<div id="List_More">
<div class="head">
<h1>Theory List_More</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitry Traytel *)</span>

<span class="keyword1"><span class="command">theory</span></span> List_More
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../List-Index/List_Index.html">List-Index.List_Index</a>"</span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Library Functions›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">bool_product_lists</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> product_lists <span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[</span>True<span class="main">,</span> False<span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="List_More-in_set_bool_product_lists"><span class="command">lemma</span></span> in_set_bool_product_lists<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">∈</span> set <span class="main">(</span>bool_product_lists <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> length <span class="free">bs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹More on sort and remdups›</span></span>

<span class="keyword1" id="List_More-insort_min"><span class="command">lemma</span></span> insort_min<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="bound">y</span> <span class="main">⟹</span> insort <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="List_More-insort_max"><span class="command">lemma</span></span> insort_max<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="bound">y</span> <span class="main">⟹</span> insort <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="List_More-insort_snoc"><span class="command">lemma</span></span> insort_snoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">y</span> <span class="main">&gt;</span> <span class="bound">z</span> <span class="main">⟹</span>
  insort <span class="free">x</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="keyword1">then</span> insort <span class="free">x</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="keyword1">else</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> set_insort_key<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="List_More-insort_remdups"><span class="command">lemma</span></span> insort_remdups<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sorted <span class="free">xs</span><span class="main">;</span> <span class="free">a</span> <span class="main">∉</span> set <span class="free">xs</span><span class="main">⟧</span> <span class="main">⟹</span> insort <span class="free">a</span> <span class="main">(</span>remdups <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> remdups <span class="main">(</span>insort <span class="free">a</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="List_More-remdups_insort"><span class="command">lemma</span></span> remdups_insort<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> remdups <span class="main">(</span>insort <span class="free">a</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> remdups <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="List_More-sort_remdups"><span class="command">lemma</span></span> sort_remdups<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sort <span class="main">(</span>remdups <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> remdups <span class="main">(</span>sort <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="List_More-sort_map_insort"><span class="command">lemma</span></span> sort_map_insort<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span> <span class="main">⟹</span> sort <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>insort <span class="free">a</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insort <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>sort <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insort_left_comm<span class="main">)</span>

<span class="keyword1" id="List_More-sort_map_sort"><span class="command">lemma</span></span> sort_map_sort<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sort <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>sort <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sort <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="List_More-remdups_append"><span class="command">lemma</span></span> remdups_append<span class="main">:</span> <span class="quoted"><span class="quoted">"remdups <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> remdups <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> set <span class="free">ys</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> remdups <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="List_More-remdups_concat_map_remdups"><span class="command">lemma</span></span> remdups_concat_map_remdups<span class="main">:</span>
  <span class="quoted"><span class="quoted">"remdups <span class="main">(</span>concat <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>remdups <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> remdups <span class="main">(</span>concat <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> remdups_append filter_empty_conv<span class="main">)</span>

<span class="comment1">(*remdups'*)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">remdups'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remdups'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remdups'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> List.find <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">remdups'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">remdups'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="List_More-map_remdups'"><span class="command">lemma</span></span> map_remdups'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">(</span>remdups' <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> remdups <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_Some_iff find_None_iff<span class="main">)</span>

<span class="keyword1" id="List_More-remdups'_map"><span class="command">lemma</span></span> remdups'_map<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"remdups' <span class="free">f</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map <span class="free">g</span> <span class="main">(</span>remdups' <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_None_iff<span class="main"><span class="keyword3">,</span></span>
                <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_Some_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> imageI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nth_mem<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="List_More-map_apfst_remdups'"><span class="command">lemma</span></span> map_apfst_remdups'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> fst<span class="main">)</span> <span class="main">(</span>remdups' snd <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map fst <span class="main">(</span>remdups' snd <span class="main">(</span>map <span class="main">(</span>apfst <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>

<span class="keyword1" id="List_More-set_remdups'"><span class="command">lemma</span></span> set_remdups'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> set <span class="main">(</span>remdups' <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_Some_iff<span class="main">)</span>

<span class="keyword1" id="List_More-subset_remdups'"><span class="command">lemma</span></span> subset_remdups'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remdups' <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="List_More-find_append"><span class="command">lemma</span></span> find_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"List.find <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> None <span class="main">=</span> <span class="main">(</span>List.find <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> None <span class="main">∧</span> List.find <span class="free">P</span> <span class="free">ys</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="List_More-subset_remdups'_append"><span class="command">lemma</span></span> subset_remdups'_append<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remdups' <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>remdups' <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>remdups' <span class="free">f</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> mp_remdups' <span class="main">=</span> subsetD<span class="main">[</span><span class="operator">OF</span> subset_remdups'<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> mp_remdups'_append <span class="main">=</span> subsetD<span class="main">[</span><span class="operator">OF</span> subset_remdups'_append<span class="main">]</span>

<span class="keyword1" id="List_More-inj_on_set_remdups'"><span class="command">lemma</span></span> inj_on_set_remdups'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>remdups' <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_None_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mp_remdups'<span class="main">)</span>

<span class="keyword1" id="List_More-distinct_remdups'"><span class="command">lemma</span></span> distinct_remdups'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>remdups' <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_None_iff<span class="main">)</span>

<span class="keyword1" id="List_More-distinct_remdups'_strong"><span class="command">lemma</span></span> distinct_remdups'_strong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span>
  distinct <span class="main">(</span>map <span class="free">g</span> <span class="main">(</span>remdups' <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_None_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mp_remdups'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="List_More-set_remdups'_strong"><span class="command">lemma</span></span> set_remdups'_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> set <span class="main">(</span>remdups' <span class="free">g</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> set_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> set <span class="main">(</span>remdups' <span class="free">g</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> set <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_Some_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="main">(</span><span class="operator">metis</span> Cons.prems image_eqI list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nth_mem<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*multisets only needed below*)</span>
<span class="keyword1" id="List_More-multiset_concat_gen"><span class="command">lemma</span></span> multiset_concat_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">+</span> mset <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">+</span> mset <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> union_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> multiset_concat<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">+</span> mset <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> multiset_concat_gen<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="List_More-fold_mset_insort"><span class="command">lemma</span></span> fold_mset_insort<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">+</span> mset <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insort <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="free">M</span> <span class="main">=</span>
  fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">+</span> mset <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">(</span>mset <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="List_More-fold_mset_sort"><span class="command">lemma</span></span> fold_mset_sort<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">+</span> mset <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sort <span class="free">xs</span><span class="main">)</span> <span class="free">M</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">+</span> mset <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="List_More-multiset_concat_map_sort"><span class="command">lemma</span></span> multiset_concat_map_sort<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>concat <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>sort <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>concat <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_concat fold_map o_def<span class="main">)</span>

<span class="keyword1" id="List_More-sort_concat_map_sort"><span class="command">lemma</span></span> sort_concat_map_sort<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sort <span class="main">(</span>concat <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>sort <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sort <span class="main">(</span>concat <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> properties_for_sort<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Pi_Regular_Set">
<div class="head">
<h1>Theory Pi_Regular_Set</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Tobias Nipkow, Alex Krauss, Dmitriy Traytel  *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Regular Sets"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Pi_Regular_Set
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> lang <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">conc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">@@</span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">@@</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">xs</span><span class="main">@</span><span class="bound">ys</span> <span class="main">|</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">xs</span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">&amp;</span> <span class="bound">ys</span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">overloading</span></span> word_pow <span class="main">==</span> <span class="quoted"><span class="quoted">"compow <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">word_pow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">word_pow</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">word_pow</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">@</span> <span class="free">word_pow</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">overloading</span></span> lang_pow <span class="main">==</span> <span class="quoted"><span class="quoted">"compow <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lang_pow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lang_pow</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lang_pow</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">@@</span> <span class="main">(</span><span class="free">lang_pow</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Pi_Regular_Set-word_pow_alt"><span class="command">lemma</span></span> word_pow_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"compow <span class="free">n</span> <span class="free">w</span> <span class="main">=</span> concat <span class="main">(</span>replicate <span class="free">n</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">star</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">star</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Concatenation of Languages›</span></span>

<span class="keyword1" id="Pi_Regular_Set-concI"><span class="command">lemma</span></span> concI<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">:</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">:</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">u</span><span class="main">@</span><span class="free">v</span> <span class="main">:</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-concE"><span class="command">lemma</span></span> concE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">u</span><span class="main">@</span><span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-conc_mono"><span class="command">lemma</span></span> conc_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">C</span> <span class="main">@@</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span> 

<span class="keyword1" id="Pi_Regular_Set-conc_empty"><span class="command">lemma</span></span> conc_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">@@</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-conc_epsilon"><span class="command">lemma</span></span> conc_epsilon<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">@@</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>conc_def<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-conc_assoc"><span class="command">lemma</span></span> conc_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">@@</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="main">(</span><span class="free">B</span> <span class="main">@@</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> concE<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> append_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> concI<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-conc_Un_distrib"><span class="command">lemma</span></span> conc_Un_distrib<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">@@</span> <span class="main">(</span><span class="free">B</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">∪</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">C</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">@@</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">C</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">@@</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-conc_UNION_distrib"><span class="command">lemma</span></span> conc_UNION_distrib<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">@@</span> <span class="main">⋃</span><span class="main">(</span><span class="free">M</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">%</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">M</span> <span class="bound">i</span><span class="main">)</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">M</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">%</span><span class="bound">i</span><span class="main">.</span> <span class="free">M</span> <span class="bound">i</span> <span class="main">@@</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-hom_image_conc"><span class="command">lemma</span></span> hom_image_conc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">xs</span> <span class="main">@</span> <span class="free">f</span> <span class="bound">ys</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">f</span> <span class="main">`</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conc_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span> <span class="operator">metis</span>

<span class="keyword1" id="Pi_Regular_Set-map_image_conc"><span class="command">lemma</span></span> map_image_conc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">@@</span> map <span class="free">f</span> <span class="main">`</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hom_image_conc<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-conc_subset_lists"><span class="command">lemma</span></span> conc_subset_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> lists <span class="free">S</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> lists <span class="free">S</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">⊆</span> lists <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def in_lists_conv_set<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Iteration of Languages›</span></span>

<span class="keyword1" id="Pi_Regular_Set-lang_pow_add"><span class="command">lemma</span></span> lang_pow_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">^^</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">^^</span> <span class="free">n</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">^^</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_assoc<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-lang_pow_simps"><span class="command">lemma</span></span> lang_pow_simps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="free">n</span> <span class="main">@@</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lang_pow_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-lang_pow_empty"><span class="command">lemma</span></span> lang_pow_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">^^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-lang_pow_empty_Suc"><span class="command">lemma</span></span> lang_pow_empty_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{}</span><span class="main">::</span><span class="tfree">'a</span> lang<span class="main">)</span> <span class="main">^^</span> Suc <span class="free">n</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_pow_empty<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-conc_pow_comm"><span class="command">lemma</span></span> conc_pow_comm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">@@</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-length_lang_pow_ub"><span class="command">lemma</span></span> length_lang_pow_ub<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">w</span> <span class="main">:</span> <span class="free">A</span><span class="main">.</span> length <span class="bound">w</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">:</span> <span class="free">A</span><span class="main">^^</span><span class="free">n</span> <span class="main">⟹</span> length <span class="free">w</span> <span class="main">≤</span> <span class="free">k</span><span class="main">*</span><span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Pi_Regular_Set-length_lang_pow_lb"><span class="command">lemma</span></span> length_lang_pow_lb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">w</span> <span class="main">:</span> <span class="free">A</span><span class="main">.</span> length <span class="bound">w</span> <span class="main">≥</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">:</span> <span class="free">A</span><span class="main">^^</span><span class="free">n</span> <span class="main">⟹</span> length <span class="free">w</span> <span class="main">≥</span> <span class="free">k</span><span class="main">*</span><span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Pi_Regular_Set-lang_pow_subset_lists"><span class="command">lemma</span></span> lang_pow_subset_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> lists <span class="free">S</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">^^</span> <span class="free">n</span> <span class="main">⊆</span> lists <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_subset_lists<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-star_subset_lists"><span class="command">lemma</span></span> star_subset_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> lists <span class="free">S</span> <span class="main">⟹</span> star <span class="free">A</span> <span class="main">⊆</span> lists <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> star_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lang_pow_subset_lists<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-star_if_lang_pow"><span class="command">lemma</span></span> star_if_lang_pow<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> <span class="free">A</span> <span class="main">^^</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">:</span> star <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> star_def<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-Nil_in_star"><span class="command">lemma</span></span> Nil_in_star<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">:</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> star_if_lang_pow<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">:</span> <span class="free">A</span> <span class="main">^^</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Regular_Set-star_if_lang"><span class="command">lemma</span></span> star_if_lang<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> star_if_lang_pow<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> <span class="free">A</span> <span class="main">^^</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">:</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Regular_Set-append_in_starI"><span class="command">lemma</span></span> append_in_starI<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">:</span> star <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">:</span> star <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">@</span><span class="free">v</span> <span class="main">:</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">:</span> star <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">:</span> <span class="free">A</span> <span class="main">^^</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> star_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">:</span> star <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">:</span> <span class="free">A</span> <span class="main">^^</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> star_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">@</span><span class="free">v</span> <span class="main">:</span> <span class="free">A</span> <span class="main">^^</span> <span class="main">(</span><span class="skolem">m</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_pow_add<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Regular_Set-conc_star_star"><span class="command">lemma</span></span> conc_star_star<span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">=</span> star <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-conc_star_comm"><span class="command">lemma</span></span> conc_star_comm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">=</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> star_def conc_pow_comm conc_UNION_distrib
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pi_Regular_Set-star_induct"><span class="command">lemma</span></span> star_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Nil append<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> star<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> star <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">u</span> <span class="main">:</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">v</span> <span class="main">:</span> star <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">u</span><span class="main">@</span><span class="bound">v</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> <span class="free">A</span> <span class="main">^^</span> <span class="skolem">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">[]</span>›</span></span> step star_if_lang_pow<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">:</span> star <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> star_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Regular_Set-star_empty"><span class="command">lemma</span></span> star_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="main">{}</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> star_induct<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-star_epsilon"><span class="command">lemma</span></span> star_epsilon<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> star_induct<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-star_idemp"><span class="command">lemma</span></span> star_idemp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> star <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> star_induct<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-star_unfold_left"><span class="command">lemma</span></span> star_unfold_left<span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">∪</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> star_induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-concat_in_star"><span class="command">lemma</span></span> concat_in_star<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">ws</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> concat <span class="free">ws</span> <span class="main">:</span> star <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Pi_Regular_Set-in_star_iff_concat"><span class="command">lemma</span></span> in_star_iff_concat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> star <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">EX</span> <span class="bound">ws</span><span class="main">.</span> set <span class="bound">ws</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">&amp;</span> <span class="free">w</span> <span class="main">=</span> concat <span class="bound">ws</span> <span class="main">&amp;</span> <span class="main">[]</span> <span class="main">∉</span> set <span class="bound">ws</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">EX</span> <span class="bound">ws</span><span class="main">.</span> <span class="var">?R</span> <span class="free">w</span> <span class="bound">ws</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> star <span class="free">A</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">EX</span> <span class="bound">ws</span><span class="main">.</span> <span class="var">?R</span> <span class="free">w</span> <span class="bound">ws</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>append <span class="skolem">u</span> <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ws</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">=</span> concat <span class="skolem">ws</span> <span class="main">∧</span> <span class="main">[]</span> <span class="main">∉</span> set <span class="skolem">ws</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">u</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="skolem">ws</span> <span class="keyword1">else</span> <span class="skolem">u</span><span class="main">#</span><span class="skolem">ws</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">EX</span> <span class="bound">us</span><span class="main">.</span> <span class="var">?R</span> <span class="free">w</span> <span class="bound">us</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">:</span> star <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concat_in_star<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Regular_Set-star_conv_concat"><span class="command">lemma</span></span> star_conv_concat<span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">=</span> <span class="main">{</span>concat <span class="bound">ws</span><span class="main">|</span><span class="bound">ws</span><span class="main">.</span> set <span class="bound">ws</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">&amp;</span> <span class="main">[]</span> <span class="main">∉</span> set <span class="bound">ws</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_star_iff_concat<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-star_insert_eps"><span class="command">lemma</span></span> star_insert_eps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="main">(</span>insert <span class="main">[]</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> star<span class="main">(</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">us</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">us</span> <span class="main">⊆</span> insert <span class="main">[]</span> <span class="free">A</span> <span class="main">⟹</span> <span class="keyword1">EX</span> <span class="bound">vs</span><span class="main">.</span> concat <span class="skolem">us</span> <span class="main">=</span> concat <span class="bound">vs</span> <span class="main">∧</span> set <span class="bound">vs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟹</span> <span class="keyword1">EX</span> <span class="bound">vs</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">vs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?vs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">%</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">us</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟹</span> <span class="var">?Q</span> <span class="var">?vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">us</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> star_conv_concat<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Regular_Set-star_decom"><span class="command">lemma</span></span> star_decom<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> star <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">@</span> <span class="bound">b</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">∈</span> star <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> star_induct<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Pi_Regular_Set-Ball_starI"><span class="command">lemma</span></span> Ball_starI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> set <span class="free">as</span><span class="main">.</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">as</span> <span class="main">∈</span> star <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-map_image_star"><span class="command">lemma</span></span> map_image_star<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">`</span> star <span class="free">A</span> <span class="main">=</span> star <span class="main">(</span>map <span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> star_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> star_induct <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_append <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_append<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Left-Quotients of Languages›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lQuot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lQuot</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">xs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="bound">xs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lQuots</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lQuots</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">ys</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">lQuotss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> lang set <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lQuotss</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="main">(</span>lQuots <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1" id="Pi_Regular_Set-lQuot_empty"><span class="command">lemma</span></span> lQuot_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"lQuot <span class="free">a</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> lQuot_epsilon<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lQuot <span class="free">a</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> lQuot_char<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>    <span class="quoted"><span class="quoted">"lQuot <span class="free">a</span> <span class="main">{</span><span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> lQuot_chars<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"lQuot <span class="free">a</span> <span class="main">{</span><span class="main">[</span><span class="bound">b</span><span class="main">]</span> <span class="main">|</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="free">a</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> lQuot_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"lQuot <span class="free">a</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> lQuot <span class="free">a</span> <span class="free">A</span> <span class="main">∪</span> lQuot <span class="free">a</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> lQuot_inter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"lQuot <span class="free">a</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> lQuot <span class="free">a</span> <span class="free">A</span> <span class="main">∩</span> lQuot <span class="free">a</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> lQuot_compl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"lQuot <span class="free">a</span> <span class="main">(</span><span class="main">-</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> lQuot <span class="free">a</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lQuot_def<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-lQuot_conc_subset"><span class="command">lemma</span></span> lQuot_conc_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"lQuot <span class="free">a</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">⊆</span> lQuot <span class="free">a</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> <span class="skolem">u</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lQuot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> concI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> <span class="skolem">u</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lQuot_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Regular_Set-lQuot_conc"><span class="command">lemma</span></span> lQuot_conc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lQuot <span class="free">c</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>lQuot <span class="free">c</span> <span class="free">A</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> lQuot <span class="free">c</span> <span class="free">B</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lQuot_def conc_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_eq_append_conv<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-lQuot_star"><span class="command">lemma</span></span> lQuot_star <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lQuot <span class="free">c</span> <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>lQuot <span class="free">c</span> <span class="free">A</span><span class="main">)</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> incl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> lQuot <span class="free">c</span> <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>lQuot <span class="free">c</span> <span class="free">A</span><span class="main">)</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lQuot_def conc_def 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_eq_append_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> star_decom<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_eq_append_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lQuot <span class="free">c</span> <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> lQuot <span class="free">c</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">∪</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> star_unfold_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> lQuot <span class="free">c</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> lQuot_union<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">(</span>lQuot <span class="free">c</span> <span class="free">A</span><span class="main">)</span> <span class="main">@@</span> <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> lQuot <span class="free">c</span> <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">(</span>lQuot <span class="free">c</span> <span class="free">A</span><span class="main">)</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> incl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lQuot <span class="free">c</span> <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>lQuot <span class="free">c</span> <span class="free">A</span><span class="main">)</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Regular_Set-lQuot_diff"><span class="command">lemma</span></span> lQuot_diff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lQuot <span class="free">c</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> lQuot <span class="free">c</span> <span class="free">A</span> <span class="main">-</span> lQuot <span class="free">c</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lQuot_def<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-lQuot_lists"><span class="command">lemma</span></span> lQuot_lists<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">:</span> <span class="free">S</span> <span class="main">⟹</span> lQuot <span class="free">c</span> <span class="main">(</span>lists <span class="free">S</span><span class="main">)</span> <span class="main">=</span> lists <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lQuot_def<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-lQuots_simps"><span class="command">lemma</span></span> lQuots_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lQuots <span class="main">[]</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"lQuots <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="free">s</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> lQuots <span class="free">s</span> <span class="main">(</span>lQuot <span class="free">c</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"lQuots <span class="main">(</span><span class="free">s1</span> <span class="main">@</span> <span class="free">s2</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> lQuots <span class="free">s2</span> <span class="main">(</span>lQuots <span class="free">s1</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lQuots_def lQuot_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-lQuots_append"><span class="command">lemma</span></span> lQuots_append<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> lQuots <span class="free">w</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">@</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lQuot_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Right-Quotients of Languages›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rQuot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rQuot</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rQuots</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rQuots</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">@</span> rev <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">rQuotss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> lang set <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rQuotss</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="main">(</span>rQuots <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Set-rQuot_rev_lQuot"><span class="command">lemma</span></span> rQuot_rev_lQuot<span class="main">:</span> <span class="quoted"><span class="quoted">"rQuot <span class="free">x</span> <span class="free">A</span> <span class="main">=</span> rev <span class="main">`</span> lQuot <span class="free">x</span> <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rQuot_def lQuot_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_swap<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-rQuots_rev_lQuots"><span class="command">lemma</span></span> rQuots_rev_lQuots<span class="main">:</span> <span class="quoted"><span class="quoted">"rQuots <span class="free">x</span> <span class="free">A</span> <span class="main">=</span> rev <span class="main">`</span> lQuots <span class="free">x</span> <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rQuots_def lQuots_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_swap<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-rQuot_empty"><span class="command">lemma</span></span> rQuot_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"rQuot <span class="free">a</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rQuot_epsilon<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rQuot <span class="free">a</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rQuot_char<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>    <span class="quoted"><span class="quoted">"rQuot <span class="free">a</span> <span class="main">{</span><span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rQuot_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"rQuot <span class="free">a</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> rQuot <span class="free">a</span> <span class="free">A</span> <span class="main">∪</span> rQuot <span class="free">a</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rQuot_inter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"rQuot <span class="free">a</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> rQuot <span class="free">a</span> <span class="free">A</span> <span class="main">∩</span> rQuot <span class="free">a</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rQuot_compl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"rQuot <span class="free">a</span> <span class="main">(</span><span class="main">-</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> rQuot <span class="free">a</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rQuot_def<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-lQuot_rQuot"><span class="command">lemma</span></span> lQuot_rQuot<span class="main">:</span> <span class="quoted"><span class="quoted">"lQuot <span class="free">a</span> <span class="main">(</span>rQuot <span class="free">b</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> rQuot <span class="free">b</span> <span class="main">(</span>lQuot <span class="free">a</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lQuot_def rQuot_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-rQuot_lQuot"><span class="command">lemma</span></span> rQuot_lQuot<span class="main">:</span> <span class="quoted"><span class="quoted">"rQuot <span class="free">a</span> <span class="main">(</span>lQuot <span class="free">b</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> lQuot <span class="free">b</span> <span class="main">(</span>rQuot <span class="free">a</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lQuot_def rQuot_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-rev_simp_invert"><span class="command">lemma</span></span> rev_simp_invert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> rev <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">zs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> rev <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">zs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-rev_append_invert"><span class="command">lemma</span></span> rev_append_invert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">=</span> rev <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">zs</span> <span class="main">=</span> rev <span class="free">ys</span> <span class="main">@</span> rev <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-image_rev_lists"><span class="command">lemma</span></span> image_rev_lists<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">`</span> lists <span class="free">S</span> <span class="main">=</span> lists <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> rev <span class="main">`</span> lists <span class="free">S</span> <span class="main">⟷</span> <span class="skolem">xs</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">rev</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_simp_invert<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Regular_Set-image_rev_conc"><span class="command">lemma</span></span> image_rev_conc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">`</span> <span class="free">B</span> <span class="main">@@</span> rev <span class="main">`</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_append<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> rev_append<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-image_rev_star"><span class="command">lemma</span></span> image_rev_star<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">`</span> star <span class="free">A</span> <span class="main">=</span> star <span class="main">(</span>rev <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> star_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> star_induct <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_append<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> rev_append<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-rQuot_conc"><span class="command">lemma</span></span> rQuot_conc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rQuot <span class="free">c</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="main">(</span>rQuot <span class="free">c</span> <span class="free">B</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">B</span> <span class="keyword1">then</span> rQuot <span class="free">c</span> <span class="free">A</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rQuot_rev_lQuot <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_image image_Un<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-rQuot_star"><span class="command">lemma</span></span> rQuot_star <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rQuot <span class="free">c</span> <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> star <span class="free">A</span> <span class="main">@@</span> <span class="main">(</span>rQuot <span class="free">c</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rQuot_rev_lQuot <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_image<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-rQuot_diff"><span class="command">lemma</span></span> rQuot_diff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rQuot <span class="free">c</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> rQuot <span class="free">c</span> <span class="free">A</span> <span class="main">-</span> rQuot <span class="free">c</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rQuot_def<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-rQuot_lists"><span class="command">lemma</span></span> rQuot_lists<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">:</span> <span class="free">S</span> <span class="main">⟹</span> rQuot <span class="free">c</span> <span class="main">(</span>lists <span class="free">S</span><span class="main">)</span> <span class="main">=</span> lists <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rQuot_def<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-rQuots_simps"><span class="command">lemma</span></span> rQuots_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rQuots <span class="main">[]</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"rQuots <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="free">s</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> rQuots <span class="free">s</span> <span class="main">(</span>rQuot <span class="free">c</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"rQuots <span class="main">(</span><span class="free">s1</span> <span class="main">@</span> <span class="free">s2</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> rQuots <span class="free">s2</span> <span class="main">(</span>rQuots <span class="free">s1</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rQuots_def rQuot_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-rQuots_append"><span class="command">lemma</span></span> rQuots_append<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> rQuots <span class="free">w</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">v</span> <span class="main">@</span> rev <span class="free">w</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rQuot_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Two-Sided-Quotients of Languages›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">biQuot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">biQuot</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">xs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">biQuots</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">biQuots</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">zs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="bound">zs</span> <span class="main">@</span> rev <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">biQuotss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> lang set <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">biQuotss</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="main">(</span>biQuots <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Set-biQuot_rQuot_lQuot"><span class="command">lemma</span></span> biQuot_rQuot_lQuot<span class="main">:</span> <span class="quoted"><span class="quoted">"biQuot <span class="free">x</span> <span class="free">y</span> <span class="free">A</span> <span class="main">=</span> rQuot <span class="free">y</span> <span class="main">(</span>lQuot <span class="free">x</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> biQuot_def rQuot_def lQuot_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-biQuot_lQuot_rQuot"><span class="command">lemma</span></span> biQuot_lQuot_rQuot<span class="main">:</span> <span class="quoted"><span class="quoted">"biQuot <span class="free">x</span> <span class="free">y</span> <span class="free">A</span> <span class="main">=</span> lQuot <span class="free">x</span> <span class="main">(</span>rQuot <span class="free">y</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> biQuot_def rQuot_def lQuot_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-biQuots_rQuots_lQuots"><span class="command">lemma</span></span> biQuots_rQuots_lQuots<span class="main">:</span> <span class="quoted"><span class="quoted">"biQuots <span class="free">x</span> <span class="free">y</span> <span class="free">A</span> <span class="main">=</span> rQuots <span class="free">y</span> <span class="main">(</span>lQuots <span class="free">x</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> biQuots_def rQuots_def lQuots_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-biQuots_lQuots_rQuots"><span class="command">lemma</span></span> biQuots_lQuots_rQuots<span class="main">:</span> <span class="quoted"><span class="quoted">"biQuots <span class="free">x</span> <span class="free">y</span> <span class="free">A</span> <span class="main">=</span> lQuots <span class="free">x</span> <span class="main">(</span>rQuots <span class="free">y</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> biQuots_def rQuots_def lQuots_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-biQuot_empty"><span class="command">lemma</span></span> biQuot_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"biQuot <span class="free">a</span> <span class="free">b</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> biQuot_epsilon<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"biQuot <span class="free">a</span> <span class="free">b</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> biQuot_char<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>    <span class="quoted"><span class="quoted">"biQuot <span class="free">a</span> <span class="free">b</span> <span class="main">{</span><span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> biQuot_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"biQuot <span class="free">a</span> <span class="free">b</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> biQuot <span class="free">a</span> <span class="free">b</span> <span class="free">A</span> <span class="main">∪</span> biQuot <span class="free">a</span> <span class="free">b</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> biQuot_inter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"biQuot <span class="free">a</span> <span class="free">b</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> biQuot <span class="free">a</span> <span class="free">b</span> <span class="free">A</span> <span class="main">∩</span> biQuot <span class="free">a</span> <span class="free">b</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> biQuot_compl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"biQuot <span class="free">a</span> <span class="free">b</span> <span class="main">(</span><span class="main">-</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> biQuot <span class="free">a</span> <span class="free">b</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> biQuot_def<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-biQuot_conc"><span class="command">lemma</span></span> biQuot_conc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"biQuot <span class="free">a</span> <span class="free">b</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span>
  lQuot <span class="free">a</span> <span class="free">A</span> <span class="main">@@</span> rQuot <span class="free">b</span> <span class="free">B</span> <span class="main">∪</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">B</span> <span class="keyword1">then</span> biQuot <span class="free">a</span> <span class="free">b</span> <span class="free">A</span> <span class="main">∪</span> biQuot <span class="free">a</span> <span class="free">b</span> <span class="free">B</span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> biQuot <span class="free">a</span> <span class="free">b</span> <span class="free">B</span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">B</span> <span class="keyword1">then</span> biQuot <span class="free">a</span> <span class="free">b</span> <span class="free">A</span>
  <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> biQuot_rQuot_lQuot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-biQuot_star"><span class="command">lemma</span></span> biQuot_star <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"biQuot <span class="free">a</span> <span class="free">b</span> <span class="main">(</span>star <span class="free">A</span><span class="main">)</span> <span class="main">=</span> biQuot <span class="free">a</span> <span class="free">b</span> <span class="free">A</span> <span class="main">∪</span> lQuot <span class="free">a</span> <span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">@@</span> rQuot <span class="free">b</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> biQuot_rQuot_lQuot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-biQuot_diff"><span class="command">lemma</span></span> biQuot_diff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"biQuot <span class="free">a</span> <span class="free">b</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> biQuot <span class="free">a</span> <span class="free">b</span> <span class="free">A</span> <span class="main">-</span> biQuot <span class="free">a</span> <span class="free">b</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> biQuot_def<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-biQuot_lists"><span class="command">lemma</span></span> biQuot_lists<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">:</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">:</span> <span class="free">S</span> <span class="main">⟹</span> biQuot <span class="free">a</span> <span class="free">b</span> <span class="main">(</span>lists <span class="free">S</span><span class="main">)</span> <span class="main">=</span> lists <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> biQuot_def<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Set-biQuots_simps"><span class="command">lemma</span></span> biQuots_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"biQuots <span class="main">[]</span> <span class="main">[]</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"biQuots <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span><span class="main">#</span><span class="free">bs</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> biQuots <span class="free">as</span> <span class="free">bs</span> <span class="main">(</span>biQuot <span class="free">a</span> <span class="free">b</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span>length <span class="free">s1</span> <span class="main">=</span> length <span class="free">t1</span><span class="main">;</span> length <span class="free">s2</span> <span class="main">=</span> length <span class="free">t2</span><span class="main">⟧</span> <span class="main">⟹</span>
    biQuots <span class="main">(</span><span class="free">s1</span> <span class="main">@</span> <span class="free">s2</span><span class="main">)</span> <span class="main">(</span><span class="free">t1</span> <span class="main">@</span> <span class="free">t2</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> biQuots <span class="free">s2</span> <span class="free">t2</span> <span class="main">(</span>biQuots <span class="free">s1</span> <span class="free">t1</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> biQuots_def biQuot_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Set-biQuots_append"><span class="command">lemma</span></span> biQuots_append<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> biQuots <span class="free">u</span> <span class="free">w</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">u</span> <span class="main">@</span> <span class="free">v</span> <span class="main">@</span> rev <span class="free">w</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> biQuots_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Arden's Lemma›</span></span>

<span class="keyword1" id="Pi_Regular_Set-arden_helper"><span class="command">lemma</span></span> arden_helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="free">n</span><span class="main">)</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_Un_distrib conc_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> conc_pow_comm<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atMost_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Regular_Set-Arden"><span class="command">lemma</span></span> Arden<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∉</span> <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">=</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[]</span> <span class="main">∉</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">u</span> <span class="main">:</span> <span class="free">A</span><span class="main">.</span> length <span class="bound">u</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 add_leD2 le_0_eq length_0_conv not_less_eq_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">u</span> <span class="main">:</span> <span class="free">A</span><span class="main">^^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> length <span class="bound">u</span> <span class="main">≥</span> <span class="var">?n</span><span class="main">+</span><span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_lang_pow_lb nat_mult_1<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">u</span> <span class="main">:</span> <span class="free">A</span><span class="main">^^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">@@</span><span class="free">X</span><span class="main">.</span> length <span class="bound">u</span> <span class="main">≥</span> <span class="var">?n</span><span class="main">+</span><span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> conc_def length_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∉</span> <span class="free">A</span><span class="main">^^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">@@</span><span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">:</span> <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> arden_helper<span class="main">[</span><span class="operator">OF</span> eq<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?n</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_def conc_UNION_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">EX</span> <span class="bound">n</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">:</span> <span class="free">A</span><span class="main">^^</span><span class="bound">n</span> <span class="main">@@</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def star_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> arden_helper<span class="main">[</span><span class="operator">OF</span> eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">∪</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> star_unfold_left<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">∪</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> star <span class="free">A</span><span class="main">)</span> <span class="main">@@</span> <span class="free">B</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> conc_Un_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="main">(</span>star <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">∪</span> <span class="free">B</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> conc_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">B</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Pi_Regular_Set-reversed_arden_helper"><span class="command">lemma</span></span> reversed_arden_helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="free">n</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="main">0</span><span class="main">.</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_Un_distrib conc_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atMost_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">≤</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="free">A</span> <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> reversed_Arden<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">=</span> <span class="free">B</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[]</span> <span class="main">∉</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">u</span> <span class="main">:</span> <span class="free">A</span><span class="main">.</span> length <span class="bound">u</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 add_leD2 le_0_eq length_0_conv not_less_eq_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">u</span> <span class="main">:</span> <span class="free">A</span><span class="main">^^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> length <span class="bound">u</span> <span class="main">≥</span> <span class="var">?n</span><span class="main">+</span><span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_lang_pow_lb nat_mult_1<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">u</span> <span class="main">:</span> <span class="free">X</span> <span class="main">@@</span> <span class="free">A</span><span class="main">^^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> length <span class="bound">u</span> <span class="main">≥</span> <span class="var">?n</span><span class="main">+</span><span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> conc_def length_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∉</span> <span class="free">X</span> <span class="main">@@</span> <span class="free">A</span><span class="main">^^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> <span class="free">B</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">:</span> <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> reversed_arden_helper<span class="main">[</span><span class="operator">OF</span> eq<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?n</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_def conc_UNION_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> <span class="free">B</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">EX</span> <span class="bound">n</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">:</span> <span class="free">B</span> <span class="main">@@</span> <span class="free">A</span><span class="main">^^</span><span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def star_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reversed_arden_helper<span class="main">[</span><span class="operator">OF</span> eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">B</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">B</span> <span class="main">@@</span> star <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"star <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">∪</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> conc_star_comm<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> Un_commute star_unfold_left<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">@@</span> star <span class="free">A</span> <span class="main">=</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span><span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">∪</span> star <span class="free">A</span> <span class="main">@@</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">@@</span> <span class="main">(</span>star <span class="free">A</span> <span class="main">@@</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> conc_Un_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∪</span> <span class="main">(</span><span class="free">B</span> <span class="main">@@</span> star <span class="free">A</span><span class="main">)</span> <span class="main">@@</span> <span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> conc_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">@@</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lists of Fixed Length›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">listsN</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">listsN</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> lists <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Set-tl_listsN"><span class="command">lemma</span></span> tl_listsN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> listsN <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">S</span> <span class="main">⟹</span> tl <span class="main">`</span> <span class="free">A</span> <span class="main">⊆</span> listsN <span class="free">n</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> image_subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> listsN <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"tl <span class="skolem">xs</span> <span class="main">∈</span> listsN <span class="free">n</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Regular_Set-map_tl_listsN"><span class="command">lemma</span></span> map_tl_listsN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> lists <span class="main">(</span>listsN <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> map tl <span class="main">`</span> <span class="free">A</span> <span class="main">⊆</span> lists <span class="main">(</span>listsN <span class="free">n</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> image_subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xss</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> lists <span class="main">(</span>listsN <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xss</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xss</span> <span class="main">⊆</span> listsN <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> set <span class="skolem">xss</span><span class="main">.</span> tl <span class="bound">xs</span> <span class="main">∈</span> listsN <span class="free">n</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tl_listsN<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xss</span>"</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"map tl <span class="skolem">xss</span> <span class="main">∈</span> lists <span class="main">(</span>listsN <span class="free">n</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xss</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Pi_Regular_Exp">
<div class="head">
<h1>Theory Pi_Regular_Exp</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹$\Pi$-Extended Regular Expressions›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Pi_Regular_Exp
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Pi_Regular_Set">Pi_Regular_Set</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/List_Lexorder.html">HOL-Library.List_Lexorder</a>"</span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Code_Target_Nat.html">HOL-Library.Code_Target_Nat</a>"</span>
  <a href="../../deriving/theories/#Compare_Instances">Deriving.Compare_Instances</a>   
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax of regular expressions›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> rexp <span class="main">=</span>
  Zero <span class="main">|</span>
  Full <span class="main">|</span>
  One <span class="main">|</span>
  Atom <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span>
  Plus <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="main">|</span>
  Times <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="main">|</span>
  Star <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="main">|</span>
  Not <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="main">|</span>
  Inter <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span> <span class="main">|</span>
  Pr <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> rexp<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">rexp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lifting constructors to lists›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rexp_of_list</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rexp_of_list</span> <span class="free"><span class="bound"><span class="entity">OPERATION</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_list</span> <span class="free"><span class="bound"><span class="entity">OPERATION</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_list</span> <span class="free"><span class="bound"><span class="entity">OPERATION</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">OPERATION</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">rexp_of_list</span> <span class="free"><span class="bound"><span class="entity">OPERATION</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">PLUS</span> <span class="main">≡</span> rexp_of_list Plus Zero"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">TIMES</span> <span class="main">≡</span> rexp_of_list Times One"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">INTERSECT</span> <span class="main">≡</span> rexp_of_list Inter Full"</span></span>

<span class="keyword1" id="Pi_Regular_Exp-list_singleton_induct"><span class="command">lemma</span></span> list_singleton_induct <span class="main">[</span><span class="operator">case_names</span> nil single cons<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ACI normalization›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">toplevel_summands</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">toplevel_summands</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">toplevel_summands</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free">toplevel_summands</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">toplevel_summands</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">flatten</span> <span class="free"><span class="bound"><span class="entity">LISTOP</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">LISTOP</span></span></span> <span class="main">(</span>sorted_list_of_set <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_nonempty"><span class="command">lemma</span></span> toplevel_summands_nonempty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="free">r</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_finite"><span class="command">lemma</span></span> toplevel_summands_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>toplevel_summands <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ACI_norm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">«</span>_<span class="keyword1">»</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>Zero<span class="main"><span class="free">»</span></span> <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>Full<span class="main"><span class="free">»</span></span> <span class="main">=</span> Full"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>One<span class="main"><span class="free">»</span></span> <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">»</span></span> <span class="main">=</span> Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">»</span></span> <span class="main">=</span> flatten PLUS <span class="main">(</span>toplevel_summands <span class="main">(</span>Plus <span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="free">»</span></span> <span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">»</span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">»</span></span> <span class="main">=</span> Times <span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="free">»</span></span> <span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">»</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="free">»</span></span> <span class="main">=</span> Star <span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="free">»</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="free">»</span></span> <span class="main">=</span> Not <span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="free">»</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">»</span></span> <span class="main">=</span> Inter <span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="free">»</span></span> <span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">»</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>Pr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="free">»</span></span> <span class="main">=</span> Pr <span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="free">»</span></span>"</span></span>

<span class="keyword1" id="Pi_Regular_Exp-Plus_toplevel_summands"><span class="command">lemma</span></span> Plus_toplevel_summands<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Plus <span class="free">r</span> <span class="free">s</span> <span class="main">∈</span> toplevel_summands <span class="free">t</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_not_Plus"><span class="command">lemma</span></span> toplevel_summands_not_Plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="free">x</span> <span class="main">≠</span> Plus <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> toplevel_summands <span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_PLUS_strong"><span class="command">lemma</span></span> toplevel_summands_PLUS_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Plus <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">⟧</span> <span class="main">⟹</span> toplevel_summands <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_flatten"><span class="command">lemma</span></span> toplevel_summands_flatten<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> finite <span class="free">X</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Plus <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> toplevel_summands <span class="main">(</span>flatten PLUS <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> toplevel_summands_PLUS_strong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="free">X</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Pi_Regular_Exp-ACI_norm_Plus"><span class="command">lemma</span></span> ACI_norm_Plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> Plus <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> Plus <span class="bound">s</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_flatten_ACI_norm_image"><span class="command">lemma</span></span> toplevel_summands_flatten_ACI_norm_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>flatten PLUS <span class="main">(</span>ACI_norm <span class="main">`</span> toplevel_summands <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ACI_norm <span class="main">`</span> toplevel_summands <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> toplevel_summands_flatten<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ACI_norm_Plus <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Plus_toplevel_summands<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_flatten_ACI_norm_image_Union"><span class="command">lemma</span></span> toplevel_summands_flatten_ACI_norm_image_Union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>flatten PLUS <span class="main">(</span>ACI_norm <span class="main">`</span> toplevel_summands <span class="free">r</span> <span class="main">∪</span> ACI_norm <span class="main">`</span> toplevel_summands <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    ACI_norm <span class="main">`</span> toplevel_summands <span class="free">r</span> <span class="main">∪</span> ACI_norm <span class="main">`</span> toplevel_summands <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> toplevel_summands_flatten<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ACI_norm_Plus<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Plus_toplevel_summands<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_ACI_norm"><span class="command">lemma</span></span> toplevel_summands_ACI_norm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> ACI_norm <span class="main">`</span> toplevel_summands <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toplevel_summands_flatten_ACI_norm_image_Union<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Exp-ACI_norm_flatten"><span class="command">lemma</span></span> ACI_norm_flatten<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> flatten PLUS <span class="main">(</span>ACI_norm <span class="main">`</span> toplevel_summands <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un toplevel_summands_flatten_ACI_norm_image<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> ACI_norm_idem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">«</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">»</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>flatten PLUS <span class="main">(</span>toplevel_summands <span class="main">«</span><span class="skolem">r</span><span class="main">»</span> <span class="main">∪</span> toplevel_summands <span class="main">«</span><span class="skolem">s</span><span class="main">»</span><span class="main">)</span><span class="main">»</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">«</span>flatten PLUS <span class="var">?U</span><span class="main">»</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> flatten PLUS <span class="main">(</span>ACI_norm <span class="main">`</span> toplevel_summands <span class="main">(</span>flatten PLUS <span class="var">?U</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ACI_norm_flatten<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>flatten PLUS <span class="var">?U</span><span class="main">)</span> <span class="main">=</span> <span class="var">?U</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> toplevel_summands_flatten<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Plus_toplevel_summands<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flatten PLUS <span class="main">(</span>ACI_norm <span class="main">`</span> <span class="var">?U</span><span class="main">)</span> <span class="main">=</span> flatten PLUS <span class="main">(</span>toplevel_summands <span class="main">«</span><span class="skolem">r</span><span class="main">»</span> <span class="main">∪</span> toplevel_summands <span class="main">«</span><span class="skolem">s</span><span class="main">»</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> image_Un toplevel_summands_ACI_norm<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Plus<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ACI_nPlus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ACI_nPlus</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free">ACI_nPlus</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">(</span><span class="free">ACI_nPlus</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="keyword1">then</span> Plus <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="keyword1">then</span> Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> Plus <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span><span class="free">ACI_nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
  <span class="keyword1">else</span> Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ACI_norm_alt</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> Full <span class="main">=</span> Full"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> ACI_nPlus <span class="main">(</span><span class="free">ACI_norm_alt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">ACI_norm_alt</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">ACI_norm_alt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">ACI_norm_alt</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Star <span class="main">(</span><span class="free">ACI_norm_alt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Not <span class="main">(</span><span class="free">ACI_norm_alt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span><span class="free">ACI_norm_alt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">ACI_norm_alt</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Pr <span class="main">(</span><span class="free">ACI_norm_alt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_ACI_nPlus"><span class="command">lemma</span></span> toplevel_summands_ACI_nPlus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>ACI_nPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> toplevel_summands <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ACI_nPlus.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_ACI_norm_alt"><span class="command">lemma</span></span> toplevel_summands_ACI_norm_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>ACI_norm_alt <span class="free">r</span><span class="main">)</span> <span class="main">=</span> ACI_norm_alt <span class="main">`</span> toplevel_summands <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toplevel_summands_ACI_nPlus<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Exp-ACI_norm_alt_Plus"><span class="command">lemma</span></span> ACI_norm_alt_Plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ACI_norm_alt <span class="free">r</span> <span class="main">=</span> Plus <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> Plus <span class="bound">s</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_flatten_ACI_norm_alt_image"><span class="command">lemma</span></span> toplevel_summands_flatten_ACI_norm_alt_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>flatten PLUS <span class="main">(</span>ACI_norm_alt <span class="main">`</span> toplevel_summands <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ACI_norm_alt <span class="main">`</span> toplevel_summands <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> toplevel_summands_flatten<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ACI_norm_alt_Plus <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Plus_toplevel_summands<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Exp-ACI_norm_ACI_norm_alt"><span class="command">lemma</span></span> ACI_norm_ACI_norm_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span>ACI_norm_alt <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ACI_norm_flatten <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ACI_norm_alt <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">]</span> ACI_norm_flatten <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Plus <span class="skolem">r</span> <span class="skolem">s</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un toplevel_summands_ACI_nPlus<span class="main">)</span>
      <span class="main">(</span><span class="operator">metis</span> Plus.IH toplevel_summands_ACI_norm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-ACI_nPlus_singleton_PLUS"><span class="command">lemma</span></span> ACI_nPlus_singleton_PLUS<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> sorted <span class="free">xs</span><span class="main">;</span> distinct <span class="free">xs</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Plus <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  ACI_nPlus <span class="free">x</span> <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="keyword1">then</span> PLUS <span class="free">xs</span> <span class="keyword1">else</span> PLUS <span class="main">(</span>insort <span class="free">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>single <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ACI_nPlus.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">y1</span> <span class="skolem">y2</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pi_Regular_Exp-ACI_nPlus_PLUS"><span class="command">lemma</span></span> ACI_nPlus_PLUS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">xs1</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="free">xs2</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">xs1</span> <span class="main">@</span> <span class="free">xs2</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Plus <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> sorted <span class="free">xs2</span><span class="main">;</span> distinct <span class="free">xs2</span><span class="main">⟧</span><span class="main">⟹</span>
  ACI_nPlus <span class="main">(</span>PLUS <span class="free">xs1</span><span class="main">)</span> <span class="main">(</span>PLUS <span class="free">xs2</span><span class="main">)</span> <span class="main">=</span> flatten PLUS <span class="main">(</span>set <span class="main">(</span><span class="free">xs1</span> <span class="main">@</span> <span class="free">xs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>single <span class="skolem">x1</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ACI_nPlus_singleton_PLUS<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_absorb <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_insert<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> finite_set finite_sorted_distinct_unique sorted_list_of_set<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> remdups_id_iff_distinct sorted_list_of_set_sort_remdups sorted_sort_id<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">x11</span> <span class="skolem">x12</span> <span class="skolem">xs1</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_insert<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ACI_nPlus_singleton_PLUS<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_insert <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x11</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_insert_left<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x11</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> insert_absorb<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_insert_right<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">x11</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> insert_absorb<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x12</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pi_Regular_Exp-ACI_nPlus_flatten_PLUS"><span class="command">lemma</span></span> ACI_nPlus_flatten_PLUS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">X1</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> <span class="free">X2</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> finite <span class="free">X1</span><span class="main">;</span> finite <span class="free">X2</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X1</span> <span class="main">∪</span> <span class="free">X2</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Plus <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span><span class="main">⟧</span><span class="main">⟹</span>
  ACI_nPlus <span class="main">(</span>flatten PLUS <span class="free">X1</span><span class="main">)</span> <span class="main">(</span>flatten PLUS <span class="free">X2</span><span class="main">)</span> <span class="main">=</span> flatten PLUS <span class="main">(</span><span class="free">X1</span> <span class="main">∪</span> <span class="free">X2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ACI_nPlus_PLUS<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-ACI_nPlus_ACI_norm"><span class="command">lemma</span></span> ACI_nPlus_ACI_norm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ACI_nPlus <span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">«</span><span class="free">s</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ACI_norm_flatten <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> ACI_norm_flatten <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> ACI_norm_flatten <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Plus <span class="free">r</span> <span class="free">s</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> ACI_nPlus_flatten_PLUS<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un Un_assoc  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> ACI_nPlus_flatten_PLUS<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ACI_norm_Plus Plus_toplevel_summands<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Pi_Regular_Exp-ACI_norm_alt"><span class="command">lemma</span></span> ACI_norm_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ACI_norm_alt <span class="free">r</span> <span class="main">=</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> ACI_norm_alt<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span>




<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finality›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">final</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">final</span> Zero <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final</span> Full <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final</span> One <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="main">(</span>Atom <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">final</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> <span class="free">final</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">final</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">final</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="main">(</span>Star <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">~</span> <span class="free">final</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">final</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">∧</span> <span class="free">final</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">final</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_final"><span class="command">lemma</span></span> toplevel_summands_final<span class="main">:</span>
  <span class="quoted"><span class="quoted">"final <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">∈</span>toplevel_summands <span class="free">s</span><span class="main">.</span> final <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-final_PLUS"><span class="command">lemma</span></span> final_PLUS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"final <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> final <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> ACI_norm_final<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"final <span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> final <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> toplevel_summands_final <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_PLUS<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Wellformedness w.r.t. an alphabet›</span></span>

<span class="keyword1"><span class="command">locale</span></span> alphabet <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Σ</span> _"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="free">wf_atom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> linorder <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">wf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'b</span> rexp <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> Zero <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> Full <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> One <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">wf_atom</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">wf_word</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_word</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf_word</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">Σ</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">wf_word</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Exp-wf_word_snoc"><span class="command">lemma</span></span> wf_word_snoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_word <span class="free">n</span> <span class="main">(</span><span class="free">ws</span> <span class="main">@</span> <span class="main">[</span><span class="free">w</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">w</span> <span class="main">∈</span> <span class="keyword1"><span class="free">Σ</span></span> <span class="free">n</span><span class="main">)</span> <span class="main">∧</span> wf_word <span class="free">n</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-wf_word_append"><span class="command">lemma</span></span> wf_word_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_word <span class="free">n</span> <span class="main">(</span><span class="free">ws</span> <span class="main">@</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>wf_word <span class="free">n</span> <span class="free">ws</span> <span class="main">∧</span> wf_word <span class="free">n</span> <span class="free">vs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">vs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-wf_word"><span class="command">lemma</span></span> wf_word<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_word <span class="free">n</span> <span class="free">w</span> <span class="main">=</span> <span class="main">(</span><span class="free">w</span> <span class="main">∈</span> lists <span class="main">(</span><span class="keyword1"><span class="free">Σ</span></span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_wf"><span class="command">lemma</span></span> toplevel_summands_wf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>toplevel_summands <span class="free">s</span><span class="main">.</span> wf <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-wf_PLUS"><span class="command">lemma</span></span> wf_PLUS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> wf <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>
  
<span class="keyword1" id="Pi_Regular_Exp-wf_TIMES"><span class="command">lemma</span></span> wf_TIMES<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="main">(</span>TIMES <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> wf <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-wf_flatten_PLUS"><span class="command">lemma</span></span> wf_flatten_PLUS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>flatten PLUS <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> wf <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_PLUS<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="free">X</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">theorem</span></span> ACI_norm_wf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> wf <span class="free">n</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command">using</span></span> toplevel_summands_wf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="skolem">r1</span><span class="main">»</span>"</span></span><span class="main">]</span> toplevel_summands_wf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="skolem">r2</span><span class="main">»</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-wf_INTERSECT"><span class="command">lemma</span></span> wf_INTERSECT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="main">(</span>INTERSECT <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> wf <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-wf_flatten_INTERSECT"><span class="command">lemma</span></span> wf_flatten_INTERSECT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>flatten INTERSECT <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> wf <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_INTERSECT<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="free">X</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Language›</span></span>

<span class="keyword1"><span class="command">locale</span></span> project <span class="main">=</span>
  alphabet <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="free">wf_atom</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">wf_atom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> linorder <span class="main">⇒</span> bool"</span></span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">project</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="free">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> project<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">project</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lang</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'b</span> rexp <span class="main">=&gt;</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> Zero <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> Full <span class="main">=</span> lists <span class="main">(</span><span class="free">Σ</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> One <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="free">lookup</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> conc <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> star <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> lists <span class="main">(</span><span class="free">Σ</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∩</span> <span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> map <span class="free">project</span> <span class="main">`</span> <span class="free">lang</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="Pi_Regular_Exp-wf_word_map_project"><span class="command">lemma</span></span> wf_word_map_project<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_word <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">ws</span> <span class="main">⟹</span> wf_word <span class="free">n</span> <span class="main">(</span>map <span class="free">project</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> project<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Exp-wf_lang_wf_word"><span class="command">lemma</span></span> wf_lang_wf_word<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="free">r</span><span class="main">.</span> wf_word <span class="free">n</span> <span class="bound">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ conc_mono<span class="main"><span class="main">]</span></span> star_induct <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_word<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Exp-lang_subset_lists"><span class="command">lemma</span></span> lang_subset_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="free">r</span> <span class="main">⊆</span> lists <span class="main">(</span><span class="free">Σ</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Pr <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> project<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_subset_lists star_subset_lists<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_lang"><span class="command">lemma</span></span> toplevel_summands_lang<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> toplevel_summands <span class="free">s</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="free">r</span> <span class="main">⊆</span> lang <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_lang_UN"><span class="command">lemma</span></span> toplevel_summands_lang_UN<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span><span class="main">∈</span>toplevel_summands <span class="free">s</span><span class="main">.</span> lang <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-toplevel_summands_in_lang"><span class="command">lemma</span></span> toplevel_summands_in_lang<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">∈</span>toplevel_summands <span class="free">s</span><span class="main">.</span> <span class="free">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-lang_PLUS"><span class="command">lemma</span></span> lang_PLUS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> lang <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>
  
<span class="keyword1" id="Pi_Regular_Exp-lang_TIMES"><span class="command">lemma</span></span> lang_TIMES<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>TIMES <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> foldr <span class="main">(@@)</span> <span class="main">(</span>map <span class="main">(</span>lang <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-lang_flatten_PLUS"><span class="command">lemma</span></span> lang_flatten_PLUS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>flatten PLUS <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> lang <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lang_PLUS<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="free">X</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">theorem</span></span> ACI_norm_lang<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> Plus<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lang <span class="skolem">n</span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">⊆</span> lang <span class="skolem">n</span> <span class="main">«</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">»</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> toplevel_summands_in_lang<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="skolem">r1</span><span class="main">»</span>"</span></span><span class="main">]</span> toplevel_summands_in_lang<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="skolem">r2</span><span class="main">»</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> toplevel_summands_lang<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-lang_final"><span class="command">lemma</span></span> lang_final<span class="main">:</span> <span class="quoted"><span class="quoted">"final <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> concI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-in_lang_INTERSECT"><span class="command">lemma</span></span> in_lang_INTERSECT<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_word <span class="free">n</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>INTERSECT <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_word<span class="main">)</span>
  
<span class="keyword1" id="Pi_Regular_Exp-lang_INTERSECT"><span class="command">lemma</span></span> lang_INTERSECT<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>INTERSECT <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> lists <span class="main">(</span><span class="free">Σ</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">⋂</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> lang <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp-lang_flatten_INTERSECT"><span class="command">lemma</span></span> lang_flatten_INTERSECT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> wf <span class="free">n</span> <span class="bound">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>flatten INTERSECT <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="free">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">using</span></span> in_lang_INTERSECT<span class="main">[</span><span class="operator">OF</span> bspec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_lang_wf_word<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_flatten_INTERSECT<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span>
    <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?L</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="free">X</span>"</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> in_lang_INTERSECT<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_lang_wf_word<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Pi_Derivatives">
<div class="head">
<h1>Theory Pi_Derivatives</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Derivatives of $\Pi$-Extended Regular Expressions›</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Pi_Derivatives
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Pi_Regular_Exp">Pi_Regular_Exp</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">locale</span></span> embed <span class="main">=</span> project <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="free">wf_atom</span></span> <span class="quoted"><span class="free">project</span></span> <span class="quoted"><span class="free">lookup</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">wf_atom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> linorder <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">project</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">embed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> embed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">embed</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">project</span> <span class="free">b</span> <span class="main">=</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntactic Derivatives›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lderiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> rexp <span class="main">⇒</span> <span class="tfree">'b</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lderiv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Full <span class="main">=</span> Full"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> One <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">lookup</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> One <span class="keyword1">else</span> Zero<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">lderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">lderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">r's</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">lderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
     <span class="keyword1">in</span> <span class="keyword1">if</span> final <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> Plus <span class="bound">r's</span> <span class="main">(</span><span class="free">lderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">r's</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">lderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Not <span class="main">(</span><span class="free">lderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span><span class="free">lderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">lderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Pr <span class="main">(</span>PLUS <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> <span class="free">lderiv</span> <span class="bound">a'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">embed</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lderivs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lderivs</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderivs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free">lderivs</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">(</span>lderiv <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finiteness of ACI-Equivalent Derivatives›</span></span>

<span class="keyword1" id="Pi_Derivatives-toplevel_summands_lderiv"><span class="command">lemma</span></span> toplevel_summands_lderiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>lderiv <span class="free">as</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">s</span><span class="main">∈</span>toplevel_summands <span class="free">r</span><span class="main">.</span> toplevel_summands <span class="main">(</span>lderiv <span class="free">as</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Pi_Derivatives-lderivs_Zero"><span class="command">lemma</span></span> lderivs_Zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lderivs <span class="free">xs</span> Zero <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Derivatives-lderivs_Full"><span class="command">lemma</span></span> lderivs_Full<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lderivs <span class="free">xs</span> Full <span class="main">=</span> Full"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Derivatives-lderivs_One"><span class="command">lemma</span></span> lderivs_One<span class="main">:</span> <span class="quoted"><span class="quoted">"lderivs <span class="free">xs</span> One <span class="main">∈</span> <span class="main">{</span>Zero<span class="main">,</span> One<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Derivatives-lderivs_Atom"><span class="command">lemma</span></span> lderivs_Atom<span class="main">:</span> <span class="quoted"><span class="quoted">"lderivs <span class="free">xs</span> <span class="main">(</span>Atom <span class="free">as</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>Zero<span class="main">,</span> One<span class="main">,</span> Atom <span class="free">as</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> insertE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lderivs_One<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pi_Derivatives-lderivs_Plus"><span class="command">lemma</span></span> lderivs_Plus<span class="main">:</span> <span class="quoted"><span class="quoted">"lderivs <span class="free">xs</span> <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>lderivs <span class="free">xs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>lderivs <span class="free">xs</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Derivatives-lderivs_PLUS"><span class="command">lemma</span></span> lderivs_PLUS<span class="main">:</span> <span class="quoted"><span class="quoted">"lderivs <span class="free">xs</span> <span class="main">(</span>PLUS <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> PLUS <span class="main">(</span>map <span class="main">(</span>lderivs <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lderivs_Plus<span class="main">)</span>

<span class="keyword1" id="Pi_Derivatives-toplevel_summands_lderivs_Times"><span class="command">lemma</span></span> toplevel_summands_lderivs_Times<span class="main">:</span> <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>lderivs <span class="free">xs</span> <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
  <span class="main">{</span>Times <span class="main">(</span>lderivs <span class="free">xs</span> <span class="free">r</span><span class="main">)</span> <span class="free">s</span><span class="main">}</span> <span class="main">∪</span>
  <span class="main">{</span><span class="bound">r'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> toplevel_summands <span class="main">(</span>lderivs <span class="bound">ys</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">zs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">=</span> <span class="free">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def lderivs_Plus<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pi_Derivatives-toplevel_summands_lderivs_Star_nonempty"><span class="command">lemma</span></span> toplevel_summands_lderivs_Star_nonempty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> toplevel_summands <span class="main">(</span>lderivs <span class="free">xs</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
    <span class="main">{</span>Times <span class="main">(</span>lderivs <span class="bound">ys</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">|</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">zs</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">zs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">=</span> <span class="free">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> spec<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> toplevel_summands_lderivs_Times<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> impE <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> meta_spec subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Derivatives-toplevel_summands_lderivs_Star"><span class="command">lemma</span></span> toplevel_summands_lderivs_Star<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>lderivs <span class="free">xs</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
    <span class="main">{</span>Star <span class="free">r</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>Times <span class="main">(</span>lderivs <span class="bound">ys</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">|</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">zs</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">zs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">=</span> <span class="free">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> toplevel_summands_lderivs_Star_nonempty<span class="main">)</span>

<span class="keyword1" id="Pi_Derivatives-ex_lderivs_Pr"><span class="command">lemma</span></span> ex_lderivs_Pr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> lderivs <span class="free">ass</span> <span class="main">(</span>Pr <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Pr <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ass</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Derivatives-toplevel_summands_PLUS"><span class="command">lemma</span></span> toplevel_summands_PLUS<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> toplevel_summands <span class="main">(</span>PLUS <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> toplevel_summands <span class="main">(</span><span class="free">f</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Pi_Derivatives-lderiv_toplevel_summands_Zero"><span class="command">lemma</span></span> lderiv_toplevel_summands_Zero<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>lderivs <span class="free">xs</span> <span class="main">(</span>Pr <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Pr <span class="free">s</span><span class="main">;</span> toplevel_summands <span class="free">r</span> <span class="main">=</span> <span class="main">{</span>Zero<span class="main">}</span><span class="main">⟧</span> <span class="main">⟹</span> toplevel_summands <span class="free">s</span> <span class="main">=</span> <span class="main">{</span>Zero<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>PLUS <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> lderiv <span class="bound">a</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">embed</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Zero<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">embed</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> toplevel_summands_PLUS<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> toplevel_summands_lderiv<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pi_Derivatives-toplevel_summands_lderivs_Pr"><span class="command">lemma</span></span> toplevel_summands_lderivs_Pr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> lderivs <span class="free">xs</span> <span class="main">(</span>Pr <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Pr <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
    toplevel_summands <span class="free">s</span> <span class="main">⊆</span> <span class="main">{</span>Zero<span class="main">}</span> <span class="main">∨</span> toplevel_summands <span class="free">s</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> toplevel_summands <span class="main">(</span>lderivs <span class="bound">xs</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">embed</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lderiv_toplevel_summands_Zero<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toplevel_summands_PLUS<span class="main"><span class="main">[</span></span><span class="operator">OF</span> False<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> lderivs.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"toplevel_summands <span class="skolem">s</span> <span class="main">⊆</span> <span class="main">{</span>Zero<span class="main">}</span> <span class="main">∨</span> toplevel_summands <span class="skolem">s</span> <span class="main">⊆</span>
       <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> toplevel_summands <span class="main">(</span>lderivs <span class="bound">xs</span> <span class="main">(</span>PLUS <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> lderiv <span class="bound">a</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">embed</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∨</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> *<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons *<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> toplevel_summands <span class="main">(</span>lderivs <span class="bound">xs</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lderivs_PLUS toplevel_summands_PLUS<span class="main"><span class="main">[</span></span><span class="operator">OF</span> False<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> lderivs.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pi_Derivatives-lderivs_Pr"><span class="command">lemma</span></span> lderivs_Pr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>lderivs <span class="bound">xs</span> <span class="main">(</span>Pr <span class="free">r</span><span class="main">)</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> True<span class="main">}</span> <span class="main">⊆</span>
    <span class="main">{</span>Pr <span class="bound">s</span> <span class="main">|</span> <span class="bound">s</span><span class="main">.</span> toplevel_summands <span class="bound">s</span> <span class="main">⊆</span> <span class="main">{</span>Zero<span class="main">}</span> <span class="main">∨</span>
               toplevel_summands <span class="bound">s</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> toplevel_summands <span class="main">(</span>lderivs <span class="bound">xs</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span><span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> lderivs <span class="skolem">xs</span> <span class="main">(</span>Pr <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"lderivs <span class="skolem">xs</span> <span class="main">(</span>Pr <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Pr <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex_lderivs_Pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> toplevel_summands_lderivs_Pr <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> allE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Derivatives-ACI_norm_toplevel_summands_Zero"><span class="command">lemma</span></span> ACI_norm_toplevel_summands_Zero<span class="main">:</span> <span class="quoted"><span class="quoted">"toplevel_summands <span class="free">r</span> <span class="main">⊆</span> <span class="main">{</span>Zero<span class="main">}</span> <span class="main">⟹</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ACI_norm_flatten<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subset_singletonD<span class="main">)</span>

<span class="keyword1" id="Pi_Derivatives-ACI_norm_lderivs_Pr"><span class="command">lemma</span></span> ACI_norm_lderivs_Pr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ACI_norm <span class="main">`</span> <span class="main">{</span>lderivs <span class="bound">xs</span> <span class="main">(</span>Pr <span class="free">r</span><span class="main">)</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> True<span class="main">}</span> <span class="main">⊆</span>
    <span class="main">{</span>Pr Zero<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>Pr <span class="main">«</span><span class="bound">s</span><span class="main">»</span> <span class="main">|</span> <span class="bound">s</span><span class="main">.</span> toplevel_summands <span class="bound">s</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> toplevel_summands <span class="main">«</span>lderivs <span class="bound">xs</span> <span class="free">r</span><span class="main">»</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> image_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lderivs_Pr<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> subsetI<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">elim</span> imageE CollectE exE conjE disjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">x'</span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rexp"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">«</span><span class="skolem">x'</span><span class="main">»</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> Pr <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"toplevel_summands <span class="skolem">s</span> <span class="main">⊆</span> <span class="main">{</span>Zero<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>Pr <span class="skolem">s</span><span class="main">»</span> <span class="main">=</span> Pr Zero"</span></span> <span class="keyword1"><span class="command">using</span></span> ACI_norm_toplevel_summands_Zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>Pr Zero<span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Pr <span class="main">«</span><span class="bound">s</span><span class="main">»</span> <span class="main">|</span><span class="bound">s</span><span class="main">.</span> toplevel_summands <span class="bound">s</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> toplevel_summands <span class="main">«</span>lderivs <span class="bound">xs</span> <span class="free">r</span><span class="main">»</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">x'</span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rexp"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">«</span><span class="skolem">x'</span><span class="main">»</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> Pr <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"toplevel_summands <span class="skolem">s</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> toplevel_summands <span class="main">(</span>lderivs <span class="bound">xs</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">«</span><span class="skolem">s</span><span class="main">»</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> toplevel_summands <span class="main">«</span>lderivs <span class="bound">xs</span> <span class="free">r</span><span class="main">»</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toplevel_summands_ACI_norm<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Pr <span class="main">«</span><span class="main">«</span><span class="skolem">s</span><span class="main">»</span><span class="main">»</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> * ACI_norm_idem ACI_norm.simps<span class="main">(</span>10<span class="main">)</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>Pr Zero<span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Pr <span class="main">«</span><span class="bound">s</span><span class="main">»</span> <span class="main">|</span><span class="bound">s</span><span class="main">.</span> toplevel_summands <span class="bound">s</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> toplevel_summands <span class="main">«</span>lderivs <span class="bound">xs</span> <span class="free">r</span><span class="main">»</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Derivatives-finite_ACI_norm_toplevel_summands"><span class="command">lemma</span></span> finite_ACI_norm_toplevel_summands<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span> <span class="main">⟹</span> finite <span class="main">{</span><span class="free">f</span> <span class="main">«</span><span class="bound">s</span><span class="main">»</span> <span class="main">|</span><span class="bound">s</span><span class="main">.</span> toplevel_summands <span class="bound">s</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> finite_surj <span class="main"><span class="main">[</span></span><span class="operator">OF</span> iffD2 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_Pow_iff<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span> <span class="keyword1"><span class="keyword1">o</span></span> flatten PLUS <span class="keyword1"><span class="keyword1">o</span></span> image ACI_norm"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ACI_norm_flatten<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Pi_Derivatives-lderivs_Not"><span class="command">lemma</span></span> lderivs_Not<span class="main">:</span> <span class="quoted"><span class="quoted">"lderivs <span class="free">xs</span> <span class="main">(</span>Not <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Not <span class="main">(</span>lderivs <span class="free">xs</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Derivatives-lderivs_Inter"><span class="command">lemma</span></span> lderivs_Inter<span class="main">:</span> <span class="quoted"><span class="quoted">"lderivs <span class="free">xs</span> <span class="main">(</span>Inter <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span>lderivs <span class="free">xs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>lderivs <span class="free">xs</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> finite_lderivs<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">«</span>lderivs <span class="bound">xs</span> <span class="free">r</span><span class="main">»</span> <span class="main">|</span> <span class="bound">xs</span> <span class="main">.</span> True<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Zero <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Full <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> One <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span>Zero<span class="main"><span class="main"><span class="main">,</span></span></span> One<span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> insertE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lderivs_One<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Atom <span class="skolem">as</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span>Zero<span class="main"><span class="main"><span class="main">,</span></span></span> One<span class="main"><span class="main"><span class="main">,</span></span></span> Atom <span class="skolem"><span class="skolem"><span class="skolem">as</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> insertE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lderivs_Atom<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lderivs_Plus <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_cartesian_product<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Plus<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>toplevel_summands <span class="main">`</span> <span class="main">{</span><span class="main">«</span>lderivs <span class="bound">xs</span> <span class="skolem">s</span><span class="main">»</span> <span class="main">|</span> <span class="bound">xs</span> <span class="main">.</span> True<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">«</span><span class="bound">r'</span><span class="main">»</span> <span class="main">|</span><span class="bound">r'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> toplevel_summands <span class="main">(</span>lderivs <span class="bound">ys</span> <span class="skolem">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">r'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> toplevel_summands <span class="main">«</span>lderivs <span class="bound">ys</span> <span class="skolem">s</span><span class="main">»</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> toplevel_summands_ACI_norm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">«</span><span class="bound">r'</span><span class="main">»</span> <span class="main">|</span><span class="bound">r'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> toplevel_summands <span class="main">(</span>lderivs <span class="bound">ys</span> <span class="skolem">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>toplevel_summands <span class="main">`</span> <span class="main">{</span><span class="main">«</span>lderivs <span class="bound">xs</span> <span class="skolem">s</span><span class="main">»</span> <span class="main">|</span> <span class="bound">xs</span> <span class="main">.</span> True<span class="main">}</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="main">{</span>Times <span class="main">(</span>lderivs <span class="bound">ys</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">|</span> <span class="bound">ys</span><span class="main">.</span> True<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">r'</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ys</span><span class="main">.</span> toplevel_summands <span class="main">(</span>lderivs <span class="bound">ys</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ACI_norm_flatten<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">rule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">X</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">X</span></span> <span class="main"><span class="main">⊆</span></span> ACI_norm <span class="main"><span class="main">`</span></span> <span class="var"><span class="var">?X</span></span> <span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">}</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"flatten PLUS"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊆</span> ACI_norm <span class="main">`</span> <span class="var">?X</span> <span class="bound">xs</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Times<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r</span><span class="main">.</span> Times <span class="bound">r</span> <span class="main">«</span><span class="skolem">s</span><span class="main">»</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> toplevel_summands_lderivs_Times<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">r'</span><span class="main">.</span> Times <span class="bound">r'</span> <span class="main">(</span>Star <span class="main">(</span><span class="bound">f</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Star <span class="skolem">r</span><span class="main">}</span> <span class="main">∪</span> <span class="var">?f</span> id <span class="main">`</span> <span class="main">{</span><span class="bound">r'</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="main">{</span>lderivs <span class="bound">ys</span> <span class="skolem">r</span><span class="main">|</span><span class="bound">ys</span><span class="main">.</span> True<span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ACI_norm_flatten<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">rule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">X</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">X</span></span> <span class="main"><span class="main">⊆</span></span> ACI_norm <span class="main"><span class="main">`</span></span> <span class="var"><span class="var">?X</span></span><span class="main"><span class="main">}</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"flatten PLUS"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> ACI_norm <span class="main">`</span> <span class="var">?f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="bound">X</span> <span class="main">=</span> <span class="var">?f</span> ACI_norm <span class="main">`</span> ACI_norm <span class="main">`</span> <span class="bound">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊆</span> ACI_norm <span class="main">`</span> <span class="var">?X</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_Collect_subsets<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> ACI_norm"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Star<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> toplevel_summands_lderivs_Star<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Not <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lderivs_Not<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_surj<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inter <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lderivs_Inter <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_cartesian_product<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Inter<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pr <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>toplevel_summands <span class="main">`</span> <span class="main">{</span><span class="main">«</span>lderivs <span class="bound">xs</span> <span class="skolem">r</span><span class="main">»</span> <span class="main">|</span> <span class="bound">xs</span> <span class="main">.</span> True<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> toplevel_summands <span class="main">«</span>lderivs <span class="bound">xs</span> <span class="skolem">r</span><span class="main">»</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ *<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>Pr <span class="main">«</span><span class="bound">s</span><span class="main">»</span> <span class="main">|</span><span class="bound">s</span><span class="main">.</span> toplevel_summands <span class="bound">s</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> toplevel_summands <span class="main">«</span>lderivs <span class="bound">xs</span> <span class="skolem">r</span><span class="main">»</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_ACI_norm_toplevel_summands<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">«</span>lderivs <span class="bound">xs</span> <span class="main">(</span>Pr <span class="skolem">r</span><span class="main">)</span><span class="main">»</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">«</span><span class="bound">s</span><span class="main">»</span><span class="main">|</span> <span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> lderivs <span class="bound">xs</span> <span class="main">(</span>Pr <span class="skolem">r</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_subset<span class="main">[</span><span class="operator">OF</span> ACI_norm_lderivs_Pr<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> fin <span class="keyword1"><span class="command">unfolding</span></span> image_Collect <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Wellformedness and language of derivatives›</span></span>

<span class="keyword1" id="Pi_Derivatives-wf_lderiv"><span class="command">lemma</span></span> wf_lderiv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>lderiv <span class="free">w</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Pi_Derivatives-wf_lderivs"><span class="command">lemma</span></span> wf_lderivs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>lderivs <span class="free">ws</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_lderiv<span class="main">)</span>

<span class="keyword1" id="Pi_Derivatives-lQuot_map_project"><span class="command">lemma</span></span> lQuot_map_project<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> lists <span class="main">(</span><span class="free">Σ</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lQuot <span class="free">as</span> <span class="main">(</span>map <span class="free">project</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> map <span class="free">project</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">embed</span> <span class="free">as</span><span class="main">)</span><span class="main">.</span> lQuot <span class="bound">a</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI image_subsetI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xss</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xss</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zss</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> zss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zss</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">#</span> <span class="skolem">xss</span> <span class="main">=</span> map <span class="free">project</span> <span class="skolem">zss</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lQuot_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xss</span> <span class="main">=</span> map <span class="free">project</span> <span class="main">(</span>tl <span class="skolem">zss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> zss assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xss</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> embed<span class="main">[</span><span class="operator">OF</span> project<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lQuot_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xss</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xss</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">embed</span> <span class="free">as</span><span class="main">)</span><span class="main">.</span> lQuot <span class="bound">a</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map <span class="free">project</span> <span class="skolem">xss</span> <span class="main">∈</span> lQuot <span class="free">as</span> <span class="main">(</span>map <span class="free">project</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lQuot_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rev_image_eqI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> embed<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Derivatives-lang_lderiv"><span class="command">lemma</span></span> lang_lderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> <span class="free">w</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>lderiv <span class="free">w</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lQuot <span class="free">w</span> <span class="main">(</span>lang <span class="free">n</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pr <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w'</span><span class="main">.</span> <span class="bound">w'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">embed</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">⟹</span>  <span class="bound">w'</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> embed<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Pr<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> lQuot_map_project<span class="main">[</span><span class="operator">OF</span> Pr<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> lang_subset_lists<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_lderiv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def lang_final<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Pi_Derivatives-lang_lderivs"><span class="command">lemma</span></span> lang_lderivs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf_word <span class="free">n</span> <span class="free">ws</span><span class="main">⟧</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>lderivs <span class="free">ws</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lQuots <span class="free">ws</span> <span class="main">(</span>lang <span class="free">n</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang_lderiv<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lderivs_final<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"wf_word <span class="free">n</span> <span class="free">ws</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"final <span class="main">(</span>lderivs <span class="free">ws</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">ws</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lang_lderivs<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> lang_final<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lderivs <span class="free">ws</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">lderivs_set</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="main">«</span>lderivs <span class="bound">w</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">»</span><span class="main">,</span> <span class="main">«</span>lderivs <span class="bound">w</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">»</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span><span class="main">.</span> wf_word <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">w</span><span class="main">}</span>"</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Deriving preserves ACI-equivalence›</span></span>

<span class="keyword1" id="Pi_Derivatives-ACI_norm_PLUS"><span class="command">lemma</span></span> ACI_norm_PLUS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="bound">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="bound">s</span><span class="main">»</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="main">«</span>PLUS <span class="free">xs</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>PLUS <span class="free">ys</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> list_all2_lengthD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pi_Derivatives-toplevel_summands_ACI_norm_lderiv"><span class="command">lemma</span></span> toplevel_summands_ACI_norm_lderiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span>toplevel_summands <span class="free">r</span><span class="main">.</span> toplevel_summands <span class="main">«</span>lderiv <span class="free">as</span> <span class="main">«</span><span class="bound">a</span><span class="main">»</span><span class="main">»</span><span class="main">)</span> <span class="main">=</span> toplevel_summands <span class="main">«</span>lderiv <span class="free">as</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> toplevel_summands.simps toplevel_summands_ACI_norm
     toplevel_summands_lderiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">»</span>"</span></span><span class="main">]</span> image_Un Union_Un_distrib
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_UN<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> ACI_norm_lderiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span>lderiv <span class="free">as</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>lderiv <span class="free">as</span> <span class="free">r</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> lderiv.simps ACI_norm_flatten<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lderiv <span class="skolem">as</span> <span class="main">«</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">»</span>"</span></span><span class="main">]</span>
     toplevel_summands_lderiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">»</span>"</span></span><span class="main">]</span> image_Un image_UN
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toplevel_summands_ACI_norm toplevel_summands_flatten_ACI_norm_image_Union<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toplevel_summands_ACI_norm<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> toplevel_summands_ACI_norm_lderiv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pr <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="bound">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="bound">s</span><span class="main">»</span><span class="main">)</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> lderiv <span class="bound">a</span> <span class="main">«</span><span class="skolem">r</span><span class="main">»</span><span class="main">)</span> <span class="main">(</span><span class="free">embed</span> <span class="skolem">as</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> lderiv <span class="bound">a</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">embed</span> <span class="skolem">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_all2_map1 list_all2_map2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> list_all2_refl<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lderiv.simps ACI_norm.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ACI_norm_PLUS<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>


<span class="keyword1"><span class="command">corollary</span></span> lderiv_preserves<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">s</span><span class="main">»</span> <span class="main">⟹</span> <span class="main">«</span>lderiv <span class="free">as</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>lderiv <span class="free">as</span> <span class="free">s</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ACI_norm_lderiv ACI_norm_lderiv<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> arg_cong<span class="main">)</span>

<span class="keyword1" id="Pi_Derivatives-lderivs_snoc"><span class="command">lemma</span></span> lderivs_snoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lderivs <span class="main">(</span><span class="free">ws</span> <span class="main">@</span> <span class="main">[</span><span class="free">w</span><span class="main">]</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>lderiv <span class="free">w</span> <span class="main">(</span>lderivs <span class="free">ws</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> ACI_norm_lderivs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span>lderivs <span class="free">ws</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>lderivs <span class="free">ws</span> <span class="free">r</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">w</span> <span class="skolem">ws</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ACI_norm_lderiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="quoted">"lderivs <span class="skolem">ws</span> <span class="skolem">r</span>"</span></span><span class="main">]</span> ACI_norm_lderiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="quoted">"lderivs <span class="skolem">ws</span> <span class="main">«</span><span class="skolem">r</span><span class="main">»</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pi_Derivatives-lderivs_alt"><span class="command">lemma</span></span> lderivs_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span>lderivs <span class="free">w</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>lderiv <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> <span class="free">w</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ACI_norm_lderiv<span class="main">)</span>

<span class="keyword1" id="Pi_Derivatives-finite_fold_lderiv"><span class="command">lemma</span></span> finite_fold_lderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>lderiv <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> <span class="bound">w</span> <span class="main">«</span><span class="free">s</span><span class="main">»</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_lderivs <span class="keyword1"><span class="command">unfolding</span></span> lderivs_alt <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Pi_Regular_Operators">
<div class="head">
<h1>Theory Pi_Regular_Operators</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Some Useful Regular Operators"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Pi_Regular_Operators
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Pi_Derivatives">Pi_Derivatives</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">REV</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">REV</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">REV</span> Full <span class="main">=</span> Full"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">REV</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">REV</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">REV</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">REV</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">REV</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">REV</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">REV</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">REV</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">REV</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Star <span class="main">(</span><span class="free">REV</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">REV</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Not <span class="main">(</span><span class="free">REV</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">REV</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span><span class="free">REV</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">REV</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">REV</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Pr <span class="main">(</span><span class="free">REV</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Operators-REV_REV"><span class="command">lemma</span></span> REV_REV<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"REV <span class="main">(</span>REV <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-final_REV"><span class="command">lemma</span></span> final_REV<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"final <span class="main">(</span>REV <span class="free">r</span><span class="main">)</span> <span class="main">=</span> final <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-REV_PLUS"><span class="command">lemma</span></span> REV_PLUS<span class="main">:</span> <span class="quoted"><span class="quoted">"REV <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> PLUS <span class="main">(</span>map REV <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> alphabet<span class="main">)</span> wf_REV<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>REV <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> project<span class="main">)</span> lang_REV<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>REV <span class="free">r</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">`</span> lang <span class="free">n</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_image rev_map image_set_diff<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> embed
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rderiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> rexp <span class="main">⇒</span> <span class="tfree">'b</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rderiv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Full <span class="main">=</span> Full"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> One <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">lookup</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> One <span class="keyword1">else</span> Zero<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">rderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">rs'</span> <span class="main">=</span> Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">rderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="keyword1">if</span> final <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Plus <span class="bound">rs'</span> <span class="main">(</span><span class="free">rderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">rs'</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Not <span class="main">(</span><span class="free">rderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span><span class="free">rderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Pr <span class="main">(</span>PLUS <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> <span class="free">rderiv</span> <span class="bound">a'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">embed</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rderivs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rderivs</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderivs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free">rderivs</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">(</span>rderiv <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Operators-rderivs_snoc"><span class="command">lemma</span></span> rderivs_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"rderivs <span class="main">(</span><span class="free">ws</span> <span class="main">@</span> <span class="main">[</span><span class="free">w</span><span class="main">]</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> rderiv <span class="free">w</span> <span class="main">(</span>rderivs <span class="free">ws</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-rderivs_append"><span class="command">lemma</span></span> rderivs_append<span class="main">:</span> <span class="quoted"><span class="quoted">"rderivs <span class="main">(</span><span class="free">ws</span> <span class="main">@</span> <span class="free">ws'</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> rderivs <span class="free">ws'</span> <span class="main">(</span>rderivs <span class="free">ws</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-rderiv_lderiv"><span class="command">lemma</span></span> rderiv_lderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"rderiv <span class="free">as</span> <span class="free">r</span> <span class="main">=</span> REV <span class="main">(</span>lderiv <span class="free">as</span> <span class="main">(</span>REV <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def o_def REV_PLUS<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-rderivs_lderivs"><span class="command">lemma</span></span> rderivs_lderivs<span class="main">:</span> <span class="quoted"><span class="quoted">"rderivs <span class="free">w</span> <span class="free">r</span> <span class="main">=</span> REV <span class="main">(</span>lderivs <span class="free">w</span> <span class="main">(</span>REV <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rderiv_lderiv<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-wf_rderiv"><span class="command">lemma</span></span> wf_rderiv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>rderiv <span class="free">w</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rderiv_lderiv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_REV<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_lderiv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_REV<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-wf_rderivs"><span class="command">lemma</span></span> wf_rderivs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>rderivs <span class="free">ws</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rderivs_lderivs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_REV<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_lderivs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_REV<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-lang_rderiv"><span class="command">lemma</span></span> lang_rderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>rderiv <span class="free">as</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> rQuot <span class="free">as</span> <span class="main">(</span>lang <span class="free">n</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rderiv_lderiv rQuot_rev_lQuot <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_lderiv<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-lang_rderivs"><span class="command">lemma</span></span> lang_rderivs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf_word <span class="free">n</span> <span class="free">w</span><span class="main">⟧</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>rderivs <span class="free">w</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> rQuots <span class="free">w</span> <span class="main">(</span>lang <span class="free">n</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rderivs_lderivs rQuots_rev_lQuots <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_lderivs<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> rderivs_final<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"wf_word <span class="free">n</span> <span class="free">w</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"final <span class="main">(</span>rderivs <span class="free">w</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟷</span> rev <span class="free">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lang_rderivs<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> lang_final<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rderivs <span class="free">w</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-toplevel_summands_REV"><span class="command">lemma</span></span> toplevel_summands_REV<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>REV <span class="free">r</span><span class="main">)</span> <span class="main">=</span> REV <span class="main">`</span> toplevel_summands <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-ACI_norm_REV"><span class="command">lemma</span></span> ACI_norm_REV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span>REV <span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>REV <span class="free">r</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">unfold_abs_def</span> <span class="main"><span class="main">=</span></span> <span class="quasi_keyword">false</span><span class="main">]</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> REV.simps ACI_norm.simps Plus<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> image_Un<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      toplevel_summands.simps<span class="main">(</span>1<span class="main">)</span> toplevel_summands_ACI_norm toplevel_summands_REV
    <span class="keyword1"><span class="command">unfolding</span></span> toplevel_summands.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> ACI_norm_flatten toplevel_summands_REV
    <span class="keyword1"><span class="command">unfolding</span></span> ACI_norm_flatten<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> toplevel_summands_ACI_norm
    <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-ACI_norm_rderiv"><span class="command">lemma</span></span> ACI_norm_rderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span>rderiv <span class="free">as</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>rderiv <span class="free">as</span> <span class="free">r</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rderiv_lderiv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ACI_norm_REV ACI_norm_lderiv<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-ACI_norm_rderivs"><span class="command">lemma</span></span> ACI_norm_rderivs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span>rderivs <span class="free">w</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="free">w</span> <span class="free">r</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rderivs_lderivs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ACI_norm_REV ACI_norm_lderivs<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> finite_rderivs<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">«</span>rderivs <span class="bound">xs</span> <span class="free">r</span><span class="main">»</span> <span class="main">|</span> <span class="bound">xs</span> <span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rderivs_lderivs
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ACI_norm_REV<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_lderivs<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">«</span>REV <span class="bound">r</span><span class="main">»</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-lderiv_PLUS"><span class="command">lemma</span></span> lderiv_PLUS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lderiv <span class="free">a</span> <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> PLUS <span class="main">(</span>map <span class="main">(</span>lderiv <span class="free">a</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-rderiv_PLUS"><span class="command">lemma</span></span> rderiv_PLUS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rderiv <span class="free">a</span> <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> PLUS <span class="main">(</span>map <span class="main">(</span>rderiv <span class="free">a</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-lang_rderiv_lderiv"><span class="command">lemma</span></span> lang_rderiv_lderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>rderiv <span class="free">a</span> <span class="main">(</span>lderiv <span class="free">b</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>lderiv <span class="free">b</span> <span class="main">(</span>rderiv <span class="free">a</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def conc_assoc<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-lang_lderiv_rderiv"><span class="command">lemma</span></span> lang_lderiv_rderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>lderiv <span class="free">a</span> <span class="main">(</span>rderiv <span class="free">b</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>rderiv <span class="free">b</span> <span class="main">(</span>lderiv <span class="free">a</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def conc_assoc<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-lang_rderiv_lderivs"><span class="command">lemma</span></span> lang_rderiv_lderivs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf_word <span class="free">n</span> <span class="free">w</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span>
  lang <span class="free">n</span> <span class="main">(</span>rderiv <span class="free">a</span> <span class="main">(</span>lderivs <span class="free">w</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>lderivs <span class="free">w</span> <span class="main">(</span>rderiv <span class="free">a</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang_lderivs lang_lderiv lang_rderiv lQuot_rQuot<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-lang_lderiv_rderivs"><span class="command">lemma</span></span> lang_lderiv_rderivs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf_word <span class="free">n</span> <span class="free">w</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span>
  lang <span class="free">n</span> <span class="main">(</span>lderiv <span class="free">a</span> <span class="main">(</span>rderivs <span class="free">w</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>rderivs <span class="free">w</span> <span class="main">(</span>lderiv <span class="free">a</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang_rderivs lang_lderiv lang_rderiv lQuot_rQuot<span class="main">)</span>
<span class="comment1">(*
primrec bideriv :: "'a ⇒ 'a ⇒ 'a rexp ⇒ 'a rexp" where
  "bideriv _ _ Zero = Zero"
| "bideriv _ _ One = Zero"
| "bideriv a b (Atom c) = Zero"
| "bideriv a b (Plus r s) = Plus (bideriv a b r) (bideriv a b s)"
| "bideriv a b (Times r s) =
    (let rs' = Times (lderiv a r) (rderiv b s)
     in if final r ∧ final s then Plus (Plus rs' (bideriv a b r)) (bideriv a b s)
        else if final r then Plus rs' (bideriv a b s)
        else if final s then Plus rs' (bideriv a b r)
        else rs')"
| "bideriv a b (Star r) = Plus (bideriv a b r) (TIMES [lderiv a r, Star r, rderiv b r])"
| "bideriv a b (Not r) = Not (bideriv a b r)"
| "bideriv a b (Inter r s) = Inter (bideriv a b r) (bideriv a b s)"
| "bideriv a b (Pr r) = Pr (PLUS (map (λb. PLUS (map (λa. bideriv a b r) (embed a))) (embed b)))"

lemma wf_bideriv[simp]: "wf n r ⟹ wf n (bideriv a b r)"
  by (induct r arbitrary: n a b) (auto simp: maps_def Let_def)

lemma ACI_norm_bideriv_rderiv_lderiv: "«bideriv a b r» = «rderiv b (lderiv a r)»"
  by (induct r arbitrary: a b)
    (auto simp: Let_def maps_def o_def list_all2_map1 list_all2_map2 intro!: ACI_PLUS list_all2_refl)

lemma bideriv_rderiv_lderiv:
  "lang n (bideriv a b r) = lang n (rderiv b (lderiv a r))"
  by (induct r arbitrary: n a b) (auto simp: Let_def)

lemma lang_bideriv:
  "⟦wf n r; a ∈ Σ n; b ∈ Σ n⟧ ⟹ lang n (bideriv a b r) = biQuot a b (lang n r)"
  by (auto simp: bideriv_rderiv_lderiv lang_lderiv lang_rderiv biQuot_rQuot_lQuot)

lemma ACI_norm_bideriv: "«bideriv a b «r»» = «bideriv a b r»"
  unfolding ACI_norm_bideriv_rderiv_lderiv by (metis ACI_norm_lderiv ACI_norm_rderiv)

fun biderivs where
  "biderivs [] [] r = r"
| "biderivs as [] r = lderivs as r"
| "biderivs [] bs r = rderivs bs r"
| "biderivs (a#as) (b#bs) r = biderivs as bs (bideriv a b r)"

lemma biderivs_rderivs_lderivs: "⟦wf n r; wf_word n w1; wf_word n w2⟧ ⟹
  lang n (biderivs w1 w2 r) = lang n (rderivs w2 (lderivs w1 r))"
  by (induct arbitrary: r rule: biderivs.induct)
    (auto simp: lang_rderivs lang_lderivs bideriv_rderiv_lderiv)

lemma lang_biderivs:
  "⟦wf n r; wf_word n w1; wf_word n w2⟧ ⟹ lang n (biderivs w1 w2 r) = biQuots w1 w2 (lang n r)"
  by (auto simp: biderivs_rderivs_lderivs lang_lderivs lang_rderivs biQuots_rQuots_lQuots)

lemma wf_biderivs[simp]: "wf n r ⟹ wf n (biderivs w1 w2 r)"
  by (induct arbitrary: r rule: biderivs.induct) auto
*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">biderivs</span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="free"><span class="bound"><span class="entity">w2</span></span></span> <span class="main">=</span> rderivs <span class="free"><span class="bound"><span class="entity">w2</span></span></span> <span class="keyword1">o</span> lderivs <span class="free"><span class="bound"><span class="entity">w1</span></span></span>"</span></span>

<span class="keyword1" id="Pi_Regular_Operators-lang_biderivs"><span class="command">lemma</span></span> lang_biderivs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf_word <span class="free">n</span> <span class="free">w1</span><span class="main">;</span> wf_word <span class="free">n</span> <span class="free">w2</span><span class="main">⟧</span> <span class="main">⟹</span>
  lang <span class="free">n</span> <span class="main">(</span>biderivs <span class="free">w1</span> <span class="free">w2</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> biQuots <span class="free">w1</span> <span class="free">w2</span> <span class="main">(</span>lang <span class="free">n</span> <span class="free">r</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> biderivs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang_rderivs lang_lderivs in_lists_conv_set<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-wf_biderivs"><span class="command">lemma</span></span> wf_biderivs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>biderivs <span class="free">w1</span> <span class="free">w2</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> biderivs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> biderivs_final<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"wf_word <span class="free">n</span> <span class="free">w1</span>"</span></span> <span class="quoted"><span class="quoted">"wf_word <span class="free">n</span> <span class="free">w2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"final <span class="main">(</span>biderivs <span class="free">w1</span> <span class="free">w2</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">w1</span> <span class="main">@</span> rev <span class="free">w2</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lang_biderivs<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> lang_final<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"biderivs <span class="free">w1</span> <span class="free">w2</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-ACI_norm_biderivs"><span class="command">lemma</span></span> ACI_norm_biderivs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span>biderivs <span class="free">w1</span> <span class="free">w2</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>biderivs <span class="free">w1</span> <span class="free">w2</span> <span class="free">r</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> biderivs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ACI_norm_lderivs ACI_norm_rderivs o_apply<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">«</span>biderivs <span class="bound">w1</span> <span class="bound">w2</span> <span class="free">r</span><span class="main">»</span> <span class="main">|</span> <span class="bound">w1</span> <span class="bound">w2</span> <span class="main">.</span> True<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">«</span>biderivs <span class="bound">w1</span> <span class="bound">w2</span> <span class="free">r</span><span class="main">»</span> <span class="main">|</span> <span class="bound">w1</span> <span class="bound">w2</span> <span class="main">.</span> True<span class="main">}</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">⋃</span><span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="main">«</span>lderivs <span class="bound">as</span> <span class="free">r</span><span class="main">»</span> <span class="main">|</span> <span class="bound">as</span> <span class="main">.</span> True<span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="main">«</span>rderivs <span class="bound">bs</span> <span class="bound">s</span><span class="main">»</span> <span class="main">|</span> <span class="bound">bs</span> <span class="main">.</span> True<span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> biderivs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ACI_norm_rderivs<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_UN<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_lderivs<span class="main"><span class="main">]</span></span> ballI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_rderivs<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Quotioning by the same letter›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fin_cut_same</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> take <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> drop <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="Pi_Regular_Operators-fin_cut_same_Nil"><span class="command">lemma</span></span> fin_cut_same_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fin_cut_same <span class="free">x</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fin_cut_same_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pi_Regular_Operators-Least_fin_cut_same"><span class="command">lemma</span></span> Least_fin_cut_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> drop <span class="bound">n</span> <span class="free">xs</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span>
  length <span class="free">xs</span> <span class="main">-</span> length <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Least <span class="var">?P</span> <span class="main">=</span> <span class="var">?min</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Least_equality<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="var">?min</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  Suc_diff_le replicate_append_same<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">m</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">-</span> <span class="skolem">m</span> <span class="main">≤</span> length <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> length_takeWhile_less_P_nth<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">-</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="skolem">m</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons'<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">m</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?min</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>
    

<span class="keyword1" id="Pi_Regular_Operators-takeWhile_takes_all"><span class="command">lemma</span></span> takeWhile_takes_all<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> length <span class="main">(</span>takeWhile <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> Ball <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">hypsubst_thin</span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-fin_cut_same_Cons"><span class="command">lemma</span></span> fin_cut_same_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fin_cut_same <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> fin_cut_same <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="keyword1">else</span> <span class="free">y</span> <span class="main">#</span> fin_cut_same <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fin_cut_same_def Least_fin_cut_same
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> takeWhile_takes_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> takeWhile_takes_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Suc_diff_le length_rev length_takeWhile_le take_Suc_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> takeWhile_takes_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> takeWhile_append2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> takeWhile_takes_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Suc_diff_le length_rev length_takeWhile_le take_Suc_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Pi_Regular_Operators-fin_cut_same_singleton"><span class="command">lemma</span></span> fin_cut_same_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fin_cut_same <span class="free">x</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> fin_cut_same <span class="free">x</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-fin_cut_same_replicate"><span class="command">lemma</span></span> fin_cut_same_replicate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fin_cut_same <span class="free">x</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> replicate <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> fin_cut_same <span class="free">x</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> replicate_append_same<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> append_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> append_assoc<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-fin_cut_sameE"><span class="command">lemma</span></span> fin_cut_sameE<span class="main">:</span> <span class="quoted"><span class="quoted">"fin_cut_same <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> replicate <span class="bound">m</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> replicate_Suc<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">SAMEQUOT</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span>fin_cut_same <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">x</span> <span class="main">@</span> replicate <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">|</span> <span class="bound">x</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Operators-SAMEQUOT_mono"><span class="command">lemma</span></span> SAMEQUOT_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> SAMEQUOT <span class="free">a</span> <span class="free">A</span> <span class="main">⊆</span> SAMEQUOT <span class="free">a</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SAMEQUOT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">locale</span></span> embed2 <span class="main">=</span> embed <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="free">wf_atom</span></span> <span class="quoted"><span class="free">project</span></span> <span class="quoted"><span class="free">lookup</span></span> <span class="quoted"><span class="free">embed</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">wf_atom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> linorder <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">project</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">embed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">singleton</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">wf_atom</span> <span class="free">n</span> <span class="main">(</span><span class="free">singleton</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lookup_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="main">(</span><span class="free">singleton</span> <span class="free">a</span><span class="main">)</span> <span class="free">a'</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="free">a'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Pi_Regular_Operators-finite_rderivs_same"><span class="command">lemma</span></span> finite_rderivs_same<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="bound">m</span> <span class="free">a</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">|</span> <span class="bound">m</span> <span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_rderivs<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-wf_word_replicate"><span class="command">lemma</span></span> wf_word_replicate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free">n</span> <span class="main">⟹</span> wf_word <span class="free">n</span> <span class="main">(</span>replicate <span class="free">m</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-star_singleton"><span class="command">lemma</span></span> star_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"star <span class="main">{</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>replicate <span class="bound">m</span> <span class="free">x</span> <span class="main">|</span> <span class="bound">m</span> <span class="main">.</span> True<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> star <span class="main">{</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="main">{</span>replicate <span class="bound">m</span> <span class="free">x</span> <span class="main">|</span> <span class="bound">m</span> <span class="main">.</span> True<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> replicate_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Ball_starI<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">samequot</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Times <span class="main">(</span>flatten PLUS <span class="main">{</span><span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">»</span> <span class="main">|</span> <span class="bound">m</span> <span class="main">.</span> True<span class="main">}</span><span class="main">)</span> <span class="main">(</span>Star <span class="main">(</span>Atom <span class="main">(</span><span class="free">singleton</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Operators-wf_samequot"><span class="command">lemma</span></span> wf_samequot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>samequot <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> samequot_def wf.simps wf_flatten_PLUS<span class="main">[</span><span class="operator">OF</span> finite_rderivs_same<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-lang_samequot"><span class="command">lemma</span></span> lang_samequot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> 
   lang <span class="free">n</span> <span class="main">(</span>samequot <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> SAMEQUOT <span class="free">a</span> <span class="main">(</span>lang <span class="free">n</span> <span class="free">r</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> SAMEQUOT_def samequot_def lang.simps lang_flatten_PLUS<span class="main">[</span><span class="operator">OF</span> finite_rderivs_same<span class="main">]</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang_rderivs<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> concI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> fin_cut_sameE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang_rderivs<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> subst<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> concE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang_rderivs<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
   <span class="keyword1"><span class="command">unfolding</span></span> fin_cut_same_replicate
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> trans<span class="main">)</span>
   <span class="keyword1"><span class="command">unfolding</span></span> fin_cut_same_replicate
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rderiv_and_add</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rderiv_and_add</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">::</span> bool<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span>
      <span class="bound">r</span> <span class="main">=</span> <span class="main">«</span>rderiv <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span><span class="main">»</span>
    <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>True<span class="main">,</span> <span class="bound">r</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">invar_rderiv_and_add</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">brs</span></span></span> <span class="main">≡</span>
  <span class="main">(</span><span class="keyword1">if</span> fst <span class="free"><span class="bound"><span class="entity">brs</span></span></span> <span class="keyword1">then</span> True <span class="keyword1">else</span> <span class="main">«</span>rderiv <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span>hd <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">brs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">»</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">brs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  snd <span class="free"><span class="bound"><span class="entity">brs</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> distinct <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">brs</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">brs</span></span></span><span class="main">)</span><span class="main">.</span> snd <span class="free"><span class="bound"><span class="entity">brs</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">brs</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">»</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Operators-invar_rderiv_and_add_init"><span class="command">lemma</span></span> invar_rderiv_and_add_init<span class="main">:</span> <span class="quoted"><span class="quoted">"invar_rderiv_and_add <span class="free">as</span> <span class="free">r</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">[</span><span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> invar_rderiv_and_add_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-invar_rderiv_and_add_step"><span class="command">lemma</span></span> invar_rderiv_and_add_step<span class="main">:</span> <span class="quoted"><span class="quoted">"invar_rderiv_and_add <span class="free">as</span> <span class="free">r</span> <span class="free">brs</span> <span class="main">⟹</span> fst <span class="free">brs</span> <span class="main">⟹</span>
  invar_rderiv_and_add <span class="free">as</span> <span class="free">r</span> <span class="main">(</span>rderiv_and_add <span class="free">as</span> <span class="free">brs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> invar_rderiv_and_add_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">brs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>
    Let_def nth_Cons' ACI_norm_rderiv rderivs_snoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> neq_Nil_conv replicate_append_same<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-rderivs_replicate_mult"><span class="command">lemma</span></span> rderivs_replicate_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="free">i</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">;</span> <span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">i</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span><span class="skolem">m</span> <span class="main">*</span> <span class="free">i</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="free">i</span> <span class="free">as</span><span class="main">)</span> <span class="skolem">r</span><span class="main">»</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="skolem">r</span><span class="main">»</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ACI_norm_rderivs<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ACI_norm_rderivs replicate_add rderivs_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pi_Regular_Operators-rderivs_replicate_mult_rest"><span class="command">lemma</span></span> rderivs_replicate_mult_rest<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="free">i</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">i</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="free">k</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="free">k</span> <span class="free">as</span><span class="main">)</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">i</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span><span class="main">»</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ACI_norm_rderivs replicate_add rderivs_append<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">i</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rderivs_replicate_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ACI_norm_rderivs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Regular_Operators-rderivs_replicate_mod"><span class="command">lemma</span></span> rderivs_replicate_mod<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="free">i</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="free">m</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span><span class="free">m</span> <span class="keyword1">mod</span> <span class="free">i</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> div_mult_mod_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">intro</span> rderivs_replicate_mult_rest<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> mod_less_divisor<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-rderivs_replicate_diff"><span class="command">lemma</span></span> rderivs_replicate_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="free">i</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="free">j</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span><span class="main">;</span> <span class="free">i</span> <span class="main">&gt;</span> <span class="free">j</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>rderivs <span class="main">(</span>replicate <span class="free">j</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="free">j</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rderivs_append<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> replicate_add<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-samequot_wf"><span class="command">lemma</span></span> samequot_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"while_option fst <span class="main">(</span>rderiv_and_add <span class="free">as</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">[</span><span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="main">(</span>PLUS <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> while_option_stop<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> while_option_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"invar_rderiv_and_add <span class="free">as</span> <span class="free">r</span>"</span></span><span class="main">,</span>
    <span class="operator">OF</span> invar_rderiv_and_add_step assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> invar_rderiv_and_add_init<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"invar_rderiv_and_add <span class="free">as</span> <span class="free">r</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="main">(</span>PLUS <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> invar_rderiv_and_add_def wf_PLUS
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth wf_rderivs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Regular_Operators-samequot_soundness"><span class="command">lemma</span></span> samequot_soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"while_option fst <span class="main">(</span>rderiv_and_add <span class="free">as</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">[</span><span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>PLUS <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>lang <span class="free">n</span> <span class="main">`</span> <span class="main">{</span><span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="bound">m</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">|</span> <span class="bound">m</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> while_option_stop<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">from</span></span> while_option_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"invar_rderiv_and_add <span class="free">as</span> <span class="free">r</span>"</span></span><span class="main">,</span>
    <span class="operator">OF</span> invar_rderiv_and_add_step assms invar_rderiv_and_add_init<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"invar_rderiv_and_add <span class="free">as</span> <span class="free">r</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span>
       <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>rderivs <span class="var">?x</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> invar_rderiv_and_add_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth hd_conv_nth ACI_norm_rderiv
      rderivs_snoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> replicate_append_same<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>rderivs <span class="var">?x</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span>length <span class="free">rs</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar_rderiv_and_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> cyc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>rderivs <span class="var">?x</span> <span class="free">r</span><span class="main">)</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="var">?x</span> <span class="free">r</span><span class="main">»</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rderivs_replicate_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">rs</span><span class="main">.</span> <span class="free">rs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="skolem">m</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> length <span class="free">rs</span> <span class="main">-</span> Suc <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> i <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">m'</span> <span class="main">+</span> length <span class="free">rs</span> <span class="main">-</span> Suc <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="skolem">m</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="skolem">m'</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>rderivs <span class="var">?x</span> <span class="free">r</span><span class="main">)</span><span class="main">»</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> replicate_add<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> rderivs_append<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> cyc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span><span class="skolem">m'</span> <span class="keyword1">mod</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>rderivs <span class="var">?x</span> <span class="free">r</span><span class="main">)</span><span class="main">»</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> rderivs_replicate_mod<span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span><span class="skolem">m'</span> <span class="keyword1">mod</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">+</span> length <span class="free">rs</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> rderivs_append<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> replicate_add<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> m i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span><span class="main">(</span><span class="skolem">m</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">+</span> length <span class="free">rs</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Suc_diff_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">metis</span> less_Suc_eq_le mod_less_divisor zero_less_Suc<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free">rs</span><span class="main">.</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="skolem">m</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> Suc <span class="bound">j</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_imp_diff_less<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> invar_rderiv_and_add_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free">rs</span><span class="main">.</span> <span class="skolem">m</span> <span class="main">=</span> length <span class="free">rs</span> <span class="main">-</span> Suc <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">metis</span> diff_self_eq_0 gr_implies_not0 lessI nat.exhaust<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> One_nat_def Suc_diff_Suc diff_Suc_1 gr0_conv_Suc less_imp_diff_less
             not_less_eq not_less_iff_gr_or_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> invar_rderiv_and_add_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>lang <span class="free">n</span> <span class="main">`</span> <span class="main">{</span><span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="bound">m</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">|</span><span class="bound">m</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> lang <span class="free">n</span> <span class="main">(</span>PLUS <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>PLUS <span class="free">rs</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>lang <span class="free">n</span> <span class="main">`</span> <span class="main">{</span><span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="bound">m</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">|</span><span class="bound">m</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> invar_rderiv_and_add_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>PLUS <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>lang <span class="free">n</span> <span class="main">`</span> <span class="main">{</span><span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="bound">m</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">|</span><span class="bound">m</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Regular_Operators-length_subset_card"><span class="command">lemma</span></span> length_subset_card<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">X</span><span class="main">;</span> distinct <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">;</span> set <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">⟧</span> <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">&lt;</span> card <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_mono distinct_card impossible_Cons not_le_imp_less order_trans<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-samequot_termination"><span class="command">lemma</span></span> samequot_termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"while_option fst <span class="main">(</span>rderiv_and_add <span class="free">as</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">[</span><span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cl</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span>  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">«</span>rderivs <span class="main">(</span>replicate <span class="bound">m</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span><span class="main">»</span> <span class="main">|</span> <span class="bound">m</span> <span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">rs</span><span class="main">)</span><span class="main">.</span> card <span class="var">?D</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="bound">rs</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">st</span><span class="main">.</span> <span class="var">?cl</span> <span class="main">=</span> Some <span class="bound">st</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measure_while_option_Some<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"invar_rderiv_and_add <span class="free"><span class="free">as</span></span> <span class="free"><span class="free">r</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar_rderiv_and_add_init invar_rderiv_and_add_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar_rderiv_and_add_def Let_def neq_Nil_conv in_set_conv_nth
       <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_less_mono2 length_subset_card<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_rderivs_same<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_less_eq nth_Cons_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">samequot_exec</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
  Times <span class="main">(</span>PLUS <span class="main">(</span>snd <span class="main">(</span>the <span class="main">(</span>while_option fst <span class="main">(</span>rderiv_and_add <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">[</span><span class="main">«</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">»</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Star <span class="main">(</span>Atom <span class="main">(</span><span class="free">singleton</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Operators-wf_samequot_exec"><span class="command">lemma</span></span> wf_samequot_exec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>samequot_exec <span class="free">as</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> samequot_exec_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"while_option fst <span class="main">(</span>rderiv_and_add <span class="free">as</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">[</span><span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> samequot_termination samequot_wf<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-samequot_exec_samequot"><span class="command">lemma</span></span> samequot_exec_samequot<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>samequot_exec <span class="free">as</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>samequot <span class="free">as</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> samequot_exec_def samequot_def lang.simps lang_flatten_PLUS<span class="main">[</span><span class="operator">OF</span> finite_rderivs_same<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"while_option fst <span class="main">(</span>rderiv_and_add <span class="free">as</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">[</span><span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> samequot_termination <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> samequot_soundness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ACI_norm_lang<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Operators-lang_samequot_exec"><span class="command">lemma</span></span> lang_samequot_exec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>samequot_exec <span class="free">as</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> SAMEQUOT <span class="free">as</span> <span class="main">(</span>lang <span class="free">n</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> samequot_exec_samequot <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lang_samequot<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Suffix and Prefix Languages›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Suffix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Suffix</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Prefix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Prefix</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">w</span> <span class="main">@</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Operators-Prefix_Suffix"><span class="command">lemma</span></span> Prefix_Suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"Prefix <span class="free">L</span> <span class="main">=</span> rev <span class="main">`</span> Suffix <span class="main">(</span>rev <span class="main">`</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Prefix_def Suffix_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_append_invert
  <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">rev</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> rev_rev_ident<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
         image_eqI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">rev</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> rev_append<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Root</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Root</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span> <span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^^</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Cycle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Cycle</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">u</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">@</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> embed
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SUFFIX</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rexp <span class="main">⇒</span> <span class="tfree">'b</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SUFFIX</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> flatten PLUS <span class="main">{</span><span class="main">«</span>lderivs <span class="bound">w</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">»</span><span class="main">|</span> <span class="bound">w</span><span class="main">.</span> wf_word <span class="free">n</span> <span class="bound">w</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Operators-finite_lderivs_wf"><span class="command">lemma</span></span> finite_lderivs_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">«</span>lderivs <span class="bound">w</span> <span class="free">r</span><span class="main">»</span><span class="main">|</span> <span class="bound">w</span><span class="main">.</span> wf_word <span class="free">n</span> <span class="bound">w</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_lderivs<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PREFIX</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rexp <span class="main">⇒</span> <span class="tfree">'b</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PREFIX</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> REV <span class="main">(</span>SUFFIX <span class="main">(</span>REV <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Operators-wf_SUFFIX"><span class="command">lemma</span></span> wf_SUFFIX<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>SUFFIX <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SUFFIX_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_flatten_PLUS<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_lderivs_wf<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
                                            
<span class="keyword1" id="Pi_Regular_Operators-lang_SUFFIX"><span class="command">lemma</span></span> lang_SUFFIX<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>SUFFIX <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suffix <span class="main">(</span>lang <span class="free">n</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SUFFIX_def Suffix_def
  <span class="keyword1"><span class="command">using</span></span> lang_flatten_PLUS<span class="main">[</span><span class="operator">OF</span> finite_lderivs_wf<span class="main">]</span> lang_lderivs wf_lang_wf_word
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Pi_Regular_Operators-wf_PREFIX"><span class="command">lemma</span></span> wf_PREFIX<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>PREFIX <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> PREFIX_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Operators-lang_PREFIX"><span class="command">lemma</span></span> lang_PREFIX<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>PREFIX <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Prefix <span class="main">(</span>lang <span class="free">n</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> PREFIX_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Prefix_Suffix<span class="main">)</span>         

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Pi_Regular_Operators-take_drop_CycleI"><span class="command">lemma</span></span> take_drop_CycleI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">L</span> <span class="main">⟹</span> drop <span class="free">i</span> <span class="free">x</span> <span class="main">@</span> take <span class="free">i</span> <span class="free">x</span> <span class="main">∈</span> Cycle <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Cycle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Pi_Regular_Operators-take_drop_CycleI'"><span class="command">lemma</span></span> take_drop_CycleI'<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="free">i</span> <span class="free">x</span> <span class="main">@</span> take <span class="free">i</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">L</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> Cycle <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> take_drop_CycleI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="free"><span class="free"><span class="free">x</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="free"><span class="free"><span class="free">i</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Pi_Regular_Exp_Dual">
<div class="head">
<h1>Theory Pi_Regular_Exp_Dual</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹$\Pi$-Extended Dual Regular Expressions›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Pi_Regular_Exp_Dual
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Pi_Derivatives">Pi_Derivatives</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/List_Lexorder.html">HOL-Library.List_Lexorder</a>"</span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Code_Target_Nat.html">HOL-Library.Code_Target_Nat</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax of regular expressions›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> rexp_dual <span class="main">=</span>
  CoZero <span class="main">(</span><span class="free"><span class="entity">co</span></span><span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="main">|</span>
  CoOne <span class="main">(</span>co<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="main">|</span>
  CoAtom <span class="main">(</span>co<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span>
  CoPlus <span class="main">(</span>co<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp_dual"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp_dual"</span></span> <span class="main">|</span>
  CoTimes <span class="main">(</span>co<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp_dual"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp_dual"</span></span> <span class="main">|</span>
  CoStar <span class="main">(</span>co<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp_dual"</span></span> <span class="main">|</span>
  CoPr <span class="main">(</span>co<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp_dual"</span></span>
<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">rexp_dual</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">CoPLUS_dual</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> rexp_of_list <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>CoZero <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">bool_unop_dual</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> id <span class="keyword1">else</span> HOL.Not<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">bool_binop_dual</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="main">(∨)</span> <span class="keyword1">else</span> <span class="main">(∧)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">set_binop_dual</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="main">(∪)</span> <span class="keyword1">else</span> <span class="main">(∩)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">final_dual</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp_dual <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">final_dual</span> <span class="main">(</span>CoZero <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final_dual</span> <span class="main">(</span>CoOne <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final_dual</span> <span class="main">(</span>CoAtom <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final_dual</span> <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> bool_binop_dual <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">final_dual</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">final_dual</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final_dual</span> <span class="main">(</span>CoTimes <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> bool_binop_dual <span class="main">(</span><span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">final_dual</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">final_dual</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final_dual</span> <span class="main">(</span>CoStar <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final_dual</span> <span class="main">(</span>CoPr <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">final_dual</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> alphabet
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">wf_dual</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'b</span> rexp_dual <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wf_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>CoZero <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wf_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>CoOne <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wf_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>CoAtom <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">wf_atom</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wf_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>CoPlus <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">wf_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">wf_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wf_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>CoTimes <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">wf_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">wf_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wf_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>CoStar <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wf_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wf_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>CoPr <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wf_dual</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="Pi_Regular_Exp_Dual-wf_dual_PLUS_dual"><span class="command">lemma</span></span> wf_dual_PLUS_dual<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_dual <span class="free">n</span> <span class="main">(</span>CoPLUS_dual <span class="free">b</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> wf_dual <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">set_unop_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">else</span> lists <span class="main">(</span><span class="keyword1"><span class="free">Σ</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> project
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lang_dual</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'b</span> rexp_dual <span class="main">=&gt;</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lang_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>CoZero <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> set_unop_dual <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>CoOne <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> set_unop_dual <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>CoAtom <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> set_unop_dual <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">{</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="free">lookup</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> set_binop_dual <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">lang_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">lang_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>CoTimes <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> set_unop_dual <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>
   <span class="main">(</span>set_unop_dual <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">lang_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">@@</span> set_unop_dual <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">lang_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>CoStar <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> set_unop_dual <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>star <span class="main">(</span>set_unop_dual <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">lang_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lang_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>CoPr <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> set_unop_dual <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>map <span class="free">project</span> <span class="main">`</span> <span class="main">(</span>set_unop_dual <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">lang_dual</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Exp_Dual-wf_dual_lang_dual_wf_word"><span class="command">lemma</span></span> wf_dual_lang_dual_wf_word<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dual <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">w</span> <span class="main">∈</span> lang_dual <span class="free">n</span> <span class="free">r</span><span class="main">.</span> wf_word <span class="free">n</span> <span class="bound">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ conc_mono<span class="main"><span class="main">]</span></span> star_induct
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_word<span class="main"><span class="main">]</span></span> wf_word_map_project<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Exp_Dual-lang_dual_subset_lists"><span class="command">lemma</span></span> lang_dual_subset_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dual <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> lang_dual <span class="free">n</span> <span class="free">r</span> <span class="main">⊆</span> lists <span class="main">(</span><span class="free">Σ</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CoPr <span class="skolem">b</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> project<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_subset_lists star_subset_lists<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Exp_Dual-lang_dual_final_dual"><span class="command">lemma</span></span> lang_dual_final_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"final_dual <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span> <span class="main">∈</span> lang_dual <span class="free">n</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> concI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Exp_Dual-lang_dual_PLUS_dual"><span class="command">lemma</span></span> lang_dual_PLUS_dual<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang_dual <span class="free">n</span> <span class="main">(</span>CoPLUS_dual True <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> lang_dual <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Regular_Exp_Dual-lang_dual_CoPLUS_dual"><span class="command">lemma</span></span> lang_dual_CoPLUS_dual<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang_dual <span class="free">n</span> <span class="main">(</span>CoPLUS_dual False <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> lists <span class="main">(</span><span class="free">Σ</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">⋂</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> lang_dual <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> embed
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lderiv_dual</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> rexp_dual <span class="main">⇒</span> <span class="tfree">'b</span> rexp_dual"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lderiv_dual</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>CoZero <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>CoZero <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv_dual</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>CoOne <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>CoZero <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv_dual</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>CoAtom <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">lookup</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> CoOne <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">else</span> CoZero <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv_dual</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> CoPlus <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">lderiv_dual</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">lderiv_dual</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv_dual</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>CoTimes <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">r's</span> <span class="main">=</span> CoTimes <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">lderiv_dual</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
     <span class="keyword1">in</span> <span class="keyword1">if</span> bool_unop_dual <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>final_dual <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">then</span> CoPlus <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">r's</span> <span class="main">(</span><span class="free">lderiv_dual</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">r's</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv_dual</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>CoStar <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> CoTimes <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">lderiv_dual</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>CoStar <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv_dual</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>CoPr <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> CoPr <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>CoPLUS_dual <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> <span class="free">lderiv_dual</span> <span class="bound">a'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">embed</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lderivs_dual</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lderivs_dual</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderivs_dual</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free">lderivs_dual</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">(</span>lderiv_dual <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Regular_Exp_Dual-wf_dual_lderiv_dual"><span class="command">lemma</span></span> wf_dual_lderiv_dual<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dual <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf_dual <span class="free">n</span> <span class="main">(</span>lderiv_dual <span class="free">w</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Exp_Dual-wf_dual_lderivs_dual"><span class="command">lemma</span></span> wf_dual_lderivs_dual<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dual <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf_dual <span class="free">n</span> <span class="main">(</span>lderivs_dual <span class="free">ws</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_dual_lderiv_dual<span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Exp_Dual-lang_dual_lderiv_dual"><span class="command">lemma</span></span> lang_dual_lderiv_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf_dual <span class="free">n</span> <span class="free">r</span><span class="main">;</span> <span class="free">w</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span>
  lang_dual <span class="free">n</span> <span class="main">(</span>lderiv_dual <span class="free">w</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lQuot <span class="free">w</span> <span class="main">(</span>lang_dual <span class="free">n</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CoPr <span class="skolem">b</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dual <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w'</span><span class="main">.</span> <span class="bound">w'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">embed</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">⟹</span>  <span class="bound">w'</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> embed<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> lQuot_map_project<span class="main">[</span><span class="operator">OF</span> CoPr<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> lang_dual_subset_lists<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    lQuot_map_project<span class="main">[</span><span class="operator">OF</span> CoPr<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Diff_subset<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"lang_dual <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">r</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CoPr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def lang_dual_final_dual<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Pi_Regular_Exp_Dual-lang_dual_lderivs_dual"><span class="command">lemma</span></span> lang_dual_lderivs_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf_dual <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf_word <span class="free">n</span> <span class="free">ws</span><span class="main">⟧</span> <span class="main">⟹</span>
  lang_dual <span class="free">n</span> <span class="main">(</span>lderivs_dual <span class="free">ws</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lQuots <span class="free">ws</span> <span class="main">(</span>lang_dual <span class="free">n</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang_dual_lderiv_dual<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lderivs_dual_final_dual<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dual <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"wf_word <span class="free">n</span> <span class="free">ws</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"final_dual <span class="main">(</span>lderivs_dual <span class="free">ws</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">ws</span> <span class="main">∈</span> lang_dual <span class="free">n</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lang_dual_lderivs_dual<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> lang_dual_final_dual<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lderivs_dual <span class="free">ws</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pnCoPlus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder rexp_dual <span class="main">⇒</span> <span class="tfree">'a</span> rexp_dual <span class="main">⇒</span> <span class="tfree">'a</span> rexp_dual"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnCoPlus</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>CoZero <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> CoZero <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnCoPlus</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>CoZero <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> CoZero <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnCoPlus</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="keyword1">then</span> <span class="free">pnCoPlus</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">pnCoPlus</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1">else</span> CoPlus <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnCoPlus</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="keyword1">then</span>
       <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> CoPlus <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
       <span class="keyword1">else</span> CoPlus <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">pnCoPlus</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>
     <span class="keyword1">else</span> CoPlus <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnCoPlus</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> CoPlus <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
      <span class="keyword1">else</span> CoPlus <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> alphabet<span class="main">)</span> wf_dual_pnCoPlus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf_dual <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf_dual <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> wf_dual <span class="free">n</span> <span class="main">(</span>pnCoPlus <span class="free">b</span> <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnCoPlus.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> project<span class="main">)</span> lang_dual_pnCoPlus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf_dual <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf_dual <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
  lang_dual <span class="free">n</span> <span class="main">(</span>pnCoPlus <span class="free">b</span> <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> lang_dual <span class="free">n</span> <span class="main">(</span>CoPlus <span class="free">b</span> <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnCoPlus.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lang_dual_subset_lists<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_1"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_2"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_3"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lang_dual_subset_lists<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_4"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lang_dual_subset_lists <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>
    subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> conc_subset_lists<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> in_lists_conv_set<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_5"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lang_dual_subset_lists <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>
    subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> star_subset_lists<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> in_lists_conv_set<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_6"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lang_dual_subset_lists <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> project<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"3_1"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"3_2"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"3_3"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"3_4"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"3_5"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"3_6"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"4_1"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"4_2"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"4_3"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"4_4"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"4_5"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_1"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_2"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_3"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_4"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_5"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_6"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_7"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_8"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_9"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_10"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Cons_in_lists_iff Diff_iff imageI list.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> lists.Nil<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_11"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_12"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_13"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_14"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_15"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_16"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_17"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_18"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_19"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lang_dual_subset_lists <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>
    subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> star_subset_lists<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> in_lists_conv_set<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_20"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_21"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_22"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Cons_in_lists_iff Diff_iff imageI list.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> lists.Nil<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_23"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_24"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"5_25"</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pnCoTimes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder rexp_dual <span class="main">⇒</span> <span class="tfree">'a</span> rexp_dual <span class="main">⇒</span> <span class="tfree">'a</span> rexp_dual"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnCoTimes</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>CoZero <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="keyword1">then</span> CoZero <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="keyword1">else</span> CoTimes <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>CoZero <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnCoTimes</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>CoOne <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> CoTimes <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>CoOne <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnCoTimes</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="keyword1">then</span> pnCoPlus <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="main">(</span><span class="free">pnCoTimes</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">pnCoTimes</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
   <span class="keyword1">else</span> CoTimes <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnCoTimes</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> CoTimes <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> alphabet<span class="main">)</span> wf_dual_pnCoTimes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf_dual <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf_dual <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> wf_dual <span class="free">n</span> <span class="main">(</span>pnCoTimes <span class="free">b</span> <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnCoTimes.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> project<span class="main">)</span> lang_dual_pnCoTimes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf_dual <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf_dual <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> lang_dual <span class="free">n</span> <span class="main">(</span>pnCoTimes <span class="free">b</span> <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> lang_dual <span class="free">n</span> <span class="main">(</span>CoTimes <span class="free">b</span> <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnCoTimes.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lang_dual_subset_lists <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> project
      subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> star_subset_lists<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> in_lists_conv_set<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
      subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> conc_subset_lists<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> in_lists_conv_set<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Diff_iff conc_epsilon<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> double_diff empty_subsetI in_listsI insert_subset lists.Nil subset_refl<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pnCoPr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder rexp_dual <span class="main">⇒</span> <span class="tfree">'a</span> rexp_dual"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnCoPr</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>CoZero <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="keyword1">then</span> CoZero <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="keyword1">else</span> CoPr <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>CoZero <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnCoPr</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>CoOne <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="keyword1">then</span> CoOne <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="keyword1">else</span> CoPr <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>CoOne <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnCoPr</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="keyword1">then</span> pnCoPlus <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="main">(</span><span class="free">pnCoPr</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">pnCoPr</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> CoPr <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnCoPr</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> CoPr <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> alphabet<span class="main">)</span> wf_dual_pnCoPr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dual <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">r</span> <span class="main">⟹</span> wf_dual <span class="free">n</span> <span class="main">(</span>pnCoPr <span class="free">b</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnCoPr.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> project<span class="main">)</span> lang_dual_pnCoPr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dual <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">r</span> <span class="main">⟹</span> lang_dual <span class="free">n</span> <span class="main">(</span>pnCoPr <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang_dual <span class="free">n</span> <span class="main">(</span>CoPr <span class="free">b</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnCoPr.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">pnorm_dual</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder rexp_dual <span class="main">⇒</span> <span class="tfree">'a</span> rexp_dual"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnorm_dual</span> <span class="main">(</span>CoZero <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>CoZero <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm_dual</span> <span class="main">(</span>CoOne <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>CoOne <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm_dual</span> <span class="main">(</span>CoAtom <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>CoAtom <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm_dual</span> <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> pnCoPlus <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">pnorm_dual</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">pnorm_dual</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm_dual</span> <span class="main">(</span>CoTimes <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> pnCoTimes <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">pnorm_dual</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm_dual</span> <span class="main">(</span>CoStar <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> CoStar <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm_dual</span> <span class="main">(</span>CoPr <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> pnCoPr <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">pnorm_dual</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> alphabet<span class="main">)</span> wf_dual_pnorm_dual<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dual <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf_dual <span class="free">n</span> <span class="main">(</span>pnorm_dual <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> project<span class="main">)</span> lang_dual_pnorm_dual<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dual <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> lang_dual <span class="free">n</span> <span class="main">(</span>pnorm_dual <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang_dual <span class="free">n</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">CoNot</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CoNot</span> <span class="main">(</span>CoZero <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> CoZero <span class="main">(</span><span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">CoNot</span> <span class="main">(</span>CoOne <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> CoOne <span class="main">(</span><span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">CoNot</span> <span class="main">(</span>CoAtom <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> CoAtom <span class="main">(</span><span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">CoNot</span> <span class="main">(</span>CoPlus <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> CoPlus <span class="main">(</span><span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">CoNot</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">CoNot</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">CoNot</span> <span class="main">(</span>CoTimes <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> CoTimes <span class="main">(</span><span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">CoNot</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">CoNot</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">CoNot</span> <span class="main">(</span>CoStar <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> CoStar <span class="main">(</span><span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">CoNot</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">CoNot</span> <span class="main">(</span>CoPr <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> CoPr <span class="main">(</span><span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">CoNot</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rexp_dual_of</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rexp_dual_of</span> Zero <span class="main">=</span> CoZero True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_dual_of</span> Full <span class="main">=</span> CoZero False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_dual_of</span> One <span class="main">=</span> CoOne True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_dual_of</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> CoAtom True <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_dual_of</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> CoPlus True <span class="main">(</span><span class="free">rexp_dual_of</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_dual_of</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_dual_of</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> CoTimes True <span class="main">(</span><span class="free">rexp_dual_of</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_dual_of</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_dual_of</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> CoStar True <span class="main">(</span><span class="free">rexp_dual_of</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_dual_of</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> CoNot <span class="main">(</span><span class="free">rexp_dual_of</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_dual_of</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> CoPlus False <span class="main">(</span><span class="free">rexp_dual_of</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_dual_of</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_dual_of</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> CoPr True <span class="main">(</span><span class="free">rexp_dual_of</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> alphabet<span class="main">)</span> wf_dual_CoNot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dual <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf_dual <span class="free">n</span> <span class="main">(</span>CoNot <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> project<span class="main">)</span> lang_dual_CoNot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dual <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> lang_dual <span class="free">n</span> <span class="main">(</span>CoNot <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lists <span class="main">(</span><span class="free">Σ</span> <span class="free">n</span><span class="main">)</span> <span class="main">-</span> lang_dual <span class="free">n</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lang_dual_subset_lists <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> double_diff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> project<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Diff_subset contra_subsetD in_listsD star_subset_lists<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> alphabet<span class="main">)</span> wf_dual_rexp_dual_of<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf_dual <span class="free">n</span> <span class="main">(</span>rexp_dual_of <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> project<span class="main">)</span> lang_dual_rexp_dual_of<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> lang_dual <span class="free">n</span> <span class="main">(</span>rexp_dual_of <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Pi_Equivalence_Checking">
<div class="head">
<h1>Theory Pi_Equivalence_Checking</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deciding Equivalence of $\Pi$-Extended Regular Expressions›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Pi_Equivalence_Checking
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Pi_Regular_Exp">Pi_Regular_Exp</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span> <a href="#List_More">List_More</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1" id="Pi_Equivalence_Checking-image2p_in_rel"><span class="command">lemma</span></span> image2p_in_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"BNF_Greatest_Fixpoint.image2p <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>in_rel <span class="free">R</span><span class="main">)</span> <span class="main">=</span>  in_rel <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span> <span class="main">`</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> image2p_def fun_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Equivalence_Checking-image2p_apply"><span class="command">lemma</span></span> image2p_apply<span class="main">:</span> <span class="quoted"><span class="quoted">"BNF_Greatest_Fixpoint.image2p <span class="free">f</span> <span class="free">g</span> <span class="free">R</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x'</span> <span class="bound">y'</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x'</span> <span class="bound">y'</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">g</span> <span class="bound">y'</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> image2p_def fun_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Equivalence_Checking-rtrancl_fold_product"><span class="command">lemma</span></span> rtrancl_fold_product<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">r</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span><span class="main">^*</span> <span class="main">=</span>
       <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>fold <span class="free">f</span> <span class="bound">w</span> <span class="bound">r</span><span class="main">,</span> fold <span class="free">f</span> <span class="bound">w</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">r</span> <span class="bound">s</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> lists <span class="free">A</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?L</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> refl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fold_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fold_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">w</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> fold <span class="free">f</span> <span class="skolem">w</span> <span class="skolem">r</span><span class="main">,</span> fold <span class="free">f</span> <span class="skolem">w</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> snoc <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-in_fold_lQuot"><span class="command">lemma</span></span> in_fold_lQuot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> fold lQuot <span class="free">w</span> <span class="free">L</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">@</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lQuot_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> project<span class="main">)</span> lang_eq_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>lang <span class="free">n</span> <span class="free">r</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">w</span> <span class="main">∈</span> lists<span class="main">(</span><span class="free">Σ</span> <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="free">r</span> <span class="main">⟷</span> <span class="bound">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lang_subset_lists<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> project<span class="main">)</span> lang_eq_ext_Nil_fold_Deriv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span> <span class="free">s</span> <span class="free">n</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔅</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>fold lQuot <span class="bound">w</span> <span class="main">(</span>lang <span class="free">n</span> <span class="free">r</span><span class="main">)</span><span class="main">,</span> fold lQuot <span class="bound">w</span> <span class="main">(</span>lang <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">∈</span>lists <span class="main">(</span><span class="free">Σ</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="free">r</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">L</span><span class="main">)</span> <span class="main">∈</span> <span class="free">𝔅</span><span class="main">.</span> <span class="main">[]</span> <span class="main">∈</span> <span class="bound">K</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> <span class="bound">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang_eq_ext<span class="main">[</span><span class="operator">OF</span> WF<span class="main">]</span> 𝔅_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> in_fold_lQuot<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">locale</span></span> rexp_DA <span class="main">=</span> project <span class="quoted"><span class="quoted">"set <span class="keyword1">o</span> <span class="free">σ</span>"</span></span> <span class="quoted"><span class="free">wf_atom</span></span> <span class="quoted"><span class="free">project</span></span> <span class="quoted"><span class="free">lookup</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">wf_atom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> linorder <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">project</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rexp <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">delta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">final</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">wf_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">post</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L_init<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">L</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L_delta<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">;</span> <span class="free">wf_state</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">L</span> <span class="main">(</span><span class="free">delta</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> lQuot <span class="free">a</span> <span class="main">(</span><span class="free">L</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> final_iff_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="free">s</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">L</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L_wf_state<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">L</span> <span class="free">s</span> <span class="main">⊆</span> lists <span class="main">(</span>set <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init_wf_state<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">wf_state</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> delta_wf_state<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">;</span> <span class="free">wf_state</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">wf_state</span> <span class="main">(</span><span class="free">delta</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L_post<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">L</span> <span class="main">(</span><span class="free">post</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">L</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf_state_post<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">wf_state</span> <span class="main">(</span><span class="free">post</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-L_deltas"><span class="command">lemma</span></span> L_deltas<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf_word <span class="free">n</span> <span class="free">w</span><span class="main">;</span> <span class="free">wf_state</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">L</span> <span class="main">(</span>fold <span class="free">delta</span> <span class="free">w</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> fold lQuot <span class="free">w</span> <span class="main">(</span><span class="free">L</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">progression</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="main">⟶</span> <span class="free">wf_state</span> <span class="bound">s1</span> <span class="main">∧</span> <span class="free">wf_state</span> <span class="bound">s2</span> <span class="main">∧</span> <span class="free">final</span> <span class="bound">s1</span> <span class="main">=</span> <span class="free">final</span> <span class="bound">s2</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">.</span> BNF_Greatest_Fixpoint.image2p <span class="free">post</span> <span class="free">post</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free">post</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">x</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">post</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">x</span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-SUPR_progression"><span class="command">lemma</span></span> SUPR_progression<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="free">X</span> <span class="bound">n</span> <span class="main">→</span> <span class="free">Y</span> <span class="bound">m</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">n</span><span class="main">.</span> <span class="free">X</span> <span class="bound">n</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">n</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> progression_def image2p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bisimulation</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bisimulation</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bisimulation_upto</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bisimulation_upto</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> image2pI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span> image2pE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> bisim_def <span class="main">=</span> bisimulation_def progression_def
<span class="keyword1"><span class="command">lemmas</span></span> bisim_upto_def <span class="main">=</span> bisimulation_upto_def progression_def

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compatible</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compatible</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span>mono <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">R</span> <span class="bound">S</span><span class="main">.</span> <span class="bound">R</span> <span class="main">→</span> <span class="bound">S</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">R</span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> compat_def <span class="main">=</span> compatible_def progression_def

<span class="keyword1" id="Pi_Equivalence_Checking-bisimulation_upto_bisimulation"><span class="command">lemma</span></span> bisimulation_upto_bisimulation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"bisimulation_upto <span class="free">R</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">S</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"bisimulation <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≤</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="skolem">n</span><span class="main">)</span> <span class="free">R</span> <span class="main">→</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">R</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bisimulation_upto_def compatible_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bisimulation <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">n</span><span class="main">)</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bisimulation_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> funpow.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="bound">n</span><span class="main">)</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-bisimulation_eqL"><span class="command">lemma</span></span> bisimulation_eqL<span class="main">:</span> <span class="quoted"><span class="quoted">"bisimulation <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span> <span class="free">wf_state</span> <span class="bound">s1</span> <span class="main">∧</span> <span class="free">wf_state</span> <span class="bound">s2</span> <span class="main">∧</span> <span class="free">L</span> <span class="bound">s1</span> <span class="main">=</span> <span class="free">L</span> <span class="bound">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bisim_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lQuot_def<span class="main">)</span>

<span class="keyword1" id="Pi_Equivalence_Checking-coinduction"><span class="command">lemma</span></span> coinduction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bisim<span class="main">[</span><span class="operator">unfolded</span> bisim_def<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bisimulation <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    WF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="free">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="free">s1</span> <span class="main">=</span> <span class="free">L</span> <span class="free">s2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
  <span class="keyword1"><span class="command">from</span></span> R WF <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="free">L</span> <span class="free">s1</span> <span class="main">⟷</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="free">L</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> bisim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">w</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="skolem">s1</span> <span class="skolem">s2</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1'</span></span> <span class="skolem"><span class="skolem">s2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">s1'</span> <span class="skolem">s2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="skolem">s1'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="skolem">s2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        *<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">post</span> <span class="skolem">s1'</span> <span class="main">=</span> <span class="free">post</span> <span class="main">(</span><span class="free">delta</span> <span class="skolem">a</span> <span class="skolem">s1</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">post</span> <span class="skolem">s2'</span> <span class="main">=</span> <span class="free">post</span> <span class="main">(</span><span class="free">delta</span> <span class="skolem">a</span> <span class="skolem">s2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bisim <span class="keyword1"><span class="command">unfolding</span></span> image2p_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="free">L</span> <span class="main">(</span><span class="free">post</span> <span class="main">(</span><span class="free">delta</span> <span class="skolem">a</span> <span class="skolem">s1</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="free">L</span> <span class="main">(</span><span class="free">post</span> <span class="main">(</span><span class="free">delta</span> <span class="skolem">a</span> <span class="skolem">s2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s1'</span></span> <span class="quoted"><span class="skolem">s2'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> a Cons.prems<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lQuot_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems bisim <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-coinduction_upto"><span class="command">lemma</span></span> coinduction_upto<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bisimulation_upto <span class="free">R</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="free">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="free">s1</span> <span class="main">=</span> <span class="free">L</span> <span class="free">s2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bisimulation_upto_bisimulation<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">,</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≤</span> <span class="skolem">S</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"bisimulation <span class="skolem">S</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="free">s1</span> <span class="main">=</span> <span class="free">L</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> coinduction<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ WF<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">≤</span> <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="free">s1</span> <span class="free">s2</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">test_invariant</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">test_invariant</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> list <span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">::</span> <span class="tfree">'s</span> rel<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span>  False <span class="main">|</span> <span class="main">(</span><span class="bound">w</span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">,</span><span class="bound">p</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span><span class="main">#</span><span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">final</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">final</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">test</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">test</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">::</span> <span class="tfree">'s</span> rel<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span>  False <span class="main">|</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span><span class="main">#</span><span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">final</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">final</span> <span class="bound">q</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">step_invariant</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step_invariant</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span>
      <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">;</span>
      <span class="bound">ps'</span> <span class="main">=</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">;</span>
      <span class="bound">succs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span>
        <span class="keyword1">let</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">;</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">s</span>
        <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span> <span class="main">#</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">post</span> <span class="bound">r'</span><span class="main">,</span> <span class="free">post</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">new</span> <span class="main">=</span> remdups' snd <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rs</span><span class="main">)</span><span class="main">.</span> <span class="bound">rs</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="bound">succs</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">ws'</span> <span class="main">=</span> tl <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">@</span> map fst <span class="bound">new</span><span class="main">;</span>
      <span class="bound">N'</span> <span class="main">=</span> set <span class="main">(</span>map snd <span class="bound">new</span><span class="main">)</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">ws'</span><span class="main">,</span> <span class="bound">ps'</span><span class="main">,</span> <span class="bound">N'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">step</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span>
      <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">;</span>
      <span class="bound">succs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span>
        <span class="keyword1">let</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">;</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">s</span>
        <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">post</span> <span class="bound">r'</span><span class="main">,</span> <span class="free">post</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">new</span> <span class="main">=</span> remdups' snd <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rs</span><span class="main">)</span><span class="main">.</span> <span class="bound">rs</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="bound">succs</span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">@</span> map fst <span class="bound">new</span><span class="main">,</span> set <span class="main">(</span>map snd <span class="bound">new</span><span class="main">)</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">closure_invariant</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">closure_invariant</span> <span class="main">=</span> while_option test_invariant step_invariant"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">closure</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">closure</span> <span class="main">=</span> while_option test step"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">invariant</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">ps</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="bound">ws</span> <span class="main">∪</span> set <span class="bound">ps</span> <span class="main">∧</span>
     distinct <span class="main">(</span>map snd <span class="bound">ws</span> <span class="main">@</span> <span class="bound">ps</span><span class="main">)</span> <span class="main">∧</span>
     bij_betw <span class="main">(</span>map_prod <span class="free">post</span> <span class="free">post</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>map snd <span class="bound">ws</span> <span class="main">@</span> <span class="bound">ps</span><span class="main">)</span><span class="main">)</span> <span class="bound">N</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">ws</span><span class="main">.</span> fold <span class="free">delta</span> <span class="main">(</span>rev <span class="bound">w</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="bound">r'</span> <span class="main">∧</span> fold <span class="free">delta</span> <span class="main">(</span>rev <span class="bound">w</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="bound">s'</span> <span class="main">∧</span>
        wf_word <span class="free">n</span> <span class="main">(</span>rev <span class="bound">w</span><span class="main">)</span> <span class="main">∧</span> <span class="free">wf_state</span> <span class="bound">r'</span> <span class="main">∧</span> <span class="free">wf_state</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">ps</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> fold <span class="free">delta</span> <span class="bound">w</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="bound">r'</span> <span class="main">∧</span> fold <span class="free">delta</span> <span class="bound">w</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span>
       <span class="free">wf_state</span> <span class="bound">r'</span> <span class="main">∧</span> <span class="free">wf_state</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">final</span> <span class="bound">r'</span> <span class="main">⟷</span> <span class="free">final</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">post</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">r'</span><span class="main">)</span><span class="main">,</span> <span class="free">post</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-invariant_start"><span class="command">lemma</span></span> invariant_start<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">wf_state</span> <span class="free">r</span><span class="main">;</span> <span class="free">wf_state</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> invariant <span class="free">r</span> <span class="free">s</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">r</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="free">post</span> <span class="free">r</span><span class="main">,</span> <span class="free">post</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invariant_def bij_betw_def<span class="main">)</span>

<span class="keyword1" id="Pi_Equivalence_Checking-step_invariant_mono"><span class="command">lemma</span></span> step_invariant_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"step_invariant <span class="main">(</span><span class="free">ws</span><span class="main">,</span> <span class="free">ps</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ws'</span><span class="main">,</span> <span class="free">ps'</span><span class="main">,</span> <span class="free">N'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="free">ws</span> <span class="main">∪</span> set <span class="free">ps</span> <span class="main">⊆</span> snd <span class="main">`</span> set <span class="free">ws'</span> <span class="main">∪</span> set <span class="free">ps'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> UnE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> snd <span class="main">`</span>set <span class="free">ws</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">ws'</span> <span class="main">∪</span> set <span class="free">ps'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> snd <span class="main">(</span>hd <span class="free">ws</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> image snd <span class="main">(</span>set <span class="free">ws</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span>tl <span class="free">ws</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ws</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Pi_Equivalence_Checking-step_invatiant_unfold"><span class="command">lemma</span></span> step_invatiant_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"step_invariant <span class="main">(</span><span class="free">w</span> <span class="main">#</span> <span class="free">ws</span><span class="main">,</span> <span class="free">ps</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ws'</span><span class="main">,</span> <span class="free">ps'</span><span class="main">,</span> <span class="free">N'</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xs</span> <span class="bound">r</span> <span class="bound">s</span><span class="main">.</span>
  <span class="free">w</span> <span class="main">=</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ps'</span> <span class="main">=</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span> <span class="main">∧</span>
  <span class="free">ws'</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">@</span> remdups' <span class="main">(</span>map_prod <span class="free">post</span> <span class="free">post</span> <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> map_prod <span class="free">post</span> <span class="free">post</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">N</span><span class="main">)</span>
   <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">#</span><span class="bound">xs</span><span class="main">,</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="free">N'</span> <span class="main">=</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">post</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">,</span> <span class="free">post</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mp_remdups'
  <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def filter_map set_n_lists image_Collect image_image comp_def<span class="main">)</span>

<span class="keyword1" id="Pi_Equivalence_Checking-invariant"><span class="command">lemma</span></span> invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"invariant <span class="free">r</span> <span class="free">s</span> <span class="free">st</span> <span class="main">⟹</span> test_invariant <span class="free">st</span> <span class="main">⟹</span> invariant <span class="free">r</span> <span class="free">s</span> <span class="main">(</span>step_invariant <span class="free">st</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> invariant_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">split</span> prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> case_prodE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ws</span> <span class="skolem">ps</span> <span class="skolem">N</span> <span class="skolem">ws'</span> <span class="skolem">ps'</span> <span class="skolem">N'</span>
  <span class="keyword3"><span class="command">assume</span></span> test_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"test_invariant <span class="main">(</span><span class="skolem">ws</span><span class="main">,</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"step_invariant <span class="main">(</span><span class="skolem">ws</span><span class="main">,</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">N</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ws'</span><span class="main">,</span> <span class="skolem">ps'</span><span class="main">,</span> <span class="skolem">N'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="skolem">ws</span> <span class="main">∪</span> set <span class="skolem">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map snd <span class="skolem">ws</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>map_prod <span class="free">post</span> <span class="free">post</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>map snd <span class="skolem">ws</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="skolem">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ws<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws</span><span class="main">.</span> fold <span class="free">delta</span> <span class="main">(</span>rev <span class="bound">w</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="bound">r'</span> <span class="main">∧</span> fold <span class="free">delta</span> <span class="main">(</span>rev <span class="bound">w</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="bound">s'</span> <span class="main">∧</span>
    wf_word <span class="free">n</span> <span class="main">(</span>rev <span class="bound">w</span><span class="main">)</span> <span class="main">∧</span> <span class="free">wf_state</span> <span class="bound">r'</span> <span class="main">∧</span> <span class="free">wf_state</span> <span class="bound">s'</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws</span><span class="main">.</span> <span class="var">?ws</span> <span class="bound">w</span> <span class="bound">r'</span> <span class="bound">s'</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> fold <span class="free">delta</span> <span class="bound">w</span> <span class="free">r</span> <span class="main">=</span> <span class="bound">r'</span> <span class="main">∧</span> fold <span class="free">delta</span> <span class="bound">w</span> <span class="free">s</span> <span class="main">=</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span>
    <span class="free">wf_state</span> <span class="bound">r'</span> <span class="main">∧</span> <span class="free">wf_state</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">final</span> <span class="bound">r'</span> <span class="main">⟷</span> <span class="free">final</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">post</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">r'</span><span class="main">)</span><span class="main">,</span> <span class="free">post</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="var">?ps</span> <span class="bound">r</span> <span class="bound">s</span> <span class="skolem">N</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> test_invariant <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ws_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ws</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ps'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ws'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws'</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> remdups' <span class="main">(</span>map_prod <span class="free">post</span> <span class="free">post</span> <span class="keyword1">o</span> snd<span class="main">)</span>
      <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> map_prod <span class="free">post</span> <span class="free">post</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">N</span><span class="main">)</span>
        <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">,</span> <span class="free">delta</span> <span class="bound">a</span> <span class="skolem">r'</span><span class="main">,</span>  <span class="free">delta</span> <span class="bound">a</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> N'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N'</span> <span class="main">=</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">post</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="skolem">r'</span><span class="main">)</span><span class="main">,</span> <span class="free">post</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">N</span><span class="main">)</span> <span class="main">∪</span> <span class="skolem">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step_invatiant_unfold<span class="main">[</span><span class="operator">OF</span> step_invariant<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ws_Cons<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> ws'ps'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map snd <span class="skolem">ws'</span> <span class="main">@</span> <span class="skolem">ps'</span><span class="main">)</span> <span class="main">=</span>
     set <span class="main">(</span>remdups' <span class="main">(</span>map_prod <span class="free">post</span> <span class="free">post</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> map_prod <span class="free">post</span> <span class="free">post</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">N</span><span class="main">)</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="skolem">r'</span><span class="main">,</span>  <span class="free">delta</span> <span class="bound">a</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>set <span class="main">(</span>map snd <span class="skolem">ws</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ws' ps' ws_Cons x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mp_remdups' <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_map image_image image_Un o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> rs step_invariant <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="skolem">ws'</span> <span class="main">∪</span> set <span class="skolem">ps'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> step_invariant_mono<span class="main">)</span>
<span class="comment1">(*next*)</span>
  <span class="keyword1"><span class="command">from</span></span> distinct ps' ws' ws_Cons x bij <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map snd <span class="skolem">ws'</span> <span class="main">@</span> <span class="skolem">ps'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"map_prod <span class="free">post</span> <span class="free">post</span>"</span></span><span class="main"><span class="main">]</span></span> distinct_remdups'_strong
        map_prod_imageI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">post</span></span> <span class="quoted"><span class="free">post</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mp_remdups'
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">snd</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> sym<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> snd_conv<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="comment1">(*next*)</span>
  <span class="keyword1"><span class="command">from</span></span> ps' ws' N' ws x bij <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>map_prod <span class="free">post</span> <span class="free">post</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>map snd <span class="skolem">ws'</span> <span class="main">@</span> <span class="skolem">ps'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">N'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ws'ps' N' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bij_betw_combine<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ bij<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def map_prod_def<span class="main">)</span>
<span class="comment1">(*next*)</span>
  <span class="keyword1"><span class="command">from</span></span> ws x ws_Cons <span class="keyword1"><span class="command">have</span></span> wr's'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ws</span> <span class="skolem">w</span> <span class="skolem">r'</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> ws ws_Cons <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws'</span><span class="main">.</span> <span class="var">?ws</span> <span class="bound">w</span> <span class="bound">r'</span> <span class="bound">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ws'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mp_remdups' <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>
<span class="comment1">(*next*)</span>
  <span class="keyword1"><span class="command">from</span></span> ps wr's' test_invariant<span class="main">[</span><span class="operator">unfolded</span> ws_Cons x<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps'</span><span class="main">.</span> <span class="var">?ps</span> <span class="bound">r'</span> <span class="bound">s'</span> <span class="skolem">N'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ps' N'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Collect<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-step_commute"><span class="command">lemma</span></span> step_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="keyword1">case</span> step_invariant <span class="main">(</span><span class="free">ws</span><span class="main">,</span> <span class="free">ps</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">ws'</span><span class="main">,</span> <span class="bound">ps'</span><span class="main">,</span> <span class="bound">N'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>map snd <span class="bound">ws'</span><span class="main">,</span> <span class="bound">N'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> step <span class="main">(</span>map snd <span class="free">ws</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> step_invariant.simps step.simps Let_def map_apfst_remdups' filter_map list.map_comp apfst_def map_prod_def snd_conv id_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_map comp_def map_tl hd_map<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> image_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-closure_invariant_closure"><span class="command">lemma</span></span> closure_invariant_closure<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_option <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">ps</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>map snd <span class="bound">ws</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>closure_invariant <span class="main">(</span><span class="free">ws</span><span class="main">,</span> <span class="free">ps</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> closure <span class="main">(</span>map snd <span class="free">ws</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closure_invariant_def closure_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> while_option_commute<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">test</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"step"</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> step_invariant.simps step.simps list.map <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> result<span class="main">:</span> <span class="quoted"><span class="quoted">"closure_invariant <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">init</span> <span class="free">r</span><span class="main">,</span> <span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="free">post</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">)</span><span class="main">,</span> <span class="free">post</span> <span class="main">(</span><span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    Some<span class="main">(</span><span class="free">ws</span><span class="main">,</span> <span class="free">ps</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"closure_invariant <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="var">?r</span><span class="main">,</span> <span class="var">?s</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> closure_invariant_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="free">r</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    counterexample<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> rev <span class="main">(</span>fst <span class="main">(</span>hd <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="free">r</span> <span class="main">⟷</span> rev <span class="main">(</span>fst <span class="main">(</span>hd <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> lang <span class="free">n</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> WF <span class="keyword1"><span class="command">have</span></span> wf_state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="var">?r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> invariant invariant_start<span class="main">[</span><span class="operator">OF</span> wf_state<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> invariant_ps<span class="main">:</span> <span class="quoted"><span class="quoted">"invariant <span class="var">?r</span> <span class="var">?s</span> <span class="main">(</span><span class="free">ws</span><span class="main">,</span> <span class="free">ps</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> while_option_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ result<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> closure_invariant_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> invariant_ps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bisimulation <span class="main">(</span>in_rel <span class="main">(</span>set <span class="free">ps</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?r</span><span class="main">,</span> <span class="var">?s</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def invariant_def bisimulation_def progression_def image2p_in_rel<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> wf_state <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="var">?r</span> <span class="main">=</span> <span class="free">L</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> coinduction<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> WF <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="free">r</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">ws'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ws<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ws'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ws</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> invariant_ps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> fold <span class="free">delta</span> <span class="main">(</span>rev <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> fold <span class="free">delta</span> <span class="main">(</span>rev <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span><span class="free">init</span> <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"wf_word <span class="free">n</span> <span class="main">(</span>rev <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> test_invariant <span class="main">(</span><span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ws'</span><span class="main">,</span> <span class="free">ps</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> while_option_stop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> result<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ws closure_invariant_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span>fst <span class="main">(</span>hd <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">L</span> <span class="var">?r</span> <span class="main">⟷</span> rev <span class="main">(</span>fst <span class="main">(</span>hd <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">L</span> <span class="var">?s</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ws <span class="keyword1"><span class="command">using</span></span> wf_state <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_fold_lQuot<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> WF <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span>fst <span class="main">(</span>hd <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="free">r</span> <span class="main">⟷</span> rev <span class="main">(</span>fst <span class="main">(</span>hd <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> lang <span class="free">n</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-closure_sound"><span class="command">lemma</span></span> closure_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> result<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">,</span> <span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="free">post</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">)</span><span class="main">,</span> <span class="free">post</span> <span class="main">(</span><span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="free">r</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trans<span class="main">[</span><span class="operator">OF</span> closure_invariant_closure<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">init</span> <span class="free">r</span><span class="main">,</span> <span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> result<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> closure_invariant_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ WF<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_eqv</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_eqv</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">init</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">init</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">case</span> closure <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="free">post</span> <span class="bound">r'</span><span class="main">,</span> <span class="free">post</span> <span class="bound">s'</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">of</span>
       Some <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-check_eqv_sound"><span class="command">lemma</span></span> check_eqv_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">r</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="free">r</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> closure_sound assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_eqv_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">counterexample</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">counterexample</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">init</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">init</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">case</span> closure_invariant <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="free">post</span> <span class="bound">r'</span><span class="main">,</span> <span class="free">post</span> <span class="bound">s'</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">of</span>
       Some<span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span>rev <span class="bound">w</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-counterexample_sound"><span class="command">lemma</span></span> counterexample_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> result<span class="main">:</span> <span class="quoted"><span class="quoted">"counterexample <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="free">r</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">∉</span> lang <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> counterexample_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> counterexample<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Auxiliary exacutable functions:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reachable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rexp <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reachable</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> snd <span class="main">(</span>the <span class="main">(</span>rtrancl_while <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">post</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">init</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">automaton</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rexp <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">*</span> <span class="tfree">'s</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">automaton</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
    snd <span class="main">(</span>the
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">init</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
         <span class="bound">start</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="free">post</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">test_invariant</span> <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">Z</span><span class="main">)</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">.</span> <span class="bound">ws</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span>
         <span class="bound">step_invariant</span> <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">Z</span><span class="main">)</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">.</span>
           <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> hd <span class="bound">ws</span><span class="main">;</span>
                <span class="bound">new_edges</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">,</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">;</span>
                <span class="bound">new</span> <span class="main">=</span> remdups <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">ss</span><span class="main">.</span> <span class="free">post</span> <span class="bound">ss</span> <span class="main">∉</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">(</span>map snd <span class="bound">new_edges</span><span class="main">)</span><span class="main">)</span>
           <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="bound">new</span> <span class="main">@</span> tl <span class="bound">ws</span><span class="main">,</span> <span class="free">post</span> <span class="main">`</span> set <span class="bound">new</span> <span class="main">∪</span> <span class="bound">Z</span><span class="main">)</span><span class="main">,</span> set <span class="bound">new_edges</span> <span class="main">∪</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">in</span> while_option <span class="bound">test_invariant</span> <span class="bound">step_invariant</span> <span class="bound">start</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="free">final</span> <span class="main">(</span>fold <span class="free">delta</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">(</span><span class="free">init</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-match_correct"><span class="command">lemma</span></span> match_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf_word <span class="free">n</span> <span class="free">w</span><span class="main">;</span> wf <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> match <span class="free">s</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> match_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_fold_lQuot lQuot_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> rexp_DFA <span class="main">=</span> rexp_DA <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">wf_atom</span></span> <span class="quoted"><span class="free">project</span></span> <span class="quoted"><span class="free">lookup</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">delta</span></span> <span class="quoted"><span class="free">final</span></span> <span class="quoted"><span class="free">wf_state</span></span> <span class="quoted"><span class="free">post</span></span> <span class="quoted"><span class="free">L</span></span> <span class="quoted"><span class="free">n</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">wf_atom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> linorder <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">project</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rexp <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">delta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">final</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">wf_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">post</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>fold <span class="free">delta</span> <span class="bound">w</span> <span class="main">(</span><span class="free">init</span> <span class="free">s</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Reachable</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">{</span>fold <span class="free">delta</span> <span class="bound">w</span> <span class="main">(</span><span class="free">init</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-closure_invariant_termination"><span class="command">lemma</span></span> closure_invariant_termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> result<span class="main">:</span> <span class="quoted"><span class="quoted">"closure_invariant <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">init</span> <span class="free">r</span><span class="main">,</span> <span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="free">post</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">)</span><span class="main">,</span> <span class="free">post</span> <span class="main">(</span><span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"closure_invariant <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="var">?r</span><span class="main">,</span> <span class="var">?s</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cl</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span>  <span class="quoted"><span class="quoted">"<span class="free">post</span> <span class="main">`</span> Reachable <span class="free">r</span> <span class="main">×</span> <span class="free">post</span> <span class="main">`</span> Reachable <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ps</span><span class="main">.</span> <span class="var">?D</span> <span class="main">-</span> map_prod <span class="free">post</span> <span class="free">post</span> <span class="main">`</span> set <span class="bound">ps</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">ps</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span><span class="main">.</span> card <span class="main">(</span><span class="var">?X</span> <span class="bound">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">st</span><span class="main">.</span> <span class="var">?cl</span> <span class="main">=</span> Some <span class="bound">st</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> closure_invariant_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_while_option_Some<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"invariant <span class="var"><span class="var">?r</span></span> <span class="var"><span class="var">?s</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">st</span> <span class="keyword3"><span class="command">assume</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"invariant <span class="var">?r</span> <span class="var">?s</span> <span class="skolem">st</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"test_invariant <span class="skolem">st</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"invariant <span class="var">?r</span> <span class="var">?s</span> <span class="main">(</span>step_invariant <span class="skolem">st</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> invariant<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ws</span><span class="main">,</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st</span></span><span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?X</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_cartesian_product fin<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws'</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="skolem"><span class="skolem">N'</span></span> <span class="keyword2"><span class="keyword">where</span></span> step_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"step_invariant <span class="main">(</span><span class="skolem">ws</span><span class="main">,</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">N</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ws'</span><span class="main">,</span> <span class="skolem">ps'</span><span class="main">,</span> <span class="skolem">N'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"step_invariant <span class="main">(</span><span class="skolem">ws</span><span class="main">,</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">N</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_prod <span class="free">post</span> <span class="free">post</span> <span class="main">`</span> set <span class="skolem">ps</span> <span class="main">⊆</span> <span class="var">?D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base<span class="main">[</span><span class="operator">unfolded</span> st invariant_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_prod <span class="free">post</span> <span class="free">post</span> <span class="main">`</span> set <span class="skolem">ps'</span> <span class="main">⊆</span> <span class="var">?D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">[</span><span class="operator">unfolded</span> st step_invariant invariant_def<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map snd <span class="skolem">ws</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>map_prod <span class="free">post</span> <span class="free">post</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>map snd <span class="skolem">ws</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> base<span class="main">[</span><span class="operator">unfolded</span> st invariant_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">post</span> <span class="free">post</span><span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">ws</span> <span class="main">@</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> distinct_map <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_prod <span class="free">post</span> <span class="free">post</span> <span class="main">`</span> set <span class="skolem">ps</span> <span class="main">⊂</span> map_prod <span class="free">post</span> <span class="free">post</span> <span class="main">`</span> set <span class="main">(</span>snd <span class="main">(</span>hd <span class="skolem">ws</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹test_invariant <span class="skolem">st</span>›</span></span> st <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ws</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_prod <span class="free">post</span> <span class="free">post</span> <span class="main">`</span> set <span class="skolem">ps'</span> <span class="main">=</span> map_prod <span class="free">post</span> <span class="free">post</span> <span class="main">`</span> set <span class="main">(</span>snd <span class="main">(</span>hd <span class="skolem">ws</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_invariant <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_prod <span class="free">post</span> <span class="free">post</span> <span class="main">`</span> set <span class="skolem">ps</span> <span class="main">⊂</span> map_prod <span class="free">post</span> <span class="free">post</span> <span class="main">`</span> set <span class="skolem">ps'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">ps'</span> <span class="main">⊂</span> <span class="var">?X</span> <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_set <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> set_map<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span>step_invariant <span class="skolem">st</span><span class="main">)</span> <span class="main">&lt;</span> <span class="var">?f</span> <span class="skolem">st</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> st step_invariant
      <span class="keyword1"><span class="command">using</span></span> psubset_card_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">ps'</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invariant_start WF invariant<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> result <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-closure_termination"><span class="command">lemma</span></span> closure_termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> result<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">,</span> <span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="free">post</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">)</span><span class="main">,</span> <span class="free">post</span> <span class="main">(</span><span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trans<span class="main">[</span><span class="operator">OF</span> closure_invariant_closure<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">init</span> <span class="free">r</span><span class="main">,</span> <span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> result<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> closure_invariant_termination<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WF<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Pi_Equivalence_Checking-closure_invariant_complete"><span class="command">lemma</span></span> closure_invariant_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="free">r</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> WF<span class="main">:</span>  <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ps</span> <span class="bound">N</span><span class="main">.</span> closure_invariant <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">init</span> <span class="free">r</span><span class="main">,</span> <span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="free">post</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">)</span><span class="main">,</span> <span class="free">post</span> <span class="main">(</span><span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    Some<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">ps</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> closure_invariant <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="var">?r</span><span class="main">,</span> <span class="var">?s</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="var">?cl</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?cl</span></span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">st</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> ws_ps_N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ws</span><span class="main">,</span> <span class="skolem">ps</span><span class="main">,</span> <span class="skolem">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st</span></span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ws</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">wrs</span> <span class="skolem">ws</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Some <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"counterexample <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> counterexample_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">wrs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ws_ps_N<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> eq counterexample_sound<span class="main">[</span><span class="operator">OF</span> _ WF<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> closure_invariant_termination<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WF<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Pi_Equivalence_Checking-closure_complete"><span class="command">lemma</span></span> closure_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="free">r</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span><span class="main">.</span> closure <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">,</span> <span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="free">post</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">)</span><span class="main">,</span> <span class="free">post</span> <span class="main">(</span><span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> closure_invariant_complete<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> closure_invariant_closure<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">[]</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="free"><span class="free"><span class="free">init</span></span></span> <span class="free"><span class="free"><span class="free">r</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="free"><span class="free"><span class="free">init</span></span></span> <span class="free"><span class="free"><span class="free">s</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Equivalence_Checking-check_eqv_complete"><span class="command">lemma</span></span> check_eqv_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="free">r</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">r</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> closure_complete<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_eqv_def<span class="main">)</span>

<span class="keyword1" id="Pi_Equivalence_Checking-counterexample_complete"><span class="command">lemma</span></span> counterexample_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="free">r</span> <span class="main">≠</span> lang <span class="free">n</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span><span class="main">.</span> counterexample <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> Some <span class="bound">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> closure_invariant_sound<span class="main">[</span><span class="operator">OF</span> _ WF<span class="main">]</span> closure_invariant_termination<span class="main">[</span><span class="operator">OF</span> WF<span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> counterexample_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits list.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> rexp_DA_no_post <span class="main">=</span> rexp_DA <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">wf_atom</span></span> <span class="quoted"><span class="free">project</span></span> <span class="quoted"><span class="free">lookup</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">delta</span></span> <span class="quoted"><span class="free">final</span></span> <span class="quoted"><span class="free">wf_state</span></span> <span class="quoted">id</span> <span class="quoted"><span class="free">L</span></span> <span class="quoted"><span class="free">n</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">wf_atom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> linorder <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">project</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rexp <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">delta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">final</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">wf_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-step_efficient"><span class="command">lemma</span></span> step_efficient<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="main">(</span><span class="free">ws</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span>
    <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> hd <span class="free">ws</span><span class="main">;</span>
    <span class="bound">new</span> <span class="main">=</span> remdups <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">∉</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">in</span> <span class="main">(</span>tl <span class="free">ws</span> <span class="main">@</span> <span class="bound">new</span><span class="main">,</span> set <span class="bound">new</span> <span class="main">∪</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def map_apfst_remdups' filter_map o_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> rexp_DFA_no_post <span class="main">=</span> rexp_DFA <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">wf_atom</span></span> <span class="quoted"><span class="free">project</span></span> <span class="quoted"><span class="free">lookup</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">delta</span></span> <span class="quoted"><span class="free">final</span></span> <span class="quoted"><span class="free">wf_state</span></span> <span class="quoted">id</span> <span class="quoted"><span class="free">L</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">wf_atom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> linorder <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">project</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rexp <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">delta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">final</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">wf_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> rexp_DA_no_post <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> rexp_DA_sim <span class="main">=</span> project <span class="quoted"><span class="quoted">"set <span class="keyword1">o</span> <span class="free">σ</span>"</span></span> <span class="quoted"><span class="free">wf_atom</span></span> <span class="quoted"><span class="free">project</span></span> <span class="quoted"><span class="free">lookup</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">wf_atom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> linorder <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">project</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rexp <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sim_delta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">final</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">wf_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">post</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L_init<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">L</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> final_iff_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="free">s</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">L</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L_wf_state<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">L</span> <span class="free">s</span> <span class="main">⊆</span> lists <span class="main">(</span>set <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init_wf_state<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">wf_state</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L_post<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">L</span> <span class="main">(</span><span class="free">post</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">L</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf_state_post<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">wf_state</span> <span class="main">(</span><span class="free">post</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L_sim_delta<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="free">s</span> <span class="main">⟹</span> map <span class="free">L</span> <span class="main">(</span><span class="free">sim_delta</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> lQuot <span class="bound">a</span> <span class="main">(</span><span class="free">L</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sim_delta_wf_state<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">sim_delta</span> <span class="free">s</span><span class="main">)</span><span class="main">.</span> <span class="free">wf_state</span> <span class="bound">s'</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">delta</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free">sim_delta</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!</span> index <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1" id="Pi_Equivalence_Checking-length_sim_delta"><span class="command">lemma</span></span> length_sim_delta<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_state</span> <span class="free">s</span> <span class="main">⟹</span> length <span class="main">(</span><span class="free">sim_delta</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L_sim_delta length_map<span class="main">)</span>

<span class="keyword1" id="Pi_Equivalence_Checking-L_delta"><span class="command">lemma</span></span> L_delta<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">;</span> <span class="free">wf_state</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">L</span> <span class="main">(</span>delta <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> lQuot <span class="free">a</span> <span class="main">(</span><span class="free">L</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> L_sim_delta<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> delta_def in_set_conv_nth
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> list_eq_iff_nth_eq<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_Equivalence_Checking-delta_wf_state"><span class="command">lemma</span></span> delta_wf_state<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">σ</span> <span class="free">n</span><span class="main">)</span><span class="main">;</span> <span class="free">wf_state</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">wf_state</span> <span class="main">(</span>delta <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> delta_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bspec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sim_delta_wf_state nth_mem<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">sublocale</span></span> rexp_DA <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">wf_atom</span></span> <span class="quoted"><span class="free">project</span></span> <span class="quoted"><span class="free">lookup</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted">delta</span> <span class="quoted"><span class="free">final</span></span> <span class="quoted"><span class="free">wf_state</span></span> <span class="quoted"><span class="free">post</span></span> <span class="quoted"><span class="free">L</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">sublocale</span></span> rexp_DA_sim_no_post<span class="main">:</span> rexp_DA_no_post <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">wf_atom</span></span> <span class="quoted"><span class="free">project</span></span> <span class="quoted"><span class="free">lookup</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted">delta</span> <span class="quoted"><span class="free">final</span></span> <span class="quoted"><span class="free">wf_state</span></span> <span class="quoted"><span class="free">L</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Init_Normalization">
<div class="head">
<h1>Theory Init_Normalization</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Initial Normalization of the Input"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Init_Normalization
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Pi_Regular_Exp">Pi_Regular_Exp</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Simps_Case_Conv.html">HOL-Library.Simps_Case_Conv</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">toplevel_inters</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">toplevel_inters</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">toplevel_inters</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free">toplevel_inters</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">toplevel_inters</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Init_Normalization-toplevel_inters_nonempty"><span class="command">lemma</span></span> toplevel_inters_nonempty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_inters <span class="free">r</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Init_Normalization-toplevel_inters_finite"><span class="command">lemma</span></span> toplevel_inters_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>toplevel_inters <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> alphabet
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Init_Normalization-toplevel_inters_wf"><span class="command">lemma</span></span> toplevel_inters_wf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>toplevel_inters <span class="free">s</span><span class="main">.</span> wf <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> project
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Init_Normalization-toplevel_inters_lang"><span class="command">lemma</span></span> toplevel_inters_lang<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> toplevel_inters <span class="free">s</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="free">s</span> <span class="main">⊆</span> lang <span class="free">n</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Init_Normalization-toplevel_inters_lang_INT"><span class="command">lemma</span></span> toplevel_inters_lang_INT<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋂</span><span class="bound">r</span><span class="main">∈</span>toplevel_inters <span class="free">s</span><span class="main">.</span> lang <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Init_Normalization-toplevel_inters_in_lang"><span class="command">lemma</span></span> toplevel_inters_in_lang<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>toplevel_inters <span class="free">s</span><span class="main">.</span> <span class="free">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Init_Normalization-lang_flatten_INTERSECT_finite"><span class="command">lemma</span></span> lang_flatten_INTERSECT_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>flatten INTERSECT <span class="free">X</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="free">w</span> <span class="main">∈</span> lists <span class="main">(</span><span class="free">Σ</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="free">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang_INTERSECT <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_distinct</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_distinct</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_distinct</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_distinct</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free">merge_distinct</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free">merge_distinct</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free">merge_distinct</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Init_Normalization-set_merge_distinct"><span class="command">lemma</span></span> set_merge_distinct<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>merge_distinct <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_distinct.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Init_Normalization-sorted_merge_distinct"><span class="command">lemma</span></span> sorted_merge_distinct<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sorted <span class="free">xs</span><span class="main">;</span> sorted <span class="free">ys</span><span class="main">⟧</span> <span class="main">⟹</span> sorted <span class="main">(</span>merge_distinct <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_distinct.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Init_Normalization-distinct_merge_distinct"><span class="command">lemma</span></span> distinct_merge_distinct<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sorted <span class="free">xs</span><span class="main">;</span> distinct <span class="free">xs</span><span class="main">;</span> sorted <span class="free">ys</span><span class="main">;</span> distinct <span class="free">ys</span><span class="main">⟧</span> <span class="main">⟹</span>
  distinct <span class="main">(</span>merge_distinct <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_distinct.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Init_Normalization-sorted_list_of_set_merge_distinct"><span class="command">lemma</span></span> sorted_list_of_set_merge_distinct<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sorted <span class="free">xs</span><span class="main">;</span> distinct <span class="free">xs</span><span class="main">;</span> sorted <span class="free">ys</span><span class="main">;</span> distinct <span class="free">ys</span><span class="main">⟧</span> <span class="main">⟹</span>
  merge_distinct <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sorted_distinct_set_unique<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">zip_with_option</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zip_with_option</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">zip_with_option</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1" id="Init_Normalization-zip_with_option_eq_Some"><span class="command">lemma</span></span> zip_with_option_eq_Some<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"zip_with_option <span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> Some <span class="free">z</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">z</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">a</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> Some <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zip_with_option.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Pluss</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Pluss</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> zip_with_option merge_distinct <span class="main">(</span><span class="free">Pluss</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Pluss</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Pluss</span> Zero <span class="main">=</span> Some <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Pluss</span> Full <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Pluss</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">[</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1" id="Init_Normalization-Pluss_None"><span class="command">lemma</span></span> Pluss_None<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pluss <span class="free">r</span> <span class="main">=</span> None <span class="main">⟷</span> Full <span class="main">∈</span> toplevel_summands <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Init_Normalization-Pluss_Some"><span class="command">lemma</span></span> Pluss_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"Pluss <span class="free">r</span> <span class="main">=</span> Some <span class="free">xs</span> <span class="main">⟷</span>
  <span class="main">(</span>Full <span class="main">∉</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>toplevel_summands <span class="free">r</span> <span class="main">-</span> <span class="main">{</span>Zero<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Pluss <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Pluss <span class="skolem">r</span> <span class="main">=</span> Some <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"Pluss <span class="skolem">s</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> merge_distinct <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Plus<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> Plus<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>toplevel_summands <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>Zero<span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_Diff<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Full <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> Plus<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> Plus<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pluss_None<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Full <span class="main">∉</span> set <span class="main">(</span>sorted_list_of_set <span class="main">(</span>toplevel_summands <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>Zero<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Plus<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">(</span>toplevel_summands <span class="skolem">r</span> <span class="main">-</span> <span class="main">{</span>Zero<span class="main">}</span><span class="main">)</span>"</span></span><span class="main">]</span>
      Plus<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">(</span>toplevel_summands <span class="skolem">s</span> <span class="main">-</span> <span class="main">{</span>Zero<span class="main">}</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Pluss <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>sorted_list_of_set <span class="main">(</span>toplevel_summands <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>Zero<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_Diff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Inters</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Inters</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> zip_with_option merge_distinct <span class="main">(</span><span class="free">Inters</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Inters</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Inters</span> Zero <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Inters</span> Full <span class="main">=</span> Some <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Inters</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">[</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1" id="Init_Normalization-Inters_None"><span class="command">lemma</span></span> Inters_None<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Inters <span class="free">r</span> <span class="main">=</span> None <span class="main">⟷</span> Zero <span class="main">∈</span> toplevel_inters <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Init_Normalization-Inters_Some"><span class="command">lemma</span></span> Inters_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"Inters <span class="free">r</span> <span class="main">=</span> Some <span class="free">xs</span> <span class="main">⟷</span>
  <span class="main">(</span>Zero <span class="main">∉</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>toplevel_inters <span class="free">r</span> <span class="main">-</span> <span class="main">{</span>Full<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inter <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Inters <span class="main">(</span>Inter <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Inters <span class="skolem">r</span> <span class="main">=</span> Some <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"Inters <span class="skolem">s</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> merge_distinct <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Inter<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> Inter<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>toplevel_inters <span class="main">(</span>Inter <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>Full<span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_Diff<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Zero <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> Inter<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> Inter<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inters_None<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Zero <span class="main">∉</span> set <span class="main">(</span>sorted_list_of_set <span class="main">(</span>toplevel_inters <span class="main">(</span>Inter <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>Full<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Inter<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">(</span>toplevel_inters <span class="skolem">r</span> <span class="main">-</span> <span class="main">{</span>Full<span class="main">}</span><span class="main">)</span>"</span></span><span class="main">]</span>
      Inter<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">(</span>toplevel_inters <span class="skolem">s</span> <span class="main">-</span> <span class="main">{</span>Full<span class="main">}</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inters <span class="main">(</span>Inter <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>sorted_list_of_set <span class="main">(</span>toplevel_inters <span class="main">(</span>Inter <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>Full<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_Diff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inPlus</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> Pluss <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Full <span class="main">|</span> Some <span class="bound">rs</span> <span class="main">⇒</span> PLUS <span class="bound">rs</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Init_Normalization-inPlus_alt"><span class="command">lemma</span></span> inPlus_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"inPlus <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">X</span> <span class="main">=</span> toplevel_summands <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>Zero<span class="main">}</span> <span class="keyword1">in</span>
  flatten PLUS <span class="main">(</span><span class="keyword1">if</span> Full <span class="main">∈</span> <span class="bound">X</span> <span class="keyword1">then</span> <span class="main">{</span>Full<span class="main">}</span> <span class="keyword1">else</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Pluss <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"Pluss <span class="free">s</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> option.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> option.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Some_Some <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inPlus_def Pluss_None<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pluss_Some Un_Diff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inPlus_def Pluss_None<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inTimes</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inTimes</span> Zero <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inTimes</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inTimes</span> One <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inTimes</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> One <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inTimes</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">inTimes</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inTimes</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inStar</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inStar</span> Zero <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inStar</span> Full <span class="main">=</span> Full"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inStar</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inStar</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Star <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inStar</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Star <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inInter</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inInter</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> Inters <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Zero <span class="main">|</span> Some <span class="bound">rs</span> <span class="main">⇒</span> INTERSECT <span class="bound">rs</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Init_Normalization-inInter_alt"><span class="command">lemma</span></span> inInter_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"inInter <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">X</span> <span class="main">=</span> toplevel_inters <span class="main">(</span>Inter <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>Full<span class="main">}</span> <span class="keyword1">in</span>
  flatten INTERSECT <span class="main">(</span><span class="keyword1">if</span> Zero <span class="main">∈</span> <span class="bound">X</span> <span class="keyword1">then</span> <span class="main">{</span>Zero<span class="main">}</span> <span class="keyword1">else</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Inters <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"Inters <span class="free">s</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> option.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> option.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Some_Some <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inInter_def Inters_None<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inters_Some Un_Diff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inInter_def Inters_None<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inNot</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inNot</span> Zero <span class="main">=</span> Full"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inNot</span> Full <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inNot</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inNot</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span><span class="free">inNot</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">inNot</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inNot</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">inNot</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">inNot</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inNot</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Not <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inPr</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inPr</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inPr</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inPr</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">inPr</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">inPr</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inPr</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Pr <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">inorm</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inorm</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inorm</span> Full <span class="main">=</span> Full"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inorm</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inorm</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inorm</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">inorm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">inorm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inorm</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">inorm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">inorm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inorm</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> inStar <span class="main">(</span><span class="free">inorm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inorm</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> inNot <span class="main">(</span><span class="free">inorm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inorm</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> inInter <span class="main">(</span><span class="free">inorm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">inorm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inorm</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> inPr <span class="main">(</span><span class="free">inorm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> alphabet <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Init_Normalization-wf_inPlus"><span class="command">lemma</span></span> wf_inPlus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>inPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> toplevel_summands_wf<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inPlus_alt<span class="main">)</span>

<span class="keyword1" id="Init_Normalization-wf_inTimes"><span class="command">lemma</span></span> wf_inTimes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>inTimes <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inTimes.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Init_Normalization-wf_inStar"><span class="command">lemma</span></span> wf_inStar<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>inStar <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inStar.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Init_Normalization-wf_inInter"><span class="command">lemma</span></span> wf_inInter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>inInter <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> toplevel_inters_wf<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inInter_alt<span class="main">)</span>

<span class="keyword1" id="Init_Normalization-wf_inNot"><span class="command">lemma</span></span> wf_inNot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>inNot <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inNot.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Init_Normalization-wf_inPr"><span class="command">lemma</span></span> wf_inPr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>inPr <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inPr.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Init_Normalization-wf_inorm"><span class="command">lemma</span></span> wf_inorm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>inorm <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> project <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Init_Normalization-lang_inPlus"><span class="command">lemma</span></span> lang_inPlus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>inPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inPlus_alt toplevel_summands_in_lang<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="main">]</span></span> toplevel_summands_in_lang<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lang_subset_lists <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">Full</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Init_Normalization-lang_inTimes"><span class="command">lemma</span></span> lang_inTimes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>inTimes <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inTimes.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_assoc<span class="main">)</span>

<span class="keyword1" id="Init_Normalization-lang_inStar"><span class="command">lemma</span></span> lang_inStar<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>inStar <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inStar.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> star_if_lang <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> star_subset_lists<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Init_Normalization-Zero_toplevel_inters"><span class="command">lemma</span></span> Zero_toplevel_inters<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Zero <span class="main">∈</span> toplevel_inters <span class="free">r</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lang.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subset_empty toplevel_inters_lang<span class="main">)</span>

<span class="keyword1" id="Init_Normalization-toplevel_inters_Full"><span class="command">lemma</span></span> toplevel_inters_Full<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>toplevel_inters <span class="free">r</span> <span class="main">=</span> <span class="main">{</span>Full<span class="main">}</span><span class="main">;</span> wf <span class="free">n</span> <span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="free">r</span> <span class="main">=</span> lists <span class="main">(</span><span class="free">Σ</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym lang.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subsetI toplevel_inters.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> toplevel_inters_in_lang<span class="main">)</span>

<span class="keyword1" id="Init_Normalization-toplevel_inters_subset_singleton"><span class="command">lemma</span></span> toplevel_inters_subset_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"toplevel_inters <span class="free">r</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">⟷</span> toplevel_inters <span class="free">r</span> <span class="main">=</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset_refl subset_singletonD toplevel_inters_nonempty<span class="main">)</span>

<span class="keyword1" id="Init_Normalization-lang_inInter"><span class="command">lemma</span></span> lang_inInter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>inInter <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>Inter <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lang_subset_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">,</span> <span class="operator">unfolded</span> lang.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    toplevel_inters_nonempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> toplevel_inters_nonempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 0 2 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inInter_alt toplevel_inters_in_lang<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="main">]</span></span> toplevel_inters_in_lang<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="main">]</span></span>
     toplevel_inters_wf<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="main">]</span></span> toplevel_inters_wf<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="main">]</span></span> Ball_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> toplevel_inters_nonempty
     <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> toplevel_inters_Full<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Init_Normalization-lang_inNot"><span class="command">lemma</span></span> lang_inNot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>inNot <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>Not <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inNot.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lang_subset_lists<span class="main">)</span>

<span class="keyword1" id="Init_Normalization-lang_inPr"><span class="command">lemma</span></span> lang_inPr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">r</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>inPr <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>Pr <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inPr.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Init_Normalization-lang_inorm"><span class="command">lemma</span></span> lang_inorm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>inorm <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="PNormalization">
<div class="head">
<h1>Theory PNormalization</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Partial Derivatives-like Normalization"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> PNormalization
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Pi_Derivatives">Pi_Derivatives</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pnPlus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnPlus</span> Zero <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> Zero <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
| "pnPlus Full r = Full"
| "pnPlus r Full = Full"
*)</span>
<span class="comment1">(*&gt;*)</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnPlus</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free">pnPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">pnPlus</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">pnPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
      <span class="keyword1">else</span> Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> alphabet<span class="main">)</span> wf_pnPlus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>pnPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnPlus.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> project<span class="main">)</span> lang_pnPlus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>pnPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnPlus.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lang_subset_lists <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> project
      subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> star_subset_lists<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> in_lists_conv_set<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
      subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> conc_subset_lists<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> in_lists_conv_set<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pnTimes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnTimes</span> Zero <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnTimes</span> One <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnTimes</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> pnPlus <span class="main">(</span><span class="free">pnTimes</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">pnTimes</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnTimes</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> alphabet<span class="main">)</span> wf_pnTimes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>pnTimes <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnTimes.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> project<span class="main">)</span> lang_pnTimes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>pnTimes <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnTimes.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pnInter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnInter</span> Zero <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnInter</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnInter</span> Full <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnInter</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> Full <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnInter</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> pnPlus <span class="main">(</span><span class="free">pnInter</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">pnInter</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnInter</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> pnPlus <span class="main">(</span><span class="free">pnInter</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">pnInter</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnInter</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free">pnInter</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">pnInter</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnInter</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Inter <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> Inter <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">pnInter</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnInter</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
      <span class="keyword1">else</span> Inter <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> alphabet<span class="main">)</span> wf_pnInter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>pnInter <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnInter.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> project<span class="main">)</span> lang_pnInter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">n</span> <span class="free">r</span><span class="main">;</span> wf <span class="free">n</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>pnInter <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>Inter <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnInter.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lang_subset_lists <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> project
      subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> star_subset_lists<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> in_lists_conv_set<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
      subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> conc_subset_lists<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> in_lists_conv_set<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pnNot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnNot</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> pnInter <span class="main">(</span><span class="free">pnNot</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">pnNot</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnNot</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> pnPlus <span class="main">(</span><span class="free">pnNot</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">pnNot</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnNot</span> Full <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnNot</span> Zero <span class="main">=</span> Full"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnNot</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnNot</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Not <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> alphabet<span class="main">)</span> wf_pnNot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>pnNot <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnNot.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> project<span class="main">)</span> lang_pnNot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>pnNot <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>Not <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnNot.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lang_subset_lists<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pnPr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnPr</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnPr</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnPr</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> pnPlus <span class="main">(</span><span class="free">pnPr</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">pnPr</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnPr</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Pr <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> alphabet<span class="main">)</span> wf_pnPr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>pnPr <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnPr.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> project<span class="main">)</span> lang_pnPr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">r</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>pnPr <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>Pr <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnPr.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">pnorm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnorm</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm</span> Full <span class="main">=</span> Full"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> pnPlus <span class="main">(</span><span class="free">pnorm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">pnorm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> pnTimes <span class="main">(</span><span class="free">pnorm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Star <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm</span> <span class="main">(</span>Inter <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> pnInter <span class="main">(</span><span class="free">pnorm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">pnorm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> pnNot <span class="main">(</span><span class="free">pnorm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> pnPr <span class="main">(</span><span class="free">pnorm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> alphabet<span class="main">)</span> wf_pnorm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>pnorm <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> project<span class="main">)</span> lang_pnorm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">n</span> <span class="free">r</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>pnorm <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Formula">
<div class="head">
<h1>Theory Formula</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Monadic Second-Order Logic Formulas›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Formula
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Pi_Regular_Operators">Pi_Regular_Operators</a> <a href="#List_More">List_More</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Interpretations and Encodings›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> interp <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">×</span> <span class="main">(</span>nat <span class="main">+</span> nat set<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">enc_atom_bool</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="bound">p</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∈</span> <span class="bound">P</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">enc_atom</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> enc_atom_bool <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax and Semantics of MSO›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> formula <span class="main">=</span>
  FQ <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted">nat</span>
<span class="main">|</span> FLess <span class="quoted">nat</span> <span class="quoted">nat</span>
<span class="main">|</span> FIn <span class="quoted">nat</span> <span class="quoted">nat</span>
<span class="main">|</span> FNot <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span>
<span class="main">|</span> FOr <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span>
<span class="main">|</span> FAnd <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span>
<span class="main">|</span> FExists <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span>
<span class="main">|</span> FEXISTS <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">FOV</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">FOV</span> <span class="main">(</span>FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FOV</span> <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FOV</span> <span class="main">(</span>FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FOV</span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">FOV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FOV</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">FOV</span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free">FOV</span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FOV</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">FOV</span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free">FOV</span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FOV</span> <span class="main">(</span>FExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">FOV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FOV</span> <span class="main">(</span>FEXISTS <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">FOV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">SOV</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SOV</span> <span class="main">(</span>FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SOV</span> <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SOV</span> <span class="main">(</span>FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SOV</span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">SOV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SOV</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">SOV</span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free">SOV</span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SOV</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">SOV</span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free">SOV</span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SOV</span> <span class="main">(</span>FExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">SOV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SOV</span> <span class="main">(</span>FEXISTS <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">SOV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">Σ</span> <span class="bound">n</span><span class="main">.</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">bs</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span> <span class="bound">Σ</span><span class="main">)</span> <span class="main">(</span>List.n_lists <span class="bound">n</span> <span class="main">[</span>True<span class="main">,</span> False<span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> tl <span class="bound">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">Σ</span> <span class="main">(</span><span class="bound">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="bound">Σ</span> <span class="keyword1">then</span> <span class="main">[</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> True <span class="main">#</span> <span class="bound">bs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> False <span class="main">#</span> <span class="bound">bs</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> atom <span class="main">=</span>
    Singleton <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"bool list"</span></span>
  <span class="main">|</span> AQ <span class="quoted">nat</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="main">|</span> Arbitrary_Except <span class="quoted">nat</span> <span class="quoted">bool</span>
  <span class="main">|</span> Arbitrary_Except2 <span class="quoted">nat</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">atom</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wf_atom</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_atom</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Singleton <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf_atom</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>AQ <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf_atom</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf_atom</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Arbitrary_Except2 <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lookup</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="main">(</span>Singleton <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="main">(</span>AQ <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="main">(</span>Arbitrary_Except2 <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Formula-π_σ"><span class="command">lemma</span></span> π_σ<span class="main">:</span> <span class="quoted"><span class="quoted">"π <span class="main">`</span> <span class="main">(</span>set <span class="keyword1">o</span> σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>set <span class="keyword1">o</span> σ <span class="free">Σ</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> π_def σ_def set_map<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> o_apply map_concat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">locale</span></span> formula <span class="main">=</span> embed2 <span class="quoted"><span class="quoted">"set <span class="keyword1">o</span> <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_atom <span class="free">Σ</span>"</span></span> <span class="quoted">π</span> <span class="quoted">lookup</span> <span class="quoted"><span class="quoted">"ε <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"case_prod Singleton"</span></span>
<span class="keyword2"><span class="keyword">for</span></span> <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder list"</span></span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">assumes</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Σ_product_lists</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
   List.maps <span class="main">(</span><span class="main">λ</span><span class="bound">bools</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">bools</span><span class="main">)</span><span class="main">)</span> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>bool_product_lists <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Normal form: quantified variables are used in the body *)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">pre_wf_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre_wf_formula</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> set <span class="free">Σ</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre_wf_formula</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre_wf_formula</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre_wf_formula</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">pre_wf_formula</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre_wf_formula</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">pre_wf_formula</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> <span class="free">pre_wf_formula</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre_wf_formula</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">pre_wf_formula</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> <span class="free">pre_wf_formula</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre_wf_formula</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">pre_wf_formula</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="main">0</span> <span class="main">∈</span> FOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="main">0</span> <span class="main">∉</span> SOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pre_wf_formula</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FEXISTS <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">pre_wf_formula</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="main">0</span> <span class="main">∉</span> FOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="main">0</span> <span class="main">∈</span> SOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="main">≡</span> pre_wf_formula <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_formula</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> pre_wf_formula <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> FOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∩</span> SOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1" id="Formula-max_idx_vars"><span class="command">lemma</span></span> max_idx_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> FOV <span class="free">φ</span> <span class="main">∪</span> SOV <span class="free">φ</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff diff_Suc_less less_SucE less_imp_diff_less<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Formula-finite_FOV"><span class="command">lemma</span></span> finite_FOV<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ENC›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid_ENC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> atom<span class="main">)</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_ENC</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Full <span class="keyword1">else</span>
    TIMES <span class="main">[</span>
      Star <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">p</span></span></span> False<span class="main">)</span><span class="main">)</span><span class="main">,</span>
      Atom <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">p</span></span></span> True<span class="main">)</span><span class="main">,</span>
      Star <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">p</span></span></span> False<span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Formula-wf_rexp_valid_ENC"><span class="command">lemma</span></span> wf_rexp_valid_ENC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>valid_ENC <span class="free">n</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valid_ENC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ENC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> atom<span class="main">)</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ENC</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">=</span> flatten INTERSECT <span class="main">(</span>valid_ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Formula-wf_rexp_ENC"><span class="command">lemma</span></span> wf_rexp_ENC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">V</span><span class="main">;</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">.</span> <span class="bound">v</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="free">V</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ENC_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_flatten_INTERSECT<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_rexp_valid_ENC<span class="main">)</span>

<span class="keyword1" id="Formula-enc_atom_σ_eq"><span class="command">lemma</span></span> enc_atom_σ_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">w</span> <span class="main">⟹</span>
 <span class="main">(</span>length <span class="free">I</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">∈</span> set <span class="free">Σ</span><span class="main">)</span> <span class="main">⟷</span> enc_atom <span class="free">I</span> <span class="free">i</span> <span class="free">p</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="free">Σ</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def set_n_lists <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"enc_atom_bool <span class="free">I</span> <span class="free">i</span>"</span></span><span class="main"><span class="main">]</span></span> imageI<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> enc_atom_σ <span class="main">=</span> iffD1<span class="main">[</span><span class="operator">OF</span> enc_atom_σ_eq<span class="main">,</span> <span class="operator">OF</span> _ conjI<span class="main">]</span>

<span class="keyword1" id="Formula-enc_atom_bool_take_drop_True"><span class="command">lemma</span></span> enc_atom_bool_take_drop_True<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">r</span> <span class="main">&lt;</span> length <span class="free">I</span><span class="main">;</span> <span class="keyword1">case</span> <span class="free">I</span> <span class="main">!</span> <span class="free">r</span> <span class="keyword1">of</span> Inl <span class="bound">p'</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">=</span> <span class="bound">p'</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">P</span><span class="main">⟧</span> <span class="main">⟹</span>
    enc_atom_bool <span class="free">I</span> <span class="free">p</span> <span class="main">=</span> take <span class="free">r</span> <span class="main">(</span>enc_atom_bool <span class="free">I</span> <span class="free">p</span><span class="main">)</span> <span class="main">@</span> True <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">(</span>enc_atom_bool <span class="free">I</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> id_take_nth_drop<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Formula-enc_atom_bool_take_drop_True2"><span class="command">lemma</span></span> enc_atom_bool_take_drop_True2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">r</span> <span class="main">&lt;</span> length <span class="free">I</span><span class="main">;</span> <span class="keyword1">case</span> <span class="free">I</span> <span class="main">!</span> <span class="free">r</span> <span class="keyword1">of</span> Inl <span class="bound">p'</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">=</span> <span class="bound">p'</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">P</span><span class="main">;</span>
    <span class="free">s</span> <span class="main">&lt;</span> length <span class="free">I</span><span class="main">;</span> <span class="keyword1">case</span> <span class="free">I</span> <span class="main">!</span> <span class="free">s</span> <span class="keyword1">of</span> Inl <span class="bound">p'</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">=</span> <span class="bound">p'</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">P</span><span class="main">;</span> <span class="free">r</span> <span class="main">&lt;</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
    enc_atom_bool <span class="free">I</span> <span class="free">p</span> <span class="main">=</span> take <span class="free">r</span> <span class="main">(</span>enc_atom_bool <span class="free">I</span> <span class="free">p</span><span class="main">)</span> <span class="main">@</span> True <span class="main">#</span>
      take <span class="main">(</span><span class="free">s</span> <span class="main">-</span> Suc <span class="free">r</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">(</span>enc_atom_bool <span class="free">I</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> True <span class="main">#</span>
      drop <span class="main">(</span>Suc <span class="free">s</span><span class="main">)</span> <span class="main">(</span>enc_atom_bool <span class="free">I</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">"enc_atom_bool <span class="free">I</span> <span class="free">p</span>"</span></span><span class="main">]</span>
      id_take_nth_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">-</span> <span class="free">r</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">(</span>enc_atom_bool <span class="free">I</span> <span class="free">p</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Formula-enc_atom_bool_take_drop_False"><span class="command">lemma</span></span> enc_atom_bool_take_drop_False<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">r</span> <span class="main">&lt;</span> length <span class="free">I</span><span class="main">;</span> <span class="keyword1">case</span> <span class="free">I</span> <span class="main">!</span> <span class="free">r</span> <span class="keyword1">of</span> Inl <span class="bound">p'</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">≠</span> <span class="bound">p'</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">∉</span> <span class="bound">P</span><span class="main">⟧</span> <span class="main">⟹</span>
    enc_atom_bool <span class="free">I</span> <span class="free">p</span> <span class="main">=</span> take <span class="free">r</span> <span class="main">(</span>enc_atom_bool <span class="free">I</span> <span class="free">p</span><span class="main">)</span> <span class="main">@</span> False <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">(</span>enc_atom_bool <span class="free">I</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> id_take_nth_drop<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1" id="Formula-enc_atom_lang_AQ"><span class="command">lemma</span></span> enc_atom_lang_AQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">r</span> <span class="main">&lt;</span> length <span class="free">I</span><span class="main">;</span>
   <span class="keyword1">case</span> <span class="free">I</span> <span class="main">!</span> <span class="free">r</span> <span class="keyword1">of</span> Inl <span class="bound">p'</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">=</span> <span class="bound">p'</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">P</span><span class="main">;</span> length <span class="free">I</span> <span class="main">=</span> <span class="free">n</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> set <span class="free">Σ</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">[</span>enc_atom <span class="free">I</span> <span class="free">p</span> <span class="free">a</span><span class="main">]</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>AQ <span class="free">r</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_bool_take_drop_True
    image_eqI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">J</span><span class="main">.</span> take <span class="free">r</span> <span class="bound">J</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">J</span><span class="main">)</span> <span class="main">(</span>enc_atom_bool <span class="free">I</span> <span class="free">p</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def set_n_lists<span class="main">)</span>

<span class="keyword1" id="Formula-enc_atom_lang_Arbitrary_Except_True"><span class="command">lemma</span></span> enc_atom_lang_Arbitrary_Except_True<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">r</span> <span class="main">&lt;</span> length <span class="free">I</span><span class="main">;</span>
   <span class="keyword1">case</span> <span class="free">I</span> <span class="main">!</span> <span class="free">r</span> <span class="keyword1">of</span> Inl <span class="bound">p'</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">=</span> <span class="bound">p'</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">P</span><span class="main">;</span> length <span class="free">I</span> <span class="main">=</span> <span class="free">n</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> set <span class="free">Σ</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">[</span>enc_atom <span class="free">I</span> <span class="free">p</span> <span class="free">a</span><span class="main">]</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="free">r</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_bool_take_drop_True
    image_eqI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">J</span><span class="main">.</span> take <span class="free">r</span> <span class="bound">J</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">J</span><span class="main">)</span> <span class="main">(</span>enc_atom_bool <span class="free">I</span> <span class="free">p</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def set_n_lists<span class="main">)</span>

<span class="keyword1" id="Formula-enc_atom_lang_Arbitrary_Except2"><span class="command">lemma</span></span> enc_atom_lang_Arbitrary_Except2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">r</span> <span class="main">&lt;</span> length <span class="free">I</span><span class="main">;</span> <span class="free">s</span> <span class="main">&lt;</span> length <span class="free">I</span><span class="main">;</span> 
  <span class="keyword1">case</span> <span class="free">I</span> <span class="main">!</span> <span class="free">r</span> <span class="keyword1">of</span> Inl <span class="bound">p'</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">=</span> <span class="bound">p'</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">P</span><span class="main">;</span>
  <span class="keyword1">case</span> <span class="free">I</span> <span class="main">!</span> <span class="free">s</span> <span class="keyword1">of</span> Inl <span class="bound">p'</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">=</span> <span class="bound">p'</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">P</span><span class="main">;</span> length <span class="free">I</span> <span class="main">=</span> <span class="free">n</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> set <span class="free">Σ</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">[</span>enc_atom <span class="free">I</span> <span class="free">p</span> <span class="free">a</span><span class="main">]</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except2 <span class="free">r</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_bool_take_drop_True2
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_n_lists σ_def take_Cons' drop_Cons' numeral_eq_Suc<span class="main">)</span>

<span class="keyword1" id="Formula-enc_atom_lang_Arbitrary_Except_False"><span class="command">lemma</span></span> enc_atom_lang_Arbitrary_Except_False<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">r</span> <span class="main">&lt;</span> length <span class="free">I</span><span class="main">;</span>
  <span class="keyword1">case</span> <span class="free">I</span> <span class="main">!</span> <span class="free">r</span> <span class="keyword1">of</span> Inl <span class="bound">p'</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">≠</span> <span class="bound">p'</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">∉</span> <span class="bound">P</span><span class="main">;</span> length <span class="free">I</span> <span class="main">=</span> <span class="free">n</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> set <span class="free">Σ</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">[</span>enc_atom <span class="free">I</span> <span class="free">p</span> <span class="free">a</span><span class="main">]</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="free">r</span> False<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_bool_take_drop_False
    image_eqI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">J</span><span class="main">.</span> take <span class="free">r</span> <span class="bound">J</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">J</span><span class="main">)</span> <span class="main">(</span>enc_atom_bool <span class="free">I</span> <span class="free">p</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_n_lists σ_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1" id="Formula-AQ_D"><span class="command">lemma</span></span> AQ_D<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>AQ <span class="free">m</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∧</span> fst <span class="bound">x</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> snd <span class="bound">x</span> <span class="main">!</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Formula-Arbitrary_ExceptD"><span class="command">lemma</span></span> Arbitrary_ExceptD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="free">r</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∧</span> snd <span class="bound">x</span> <span class="main">!</span> <span class="free">r</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Formula-Arbitrary_Except2D"><span class="command">lemma</span></span> Arbitrary_Except2D<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except2 <span class="free">r</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∧</span> snd <span class="bound">x</span> <span class="main">!</span> <span class="free">r</span> <span class="main">∧</span> snd <span class="bound">x</span> <span class="main">!</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Formula-star_Arbitrary_ExceptD"><span class="command">lemma</span></span> star_Arbitrary_ExceptD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">v</span> <span class="main">∈</span> star <span class="main">(</span>lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="free">r</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free">r</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">v</span><span class="main">⟧</span> <span class="main">⟹</span>
    snd <span class="main">(</span><span class="free">v</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">!</span> <span class="free">r</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> star_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>append <span class="skolem">u</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Arbitrary_ExceptD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="M2L">
<div class="head">
<h1>Theory M2L</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹M2L›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> M2L
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Formula">Formula</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Encodings›</span></span>

<span class="keyword1"><span class="command">context</span></span> formula
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">enc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool list<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enc</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">=</span> map_index <span class="main">(</span>enc_atom <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">wf_interp</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">Σ</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wf_interp_for_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interp <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_interp_for_formula</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span>
    <span class="main">(</span>wf_interp <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> FOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">!</span> <span class="bound">n</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> SOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">!</span> <span class="bound">n</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">satisfies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interp <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> FLess <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="main">(</span>FExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> length <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> Inl <span class="bound">p</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="main">(</span>FEXISTS <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> length <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> Inr <span class="bound">P</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool list<span class="main">)</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">{</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span> <span class="bound">I</span><span class="main">.</span>
     length <span class="bound">I</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> wf_interp_for_formula <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> satisfies <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec_word</span> <span class="main">≡</span> map fst"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">positions_in_row</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span>
  Option.these <span class="main">(</span>set <span class="main">(</span>map_index <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">a_bs</span><span class="main">.</span> <span class="keyword1">if</span> nth <span class="main">(</span>snd <span class="bound">a_bs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> Some <span class="bound">p</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec_interp</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">FO</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool list<span class="main">)</span> list<span class="main">)</span> <span class="main">≡</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span>
  <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">FO</span></span></span>
  <span class="keyword1">then</span> Inl <span class="main">(</span>the_elem <span class="main">(</span>positions_in_row <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span> Inr <span class="main">(</span>positions_in_row <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1" id="M2L-positions_in_row"><span class="command">lemma</span></span> positions_in_row<span class="main">:</span> <span class="quoted"><span class="quoted">"positions_in_row <span class="free">w</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="free">w</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">w</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> positions_in_row_def Option.these_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">the</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="M2L-positions_in_row_unique"><span class="command">lemma</span></span> positions_in_row_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="free">w</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">w</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">⟹</span>
  the_elem <span class="main">(</span>positions_in_row <span class="free">w</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="free">w</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">w</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> the1I2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> the_elem_def positions_in_row<span class="main">)</span>

<span class="keyword1" id="M2L-positions_in_row_length"><span class="command">lemma</span></span> positions_in_row_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="free">w</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">w</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">⟹</span>
  the_elem <span class="main">(</span>positions_in_row <span class="free">w</span> <span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> positions_in_row_unique <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> the1I2<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-dec_interp_Inl"><span class="command">lemma</span></span> dec_interp_Inl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="free">x</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inl <span class="bound">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dec_interp_def <span class="keyword1"><span class="command">using</span></span> nth_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-dec_interp_not_Inr"><span class="command">lemma</span></span> dec_interp_not_Inr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="free">x</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inr <span class="free">P</span><span class="main">;</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dec_interp_def <span class="keyword1"><span class="command">using</span></span> nth_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-dec_interp_Inr"><span class="command">lemma</span></span> dec_interp_Inr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">∉</span> <span class="free">FO</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">P</span><span class="main">.</span> dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="free">x</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inr <span class="bound">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dec_interp_def <span class="keyword1"><span class="command">using</span></span> nth_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-dec_interp_not_Inl"><span class="command">lemma</span></span> dec_interp_not_Inl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="free">x</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inl <span class="free">p</span><span class="main">;</span> <span class="free">i</span> <span class="main">∉</span> <span class="free">FO</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dec_interp_def <span class="keyword1"><span class="command">using</span></span> nth_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-Inl_dec_interp_length"><span class="command">lemma</span></span> Inl_dec_interp_length<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">.</span> <span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="free">w</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">w</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inl <span class="free">p</span> <span class="main">∈</span> set <span class="main">(</span>dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">&lt;</span> length <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dec_interp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> positions_in_row_length<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bspec<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="M2L-Inr_dec_interp_length"><span class="command">lemma</span></span> Inr_dec_interp_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Inr <span class="free">P</span> <span class="main">∈</span> set <span class="main">(</span>dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="free">w</span><span class="main">)</span><span class="main">;</span> <span class="free">p</span> <span class="main">∈</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">&lt;</span> length <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dec_interp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> positions_in_row<span class="main">)</span>

<span class="keyword1" id="M2L-the_elem_Collect"><span class="command">lemma</span></span> the_elem_Collect<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"the_elem <span class="main">(</span>Collect <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>The <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> the_elem_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> the_equality<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>The <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> theI'<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Collect <span class="free">P</span> <span class="main">=</span> <span class="main">{</span>The <span class="free">P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Collect <span class="free">P</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> The <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> the_equality<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1" id="M2L-enc_atom_dec"><span class="command">lemma</span></span> enc_atom_dec<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf_word <span class="free">n</span> <span class="free">w</span><span class="main">;</span> <span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="free">w</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">w</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span> <span class="free">p</span> <span class="main">&lt;</span> length <span class="free">w</span><span class="main">⟧</span> <span class="main">⟹</span>
   enc_atom <span class="main">(</span>dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="free">w</span><span class="main">)</span> <span class="free">p</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">w</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span> <span class="main">!</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_word dec_interp_def map_filter_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def σ_def set_n_lists positions_in_row <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nth_mem<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iffD2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> prod.inject<span class="main"><span class="main"><span class="main">]</span></span></span> prod.collapse<span class="main"><span class="main">]</span></span> nth_equalityI the_equality<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> the1I2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="free">w</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">w</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="main">(</span><span class="free">w</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">i</span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">False</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="M2L-enc_dec"><span class="command">lemma</span></span> enc_dec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf_word <span class="free">n</span> <span class="free">w</span><span class="main">;</span> <span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="free">w</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">w</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
   enc <span class="main">(</span>dec_word <span class="free">w</span><span class="main">,</span> dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> enc.simps dec_word_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_index_map map_index_congL<span class="main"><span class="main">]</span></span> allI impI enc_atom_dec<span class="main">)</span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="M2L-dec_word_enc"><span class="command">lemma</span></span> dec_word_enc<span class="main">:</span> <span class="quoted"><span class="quoted">"dec_word <span class="main">(</span>enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dec_word_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-enc_unique"><span class="command">lemma</span></span> enc_unique<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_interp <span class="free">w</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="free">I</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inl <span class="bound">p</span> <span class="main">⟹</span> <span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="main">(</span>enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_index all_set_conv_all_nth <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="M2L-dec_interp_enc_Inl"><span class="command">lemma</span></span> dec_interp_enc_Inl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="main">(</span>enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inl <span class="free">p'</span><span class="main">;</span> <span class="free">I</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inl <span class="free">p</span><span class="main">;</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">;</span> length <span class="free">I</span> <span class="main">=</span> <span class="free">n</span><span class="main">;</span> <span class="free">p</span> <span class="main">&lt;</span> length <span class="free">w</span><span class="main">;</span> wf_interp <span class="free">w</span> <span class="free">I</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">p</span> <span class="main">=</span> <span class="free">p'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dec_interp_def <span class="keyword1"><span class="command">using</span></span> nth_map<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span><span class="main">]</span> positions_in_row_unique<span class="main">[</span><span class="operator">OF</span> enc_unique<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> the_equality<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="M2L-dec_interp_enc_Inr"><span class="command">lemma</span></span> dec_interp_enc_Inr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="main">(</span>enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inr <span class="free">P'</span><span class="main">;</span> <span class="free">I</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inr <span class="free">P</span><span class="main">;</span> <span class="free">i</span> <span class="main">∉</span> <span class="free">FO</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">;</span> length <span class="free">I</span> <span class="main">=</span> <span class="free">n</span><span class="main">;</span> <span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="free">w</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">P</span> <span class="main">=</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dec_interp_def positions_in_row <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-length_dec_interp"><span class="command">lemma</span></span> length_dec_interp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_interp_def<span class="main">)</span>

<span class="keyword1" id="M2L-nth_dec_interp"><span class="command">lemma</span></span> nth_dec_interp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> dec_interp <span class="free">n</span> <span class="main">{}</span> <span class="free">x</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inr <span class="main">(</span>positions_in_row <span class="free">x</span> <span class="free">i</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_interp_def<span class="main">)</span>

<span class="keyword1" id="M2L-set_σD"><span class="command">lemma</span></span> set_σD<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="free">Σ</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> set <span class="free">Σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> σ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-lang_ENC"><span class="command">lemma</span></span> lang_ENC<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">FO</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">SO</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="free">FO</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="free">FO</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span> <span class="bound">I</span> <span class="main">.</span> length <span class="bound">I</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> wf_interp <span class="bound">w</span> <span class="bound">I</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">I</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">SO</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">I</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">}</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">FO</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ENC_def dec_word_def wf_word
      in_set_conv_nth<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"dec_interp <span class="free">n</span> <span class="main">{}</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span> positions_in_row Ball_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"dec_word <span class="skolem">x</span> <span class="main">::</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"dec_interp <span class="free">n</span> <span class="main">{}</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span>
        enc_dec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> dec_word_def enc.simps map_index_map<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_ENC <span class="free">n</span> <span class="main">`</span> <span class="free">FO</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>valid_ENC <span class="free">n</span> <span class="main">`</span> <span class="free">FO</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> False assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> wf_rexp_valid_ENC assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> wf_rexp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> valid_ENC <span class="free">n</span> <span class="main">`</span> <span class="free">FO</span><span class="main">.</span> wf <span class="free">n</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">w</span> <span class="skolem">I</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">FO</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp <span class="skolem">w</span> <span class="skolem">I</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">.</span> <span class="keyword1">case</span> <span class="skolem">I</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">SO</span><span class="main">.</span> <span class="keyword1">case</span> <span class="skolem">I</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">r</span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">r</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">FO</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> *<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> length <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inl <span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">!</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="free">Σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&lt;</span> length <span class="skolem">I</span>›</span></span> p *<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> set <span class="free">Σ</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="skolem">a</span><span class="main">]</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">r</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> enc_atom_lang_Arbitrary_Except_True<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&lt;</span> length <span class="skolem">I</span>›</span></span> p *<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> set <span class="free">Σ</span>›</span></span> *<span class="main">(</span>2<span class="main">)</span>  <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">w</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> star <span class="main">(</span>lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">r</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> lang.simps
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Ball_starI enc_atom_lang_Arbitrary_Except_False<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&lt;</span> length <span class="skolem">I</span>›</span></span> p *<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> set <span class="free">Σ</span>›</span></span> *<span class="main">(</span>2<span class="main">)</span>  <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">w</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> star <span class="main">(</span>lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">r</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> lang.simps
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Ball_starI enc_atom_lang_Arbitrary_Except_False<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
      lang <span class="free">n</span> <span class="main">(</span>valid_ENC <span class="free">n</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> valid_ENC_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> append.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">w</span>›</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>valid_ENC <span class="free">n</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">⊆</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lang_flatten_INTERSECT<span class="main">[</span><span class="operator">OF</span> finite nonempty wf_rexp<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ENC_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋂</span><span class="bound">r</span> <span class="main">∈</span> valid_ENC <span class="free">n</span> <span class="main">`</span> <span class="free">FO</span><span class="main">.</span> lang <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>valid_ENC <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dec_interp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">FO</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">FO</span>›</span></span> r <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> uvw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> star <span class="main">(</span>lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">r</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">r</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> star <span class="main">(</span>lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">r</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> valid_ENC_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> lang.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">u</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">x</span> <span class="main">⟶</span> snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">r</span> <span class="main">⟷</span> <span class="bound">i</span> <span class="main">=</span> length <span class="skolem">u</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> lang.simps
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Arbitrary_ExceptD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> star_Arbitrary_ExceptD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> star_Arbitrary_ExceptD<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted">False</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> x_wf_word<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_word <span class="free">n</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf_lang_wf_word<span class="main">[</span><span class="operator">OF</span> wf_rexp_valid_ENC<span class="main">]</span> False r assms<span class="main">(</span>1<span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span>dec_word <span class="skolem">x</span><span class="main">,</span> dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> enc_dec<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_interp <span class="main">(</span>dec_word <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">.</span> <span class="keyword1">case</span> dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="skolem">x</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">SO</span><span class="main">.</span> <span class="keyword1">case</span> dec_interp <span class="free">n</span> <span class="free">FO</span> <span class="skolem">x</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False x_wf_word<span class="main">[</span><span class="operator">unfolded</span> wf_word<span class="main">,</span> <span class="operator">unfolded</span> σ_def o_apply set_concat set_map set_n_lists<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> assms
        Inl_dec_interp_length<span class="main">[</span><span class="operator">OF</span> ballI<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">FO</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> Inr_dec_interp_length<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">FO</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
        dec_interp_Inl<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">FO</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> dec_interp_Inr<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">FO</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dec_word_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> False lang_flatten_INTERSECT<span class="main">[</span><span class="operator">OF</span> finite nonempty wf_rexp<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ENC_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="M2L-lang_ENC_formula"><span class="command">lemma</span></span> lang_ENC_formula<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span> <span class="bound">I</span> <span class="main">.</span> length <span class="bound">I</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> wf_interp_for_formula <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms max_idx_vars <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"FOV <span class="free">φ</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"SOV <span class="free">φ</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">-</span> FOV <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Welldefinedness of enc wrt. Models›</span></span>

<span class="keyword1" id="M2L-enc_alt_def"><span class="command">lemma</span></span> enc_alt_def<span class="main">:</span>
 <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> map_index <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">n</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="bound">n</span> <span class="main">∈</span> <span class="bound">P</span><span class="main">)</span> <span class="main">#</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>

<span class="keyword1" id="M2L-enc_extend_interp"><span class="command">lemma</span></span> enc_extend_interp<span class="main">:</span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> enc <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span> <span class="main">⟹</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> enc <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">I'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> enc_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-wf_interp_for_formula_FExists"><span class="command">lemma</span></span> wf_interp_for_formula_FExists<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf_formula <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span><span class="main">;</span> <span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">⟧</span><span class="main">⟹</span>
    wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">p</span></span> <span class="main">&lt;</span> length <span class="free">w</span><span class="main">.</span> wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inl <span class="bound">p</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="M2L-wf_interp_for_formula_any_Inl"><span class="command">lemma</span></span> wf_interp_for_formula_any_Inl<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inl <span class="free">p</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound"><span class="bound">p</span></span> <span class="main">&lt;</span> length <span class="free">w</span><span class="main">.</span> wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inl <span class="bound">p</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="M2L-wf_interp_for_formula_FEXISTS"><span class="command">lemma</span></span> wf_interp_for_formula_FEXISTS<span class="main">:</span> 
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf_formula <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span><span class="main">;</span> <span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">⟧</span><span class="main">⟹</span>
  wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">P</span></span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> length <span class="free">w</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inr <span class="bound">P</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Nil_conv nth_Cons'<span class="main">)</span>

<span class="keyword1" id="M2L-wf_interp_for_formula_any_Inr"><span class="command">lemma</span></span> wf_interp_for_formula_any_Inr<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inr <span class="free">P</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound"><span class="bound">P</span></span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> length <span class="free">w</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inr <span class="bound">P</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="M2L-enc_word_length"><span class="command">lemma</span></span> enc_word_length<span class="main">:</span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> enc <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span> <span class="main">⟹</span> length <span class="free">w</span> <span class="main">=</span> length <span class="free">w'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> map_index_eq_imp_length_eq<span class="main">)</span>

<span class="keyword1" id="M2L-enc_length"><span class="command">lemma</span></span> enc_length<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> enc <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">I</span> <span class="main">=</span> length <span class="free">I'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  length_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">∈</span> <span class="bound">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span>
  length_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">∈</span> <span class="bound">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">I'</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> enc_word_length<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-wf_interp_for_formula_FOr"><span class="command">lemma</span></span> wf_interp_for_formula_FOr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>FOr <span class="free">φ1</span> <span class="free">φ2</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ1</span> <span class="main">∧</span> wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-wf_interp_for_formula_FAnd"><span class="command">lemma</span></span> wf_interp_for_formula_FAnd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>FAnd <span class="free">φ1</span> <span class="free">φ2</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ1</span> <span class="main">∧</span> wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-enc_wf_interp"><span class="command">lemma</span></span> enc_wf_interp<span class="main">:</span> 
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_formula <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span>dec_word <span class="main">(</span>enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> dec_interp <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
 <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?dec</span><span class="main">)</span> <span class="free">φ</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> dec_word_enc
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> FOV <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="free">I</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> Inl <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> i assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="main">(</span>enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> enc_unique<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">w</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bspec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> max_idx_vars<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="var">?dec</span><span class="main">.</span> case_sum <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="free">w</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="free">w</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">split</span> sum.split<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Inl <span class="skolem">p</span> <span class="main">∈</span> set <span class="var">?dec</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Inl_dec_interp_length<span class="main">[</span><span class="operator">OF</span> ballI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">P</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Inr <span class="skolem">P</span> <span class="main">∈</span> set <span class="var">?dec</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Inr_dec_interp_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="var">?dec</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
    dec_interp_Inl<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"FOV <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ bspec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> max_idx_vars<span class="main"><span class="main">]</span></span><span class="main">]</span>
    dec_interp_Inr<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"FOV <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ bspec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> max_idx_vars<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="M2L-enc_welldef"><span class="command">lemma</span></span> enc_welldef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> enc <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span><span class="main">;</span> wf_formula <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">;</span>
  wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">;</span> wf_interp_for_formula <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span> <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span>
  satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span> <span class="main">⟷</span> satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">I'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">w</span> <span class="bound">I</span><span class="main">.</span> <span class="main">(</span>dec_word <span class="main">(</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> dec_interp <span class="main">(</span>length <span class="bound">I</span><span class="main">)</span> <span class="main">(</span>FOV <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> FQ<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> satisfies <span class="main">(</span><span class="var">?dec</span> <span class="free">w</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dec_word_enc 
    <span class="keyword1"><span class="command">using</span></span> dec_interp_enc_Inl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_mem <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dec_interp_not_Inr <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> nth_mem<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> FQ<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> FQ<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> satisfies <span class="main">(</span><span class="var">?dec</span> <span class="free">w'</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dec_word_enc enc_length<span class="main">[</span><span class="operator">OF</span> * FQ<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> dec_interp_enc_Inl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">I'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">w'</span></span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dec_interp_not_Inr <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> nth_mem<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> FQ<span class="main">(</span>1<span class="main">)</span> enc_length<span class="main">[</span><span class="operator">OF</span> * FQ<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">w</span> <span class="bound">I</span><span class="main">.</span> <span class="main">(</span>dec_word <span class="main">(</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> dec_interp <span class="main">(</span>length <span class="bound">I</span><span class="main">)</span> <span class="main">(</span>FOV <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> FLess<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> satisfies <span class="main">(</span><span class="var">?dec</span> <span class="main">(</span><span class="keyword1">TYPE</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dec_word_enc
    <span class="keyword1"><span class="command">using</span></span> dec_interp_enc_Inl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> dec_interp_enc_Inl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_mem <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dec_interp_not_Inr <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> FLess<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> FLess<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> satisfies <span class="main">(</span><span class="var">?dec</span> <span class="main">(</span><span class="keyword1">TYPE</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="free">w'</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dec_word_enc enc_length<span class="main">[</span><span class="operator">OF</span> * FLess<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> dec_interp_enc_Inl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">I'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">w'</span></span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> dec_interp_enc_Inl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">I'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">w'</span></span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_mem <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dec_interp_not_Inr <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> FLess<span class="main">(</span>1<span class="main">)</span> enc_length<span class="main">[</span><span class="operator">OF</span> * FLess<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">w</span> <span class="bound">I</span><span class="main">.</span> <span class="main">(</span>dec_word <span class="main">(</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> dec_interp <span class="main">(</span>length <span class="bound">I</span><span class="main">)</span> <span class="main">(</span>FOV <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> FIn<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> satisfies <span class="main">(</span><span class="var">?dec</span> <span class="main">(</span><span class="keyword1">TYPE</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dec_word_enc
    <span class="keyword1"><span class="command">using</span></span> dec_interp_enc_Inl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> dec_interp_enc_Inr<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">M</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dec_interp_not_Inr dec_interp_not_Inl <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> nth_mem<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> FIn<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> FIn<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> satisfies <span class="main">(</span><span class="var">?dec</span> <span class="main">(</span><span class="keyword1">TYPE</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="free">w'</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dec_word_enc enc_length<span class="main">[</span><span class="operator">OF</span> * FIn<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> dec_interp_enc_Inl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">I'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">w'</span></span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> dec_interp_enc_Inr<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">I'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">w'</span></span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="skolem">M</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dec_interp_not_Inr dec_interp_not_Inl <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> nth_mem<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> FIn<span class="main">(</span>1<span class="main">)</span> enc_length<span class="main">[</span><span class="operator">OF</span> * FIn<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FOr <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies.simps<span class="main">(</span>5<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> disj_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> FOr<span class="main">(</span>3-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ1</span> <span class="main">=</span> satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FOr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> FOr<span class="main">(</span>3-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ2</span> <span class="main">=</span> satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FOr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FAnd <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies.simps<span class="main">(</span>6<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conj_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> FAnd<span class="main">(</span>3-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ1</span> <span class="main">=</span> satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FAnd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> FAnd<span class="main">(</span>3-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ2</span> <span class="main">=</span> satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FAnd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">w</span> <span class="main">=</span> length <span class="free">w'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> length <span class="skolem">I'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> enc_word_length<span class="main">[</span><span class="operator">OF</span> FExists.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> enc_length<span class="main">[</span><span class="operator">OF</span> _ FExists.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> FExists.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ord_less_eq_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_imp_less_Suc Suc_pred<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> FExists.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FExists.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Inl <span class="skolem"><span class="skolem">p</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inl <span class="skolem"><span class="skolem">p</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> FExists.prems<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="free">w</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FExists<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> FExists.prems<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="free">w</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w'</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FExists<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I'</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">w'</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> enc_extend_interp <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> FExists.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="free">w'</span>"</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ord_less_eq_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_imp_less_Suc Suc_pred<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> FExists.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FExists.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Inl <span class="skolem"><span class="skolem">p</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inl <span class="skolem"><span class="skolem">p</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> FExists.prems<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="free">w'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> length<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FExists<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> FExists.prems<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="free">w'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w'</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FExists<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I'</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">w'</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> enc_extend_interp <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">w</span> <span class="main">=</span> length <span class="free">w'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> length <span class="skolem">I'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> enc_word_length<span class="main">[</span><span class="operator">OF</span> FEXISTS.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> enc_length<span class="main">[</span><span class="operator">OF</span> _ FEXISTS.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> length <span class="free">w</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> FEXISTS.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FEXISTS.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Inr <span class="skolem"><span class="skolem">P</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inr <span class="skolem"><span class="skolem">P</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> FEXISTS.prems<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> P<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FEXISTS<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> FEXISTS.prems<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> P<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w'</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FEXISTS<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I'</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">w'</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> enc_extend_interp <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">P</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> length <span class="free">w'</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w'</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> FEXISTS.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FEXISTS.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Inr <span class="skolem"><span class="skolem">P</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inr <span class="skolem"><span class="skolem">P</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> FEXISTS.prems<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> P<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> length<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FEXISTS<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> FEXISTS.prems<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> P<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w'</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FEXISTS<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I'</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">w'</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> enc_extend_interp <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">P</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-lang"><span class="command">lemma</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_FOr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FOr <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="main">(</span>FOr <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊆</span>
    <span class="main">(</span>lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span> <span class="bound">I</span><span class="main">.</span> length <span class="bound">I</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> wf_interp_for_formula <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">(</span>FOr <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⊆</span> <span class="main">(</span><span class="var">?L1</span> <span class="main">∪</span> <span class="var">?L2</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?ENC</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="main">(</span>FOr <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FOr <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">w</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
     <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∨</span> satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="var">?L1</span> <span class="main">∪</span> <span class="var">?L2</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?ENC</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span><span class="var">?L2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="M2L-lang"><span class="command">lemma</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_FAnd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FAnd <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="main">(</span>FAnd <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊆</span>
    lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> <span class="main">{</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span> <span class="bound">I</span><span class="main">.</span> length <span class="bound">I</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> wf_interp_for_formula <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">(</span>FAnd <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⊆</span> <span class="var">?L1</span> <span class="main">∩</span> <span class="var">?L2</span> <span class="main">∩</span> <span class="var">?ENC</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹From M2L to Regular expressions›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rexp_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> atom<span class="main">)</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span>TIMES <span class="main">[</span>Full<span class="main">,</span> Atom <span class="main">(</span>AQ <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">,</span> Full<span class="main">]</span><span class="main">)</span> <span class="main">(</span>ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="keyword1">then</span> Zero <span class="keyword1">else</span> Inter
    <span class="main">(</span>TIMES <span class="main">[</span>Full<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">m1</span></span></span> True<span class="main">)</span><span class="main">,</span> Full<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">m2</span></span></span> True<span class="main">)</span><span class="main">,</span> Full<span class="main">]</span><span class="main">)</span>
    <span class="main">(</span>ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> 
    Inter <span class="main">(</span>TIMES <span class="main">[</span>Full<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except2 <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">,</span> Full<span class="main">]</span><span class="main">)</span> <span class="main">(</span>ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span>rexp.Not <span class="main">(</span><span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span>Plus <span class="main">(</span><span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> INTERSECT <span class="main">[</span><span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Pr <span class="main">(</span><span class="free">rexp_of</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FEXISTS <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Pr <span class="main">(</span><span class="free">rexp_of</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rexp_of_alt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> atom<span class="main">)</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> TIMES <span class="main">[</span>Full<span class="main">,</span> Atom <span class="main">(</span>AQ <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">,</span> Full<span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="keyword1">then</span> Zero <span class="keyword1">else</span>
    TIMES <span class="main">[</span>Full<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">m1</span></span></span> True<span class="main">)</span><span class="main">,</span> Full<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">m2</span></span></span> True<span class="main">)</span><span class="main">,</span> Full<span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> TIMES <span class="main">[</span>Full<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except2 <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">,</span> Full<span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> rexp.Not <span class="main">(</span><span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span><span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Pr <span class="main">(</span>Inter <span class="main">(</span><span class="free">rexp_of_alt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FEXISTS <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Pr <span class="main">(</span>Inter <span class="main">(</span><span class="free">rexp_of_alt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> Inter <span class="main">(</span>rexp_of_alt <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rexp_of_alt'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> atom<span class="main">)</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> TIMES <span class="main">[</span>Full<span class="main">,</span> Atom <span class="main">(</span>AQ <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">,</span> Full<span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="keyword1">then</span> Zero <span class="keyword1">else</span>
    TIMES <span class="main">[</span>Full<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">m1</span></span></span> True<span class="main">)</span><span class="main">,</span> Full<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">m2</span></span></span> True<span class="main">)</span><span class="main">,</span> Full<span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> TIMES <span class="main">[</span>Full<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except2 <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">,</span> Full<span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> rexp.Not <span class="main">(</span><span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span><span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Pr <span class="main">(</span>Inter <span class="main">(</span><span class="free">rexp_of_alt'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FEXISTS <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Pr <span class="main">(</span><span class="free">rexp_of_alt'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of''</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> Inter <span class="main">(</span>rexp_of_alt' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">φ</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>rexp_of <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">=</span> <span class="var">?L</span> <span class="free">n</span> <span class="free">φ</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> FQ<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">!</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_set_conv_all_nth <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> take <span class="skolem">p</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>4<span class="main">)</span> FQ<span class="main">(</span>1<span class="main">)</span> p<span class="main">(</span>2<span class="main">)</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="skolem">a</span><span class="main">]</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>AQ <span class="skolem">m</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> enc_atom_lang_AQ<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Full<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_takeD<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Full<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_dropD<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps<span class="main">(</span>6<span class="main">,</span>9<span class="main">)</span> rexp_of_list.simps Int_Diff
        lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FQ<span class="main">,</span> <span class="operator">unfolded</span> FOV.simps<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ssubst <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply append.simps lang.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> FQ <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      wI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FQ<span class="main">,</span> <span class="operator">unfolded</span> FOV.simps<span class="main">]</span> Int_Diff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span>dec_word <span class="skolem">x</span><span class="main">,</span> dec_interp <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wI<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> enc_wf_interp<span class="main">[</span><span class="operator">OF</span> FQ<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> wI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u1</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">u2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>AQ <span class="skolem">m</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps rexp_of_list.simps <span class="keyword1"><span class="command">using</span></span> concE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> FQ<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u2</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">v</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> AQ_D<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">u1</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> length <span class="skolem">u1</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> m wI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_mem <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> m wI <span class="keyword1"><span class="command">have</span></span> ex1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wI<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> enc_unique<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> length <span class="skolem">u1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">!</span> length <span class="skolem">u1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wI<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">!</span> length <span class="skolem">u1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_map<span class="main">[</span><span class="operator">OF</span> u<span class="main">,</span> <span class="operator">of</span> <span class="quoted">fst</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> wI<span class="main">(</span>1<span class="main">)</span> v<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> * m wI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span>dec_word <span class="skolem">x</span><span class="main">,</span> dec_interp <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dec_word_enc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">I</span></span><span class="main">,</span> <span class="operator">folded</span> wI<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dec_interp_not_Inr <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
         <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dec_interp_enc_Inl <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_mem <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> wI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_word <span class="skolem">n</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wf_word <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">using</span></span> m wI<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"dec_word <span class="skolem">x</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"dec_interp <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> enc_dec<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ ballI<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">OF</span> impI<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator">OF</span> enc_unique<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span></span></span> <span class="operator">folded</span> wI<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">m'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span>
         <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> FLess<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> pq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> length <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m'</span> <span class="main">=</span> Inl <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_set_conv_all_nth <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> take <span class="skolem">p</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span>
        <span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">!</span> <span class="skolem">q</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?LHS</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> pq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> take <span class="skolem">p</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="var">?LHS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> FLess<span class="main">(</span>1<span class="main">)</span> pq<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">m</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> enc_atom_lang_Arbitrary_Except_True<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> FLess<span class="main">(</span>1<span class="main">)</span> pq<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">!</span> <span class="skolem">q</span><span class="main">)</span><span class="main">]</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">m'</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> enc_atom_lang_Arbitrary_Except_True<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Full<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_takeD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Full<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_dropD in_set_takeD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Full<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_dropD<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps<span class="main">(</span>6<span class="main">,</span>9<span class="main">)</span> rexp_of_list.simps Int_Diff
          lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FLess<span class="main">,</span> <span class="operator">unfolded</span> FOV.simps<span class="main">]</span> if_not_P<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ssubst <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply append.simps lang.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> FLess <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        wI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FLess<span class="main">,</span> <span class="operator">unfolded</span> FOV.simps<span class="main">]</span> Int_Diff
          if_not_P<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> FLess <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m'</span> <span class="main">=</span> Inl <span class="skolem">p'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">&lt;</span> length <span class="skolem">I</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> wI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span>dec_word <span class="skolem">x</span><span class="main">,</span> dec_interp <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">}</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wI<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> enc_wf_interp<span class="main">[</span><span class="operator">OF</span> FLess<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> wI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u1</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u2</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">u3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">u2</span> <span class="main">@</span> <span class="skolem">u'</span> <span class="main">@</span> <span class="skolem">u3</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">m</span> True<span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">m'</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps rexp_of_list.simps if_not_P<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> concE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">with</span></span> FLess<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">v'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u3</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">v</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">v'</span> <span class="main">!</span> <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Arbitrary_ExceptD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted">True</span><span class="main">]</span> Arbitrary_ExceptD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u'</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">m'</span></span> <span class="quoted">True</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">hence</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">u1</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="skolem">u1</span> <span class="main">+</span> length <span class="skolem">u2</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u'</span> <span class="main">&lt;</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> length <span class="skolem">u1</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> m wI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_mem <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> m wI <span class="keyword1"><span class="command">have</span></span> ex1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wI<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> enc_unique<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> length <span class="skolem">u1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="var">?u'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> m wI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_mem <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> m wI <span class="keyword1"><span class="command">have</span></span> ex1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wI<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> enc_unique<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="var">?u'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> length <span class="skolem">u1</span>›</span></span>
      <span class="keyword1"><span class="command">with</span></span> * m wI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span>dec_word <span class="skolem">x</span><span class="main">,</span> dec_interp <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">}</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> dec_word_enc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">I</span></span><span class="main">,</span> <span class="operator">folded</span> wI<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dec_interp_not_Inr <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
           <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dec_interp_enc_Inl <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_mem <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> wI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_word <span class="skolem">n</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wf_word <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">using</span></span> m wI<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"dec_word <span class="skolem">x</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"dec_interp <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">}</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> enc_dec<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ ballI<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">OF</span> impI<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator">OF</span> enc_unique<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span></span></span> <span class="operator">folded</span> wI<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> FIn<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">M</span> <span class="main">=</span> Inr <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_set_conv_all_nth <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> take <span class="skolem">p</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> FIn<span class="main">(</span>1<span class="main">)</span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except2 <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> enc_atom_lang_Arbitrary_Except2<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Full<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_takeD<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Full<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_dropD<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps<span class="main">(</span>6<span class="main">,</span>9<span class="main">)</span> rexp_of_list.simps Int_Diff
        lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FIn<span class="main">,</span> <span class="operator">unfolded</span> FOV.simps<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ssubst <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply append.simps lang.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> FIn <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span>  wI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FIn<span class="main">,</span> <span class="operator">unfolded</span> FOV.simps<span class="main">]</span> Int_Diff
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> FIn <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">M</span> <span class="main">=</span> Inr <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">&lt;</span> length <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> wI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span>dec_word <span class="skolem">x</span><span class="main">,</span> dec_interp <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wI<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> enc_wf_interp<span class="main">[</span><span class="operator">OF</span> FIn<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> wI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u1</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">u2</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except2 <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps rexp_of_list.simps <span class="keyword1"><span class="command">using</span></span> concE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> FIn<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u2</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">v</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">v</span> <span class="main">!</span> <span class="skolem">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Arbitrary_Except2D<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">M</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">u1</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> length <span class="skolem">u1</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> m wI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_mem <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> m wI <span class="keyword1"><span class="command">have</span></span> ex1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wI<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> enc_unique<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> length <span class="skolem">u1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">!</span> length <span class="skolem">u1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wI<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> v<span class="main">(</span>3<span class="main">)</span> m<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> u wI<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">u1</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> * m wI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span>dec_word <span class="skolem">x</span><span class="main">,</span> dec_interp <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dec_word_enc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">I</span></span><span class="main">,</span> <span class="operator">folded</span> wI<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dec_interp_not_Inr dec_interp_not_Inl <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dec_interp_enc_Inl dec_interp_enc_Inr <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nth_mem <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> wI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_word <span class="skolem">n</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wf_word <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">using</span></span> m wI<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"dec_word <span class="skolem">x</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"dec_interp <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> enc_dec<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ ballI<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">OF</span> impI<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator">OF</span> enc_unique<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span></span></span> <span class="operator">folded</span> wI<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FOr<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FOr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> FOr<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FOr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_FOr<span class="main">[</span><span class="operator">OF</span> FOr<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FOr<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> rexp_of.simps lang.simps
        IH1 IH2 Int_Diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> or<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FOr<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> rexp_of.simps lang.simps IH1 IH2 Int_Diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∨</span> satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disj_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> impI impI<span class="main"><span class="main">]</span></span> or<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> wI<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> FOr<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def wI<span class="main">(</span>1<span class="main">)</span> wf_interp_for_formula_FOr
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> enc_welldef<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> wI<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> FOr<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def wI<span class="main">(</span>1<span class="main">)</span> wf_interp_for_formula_FOr
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> enc_welldef<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> wI <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FAnd<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FAnd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> FAnd<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FAnd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_FAnd<span class="main">[</span><span class="operator">OF</span> FAnd<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FAnd<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> rexp_of.simps
        rexp_of_list.simps lang.simps IH1 IH2 Int_Diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted">"and"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FAnd<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> rexp_of.simps rexp_of_list.simps lang.simps IH1 IH2
        Int_Diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> conj_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> impI impI<span class="main"><span class="main">]</span></span> <span class="quoted">"and"</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> wI<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> FAnd<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def wI<span class="main">(</span>1<span class="main">)</span> wf_interp_for_formula_FAnd
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> enc_welldef<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> wI<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> FAnd<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def wI<span class="main">(</span>1<span class="main">)</span> wf_interp_for_formula_FAnd
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> enc_welldef<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> wI <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="skolem">n</span> <span class="skolem">φ</span> <span class="main">=</span>  lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">w</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> enc_welldef<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ _ *<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> FNot<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> *<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> unsat <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps
      <span class="keyword1"><span class="command">using</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FNot<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>ENC <span class="skolem">n</span> <span class="main">(</span>FOV <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FNot<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> x * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">w</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> length <span class="skolem">w</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> FExists<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?L</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> equalityD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FExists<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"enc <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">w</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> Inl <span class="skolem"><span class="skolem"><span class="skolem">p</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">I</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def nth_Cons' ord_less_eq_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_imp_less_Suc Suc_pred<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> *<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm sum.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_index <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"map π"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> π_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> map π <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="var">?L</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> FExists<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> equalityD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FExists<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I'</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I'</span> <span class="main">=</span> <span class="skolem">I<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">I'</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> FExists<span class="main">(</span>2<span class="main">)</span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="quoted"><span class="quoted">"length <span class="skolem">w</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FExists<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_tl nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> π_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">w</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> length <span class="skolem">w</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>2-4<span class="main">,</span>6<span class="main">)</span> FEXISTS<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?L</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> equalityD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FEXISTS<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"enc <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">w</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> Inr <span class="skolem"><span class="skolem"><span class="skolem">P</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">I</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm sum.splits
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_index <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"map π"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> π_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> map π <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">x'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="var">?L</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> FEXISTS<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> equalityD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FEXISTS<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I'</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I'</span> <span class="main">=</span> <span class="skolem">I<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">I'</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> FEXISTS<span class="main">(</span>2<span class="main">)</span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> Inr <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">w</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x' *<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="quoted"><span class="quoted">"length <span class="skolem">w</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FEXISTS<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_tl nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">P</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> π_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="skolem">n</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="M2L-wf_rexp_of"><span class="command">lemma</span></span> wf_rexp_of<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>rexp_of <span class="free">n</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_rexp_ENC <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_FOV max_idx_vars<span class="main">)</span>

<span class="keyword1" id="M2L-wf_rexp_of_alt"><span class="command">lemma</span></span> wf_rexp_of_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>rexp_of_alt <span class="free">n</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_rexp_ENC finite_FOV max_idx_vars<span class="main">)</span>

<span class="keyword1" id="M2L-wf_rexp_of'"><span class="command">lemma</span></span> wf_rexp_of'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>rexp_of' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rexp_of'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_rexp_ENC wf_rexp_of_alt finite_FOV max_idx_vars<span class="main">)</span>

<span class="keyword1" id="M2L-wf_rexp_of_alt'"><span class="command">lemma</span></span> wf_rexp_of_alt'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>rexp_of_alt' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_rexp_ENC<span class="main">)</span>

<span class="keyword1" id="M2L-wf_rexp_of''"><span class="command">lemma</span></span> wf_rexp_of''<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>rexp_of'' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rexp_of''_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_rexp_ENC wf_rexp_of_alt' finite_FOV max_idx_vars<span class="main">)</span>

<span class="keyword1" id="M2L-ENC_Not"><span class="command">lemma</span></span> ENC_Not<span class="main">:</span> <span class="quoted"><span class="quoted">"ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FNot <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ENC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-ENC_And"><span class="command">lemma</span></span> ENC_And<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FAnd <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FAnd <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">⊆</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FAnd <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FAnd <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> wI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FAnd <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_interp_for_formula_FAnd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf2<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> wI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="M2L-ENC_Or"><span class="command">lemma</span></span> ENC_Or<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">⊆</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> wI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_interp_for_formula_FOr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf2<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> wI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="M2L-project_enc"><span class="command">lemma</span></span> project_enc<span class="main">:</span> <span class="quoted"><span class="quoted">"map π <span class="main">(</span>enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> π_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-list_list_eqI"><span class="command">lemma</span></span> list_list_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> hd <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> hd <span class="bound">x</span><span class="main">)</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"map π <span class="free">xs</span> <span class="main">=</span> map π <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> π_def neq_Nil_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="M2L-project_enc_extend"><span class="command">lemma</span></span> project_enc_extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map π <span class="free">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inr <span class="main">(</span>positions_in_row <span class="free">x</span> <span class="main">0</span><span class="main">)</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"map fst"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> map fst <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> π_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list_list_eqI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> project_enc<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> hd <span class="bound">x</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> hd <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inr <span class="main">(</span>positions_in_row <span class="free">x</span> <span class="main">0</span><span class="main">)</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> enc.simps map_index positions_in_row w
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_mem <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="M2L-ENC_Exists"><span class="command">lemma</span></span> ENC_Exists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> map π <span class="main">`</span> lang <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> wI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> wI<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_interp_for_formula_FExists<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">[</span></span><span class="operator">folded</span> wI<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> wI<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> map π <span class="main">`</span> <span class="main">(</span>lang <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wI<span class="main">(</span>1<span class="main">)</span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> project_enc<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="quoted">"Inl <span class="skolem">p</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> imageI CollectI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Inl <span class="skolem"><span class="skolem"><span class="skolem">p</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">I</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> map π <span class="main">`</span> lang <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> map π <span class="main">`</span> lang <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> FOV <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> map π <span class="main">`</span> <span class="main">(</span>lang <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> wI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> map π <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">∈</span> FOV <span class="free">φ</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">I'</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">I</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> wI <span class="keyword1"><span class="command">have</span></span> wtlI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I'</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> π_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_interp_for_formula_FExists<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">[</span></span><span class="operator">folded</span> wtlI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main">]</span>
          wf_interp_for_formula_any_Inl<span class="main">[</span><span class="operator">OF</span> wI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> I<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> wtlI <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="M2L-ENC_EXISTS"><span class="command">lemma</span></span> ENC_EXISTS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> map π <span class="main">`</span> lang <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> wI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> wI<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_interp_for_formula_FEXISTS<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">[</span></span><span class="operator">folded</span> wI<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> wI<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> map π <span class="main">`</span> <span class="main">(</span>lang <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wI<span class="main">(</span>1<span class="main">)</span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> project_enc<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="quoted">"Inr <span class="skolem">P</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> imageI CollectI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Inr <span class="skolem"><span class="skolem"><span class="skolem">P</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">I</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> map π <span class="main">`</span> lang <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> map π <span class="main">`</span> lang <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> SOV <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> map π <span class="main">`</span> <span class="main">(</span>lang <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> wI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> map π <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">∈</span> SOV <span class="free">φ</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">I'</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">I</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> wI <span class="keyword1"><span class="command">have</span></span> wtlI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I'</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> π_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_interp_for_formula_FEXISTS<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">[</span></span><span class="operator">folded</span> wtlI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main">]</span>
          wf_interp_for_formula_any_Inr<span class="main">[</span><span class="operator">OF</span> wI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> I<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> wtlI <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="M2L-map_project_empty"><span class="command">lemma</span></span> map_project_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"map π <span class="main">`</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> map π <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-lang"><span class="command">lemma</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of_rexp_of'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>rexp_of <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>rexp_of' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rexp_of'_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> FNot.IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps rexp_of_alt.simps lang.simps ENC_Not <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> FAnd.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> FAnd.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ENC_And<span class="main">[</span><span class="operator">OF</span> FAnd.prems<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps rexp_of_alt.simps lang.simps rexp_of_list.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> FOr.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> FOr.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ENC_Or<span class="main">[</span><span class="operator">OF</span> FOr.prems<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps rexp_of_alt.simps lang.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ENC_Exists<span class="main">[</span><span class="operator">OF</span> FExists.prems<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps rexp_of_alt.simps lang.simps map_project_empty FExists.IH<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ENC_EXISTS<span class="main">[</span><span class="operator">OF</span> FEXISTS.prems<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps rexp_of_alt.simps lang.simps map_project_empty FEXISTS.IH<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-Int_Diff_both"><span class="command">lemma</span></span> Int_Diff_both<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">-</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-lang_ENC_split"><span class="command">lemma</span></span> lang_ENC_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">Y1</span> <span class="main">∪</span> <span class="free">Y2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="free">Y1</span><span class="main">)</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="free">Y2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ENC_def lang_INTERSECT <span class="keyword1"><span class="command">using</span></span> assms lang_subset_lists<span class="main">[</span><span class="operator">OF</span> wf_rexp_valid_ENC<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="M2L-map_project_Int_ENC"><span class="command">lemma</span></span> map_project_Int_ENC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">⊆</span> lists <span class="main">(</span><span class="main">(</span>set <span class="keyword1">o</span> σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map π <span class="main">`</span> <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> lang <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    map π <span class="main">`</span> <span class="free">Z</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span> <span class="main">-</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fX</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fY</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Int_Diff lang_ENC<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subset_refl<span class="main">]</span> lang_ENC<span class="main">[</span><span class="operator">OF</span> * subset_refl<span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">I</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="keyword1">case</span> <span class="skolem">I</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> True <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> False"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="var">?Y</span><span class="main">.</span> <span class="keyword1">case</span> <span class="skolem">I</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> False <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> True"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="skolem">w</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>case_sum <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">Is</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">Is</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">I</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w'</span> <span class="bound">I'</span><span class="main">.</span>
      map π <span class="main">(</span>enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> enc <span class="main">(</span><span class="bound">w'</span><span class="main">,</span> <span class="bound">I'</span><span class="main">)</span> <span class="main">∧</span>
      length <span class="bound">I'</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> length <span class="bound">w'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="bound">w'</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">Σ</span><span class="main">)</span> <span class="main">∧</span>
      Ball <span class="main">(</span>set <span class="bound">I'</span><span class="main">)</span> <span class="main">(</span>case_sum <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="bound">w'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="bound">w'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="var">?fX</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">I'</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> True <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> False<span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="var">?fY</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">I'</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> False <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">hypsubst</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Is</span></span></span></span><span class="main"><span class="main">]</span></span> conjI ballI project_enc<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="var">?fY</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">Is</span> <span class="main">!</span> <span class="skolem">i</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> False <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> True"</span></span>
        <span class="keyword1"><span class="command">using</span></span> *<span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">I</span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">p</span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">#</span></span></span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">Is</span></span></span></span></span></span>›</span></span></span></span></span></span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' image_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> *<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">I</span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">p</span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">#</span></span></span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">Is</span></span></span></span></span></span>›</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">w</span> <span class="skolem">I</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">Z</span>"</span></span> <span class="quoted"><span class="quoted">"map π <span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="var">?fX</span><span class="main">.</span> <span class="keyword1">case</span> <span class="skolem">I</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> True <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> False"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="skolem">I</span><span class="main">}</span> <span class="main">-</span> <span class="var">?fX</span><span class="main">.</span> <span class="keyword1">case</span> <span class="skolem">I</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> False <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> True"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="skolem">w</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>case_sum <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">⟷</span> 
      <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> neq0_conv<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_diff_1 diff_0_eq_0 diff_self_eq_0 neq0_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inr <span class="main">(</span>positions_in_row <span class="skolem">x</span> <span class="main">0</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> project_enc_extend <span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> σ_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">length</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">w</span> <span class="main">=</span> length <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" map π <span class="skolem">x</span> <span class="main">∈</span> map π <span class="main">`</span>
      <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> <span class="main">{</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I'</span><span class="main">)</span> <span class="main">|</span><span class="bound">w</span> <span class="bound">I'</span><span class="main">.</span> length <span class="bound">I'</span> <span class="main">=</span> length <span class="skolem">I</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> length <span class="bound">w</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="bound">w</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">Σ</span><span class="main">)</span> <span class="main">∧</span>
         Ball <span class="main">(</span>set <span class="bound">I'</span><span class="main">)</span> <span class="main">(</span>case_sum <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="bound">w</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">I'</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> True <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> False<span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">I</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span> <span class="main">-</span> <span class="free">X</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">I'</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> False <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> imageI CollectI conjI IntI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Inr <span class="main"><span class="main"><span class="main">(</span></span></span>positions_in_row <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span> <span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">I</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' positions_in_row <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bspec <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="M2L-map_project_ENC"><span class="command">lemma</span></span> map_project_ENC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">⊆</span> lists <span class="main">(</span><span class="main">(</span>set <span class="keyword1">o</span> σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map π <span class="main">`</span> <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> lang <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">X</span>
    <span class="keyword1">then</span> map π <span class="main">`</span> <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> lang <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>
    <span class="keyword1">else</span> map π <span class="main">`</span> <span class="free">Z</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">_</span> <span class="keyword1">then</span> <span class="var">?R1</span> <span class="keyword1">else</span> <span class="var">?R2</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">split</span> if_splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> finite_subset <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">X</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> map_project_Int_ENC<span class="main">[</span><span class="operator">OF</span> 0 assms<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> lists_image<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> π_σ
      Int_absorb1<span class="main">[</span><span class="operator">OF</span> lang_subset_lists<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_rexp_ENC<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span>
      Int_absorb1<span class="main">[</span><span class="operator">OF</span> lang_subset_lists<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_rexp_ENC<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> finite_subset <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">X</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> map π <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> lang <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> lang <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Int_assoc <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lang_ENC_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin X<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?R1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> map_project_Int_ENC<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔏</span> <span class="main">≡</span> project.lang <span class="main">(</span>set <span class="main">∘</span> σ <span class="free">Σ</span><span class="main">)</span> π"</span></span>

<span class="keyword1" id="M2L-lang"><span class="command">lemma</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of'_rexp_of''<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>rexp_of' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>rexp_of'' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rexp_of'_def rexp_of''_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> FNot.IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rexp_of_alt.simps rexp_of_alt'.simps lang.simps ENC_Not <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> FAnd.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> FAnd.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ENC_And<span class="main">[</span><span class="operator">OF</span> FAnd.prems<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rexp_of_alt.simps rexp_of_alt'.simps lang.simps rexp_of_list.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> FOr.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> FOr.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ENC_Or<span class="main">[</span><span class="operator">OF</span> FOr.prems<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rexp_of_alt.simps rexp_of_alt'.simps lang.simps rexp_of_list.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> FOV <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ENC_Exists<span class="main">[</span><span class="operator">OF</span> FExists.prems<span class="main">]</span> map_project_ENC<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"FOV <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> max_idx_vars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">]</span>
      wf_rexp_of_alt'<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> 0
    <span class="keyword1"><span class="command">unfolding</span></span> rexp_of_alt.simps rexp_of_alt'.simps lang.simps Int_Diff_both
    <span class="keyword1"><span class="command">unfolding</span></span> map_project_empty FExists.IH<span class="main">[</span><span class="operator">OF</span> wf<span class="main">,</span> <span class="operator">unfolded</span> lang.simps<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> arg_cong2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(∩)</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> map_project_ENC<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ lang_subset_lists<span class="main"><span class="main"><span class="main">]</span></span></span> refl<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> FOV <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ENC_EXISTS<span class="main">[</span><span class="operator">OF</span> FEXISTS.prems<span class="main">]</span> map_project_ENC<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"FOV <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> max_idx_vars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">]</span>
      wf_rexp_of_alt'<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> 0
    <span class="keyword1"><span class="command">unfolding</span></span> rexp_of_alt.simps rexp_of_alt'.simps lang.simps Int_Diff_both
    <span class="keyword1"><span class="command">unfolding</span></span> map_project_empty FEXISTS.IH<span class="main">[</span><span class="operator">OF</span> wf<span class="main">,</span> <span class="operator">unfolded</span> lang.simps<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> arg_cong2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(∩)</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> map_project_ENC<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ lang_subset_lists<span class="main"><span class="main"><span class="main">]</span></span></span> refl<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">theorem</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">φ</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>rexp_of' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of_rexp_of'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of''<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">φ</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>rexp_of'' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of'_rexp_of''<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of'<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="M2L_Normalization">
<div class="head">
<h1>Theory M2L_Normalization</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Normalization of M2L Formulas›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> M2L_Normalization
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#M2L">M2L</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nNot</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nNot</span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nNot</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ1</span></span></span> <span class="free"><span class="bound"><span class="entity">φ2</span></span></span><span class="main">)</span> <span class="main">=</span> FOr <span class="main">(</span><span class="free">nNot</span> <span class="free"><span class="bound"><span class="entity">φ1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nNot</span> <span class="free"><span class="bound"><span class="entity">φ2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nNot</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ1</span></span></span> <span class="free"><span class="bound"><span class="entity">φ2</span></span></span><span class="main">)</span> <span class="main">=</span> FAnd <span class="main">(</span><span class="free">nNot</span> <span class="free"><span class="bound"><span class="entity">φ1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nNot</span> <span class="free"><span class="bound"><span class="entity">φ2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nNot</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">norm</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> FLess <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> FOr <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> FAnd <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> nNot <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FExists <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FEXISTS <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FEXISTS <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> formula
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="M2L_Normalization-satisfies_nNot"><span class="command">lemma</span></span> satisfies_nNot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>nNot <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span><span class="free">I</span><span class="main">)</span> <span class="main">(</span>FNot <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nNot.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="M2L_Normalization-FOV_nNot"><span class="command">lemma</span></span> FOV_nNot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"FOV <span class="main">(</span>nNot <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> FOV <span class="main">(</span>FNot <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nNot.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="M2L_Normalization-SOV_nNot"><span class="command">lemma</span></span> SOV_nNot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"SOV <span class="main">(</span>nNot <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> SOV <span class="main">(</span>FNot <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nNot.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="M2L_Normalization-pre_wf_formula_nNot"><span class="command">lemma</span></span> pre_wf_formula_nNot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pre_wf_formula <span class="free">n</span> <span class="main">(</span>nNot <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> pre_wf_formula <span class="free">n</span> <span class="main">(</span>FNot <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nNot.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="M2L_Normalization-FOV_norm"><span class="command">lemma</span></span> FOV_norm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"FOV <span class="main">(</span>norm <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> FOV <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="M2L_Normalization-SOV_norm"><span class="command">lemma</span></span> SOV_norm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"SOV <span class="main">(</span>norm <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> SOV <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="M2L_Normalization-pre_wf_formula_norm"><span class="command">lemma</span></span> pre_wf_formula_norm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pre_wf_formula <span class="free">n</span> <span class="main">(</span>norm <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> pre_wf_formula <span class="free">n</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="M2L_Normalization-satisfies_norm"><span class="command">lemma</span></span> satisfies_norm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>norm <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> satisfies <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="M2L_Normalization-lang"><span class="command">lemma</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_norm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="main">(</span>norm <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="M2L_Equivalence_Checking">
<div class="head">
<h1>Theory M2L_Equivalence_Checking</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deciding Equivalence of M2L Formulas›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> M2L_Equivalence_Checking
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Pi_Equivalence_Checking">Pi_Equivalence_Checking</a>
  <a href="#PNormalization">PNormalization</a>
  <a href="#Init_Normalization">Init_Normalization</a>
  <a href="#M2L_Normalization">M2L_Normalization</a>
  <a href="#Pi_Regular_Exp_Dual">Pi_Regular_Exp_Dual</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> embed <span class="quoted"><span class="quoted">"set <span class="keyword1">o</span> σ <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_atom <span class="free">Σ</span>"</span></span> <span class="quoted">π</span> <span class="quoted">lookup</span> <span class="quoted"><span class="quoted">"ε <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder list"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span>
      𝔇 <span class="main">=</span> <span class="quoted"><span class="quoted">"embed.lderiv lookup <span class="main">(</span>ε <span class="free">Σ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Co𝔇 <span class="main">=</span> <span class="quoted"><span class="quoted">"embed.lderiv_dual lookup <span class="main">(</span>ε <span class="free">Σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def π_def ε_def set_n_lists<span class="main">)</span>

<span class="keyword1" id="M2L_Equivalence_Checking-enum_not_empty"><span class="command">lemma</span></span> enum_not_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Enum.enum <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?enum</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?enum</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?enum</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> UNIV_enum<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Φ<span class="main">:</span> formula <span class="quoted"><span class="quoted">"Enum.enum <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>enum<span class="main">,</span> linorder<span class="main">}</span> list"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span>
      pre_wf_formula <span class="main">=</span> <span class="quoted">Φ.pre_wf_formula</span>
  <span class="keyword2"><span class="keyword">and</span></span> wf_formula <span class="main">=</span> <span class="quoted">Φ.wf_formula</span>
  <span class="keyword2"><span class="keyword">and</span></span> rexp_of <span class="main">=</span> <span class="quoted">Φ.rexp_of</span>
  <span class="keyword2"><span class="keyword">and</span></span> rexp_of_alt <span class="main">=</span> <span class="quoted">Φ.rexp_of_alt</span>
  <span class="keyword2"><span class="keyword">and</span></span> rexp_of_alt' <span class="main">=</span> <span class="quoted">Φ.rexp_of_alt'</span>
  <span class="keyword2"><span class="keyword">and</span></span> rexp_of' <span class="main">=</span> <span class="quoted">Φ.rexp_of'</span>
  <span class="keyword2"><span class="keyword">and</span></span> rexp_of'' <span class="main">=</span> <span class="quoted">Φ.rexp_of''</span>
  <span class="keyword2"><span class="keyword">and</span></span> valid_ENC <span class="main">=</span> <span class="quoted">Φ.valid_ENC</span>
  <span class="keyword2"><span class="keyword">and</span></span> ENC <span class="main">=</span> <span class="quoted">Φ.ENC</span>
  <span class="keyword2"><span class="keyword">and</span></span> dec_interp <span class="main">=</span> <span class="quoted">Φ.dec_interp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def π_def set_n_lists<span class="main">)</span>

<span class="keyword1" id="M2L_Equivalence_Checking-lang_Plus_Zero"><span class="command">lemma</span></span> lang_Plus_Zero<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="free">Σ</span> <span class="free">n</span> <span class="main">(</span>Plus <span class="free">r</span> One<span class="main">)</span> <span class="main">=</span> lang <span class="free">Σ</span> <span class="free">n</span> <span class="main">(</span>Plus <span class="free">s</span> One<span class="main">)</span> <span class="main">⟷</span> lang <span class="free">Σ</span> <span class="free">n</span> <span class="free">r</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="main">=</span> lang <span class="free">Σ</span> <span class="free">n</span> <span class="free">s</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of_norm <span class="main">=</span> trans<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Φ.lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_norm<span class="main"><span class="main">]</span></span> Φ.lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of'_norm <span class="main">=</span> trans<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Φ.lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_norm<span class="main"><span class="main">]</span></span> Φ.lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of'<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of''_norm <span class="main">=</span> trans<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Φ.lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_norm<span class="main"><span class="main">]</span></span> Φ.lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of''<span class="main">]</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Sign.map_naming <span class="main">(</span>Name_Space.mandatory_path <span class="inner_quoted">"slow"</span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> D<span class="main">:</span> rexp_DFA <span class="quoted"><span class="quoted">"σ <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_atom <span class="free">Σ</span>"</span></span> <span class="quoted">π</span> <span class="quoted">lookup</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">«</span>pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">»</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span>"</span></span> <span class="quoted">final</span> <span class="quoted"><span class="quoted">"alphabet.wf <span class="main">(</span>wf_atom <span class="free">Σ</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="quoted">pnorm</span> <span class="quoted"><span class="quoted">"lang <span class="free">Σ</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="free">n</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span>
      test <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.test <span class="main">(</span>final <span class="main">::</span> <span class="tfree">'a</span> atom rexp <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.step <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> pnorm <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> closure <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.closure <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> final pnorm <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> check_eqvRE <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.check_eqv <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">«</span>pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">»</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> final pnorm <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> test_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.test_invariant <span class="main">(</span>final <span class="main">::</span> <span class="tfree">'a</span> atom rexp <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">::</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool list<span class="main">)</span> list <span class="main">×</span> <span class="main">_</span><span class="main">)</span> list <span class="main">×</span> <span class="main">_</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.step_invariant <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> pnorm <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> closure_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.closure_invariant <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> final pnorm <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> counterexampleRE <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.counterexample <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">«</span>pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">»</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> final pnorm <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.reachable <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">«</span>pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">»</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> pnorm <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> automaton <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.automaton <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">«</span>pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">»</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> pnorm <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> comp_apply
    ACI_norm_wf ACI_norm_lang wf_inorm lang_inorm wf_pnorm lang_pnorm wf_lderiv lang_lderiv
    lang_final finite_fold_lderiv <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lang_subset_lists<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_eqv</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">check_eqv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">⟷</span> wf_formula <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">∧</span>
   slow.check_eqvRE Enum.enum <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Plus <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> One<span class="main">)</span> <span class="main">(</span>Plus <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> One<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">counterexample</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">counterexample</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span>
   map_option <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> dec_interp <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">w</span><span class="main">)</span>
   <span class="main">(</span>slow.counterexampleRE Enum.enum <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Plus <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> One<span class="main">)</span> <span class="main">(</span>Plus <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> One<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="M2L_Equivalence_Checking-soundness"><span class="command">lemma</span></span> soundness<span class="main">:</span> <span class="quoted"><span class="quoted">"slow.check_eqv <span class="free">n</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="main">⟹</span> Φ.lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">φ</span> <span class="main">=</span> Φ.lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iffD1<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> lang_Plus_Zero<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> slow.D.check_eqv_sound<span class="main"><span class="main"><span class="main">]</span></span></span>
  sym<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> trans<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of''_norm<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> sym<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> trans<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of''_norm<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> slow.check_eqv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Φ.wf_rexp_of''<span class="main">)</span>

<span class="keyword1" id="M2L_Equivalence_Checking-completeness"><span class="command">lemma</span></span> completeness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Φ.lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">φ</span> <span class="main">=</span> Φ.lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"slow.check_eqv <span class="free">n</span> <span class="free">φ</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> slow.check_eqv_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> slow.D.check_eqv_complete<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lang_Plus_Zero<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span>
                <span class="operator">OF</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of''_norm lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of''_norm<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Φ.wf_rexp_of''<span class="main">)</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Sign.map_naming Name_Space.parent_path›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Sign.map_naming <span class="main">(</span>Name_Space.mandatory_path <span class="inner_quoted">"fast"</span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> D<span class="main">:</span> rexp_DA_no_post <span class="quoted"><span class="quoted">"σ <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_atom <span class="free">Σ</span>"</span></span> <span class="quoted">π</span> <span class="quoted">lookup</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="quoted">final</span> <span class="quoted"><span class="quoted">"alphabet.wf <span class="main">(</span>wf_atom <span class="free">Σ</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">Σ</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="free">n</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span>
      test <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.test <span class="main">(</span>final <span class="main">::</span> <span class="tfree">'a</span> atom rexp <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.step <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> closure <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.closure <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> check_eqvRE <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.check_eqv <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> test_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.test_invariant <span class="main">(</span>final <span class="main">::</span> <span class="tfree">'a</span> atom rexp <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">::</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool list<span class="main">)</span> list <span class="main">×</span> <span class="main">_</span><span class="main">)</span> list <span class="main">×</span> <span class="main">_</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.step_invariant <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> closure_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.closure_invariant <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> counterexampleRE <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.counterexample <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.reachable <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> automaton <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.automaton <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> comp_apply
    ACI_norm_wf ACI_norm_lang wf_inorm lang_inorm wf_pnorm lang_pnorm wf_lderiv lang_lderiv id_apply
    lang_final <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lang_subset_lists<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_eqv</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">check_eqv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">⟷</span> wf_formula <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">∧</span>
   fast.check_eqvRE Enum.enum <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Plus <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> One<span class="main">)</span> <span class="main">(</span>Plus <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> One<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">counterexample</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">counterexample</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span>
   map_option <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> dec_interp <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">w</span><span class="main">)</span>
   <span class="main">(</span>fast.counterexampleRE Enum.enum <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Plus <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> One<span class="main">)</span> <span class="main">(</span>Plus <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> One<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="M2L_Equivalence_Checking-soundness"><span class="command">lemma</span></span> soundness<span class="main">:</span> <span class="quoted"><span class="quoted">"fast.check_eqv <span class="free">n</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="main">⟹</span> Φ.lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">φ</span> <span class="main">=</span> Φ.lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iffD1<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> lang_Plus_Zero<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> fast.D.check_eqv_sound<span class="main"><span class="main"><span class="main">]</span></span></span>
  sym<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> trans<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of''_norm<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> sym<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> trans<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of''_norm<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fast.check_eqv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Φ.wf_rexp_of''<span class="main">)</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Sign.map_naming Name_Space.parent_path›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Sign.map_naming <span class="main">(</span>Name_Space.mandatory_path <span class="inner_quoted">"dual"</span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> D<span class="main">:</span> rexp_DA_no_post <span class="quoted"><span class="quoted">"σ <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_atom <span class="free">Σ</span>"</span></span> <span class="quoted">π</span> <span class="quoted">lookup</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm_dual <span class="main">(</span>rexp_dual_of <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="quoted">final_dual</span>
  <span class="quoted"><span class="quoted">"alphabet.wf_dual <span class="main">(</span>wf_atom <span class="free">Σ</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"lang_dual <span class="free">Σ</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="free">n</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span>
      test <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.test <span class="main">(</span>final_dual <span class="main">::</span> <span class="tfree">'a</span> atom rexp_dual <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.step <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> closure <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.closure <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final_dual id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> check_eqvRE <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.check_eqv <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm_dual <span class="main">(</span>rexp_dual_of <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final_dual id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> test_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.test_invariant <span class="main">(</span>final_dual <span class="main">::</span> <span class="tfree">'a</span> atom rexp_dual <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">::</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool list<span class="main">)</span> list <span class="main">×</span> <span class="main">_</span><span class="main">)</span> list <span class="main">×</span> <span class="main">_</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.step_invariant <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> closure_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.closure_invariant <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final_dual id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> counterexampleRE <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.counterexample <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm_dual <span class="main">(</span>rexp_dual_of <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final_dual id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.reachable <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm_dual <span class="main">(</span>rexp_dual_of <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> automaton <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.automaton <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm_dual <span class="main">(</span>rexp_dual_of <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> comp_apply id_apply
    wf_inorm lang_inorm
    wf_dual_pnorm_dual lang_dual_pnorm_dual
    wf_dual_rexp_dual_of lang_dual_rexp_dual_of
    wf_dual_lderiv_dual lang_dual_lderiv_dual
    lang_dual_final_dual <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lang_dual_subset_lists<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_eqv</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">check_eqv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">⟷</span> wf_formula <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">∧</span>
   dual.check_eqvRE Enum.enum <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Plus <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> One<span class="main">)</span> <span class="main">(</span>Plus <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> One<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">counterexample</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">counterexample</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span>
   map_option <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> dec_interp <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">w</span><span class="main">)</span>
   <span class="main">(</span>dual.counterexampleRE Enum.enum <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Plus <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> One<span class="main">)</span> <span class="main">(</span>Plus <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> One<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="M2L_Equivalence_Checking-soundness"><span class="command">lemma</span></span> soundness<span class="main">:</span> <span class="quoted"><span class="quoted">"dual.check_eqv <span class="free">n</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="main">⟹</span> Φ.lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">φ</span> <span class="main">=</span> Φ.lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub> <span class="free">n</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iffD1<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> lang_Plus_Zero<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> dual.D.check_eqv_sound<span class="main"><span class="main"><span class="main">]</span></span></span>
  sym<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> trans<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of''_norm<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> sym<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> trans<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of''_norm<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dual.check_eqv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Φ.wf_rexp_of''<span class="main">)</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Sign.map_naming Name_Space.parent_path›</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="WS1S">
<div class="head">
<h1>Theory WS1S</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹WS1S›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> WS1S
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Formula">Formula</a> <a href="#Pi_Regular_Operators">Pi_Regular_Operators</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Stream.html">HOL-Library.Stream</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Encodings›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cut_same</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> stake <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> sdrop <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> sconst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">poss</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="bound">P</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> smap_sconst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wellorder<span class="main">)</span> min_Least<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span><span class="main">;</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">n</span><span class="main">⟧</span> <span class="main">⟹</span> min <span class="main">(</span>Least <span class="free">P</span><span class="main">)</span> <span class="main">(</span>Least <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="main">∨</span> <span class="free">Q</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Least_equality<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="free">Q</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>Least <span class="free">P</span><span class="main">)</span> <span class="main">(</span>Least <span class="free">Q</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Least <span class="free">P</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LeastI2_wellorder<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>Least <span class="free">P</span><span class="main">)</span> <span class="main">(</span>Least <span class="free">Q</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> min_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Least <span class="free">Q</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LeastI2_wellorder<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>Least <span class="free">P</span><span class="main">)</span> <span class="main">(</span>Least <span class="free">Q</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> min_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> LeastI_ex min_def<span class="main">)</span>

<span class="keyword1" id="WS1S-sconst_collapse"><span class="command">lemma</span></span> sconst_collapse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">##</span> sconst <span class="free">y</span> <span class="main">=</span> sconst <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> siterate.ctr<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-shift_sconst_inj"><span class="command">lemma</span></span> shift_sconst_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>length <span class="free">x</span> <span class="main">=</span> length <span class="free">y</span><span class="main">;</span> <span class="free">x</span> <span class="main">@-</span> sconst <span class="free">z</span> <span class="main">=</span> <span class="free">y</span> <span class="main">@-</span> sconst <span class="free">z</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> formula
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">any</span> <span class="main">≡</span> hd <span class="free">Σ</span>"</span></span>

<span class="keyword1" id="WS1S-any_Σ"><span class="command">lemma</span></span> any_Σ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"any <span class="main">∈</span> set <span class="free">Σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> any_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonempty <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">Σ</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="WS1S-any_σ"><span class="command">lemma</span></span> any_σ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">bs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span>any<span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="free">Σ</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def set_n_lists<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">stream_enc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool list<span class="main">)</span> stream"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stream_enc</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">=</span> smap2 <span class="main">(</span>enc_atom <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> nats <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">@-</span> sconst any<span class="main">)</span>"</span></span>

<span class="keyword1" id="WS1S-tl_stream_enc"><span class="command">lemma</span></span> tl_stream_enc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"smap π <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def π_def<span class="main">)</span>

<span class="keyword1" id="WS1S-enc_atom_max"><span class="command">lemma</span></span> enc_atom_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≤</span> <span class="free">n</span><span class="main">;</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">n'</span><span class="main">⟧</span> <span class="main">⟹</span>
  enc_atom <span class="free">I</span> <span class="main">(</span>Suc <span class="free">n'</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">I</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1" id="WS1S-ex_Loop_stream_enc"><span class="command">lemma</span></span> ex_Loop_stream_enc<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> finite <span class="bound">P</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> sdrop <span class="bound">n</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&gt;</span> length <span class="free">w</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≤</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">I</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">I</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">w</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">p</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"max <span class="skolem"><span class="skolem"><span class="skolem">p</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">P</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> IH Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"max <span class="main"><span class="main"><span class="main">(</span></span></span>Max <span class="skolem"><span class="skolem"><span class="skolem">P</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Max_ge <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"length <span class="free">w</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">|</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sdrop <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s1</span> <span class="skolem">n</span> <span class="main">=</span> <span class="var">?s2</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> stream.coinduct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">s1</span></span></span> <span class="bound"><span class="bound"><span class="bound">s2</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">∃</span></span></span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">n'</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">≥</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">s1</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="var"><span class="var">?s1</span></span></span> <span class="bound"><span class="bound"><span class="bound">n'</span></span></span> <span class="main"><span class="main"><span class="main">∧</span></span></span> <span class="bound"><span class="bound"><span class="bound">s2</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="var"><span class="var">?s2</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> enc_atom_max <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_SucI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-length_snth_enc"><span class="command">lemma</span></span> length_snth_enc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">!!</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-sset_singleton"><span class="command">lemma</span></span> sset_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="free">s</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟷</span> sset <span class="free">s</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-drop_sconstE"><span class="command">lemma</span></span> drop_sconstE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>drop <span class="free">n</span> <span class="free">w</span> <span class="main">@-</span> sconst <span class="free">y</span> <span class="main">=</span> sconst <span class="free">y</span><span class="main">;</span> <span class="free">p</span> <span class="main">&lt;</span> length <span class="free">w</span><span class="main">;</span> <span class="main">¬</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">!</span> <span class="free">p</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> not_less sconst_alt <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"tl <span class="skolem">w</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> nat.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> neq_Nil_conv<span class="main">)</span>

<span class="keyword1" id="WS1S-less_length_cut_same"><span class="command">lemma</span></span> less_length_cut_same<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">w</span> <span class="main">@-</span> sconst <span class="free">y</span><span class="main">)</span> <span class="main">!!</span> <span class="free">p</span> <span class="main">=</span> <span class="free">a</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∨</span> <span class="main">(</span><span class="free">p</span> <span class="main">&lt;</span> length <span class="main">(</span>cut_same <span class="free">y</span> <span class="main">(</span><span class="free">w</span> <span class="main">@-</span> sconst <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">!</span> <span class="free">p</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cut_same_def length_stake
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LeastI2_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> exI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="free"><span class="free"><span class="free">w</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sdrop_shift shift_snth <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> drop_sconstE<span class="main">)</span>

<span class="keyword1" id="WS1S-less_length_cut_same_Inl"><span class="command">lemma</span></span> less_length_cut_same_Inl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> finite <span class="bound">P</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">;</span> <span class="free">r</span> <span class="main">&lt;</span> length <span class="free">I</span><span class="main">;</span> <span class="free">I</span> <span class="main">!</span> <span class="free">r</span> <span class="main">=</span> Inl <span class="free">p</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">p</span> <span class="main">&lt;</span> length <span class="main">(</span>cut_same <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cut_same_def length_stake
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> LeastI2_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ex_Loop_stream_enc ccontr<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smap2_alt list_eq_iff_nth_eq add.commute <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_diff_inverse <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">metis</span><span class="main">)</span>

<span class="keyword1" id="WS1S-less_length_cut_same_Inr"><span class="command">lemma</span></span> less_length_cut_same_Inr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> finite <span class="bound">P</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">;</span> <span class="free">r</span> <span class="main">&lt;</span> length <span class="free">I</span><span class="main">;</span> <span class="free">I</span> <span class="main">!</span> <span class="free">r</span> <span class="main">=</span> Inr <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="main">(</span>cut_same <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cut_same_def length_stake
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> LeastI2_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ex_Loop_stream_enc ccontr<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smap2_alt list_eq_iff_nth_eq add.commute <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_diff_inverse <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">metis</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">enc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool list<span class="main">)</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enc</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span>cut_same <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> False<span class="main">)</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">@</span>
     replicate <span class="bound">n</span> <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="WS1S-cut_same_all"><span class="command">lemma</span></span> cut_same_all<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cut_same <span class="free">x</span> <span class="main">(</span>sconst <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cut_same_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Least_equality<span class="main">)</span>

<span class="keyword1" id="WS1S-cut_same_stop"><span class="command">lemma</span></span> cut_same_stop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cut_same <span class="free">x</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">y</span> <span class="main">##</span> sconst <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"cut_same <span class="free">x</span> <span class="var">?s</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> sdrop <span class="bound">n</span> <span class="var">?s</span> <span class="main">=</span> sconst <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Least_equality<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sdrop <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="var">?s</span> <span class="main">=</span> sconst <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sdrop_shift<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sdrop <span class="skolem">m</span> <span class="var">?s</span> <span class="main">=</span> sconst <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"sdrop <span class="skolem">m</span> <span class="var">?s</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@-</span> <span class="free">y</span> <span class="main">##</span> sconst <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">@-</span> <span class="free">y</span> <span class="main">##</span> sconst <span class="free">x</span> <span class="main">=</span> sconst <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"sdrop <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">##</span> sconst <span class="free">x</span> <span class="main">=</span> sconst <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sdrop_shift<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> siterate.code stream.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> leI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> cut_same_def stake_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-cut_same_shift_sconst"><span class="command">lemma</span></span> cut_same_shift_sconst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> cut_same <span class="free">x</span> <span class="main">(</span><span class="free">w</span> <span class="main">@-</span> sconst <span class="free">x</span><span class="main">)</span> <span class="main">@</span> replicate <span class="bound">n</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">w</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> cut_same <span class="free">x</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">@-</span> sconst <span class="free">x</span><span class="main">)</span> <span class="main">@</span> replicate <span class="skolem">n</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> siterate.code<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">id</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> id_apply<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      replicate_append_same<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="WS1S-set_cut_same"><span class="command">lemma</span></span> set_cut_same<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>cut_same <span class="free">x</span> <span class="main">(</span><span class="free">w</span> <span class="main">@-</span> sconst <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">w</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> siterate.code<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">id</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> id_apply<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="WS1S-stream_enc_cut_same"><span class="command">lemma</span></span> stream_enc_cut_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> finite <span class="bound">P</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> cut_same <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">@-</span>
    sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cut_same_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> stake_sdrop<span class="main"><span class="main"><span class="main">]</span></span></span> arg_cong2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(@-)</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> refl<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">rule</span> LeastI_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ex_Loop_stream_enc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="WS1S-stream_enc_enc"><span class="command">lemma</span></span> stream_enc_enc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> finite <span class="bound">P</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">@-</span> sconst <span class="var">?F</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"sdrop <span class="skolem">n</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sconst <span class="var">?F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ex_Loop_stream_enc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> v <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">=</span> cut_same <span class="var">?F</span> <span class="var">?s</span> <span class="main">@</span> replicate <span class="skolem">m</span> <span class="var">?F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">=</span> <span class="free">v</span> <span class="main">@-</span> sconst <span class="var">?F</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream_enc.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> stream_enc_cut_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-stream_enc_enc_some"><span class="command">lemma</span></span> stream_enc_enc_some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> finite <span class="bound">P</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stream_enc_enc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> someI_ex<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-enc_unique_length"><span class="command">lemma</span></span> enc_unique_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">v'</span><span class="main">.</span> length <span class="bound">v'</span> <span class="main">=</span> length <span class="free">v</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">v</span> <span class="main">=</span> <span class="bound">v'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-sdrop_sconst"><span class="command">lemma</span></span> sdrop_sconst<span class="main">:</span> <span class="quoted"><span class="quoted">"sdrop <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> sconst <span class="free">x</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">!!</span> <span class="free">m</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_iff_add sdrop_snth snth_siterate<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">id</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> id_funpow id_apply<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="WS1S-fin_cut_same_tl"><span class="command">lemma</span></span> fin_cut_same_tl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> sdrop <span class="bound">n</span> <span class="free">s</span> <span class="main">=</span> sconst <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fin_cut_same <span class="main">(</span>π <span class="free">x</span><span class="main">)</span> <span class="main">(</span>map π <span class="main">(</span>cut_same <span class="free">x</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> cut_same <span class="main">(</span>π <span class="free">x</span><span class="main">)</span> <span class="main">(</span>smap π <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">min</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">min</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> sdrop <span class="bound">n</span> <span class="free">s</span> <span class="main">=</span> sconst <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> min<span class="main">:</span> <span class="quoted"><span class="quoted">"sdrop <span class="skolem">min</span> <span class="free">s</span> <span class="main">=</span> sconst <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> sdrop <span class="bound">m</span> <span class="free">s</span> <span class="main">=</span> sconst <span class="free">x</span> <span class="main">⟹</span> <span class="skolem">min</span> <span class="main">≤</span> <span class="bound">m</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> min_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LeastI Least_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> drop <span class="bound">n</span> <span class="main">(</span>map π <span class="main">(</span>stake <span class="skolem">min</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="main">(</span>map π <span class="main">(</span>stake <span class="skolem">min</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>π <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map π <span class="main">(</span>stake <span class="skolem">min</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fin_cut_same <span class="main">(</span>π <span class="free">x</span><span class="main">)</span> <span class="main">(</span>map π <span class="main">(</span>cut_same <span class="free">x</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     map π <span class="main">(</span>stake  <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span>
       map π <span class="main">(</span>stake <span class="main">(</span><span class="skolem">min</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="bound">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="skolem">min</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>π <span class="free">x</span><span class="main">)</span> <span class="main">∨</span> sdrop <span class="bound">n</span> <span class="free">s</span> <span class="main">=</span> sconst <span class="free">x</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fin_cut_same_def cut_same_def take_map take_stake min_Least<span class="main">[</span><span class="operator">OF</span> Ex assms<span class="main">,</span> <span class="operator">folded</span> min_def<span class="main">]</span>
      min_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> drop_map drop_stake<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> map π <span class="main">(</span>stake <span class="main">(</span><span class="skolem">min</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="bound">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="skolem">min</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>π <span class="free">x</span><span class="main">)</span> <span class="main">∨</span> sdrop <span class="bound">n</span> <span class="free">s</span> <span class="main">=</span> sconst <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> smap π <span class="main">(</span>sdrop <span class="bound">n</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> sconst <span class="main">(</span>π <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> smap_alt snth_siterate<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">id</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> id_funpow id_apply<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">m</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"map π <span class="main">(</span>stake <span class="main">(</span><span class="skolem">min</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="skolem">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="skolem">min</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>π <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="main">(</span>stake <span class="main">(</span><span class="skolem">min</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="skolem">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> π <span class="bound">y</span> <span class="main">=</span> π <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_eq_conv<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> length_stake map_replicate_const<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">min</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">.</span> π <span class="main">(</span>sdrop <span class="skolem">n</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> π <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> all_set_conv_all_nth <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sdrop_snth<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"π <span class="main">(</span>sdrop <span class="skolem">n</span> <span class="free">s</span> <span class="main">!!</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> π <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">min</span> <span class="main">-</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">min</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sdrop <span class="skolem">n</span> <span class="free">s</span> <span class="main">!!</span> <span class="skolem">m</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sdrop_snth <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sdrop_sconst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> min<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span><span class="main">.</span> π <span class="main">(</span>sdrop <span class="skolem">n</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> π <span class="free">x</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"map π <span class="main">(</span>stake <span class="main">(</span><span class="skolem">min</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="skolem">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="skolem">min</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>π <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> stake_smap<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> smap_alt<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">π</span> <span class="quoted"><span class="quoted">"sdrop <span class="skolem">n</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"sconst <span class="main">(</span>π <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_replicate_const<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> cut_same_def sdrop_smap stake_smap <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-tl_enc"><span class="command">lemma</span></span> tl_enc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> finite <span class="bound">P</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SAMEQUOT <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span> <span class="main">(</span>map π <span class="main">`</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SAMEQUOT_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms π_def
    fin_cut_same_tl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ex_Loop_stream_enc<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> π_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="WS1S-encD"><span class="command">lemma</span></span> encD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">v</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> finite <span class="bound">P</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">v</span> <span class="main">=</span> map <span class="main">(</span>case_prod <span class="main">(</span>enc_atom <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free">v</span><span class="main">]</span> <span class="main">(</span>stake <span class="main">(</span>length <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">@-</span> sconst any<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> arg_cong<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"stake <span class="main"><span class="main"><span class="main">(</span></span></span>length <span class="free"><span class="free"><span class="free">v</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span><span class="operator">OF</span> stream_enc_enc<span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stake_shift sdrop_shift stake_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_replicate_const<span class="main">)</span>

<span class="keyword1" id="WS1S-enc_Inl"><span class="command">lemma</span></span> enc_Inl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> finite <span class="bound">P</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">;</span>
  <span class="free">m</span> <span class="main">&lt;</span> length <span class="free">I</span><span class="main">;</span> <span class="free">I</span> <span class="main">!</span> <span class="free">m</span> <span class="main">=</span> Inl <span class="free">p</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">&lt;</span> length <span class="free">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">x</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="main">!</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_length_cut_same_Inl<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append cut_same_def<span class="main">)</span>

<span class="keyword1" id="WS1S-enc_Inr"><span class="command">lemma</span></span> enc_Inr<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> finite <span class="bound">P</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&lt;</span> length <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">!</span> <span class="free">M</span> <span class="main">=</span> Inr <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">&lt;</span> length <span class="free">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">x</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="main">!</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&lt;</span> length <span class="free">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">x</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="main">!</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_length_cut_same_Inr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append cut_same_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&lt;</span> length <span class="free">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">x</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="main">!</span> <span class="free">M</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> encD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-enc_length"><span class="command">lemma</span></span> enc_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> enc <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">I</span> <span class="main">=</span> length <span class="free">I'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cL</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">w</span> <span class="bound">I</span><span class="main">.</span> cut_same <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="bound">I</span><span class="main">)</span> False<span class="main">)</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">w</span> <span class="bound">I</span> <span class="bound">m</span><span class="main">.</span> <span class="var">?cL</span> <span class="bound">w</span> <span class="bound">I</span> <span class="main">@</span> replicate <span class="main">(</span><span class="bound">m</span> <span class="main">-</span> length <span class="main">(</span><span class="var">?cL</span> <span class="bound">w</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="bound">I</span><span class="main">)</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?max</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"max <span class="main">(</span>length <span class="main">(</span><span class="var">?cL</span> <span class="free">w</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span><span class="var">?cL</span> <span class="free">w'</span> <span class="free">I'</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="free">w</span> <span class="free">I</span> <span class="var">?max</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="free">w'</span> <span class="free">I'</span> <span class="var">?max</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="free">w</span> <span class="free">I</span> <span class="var">?max</span> <span class="main">=</span> <span class="var">?w</span> <span class="free">w'</span> <span class="free">I'</span> <span class="var">?max</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> enc_unique_length assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span><span class="var">?w</span> <span class="free">w</span> <span class="free">I</span> <span class="var">?max</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span>"</span></span>
                <span class="quoted"><span class="quoted">"last <span class="main">(</span><span class="var">?w</span> <span class="free">w'</span> <span class="free">I'</span> <span class="var">?max</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I'</span><span class="main">)</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="free">I</span> <span class="main">=</span> length <span class="free">I'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-enc_stream_enc"><span class="command">lemma</span></span> enc_stream_enc<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> finite <span class="bound">P</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">I'</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> finite <span class="bound">P</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">;</span> 
    enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> enc <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> stream_enc <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> stream_enc_enc_some<span class="main"><span class="main">]</span></span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> stream_enc_enc_some<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> enc_length <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">wf_interp</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span>
  <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">Σ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> finite <span class="bound">P</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wf_interp_for_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interp <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_interp_for_formula</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span>
    <span class="main">(</span>wf_interp <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> FOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">!</span> <span class="bound">n</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> SOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">!</span> <span class="bound">n</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">satisfies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interp <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">!</span> <span class="bound">p</span> <span class="keyword1">else</span> any<span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> FLess <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="main">(</span>FExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> Inl <span class="bound">p</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="main">(</span>FEXISTS <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">P</span><span class="main">.</span> finite <span class="bound">P</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> Inr <span class="bound">P</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool list<span class="main">)</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span> <span class="bound">I</span> <span class="main">.</span> length <span class="bound">I</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> wf_interp_for_formula <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="WS1S-encD_ex"><span class="command">lemma</span></span> encD_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> finite <span class="bound">P</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> map <span class="main">(</span>case_prod <span class="main">(</span>enc_atom <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="bound">n</span><span class="main">]</span> <span class="main">(</span>stake <span class="bound">n</span> <span class="main">(</span><span class="free">w</span> <span class="main">@-</span> sconst any<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> encD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>

<span class="keyword1" id="WS1S-enc_set_σ"><span class="command">lemma</span></span> enc_set_σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inr <span class="bound">P</span> <span class="main">⇒</span> finite <span class="bound">P</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">;</span>
  length <span class="free">I</span> <span class="main">=</span> <span class="free">n</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> set <span class="free">x</span><span class="main">;</span> set <span class="free">w</span> <span class="main">⊆</span> set <span class="free">Σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="free">Σ</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> encD_ex <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> enc_atom_σ <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_zip shift_snth <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">positions_in_row</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span>
  Option.these <span class="main">(</span>sset <span class="main">(</span>smap2 <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> nth <span class="bound">bs</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> Some <span class="bound">p</span> <span class="keyword1">else</span> None<span class="main">)</span> nats <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="WS1S-positions_in_row"><span class="command">lemma</span></span> positions_in_row<span class="main">:</span> <span class="quoted"><span class="quoted">"positions_in_row <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> snd <span class="main">(</span><span class="free">s</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> positions_in_row_def Option.these_def smap2_szip stream.set_map sset_range
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">the</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1" id="WS1S-positions_in_row_unique"><span class="command">lemma</span></span> positions_in_row_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> snd <span class="main">(</span><span class="free">s</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">⟹</span>
  the_elem <span class="main">(</span>positions_in_row <span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">p</span><span class="main">.</span> snd <span class="main">(</span><span class="free">s</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> the1I2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> the_elem_def positions_in_row<span class="main">)</span>

<span class="keyword1" id="WS1S-positions_in_row_nth"><span class="command">lemma</span></span> positions_in_row_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> snd <span class="main">(</span><span class="free">s</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">⟹</span>
  snd <span class="main">(</span><span class="free">s</span> <span class="main">!!</span> the_elem <span class="main">(</span>positions_in_row <span class="free">s</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> positions_in_row_unique <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> the1I2<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec_word</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> cut_same any <span class="main">(</span>smap fst <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="WS1S-dec_word_stream_enc"><span class="command">lemma</span></span> dec_word_stream_enc<span class="main">:</span> <span class="quoted"><span class="quoted">"dec_word <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> cut_same any <span class="main">(</span><span class="free">w</span> <span class="main">@-</span> sconst any<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dec_word_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"cut_same any"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smap2_alt<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">stream_dec</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">FO</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool list<span class="main">)</span> stream<span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span>
  <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">FO</span></span></span>
  <span class="keyword1">then</span> Inl <span class="main">(</span>the_elem <span class="main">(</span>positions_in_row <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span> Inr <span class="main">(</span>positions_in_row <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1" id="WS1S-stream_dec_Inl"><span class="command">lemma</span></span> stream_dec_Inl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> stream_dec <span class="free">n</span> <span class="free">FO</span> <span class="free">s</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inl <span class="bound">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stream_dec_def <span class="keyword1"><span class="command">using</span></span> nth_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-stream_dec_not_Inr"><span class="command">lemma</span></span> stream_dec_not_Inr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>stream_dec <span class="free">n</span> <span class="free">FO</span> <span class="free">s</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inr <span class="free">P</span><span class="main">;</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stream_dec_def <span class="keyword1"><span class="command">using</span></span> nth_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-stream_dec_Inr"><span class="command">lemma</span></span> stream_dec_Inr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">∉</span> <span class="free">FO</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">P</span><span class="main">.</span> stream_dec <span class="free">n</span> <span class="free">FO</span> <span class="free">s</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inr <span class="bound">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stream_dec_def <span class="keyword1"><span class="command">using</span></span> nth_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-stream_dec_not_Inl"><span class="command">lemma</span></span> stream_dec_not_Inl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>stream_dec <span class="free">n</span> <span class="free">FO</span> <span class="free">s</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inl <span class="free">p</span><span class="main">;</span> <span class="free">i</span> <span class="main">∉</span> <span class="free">FO</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stream_dec_def <span class="keyword1"><span class="command">using</span></span> nth_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-Inr_dec_finite"><span class="command">lemma</span></span> Inr_dec_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> finite <span class="main">{</span><span class="bound">p</span><span class="main">.</span> snd <span class="main">(</span><span class="free">s</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">}</span><span class="main">;</span> Inr <span class="free">P</span> <span class="main">∈</span> set <span class="main">(</span>stream_dec <span class="free">n</span> <span class="free">FO</span> <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  finite <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stream_dec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> positions_in_row<span class="main">)</span>

<span class="keyword1" id="WS1S-enc_atom_dec"><span class="command">lemma</span></span> enc_atom_dec<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> length <span class="main">(</span>snd <span class="main">(</span><span class="free">s</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span><span class="main">;</span> <span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> snd <span class="main">(</span><span class="free">s</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span> <span class="free">a</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">s</span> <span class="main">!!</span> <span class="free">p</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
   enc_atom <span class="main">(</span>stream_dec <span class="free">n</span> <span class="free">FO</span> <span class="free">s</span><span class="main">)</span> <span class="free">p</span> <span class="free">a</span> <span class="main">=</span> <span class="free">s</span> <span class="main">!!</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stream_dec_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> surjective_pairing<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">s</span></span></span> <span class="main"><span class="main"><span class="main">!!</span></span></span> <span class="free"><span class="free"><span class="free">p</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_equalityI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> positions_in_row <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> prod.collapse <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span>
    <span class="main">(</span><span class="operator">metis</span> positions_in_row positions_in_row_nth<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="WS1S-length_stream_dec"><span class="command">lemma</span></span> length_stream_dec<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>stream_dec <span class="free">n</span> <span class="free">FO</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stream_dec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-stream_enc_dec"><span class="command">lemma</span></span> stream_enc_dec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> sdrop <span class="bound">n</span> <span class="main">(</span>smap fst <span class="free">s</span><span class="main">)</span> <span class="main">=</span> sconst any<span class="main">;</span>
   stream_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> length <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span><span class="main">;</span> <span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">.</span> <span class="main">(</span><span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> snd <span class="main">(</span><span class="free">s</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
   stream_enc <span class="main">(</span>dec_word <span class="free">s</span><span class="main">,</span> stream_dec <span class="free">n</span> <span class="free">FO</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dec_word_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> LeastI_ex<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_dec <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smap2_alt cut_same_def
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stake_smap sdrop_smap
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> arg_cong2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(!!)</span>"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> snth_smap<span class="main"><span class="main">]</span></span>
            trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> arg_cong2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(@-)</span>"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> stake_sdrop<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="WS1S-stream_enc_unique"><span class="command">lemma</span></span> stream_enc_unique<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">I</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="free">I</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inl <span class="bound">p</span> <span class="main">⟹</span> <span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> snd <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-stream_dec_enc_Inl"><span class="command">lemma</span></span> stream_dec_enc_Inl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>stream_dec <span class="free">n</span> <span class="free">FO</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inl <span class="free">p'</span><span class="main">;</span> <span class="free">I</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inl <span class="free">p</span><span class="main">;</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">;</span> length <span class="free">I</span> <span class="main">=</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">p</span> <span class="main">=</span> <span class="free">p'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stream_dec_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ sym<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span>  positions_in_row_unique<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> stream_enc_unique<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream_enc.simps<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="WS1S-stream_dec_enc_Inr"><span class="command">lemma</span></span> stream_dec_enc_Inr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>stream_dec <span class="free">n</span> <span class="free">FO</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inr <span class="free">P'</span><span class="main">;</span> <span class="free">I</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Inr <span class="free">P</span><span class="main">;</span> <span class="free">i</span> <span class="main">∉</span> <span class="free">FO</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">;</span> length <span class="free">I</span> <span class="main">=</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">P</span> <span class="main">=</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stream_dec_def positions_in_row <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-Collect_snth"><span class="command">lemma</span></span> Collect_snth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">s</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∪</span> Suc <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">s</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> image_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gr0_conv_Suc<span class="main">)</span>

<span class="keyword1" id="WS1S-finite_True_in_row"><span class="command">lemma</span></span> finite_True_in_row<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> finite <span class="main">{</span><span class="bound">p</span><span class="main">.</span> snd <span class="main">(</span><span class="main">(</span><span class="free">w</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="free">n</span> False<span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Collect_snth<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="WS1S-lang_ENC"><span class="command">lemma</span></span> lang_ENC<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">FO</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">SO</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="free">FO</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="free">FO</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span> <span class="bound">I</span> <span class="main">.</span> length <span class="bound">I</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> wf_interp <span class="bound">w</span> <span class="bound">I</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">I</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">SO</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">I</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">}</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">FO</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">x</span> <span class="main">⊆</span> set <span class="main">(</span>σ <span class="free">Σ</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    bspec<span class="main">[</span><span class="operator">OF</span> wf_lang_wf_word<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_rexp_ENC<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> L<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_word<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="free">n</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">bs</span><span class="main">.</span> length <span class="main">(</span>snd <span class="bound">bs</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff σ_def set_n_lists<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"stream_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> length <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="free">n</span> False<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> stream_all_shift sset_sconst length_replicate snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> <span class="free">FO</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_idx_vars<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> L <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">∈</span> <span class="free">FO</span>›</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> uzv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">z</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> star <span class="main">(</span>lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">m</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">m</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> star <span class="main">(</span>lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">m</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ENC_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less max_idx_vars valid_ENC_def fin <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_rexp_valid_ENC finite_FOV
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lang_flatten_INTERSECT<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span>  snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ex1I<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"length <span class="skolem"><span class="skolem">u</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> star_Arbitrary_ExceptD<span class="main">[</span><span class="operator">OF</span> uzv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> Arbitrary_ExceptD<span class="main">[</span><span class="operator">OF</span> uzv<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> star_Arbitrary_ExceptD<span class="main">[</span><span class="operator">OF</span> uzv<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> length <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append uzv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Arbitrary_ExceptD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="bound">q</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> length <span class="skolem">x</span> <span class="main">⟶</span> <span class="bound">q</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> snd <span class="main">(</span><span class="var">?s</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ex1I<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="keyword1"><span class="command">from</span></span> p<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> p<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?s</span> <span class="main">!!</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">⟹</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span><span class="main">)</span>  <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sdrop <span class="main">(</span>length <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>smap fst <span class="main">(</span><span class="skolem">x</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="free">n</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sconst any"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sdrop_smap <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sdrop_shift<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> enc_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_enc <span class="main">(</span>dec_word <span class="var">?s</span><span class="main">,</span> stream_dec <span class="free">n</span> <span class="free">FO</span> <span class="var">?s</span><span class="main">)</span> <span class="main">=</span>
    <span class="skolem">x</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="free">n</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> stream_enc_dec<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> stream_dec <span class="free">n</span> <span class="free">FO</span> <span class="var">?s</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_interp <span class="main">(</span>dec_word <span class="var">?s</span><span class="main">)</span> <span class="skolem">I</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">.</span> <span class="keyword1">case</span> <span class="skolem">I</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">SO</span><span class="main">.</span> <span class="keyword1">case</span> <span class="skolem">I</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def dec_word_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> stream_dec_not_Inr stream_dec_not_Inl <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def  max_idx_vars
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> set_cut_same<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted">any</span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">x</span>"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream_dec_def positions_in_row finite_True_in_row<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span>dec_word <span class="var">?s</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enc_dec cut_same_shift_sconst <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream_enc.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp <span class="skolem">w</span> <span class="skolem">I</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">FO</span><span class="main">.</span> <span class="keyword1">case</span> <span class="skolem">I</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">SO</span><span class="main">.</span> <span class="keyword1">case</span> <span class="skolem">I</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">from</span></span> I<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span> <span class="main">@-</span> sconst any<span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">∈</span> set <span class="free">Σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">w</span>"</span></span><span class="main">)</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="skolem">I</span><span class="main">)</span> False<span class="main">)</span> <span class="main">=</span> stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">@-</span> <span class="var">?F</span> <span class="main">=</span> <span class="var">?s</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> stream_enc_enc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="quoted"><span class="quoted">‹length <span class="skolem">I</span> <span class="main">=</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">x</span><span class="main">.</span> length <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> fst <span class="bound">x</span> <span class="main">∈</span> set <span class="free">Σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> shift_snth_less<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">FO</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_ENC <span class="free">n</span> <span class="main">`</span> <span class="free">FO</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>valid_ENC <span class="free">n</span> <span class="main">`</span> <span class="free">FO</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> False assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> max_idx_vars<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> wf_rexp_valid_ENC assms <span class="keyword1"><span class="command">have</span></span> wf_rexp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> valid_ENC <span class="free">n</span> <span class="main">`</span> <span class="free">FO</span><span class="main">.</span> wf <span class="free">n</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_idx_vars<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">FO</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> I<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">r</span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">r</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">FO</span>›</span></span> assms I<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> length <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> max_idx_vars<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> p I<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> r <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> less_length_cut_same_Inl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> p I r *
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">]</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">r</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> encD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">I</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> lang.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_lang_Arbitrary_Except_True<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> p I r * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">∈</span> star <span class="main">(</span>lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">r</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> encD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> lang.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Ball_starI enc_atom_lang_Arbitrary_Except_False<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> p I r * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="skolem">p</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∈</span> star <span class="main">(</span>lang <span class="free">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">r</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> encD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> lang.simps snth.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Ball_starI enc_atom_lang_Arbitrary_Except_False<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>valid_ENC <span class="free">n</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> valid_ENC_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> append.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>valid_ENC <span class="free">n</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> False lang_flatten_INTERSECT<span class="main">[</span><span class="operator">OF</span> finite nonempty wf_rexp<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ENC_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ENC_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def set_n_lists image_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-lang_ENC_formula"><span class="command">lemma</span></span> lang_ENC_formula<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span> <span class="bound">I</span> <span class="main">.</span> length <span class="bound">I</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> wf_interp_for_formula <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms max_idx_vars <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"FOV <span class="free">φ</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"SOV <span class="free">φ</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">-</span> FOV <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Welldefinedness of enc wrt. Models›</span></span>

<span class="keyword1" id="WS1S-wf_interp_for_formula_FExists"><span class="command">lemma</span></span> wf_interp_for_formula_FExists<span class="main">:</span> 
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf_formula <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span><span class="main">⟧</span><span class="main">⟹</span>
  wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inl <span class="bound">p</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="WS1S-wf_interp_for_formula_any_Inl"><span class="command">lemma</span></span> wf_interp_for_formula_any_Inl<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inl <span class="free">p</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inl <span class="bound">p</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="WS1S-wf_interp_for_formula_FEXISTS"><span class="command">lemma</span></span> wf_interp_for_formula_FEXISTS<span class="main">:</span> 
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf_formula <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span><span class="main">⟧</span><span class="main">⟹</span>
  wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> finite <span class="bound">P</span> <span class="main">⟶</span> wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inr <span class="bound">P</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="WS1S-wf_interp_for_formula_any_Inr"><span class="command">lemma</span></span> wf_interp_for_formula_any_Inr<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inr <span class="free">P</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">P</span><span class="main">.</span> finite <span class="bound">P</span> <span class="main">⟶</span> wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> Inr <span class="bound">P</span> <span class="main">#</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="WS1S-wf_interp_for_formula_FOr"><span class="command">lemma</span></span> wf_interp_for_formula_FOr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>FOr <span class="free">φ1</span> <span class="free">φ2</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ1</span> <span class="main">∧</span> wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-wf_interp_for_formula_FAnd"><span class="command">lemma</span></span> wf_interp_for_formula_FAnd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>FAnd <span class="free">φ1</span> <span class="free">φ2</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ1</span> <span class="main">∧</span> wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-enc_wf_interp"><span class="command">lemma</span></span> enc_wf_interp<span class="main">:</span> 
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf_formula <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">;</span> wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  wf_interp_for_formula <span class="main">(</span>dec_word <span class="main">(</span><span class="free">x</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    stream_dec <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>
    stream_dec_Inl<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"FOV <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ bspec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> max_idx_vars<span class="main"><span class="main">]</span></span><span class="main">]</span>
    stream_dec_Inr<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"FOV <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ bspec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> max_idx_vars<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Inr_dec_finite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_True_in_row<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_idx_vars dec_word_def
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> stream_dec_not_Inl stream_dec_not_Inr subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> set_cut_same<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream_enc.simps<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cut_same_def in_set_zip smap2_alt shift_snth<span class="main">)</span>

<span class="keyword1" id="WS1S-enc_atom_welldef"><span class="command">lemma</span></span> enc_atom_welldef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">a</span><span class="main">.</span> enc_atom <span class="free">I</span> <span class="bound">x</span> <span class="bound">a</span> <span class="main">=</span> enc_atom <span class="free">I'</span> <span class="bound">x</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">&lt;</span> length <span class="free">I</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">I</span> <span class="main">!</span> <span class="free">m</span><span class="main">,</span> <span class="free">I'</span> <span class="main">!</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>Inl <span class="bound">p</span><span class="main">,</span> Inl <span class="bound">q</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">p</span> <span class="main">=</span> <span class="bound">q</span> <span class="main">|</span> <span class="main">(</span>Inr <span class="bound">P</span><span class="main">,</span> Inr <span class="bound">Q</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">P</span> <span class="main">=</span> <span class="bound">Q</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">I</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">I'</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="skolem">I</span> <span class="skolem">I'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I'</span> <span class="main">=</span> <span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_length_conv map_eq_Cons_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">x'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sum.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> sum.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="WS1S-stream_enc_welldef"><span class="command">lemma</span></span> stream_enc_welldef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> stream_enc <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span><span class="main">;</span> wf_formula <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">;</span>
  wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">;</span> wf_interp_for_formula <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span> <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">w'</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">I'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> enc_atom_welldef<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smap2_alt shift_snth<span class="main">)</span>
      <span class="main">(</span><span class="operator">metis</span> snth_siterate<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">id</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> id_funpow id_apply<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FLess <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> enc_atom_welldef<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="skolem">m1</span></span><span class="main">]</span> enc_atom_welldef<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="skolem">m2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smap2_alt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> enc_atom_welldef<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> enc_atom_welldef<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="skolem">M</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smap2_alt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FOr <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies.simps<span class="main">(</span>5<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> disj_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> FOr<span class="main">(</span>3-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ1</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FOr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> FOr<span class="main">(</span>3-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ2</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FOr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FAnd <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies.simps<span class="main">(</span>6<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conj_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> FAnd<span class="main">(</span>3-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ1</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FAnd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> FAnd<span class="main">(</span>3-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ2</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FAnd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">I'</span> <span class="main">=</span> length <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_snth_enc<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> FExists <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> FExists.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> FExists.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FExists.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inl <span class="skolem"><span class="skolem">p</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w'</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inl <span class="skolem"><span class="skolem">p</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> FExists.prems<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FExists<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> FExists.prems<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FExists<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I'</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> length<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smap2_alt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">⊨</span> FExists <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">⊨</span> FExists <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> FExists.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> FExists.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FExists.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inl <span class="skolem"><span class="skolem">p</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w'</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inl <span class="skolem"><span class="skolem">p</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> FExists.prems<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FExists<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> FExists.prems<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FExists<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I'</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> length<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smap2_alt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> FExists <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">I'</span> <span class="main">=</span> length <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_snth_enc<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> FEXISTS <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> FEXISTS.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> FEXISTS.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FEXISTS.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inr <span class="skolem"><span class="skolem">P</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w'</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inr <span class="skolem"><span class="skolem">P</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> FEXISTS.prems<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FEXISTS<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> FEXISTS.prems<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FEXISTS<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I'</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> length<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smap2_alt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">⊨</span> FEXISTS <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">⊨</span> FEXISTS <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> FEXISTS.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> FEXISTS.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FEXISTS.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inr <span class="skolem"><span class="skolem">P</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w'</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inr <span class="skolem"><span class="skolem">P</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">I'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> FEXISTS.prems<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FEXISTS<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> FEXISTS.prems<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w'</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_interp_for_formula_FEXISTS<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">I'</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> length<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smap2_alt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> FEXISTS <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-lang"><span class="command">lemma</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_FOr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FOr <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="main">(</span>FOr <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊆</span>
    <span class="main">(</span>lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">{</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span> <span class="bound">I</span><span class="main">.</span> length <span class="bound">I</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> wf_interp_for_formula <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">(</span>FOr <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⊆</span> <span class="main">(</span><span class="var">?L1</span> <span class="main">∪</span> <span class="var">?L2</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?ENC</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="main">(</span>FOr <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FOr <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
     <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∨</span> satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="var">?L1</span> <span class="main">∪</span> <span class="var">?L2</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?ENC</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span><span class="var">?L2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-lang"><span class="command">lemma</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_FAnd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FAnd <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="main">(</span>FAnd <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊆</span>
    lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">{</span>enc <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span> <span class="bound">I</span><span class="main">.</span> length <span class="bound">I</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> wf_interp_for_formula <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">(</span>FAnd <span class="free">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹From WS1S to Regular expressions›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rexp_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> atom<span class="main">)</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span>
    Inter <span class="main">(</span>TIMES <span class="main">[</span>rexp.Not Zero<span class="main">,</span> Atom <span class="main">(</span>AQ <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">,</span> rexp.Not Zero<span class="main">]</span><span class="main">)</span>
    <span class="main">(</span>ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="main">(</span>FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="keyword1">then</span> Zero <span class="keyword1">else</span>
    Inter <span class="main">(</span>TIMES <span class="main">[</span>rexp.Not Zero<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">m1</span></span></span> True<span class="main">)</span><span class="main">,</span>
      rexp.Not Zero<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">m2</span></span></span> True<span class="main">)</span><span class="main">,</span>
      rexp.Not Zero<span class="main">]</span><span class="main">)</span> <span class="main">(</span>ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> formula<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> 
    Inter <span class="main">(</span>TIMES <span class="main">[</span>rexp.Not Zero<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except2 <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">,</span> rexp.Not Zero<span class="main">]</span><span class="main">)</span>
    <span class="main">(</span>ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="main">(</span>FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> formula<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span>rexp.Not <span class="main">(</span><span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span>Plus <span class="main">(</span><span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> INTERSECT <span class="main">[</span><span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> samequot_exec <span class="main">(</span>any<span class="main">,</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> False<span class="main">)</span> <span class="main">(</span>Pr <span class="main">(</span><span class="free">rexp_of</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FEXISTS <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> samequot_exec <span class="main">(</span>any<span class="main">,</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> False<span class="main">)</span> <span class="main">(</span>Pr <span class="main">(</span><span class="free">rexp_of</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rexp_of_alt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> atom<span class="main">)</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span>
    TIMES <span class="main">[</span>rexp.Not Zero<span class="main">,</span> Atom <span class="main">(</span>AQ <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">,</span> rexp.Not Zero<span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="keyword1">then</span> Zero <span class="keyword1">else</span>
    TIMES <span class="main">[</span>rexp.Not Zero<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">m1</span></span></span> True<span class="main">)</span><span class="main">,</span>
      rexp.Not Zero<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">m2</span></span></span> True<span class="main">)</span><span class="main">,</span>
      rexp.Not Zero<span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> 
    TIMES <span class="main">[</span>rexp.Not Zero<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except2 <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">,</span> rexp.Not Zero<span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> rexp.Not <span class="main">(</span><span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span><span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> samequot_exec <span class="main">(</span>any<span class="main">,</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> False<span class="main">)</span> <span class="main">(</span>Pr <span class="main">(</span>Inter <span class="main">(</span><span class="free">rexp_of_alt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>FOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FEXISTS <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> samequot_exec <span class="main">(</span>any<span class="main">,</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> False<span class="main">)</span> <span class="main">(</span>Pr <span class="main">(</span>Inter <span class="main">(</span><span class="free">rexp_of_alt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>FOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> Inter <span class="main">(</span>rexp_of_alt <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rexp_of_alt'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> atom<span class="main">)</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> TIMES <span class="main">[</span>Full<span class="main">,</span> Atom <span class="main">(</span>AQ <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">,</span> Full<span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="keyword1">then</span> Zero <span class="keyword1">else</span>
    TIMES <span class="main">[</span>Full<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">m1</span></span></span> True<span class="main">)</span><span class="main">,</span> Full<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except <span class="free"><span class="bound"><span class="entity">m2</span></span></span> True<span class="main">)</span><span class="main">,</span> Full<span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> TIMES <span class="main">[</span>Full<span class="main">,</span> Atom <span class="main">(</span>Arbitrary_Except2 <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">,</span> Full<span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> rexp.Not <span class="main">(</span><span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Inter <span class="main">(</span><span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> samequot_exec <span class="main">(</span>any<span class="main">,</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> False<span class="main">)</span> <span class="main">(</span>Pr <span class="main">(</span>Inter <span class="main">(</span><span class="free">rexp_of_alt'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_alt'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FEXISTS <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> samequot_exec <span class="main">(</span>any<span class="main">,</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> False<span class="main">)</span> <span class="main">(</span>Pr <span class="main">(</span><span class="free">rexp_of_alt'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of''</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> Inter <span class="main">(</span>rexp_of_alt' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>ENC <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="WS1S-enc_eqI"><span class="command">lemma</span></span> enc_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">I</span> <span class="main">=</span> length <span class="free">I'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> enc <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> stream_enc <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ stream_enc_enc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> stream_enc_enc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-enc_eq_welldef"><span class="command">lemma</span></span> enc_eq_welldef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> enc <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span><span class="main">;</span> wf_formula <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">;</span> wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span> <span class="main">;</span>wf_interp_for_formula <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span> <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> stream_enc_welldef<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream_enc.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_stream_enc<span class="main">)</span>

<span class="keyword1" id="WS1S-enc_welldef"><span class="command">lemma</span></span> enc_welldef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span><span class="main">;</span> length <span class="free">I</span> <span class="main">=</span> length <span class="free">I'</span><span class="main">;</span> wf_formula <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">;</span>
  wf_interp_for_formula <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">φ</span> <span class="main">;</span>wf_interp_for_formula <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span> <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> enc_eq_welldef<span class="main"><span class="main">[</span></span><span class="operator">OF</span> enc_eqI<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="WS1S-wf_rexp_of"><span class="command">lemma</span></span> wf_rexp_of<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>rexp_of <span class="free">n</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_samequot_exec wf_rexp_ENC<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_idx_vars finite_FOV<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">φ</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>rexp_of <span class="free">n</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">=</span> <span class="var">?L</span> <span class="free">n</span> <span class="free">φ</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> FQ <span class="skolem">a</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> x_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> map <span class="main">(</span>case_prod <span class="main">(</span>enc_atom <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="skolem">x</span><span class="main">]</span> <span class="main">(</span>stake <span class="main">(</span>length <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">@-</span> sconst any<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> encD<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> FQ<span class="main">(</span>1<span class="main">)</span> *<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_set_conv_all_nth <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> FQ<span class="main">(</span>1<span class="main">)</span> * <span class="keyword1"><span class="command">have</span></span> p_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream_enc.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans_less_add1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> less_length_cut_same_Inl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> enc_atom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">!</span> <span class="skolem">p</span> <span class="main">=</span> enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="main">(</span><span class="main">(</span><span class="skolem">w</span> <span class="main">@-</span> sconst any<span class="main">)</span> <span class="main">!!</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> enc_atom <span class="main">_</span> <span class="main">_</span> <span class="var">?p</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> x_alt<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>1<span class="main">)</span> p_less<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> take <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="var">?p</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> FQ<span class="main">(</span>1<span class="main">)</span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="var">?p</span><span class="main">]</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>AQ <span class="skolem">m</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> lang.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_lang_AQ<span class="main">)</span> 
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp.Not Zero<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> x_alt<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_zip shift_snth <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_takeD<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="skolem">p</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp.Not Zero<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> x_alt<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_zip shift_snth <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_dropD<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps<span class="main">(</span>6<span class="main">,</span>9<span class="main">)</span> rexp_of_list.simps lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FQ<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ssubst <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply append.simps lang.simps enc.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> FQ <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FQ<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> stream_enc<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">=</span> <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> stream_enc_enc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> I FQ <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span>dec_word <span class="var">?x</span><span class="main">,</span> stream_dec <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span> <span class="var">?x</span><span class="main">)</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> enc_wf_interp<span class="main">[</span><span class="operator">OF</span> FQ<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> I<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u1</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">u2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>AQ <span class="skolem">m</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps rexp_of_list.simps <span class="keyword1"><span class="command">using</span></span> concE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> FQ<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u2</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">v</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> AQ_D<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">u1</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> length <span class="skolem">u1</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> m I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> enc_Inl <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> m I <span class="keyword1"><span class="command">have</span></span> ex1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> snd <span class="main">(</span>stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> stream_enc_unique<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> length <span class="skolem">u1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> stream_enc <span class="keyword1"><span class="command">using</span></span> u I<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">!</span> length <span class="skolem">u1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">!!</span> length <span class="skolem">u1</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_snth<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * m I v<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dec_word <span class="var">?x</span><span class="main">,</span> stream_dec <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span> <span class="var">?x</span><span class="main">)</span> <span class="main">⊨</span> FQ <span class="skolem">a</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stream_enc_enc<span class="main">[</span><span class="operator">OF</span> _ I<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> less_length_cut_same<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="quoted">"any"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">u1</span>"</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps stream_enc.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_word_stream_enc <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>
        stream_dec_enc_Inl stream_dec_not_Inr <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smap2_alt cut_same_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> m I<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> stream_enc_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_enc <span class="main">(</span>dec_word <span class="main">(</span>stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> stream_dec <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> stream_enc_dec<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smap2_alt sdrop_snth shift_snth <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> stream_enc_unique<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smap2_szip stream.set_map<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_word <span class="skolem">n</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wf_word <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> enc_set_σ <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FQ <span class="skolem">a</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">using</span></span> m I<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps stream_enc.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span>dec_word <span class="var">?x</span><span class="main">,</span> stream_dec <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span> <span class="var">?x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps stream_enc.simps<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream_enc.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream_enc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> I<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">m'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> FLess <span class="skolem">m</span> <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> x_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> map <span class="main">(</span>case_prod <span class="main">(</span>enc_atom <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="skolem">x</span><span class="main">]</span> <span class="main">(</span>stake <span class="main">(</span>length <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">@-</span> sconst any<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> encD<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> FLess<span class="main">(</span>1<span class="main">)</span> *<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> pq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m'</span> <span class="main">=</span> Inl <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_set_conv_all_nth <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> FLess<span class="main">(</span>1<span class="main">)</span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> pq_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream_enc.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trans_less_add1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> less_length_cut_same_Inl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> enc_atom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">!</span> <span class="skolem">p</span> <span class="main">=</span> enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="main">(</span><span class="main">(</span><span class="skolem">w</span> <span class="main">@-</span> sconst any<span class="main">)</span> <span class="main">!!</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> enc_atom <span class="main">_</span> <span class="main">_</span> <span class="var">?p</span>"</span></span><span class="main">)</span>
                      <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">!</span> <span class="skolem">q</span> <span class="main">=</span> enc_atom <span class="skolem">I</span> <span class="skolem">q</span> <span class="main">(</span><span class="main">(</span><span class="skolem">w</span> <span class="main">@-</span> sconst any<span class="main">)</span> <span class="main">!!</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> enc_atom <span class="main">_</span> <span class="main">_</span> <span class="var">?q</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> x_alt<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>1<span class="main">)</span> pq_less<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> take <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="var">?p</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">@</span>
        <span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">q</span> <span class="var">?q</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?LHS</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main">]</span> pq pq_less<span class="main">(</span>2<span class="main">)</span> enc_atom<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> take <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="var">?p</span><span class="main">]</span> <span class="main">@</span> <span class="var">?LHS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> FLess<span class="main">(</span>1<span class="main">)</span> pq<span class="main">(</span>1<span class="main">)</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="var">?p</span><span class="main">]</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">m</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> enc_atom_lang_Arbitrary_Except_True<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_snth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> FLess<span class="main">(</span>1<span class="main">)</span> pq<span class="main">(</span>2<span class="main">)</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">q</span> <span class="var">?q</span><span class="main">]</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">m'</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> enc_atom_lang_Arbitrary_Except_True<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_snth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp.Not Zero<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> x_alt<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_zip shift_snth <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_takeD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">p</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp.Not Zero<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> x_alt<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_zip shift_snth <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_dropD in_set_takeD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">p</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp.Not Zero<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> x_alt<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_zip shift_snth <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_dropD<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps<span class="main">(</span>6<span class="main">,</span>9<span class="main">)</span> rexp_of_list.simps Int_Diff lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FLess<span class="main">]</span> if_not_P<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ssubst <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply append.simps lang.simps enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> FLess <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FLess<span class="main">]</span> if_not_P<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">hence</span></span> stream_enc<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> stream_enc_enc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> I FLess <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m'</span> <span class="main">=</span> Inl <span class="skolem">p'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">&lt;</span> length <span class="skolem">I</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span>dec_word <span class="var">?x</span><span class="main">,</span> stream_dec <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">}</span> <span class="var">?x</span><span class="main">)</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> enc_wf_interp<span class="main">[</span><span class="operator">OF</span> FLess<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> I<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u1</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u2</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">u3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">u2</span> <span class="main">@</span> <span class="skolem">u'</span> <span class="main">@</span> <span class="skolem">u3</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">m</span> True<span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except <span class="skolem">m'</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps rexp_of_list.simps if_not_P<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> concE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">with</span></span> FLess<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">v'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u3</span>"</span></span>
         <span class="quoted"><span class="quoted">"snd <span class="skolem">v</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">v'</span> <span class="main">!</span> <span class="skolem">m'</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">v</span> <span class="main">∈</span> set <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">v'</span> <span class="main">∈</span> set <span class="free">Σ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Arbitrary_ExceptD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted">True</span><span class="main">]</span> Arbitrary_ExceptD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u'</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">m'</span></span> <span class="quoted">True</span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">u1</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="skolem">u1</span> <span class="main">+</span> length <span class="skolem">u2</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u'</span> <span class="main">&lt;</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> length <span class="skolem">u1</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> m I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> enc_Inl <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> m I <span class="keyword1"><span class="command">have</span></span> ex1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> snd <span class="main">(</span>stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> stream_enc_unique<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> length <span class="skolem">u1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> stream_enc <span class="keyword1"><span class="command">using</span></span> u I<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="var">?u'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> m I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> enc_Inl <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> m I <span class="keyword1"><span class="command">have</span></span> ex1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> snd <span class="main">(</span>stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> stream_enc_unique<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="var">?u'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> stream_enc <span class="keyword1"><span class="command">using</span></span> u' I<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> shift_snth_less<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> length <span class="skolem">u1</span>›</span></span>
      <span class="keyword1"><span class="command">with</span></span> m I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dec_word <span class="var">?x</span><span class="main">,</span> stream_dec <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">}</span> <span class="var">?x</span><span class="main">)</span> <span class="main">⊨</span> FLess <span class="skolem">m</span> <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> stream_enc_enc<span class="main">[</span><span class="operator">OF</span> _ I<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> stream_dec_not_Inr stream_dec_enc_Inl <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream_enc.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> m I<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> stream_enc_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_enc <span class="main">(</span>dec_word <span class="main">(</span>stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> stream_dec <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">}</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> stream_enc_dec<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smap2_alt sdrop_snth shift_snth <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> stream_enc_unique<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smap2_szip stream.set_map<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_word <span class="skolem">n</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wf_word <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> enc_set_σ <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FLess <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">using</span></span> m I<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps stream_enc.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span>dec_word <span class="var">?x</span><span class="main">,</span> stream_dec <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">}</span> <span class="var">?x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps stream_enc.simps<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream_enc.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream_enc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> I<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> FIn <span class="skolem">m</span> <span class="skolem">M</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> x_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> map <span class="main">(</span>case_prod <span class="main">(</span>enc_atom <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="skolem">x</span><span class="main">]</span> <span class="main">(</span>stake <span class="main">(</span>length <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">@-</span> sconst any<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> encD<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> FIn<span class="main">(</span>1<span class="main">)</span> *<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">M</span> <span class="main">=</span> Inr <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_set_conv_all_nth <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> FIn<span class="main">(</span>1<span class="main">)</span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> p_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream_enc.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans_less_add1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> less_length_cut_same_Inl<span class="main"><span class="main">]</span></span>
        trans_less_add1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bspec<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> less_length_cut_same_Inr<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> enc_atom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">!</span> <span class="skolem">p</span> <span class="main">=</span> enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="main">(</span><span class="main">(</span><span class="skolem">w</span> <span class="main">@-</span> sconst any<span class="main">)</span> <span class="main">!!</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> enc_atom <span class="main">_</span> <span class="main">_</span> <span class="var">?p</span>"</span></span><span class="main">)</span>
            <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">!</span> <span class="bound">p</span> <span class="main">=</span> enc_atom <span class="skolem">I</span> <span class="bound">p</span> <span class="main">(</span><span class="main">(</span><span class="skolem">w</span> <span class="main">@-</span> sconst any<span class="main">)</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Ball <span class="main">_</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">_</span> <span class="main">=</span> enc_atom <span class="main">_</span> <span class="main">_</span> <span class="main">(</span><span class="var">?P</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> x_alt<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>1<span class="main">)</span> p_less<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> take <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="var">?p</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> FIn<span class="main">(</span>1<span class="main">)</span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>enc_atom <span class="skolem">I</span> <span class="skolem">p</span> <span class="var">?p</span><span class="main">]</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except2 <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> enc_atom_lang_Arbitrary_Except2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_snth<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp.Not Zero<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> x_alt<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_zip shift_snth <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_takeD<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="skolem">p</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp.Not Zero<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> x_alt<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_zip shift_snth <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_atom_σ <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_dropD<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps<span class="main">(</span>6<span class="main">,</span>9<span class="main">)</span> rexp_of_list.simps Int_Diff lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FIn<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ssubst <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply append.simps lang.simps enc.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> FIn <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FIn<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> stream_enc<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">=</span> <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> stream_enc_enc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> I FIn <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">!</span> <span class="skolem">M</span> <span class="main">=</span> Inr <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">&lt;</span> length <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span>dec_word <span class="var">?x</span><span class="main">,</span> stream_dec <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span> <span class="var">?x</span><span class="main">)</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> enc_wf_interp<span class="main">[</span><span class="operator">OF</span> FIn<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> I<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u1</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">u2</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>Atom <span class="main">(</span>Arbitrary_Except2 <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps rexp_of_list.simps <span class="keyword1"><span class="command">using</span></span> concE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> FIn<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u2</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">v</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">v</span> <span class="main">!</span> <span class="skolem">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">v</span> <span class="main">∈</span> set <span class="free">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Arbitrary_Except2D<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">M</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">u1</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> length <span class="skolem">u1</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> m I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> enc_Inl <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> m I <span class="keyword1"><span class="command">have</span></span> ex1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> snd <span class="main">(</span>stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> stream_enc_unique<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> length <span class="skolem">u1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> stream_enc <span class="keyword1"><span class="command">using</span></span> u I<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">!</span> length <span class="skolem">u1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> v<span class="main">(</span>3<span class="main">)</span> m<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> u I<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">u1</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_Inr <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * m I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dec_word <span class="var">?x</span><span class="main">,</span> stream_dec <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span> <span class="var">?x</span><span class="main">)</span> <span class="main">⊨</span> FIn <span class="skolem">m</span> <span class="skolem">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stream_enc_enc<span class="main">[</span><span class="operator">OF</span> _ I<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream_enc.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> stream_dec_not_Inr stream_dec_not_Inl
        stream_dec_enc_Inl stream_dec_enc_Inr <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> m I<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> stream_enc_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_enc <span class="main">(</span>dec_word <span class="main">(</span>stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> stream_dec <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> stream_enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> stream_enc_dec<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smap2_alt sdrop_snth shift_snth <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> stream_enc_unique<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smap2_szip stream.set_map<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_word <span class="skolem">n</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wf_word <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> enc_set_σ <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FIn <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">using</span></span> m I<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps stream_enc.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span>dec_word <span class="var">?x</span><span class="main">,</span> stream_dec <span class="skolem">n</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span> <span class="var">?x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps stream_enc.simps<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream_enc.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream_enc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> I<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FOr<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FOr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> FOr<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FOr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_FOr<span class="main">[</span><span class="operator">OF</span> FOr<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FOr<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> rexp_of.simps lang.simps IH1 IH2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> or<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FOr<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> rexp_of.simps lang.simps IH1 IH2 Int_Diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disj_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> impI impI<span class="main"><span class="main">]</span></span> or<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> I FOr<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def I<span class="main">(</span>1<span class="main">)</span> wf_interp_for_formula_FOr
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_welldef<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> I FOr<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def I<span class="main">(</span>1<span class="main">)</span> wf_interp_for_formula_FOr
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_welldef<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> I <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FAnd<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FAnd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> FAnd<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FAnd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_FAnd<span class="main">[</span><span class="operator">OF</span> FAnd<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FAnd<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> rexp_of.simps rexp_of_list.simps lang.simps IH1 IH2 Int_assoc
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>rexp_of <span class="skolem">n</span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted">"and"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FAnd<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> rexp_of.simps rexp_of_list.simps lang.simps IH1 IH2 Int_Diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> conj_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> impI impI<span class="main"><span class="main">]</span></span> <span class="quoted">"and"</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> I FAnd<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def I<span class="main">(</span>1<span class="main">)</span> wf_interp_for_formula_FAnd
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_welldef<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> I FAnd<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def I<span class="main">(</span>1<span class="main">)</span> wf_interp_for_formula_FAnd
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enc_welldef<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> I <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="skolem">n</span> <span class="skolem">φ</span> <span class="main">=</span>  lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> enc_welldef<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">,</span> <span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ _ _ *<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> FNot<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> *<span class="main">(</span>3<span class="main">)</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> unsat <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps lang.simps <span class="keyword1"><span class="command">using</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FNot<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> enc_set_σ<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="skolem">n</span> <span class="main">(</span>ENC <span class="skolem">n</span> <span class="main">(</span>FOV <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> FNot<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> FNot <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> x * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>set <span class="keyword1">o</span> σ <span class="free">Σ</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def set_n_lists image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FExists<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="skolem">n</span> <span class="main">(</span>Pr <span class="main">(</span>rexp_of <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_rexp_of<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> lang_quot <span class="main">=</span> lang_samequot_exec<span class="main">[</span><span class="operator">OF</span> wf σ<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> FExists<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?L</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> FExists<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def nth_Cons' <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang_quot <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply enc.simps <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SAMEQUOT_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> image_mono<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="var">?L</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> fin_cut_same <span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span> <span class="main">(</span>map π <span class="skolem">x'</span><span class="main">)</span> <span class="main">@</span> replicate <span class="skolem">m</span> <span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang_quot SAMEQUOT_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> FExists<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> equalityD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FExists<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I'</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I'</span> <span class="main">=</span> <span class="skolem">I<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">I'</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> FExists<span class="main">(</span>2<span class="main">)</span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> Inl <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> FExists <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FExists<span class="main">(</span>2<span class="main">)</span> fin_cut_same_tl<span class="main">[</span><span class="operator">OF</span> ex_Loop_stream_enc<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>set <span class="keyword1">o</span> σ <span class="free">Σ</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def set_n_lists image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FEXISTS<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="skolem">n</span> <span class="main">(</span>Pr <span class="main">(</span>rexp_of <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_rexp_of<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> lang_quot <span class="main">=</span> lang_samequot_exec<span class="main">[</span><span class="operator">OF</span> wf σ<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> FEXISTS<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?L</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> FEXISTS<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def nth_Cons' <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang_quot <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply enc.simps <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SAMEQUOT_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> image_mono<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="skolem">n</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="var">?L</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> fin_cut_same <span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span> <span class="main">(</span>map π <span class="skolem">x'</span><span class="main">)</span> <span class="main">@</span> replicate <span class="skolem">m</span> <span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang_quot SAMEQUOT_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply enc.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> FEXISTS<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> equalityD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FEXISTS<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I'</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I'</span> <span class="main">=</span> <span class="skolem">I<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">I'</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> FEXISTS<span class="main">(</span>2<span class="main">)</span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> Inr <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⊨</span> FEXISTS <span class="skolem">φ</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> FEXISTS<span class="main">(</span>2<span class="main">)</span> fin_cut_same_tl<span class="main">[</span><span class="operator">OF</span> ex_Loop_stream_enc<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' π_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="skolem">n</span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-wf_rexp_of_alt"><span class="command">lemma</span></span> wf_rexp_of_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>rexp_of_alt <span class="free">n</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_samequot_exec wf_rexp_ENC<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_idx_vars finite_FOV<span class="main">)</span>

<span class="keyword1" id="WS1S-wf_rexp_of'"><span class="command">lemma</span></span> wf_rexp_of'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>rexp_of' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rexp_of'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_idx_vars <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_rexp_of_alt wf_rexp_ENC<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_FOV<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="WS1S-wf_rexp_of_alt'"><span class="command">lemma</span></span> wf_rexp_of_alt'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>rexp_of_alt' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_samequot_exec wf_rexp_ENC<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_idx_vars finite_FOV<span class="main">)</span>

<span class="keyword1" id="WS1S-wf_rexp_of''"><span class="command">lemma</span></span> wf_rexp_of''<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">n</span> <span class="main">(</span>rexp_of'' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rexp_of''_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_rexp_ENC wf_rexp_of_alt' finite_FOV max_idx_vars<span class="main">)</span>


<span class="keyword1" id="WS1S-ENC_FNot"><span class="command">lemma</span></span> ENC_FNot<span class="main">:</span> <span class="quoted"><span class="quoted">"ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FNot <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ENC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-ENC_FAnd"><span class="command">lemma</span></span> ENC_FAnd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FAnd <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FAnd <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FAnd <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FAnd <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FAnd <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_interp_for_formula_FAnd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf2<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="WS1S-ENC_FOr"><span class="command">lemma</span></span> ENC_FOr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_interp_for_formula_FOr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf2<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-ENC_FExists"><span class="command">lemma</span></span> ENC_FExists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  SAMEQUOT <span class="main">(</span>any<span class="main">,</span> replicate <span class="free">n</span> False<span class="main">)</span> <span class="main">(</span>map π <span class="main">`</span> lang <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> I<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_interp_for_formula_FExists<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">[</span></span><span class="operator">folded</span> I<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> I<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> I<span class="main">(</span>1<span class="main">)</span> tl_enc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Inl <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="skolem">I</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span> 
      <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ SAMEQUOT_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> image_mono<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> FOV <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> SAMEQUOT <span class="main">(</span>any<span class="main">,</span> replicate <span class="free">n</span> False<span class="main">)</span> <span class="main">(</span>map π <span class="main">`</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> SAMEQUOT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">∈</span> FOV <span class="free">φ</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">I'</span></span> <span class="keyword2"><span class="keyword">where</span></span> I'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> Inl <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">I'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">I</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> I <span class="keyword1"><span class="command">have</span></span> wtlI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I'</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tl_enc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Inl <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">(</span>FExists <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_interp_for_formula_FExists<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">[</span></span><span class="operator">folded</span> wtlI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
          wf_interp_for_formula_any_Inl<span class="main">[</span><span class="operator">OF</span> I<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> I'<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> wtlI <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-ENC_FEXISTS"><span class="command">lemma</span></span> ENC_FEXISTS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span>FOV <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  SAMEQUOT <span class="main">(</span>any<span class="main">,</span> replicate <span class="free">n</span> False<span class="main">)</span> <span class="main">(</span>map π <span class="main">`</span> lang <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>FOV <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> I<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_interp_for_formula_FEXISTS<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">[</span></span><span class="operator">folded</span> I<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> I<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> I<span class="main">(</span>1<span class="main">)</span> tl_enc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Inr <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="skolem">I</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps<span class="main">)</span> 
      <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ SAMEQUOT_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> image_mono<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> SOV <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> SAMEQUOT <span class="main">(</span>any<span class="main">,</span> replicate <span class="free">n</span> False<span class="main">)</span> <span class="main">(</span>map π <span class="main">`</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> SAMEQUOT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">∈</span> SOV <span class="free">φ</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">I'</span></span> <span class="keyword2"><span class="keyword">where</span></span> I'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> Inr <span class="skolem">P</span> <span class="main">#</span> <span class="skolem">I'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">I</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> I <span class="keyword1"><span class="command">have</span></span> wtlI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">I'</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tl_enc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Inr <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_interp_for_formula <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I'</span><span class="main">)</span> <span class="main">(</span>FEXISTS <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_interp_for_formula_FEXISTS<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">[</span></span><span class="operator">folded</span> wtlI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
          wf_interp_for_formula_any_Inr<span class="main">[</span><span class="operator">OF</span> I<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> I'<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> wtlI <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC_formula<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-lang"><span class="command">lemma</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of_rexp_of'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>rexp_of <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>rexp_of' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rexp_of'_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> FNot.IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps rexp_of_alt.simps lang.simps ENC_FNot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> FAnd.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> FAnd.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ENC_FAnd<span class="main">[</span><span class="operator">OF</span> FAnd.prems<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps rexp_of_alt.simps lang.simps rexp_of_list.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> FOr.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> FOr.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ENC_FOr<span class="main">[</span><span class="operator">OF</span> FOr.prems<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps rexp_of_alt.simps lang.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FExists<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>rexp_of <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span>
    lang <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Inter <span class="main">(</span>rexp_of_alt <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>FOV <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FExists.IH<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>set <span class="keyword1">o</span> σ <span class="free">Σ</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def set_n_lists image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FExists<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="skolem">n</span> <span class="main">(</span>Pr <span class="main">(</span>rexp.Inter <span class="main">(</span>rexp_of_alt <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>FOV <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf <span class="skolem">n</span> <span class="main">(</span>Pr <span class="main">(</span>rexp_of <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_idx_vars <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_rexp_of wf_rexp_of_alt wf_rexp_ENC<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_FOV<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">note</span></span> lang_quot <span class="main">=</span> lang_samequot_exec<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> σ<span class="main">]</span> lang_samequot_exec<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> σ<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps rexp_of_alt.simps lang.simps IH lang_quot Suc_eq_plus1
    ENC_FExists<span class="main">[</span><span class="operator">OF</span> FExists.prems<span class="main">,</span> <span class="operator">unfolded</span> Suc_eq_plus1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SAMEQUOT_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FEXISTS<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>rexp_of <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span>
    lang <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Inter <span class="main">(</span>rexp_of_alt <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>FOV <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FEXISTS.IH<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>set <span class="keyword1">o</span> σ <span class="free">Σ</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def set_n_lists image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FEXISTS<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="skolem">n</span> <span class="main">(</span>Pr <span class="main">(</span>rexp.Inter <span class="main">(</span>rexp_of_alt <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>FOV <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf <span class="skolem">n</span> <span class="main">(</span>Pr <span class="main">(</span>rexp_of <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_idx_vars <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_rexp_of wf_rexp_of_alt wf_rexp_ENC<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_FOV<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">note</span></span> lang_quot <span class="main">=</span> lang_samequot_exec<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> σ<span class="main">]</span> lang_samequot_exec<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> σ<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rexp_of.simps rexp_of_alt.simps lang.simps IH lang_quot Suc_eq_plus1
    ENC_FEXISTS<span class="main">[</span><span class="operator">OF</span> FEXISTS.prems<span class="main">,</span> <span class="operator">unfolded</span> Suc_eq_plus1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SAMEQUOT_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-SAMEQUTO_UN"><span class="command">lemma</span></span> SAMEQUTO_UN<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"SAMEQUOT <span class="free">x</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">B</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> SAMEQUOT <span class="free">x</span> <span class="main">(</span><span class="free">B</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SAMEQUOT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-finite_positions_in_row"><span class="command">lemma</span></span> finite_positions_in_row<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> finite <span class="main">(</span>positions_in_row <span class="main">(</span><span class="free">x</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="free">n</span> False<span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> positions_in_row shift_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-fin_cut_same_snoc"><span class="command">lemma</span></span> fin_cut_same_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"fin_cut_same <span class="free">x</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">then</span> fin_cut_same <span class="free">x</span> <span class="free">xs</span> <span class="keyword1">else</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-fin_cut_same_idem"><span class="command">lemma</span></span> fin_cut_same_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"fin_cut_same <span class="free">x</span> <span class="main">(</span>fin_cut_same <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> fin_cut_same <span class="free">x</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-cut_same_sconst"><span class="command">lemma</span></span> cut_same_sconst<span class="main">:</span> <span class="quoted"><span class="quoted">"cut_same <span class="free">x</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> sconst <span class="free">x</span><span class="main">)</span> <span class="main">=</span> fin_cut_same <span class="free">x</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> id_apply <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fin_cut_same_snoc sconst_collapse<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> id_apply<span class="main">)</span>

<span class="keyword1" id="WS1S-length_cut_same"><span class="command">lemma</span></span> length_cut_same<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>cut_same <span class="free">x</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> sdrop <span class="bound">n</span> <span class="free">s</span> <span class="main">=</span> sconst <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cut_same_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="WS1S-enc_alt"><span class="command">lemma</span></span> enc_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_interp <span class="free">w</span> <span class="free">I</span> <span class="main">⟹</span>
  <span class="free">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">@-</span> sconst <span class="main">(</span><span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span> <span class="main">=</span> stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> enc.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> shift_append shift_replicate_sconst stream_enc_cut_same<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
    length_append length_replicate length_cut_same sdrop_shift drop_all diff_self_eq_0
    shift.simps sdrop.simps
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sym<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> shift_sconst_inj<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> Least_le
      exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">-</span> length <span class="main">(</span>cut_same <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I</span><span class="main">)</span> False<span class="main">)</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
      le_add_diff_inverse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>

<span class="keyword1" id="WS1S-stream_stream_eqI"><span class="command">lemma</span></span> stream_stream_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> sset <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> sset <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span>
  smap <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> hd <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> smap <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> hd <span class="bound">x</span><span class="main">)</span> <span class="free">ys</span><span class="main">;</span> smap π <span class="free">xs</span> <span class="main">=</span> smap π <span class="free">ys</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Eq_stream
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> stream.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> stream.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SCons_SCons <span class="skolem">h1</span> <span class="skolem">t1</span> <span class="skolem">h2</span> <span class="skolem">t2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Eq_stream <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">h1</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">h2</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> list.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> π_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-project_enc_extend"><span class="command">lemma</span></span> project_enc_extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">I</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≡</span> length <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>any<span class="main">,</span> replicate <span class="bound">n</span> False<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">I'</span> <span class="main">≡</span> Inr <span class="main">(</span>positions_in_row <span class="main">(</span><span class="free">x</span> <span class="main">@-</span> sconst <span class="main">(</span><span class="free">z</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">#</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_interp <span class="free">w</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> enc<span class="main">:</span> <span class="quoted"><span class="quoted">"fin_cut_same <span class="main">(</span><span class="free">z</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>map π <span class="free">x</span><span class="main">)</span> <span class="main">@</span> replicate <span class="free">m</span> <span class="main">(</span><span class="free">z</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"π <span class="main">(</span><span class="free">z</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> z_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">z</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">(</span>any<span class="main">,</span> replicate <span class="bound">n</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> π_def z_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> wf'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_interp <span class="free">w</span> <span class="free">I'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf I'_def z_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> replicate_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> stream_enc.simps
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> enc_alt<span class="main">[</span><span class="operator">OF</span> wf'<span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> stream_stream_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> nonempty stream_smap_nats<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> hd <span class="bound">y</span><span class="main">)</span> <span class="free">x</span> <span class="main">@-</span> sconst False"</span></span><span class="main">]</span>
      smap_szip_fst
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> hd <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I'</span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      smap <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> hd <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream_enc.simps I'_def z_def smap2_szip stream.map_comp o_def split_def
        positions_in_row shift_snth hd_conv_nth <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> smap_szip_fst<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> stream.map_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fin_cut_same <span class="main">(</span><span class="free">z</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>map π <span class="free">x</span><span class="main">)</span> <span class="main">=</span> cut_same <span class="main">(</span><span class="free">z</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stream_enc_enc<span class="main">[</span><span class="operator">OF</span> _ enc<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cut_same_sconst z_def n_def fin_cut_same_idem<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> πx<span class="main">:</span> <span class="quoted"><span class="quoted">"map π <span class="free">x</span> <span class="main">=</span> cut_same <span class="main">(</span><span class="free">z</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> replicate <span class="skolem">m'</span> <span class="main">(</span><span class="free">z</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fin_cut_sameE<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"smap π <span class="main">(</span><span class="free">x</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>length <span class="free">I'</span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      smap π <span class="main">(</span>stream_enc <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> replicate_Suc <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> z_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> I'_def
        stream_enc_cut_same<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> n_def z_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> nonempty<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream_enc.simps I'_def split_beta smap2_szip stream.set_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-pred_case_conv"><span class="command">lemma</span></span> pred_case_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Suc <span class="bound">m</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-in_pred_image_iff"><span class="command">lemma</span></span> in_pred_image_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_case_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1" id="WS1S-map_project_Int_ENC"><span class="command">lemma</span></span> map_project_Int_ENC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="free">Z</span> <span class="free">n</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≡</span> <span class="main">(</span>any<span class="main">,</span> replicate <span class="free">n</span> False<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">⊆</span> lists <span class="main">(</span><span class="main">(</span>set <span class="keyword1">o</span> σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SAMEQUOT <span class="free">z</span> <span class="main">(</span>map π <span class="main">`</span> <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> lang <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    SAMEQUOT <span class="free">z</span> <span class="main">(</span>map π <span class="main">`</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span> <span class="main">-</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fX</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fY</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SAMEQUOT_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> subset_trans<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> image_Int_subset Int_lower1<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> SAMEQUOT <span class="free">z</span> <span class="main">(</span>map π <span class="main">`</span> <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> lang <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> SAMEQUOT <span class="free">z</span> <span class="main">(</span>map π <span class="main">`</span> lang <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ SAMEQUOT_mono<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> subset_refl<span class="main">]</span> lang_ENC<span class="main">[</span><span class="operator">OF</span> * subset_refl<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Union z_def length_Suc_conv <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> enc.simps
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"enc <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">w</span> <span class="skolem">I</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> conjI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span></span> <span class="skolem">x</span> <span class="skolem">A</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons image_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> SAMEQUOT <span class="free">z</span> <span class="main">(</span>map π <span class="main">`</span> <span class="free">Z</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> SAMEQUOT <span class="free">z</span> <span class="main">(</span>map π <span class="main">`</span> <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> lang <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span>  z_def SAMEQUOT_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> πx<span class="main">:</span> <span class="quoted"><span class="quoted">"fin_cut_same <span class="main">(</span>any<span class="main">,</span> replicate <span class="free">n</span> False<span class="main">)</span> <span class="main">(</span>map π <span class="skolem">x</span><span class="main">)</span> <span class="main">@</span>
       replicate <span class="skolem">m</span> <span class="main">(</span>any<span class="main">,</span> replicate <span class="free">n</span> False<span class="main">)</span> <span class="main">∈</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">Z</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map π <span class="skolem">x</span> <span class="main">∈</span> map π <span class="main">`</span> <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> lang <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> imageI IntI<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">Z</span>›</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> πx assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lang <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lang_ENC<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> subset_refl<span class="main">]</span> lang_ENC<span class="main">[</span><span class="operator">OF</span> * subset_refl<span class="main">]</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> UnionI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ project_enc_extend<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> CollectI exI conjI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">+</span> nat set<span class="main">)</span> list"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>case_sum <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> True<span class="main">)</span> finite<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>set
             <span class="main">(</span>Inr <span class="main">(</span>positions_in_row <span class="main">(</span><span class="skolem">x</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">#</span><span class="skolem">I</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span>case_sum <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> True<span class="main">)</span> finite<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> replicate_Suc<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_Cons' Ball_def in_pred_image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">Z</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-lang_ENC_split"><span class="command">lemma</span></span> lang_ENC_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">Y1</span> <span class="main">∪</span> <span class="free">Y2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="free">Y1</span><span class="main">)</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="free">Y2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ENC_def lang_INTERSECT <span class="keyword1"><span class="command">using</span></span> assms lang_subset_lists<span class="main">[</span><span class="operator">OF</span> wf_rexp_valid_ENC<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S-map_project_ENC"><span class="command">lemma</span></span> map_project_ENC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">⊆</span> lists <span class="main">(</span><span class="main">(</span>set <span class="keyword1">o</span> σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≡</span> <span class="main">(</span>any<span class="main">,</span> replicate <span class="free">n</span> False<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SAMEQUOT <span class="free">z</span> <span class="main">(</span>map π <span class="main">`</span> <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> lang <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">X</span>
    <span class="keyword1">then</span> SAMEQUOT <span class="free">z</span> <span class="main">(</span>map π <span class="main">`</span> <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> lang <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> SAMEQUOT <span class="free">z</span> <span class="main">(</span>map π <span class="main">`</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∩</span> lang <span class="free">n</span> <span class="main">(</span>ENC <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">_</span> <span class="keyword1">then</span> <span class="var">?R1</span> <span class="keyword1">else</span> <span class="var">?R2</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">split</span> if_splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> finite_subset <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">X</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> map_project_Int_ENC<span class="main">[</span><span class="operator">OF</span> 0 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> lists_image<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> π_σ
      Int_absorb1<span class="main">[</span><span class="operator">OF</span> lang_subset_lists<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_rexp_ENC<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span>
      Int_absorb1<span class="main">[</span><span class="operator">OF</span> lang_subset_lists<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_rexp_ENC<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> z_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> finite_subset <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">X</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> SAMEQUOT <span class="free">z</span> <span class="main">(</span>map π <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> lang <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> lang <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Int_assoc z_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lang_ENC_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin X<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?R1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> z_def
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_project_Int_ENC<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WS1S-lang"><span class="command">lemma</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of'_rexp_of''<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>rexp_of' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>rexp_of'' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rexp_of'_def rexp_of''_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> FNot.IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rexp_of_alt.simps rexp_of_alt'.simps lang.simps ENC_FNot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> FAnd.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> FAnd.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ENC_FAnd<span class="main">[</span><span class="operator">OF</span> FAnd.prems<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rexp_of_alt.simps rexp_of_alt'.simps lang.simps rexp_of_list.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="skolem">n</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> FOr.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf1<span class="main">]</span> FOr.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ENC_FOr<span class="main">[</span><span class="operator">OF</span> FOr.prems<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rexp_of_alt.simps rexp_of_alt'.simps lang.simps rexp_of_list.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> FOV <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> max_idx_vars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">]</span> wf_rexp_of_alt'<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rexp_of_alt.simps rexp_of_alt'.simps lang.simps Suc_eq_plus1
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> lang_samequot_exec<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SAMEQUOT <span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span>
          <span class="main">(</span>lang <span class="skolem">n</span> <span class="main">(</span>Pr <span class="main">(</span>Inter <span class="main">(</span>rexp_of_alt <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>FOV <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span>
          lang <span class="skolem">n</span> <span class="main">(</span>ENC <span class="skolem">n</span> <span class="main">(</span>FOV <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        SAMEQUOT <span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span>
          <span class="main">(</span>lang <span class="skolem">n</span> <span class="main">(</span>Pr <span class="main">(</span>Inter <span class="main">(</span>rexp_of_alt' <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span>
          lang <span class="skolem">n</span> <span class="main">(</span>ENC <span class="skolem">n</span> <span class="main">(</span>FOV <span class="main">(</span>FExists <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wf 0 max_idx_vars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">]</span> wf_rexp_of_alt'<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> lang.simps FExists.IH<span class="main">[</span><span class="operator">OF</span> wf<span class="main">,</span> <span class="operator">unfolded</span> lang.simps<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> map_project_ENC<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lang_subset_lists<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_rexp_of_alt finite_FOV wf_rexp_ENC<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> FOV <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> max_idx_vars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">]</span> wf_rexp_of_alt'<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rexp_of_alt.simps rexp_of_alt'.simps lang.simps Suc_eq_plus1
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> lang_samequot_exec<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SAMEQUOT <span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span>
          <span class="main">(</span>lang <span class="skolem">n</span> <span class="main">(</span>Pr <span class="main">(</span>Inter <span class="main">(</span>rexp_of_alt <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>ENC <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>FOV <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span>
          lang <span class="skolem">n</span> <span class="main">(</span>ENC <span class="skolem">n</span> <span class="main">(</span>FOV <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        SAMEQUOT <span class="main">(</span>any<span class="main">,</span> replicate <span class="skolem">n</span> False<span class="main">)</span>
          <span class="main">(</span>lang <span class="skolem">n</span> <span class="main">(</span>Pr <span class="main">(</span>rexp_of_alt' <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span>
          lang <span class="skolem">n</span> <span class="main">(</span>ENC <span class="skolem">n</span> <span class="main">(</span>FOV <span class="main">(</span>FEXISTS <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wf 0 max_idx_vars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">]</span> wf_rexp_of_alt'<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> lang.simps FEXISTS.IH<span class="main">[</span><span class="operator">OF</span> wf<span class="main">,</span> <span class="operator">unfolded</span> lang.simps<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> map_project_ENC<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lang_subset_lists<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_rexp_of_alt finite_FOV wf_rexp_ENC<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">theorem</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">φ</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>rexp_of' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of_rexp_of'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of''<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="free">φ</span> <span class="main">⟹</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">φ</span> <span class="main">=</span> lang <span class="free">n</span> <span class="main">(</span>rexp_of'' <span class="free">n</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>L</sub>_rexp_of'_rexp_of''<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of'<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="WS1S_Normalization">
<div class="head">
<h1>Theory WS1S_Normalization</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Normalization of WS1S Formulas›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> WS1S_Normalization
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#WS1S">WS1S</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nNot</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nNot</span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nNot</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ1</span></span></span> <span class="free"><span class="bound"><span class="entity">φ2</span></span></span><span class="main">)</span> <span class="main">=</span> FOr <span class="main">(</span><span class="free">nNot</span> <span class="free"><span class="bound"><span class="entity">φ1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nNot</span> <span class="free"><span class="bound"><span class="entity">φ2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nNot</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ1</span></span></span> <span class="free"><span class="bound"><span class="entity">φ2</span></span></span><span class="main">)</span> <span class="main">=</span> FAnd <span class="main">(</span><span class="free">nNot</span> <span class="free"><span class="bound"><span class="entity">φ1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nNot</span> <span class="free"><span class="bound"><span class="entity">φ2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nNot</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">norm</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> FQ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> FLess <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> FIn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> FOr <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> FAnd <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> nNot <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FExists <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FEXISTS <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FEXISTS <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> formula
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="WS1S_Normalization-satisfies_nNot"><span class="command">lemma</span></span> satisfies_nNot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">⊨</span> nNot <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">⊨</span> FNot <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nNot.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S_Normalization-FOV_nNot"><span class="command">lemma</span></span> FOV_nNot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"FOV <span class="main">(</span>nNot <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> FOV <span class="main">(</span>FNot <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nNot.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S_Normalization-SOV_nNot"><span class="command">lemma</span></span> SOV_nNot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"SOV <span class="main">(</span>nNot <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> SOV <span class="main">(</span>FNot <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nNot.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S_Normalization-pre_wf_formula_nNot"><span class="command">lemma</span></span> pre_wf_formula_nNot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pre_wf_formula <span class="free">n</span> <span class="main">(</span>nNot <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> pre_wf_formula <span class="free">n</span> <span class="main">(</span>FNot <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nNot.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S_Normalization-FOV_norm"><span class="command">lemma</span></span> FOV_norm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"FOV <span class="main">(</span>norm <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> FOV <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S_Normalization-SOV_norm"><span class="command">lemma</span></span> SOV_norm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"SOV <span class="main">(</span>norm <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> SOV <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S_Normalization-pre_wf_formula_norm"><span class="command">lemma</span></span> pre_wf_formula_norm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pre_wf_formula <span class="free">n</span> <span class="main">(</span>norm <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> pre_wf_formula <span class="free">n</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S_Normalization-satisfies_norm"><span class="command">lemma</span></span> satisfies_norm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wI</span> <span class="main">⊨</span> norm <span class="free">φ</span> <span class="main">⟷</span> <span class="free">wI</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">wI</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="WS1S_Normalization-lang"><span class="command">lemma</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_norm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="main">(</span>norm <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="WS1S_Equivalence_Checking">
<div class="head">
<h1>Theory WS1S_Equivalence_Checking</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deciding Equivalence of WS1S Formulas›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> WS1S_Equivalence_Checking
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Pi_Equivalence_Checking">Pi_Equivalence_Checking</a>
  <a href="#PNormalization">PNormalization</a>
  <a href="#Init_Normalization">Init_Normalization</a>
  <a href="#WS1S_Normalization">WS1S_Normalization</a>
  <a href="#Pi_Regular_Exp_Dual">Pi_Regular_Exp_Dual</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> embed2 <span class="quoted"><span class="quoted">"set <span class="keyword1">o</span> σ <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_atom <span class="free">Σ</span>"</span></span> <span class="quoted">π</span> <span class="quoted">lookup</span> <span class="quoted"><span class="quoted">"ε <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"case_prod Singleton"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder list"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span>
      𝔇 <span class="main">=</span> <span class="quoted"><span class="quoted">"embed.lderiv lookup <span class="main">(</span>ε <span class="free">Σ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Co𝔇 <span class="main">=</span> <span class="quoted"><span class="quoted">"embed.lderiv_dual lookup <span class="main">(</span>ε <span class="free">Σ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> r𝔇 <span class="main">=</span> <span class="quoted"><span class="quoted">"embed.rderiv lookup <span class="main">(</span>ε <span class="free">Σ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> r𝔇_add <span class="main">=</span> <span class="quoted"><span class="quoted">"embed2.rderiv_and_add lookup <span class="main">(</span>ε <span class="free">Σ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> 𝔔 <span class="main">=</span> <span class="quoted"><span class="quoted">"embed2.samequot_exec lookup <span class="main">(</span>ε <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>case_prod Singleton<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def π_def ε_def set_n_lists<span class="main">)</span>

<span class="keyword1" id="WS1S_Equivalence_Checking-enum_not_empty"><span class="command">lemma</span></span> enum_not_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Enum.enum <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?enum</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?enum</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?enum</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> UNIV_enum<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Φ<span class="main">:</span> formula <span class="quoted"><span class="quoted">"Enum.enum <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>enum<span class="main">,</span> linorder<span class="main">}</span> list"</span></span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"embed2.samequot_exec lookup <span class="main">(</span>ε <span class="main">(</span>Enum.enum <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>enum<span class="main">,</span> linorder<span class="main">}</span> list<span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_prod Singleton<span class="main">)</span> <span class="main">=</span> 𝔔 Enum.enum"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span>
      pre_wf_formula <span class="main">=</span> <span class="quoted">Φ.pre_wf_formula</span>
  <span class="keyword2"><span class="keyword">and</span></span> wf_formula <span class="main">=</span> <span class="quoted">Φ.wf_formula</span>
  <span class="keyword2"><span class="keyword">and</span></span> rexp_of <span class="main">=</span> <span class="quoted">Φ.rexp_of</span>
  <span class="keyword2"><span class="keyword">and</span></span> rexp_of_alt <span class="main">=</span> <span class="quoted">Φ.rexp_of_alt</span>
  <span class="keyword2"><span class="keyword">and</span></span> rexp_of_alt' <span class="main">=</span> <span class="quoted">Φ.rexp_of_alt'</span>
  <span class="keyword2"><span class="keyword">and</span></span> rexp_of' <span class="main">=</span> <span class="quoted">Φ.rexp_of'</span>
  <span class="keyword2"><span class="keyword">and</span></span> rexp_of'' <span class="main">=</span> <span class="quoted">Φ.rexp_of''</span>
  <span class="keyword2"><span class="keyword">and</span></span> valid_ENC <span class="main">=</span> <span class="quoted">Φ.valid_ENC</span>
  <span class="keyword2"><span class="keyword">and</span></span> ENC <span class="main">=</span> <span class="quoted">Φ.ENC</span>
  <span class="keyword2"><span class="keyword">and</span></span> dec_interp <span class="main">=</span> <span class="quoted">Φ.stream_dec</span>
  <span class="keyword2"><span class="keyword">and</span></span> any <span class="main">=</span> <span class="quoted">Φ.any</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def π_def 𝔔_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of_norm <span class="main">=</span> trans<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Φ.lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_norm<span class="main"><span class="main">]</span></span> Φ.lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of'_norm <span class="main">=</span> trans<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Φ.lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_norm<span class="main"><span class="main">]</span></span> Φ.lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of'<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of''_norm <span class="main">=</span> trans<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Φ.lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_norm<span class="main"><span class="main">]</span></span> Φ.lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of''<span class="main">]</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Sign.map_naming <span class="main">(</span>Name_Space.mandatory_path <span class="inner_quoted">"slow"</span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> D<span class="main">:</span> rexp_DFA <span class="quoted"><span class="quoted">"σ <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_atom <span class="free">Σ</span>"</span></span> <span class="quoted">π</span> <span class="quoted">lookup</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">«</span>pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">»</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span>"</span></span> <span class="quoted">final</span> <span class="quoted"><span class="quoted">"alphabet.wf <span class="main">(</span>wf_atom <span class="free">Σ</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="quoted">pnorm</span> <span class="quoted"><span class="quoted">"lang <span class="free">Σ</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="free">n</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span>
      test <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.test <span class="main">(</span>final <span class="main">::</span> <span class="tfree">'a</span> atom rexp <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.step <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> pnorm <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> closure <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.closure <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> final pnorm <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> check_eqvRE <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.check_eqv <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">«</span>pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">»</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> final pnorm <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> test_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.test_invariant <span class="main">(</span>final <span class="main">::</span> <span class="tfree">'a</span> atom rexp <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">::</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool list<span class="main">)</span> list <span class="main">×</span> <span class="main">_</span><span class="main">)</span> list <span class="main">×</span> <span class="main">_</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.step_invariant <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> pnorm <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> closure_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.closure_invariant <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> final pnorm <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> counterexampleRE <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.counterexample <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">«</span>pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">»</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> final pnorm <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.reachable <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">«</span>pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">»</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> pnorm <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> automaton <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.automaton <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">«</span>pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">»</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> pnorm <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> comp_apply
    ACI_norm_wf ACI_norm_lang wf_inorm lang_inorm wf_pnorm lang_pnorm wf_lderiv lang_lderiv
    lang_final finite_fold_lderiv <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lang_subset_lists<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_eqv</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">check_eqv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">⟷</span> wf_formula <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">∧</span>
   slow.check_eqvRE Enum.enum <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">counterexample</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">counterexample</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span>
   map_option <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> dec_interp <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">w</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">(</span>slow.counterexampleRE Enum.enum <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="WS1S_Equivalence_Checking-soundness"><span class="command">lemma</span></span> soundness<span class="main">:</span> <span class="quoted"><span class="quoted">"slow.check_eqv <span class="free">n</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="main">⟹</span> Φ.lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">φ</span> <span class="main">=</span> Φ.lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> slow.D.check_eqv_sound
  sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of''_norm<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of''_norm<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> slow.check_eqv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Φ.wf_rexp_of''<span class="main">)</span>

<span class="keyword1" id="WS1S_Equivalence_Checking-completeness"><span class="command">lemma</span></span> completeness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Φ.lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">φ</span> <span class="main">=</span> Φ.lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_formula <span class="free">n</span> <span class="main">(</span>FOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"slow.check_eqv <span class="free">n</span> <span class="free">φ</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> slow.check_eqv_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> slow.D.check_eqv_complete<span class="main"><span class="main">,</span></span>
                <span class="operator">OF</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of''_norm lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of''_norm<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Φ.wf_rexp_of''<span class="main">)</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Sign.map_naming Name_Space.parent_path›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Sign.map_naming <span class="main">(</span>Name_Space.mandatory_path <span class="inner_quoted">"fast"</span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> D<span class="main">:</span> rexp_DA_no_post <span class="quoted"><span class="quoted">"σ <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_atom <span class="free">Σ</span>"</span></span> <span class="quoted">π</span> <span class="quoted">lookup</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="quoted">final</span> <span class="quoted"><span class="quoted">"alphabet.wf <span class="main">(</span>wf_atom <span class="free">Σ</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">Σ</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="free">n</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span>
      test <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.test <span class="main">(</span>final <span class="main">::</span> <span class="tfree">'a</span> atom rexp <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.step <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> closure <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.closure <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> check_eqvRE <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.check_eqv <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> test_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.test_invariant <span class="main">(</span>final <span class="main">::</span> <span class="tfree">'a</span> atom rexp <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">::</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool list<span class="main">)</span> list <span class="main">×</span> <span class="main">_</span><span class="main">)</span> list <span class="main">×</span> <span class="main">_</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.step_invariant <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> closure_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.closure_invariant <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> counterexampleRE <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.counterexample <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.reachable <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> automaton <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.automaton <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> comp_apply
    ACI_norm_wf ACI_norm_lang wf_inorm lang_inorm wf_pnorm lang_pnorm wf_lderiv lang_lderiv id_apply
    lang_final <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lang_subset_lists<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_eqv</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">check_eqv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">⟷</span> wf_formula <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">∧</span>
   fast.check_eqvRE Enum.enum <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">counterexample</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">counterexample</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span>
   map_option <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> dec_interp <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">w</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">(</span>fast.counterexampleRE Enum.enum <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="WS1S_Equivalence_Checking-soundness"><span class="command">lemma</span></span> soundness<span class="main">:</span> <span class="quoted"><span class="quoted">"fast.check_eqv <span class="free">n</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="main">⟹</span> Φ.lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">φ</span> <span class="main">=</span> Φ.lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fast.D.check_eqv_sound
  sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of''_norm<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of''_norm<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fast.check_eqv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Φ.wf_rexp_of''<span class="main">)</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Sign.map_naming Name_Space.parent_path›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Sign.map_naming <span class="main">(</span>Name_Space.mandatory_path <span class="inner_quoted">"dual"</span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> D<span class="main">:</span> rexp_DA_no_post <span class="quoted"><span class="quoted">"σ <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_atom <span class="free">Σ</span>"</span></span> <span class="quoted">π</span> <span class="quoted">lookup</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm_dual <span class="main">(</span>rexp_dual_of <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="quoted">final_dual</span>
  <span class="quoted"><span class="quoted">"alphabet.wf_dual <span class="main">(</span>wf_atom <span class="free">Σ</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"lang_dual <span class="free">Σ</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="free">n</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span>
      test <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.test <span class="main">(</span>final_dual <span class="main">::</span> <span class="tfree">'a</span> atom rexp_dual <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.step <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> closure <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.closure <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final_dual id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> check_eqvRE <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.check_eqv <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm_dual <span class="main">(</span>rexp_dual_of <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final_dual id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> test_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.test_invariant <span class="main">(</span>final_dual <span class="main">::</span> <span class="tfree">'a</span> atom rexp_dual <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">::</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> bool list<span class="main">)</span> list <span class="main">×</span> <span class="main">_</span><span class="main">)</span> list <span class="main">×</span> <span class="main">_</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.step_invariant <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> closure_invariant <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.closure_invariant <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final_dual id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> counterexampleRE <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.counterexample <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm_dual <span class="main">(</span>rexp_dual_of <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> final_dual id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.reachable <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm_dual <span class="main">(</span>rexp_dual_of <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> automaton <span class="main">=</span> <span class="quoted"><span class="quoted">"rexp_DA.automaton <span class="main">(</span>σ <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pnorm_dual <span class="main">(</span>rexp_dual_of <span class="main">(</span>inorm <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm_dual <span class="main">(</span>Co𝔇 <span class="free">Σ</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> comp_apply id_apply
    wf_inorm lang_inorm
    wf_dual_pnorm_dual lang_dual_pnorm_dual
    wf_dual_rexp_dual_of lang_dual_rexp_dual_of
    wf_dual_lderiv_dual lang_dual_lderiv_dual
    lang_dual_final_dual <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lang_dual_subset_lists<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_eqv</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">check_eqv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">⟷</span> wf_formula <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">∧</span>
   dual.check_eqvRE Enum.enum <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">counterexample</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">counterexample</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span>
   map_option <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> dec_interp <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOV <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">w</span> <span class="main">@-</span> sconst <span class="main">(</span>any<span class="main">,</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">(</span>dual.counterexampleRE Enum.enum <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rexp_of'' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="WS1S_Equivalence_Checking-soundness"><span class="command">lemma</span></span> soundness<span class="main">:</span> <span class="quoted"><span class="quoted">"dual.check_eqv <span class="free">n</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="main">⟹</span> Φ.lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">φ</span> <span class="main">=</span> Φ.lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub> <span class="free">n</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dual.D.check_eqv_sound
  sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of''_norm<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lang<span class="hidden">⇩</span><sub>W</sub><span class="hidden">⇩</span><sub>S</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>S</sub>_rexp_of''_norm<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dual.check_eqv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Φ.wf_rexp_of''<span class="main">)</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Sign.map_naming Name_Space.parent_path›</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="M2L_Examples">
<div class="head">
<h1>Theory M2L_Examples</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">theory</span></span> M2L_Examples
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#M2L_Equivalence_Checking">M2L_Equivalence_Checking</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Char_ord.html">HOL-Library.Char_ord</a>"</span>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Product_Lexorder.html">HOL-Library.Product_Lexorder</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">FALSE</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">FALSE</span> <span class="main">≡</span> FExists <span class="main">(</span>FLess <span class="main">0</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">TRUE</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">TRUE</span> <span class="main">≡</span> FNot FALSE"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">All</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">All</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> FNot <span class="main">(</span>FExists <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">AL</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">AL</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> FNot <span class="main">(</span>FEXISTS <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Imp</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Imp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> FOr <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Iff</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Iff</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> FAnd <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Ball</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ball</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> All <span class="main">(</span>Imp <span class="main">(</span>FIn <span class="main">0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Bex</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Bex</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> FExists <span class="main">(</span>FAnd <span class="main">(</span>FIn <span class="main">0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Eq</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Eq</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> FAnd <span class="main">(</span>FNot <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>FNot <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SUBSET</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SUBSET</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> Ball <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>FIn <span class="main">0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">EQ</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EQ</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> FAnd <span class="main">(</span>SUBSET <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">(</span>SUBSET <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">First</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">First</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> FNot <span class="main">(</span>FExists <span class="main">(</span>FLess <span class="main">0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Last</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Last</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> FNot <span class="main">(</span>FExists <span class="main">(</span>FLess <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Suc</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Suc</span> <span class="free"><span class="bound"><span class="entity">sucx</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> FAnd <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sucx</span></span></span><span class="main">)</span> <span class="main">(</span>FNot <span class="main">(</span>FExists <span class="main">(</span>FAnd <span class="main">(</span>FLess <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>FLess <span class="main">0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sucx</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Thm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">type</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>enum<span class="main">,</span> linorder<span class="main">}</span> itself<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> fast.check_eqv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> formula<span class="main">)</span> FALSE"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Thm_slow</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">type</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>enum<span class="main">,</span> linorder<span class="main">}</span> itself<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> slow.check_eqv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> formula<span class="main">)</span> FALSE"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Thm_dual</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">type</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>enum<span class="main">,</span> linorder<span class="main">}</span> itself<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> dual.check_eqv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> formula<span class="main">)</span> FALSE"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2L</span> <span class="main">=</span> <span class="main">(</span>FEXISTS <span class="main">(</span>All <span class="main">(</span>FIn <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">::</span> Enum.finite_1 formula<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm <span class="keyword1">TYPE</span><span class="main">(</span>Enum.finite_1<span class="main">)</span> <span class="main">0</span> M2L"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm <span class="keyword1">TYPE</span><span class="main">(</span>Enum.finite_1<span class="main">)</span> <span class="main">0</span> <span class="main">(</span>FNot <span class="main">(</span>All <span class="main">(</span>FExists <span class="main">(</span>FLess <span class="main">1</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>bool<span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>FNot <span class="main">(</span>FExists <span class="main">(</span>FExists <span class="main">(</span>FAnd <span class="main">(</span>FLess <span class="main">0</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>FLess <span class="main">1</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1" id="M2L_Examples-Drinker"><span class="command">lemma</span></span> Drinker<span class="main">:</span> <span class="quoted"><span class="quoted">"Thm <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>bool<span class="main">)</span><span class="main">)</span> <span class="main">1</span> <span class="main">(</span>FExists <span class="main">(</span>Imp <span class="main">(</span>FIn <span class="main">0</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>All <span class="main">(</span>FIn <span class="main">0</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>bool<span class="main">)</span><span class="main">)</span> <span class="main">1</span> <span class="main">(</span>Imp <span class="main">(</span>All <span class="main">(</span>FIn <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>FExists <span class="main">(</span>FIn <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="comment1">(*
definition "mod_two a b c d = Iff a (Iff b (Iff c d))"
definition "at_least_two a b c d = Iff d (FOr (FAnd a b) (FOr (FAnd b c) (FAnd a c)))"

definition "ADD S A B = FEXISTS (FAnd (All (Imp (First 0) (FNot (FIn 0 1))))
  (All (FAnd (mod_two (FIn 0 (A+2)) (FIn 0 (B+2)) (FIn 0 1) (FIn 0 (S+2)))
       (Imp (FExists (FAnd (Last 0) (FLess 1 0)))
            (at_least_two (FIn 0 (A+2)) (FIn 0 (B+2)) (FIn 0 1) (All (Imp (Suc 0 1) (FIn 0 2))))))))"

definition Comm_Lemma :: "Enum.finite_1 formula" where
  "Comm_Lemma = AL (AL (FEXISTS (FAnd (ADD 0 1 2) (FEXISTS (FAnd (ADD 0 3 2) (EQ 0 1))))))"

lemma "Thm TYPE(bool) 0 (AL (AL (FEXISTS (ADD 0 1 2))))"
  by eval

lemma "Thm TYPE(Enum.finite_1) 0 Comm_Lemma"
  by eval
*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Globally</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">□</span>_"</span> <span class="main">[</span>40<span class="main">]</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Globally</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">==</span> <span class="main">%</span><span class="bound">n</span><span class="main">.</span> All <span class="main">(</span>Imp <span class="main">(</span>FNot <span class="main">(</span>FLess <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Future</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">◇</span>_"</span> <span class="main">[</span>40<span class="main">]</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Future</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">==</span> <span class="main">%</span><span class="bound">n</span><span class="main">.</span> FExists <span class="main">(</span>FAnd <span class="main">(</span>FNot <span class="main">(</span>FLess <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">IMP</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">IMP</span> <span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="free"><span class="bound"><span class="entity">P2</span></span></span> <span class="main">==</span> <span class="main">%</span><span class="bound">n</span><span class="main">.</span> Imp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P2</span></span></span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">FOR</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> rexp_of_list FOr FALSE <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> FQ <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Φ0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ0</span> <span class="main">≡</span>
  <span class="main">(</span>All <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Φ1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">×</span> bool<span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ1</span> <span class="main">≡</span>
  <span class="main">(</span>All <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">)</span><span class="main">]</span> <span class="main">→</span>
            FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span>
         <span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span>
         <span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Φ2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">×</span> bool <span class="main">×</span> bool<span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ2</span> <span class="main">≡</span> 
  <span class="main">(</span>All <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">,</span> False<span class="main">)</span><span class="main">]</span> <span class="main">→</span>
            FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">]</span> <span class="main">→</span>
            FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span>
        <span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">,</span> False<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span>
        <span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span>
        <span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ψ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Enum.finite_1 formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ψ</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> All <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">□</span><span class="main">(</span>foldr <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> FIn <span class="bound">m</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> FIn <span class="bound">m</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span>
     foldr <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="main">□</span><span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> FIn <span class="bound">m</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span> <span class="main">(</span><span class="main">□</span><span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> FIn <span class="bound">m</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Thm1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Thm <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>Enum.finite_1<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Ψ <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Thm1_slow</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Thm_slow <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>Enum.finite_1<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Ψ <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Thm1_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Thm_dual <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>Enum.finite_1<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Ψ <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm1 <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm1 <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm1 <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>bool<span class="main">)</span><span class="main">)</span> <span class="main">0</span> Φ0"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>bool <span class="main">*</span> bool<span class="main">)</span><span class="main">)</span> <span class="main">0</span> Φ1"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>bool <span class="main">*</span> bool <span class="main">*</span> bool<span class="main">)</span><span class="main">)</span> <span class="main">0</span> Φ2"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="comment1">(*
export_code Thm1 Nat in SML module_name M2L_Thm1 file "M2L_Thm1.ML"
export_code Thm1_slow Nat in SML module_name M2L_Thm1_slow file "M2L_Thm1_slow.ML"
export_code Thm1_dual Nat in SML module_name M2L_Thm1_dual file "M2L_Thm1_dual.ML"

ML_file "M2L_Thm1.ML"
ML_file "M2L_Thm1_slow.ML"
ML_file "M2L_Thm1_dual.ML"

ML {* PolyML.timing true; open M2L_Thm1; thm1 (Nat 0); thm1 (Nat 1); thm1 (Nat 2); thm1 (Nat 3); *}
ML {* PolyML.timing true; open M2L_Thm1_dual; thm1_dual (Nat 0); thm1_dual (Nat 1); thm1_dual (Nat 2); thm1_dual (Nat 3); *}
ML {* PolyML.timing true; open M2L_Thm1_slow; thm1_slow (Nat 0); thm1_slow (Nat 1); thm1_slow (Nat 2); *}
*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="WS1S_Examples">
<div class="head">
<h1>Theory WS1S_Examples</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">theory</span></span> WS1S_Examples
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#WS1S_Equivalence_Checking">WS1S_Equivalence_Checking</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Char_ord.html">HOL-Library.Char_ord</a>"</span>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Product_Lexorder.html">HOL-Library.Product_Lexorder</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">FALSE</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">FALSE</span> <span class="main">≡</span> FExists <span class="main">(</span>FLess <span class="main">0</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">TRUE</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">TRUE</span> <span class="main">≡</span> FNot FALSE"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">All</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">All</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> FNot <span class="main">(</span>FExists <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">AL</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">AL</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> FNot <span class="main">(</span>FEXISTS <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Imp</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Imp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> FOr <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Iff</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Iff</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> FAnd <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Ball</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ball</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> All <span class="main">(</span>Imp <span class="main">(</span>FIn <span class="main">0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Bex</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Bex</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> FExists <span class="main">(</span>FAnd <span class="main">(</span>FIn <span class="main">0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Eq</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Eq</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> FAnd <span class="main">(</span>FNot <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>FNot <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SUBSET</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SUBSET</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> Ball <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>FIn <span class="main">0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">EQ</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EQ</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> FAnd <span class="main">(</span>SUBSET <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">(</span>SUBSET <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">First</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">First</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> FNot <span class="main">(</span>FExists <span class="main">(</span>FLess <span class="main">0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Last</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Last</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> FNot <span class="main">(</span>FExists <span class="main">(</span>FLess <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Suc</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Suc</span> <span class="free"><span class="bound"><span class="entity">sucx</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> FAnd <span class="main">(</span>FLess <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sucx</span></span></span><span class="main">)</span> <span class="main">(</span>FNot <span class="main">(</span>FExists <span class="main">(</span>FAnd <span class="main">(</span>FLess <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>FLess <span class="main">0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sucx</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Thm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">type</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>enum<span class="main">,</span> linorder<span class="main">}</span> itself<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> fast.check_eqv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> formula<span class="main">)</span> FALSE"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Thm_slow</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">type</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>enum<span class="main">,</span> linorder<span class="main">}</span> itself<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> slow.check_eqv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> formula<span class="main">)</span> FALSE"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Thm_dual</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">type</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>enum<span class="main">,</span> linorder<span class="main">}</span> itself<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> dual.check_eqv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> formula<span class="main">)</span> FALSE"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2L</span> <span class="main">=</span> <span class="main">(</span>FEXISTS <span class="main">(</span>All <span class="main">(</span>FIn <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">::</span> Enum.finite_1 formula<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm <span class="keyword1">TYPE</span><span class="main">(</span>Enum.finite_1<span class="main">)</span> <span class="main">0</span> <span class="main">(</span>FNot M2L<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm <span class="keyword1">TYPE</span><span class="main">(</span>Enum.finite_1<span class="main">)</span> <span class="main">0</span> <span class="main">(</span>All <span class="main">(</span>FExists <span class="main">(</span>FLess <span class="main">1</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>bool<span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>FNot <span class="main">(</span>FExists <span class="main">(</span>FExists <span class="main">(</span>FAnd <span class="main">(</span>FLess <span class="main">0</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>FLess <span class="main">1</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1" id="WS1S_Examples-Drinker"><span class="command">lemma</span></span> Drinker<span class="main">:</span> <span class="quoted"><span class="quoted">"Thm <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>bool<span class="main">)</span><span class="main">)</span> <span class="main">1</span> <span class="main">(</span>FExists <span class="main">(</span>Imp <span class="main">(</span>FIn <span class="main">0</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>All <span class="main">(</span>FIn <span class="main">0</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>bool<span class="main">)</span><span class="main">)</span> <span class="main">1</span> <span class="main">(</span>Imp <span class="main">(</span>All <span class="main">(</span>FIn <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>FExists <span class="main">(</span>FIn <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="comment1">(*
definition "mod_two a b c d = Iff a (Iff b (Iff c d))"
definition "at_least_two a b c d = Iff d (FOr (FAnd a b) (FOr (FAnd b c) (FAnd a c)))"

definition "ADD S A B = FEXISTS (FAnd (All (Imp (First 0) (FNot (FIn 0 1))))
  (All (FAnd (mod_two (FIn 0 (A+2)) (FIn 0 (B+2)) (FIn 0 1) (FIn 0 (S+2)))
       (Imp (FExists (FAnd (Last 0) (FLess 1 0)))
            (at_least_two (FIn 0 (A+2)) (FIn 0 (B+2)) (FIn 0 1) (All (Imp (Suc 0 1) (FIn 0 2))))))))"

definition Comm_Lemma :: "Enum.finite_1 formula" where
  "Comm_Lemma = AL (AL (FEXISTS (FAnd (ADD 0 1 2) (FEXISTS (FAnd (ADD 0 3 2) (EQ 0 1))))))"

lemma "Thm TYPE(bool) 0 (AL (AL (FEXISTS (ADD 0 1 2))))"
  by eval

lemma "Thm TYPE(Enum.finite_1) 0 Comm_Lemma"
  by eval
*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Globally</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">□</span>_"</span> <span class="main">[</span>40<span class="main">]</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Globally</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">==</span> <span class="main">%</span><span class="bound">n</span><span class="main">.</span> All <span class="main">(</span>Imp <span class="main">(</span>FNot <span class="main">(</span>FLess <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Future</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">◇</span>_"</span> <span class="main">[</span>40<span class="main">]</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Future</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">==</span> <span class="main">%</span><span class="bound">n</span><span class="main">.</span> FExists <span class="main">(</span>FAnd <span class="main">(</span>FNot <span class="main">(</span>FLess <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">IMP</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">IMP</span> <span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="free"><span class="bound"><span class="entity">P2</span></span></span> <span class="main">==</span> <span class="main">%</span><span class="bound">n</span><span class="main">.</span> Imp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P2</span></span></span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">FOR</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> rexp_of_list FOr FALSE <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> FQ <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Φ0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ0</span> <span class="main">≡</span>
  <span class="main">(</span>All <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Φ1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">×</span> bool<span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ1</span> <span class="main">≡</span>
  <span class="main">(</span>All <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">)</span><span class="main">]</span> <span class="main">→</span>
            FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span>
         <span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span>
         <span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Φ2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">×</span> bool <span class="main">×</span> bool<span class="main">)</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ2</span> <span class="main">≡</span> 
  <span class="main">(</span>All <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">,</span> False<span class="main">)</span><span class="main">]</span> <span class="main">→</span>
            FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">]</span> <span class="main">→</span>
            FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span>
        <span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">,</span> False<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span>
        <span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span>
        <span class="main">(</span><span class="main">□</span><span class="main">(</span>FOR <span class="main">[</span><span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ψ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Enum.finite_1 formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ψ</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> All <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">□</span><span class="main">(</span>foldr <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> FIn <span class="bound">m</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> FIn <span class="bound">m</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span>
     foldr <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="main">□</span><span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> FIn <span class="bound">m</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span> <span class="main">(</span><span class="main">□</span><span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> FIn <span class="bound">m</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Thm1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Thm <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>Enum.finite_1<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Ψ <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Thm1_slow</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Thm_slow <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>Enum.finite_1<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Ψ <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Thm1_dual</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Thm_dual <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>Enum.finite_1<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Ψ <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm1_dual <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm1_dual <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="comment1">(*
lemma "Thm1 2" by eval
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm_dual <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>bool<span class="main">)</span><span class="main">)</span> <span class="main">0</span> Φ0"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm_dual <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span>bool <span class="main">*</span> bool<span class="main">)</span><span class="main">)</span> <span class="main">0</span> Φ1"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="comment1">(*
lemma "Thm (TYPE(bool * bool * bool)) 0 Φ2" by eval
*)</span>

<span class="comment1">(*
export_code Thm1 Nat in SML module_name WS1S_Thm1 file "WS1S_Thm1.ML"
export_code Thm1_slow Nat in SML module_name WS1S_Thm1_slow file "WS1S_Thm1_slow.ML"
export_code Thm1_dual Nat in SML module_name WS1S_Thm1_dual file "WS1S_Thm1_dual.ML"

ML_file "WS1S_Thm1.ML"
ML_file "WS1S_Thm1_slow.ML"
ML_file "WS1S_Thm1_dual.ML"

ML {* PolyML.timing true; open WS1S_Thm1_dual; thm1_dual (Nat 0); thm1_dual (Nat 1); *}
ML {* PolyML.timing true; open WS1S_Thm1; thm1 (Nat 0); thm1 (Nat 1); *}
ML {* PolyML.timing true; open WS1S_Thm1_slow; thm1_slow (Nat 0); *}
*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>