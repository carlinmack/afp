<div id="Multisets_Extras">
<div class="head">
<h1>Theory Multisets_Extras</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Multisets_Extras
   Author: Chelsea Edmonds
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Micellanious Helper Functions on Sets and Multisets›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Multisets_Extras <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span> <span class="quoted">"<a href="../../card_partitions/theories/#Set_Partition">Card_Partitions.Set_Partition</a>"</span>
<span class="quoted">"<a href="../../nested_multisets_ordinals/theories/#Multiset_More">Nested_Multisets_Ordinals.Multiset_More</a>"</span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Disjoint_Sets.html">HOL-Library.Disjoint_Sets</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Set Theory Extras›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A number of extra helper lemmas for reasoning on sets (finite) required for Design Theory 
proofs›</span></span>

<span class="keyword1" id="Multisets_Extras-card_Pow_filter_one"><span class="command">lemma</span></span> card_Pow_filter_one<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> Pow <span class="free">A</span> <span class="main">.</span> card <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>  <span class="main">=</span> card <span class="main">(</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pow <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> Pow <span class="skolem">F</span> <span class="main">∪</span> insert <span class="skolem">x</span> <span class="main">`</span> Pow <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pow_insert<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> Pow <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">.</span> card <span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> 
      <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="main">(</span>Pow <span class="skolem">F</span><span class="main">)</span> <span class="main">.</span> card <span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">`</span> Pow <span class="skolem">F</span><span class="main">)</span> <span class="main">.</span> card <span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">`</span> Pow <span class="skolem">F</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_subset insert.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">`</span> Pow <span class="skolem">F</span><span class="main">)</span> <span class="main">⟹</span> card <span class="bound">y</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_1_singletonE empty_iff image_iff insertCI insertE<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">`</span> Pow <span class="skolem">F</span><span class="main">)</span> <span class="main">.</span> card <span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> empty_iff imageI is_singletonI is_singletonI' is_singleton_altdef <span class="comment1">(* LONG *)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_empty_eq_bot Pow_bottom bot_empty_eq  mem_Collect_eq<span class="main">)</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">`</span> Pow <span class="skolem">F</span><span class="main">)</span> <span class="main">.</span> card <span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> single card_1_singletonE card_eq_0_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> empty_Collect_eq mem_Collect_eq singletonD zero_neq_one<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> split2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> Pow <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">.</span> card <span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="main">(</span>Pow <span class="skolem">F</span><span class="main">)</span> <span class="main">.</span> card <span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> split <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">F</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="main">(</span>Pow <span class="skolem">F</span><span class="main">)</span> <span class="main">.</span> card <span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fact<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> Pow <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">.</span> card <span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> 
        card <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="main">(</span>Pow <span class="skolem">F</span><span class="main">)</span> <span class="main">.</span> card <span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">+</span> card <span class="main">{</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> split2 card_Un_disjoint insert.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> card <span class="skolem">F</span> <span class="main">+</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> False card_insert_disjoint <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 insert.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fact insert.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-elem_exists_non_empty_set"><span class="command">lemma</span></span> elem_exists_non_empty_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms card_gt_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Multisets_Extras-set_self_img_compr"><span class="command">lemma</span></span> set_self_img_compr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span> <span class="main">|</span> <span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="Multisets_Extras-card_subset_not_gt_card"><span class="command">lemma</span></span> card_subset_not_gt_card<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">&gt;</span> card <span class="free">A</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="free">ps</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> card_mono leD <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Multisets_Extras-card_inter_lt_single"><span class="command">lemma</span></span> card_inter_lt_single<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> finite <span class="free">B</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-set_diff_non_empty_not_subset"><span class="command">lemma</span></span> set_diff_non_empty_not_subset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊆</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> <span class="main">¬</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊆</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> a assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-set_card_diff_ge_zero"><span class="command">lemma</span></span> set_card_diff_ge_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> finite <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">≠</span> <span class="free">B</span> <span class="main">⟹</span> card <span class="free">A</span> <span class="main">=</span> card <span class="free">B</span> <span class="main">⟹</span> 
    card <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Diff_eq_empty_iff card_0_eq card_subset_eq finite_Diff neq0_conv<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-set_filter_diff"><span class="command">lemma</span></span> set_filter_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="free">A</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="bound">a</span> <span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-set_filter_diff_card"><span class="command">lemma</span></span> set_filter_diff_card<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="free">A</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="bound">a</span> <span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_filter_diff<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-obtain_subset_with_card_int_n"><span class="command">lemma</span></span> obtain_subset_with_card_int_n<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">::</span>int<span class="main">)</span> <span class="main">≤</span> of_nat <span class="main">(</span>card <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">::</span>int<span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">T</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>card <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">::</span>int<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> obtain_subset_with_card_n assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nonneg_int_cases of_nat_le_iff<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-transform_filter_img_empty_rm"><span class="command">lemma</span></span> transform_filter_img_empty_rm<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟷</span> <span class="var">?f</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_cancel Diff_empty Diff_insert0 insert_Diff<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-bij_betw_inter_subsets"><span class="command">lemma</span></span> bij_betw_inter_subsets<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">a1</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">a2</span> <span class="main">⊆</span> <span class="free">A</span> 
    <span class="main">⟹</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="free">a1</span> <span class="main">∩</span> <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">a1</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">a2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bij_betw_imp_inj_on inj_on_image_Int<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Partition related set theory lemmas›</span></span>

<span class="keyword1" id="Multisets_Extras-partition_on_remove_pt"><span class="command">lemma</span></span> partition_on_remove_pt<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> partition_onI<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms partition_onD3 subset_singletonD <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> un_img<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="main">{</span><span class="var">?f</span> <span class="bound">g</span> <span class="main">|</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">(</span><span class="main">⋃</span> <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">⋃</span> <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> partition_onD1 assms un_img
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">p'</span><span class="main">.</span>
       <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span> <span class="main">⟹</span>
       <span class="bound">p'</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="bound">p'</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">∩</span> <span class="bound">p'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p1</span> <span class="skolem">p2</span>
    <span class="keyword3"><span class="command">assume</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span>"</span></span> 
       <span class="keyword2"><span class="keyword">and</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p2</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">≠</span> <span class="skolem">p2</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p1'</span></span> <span class="skolem"><span class="skolem">p2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> orig1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">=</span> <span class="skolem">p1'</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> orig2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p2</span> <span class="main">=</span> <span class="skolem">p2'</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> 
       <span class="keyword2"><span class="keyword">and</span></span> origne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p1'</span> <span class="main">≠</span> <span class="skolem">p2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ne1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p1'</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ne2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p2'</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ing1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p1'</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> 
       <span class="keyword2"><span class="keyword">and</span></span> ing2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p2'</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p1 p2 <span class="keyword1"><span class="command">using</span></span> mem_Collect_eq ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p1'</span> <span class="main">∩</span> <span class="skolem">p2'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms partition_onD2 ing1 ing2 origne disjointD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">∩</span> <span class="skolem">p2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> orig1 orig2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-partition_on_cart_prod"><span class="command">lemma</span></span> partition_on_cart_prod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span> <span class="main">{</span><span class="bound">g</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> partition_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">g</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> partition_onD3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">{</span><span class="bound">g</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span><span class="main">}</span> <span class="main">=</span> <span class="free">A</span> <span class="main">×</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Setcompr_eq_image Sigma_Union assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> partition_onD1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">g</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">g</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="bound">p'</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">∩</span> <span class="bound">p'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> Sigma_Int_distrib1 Sigma_empty1 assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> mem_Collect_eq partition_onE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Multiset Helpers›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Generic Size, count and card helpers›</span></span>

<span class="keyword1" id="Multisets_Extras-count_size_set_repr"><span class="command">lemma</span></span> count_size_set_repr<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span><span class="main">#}</span> <span class="main">=</span> count <span class="free">A</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_eq_replicate_mset<span class="main">)</span> 

<span class="keyword1" id="Multisets_Extras-mset_nempty_set_nempty"><span class="command">lemma</span></span> mset_nempty_set_nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="main">(</span>set_mset <span class="free">A</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Multisets_Extras-mset_size_ne0_set_card"><span class="command">lemma</span></span> mset_size_ne0_set_card<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="free">A</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> card <span class="main">(</span>set_mset <span class="free">A</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mset_nempty_set_nempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="Multisets_Extras-set_count_size_min"><span class="command">lemma</span></span> set_count_size_min<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="free">A</span> <span class="free">a</span> <span class="main">≥</span> <span class="free">n</span> <span class="main">⟹</span> size <span class="free">A</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> count_le_replicate_mset_subset_eq size_mset_mono size_replicate_mset<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-card_size_filter_eq"><span class="command">lemma</span></span> card_size_filter_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span>  card <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="free">A</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span><span class="main">}</span> <span class="main">=</span> size <span class="main">{#</span><span class="bound">a</span> <span class="main">∈#</span> mset_set <span class="free">A</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Multisets_Extras-size_multiset_int_count"><span class="command">lemma</span></span> size_multiset_int_count<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>card <span class="main">(</span>set_mset <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ca</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> of_nat <span class="main">(</span>count <span class="free">A</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ca2</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>size <span class="free">A</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="main">(</span><span class="free">ca</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">*</span> <span class="free">ca2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">(</span>set_mset <span class="free">A</span><span class="main">)</span> <span class="main">.</span> count <span class="free">A</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> size_multiset_overloaded_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>size <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">(</span>set_mset <span class="free">A</span><span class="main">)</span> <span class="main">.</span> <span class="free">ca2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-mset_union_size"><span class="command">lemma</span></span> mset_union_size<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="free">A</span> <span class="main">∪#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="free">A</span><span class="main">)</span> <span class="main">+</span> size <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_subset_mset_def<span class="main">)</span> 

<span class="keyword1" id="Multisets_Extras-mset_union_size_inter"><span class="command">lemma</span></span> mset_union_size_inter<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="free">A</span> <span class="main">∪#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="free">A</span><span class="main">)</span> <span class="main">+</span> size <span class="free">B</span> <span class="main">-</span> size <span class="main">(</span><span class="free">A</span> <span class="main">∩#</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_add_inverse2 size_Un_Int<span class="main">)</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemmas for repeat\_mset›</span></span>

<span class="keyword1" id="Multisets_Extras-repeat_mset_size"><span class="command">lemma</span></span> repeat_mset_size <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>repeat_mset <span class="free">n</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> size <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Multisets_Extras-repeat_mset_subset_in"><span class="command">lemma</span></span> repeat_mset_subset_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈#</span> repeat_mset <span class="free">n</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" <span class="free">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Multisets_Extras-repeat_mset_not_empty"><span class="command">lemma</span></span> repeat_mset_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> repeat_mset <span class="free">n</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Multisets_Extras-elem_in_repeat_in_original"><span class="command">lemma</span></span> elem_in_repeat_in_original<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> repeat_mset <span class="free">n</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_inI count_repeat_mset in_countE mult.commute mult_zero_left nat.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-elem_in_original_in_repeat"><span class="command">lemma</span></span> elem_in_original_in_repeat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈#</span> repeat_mset <span class="free">n</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Suc_pred repeat_mset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> union_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemmas on image and filter for multisets›</span></span>

<span class="keyword1" id="Multisets_Extras-multiset_add_filter_size"><span class="command">lemma</span></span> multiset_add_filter_size<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">A1</span> <span class="main">+</span> <span class="free">A2</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">#}</span> <span class="main">=</span> size <span class="main">{#</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A1</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">#}</span> <span class="main">+</span> 
    size <span class="main">{#</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A2</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">#}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Multisets_Extras-size_filter_neg"><span class="command">lemma</span></span> size_filter_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">#}</span> <span class="main">=</span> size <span class="free">A</span> <span class="main">-</span> size <span class="main">{#</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> size_filter_mset_lesseq size_union union_filter_mset_complement
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ordered_cancel_comm_monoid_diff_class.le_imp_diff_is_add<span class="main">)</span> 

<span class="keyword1" id="Multisets_Extras-filter_filter_mset_cond_simp"><span class="command">lemma</span></span> filter_filter_mset_cond_simp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filter_mset <span class="free">P</span> <span class="free">A</span> <span class="main">=</span> filter_mset <span class="free">P</span> <span class="main">(</span>filter_mset <span class="free">Q</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter_mset <span class="free">P</span> <span class="main">(</span>filter_mset <span class="free">Q</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> filter_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">a</span><span class="main">)</span> <span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_filter_mset<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> filter_mset_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-filter_filter_mset_ss_member"><span class="command">lemma</span></span> filter_filter_mset_ss_member<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">a</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> 
  filter_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>filter_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">a</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> filter<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>filter_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">a</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> 
    filter_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">a</span> <span class="main">∧</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">a</span><span class="main">)</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_filter_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-multiset_image_do_nothing"><span class="command">lemma</span></span> multiset_image_do_nothing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> image_mset <span class="free">f</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Multisets_Extras-set_mset_filter"><span class="command">lemma</span></span> set_mset_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">{#</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">#}</span> <span class="main">=</span> <span class="main">{</span><span class="free">f</span> <span class="bound">a</span> <span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Setcompr_eq_image<span class="main">)</span>  

<span class="keyword1" id="Multisets_Extras-mset_exists_imply"><span class="command">lemma</span></span> mset_exists_imply<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="main">{#</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">#}</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Multisets_Extras-filter_mset_image_mset"><span class="command">lemma</span></span> filter_mset_image_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"filter_mset <span class="free">P</span> <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> image_mset <span class="free">f</span> <span class="main">(</span>filter_mset <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Multisets_Extras-mset_bunion_filter"><span class="command">lemma</span></span> mset_bunion_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">∨</span> <span class="free">Q</span> <span class="bound">a</span> <span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">#}</span> <span class="main">∪#</span> <span class="main">{#</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">Q</span> <span class="bound">a</span> <span class="main">#}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_eqI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Multisets_Extras-mset_inter_filter"><span class="command">lemma</span></span> mset_inter_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">a</span> <span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">#}</span> <span class="main">∩#</span> <span class="main">{#</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">Q</span> <span class="bound">a</span> <span class="main">#}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_eqI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Multisets_Extras-image_image_mset"><span class="command">lemma</span></span> image_image_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>image_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span> <span class="main">.</span> <span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> 
    image_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Big Union over multiset helpers›</span></span>

<span class="keyword1" id="Multisets_Extras-mset_big_union_obtain"><span class="command">lemma</span></span> mset_big_union_obtain<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Multisets_Extras-size_big_union_sum"><span class="command">lemma</span></span> size_big_union_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span><span class="free">M</span> <span class="main">::</span> <span class="tfree">'a</span> multiset multiset<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span><span class="free">M</span> <span class="main">.</span> size <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Cartesian Product on Multisets›</span></span>

<span class="keyword1" id="Multisets_Extras-size_cartesian_product_singleton"><span class="command">lemma</span></span> size_cartesian_product_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> size <span class="free">B</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Times_mset_single_left<span class="main">)</span>  

<span class="keyword1" id="Multisets_Extras-size_cartesian_product_singleton_right"><span class="command">lemma</span></span> size_cartesian_product_singleton_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> size <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Times_mset_single_right<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-size_cartesian_product_empty"><span class="command">lemma</span></span> size_cartesian_product_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Multisets_Extras-size_add_elem_step_eq"><span class="command">lemma</span></span> size_add_elem_step_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> size <span class="free">A</span> <span class="main">*</span> size <span class="free">B</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>add_mset <span class="free">x</span> <span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span>add_mset <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="main">*</span> size <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_mset <span class="free">x</span> <span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">×#</span> <span class="free">B</span> <span class="main">+</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">×#</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sigma_mset_plus_distrib1 add_mset_add_single<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>add_mset <span class="free">x</span> <span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">+</span> size <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> size <span class="free">A</span> <span class="main">*</span> size <span class="free">B</span> <span class="main">+</span> size <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>add_mset <span class="free">x</span> <span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>size <span class="free">A</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> size <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-size_cartesian_product"><span class="command">lemma</span></span> size_cartesian_product<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> size <span class="free">A</span> <span class="main">*</span> size <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_add_elem_step_eq<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-cart_prod_distinct_mset"><span class="command">lemma</span></span> cart_prod_distinct_mset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assm1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assm2<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct_mset <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> distinct_mset_count_less_1
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> count_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> count <span class="free">A</span> <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> count <span class="free">B</span> <span class="main">(</span>snd <span class="skolem">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> count_Sigma_mset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.exhaust_sel<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="free">A</span> <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> count <span class="free">B</span> <span class="main">(</span>snd <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assm1 assm2 
    <span class="keyword1"><span class="command">unfolding</span></span> distinct_mset_count_less_1 <span class="keyword1"><span class="command">using</span></span> mult_le_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> count_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-cart_product_single_intersect"><span class="command">lemma</span></span> cart_product_single_intersect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">≠</span> <span class="free">x2</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">{#</span><span class="free">x1</span><span class="main">#}</span> <span class="main">×#</span> <span class="free">A</span><span class="main">)</span> <span class="main">∩#</span> <span class="main">(</span><span class="main">{#</span><span class="free">x2</span><span class="main">#}</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> multiset_inter_single <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Multisets_Extras-size_union_distinct_cart_prod"><span class="command">lemma</span></span> size_union_distinct_cart_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">≠</span> <span class="free">x2</span> <span class="main">⟹</span> size <span class="main">(</span><span class="main">(</span><span class="main">{#</span><span class="free">x1</span><span class="main">#}</span> <span class="main">×#</span> <span class="free">A</span><span class="main">)</span> <span class="main">∪#</span> <span class="main">(</span><span class="main">{#</span><span class="free">x2</span><span class="main">#}</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    size <span class="main">(</span><span class="main">{#</span><span class="free">x1</span><span class="main">#}</span> <span class="main">×#</span> <span class="free">A</span><span class="main">)</span> <span class="main">+</span> size <span class="main">(</span><span class="main">{#</span><span class="free">x2</span><span class="main">#}</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cart_product_single_intersect size_Un_disjoint<span class="main">)</span> 

<span class="keyword1" id="Multisets_Extras-size_Union_distinct_cart_prod"><span class="command">lemma</span></span> size_Union_distinct_cart_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">M</span> <span class="main">⟹</span> 
    size <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈#</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">{#</span><span class="bound">p</span><span class="main">#}</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="free">M</span><span class="main">)</span> <span class="main">*</span> size <span class="main">(</span><span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Multisets_Extras-size_Union_distinct_cart_prod_filter"><span class="command">lemma</span></span> size_Union_distinct_cart_prod_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">M</span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="main">⋀</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">⟹</span> size <span class="main">(</span><span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">p</span> <span class="bound">b</span> <span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟹</span> 
    size <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈#</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">{#</span><span class="bound">p</span><span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">p</span> <span class="bound">b</span> <span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="free">M</span><span class="main">)</span> <span class="main">*</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Multisets_Extras-size_Union_distinct_cart_prod_filter2"><span class="command">lemma</span></span> size_Union_distinct_cart_prod_filter2<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">V</span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">⟹</span> size <span class="main">(</span><span class="main">{#</span> <span class="bound">v</span> <span class="main">∈#</span> <span class="free">V</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">v</span> <span class="bound">b</span> <span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟹</span> 
    size <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈#</span><span class="free">B</span><span class="main">.</span> <span class="main">(</span> <span class="main">{#</span> <span class="bound">v</span> <span class="main">∈#</span> <span class="free">V</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">v</span> <span class="bound">b</span> <span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span><span class="bound">b</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="free">B</span><span class="main">)</span> <span class="main">*</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Multisets_Extras-cart_product_add_1"><span class="command">lemma</span></span> cart_product_add_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_mset <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="main">×#</span> <span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sigma_mset_plus_distrib1 add_mset_add_single union_commute<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-cart_product_add_1_filter"><span class="command">lemma</span></span> cart_product_add_1_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">(</span>add_mset <span class="free">a</span> <span class="free">M</span><span class="main">)</span> <span class="main">×#</span> <span class="free">N</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">m</span> <span class="main">#}</span> <span class="main">=</span> 
    <span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">M</span> <span class="main">×#</span> <span class="free">N</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">m</span> <span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span>  <span class="free">N</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">m</span> <span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_mset_add_single <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> Sigma_mset_plus_distrib1
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Times_mset_single_left<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-cart_product_add_1_filter2"><span class="command">lemma</span></span> cart_product_add_1_filter2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">M</span> <span class="main">×#</span> <span class="main">(</span>add_mset <span class="free">b</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">m</span> <span class="main">#}</span> <span class="main">=</span> 
    <span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">M</span> <span class="main">×#</span> <span class="free">N</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">m</span> <span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">M</span> <span class="main">×#</span>  <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">m</span> <span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_mset_add_single <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span> Sigma_mset_plus_distrib1
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Times_insert_left Times_mset_single_right add_mset_add_single filter_union_mset<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-cart_prod_singleton_right_gen"><span class="command">lemma</span></span> cart_prod_singleton_right_gen<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">Q</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">x</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">A</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">Q</span> <span class="bound">a</span><span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">x</span> <span class="skolem">A</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="main">=</span> add_mset <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Times_mset_single_right<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_mset <span class="free">P</span> <span class="main">(</span>add_mset <span class="skolem">x</span> <span class="skolem">A</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> filter_mset <span class="free">P</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> 
    filter_mset <span class="free">P</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_mset <span class="free">Q</span> <span class="main">(</span>add_mset <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="main">=</span> filter_mset <span class="free">Q</span> <span class="skolem">A</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="main">+</span> 
    filter_mset <span class="free">Q</span> <span class="main">{#</span><span class="skolem">x</span><span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sigma_mset_plus_distrib1 add_mset_add_single filter_union_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter_mset <span class="free">P</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">#}</span> <span class="main">=</span> filter_mset <span class="free">Q</span> <span class="main">{#</span><span class="skolem">x</span><span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> lhs rhs add.IH add.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-cart_prod_singleton_left_gen"><span class="command">lemma</span></span> cart_prod_singleton_left_gen<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">Q</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">x</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> <span class="free">B</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">.</span> <span class="free">Q</span> <span class="bound">b</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x</span> <span class="skolem">B</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_mset <span class="free">P</span> <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> add_mset <span class="skolem">x</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> filter_mset <span class="free">P</span> <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">+</span> 
    filter_mset <span class="free">P</span> <span class="main">{#</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cart_product_add_1_filter2<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> filter_mset <span class="free">Q</span> <span class="main">(</span>add_mset <span class="skolem">x</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> filter_mset <span class="free">Q</span> <span class="skolem">B</span> <span class="main">+</span> 
    <span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> filter_mset <span class="free">Q</span> <span class="main">{#</span><span class="skolem">x</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_mset_add_single filter_union_mset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Times_mset_single_left image_mset_union<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter_mset <span class="free">P</span> <span class="main">{#</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> filter_mset <span class="free">Q</span> <span class="main">{#</span><span class="skolem">x</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> lhs rhs add.IH add.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-cart_product_singleton_left"><span class="command">lemma</span></span> cart_product_singleton_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span>  <span class="free">N</span><span class="main">)</span> <span class="main">.</span> fst <span class="bound">m</span> <span class="main">∈</span> snd <span class="bound">m</span> <span class="main">#}</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span> <span class="bound">n</span> <span class="main">∈#</span> <span class="free">N</span> <span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">n</span> <span class="main">#}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> stmt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> <span class="free">N</span><span class="main">)</span> <span class="main">⟹</span> fst <span class="bound">m</span> <span class="main">∈</span> snd <span class="bound">m</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> snd <span class="bound">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_Times_mset_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Sigma_mset_cong stmt cart_prod_singleton_left_gen<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-cart_product_singleton_right"><span class="command">lemma</span></span> cart_product_singleton_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">N</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> fst <span class="bound">m</span> <span class="main">∈</span> snd <span class="bound">m</span> <span class="main">#}</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">{#</span> <span class="bound">n</span> <span class="main">∈#</span> <span class="free">N</span> <span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">b</span> <span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span> <span class="free">b</span> <span class="main">#}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> stmt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">N</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span> <span class="main">⟹</span> fst <span class="bound">m</span> <span class="main">∈</span> snd <span class="bound">m</span> <span class="main">⟷</span> fst <span class="bound">m</span> <span class="main">∈</span><span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_Times_mset_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Sigma_mset_cong stmt cart_prod_singleton_right_gen<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-cart_product_add_1_filter_eq"><span class="command">lemma</span></span> cart_product_add_1_filter_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">(</span>add_mset <span class="free">a</span> <span class="free">M</span><span class="main">)</span> <span class="main">×#</span> <span class="free">N</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span>fst <span class="bound">m</span> <span class="main">∈</span> snd <span class="bound">m</span><span class="main">)</span> <span class="main">#}</span> <span class="main">=</span> 
    <span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">M</span> <span class="main">×#</span> <span class="free">N</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span>fst <span class="bound">m</span> <span class="main">∈</span> snd <span class="bound">m</span><span class="main">)</span> <span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span> <span class="bound">n</span> <span class="main">∈#</span> <span class="free">N</span> <span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">n</span> <span class="main">#}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_mset_add_single <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> Sigma_mset_plus_distrib1
  <span class="keyword1"><span class="command">using</span></span> cart_product_singleton_left cart_product_add_1_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="Multisets_Extras-cart_product_add_1_filter_eq_mirror"><span class="command">lemma</span></span> cart_product_add_1_filter_eq_mirror<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">×#</span> <span class="main">(</span>add_mset <span class="free">b</span> <span class="free">N</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span>fst <span class="bound">m</span> <span class="main">∈</span> snd <span class="bound">m</span><span class="main">)</span> <span class="main">#}</span> <span class="main">=</span> 
    <span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">M</span> <span class="main">×#</span> <span class="free">N</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span>fst <span class="bound">m</span> <span class="main">∈</span> snd <span class="bound">m</span><span class="main">)</span> <span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span> <span class="bound">n</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">b</span> <span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_mset_add_single <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span> Sigma_mset_plus_distrib1 <span class="comment1">(* longish *)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add_mset_add_single cart_product_add_1_filter2 cart_product_singleton_right<span class="main">)</span> 

<span class="keyword1" id="Multisets_Extras-set_break_down_left"><span class="command">lemma</span></span> set_break_down_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">m</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">M</span> <span class="main">×#</span> <span class="free">N</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span>fst <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="bound">m</span><span class="main">)</span>  <span class="main">#}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈#</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">{#</span><span class="bound">m</span><span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span><span class="bound">n</span> <span class="main">∈#</span> <span class="free">N</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈</span> <span class="bound">n</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cart_product_add_1_filter_eq<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-set_break_down_right"><span class="command">lemma</span></span> set_break_down_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">×#</span> <span class="free">N</span> <span class="main">.</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span>  <span class="main">#}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈#</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span><span class="main">{#</span><span class="bound">m</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈</span> <span class="bound">n</span><span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span><span class="bound">n</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">N</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cart_product_add_1_filter_eq_mirror<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reasoning on sums of elements over multisets›</span></span>

<span class="keyword1" id="Multisets_Extras-sum_over_fun_eq"><span class="command">lemma</span></span> sum_over_fun_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> ring_1
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Multisets_Extras-sum_mset_add_diff"><span class="command">lemma</span></span> sum_mset_add_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span>  <span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> ordered_ring
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Multisets_Extras-sum_mset_ge0"><span class="command">lemma</span></span> sum_mset_ge0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> hyp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> sum_mset <span class="main">(</span>image_mset <span class="free">f</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" sum_mset <span class="main">(</span>image_mset <span class="free">f</span> <span class="main">(</span>add_mset <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>  sum_mset <span class="main">(</span>image_mset <span class="free">f</span>  <span class="skolem">A</span><span class="main">)</span> <span class="main">+</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_commute<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.IH add.prems<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-sum_order_add_mset"><span class="command">lemma</span></span> sum_order_add_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">∈#</span> add_mset <span class="free">a</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Multisets_Extras-sum_mset_0_left"><span class="command">lemma</span></span> sum_mset_0_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span><span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> local.add_nonneg_eq_0_iff sum_mset_ge0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.antisym local.sum_mset.insert sum_mset_ge0 sum_order_add_mset<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-sum_mset_0_iff_ge_0"><span class="command">lemma</span></span> sum_mset_0_iff_ge_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set_mset <span class="free">A</span> <span class="main">.</span><span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum_mset_0_left assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Multisets_Extras-mset_set_size_card_count"><span class="command">lemma</span></span> mset_set_size_card_count<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> set_mset <span class="free">A</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span>count <span class="free">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set_mset <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> count <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>insert <span class="skolem">y</span> <span class="main">(</span>set_mset <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> count <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">A</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> x_val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>insert <span class="skolem">y</span> <span class="main">(</span>set_mset <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">⟹</span> 
        <span class="bound">x</span><span class="main">*</span> count <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span>count <span class="skolem">A</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> y_count<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> count <span class="skolem">A</span> <span class="skolem">y</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> True count_inI <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set_mset <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> count <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="skolem">y</span> <span class="main">*</span> <span class="main">(</span>count <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>set_mset <span class="skolem">A</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> count <span class="skolem">A</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> x_val finite_set_mset sum.cong sum.insert rhs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> DiffD1 Diff_insert_absorb insert_absorb mk_disjoint_insert sum.insert_remove<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set_mset <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> count <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> 
        <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">*</span> <span class="main">(</span>count <span class="skolem">A</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>set_mset <span class="skolem">A</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> count <span class="skolem">A</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> y_count <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set_mset <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> count <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> 
        <span class="skolem">y</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>insert <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span>set_mset <span class="skolem">A</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span> <span class="main">)</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> count <span class="skolem">A</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.insert_remove<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set_mset <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> count <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> 
        <span class="skolem">y</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>set_mset <span class="skolem">A</span><span class="main">)</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> count <span class="skolem">A</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  True insert_absorb<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lhs add.IH
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> x_val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_mset <span class="skolem">A</span> <span class="main">⟹</span> <span class="bound">x</span><span class="main">*</span> count <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span>count <span class="skolem">A</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> y_count<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False count_inI <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set_mset <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> count <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="skolem">y</span> <span class="main">*</span> count <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set_mset <span class="skolem">A</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> count <span class="skolem">A</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> x_val rhs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> False finite_set_mset sum.cong sum.insert<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set_mset <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> count <span class="main">(</span>add_mset <span class="skolem">y</span> <span class="skolem">A</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> 
        <span class="skolem">y</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set_mset <span class="skolem">A</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> count <span class="skolem">A</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> y_count <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lhs add.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Partitions on Multisets›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A partition on a multiset A is a multiset of multisets, where the sum over P equals A and the 
empty multiset is not in the partition. Based off set partition definition. 
We note that unlike set partitions, there is no requirement for elements in the multisets to be 
distinct due to the definition of union on multisets \cite{benderPartitionsMultisets1974}›</span></span>

<span class="keyword1" id="Multisets_Extras-mset_size_partition_dep"><span class="command">lemma</span></span> mset_size_partition_dep<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">∨</span> <span class="free">Q</span> <span class="bound">a</span> <span class="main">#}</span> <span class="main">=</span> 
    size <span class="main">{#</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">#}</span> <span class="main">+</span>  size <span class="main">{#</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">Q</span> <span class="bound">a</span> <span class="main">#}</span> <span class="main">-</span>  size <span class="main">{#</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">a</span> <span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_bunion_filter mset_inter_filter mset_union_size_inter<span class="main">)</span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition_on_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">partition_on_mset</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟷</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> <span class="main">{#}</span> <span class="main">∉#</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1" id="Multisets_Extras-partition_on_msetI"><span class="command">lemma</span></span> partition_on_msetI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="free">P</span> <span class="main">=</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">{#}</span> <span class="main">∉#</span> <span class="free">P</span> <span class="main">⟹</span> partition_on_mset <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_mset_def<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_msetD1"><span class="command">lemma</span></span> partition_on_msetD1<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span> <span class="main">⟹</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="free">P</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_mset_def<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_msetD2"><span class="command">lemma</span></span> partition_on_msetD2<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span> <span class="main">⟹</span> <span class="main">{#}</span> <span class="main">∉#</span>  <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_mset_def<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_empty"><span class="command">lemma</span></span> partition_on_mset_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="main">{#}</span> <span class="free">P</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> partition_on_mset_def
  <span class="keyword1"><span class="command">using</span></span> multiset_nonemptyE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_all"><span class="command">lemma</span></span> partition_on_mset_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> partition_on_mset <span class="free">A</span> <span class="main">{#</span><span class="free">A</span> <span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_mset_def<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_singletons"><span class="command">lemma</span></span> partition_on_mset_singletons<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="main">(</span>image_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span> <span class="main">{#</span><span class="bound">x</span><span class="main">#}</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partition_on_mset_def<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_not_empty"><span class="command">lemma</span></span> partition_on_mset_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> partition_on_mset <span class="free">A</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partition_on_mset_def<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_msetI2"><span class="command">lemma</span></span> partition_on_msetI2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="free">P</span> <span class="main">=</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> <span class="free">P</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">⟹</span> partition_on_mset <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partition_on_mset_def<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_elems"><span class="command">lemma</span></span> partition_on_mset_elems<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">p1</span> <span class="main">∈#</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈#</span> <span class="free">p1</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈#</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partition_on_mset_def<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_sum_size_eq"><span class="command">lemma</span></span> partition_on_mset_sum_size_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">P</span><span class="main">.</span> size <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> size <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> partition_on_msetD1 size_big_union_sum<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_card"><span class="command">lemma</span></span> partition_on_mset_card<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" size <span class="free">P</span> <span class="main">≤</span> size <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> size <span class="free">P</span> <span class="main">≤</span> size <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="free">P</span> <span class="main">&gt;</span> size <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">P</span> <span class="main">⟹</span> size <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> partition_on_msetD2
    <span class="keyword1"><span class="command">using</span></span> assms nonempty_has_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">P</span><span class="main">.</span> size <span class="bound">x</span><span class="main">)</span> <span class="main">≥</span> size <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leI less_one not_less_zero size_eq_sum_mset sum_mset_mono<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> a partition_on_mset_sum_size_eq
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_count_eq"><span class="command">lemma</span></span> partition_on_mset_count_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">P</span><span class="main">.</span> count <span class="bound">x</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> count <span class="free">A</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_sum_mset partition_on_msetD1<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_subsets"><span class="command">lemma</span></span> partition_on_mset_subsets<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈#</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊆#</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_mset_def<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_distinct"><span class="command">lemma</span></span> partition_on_mset_distinct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> distinct_mset <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p1</span></span> <span class="keyword2"><span class="keyword">where</span></span> count<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="free">P</span> <span class="skolem">p1</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_1 distinct_mset_count_less_1 less_Suc_eq_le not_less_eq<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">p1</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span> <span class="main">∈#</span> <span class="free">P</span><span class="main">.</span> count <span class="bound">p</span> <span class="bound">x</span> <span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> count_greater_eq_one_iff count_sum_mset_if_1_0 dual_order.trans sum_mset_mono zero_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> elem_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">p1</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> partition_on_mset_elems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> count_eq_zero_iff not_numeral_le_zero<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> count <span class="free">A</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_mset_def<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> 
    <span class="keyword1"><span class="command">using</span></span> assms partition_on_mset_count_eq cge elem_in count_inI local.count multiset_nonemptyE
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> not_numeral_le_zero numeral_One numeral_le_iff partition_on_mset_def semiring_norm<span class="main"><span class="main">(</span></span>69<span class="main"><span class="main">)</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_distinct_disjoint"><span class="command">lemma</span></span> partition_on_mset_distinct_disjoint<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">∈#</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p2</span> <span class="main">∈#</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{#</span><span class="free">p1</span><span class="main">#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">∩#</span> <span class="free">p2</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Diff_eq_empty_iff_mset assms diff_add_zero distinct_mset_add multiset_inter_assoc sum_mset.remove
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> partition_on_msetD1 subset_mset.inf.absorb_iff2 subset_mset.le_add_same_cancel1 subset_mset.le_iff_inf<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_diff"><span class="command">lemma</span></span> partition_on_mset_diff<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊆#</span><span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="free">Q</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms partition_on_mset_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> diff_union_cancelL subset_mset.add_diff_inverse sum_mset.union union_iff<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-sigma_over_set_partition_count"><span class="command">lemma</span></span> sigma_over_set_partition_count<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms partition_onD2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span>  pin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈#</span> mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> count_eq_zero_iff count_mset_set'<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> filter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p'</span> <span class="main">.</span> <span class="bound">p'</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">(</span>mset_set <span class="main">(</span>mset_set<span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">p</span><span class="main">#}</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="bound">p'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> count_eq_zero_iff count_single <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  
  <span class="keyword1"><span class="command">have</span></span> zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈#</span> mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">p'</span> <span class="main">≠</span> <span class="skolem">p</span> <span class="main">⟹</span> count <span class="bound">p'</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> 
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈#</span> mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="skolem">p'</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> xin2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="skolem">p'</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p1</span></span> <span class="skolem"><span class="skolem">p2</span></span> <span class="keyword2"><span class="keyword">where</span></span> p1in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p2in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p2</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  p1eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_set <span class="skolem">p1</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> p2eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_set <span class="skolem">p2</span> <span class="main">=</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assm assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> pin 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> elem_mset_set finite_elements finite_imageI image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> origne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">≠</span> <span class="skolem">p2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne p1eq p2eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">=</span> <span class="skolem">p2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> partition_onD4 xin xin2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> count_eq_zero_iff count_mset_set' p1eq p1in p2eq p2in<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> origne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> one<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="skolem">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pin xin assms count_eq_zero_iff count_greater_eq_one_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_mset_set<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> count_mset_set_le_one image_iff le_antisym<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound">p'</span> <span class="main">∈#</span> <span class="main">(</span>mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> count <span class="bound">p'</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> count_sum_mset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>count <span class="skolem">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p'</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">(</span>mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">p</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> count <span class="bound">p'</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> insert_DiffM pin sum_mset.insert<span class="main">)</span>  
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p'</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">(</span>mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">p</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> count <span class="bound">p'</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> one <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> 
      <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p'</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">(</span>mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">p</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> zero filter <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> in_diffD sum_over_fun_eq<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_set"><span class="command">lemma</span></span> partition_on_mset_set<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="main">(</span>mset_set <span class="free">A</span><span class="main">)</span> <span class="main">(</span>mset_set <span class="main">(</span>image <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> mset_set <span class="bound">x</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> partition_on_msetI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> partd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">P</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms partition_onD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> elem_mset_set equals0D infinite_set_mset_mset_set mset_big_union_obtain<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">p</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff finite_set_mset_mset_set image_iff infinite_set_mset_mset_set<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> mset_set <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> partd1 xin assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> imp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="free">A</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> mset_set <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> partd1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> mset_set <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">p</span>›</span></span> finite_elements partd1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sup_upper finite_imageI finite_set_mset_mset_set in_Union_mset_iff rev_finite_subset<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="free">A</span> <span class="main">⟹</span> count <span class="main">(</span>mset_set <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mset_set <span class="free">A</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> imp imp2 a1 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> count_eq_zero_iff multiset_eqI sigma_over_set_partition_count<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span>  <span class="bound">p</span> <span class="main">≠</span> <span class="main">{}</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> assms partition_onD3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span>  mset_set <span class="bound">p</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_set_empty_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Union_upper assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> partd1 rev_finite_subset<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∉#</span> mset_set <span class="main">(</span>mset_set <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> elem_mset_set equals0D image_iff infinite_set_mset_mset_set<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_distinct_inter"><span class="command">lemma</span></span> partition_on_mset_distinct_inter<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">∈#</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p2</span> <span class="main">∈#</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≠</span> <span class="free">p2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">∩#</span> <span class="free">p2</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms in_remove1_mset_neq partition_on_mset_distinct_disjoint<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_set_mset_distinct"><span class="command">lemma</span></span> partition_on_set_mset_distinct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈#</span> image_mset set_mset <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈#</span> image_mset set_mset <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="free">p'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∩</span> <span class="free">p'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p1</span></span> <span class="keyword2"><span class="keyword">where</span></span> p1in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">∈#</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p1eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">p1</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p2</span></span> <span class="keyword2"><span class="keyword">where</span></span> p2in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p2</span> <span class="main">∈#</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p2eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">p2</span> <span class="main">=</span> <span class="free">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms partition_on_mset_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">≠</span> <span class="skolem">p2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">using</span></span> p1eq p2eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">∩#</span> <span class="skolem">p2</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> partition_on_mset_distinct_inter
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> p1in p2in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> p1eq p2eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_mset_empty set_mset_inter<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-partition_on_set_mset"><span class="command">lemma</span></span> partition_on_set_mset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct_mset <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span>set_mset <span class="free">A</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="main">(</span>image_mset set_mset <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> partition_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> image_mset set_mset <span class="free">P</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> partition_on_msetD2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_mset <span class="free">A</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>set_mset <span class="main">(</span>image_mset set_mset <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Union_iff assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> image_eqI mset_big_union_obtain partition_on_msetD1 set_image_mset<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>set_mset <span class="main">(</span>image_mset set_mset <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> set_eqI' partition_on_mset_elems assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> image_mset set_mset <span class="free">P</span> <span class="main">⟹</span> <span class="bound">p'</span> <span class="main">∈#</span> image_mset set_mset <span class="free">P</span> <span class="main">⟹</span> 
      <span class="bound">p</span> <span class="main">≠</span> <span class="bound">p'</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">∩</span> <span class="bound">p'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> partition_on_set_mset_distinct assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_eq_imp_eq_carrier"><span class="command">lemma</span></span> partition_on_mset_eq_imp_eq_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">B</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms partition_on_msetD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Multisets_Extras-partition_on_mset_add_single"><span class="command">lemma</span></span> partition_on_mset_add_single<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="main">(</span>add_mset <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>add_mset <span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partition_on_mset_def<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_add_part"><span class="command">lemma</span></span> partition_on_mset_add_part<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">+</span> <span class="free">X</span> <span class="main">=</span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A'</span> <span class="main">(</span>add_mset <span class="free">X</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partition_on_mset_def<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_add"><span class="command">lemma</span></span> partition_on_mset_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈#</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="free">a</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="main">(</span>add_mset <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>add_mset <span class="free">X'</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{#</span><span class="free">X</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_mset_add_single assms empty_not_add_mset mset_subset_eq_single partition_on_mset_all
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> partition_on_mset_def subset_mset.add_diff_inverse sum_mset.add_mset sum_mset.remove union_iff union_mset_add_mset_left<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_elem_exists_part"><span class="command">lemma</span></span> partition_on_mset_elem_exists_part<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈#</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms in_Union_mset_iff partition_on_msetD2 partition_on_msetI
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> partition_on_mset_eq_imp_eq_carrier<span class="main">)</span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_combine"><span class="command">lemma</span></span> partition_on_mset_combine<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">B</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="main">+</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> partition_on_mset_def
  <span class="keyword1"><span class="command">using</span></span> assms partition_on_msetD1 partition_on_msetD2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Multisets_Extras-partition_on_mset_split"><span class="command">lemma</span></span> partition_on_mset_split<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="free">A</span> <span class="main">(</span><span class="free">P</span> <span class="main">+</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="free">P</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  partition_on_mset_def partition_on_msetD2 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Design_Basics">
<div class="head">
<h1>Theory Design_Basics</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Design_Basics <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a> <a href="#Multisets_Extras">Multisets_Extras</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Disjoint_Sets.html">HOL-Library.Disjoint_Sets</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Design Theory Basics›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All definitions in this section reference the handbook of combinatorial designs
 \cite{colbournHandbookCombinatorialDesigns2007}›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Initial setup›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Enable coercion of nats to ints to aid with reasoning on design properties›</span></span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">coercion_enabled</span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">coercion</span> <span class="quoted"><span class="quoted">"of_nat <span class="main">::</span> nat <span class="main">⇒</span> int"</span></span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Incidence System›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An incidence system is defined to be a wellformed set system. i.e. each block is a subset
of the base point set. Alternatively, an incidence system can be looked at as the point set
and an incidence relation which indicates if they are in the same block›</span></span>

<span class="keyword1"><span class="command">locale</span></span> incidence_system <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">point_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">𝒱</span></span></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">block_collection</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set multiset"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">ℬ</span></span></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span> <span class="comment1">(* incidence relation *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">incident</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">incident</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">∈</span> ℐ"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Defines common notation used to indicate number of points ($v$) and number of blocks ($b$)›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝗏</span> <span class="main">≡</span> int <span class="main">(</span>card <span class="keyword1"><span class="free">𝒱</span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝖻</span> <span class="main">≡</span> int <span class="main">(</span>size <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic incidence lemmas›</span></span>

<span class="keyword1" id="Design_Basics-incidence_alt_def"><span class="command">lemma</span></span> incidence_alt_def<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"incident <span class="free">p</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">∈</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incident_def ℐ_def assms<span class="main">)</span>

<span class="keyword1" id="Design_Basics-wf_invalid_point"><span class="command">lemma</span></span> wf_invalid_point<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wellformed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Design_Basics-block_set_nempty_imp_block_ex"><span class="command">lemma</span></span> block_set_nempty_imp_block_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abbreviations for all incidence systems›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">multiplicity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">multiplicity</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> count <span class="keyword1"><span class="free">ℬ</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">incomplete_block</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">incomplete_block</span> <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="main">≡</span> card <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="main">&lt;</span> card <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>

<span class="keyword1" id="Design_Basics-incomplete_alt_size"><span class="command">lemma</span></span> incomplete_alt_size<span class="main">:</span> <span class="quoted"><span class="quoted">"incomplete_block <span class="free">bl</span> <span class="main">⟹</span> card <span class="free">bl</span> <span class="main">&lt;</span> 𝗏"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Design_Basics-incomplete_alt_in"><span class="command">lemma</span></span> incomplete_alt_in<span class="main">:</span> <span class="quoted"><span class="quoted">"incomplete_block <span class="free">bl</span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Design_Basics-incomplete_alt_imp"><span class="command">lemma</span></span> incomplete_alt_imp<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">bl</span> <span class="main">&lt;</span> 𝗏 <span class="main">⟹</span> <span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> incomplete_block <span class="free">bl</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">design_support</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">design_support</span> <span class="main">≡</span> set_mset <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finite Incidence Systems›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These simply require the point set to be finite.
As multisets are only defined to be finite, it is implied that the block set must be finite already›</span></span>

<span class="keyword1"><span class="command">locale</span></span> finite_incidence_system <span class="main">=</span> incidence_system <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_sets<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Design_Basics-finite_blocks"><span class="command">lemma</span></span> finite_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> finite <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wellformed finite_sets finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="Design_Basics-mset_points_distinct"><span class="command">lemma</span></span> mset_points_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="main">(</span>mset_set <span class="keyword1"><span class="free">𝒱</span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_sets <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_mset_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-mset_points_distinct_diff_one"><span class="command">lemma</span></span> mset_points_distinct_diff_one<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="main">(</span>mset_set <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> count_mset_set_le_one distinct_mset_count_less_1<span class="main">)</span>

<span class="keyword1" id="Design_Basics-finite_design_support"><span class="command">lemma</span></span> finite_design_support<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>design_support<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> design_support_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Design_Basics-block_size_lt_order"><span class="command">lemma</span></span> block_size_lt_order<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> card <span class="free">bl</span> <span class="main">≤</span> card <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wellformed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_mono finite_sets<span class="main">)</span>  

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Designs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There are many varied definitions of a design in literature. However, the most
commonly accepted definition is a finite point set, $V$ and collection of blocks $B$, where
no block in $B$ can be empty›</span></span>
<span class="keyword1"><span class="command">locale</span></span> design <span class="main">=</span> finite_incidence_system <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> blocks_nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Design_Basics-wf_design"><span class="command">lemma</span></span> wf_design<span class="main">:</span> <span class="quoted"><span class="quoted">"design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_locales</span>

<span class="keyword1" id="Design_Basics-wf_design_iff"><span class="command">lemma</span></span> wf_design_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free">bl</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">∧</span> finite <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">∧</span> <span class="free">bl</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> blocks_nempty wellformed finite_sets
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_design<span class="main">)</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reasoning on non empty properties and non zero parameters›</span></span>
<span class="keyword1" id="Design_Basics-blocks_nempty_alt"><span class="command">lemma</span></span> blocks_nempty_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="bound">bl</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> blocks_nempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Design_Basics-block_set_nempty_imp_points"><span class="command">lemma</span></span> block_set_nempty_imp_points<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_design wf_design_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Design_Basics-b_non_zero_imp_v_non_zero"><span class="command">lemma</span></span> b_non_zero_imp_v_non_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> 𝗏 <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> block_set_nempty_imp_points finite_sets <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Design_Basics-v_eq0_imp_b_eq_0"><span class="command">lemma</span></span> v_eq0_imp_b_eq_0<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> 𝖻 <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> b_non_zero_imp_v_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Size lemmas›</span></span>
<span class="keyword1" id="Design_Basics-block_size_lt_v"><span class="command">lemma</span></span> block_size_lt_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> card <span class="free">bl</span> <span class="main">≤</span> 𝗏"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_mono finite_sets wellformed<span class="main">)</span>

<span class="keyword1" id="Design_Basics-block_size_gt_0"><span class="command">lemma</span></span> block_size_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> card <span class="free">bl</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_sets blocks_nempty finite_blocks <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Design_Basics-design_cart_product_size"><span class="command">lemma</span></span> design_cart_product_size<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">(</span>mset_set <span class="keyword1"><span class="free">𝒱</span></span><span class="main">)</span> <span class="main">×#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">=</span> 𝗏 <span class="main">*</span> 𝖻"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_cartesian_product<span class="main">)</span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intro rules for design locale›</span></span>

<span class="keyword1" id="Design_Basics-wf_design_implies"><span class="command">lemma</span></span> wf_design_implies<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">⊆</span> <span class="free">V</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℬ</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"design <span class="free">V</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> incidence_system<span class="main">)</span> finite_sysI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> finite_incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> finite_incidence_system<span class="main">)</span> designI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">≠</span> <span class="main">{#}</span>
     <span class="main">⟹</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Core Property Definitions›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Replication Number›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The replication number for a point is the number of blocks that point is incident with›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">point_replication_number</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set multiset <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> int"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">rep</span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1"><span class="free">rep</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="bound">b</span><span class="main">#}</span>"</span></span>

<span class="keyword1" id="Design_Basics-max_point_rep"><span class="command">lemma</span></span> max_point_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">≤</span> size <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> size_filter_mset_lesseq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-rep_number_g0_exists"><span class="command">lemma</span></span> rep_number_g0_exists<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms point_replication_number_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_0_less_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filter_mset_empty_conv nonempty_has_size that<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Basics-rep_number_on_set_def"><span class="command">lemma</span></span> rep_number_on_set_def<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span> <span class="main">⟹</span> <span class="main">(</span>mset_set <span class="free">B</span><span class="main">)</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-point_rep_number_split"><span class="command">lemma</span></span> point_rep_number_split<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">+</span> <span class="free">B</span> <span class="keyword1">rep</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-point_rep_singleton_val"><span class="command">lemma</span></span> point_rep_singleton_val <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-point_rep_singleton_inval"><span class="command">lemma</span></span> point_rep_singleton_inval <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> incidence_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Design_Basics-point_rep_number_alt_def"><span class="command">lemma</span></span> point_rep_number_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-rep_number_non_zero_system_point"><span class="command">lemma</span></span> rep_number_non_zero_system_point<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rep_number_g0_exists wellformed
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_invalid_point<span class="main">)</span> 

<span class="keyword1" id="Design_Basics-point_rep_non_existance"><span class="command">lemma</span></span> point_rep_non_existance <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_invalid_point <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  point_replication_number_def filter_mset_empty_conv<span class="main">)</span> 

<span class="keyword1" id="Design_Basics-point_rep_number_inv"><span class="command">lemma</span></span> point_rep_number_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> <span class="bound">b</span> <span class="main">#}</span> <span class="main">=</span> 𝖻 <span class="main">-</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">=</span> size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> <span class="bound">b</span> <span class="main">#}</span> <span class="main">+</span> size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span> <span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> multiset_partition <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute size_union<span class="main">)</span>  
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Basics-point_rep_num_inv_non_empty"><span class="command">lemma</span></span> point_rep_num_inv_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> 𝖻 <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> <span class="bound">b</span> <span class="main">#}</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_zero point_replication_number_def size_empty size_filter_neg verit_comp_simplify1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Point Index›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The point index of a subset of points in a design, is the number of times those points 
occur together in a block of the design›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">points_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set multiset <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> nat"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">index</span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1"><span class="free">index</span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≡</span> size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span>"</span></span>

<span class="keyword1" id="Design_Basics-points_index_empty"><span class="command">lemma</span></span> points_index_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-point_index_distrib"><span class="command">lemma</span></span> point_index_distrib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B1</span> <span class="main">+</span> <span class="free">B2</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span>  <span class="free">B1</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">+</span> <span class="free">B2</span> <span class="keyword1">index</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-point_index_diff"><span class="command">lemma</span></span> point_index_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B1</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">B1</span> <span class="main">+</span> <span class="free">B2</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">-</span> <span class="free">B2</span> <span class="keyword1">index</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-points_index_singleton"><span class="command">lemma</span></span> points_index_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-points_index_singleton_zero"><span class="command">lemma</span></span> points_index_singleton_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">ps</span> <span class="main">⊆</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-points_index_sum"><span class="command">lemma</span></span> points_index_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="free">B</span> <span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="keyword1">index</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> points_index_empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_index_distrib<span class="main">)</span>

<span class="keyword1" id="Design_Basics-points_index_block_image_add_eq"><span class="command">lemma</span></span> points_index_block_image_add_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> insert <span class="free">x</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">#}</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> points_index_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms filter_mset_cong 
      image_mset_filter_swap2 points_index_def size_image_mset subset_insert<span class="main">)</span>

<span class="keyword1" id="Design_Basics-points_index_on_set_def"><span class="command">lemma</span></span> points_index_on_set_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset_set <span class="free">B</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def assms<span class="main">)</span>

<span class="keyword1" id="Design_Basics-points_index_single_rep_num"><span class="command">lemma</span></span> points_index_single_rep_num<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">B</span> <span class="keyword1">rep</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def point_replication_number_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-points_index_pair_rep_num"><span class="command">lemma</span></span> points_index_pair_rep_num<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="free">B</span> <span class="keyword1">rep</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> point_replication_number_def points_index_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms empty_subsetI filter_mset_cong insert_subset<span class="main">)</span>

<span class="keyword1" id="Design_Basics-points_index_0_left_imp"><span class="command">lemma</span></span> points_index_0_left_imp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">ps</span> <span class="main">⊆</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">¬</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="main">{#</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> count_greater_eq_Suc_zero_iff count_size_set_repr not_less_eq_eq 
        points_index_def size_filter_mset_lesseq<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Basics-points_index_0_right_imp"><span class="command">lemma</span></span> points_index_0_right_imp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_mset_empty_conv points_index_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-points_index_0_iff"><span class="command">lemma</span></span> points_index_0_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">¬</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> points_index_0_left_imp points_index_0_right_imp <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Design_Basics-points_index_gt0_impl_existance"><span class="command">lemma</span></span> points_index_gt0_impl_existance<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">bl</span> <span class="main">.</span> <span class="main">(</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="main">#}</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms points_index_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bl</span> <span class="main">∈#</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="skolem">bl</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filter_mset_empty_conv nonempty_has_size<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Basics-points_index_one_unique"><span class="command">lemma</span></span> points_index_one_unique<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="free">bl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl'</span> <span class="main">∈#</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="free">bl'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">=</span> <span class="free">bl'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">≠</span> <span class="free">bl'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bl1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="main">{#</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bl2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl'</span><span class="main">∈#</span> <span class="main">{#</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">bl</span><span class="main">,</span> <span class="free">bl'</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="main">{#</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bl1 bl2 points_index_def
        add_mset_subseteq_single_iff assm mset_subset_eq_single size_single subseteq_mset_size_eql<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="main">#}</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> size_mset_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> numeral_le_one_iff points_index_def semiring_norm<span class="main"><span class="main">(</span></span>69<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Basics-points_index_one_unique_block"><span class="command">lemma</span></span> points_index_one_unique_block<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span> <span class="bound">bl</span> <span class="main">.</span> <span class="main">(</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms points_index_gt0_impl_existance points_index_one_unique
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> zero_less_one<span class="main">)</span> 

<span class="keyword1" id="Design_Basics-points_index_one_not_unique_block"><span class="command">lemma</span></span> points_index_one_not_unique_block<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="free">bl</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl'</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">-</span> <span class="main">{#</span><span class="free">bl</span><span class="main">#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="free">bl'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{#</span><span class="free">bl</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="free">bl</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{#</span><span class="free">bl</span><span class="main">#}</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">B</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">-</span> <span class="main">{#</span><span class="free">bl</span><span class="main">#}</span> <span class="keyword1">index</span> <span class="free">ps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> point_index_diff<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{#</span><span class="free">bl</span><span class="main">#}</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms points_index_singleton
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_self_eq_0<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> points_index_0_left_imp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> incidence_system<span class="main">)</span> points_index_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> incidence_system<span class="main">)</span> points_index_ps_nin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> points_index_alt_def filter_mset_empty_conv in_mono size_empty subsetI wf_invalid_point
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> incidence_system<span class="main">)</span> points_index_count_bl<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">≥</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="free">bl</span> <span class="main">⟹</span> count <span class="main">{#</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="main">#}</span> <span class="free">bl</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> finite_incidence_system<span class="main">)</span> points_index_zero<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">ps</span> <span class="main">&gt;</span> card <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">&gt;</span> card <span class="bound">b</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> block_size_lt_order card_subset_not_gt_card finite_sets assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_subset_not_gt_card filter_mset_empty_conv finite_blocks<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> points_index_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> design<span class="main">)</span> points_index_subset<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊆#</span> <span class="main">{#</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="main">#}</span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span>size <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def size_mset_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> design<span class="main">)</span> points_index_count_min<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">≥</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="free">bl</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> points_index_alt_def set_count_size_min <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filter_mset.rep_eq<span class="main">)</span> 

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Intersection Number›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The intersection number of two blocks is the size of the intersection of those blocks. i.e. 
the number of points which occur in both blocks›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">intersection_number</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> int"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">|∩|</span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main"><span class="free">|∩|</span></span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="main">≡</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Design_Basics-intersection_num_non_neg"><span class="command">lemma</span></span> intersection_num_non_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">|∩|</span> <span class="free">b2</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intersection_number_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-intersection_number_empty_iff"><span class="command">lemma</span></span> intersection_number_empty_iff<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">b1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∩</span> <span class="free">b2</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">b1</span> <span class="main">|∩|</span> <span class="free">b2</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intersection_number_def assms<span class="main">)</span>

<span class="keyword1" id="Design_Basics-intersect_num_commute"><span class="command">lemma</span></span> intersect_num_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">|∩|</span> <span class="free">b2</span> <span class="main">=</span> <span class="free">b2</span> <span class="main">|∩|</span> <span class="free">b1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_commute intersection_number_def<span class="main">)</span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">n_intersect_number</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> nat<span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">n_intersect_number</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="main">≡</span> card <span class="main">{</span> <span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> Pow <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="main">.</span> card <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> n_intersect_number <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">|∩|⇩</span>_ _<span class="keyword3">)</span>"</span> <span class="main">[</span>52<span class="main">,</span> 51<span class="main">,</span> 52<span class="main">]</span> 50<span class="main">)</span>

<span class="keyword1" id="Design_Basics-n_intersect_num_subset_def"><span class="command">lemma</span></span> n_intersect_num_subset_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">|∩|⇩</span><span class="free">n</span> <span class="free">b2</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">b1</span> <span class="main">∩</span> <span class="free">b2</span> <span class="main">∧</span> card <span class="bound">x</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> n_intersect_number_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Design_Basics-n_inter_num_one"><span class="command">lemma</span></span> n_inter_num_one<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">b1</span> <span class="main">⟹</span> finite <span class="free">b2</span> <span class="main">⟹</span> <span class="free">b1</span> <span class="main">|∩|⇩</span><span class="main">1</span> <span class="free">b2</span> <span class="main">=</span> <span class="free">b1</span> <span class="main">|∩|</span> <span class="free">b2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> n_intersect_number_def intersection_number_def card_Pow_filter_one
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> finite_Int<span class="main">)</span> 

<span class="keyword1" id="Design_Basics-n_inter_num_choose"><span class="command">lemma</span></span> n_inter_num_choose<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">b1</span> <span class="main">⟹</span> finite <span class="free">b2</span> <span class="main">⟹</span> <span class="free">b1</span> <span class="main">|∩|⇩</span><span class="free">n</span> <span class="free">b2</span> <span class="main">=</span> <span class="main">(</span>card <span class="main">(</span><span class="free">b1</span> <span class="main">∩</span> <span class="free">b2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> n_subsets n_intersect_num_subset_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> finite_Int<span class="main">)</span> 

<span class="keyword1" id="Design_Basics-set_filter_single"><span class="command">lemma</span></span> set_filter_single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="free">A</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> design<span class="main">)</span> n_inter_num_zero<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b2</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">|∩|⇩</span><span class="main">0</span> <span class="free">b2</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">.</span> finite <span class="bound">x</span> <span class="main">⟹</span> card <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> empt_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∈</span> Pow <span class="main">(</span><span class="free">b1</span> <span class="main">∩</span> <span class="free">b2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">b1</span> <span class="main">∩</span> <span class="free">b2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_blocks assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> Pow <span class="main">(</span><span class="free">b1</span> <span class="main">∩</span> <span class="free">b2</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> PowD finite_subset<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> Pow <span class="main">(</span><span class="free">b1</span> <span class="main">∩</span> <span class="free">b2</span><span class="main">)</span> <span class="main">.</span> card <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> Pow <span class="main">(</span><span class="free">b1</span> <span class="main">∩</span> <span class="free">b2</span><span class="main">)</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">{}</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card.empty<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> Pow <span class="main">(</span><span class="free">b1</span> <span class="main">∩</span> <span class="free">b2</span><span class="main">)</span> <span class="main">.</span> card <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empt_in set_filter_single Collect_conv_if<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_intersect_number_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> design<span class="main">)</span> n_inter_num_choose_design<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">b2</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> 
    <span class="main">⟹</span> <span class="free">b1</span> <span class="main">|∩|⇩</span><span class="free">n</span> <span class="free">b2</span> <span class="main">=</span> <span class="main">(</span>card <span class="main">(</span><span class="free">b1</span> <span class="main">∩</span> <span class="free">b2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="free">n</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_blocks <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_inter_num_choose<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> design<span class="main">)</span> n_inter_num_choose_design_inter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">b2</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> 
    <span class="main">⟹</span> <span class="free">b1</span> <span class="main">|∩|⇩</span><span class="free">n</span> <span class="free">b2</span> <span class="main">=</span> <span class="main">(</span>nat <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="free">b2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="free">n</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_blocks <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_inter_num_choose intersection_number_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Incidence System Set Property Definitions›</span></span>
<span class="keyword1"><span class="command">context</span></span> incidence_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of replication numbers for all points of design›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">replication_numbers</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">replication_numbers</span> <span class="main">≡</span> <span class="main">{</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="bound">x</span> <span class="main">|</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Design_Basics-replication_numbers_non_empty"><span class="command">lemma</span></span> replication_numbers_non_empty<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒱</span></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"replication_numbers <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms replication_numbers_def<span class="main">)</span> 

<span class="keyword1" id="Design_Basics-obtain_point_with_rep"><span class="command">lemma</span></span> obtain_point_with_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> replication_numbers <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">∧</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> replication_numbers_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Design_Basics-point_rep_number_in_set"><span class="command">lemma</span></span> point_rep_number_in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> replication_numbers"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> replication_numbers_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> finite_incidence_system<span class="main">)</span> replication_numbers_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite replication_numbers"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_sets <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> replication_numbers_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of all block sizes in a system›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sys_block_sizes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sys_block_sizes</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>int <span class="main">(</span>card <span class="bound">bl</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Design_Basics-block_sizes_non_empty_set"><span class="command">lemma</span></span> block_sizes_non_empty_set<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sys_block_sizes <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sys_block_sizes_def assms<span class="main">)</span>

<span class="keyword1" id="Design_Basics-finite_block_sizes"><span class="command">lemma</span></span> finite_block_sizes<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>sys_block_sizes<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sys_block_sizes_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-block_sizes_non_empty"><span class="command">lemma</span></span> block_sizes_non_empty<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>sys_block_sizes<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_block_sizes block_sizes_non_empty_set
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms card_gt_0_iff<span class="main">)</span> 

<span class="keyword1" id="Design_Basics-sys_block_sizes_in"><span class="command">lemma</span></span> sys_block_sizes_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> card <span class="free">bl</span> <span class="main">∈</span> sys_block_sizes"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sys_block_sizes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Design_Basics-sys_block_sizes_obtain_bl"><span class="command">lemma</span></span> sys_block_sizes_obtain_bl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> sys_block_sizes  <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> int <span class="main">(</span>card <span class="bound">bl</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sys_block_sizes_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of all possible intersection numbers in a system.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">intersection_numbers</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">intersection_numbers</span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">b1</span> <span class="main">|∩|</span> <span class="bound">b2</span> <span class="main">|</span> <span class="bound">b1</span> <span class="bound">b2</span> <span class="main">.</span> <span class="bound">b1</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="bound">b2</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="bound">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Design_Basics-obtain_blocks_intersect_num"><span class="command">lemma</span></span> obtain_blocks_intersect_num<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> intersection_numbers <span class="main">⟹</span> 
  <span class="main">∃</span> <span class="bound">b1</span> <span class="bound">b2</span><span class="main">.</span> <span class="bound">b1</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="bound">b2</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="bound">b1</span><span class="main">#}</span><span class="main">)</span> <span class="main">∧</span>  <span class="bound">b1</span> <span class="main">|∩|</span> <span class="bound">b2</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intersection_numbers_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-intersect_num_in_set"><span class="command">lemma</span></span> intersect_num_in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">b2</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">b1</span> <span class="main">|∩|</span> <span class="free">b2</span> <span class="main">∈</span> intersection_numbers"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intersection_numbers_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of all possible point indices›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">point_indices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">point_indices</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="bound">ps</span> <span class="main">|</span> <span class="bound">ps</span><span class="main">.</span> int <span class="main">(</span>card <span class="bound">ps</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="bound">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Design_Basics-point_indices_elem_in"><span class="command">lemma</span></span> point_indices_elem_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">∈</span> point_indices <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_indices_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-point_indices_alt_def"><span class="command">lemma</span></span> point_indices_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"point_indices <span class="free">t</span> <span class="main">=</span> <span class="main">{</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="bound">ps</span> <span class="main">|</span> <span class="bound">ps</span><span class="main">.</span> int <span class="main">(</span>card <span class="bound">ps</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="main">∧</span> <span class="bound">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_indices_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Constructions on designs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section defines some of the most common universal constructions found in design theory
involving only a single design›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Design Complements›</span></span>

<span class="keyword1"><span class="command">context</span></span> incidence_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The complement of a block are all the points in the design not in that block. 
The complement of a design is therefore the original point sets, and set of all block complements›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">block_complement</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span>"</span> <span class="main">[</span>56<span class="main">]</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">block_complement</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">complement_blocks</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set multiset"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span><span class="keyword3">)</span>"</span><span class="main">)</span><span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">complement_blocks</span> <span class="main">≡</span> <span class="main">{#</span> <span class="bound">bl</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">#}</span>"</span></span> 

<span class="keyword1" id="Design_Basics-block_complement_elem_iff"><span class="command">lemma</span></span> block_complement_elem_iff<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="free">bl</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">ps</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">bl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms block_complement_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Design_Basics-block_complement_inter_empty"><span class="command">lemma</span></span> block_complement_inter_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl1</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span> <span class="main">=</span> <span class="free">bl2</span> <span class="main">⟹</span> <span class="free">bl1</span> <span class="main">∩</span> <span class="free">bl2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> block_complement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Design_Basics-block_complement_inv"><span class="command">lemma</span></span> block_complement_inv<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span> <span class="main">=</span> <span class="free">bl2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl2</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span> <span class="main">=</span> <span class="free">bl</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_Diff_Int assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> block_complement_def inf.absorb_iff2 wellformed<span class="main">)</span>

<span class="keyword1" id="Design_Basics-block_complement_subset_points"><span class="command">lemma</span></span> block_complement_subset_points<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">bl</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> block_complement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Design_Basics-obtain_comp_block_orig"><span class="command">lemma</span></span> obtain_comp_block_orig<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl1</span> <span class="main">∈#</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">bl2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl2</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl1</span> <span class="main">=</span> <span class="free">bl2</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wellformed assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complement_blocks_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-complement_same_b"><span class="command">lemma</span></span> complement_same_b <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span> <span class="main">=</span> size <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complement_blocks_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-block_comp_elem_alt_left"><span class="command">lemma</span></span> block_comp_elem_alt_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">bl</span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="free">bl</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_complement_def block_complement_elem_iff<span class="main">)</span>

<span class="keyword1" id="Design_Basics-block_comp_elem_alt_right"><span class="command">lemma</span></span> block_comp_elem_alt_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">ps</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">bl</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="free">bl</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_complement_elem_iff<span class="main">)</span>

<span class="keyword1" id="Design_Basics-complement_index"><span class="command">lemma</span></span> complement_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">ps</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">b</span><span class="main">)</span> <span class="main">#}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span>  size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="main">{#</span> <span class="bound">bl</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">#}</span><span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complement_blocks_def points_index_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> size <span class="main">{#</span> <span class="bound">bl</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span> <span class="main">|</span> <span class="bound"><span class="bound">bl</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span> <span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_mset_filter_swap<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_complement_elem_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Basics-complement_index_2"><span class="command">lemma</span></span> complement_index_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∉</span> <span class="bound">b</span> <span class="main">#}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="main">∀</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∉</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∉</span> <span class="bound">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∉</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">∀</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">.</span> <span class="bound">x'</span> <span class="main">∉</span> <span class="bound">b</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms a complement_index
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span> filter_mset_cong<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Basics-complement_rep_number"><span class="command">lemma</span></span> complement_rep_number<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> <span class="free">r</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> 𝖻 <span class="main">-</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="bound">b</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_complement_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> block_complement_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>image_mset block_complement <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> <span class="bound">b</span><span class="main">#}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> a filter_mset_cong image_mset_filter_swap2 point_replication_number_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_SIG<span class="main"><span class="main">)</span></span> size_image_mset<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">=</span> size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">+</span> size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> <span class="bound">b</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> multiset_partition size_union<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> alt
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r complement_blocks_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Basics-complement_blocks_wf"><span class="command">lemma</span></span> complement_blocks_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complement_blocks_def block_complement_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-complement_wf"><span class="command">lemma</span></span> complement_wf <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> complement_blocks_wf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> sys_complement<span class="main">:</span> incidence_system <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> complement_wf <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> finite_incidence_system
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Design_Basics-block_complement_size"><span class="command">lemma</span></span> block_complement_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">b</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span><span class="main">)</span> <span class="main">=</span> card <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> card <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_complement_def card_Diff_subset finite_subset card_mono of_nat_diff finite_sets<span class="main">)</span>  

<span class="keyword1" id="Design_Basics-block_comp_incomplete"><span class="command">lemma</span></span> block_comp_incomplete<span class="main">:</span> <span class="quoted"><span class="quoted">"incomplete_block <span class="free">bl</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">bl</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> block_complement_size <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed<span class="main">)</span> 

<span class="keyword1" id="Design_Basics-block_comp_incomplete_nempty"><span class="command">lemma</span></span>  block_comp_incomplete_nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"incomplete_block <span class="free">bl</span> <span class="main">⟹</span> <span class="free">bl</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wellformed block_complement_def finite_blocks
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_complement_size block_comp_incomplete card_subset_not_gt_card<span class="main">)</span>

<span class="keyword1" id="Design_Basics-incomplete_block_proper_subset"><span class="command">lemma</span></span> incomplete_block_proper_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"incomplete_block <span class="free">bl</span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">⊂</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wellformed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Design_Basics-complement_finite"><span class="command">lemma</span></span> complement_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> complement_wf finite_sets <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incidence_system.finite_sysI<span class="main">)</span> 

<span class="keyword1"><span class="command">interpretation</span></span> comp_fin<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> complement_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> design
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> design<span class="main">)</span> complement_design<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> incomplete_block <span class="bound">bl</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"design <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> fin<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> complement_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms block_comp_incomplete_nempty wellformed 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complement_blocks_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Multiples›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An easy way to construct new set systems is to simply multiply the block collection by some 
constant›</span></span>

<span class="keyword1"><span class="command">context</span></span> incidence_system 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">multiple_blocks</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> set multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">multiple_blocks</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> repeat_mset <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>

<span class="keyword1" id="Design_Basics-multiple_block_in_original"><span class="command">lemma</span></span> multiple_block_in_original<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> multiple_blocks <span class="free">n</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> elem_in_repeat_in_original<span class="main">)</span> 

<span class="keyword1" id="Design_Basics-multiple_block_in"><span class="command">lemma</span></span> multiple_block_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span>  <span class="free">b</span> <span class="main">∈#</span> multiple_blocks <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> elem_in_original_in_repeat<span class="main">)</span>

<span class="keyword1" id="Design_Basics-multiple_blocks_gt"><span class="command">lemma</span></span> multiple_blocks_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> size <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span> <span class="main">≥</span> size <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Design_Basics-block_original_count_le"><span class="command">lemma</span></span> block_original_count_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> count <span class="keyword1"><span class="free">ℬ</span></span> <span class="free">b</span> <span class="main">≤</span> count <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> count_repeat_mset <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1" id="Design_Basics-multiple_blocks_sub"><span class="command">lemma</span></span> multiple_blocks_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⊆#</span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_subset_eqI block_original_count_le<span class="main">)</span> 

<span class="keyword1" id="Design_Basics-multiple_1_same"><span class="command">lemma</span></span> multiple_1_same<span class="main">:</span> <span class="quoted"><span class="quoted">"multiple_blocks <span class="main">1</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Design_Basics-multiple_unfold_1"><span class="command">lemma</span></span> multiple_unfold_1<span class="main">:</span> <span class="quoted"><span class="quoted">"multiple_blocks <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Design_Basics-multiple_point_rep_num"><span class="command">lemma</span></span> multiple_point_rep_num<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiple_blocks <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.IH Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_commute point_replication_number_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_distrib<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Basics-multiple_point_index"><span class="command">lemma</span></span> multiple_point_index<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span><span class="main">)</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def<span class="main">)</span>

<span class="keyword1" id="Design_Basics-repeat_mset_block_point_rel"><span class="command">lemma</span></span> repeat_mset_block_point_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> multiple_blocks  <span class="free">n</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">meson</span> subset_iff wellformed<span class="main">)</span>

<span class="keyword1" id="Design_Basics-multiple_is_wellformed"><span class="command">lemma</span></span> multiple_is_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> repeat_mset_subset_in wellformed repeat_mset_block_point_rel <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Design_Basics-multiple_blocks_num"><span class="command">lemma</span></span>  multiple_blocks_num <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span><span class="main">*</span>𝖻"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">interpretation</span></span> mult_sys<span class="main">:</span> incidence_system <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiple_is_wellformed<span class="main">)</span>

<span class="keyword1" id="Design_Basics-multiple_block_multiplicity"><span class="command">lemma</span></span> multiple_block_multiplicity <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mult_sys.multiplicity <span class="free">n</span> <span class="free">bl</span> <span class="main">=</span> <span class="main">(</span>multiplicity <span class="free">bl</span><span class="main">)</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Design_Basics-multiple_block_sizes_same"><span class="command">lemma</span></span> multiple_block_sizes_same<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sys_block_sizes <span class="main">=</span> mult_sys.sys_block_sizes <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> def<span class="main">:</span> <span class="quoted"><span class="quoted">"mult_sys.sys_block_sizes <span class="free">n</span> <span class="main">=</span> <span class="main">{</span>card <span class="bound">bl</span> <span class="main">|</span> <span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_sys.sys_block_sizes_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms multiple_block_in multiple_block_in_original <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sys_block_sizes_def eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> finite_incidence_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Design_Basics-multiple_is_finite"><span class="command">lemma</span></span> multiple_is_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> multiple_is_wellformed finite_sets <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incidence_system_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> design
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Design_Basics-multiple_is_design"><span class="command">lemma</span></span> multiple_is_design<span class="main">:</span> <span class="quoted"><span class="quoted">"design <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> fis<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="quoted">"multiple_blocks <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> multiple_is_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> blocks_nempty
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> elem_in_repeat_in_original repeat_mset_not_empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Simple Designs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simple designs are those in which the multiplicity of each block is at most one. 
In other words, the block collection is a set. This can significantly ease reasoning.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> simple_incidence_system <span class="main">=</span> incidence_system <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> simple <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> multiplicity <span class="free">bl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1" id="Design_Basics-simple_alt_def_all"><span class="command">lemma</span></span> simple_alt_def_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> multiplicity <span class="bound">bl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simple <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1" id="Design_Basics-simple_blocks_eq_sup"><span class="command">lemma</span></span> simple_blocks_eq_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_set <span class="main">(</span>design_support<span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_mset_def simple design_support_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_mset_set_mset_ident<span class="main">)</span> 

<span class="keyword1" id="Design_Basics-simple_block_size_eq_card"><span class="command">lemma</span></span> simple_block_size_eq_card<span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">=</span> card <span class="main">(</span>design_support<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> simple_blocks_eq_sup size_mset_set<span class="main">)</span>

<span class="keyword1" id="Design_Basics-points_index_simple_def"><span class="command">lemma</span></span> points_index_simple_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> design_support <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> design_support_def points_index_def card_size_filter_eq simple_blocks_eq_sup
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_set_mset<span class="main">)</span> 

<span class="keyword1" id="Design_Basics-replication_num_simple_def"><span class="command">lemma</span></span> replication_num_simple_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> design_support <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> design_support_def point_replication_number_def card_size_filter_eq simple_blocks_eq_sup
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_set_mset<span class="main">)</span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> simple_design <span class="main">=</span> design <span class="main">+</span> simple_incidence_system

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additional reasoning about when something is not simple›</span></span>
<span class="keyword1"><span class="command">context</span></span> incidence_system
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Design_Basics-simple_not_multiplicity"><span class="command">lemma</span></span> simple_not_multiplicity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> multiplicity  <span class="free">b</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">¬</span> simple_incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simple_incidence_system_def simple_incidence_system_axioms_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat_neq_iff<span class="main">)</span> 

<span class="keyword1" id="Design_Basics-multiple_not_simple"><span class="command">lemma</span></span> multiple_not_simple<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> simple_incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"simple_incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> count <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span> <span class="bound">bl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> elem_in_original_in_repeat
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_gr_zero not_less_zero simple_incidence_system.simple<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proper Designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Many types of designs rely on parameter conditions that only make sense for non-empty designs. 
i.e. designs with at least one block, and therefore given well-formed condition, at least one point. 
To this end we define the notion of a "proper" design›</span></span>

<span class="keyword1"><span class="command">locale</span></span> proper_design <span class="main">=</span> design <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> b_non_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Design_Basics-is_proper"><span class="command">lemma</span></span> is_proper<span class="main">:</span> <span class="quoted"><span class="quoted">"proper_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_locales</span>

<span class="keyword1" id="Design_Basics-v_non_zero"><span class="command">lemma</span></span> v_non_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> b_non_zero v_eq0_imp_b_eq_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Design_Basics-b_positive"><span class="command">lemma</span></span> b_positive<span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_non_zero
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonempty_has_size<span class="main">)</span>

<span class="keyword1" id="Design_Basics-design_points_nempty"><span class="command">lemma</span></span> design_points_nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒱</span></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> v_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Design_Basics-design_blocks_nempty"><span class="command">lemma</span></span> design_blocks_nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> b_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intro rules for a proper design›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> design<span class="main">)</span> proper_designI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> proper_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Design_Basics-proper_designII"><span class="command">lemma</span></span> proper_designII<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"design <span class="free">V</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proper_design <span class="free">V</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> design <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">B</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reasoning on construction closure for proper designs›</span></span>
<span class="keyword1"><span class="command">context</span></span> proper_design
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Design_Basics-multiple_proper_design"><span class="command">lemma</span></span> multiple_proper_design<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proper_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> multiple_is_design assms design_blocks_nempty multiple_block_in
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> block_set_nempty_imp_block_ex empty_iff proper_designII set_mset_empty<span class="main">)</span> 

<span class="keyword1" id="Design_Basics-complement_proper_design"><span class="command">lemma</span></span> complement_proper_design<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> incomplete_block <span class="bound">bl</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proper_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> design <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms complement_design<span class="main">)</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> b_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Design_Operations">
<div class="head">
<h1>Theory Design_Operations</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Design_Operations <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Design_Basics">Design_Basics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Design Operations›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Incidence systems have a number of very typical computational operations
which can be used for constructions in design theory. Definitions in this section are based off
the handbook of combinatorial designs, hypergraph theory \cite{bergeHypergraphsCombinatoricsFinite1989}, 
and the GAP design theory library \cite{soicherDesignsGroupsComputing2013}›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Incidence system definitions›</span></span>

<span class="keyword1"><span class="command">context</span></span> incidence_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The basic add point operation only affects the point set of a design›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_point</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">add_point</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> insert <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>

<span class="keyword1" id="Design_Operations-add_existing_point"><span class="command">lemma</span></span> add_existing_point <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> add_point <span class="free">p</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_point_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Design_Operations-add_point_wf"><span class="command">lemma</span></span> add_point_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"incidence_system <span class="main">(</span>add_point <span class="free">p</span><span class="main">)</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_invalid_point add_point_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An extension of the basic add point operation also adds the point to a given set of blocks›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_point_to_blocks</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">add_point_to_blocks</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">≡</span> <span class="main">{#</span> <span class="main">(</span>insert <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">b</span><span class="main">)</span> <span class="main">|</span> <span class="bound"><span class="bound">b</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">#}</span>"</span></span>

<span class="keyword1" id="Design_Operations-add_point_blocks_blocks_alt"><span class="command">lemma</span></span> add_point_blocks_blocks_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"add_point_to_blocks <span class="free">p</span> <span class="free">bs</span> <span class="main">=</span> 
    image_mset <span class="main">(</span>insert <span class="free">p</span><span class="main">)</span> <span class="main">(</span>filter_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">bs</span><span class="main">)</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>filter_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∉</span> <span class="free">bs</span><span class="main">)</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_point_to_blocks_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Design_Operations-add_point_existing_blocks"><span class="command">lemma</span></span> add_point_existing_blocks<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈</span> <span class="free">bs</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"add_point_to_blocks <span class="free">p</span> <span class="free">bs</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_point_to_blocks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"image_mset <span class="main">(</span>insert <span class="free">p</span><span class="main">)</span> <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">bs</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">bs</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_filter_cong insert_absorb<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"image_mset <span class="main">(</span>insert <span class="free">p</span><span class="main">)</span> <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">bs</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="bound">b</span> <span class="main">∉</span> <span class="free">bs</span><span class="main">#}</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> multiset_partition <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Operations-add_new_point_rep_number"><span class="command">lemma</span></span> add_new_point_rep_number<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_point_to_blocks <span class="free">p</span> <span class="free">bs</span><span class="main">)</span> <span class="keyword1">rep</span> <span class="free">p</span> <span class="main">=</span> size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">bs</span><span class="main">#}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∉</span> <span class="free">bs</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∉</span> <span class="bound">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms wf_invalid_point<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∉</span> <span class="free">bs</span><span class="main">#}</span> <span class="keyword1">rep</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_mset_empty_conv point_replication_number_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_point_to_blocks <span class="free">p</span> <span class="free">bs</span><span class="main">)</span> <span class="keyword1">rep</span> <span class="free">p</span> <span class="main">=</span> <span class="main">{#</span> <span class="main">(</span>insert <span class="free">p</span> <span class="bound">b</span><span class="main">)</span> <span class="main">|</span> <span class="bound"><span class="bound">b</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">bs</span><span class="main">#}</span> <span class="keyword1">rep</span> <span class="free">p</span> <span class="main">+</span> <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∉</span> <span class="free">bs</span><span class="main">#}</span> <span class="keyword1">rep</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_point_to_blocks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_point_to_blocks <span class="free">p</span> <span class="free">bs</span><span class="main">)</span> <span class="keyword1">rep</span> <span class="free">p</span> <span class="main">=</span> <span class="main">{#</span> <span class="main">(</span>insert <span class="free">p</span> <span class="bound">b</span><span class="main">)</span> <span class="main">|</span> <span class="bound"><span class="bound">b</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">bs</span><span class="main">#}</span> <span class="keyword1">rep</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="main">{#</span> <span class="main">(</span>insert <span class="free">p</span> <span class="bound">b</span><span class="main">)</span> <span class="main">|</span> <span class="bound"><span class="bound">b</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">bs</span><span class="main">#}</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">bl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="main">(</span>insert <span class="free">p</span> <span class="bound">b</span><span class="main">)</span> <span class="main">|</span> <span class="bound"><span class="bound">b</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">bs</span><span class="main">#}</span> <span class="keyword1">rep</span> <span class="free">p</span> <span class="main">=</span> size <span class="main">{#</span> <span class="main">(</span>insert <span class="free">p</span> <span class="bound">b</span><span class="main">)</span> <span class="main">|</span> <span class="bound"><span class="bound">b</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">bs</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> point_replication_number_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filter_mset_True filter_mset_cong<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Operations-add_point_blocks_wf"><span class="command">lemma</span></span> add_point_blocks_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"incidence_system <span class="main">(</span>add_point <span class="free">p</span><span class="main">)</span> <span class="main">(</span>add_point_to_blocks <span class="free">p</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_point_def wf_invalid_point add_point_to_blocks_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic (weak) delete point operation removes a point from both the point set and from any 
blocks that contain it to maintain wellformed property›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">del_point</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">del_point</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">del_point_blocks</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">del_point_blocks</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">{#</span> <span class="main">(</span><span class="bound">bl</span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">#}</span>"</span></span>

<span class="keyword1" id="Design_Operations-del_point_block_count"><span class="command">lemma</span></span> del_point_block_count<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>del_point_blocks <span class="free">p</span><span class="main">)</span> <span class="main">=</span> size <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> del_point_blocks_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-remove_invalid_point_block"><span class="command">lemma</span></span> remove_invalid_point_block<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">=</span> <span class="free">bl</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_invalid_point <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Design_Operations-del_invalid_point"><span class="command">lemma</span></span> del_invalid_point<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> del_point_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-del_invalid_point_blocks"><span class="command">lemma</span></span> del_invalid_point_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="main">(</span>del_point_blocks <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> del_invalid_point
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_invalid_point_block del_point_blocks_def<span class="main">)</span> 

<span class="keyword1" id="Design_Operations-delete_point_p_not_in_bl_blocks"><span class="command">lemma</span></span> delete_point_p_not_in_bl_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∉</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>del_point_blocks <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> del_point_blocks_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-delete_point_blocks_wf"><span class="command">lemma</span></span> delete_point_blocks_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="main">(</span>del_point_blocks <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> del_point_blocks_def <span class="keyword1"><span class="command">using</span></span> wellformed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Design_Operations-delete_point_blocks_sub"><span class="command">lemma</span></span> delete_point_blocks_sub<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="main">(</span>del_point_blocks <span class="free">p</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">bl</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">b</span> <span class="main">⊆</span> <span class="free">bl</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> del_point_blocks_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-delete_point_split_blocks"><span class="command">lemma</span></span> delete_point_split_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"del_point_blocks <span class="free">p</span> <span class="main">=</span> 
  <span class="main">{#</span> <span class="bound">bl</span> <span class="main">∈#</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">p</span> <span class="main">∉</span> <span class="bound">bl</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span> <span class="bound">bl</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">|</span> <span class="bound"><span class="bound">bl</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">#}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> sm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="free">p</span> <span class="main">∉</span> <span class="bound">bl</span> <span class="main">⟹</span> <span class="bound">bl</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">=</span> <span class="bound">bl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"del_point_blocks <span class="free">p</span> <span class="main">=</span> <span class="main">{#</span> <span class="main">(</span><span class="bound">bl</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> del_point_blocks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{#</span> <span class="main">(</span><span class="bound">bl</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="main">|</span> <span class="bound"><span class="bound">bl</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">p</span> <span class="main">∉</span> <span class="bound">bl</span> <span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span> <span class="main">(</span><span class="bound">bl</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="main">|</span> <span class="bound"><span class="bound">bl</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> multiset_partition <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_mset_union union_commute<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"del_point_blocks <span class="free">p</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">bl</span> <span class="main">|</span> <span class="bound"><span class="bound">bl</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">p</span> <span class="main">∉</span> <span class="bound">bl</span><span class="main">#}</span> <span class="main">+</span> 
      <span class="main">{#</span> <span class="main">(</span><span class="bound">bl</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="main">|</span> <span class="bound"><span class="bound">bl</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sm mem_Collect_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Multiset.set_mset_filter  multiset.map_cong<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Operations-delete_point_index_eq"><span class="command">lemma</span></span> delete_point_index_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>del_point_blocks <span class="free">p</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_mset <span class="main">(</span><span class="main">(⊆)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">{#</span><span class="bound">bl</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">#}</span> <span class="main">=</span> 
      image_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>filter_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">b</span><span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_mset_image_mset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> <span class="free">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms del_point_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">bl</span> <span class="main">⟷</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">bl</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>filter_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">b</span><span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>filter_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">b</span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>image_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>filter_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">b</span><span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> del_point_blocks_def points_index_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Operations-delete_point_wf"><span class="command">lemma</span></span> delete_point_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"incidence_system <span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span> <span class="main">(</span>del_point_blocks <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> delete_point_blocks_wf del_point_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The concept of a strong delete point comes from hypergraph theory. When a point is deleted, 
any blocks containing it are also deleted›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">str_del_point_blocks</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">str_del_point_blocks</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">{#</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∉</span> <span class="bound">bl</span><span class="main">#}</span>"</span></span>

<span class="keyword1" id="Design_Operations-str_del_point_blocks_alt"><span class="command">lemma</span></span> str_del_point_blocks_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"str_del_point_blocks <span class="free">p</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">#}</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> add_diff_cancel_left' multiset_partition <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> str_del_point_blocks_def<span class="main">)</span> 

<span class="keyword1" id="Design_Operations-delete_point_strong_block_in"><span class="command">lemma</span></span> delete_point_strong_block_in<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> <span class="free">bl</span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>  <span class="main">⟹</span> <span class="free">bl</span> <span class="main">∈#</span> str_del_point_blocks <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> str_del_point_blocks_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-delete_point_strong_block_not_in"><span class="command">lemma</span></span> delete_point_strong_block_not_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">bl</span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">∉#</span> <span class="main">(</span>str_del_point_blocks<span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> str_del_point_blocks_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-delete_point_strong_block_in_iff"><span class="command">lemma</span></span> delete_point_strong_block_in_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">∈#</span> str_del_point_blocks <span class="free">p</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">∉</span> <span class="free">bl</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> delete_point_strong_block_in delete_point_strong_block_not_in
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> str_del_point_blocks_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-delete_point_strong_block_subset"><span class="command">lemma</span></span> delete_point_strong_block_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"str_del_point_blocks <span class="free">p</span> <span class="main">⊆#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> str_del_point_blocks_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-delete_point_strong_block_in_orig"><span class="command">lemma</span></span> delete_point_strong_block_in_orig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> str_del_point_blocks <span class="free">p</span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> delete_point_strong_block_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_subset_eqD<span class="main">)</span> 

<span class="keyword1" id="Design_Operations-delete_invalid_pt_strong_eq"><span class="command">lemma</span></span> delete_invalid_pt_strong_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">=</span> str_del_point_blocks <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> str_del_point_blocks_def <span class="keyword1"><span class="command">using</span></span> wf_invalid_point empty_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Multiset.diff_cancel filter_mset_eq_conv set_mset_empty subset_mset.order_refl<span class="main">)</span>

<span class="keyword1" id="Design_Operations-strong_del_point_index_alt"><span class="command">lemma</span></span> strong_del_point_index_alt<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>str_del_point_blocks <span class="free">p</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> 
    <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">-</span> <span class="main">{#</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">#}</span> <span class="keyword1">index</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> str_del_point_blocks_alt points_index_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filter_diff_mset multiset_filter_mono multiset_filter_subset  size_Diff_submset<span class="main">)</span>

<span class="keyword1" id="Design_Operations-strong_del_point_incidence_wf"><span class="command">lemma</span></span> strong_del_point_incidence_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"incidence_system <span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span> <span class="main">(</span>str_del_point_blocks <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wellformed str_del_point_blocks_def del_point_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Add block operation›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_block</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
<span class="quoted"><span class="quoted">"<span class="free">add_block</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">#}</span>"</span></span>

<span class="keyword1" id="Design_Operations-add_block_alt"><span class="command">lemma</span></span> add_block_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"add_block <span class="free">b</span> <span class="main">=</span> add_mset <span class="free">b</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_block_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-add_block_rep_number_in"><span class="command">lemma</span></span> add_block_rep_number_in<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_block <span class="free">b</span><span class="main">)</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_block <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="main">+</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_block_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_block <span class="free">b</span><span class="main">)</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">+</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> point_rep_number_split<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Operations-add_block_rep_number_not_in"><span class="command">lemma</span></span> add_block_rep_number_not_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">(</span>add_block <span class="free">b</span><span class="main">)</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> point_rep_number_split add_block_alt point_rep_singleton_inval
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral union_mset_add_mset_right<span class="main">)</span>

<span class="keyword1" id="Design_Operations-add_block_index_in"><span class="command">lemma</span></span> add_block_index_in<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_block <span class="free">b</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_block <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="main">+</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_block_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_block <span class="free">b</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">+</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> point_index_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms points_index_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> split <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Operations-add_block_index_not_in"><span class="command">lemma</span></span> add_block_index_not_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">ps</span> <span class="main">⊆</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>add_block <span class="free">b</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> point_index_distrib points_index_singleton_zero
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral add_block_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note the add block incidence system is defined slightly differently then textbook 
definitions due to the modification to the point set. This ensures the operation is closed, 
where otherwise a condition that $b \subseteq \mathcal{V}$ would be required.›</span></span>
<span class="keyword1" id="Design_Operations-add_block_wf"><span class="command">lemma</span></span> add_block_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"incidence_system <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">∪</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>add_block <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wellformed add_block_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Design_Operations-add_block_wf_cond"><span class="command">lemma</span></span> add_block_wf_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>add_block <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_block_wf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sup.order_iff<span class="main">)</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Delete block removes a block from the block set. The point set is unchanged›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">del_block</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">del_block</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">#}</span>"</span></span>

<span class="keyword1" id="Design_Operations-delete_block_subset"><span class="command">lemma</span></span> delete_block_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>del_block <span class="free">b</span><span class="main">)</span> <span class="main">⊆#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> del_block_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-delete_invalid_block_eq"><span class="command">lemma</span></span> delete_invalid_block_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> del_block <span class="free">b</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> del_block_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-delete_block_wf"><span class="command">lemma</span></span> delete_block_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>del_block <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> del_block_def in_diffD wellformed<span class="main">)</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The strong delete block operation effectively deletes the block, as well as 
all points in that block›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">str_del_block</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">str_del_block</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">{#</span> <span class="bound">bl</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">|</span> <span class="bound"><span class="bound">bl</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#}</span>"</span></span>

<span class="keyword1" id="Design_Operations-strong_del_block_alt_def"><span class="command">lemma</span></span> strong_del_block_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"str_del_block <span class="free">b</span> <span class="main">=</span> <span class="main">{#</span> <span class="bound">bl</span> <span class="main">-</span> <span class="free">b</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> removeAll_mset <span class="free">b</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_mset_neq str_del_block_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-strong_del_block_wf"><span class="command">lemma</span></span> strong_del_block_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"incidence_system <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>str_del_block <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_invalid_point str_del_block_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Design_Operations-str_del_block_del_point"><span class="command">lemma</span></span> str_del_block_del_point<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∉#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"str_del_block <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span>del_point_blocks <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> neqx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="bound">bl</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"str_del_block <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{#</span> <span class="bound">bl</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound"><span class="bound">bl</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> str_del_block_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"str_del_block <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{#</span> <span class="bound">bl</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms neqx
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_mset_cong<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> del_point_blocks_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Incidence System Interpretations›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It is easy to interpret all operations as incidence systems in there own right. 
These can then be used to prove local properties on the new constructions, as well 
as reason on interactions between different operation sequences›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> add_point_sys<span class="main">:</span> incidence_system <span class="quoted"><span class="quoted">"add_point <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_point_wf <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Design_Operations-add_point_sys_rep_numbers"><span class="command">lemma</span></span> add_point_sys_rep_numbers<span class="main">:</span> <span class="quoted"><span class="quoted">"add_point_sys.replication_numbers <span class="free">p</span> <span class="main">=</span> 
    replication_numbers <span class="main">∪</span> <span class="main">{</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_point_sys.replication_numbers_def replication_numbers_def add_point_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> del_point_sys<span class="main">:</span> incidence_system <span class="quoted"><span class="quoted">"del_point <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"del_point_blocks <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> delete_point_wf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> add_block_sys<span class="main">:</span> incidence_system <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒱</span></span> <span class="main">∪</span> <span class="free">bl</span>"</span></span> <span class="quoted"><span class="quoted">"add_block <span class="free">bl</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_block_wf <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">interpretation</span></span> del_block_sys<span class="main">:</span> incidence_system <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="quoted"><span class="quoted">"del_block <span class="free">bl</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> delete_block_wf <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1" id="Design_Operations-add_del_block_inv"><span class="command">lemma</span></span> add_del_block_inv<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"add_block_sys.del_block <span class="free">bl</span> <span class="free">bl</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_block_sys.del_block_def add_block_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Design_Operations-del_add_block_inv"><span class="command">lemma</span></span> del_add_block_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> del_block_sys.add_block <span class="free">bl</span> <span class="free">bl</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> del_block_sys.add_block_def del_block_def wellformed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Design_Operations-del_invalid_add_block_eq"><span class="command">lemma</span></span> del_invalid_add_block_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∉#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> del_block_sys.add_block <span class="free">bl</span> <span class="free">bl</span> <span class="main">=</span> add_block <span class="free">bl</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> del_block_sys.add_block_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_invalid_block_eq<span class="main">)</span> 

<span class="keyword1" id="Design_Operations-add_delete_point_inv"><span class="command">lemma</span></span> add_delete_point_inv<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"add_point_sys.del_point <span class="free">p</span> <span class="free">p</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_point_sys.del_point <span class="free">p</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>insert <span class="free">p</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_point_sys.del_point_def del_block_sys.add_point_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operation Closure for Designs›</span></span>

<span class="keyword1"><span class="command">context</span></span> finite_incidence_system 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Design_Operations-add_point_finite"><span class="command">lemma</span></span> add_point_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_incidence_system <span class="main">(</span>add_point <span class="free">p</span><span class="main">)</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_point_wf finite_sets add_point_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incidence_system_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-add_point_to_blocks_finite"><span class="command">lemma</span></span> add_point_to_blocks_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_incidence_system <span class="main">(</span>add_point <span class="free">p</span><span class="main">)</span> <span class="main">(</span>add_point_to_blocks <span class="free">p</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_point_blocks_wf add_point_finite finite_incidence_system.finite_sets 
    incidence_system.finite_sysI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Design_Operations-delete_point_finite"><span class="command">lemma</span></span> delete_point_finite<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"finite_incidence_system <span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span> <span class="main">(</span>del_point_blocks <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_sets delete_point_wf 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incidence_system_def del_point_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-del_point_order"><span class="command">lemma</span></span> del_point_order<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span> <span class="main">=</span> 𝗏 <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> vg0<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms finite_sets card_gt_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span> <span class="main">=</span> card <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms del_point_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_Diff_singleton finite_sets<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> vg0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Operations-strong_del_point_finite"><span class="command">lemma</span></span> strong_del_point_finite<span class="main">:</span><span class="quoted"><span class="quoted">"finite_incidence_system <span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span> <span class="main">(</span>str_del_point_blocks <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> strong_del_point_incidence_wf del_point_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_incidence_system_axioms_def finite_sets<span class="main">)</span>

<span class="keyword1" id="Design_Operations-add_block_fin"><span class="command">lemma</span></span> add_block_fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">b</span> <span class="main">⟹</span> finite_incidence_system <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">∪</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>add_block <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_invalid_point finite_sets add_block_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Design_Operations-add_block_fin_cond"><span class="command">lemma</span></span> add_block_fin_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> finite_incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>add_block <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_block_wf_cond finite_incidence_system_axioms.intro finite_sets
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Design_Operations-delete_block_fin_incidence_sys"><span class="command">lemma</span></span> delete_block_fin_incidence_sys<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>del_block <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> delete_block_wf finite_sets <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incidence_system_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-strong_del_block_fin"><span class="command">lemma</span></span> strong_del_block_fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_incidence_system <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>str_del_block <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> strong_del_block_wf finite_sets finite_incidence_system_axioms_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_locales</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> design
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Design_Operations-add_point_design"><span class="command">lemma</span></span> add_point_design<span class="main">:</span> <span class="quoted"><span class="quoted">"design <span class="main">(</span>add_point <span class="free">p</span><span class="main">)</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_point_wf finite_sets blocks_nempty add_point_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incidence_system_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-delete_point_design"><span class="command">lemma</span></span> delete_point_design<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">⟹</span> card <span class="bound">bl</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"design <span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span> <span class="main">(</span>del_point_blocks <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">interpret</span></span> fis<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="quoted">"<span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>del_point_blocks <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> delete_point_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>del_point_blocks <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">bl</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms del_point_def 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bl</span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bl</span> <span class="main">∈#</span><span class="main">(</span>del_point_blocks <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bl'</span></span> <span class="keyword2"><span class="keyword">where</span></span> block<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bl'</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bl</span> <span class="main">=</span> <span class="skolem">bl'</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> del_point_blocks_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> <span class="skolem">bl'</span> <span class="main">⟹</span> <span class="skolem">bl</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> block blocks_nempty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rem<span class="main">)</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="skolem">bl'</span> <span class="main">⟹</span> card <span class="skolem">bl</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rem finite_blocks block assms block <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bl</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  eq assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> del_invalid_point del_invalid_point_blocks
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_design<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Operations-strong_del_point_design"><span class="command">lemma</span></span> strong_del_point_design<span class="main">:</span> <span class="quoted"><span class="quoted">"design <span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span> <span class="main">(</span>str_del_point_blocks <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> fin<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="quoted">"<span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>str_del_point_blocks <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> strong_del_point_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> wf_design wf_design_iff del_point_def str_del_point_blocks_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Operations-add_block_design"><span class="command">lemma</span></span> add_block_design<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">bl</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"design <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">∪</span> <span class="free">bl</span><span class="main">)</span> <span class="main">(</span>add_block <span class="free">bl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">interpret</span></span> fin<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">∪</span> <span class="free">bl</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_block <span class="free">bl</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> add_block_fin assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> blocks_nempty assms add_block_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Operations-add_block_design_cond"><span class="command">lemma</span></span> add_block_design_cond<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"design <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>add_block <span class="free">bl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> fin<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_block <span class="free">bl</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> add_block_fin_cond assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> blocks_nempty assms add_block_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Operations-delete_block_design"><span class="command">lemma</span></span> delete_block_design<span class="main">:</span> <span class="quoted"><span class="quoted">"design <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>del_block <span class="free">bl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> fin<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>del_block <span class="free">bl</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> delete_block_fin_incidence_sys <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="main">(</span>del_block <span class="free">bl</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> blocks_nempty delete_block_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Operations-strong_del_block_des"><span class="command">lemma</span></span> strong_del_block_des<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">bl</span> <span class="main">⊂</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"design <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>str_del_block <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> fin<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>str_del_block <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> strong_del_block_fin <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms str_del_block_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> proper_design
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Design_Operations-delete_point_proper"><span class="command">lemma</span></span> delete_point_proper<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">⟹</span> <span class="numeral">2</span> <span class="main">≤</span> card <span class="bound">bl</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proper_design <span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span> <span class="main">(</span>del_point_blocks <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> design <span class="quoted"><span class="quoted">"del_point <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"del_point_blocks <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> delete_point_design assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> design_blocks_nempty del_point_def del_point_blocks_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Operations-strong_delete_point_proper"><span class="command">lemma</span></span> strong_delete_point_proper<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">⟹</span> <span class="numeral">2</span> <span class="main">≤</span> card <span class="bound">bl</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">p</span> <span class="main">&lt;</span> 𝖻"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proper_design <span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span> <span class="main">(</span>str_del_point_blocks <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> design <span class="quoted"><span class="quoted">"del_point <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"str_del_point_blocks <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> strong_del_point_design assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms design_blocks_nempty point_rep_num_inv_non_empty 
    str_del_point_blocks_def del_point_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Combining Set Systems›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Similar to multiple, another way to construct a new set system is to combine two existing ones.
We introduce a new locale enabling us to reason on two different incidence systems›</span></span>
<span class="keyword1"><span class="command">locale</span></span> two_set_systems <span class="main">=</span> sys1<span class="main">:</span> incidence_system <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="main">+</span> sys2<span class="main">:</span> incidence_system <span class="quoted"><span class="free">𝒱'</span></span> <span class="quoted"><span class="free">ℬ'</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">𝒱</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℬ</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒱'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℬ'</span>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">combine_points</span> <span class="main">≡</span> <span class="free">𝒱</span> <span class="main">∪</span> <span class="free">𝒱'</span>"</span></span> 

<span class="keyword1"><span class="command">notation</span></span> combine_points <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">combine_blocks</span> <span class="main">≡</span> <span class="free">ℬ</span> <span class="main">+</span> <span class="free">ℬ'</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> combine_blocks <span class="main">(</span><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> combine_sys<span class="main">:</span> incidence_system <span class="quoted"><span class="quoted">"<span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sys1.wellformed sys2.wellformed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Design_Operations-combine_points_index"><span class="command">lemma</span></span> combine_points_index<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">ℬ</span> <span class="keyword1">index</span> <span class="free">ps</span>  <span class="main">+</span> <span class="free">ℬ'</span> <span class="keyword1">index</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_index_distrib<span class="main">)</span>

<span class="keyword1" id="Design_Operations-combine_rep_number"><span class="command">lemma</span></span> combine_rep_number<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> <span class="free">ℬ</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">+</span> <span class="free">ℬ'</span> <span class="keyword1">rep</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def<span class="main">)</span>

<span class="keyword1" id="Design_Operations-combine_multiple1"><span class="command">lemma</span></span> combine_multiple1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒱</span> <span class="main">=</span> <span class="free">𝒱'</span> <span class="main">⟹</span> <span class="free">ℬ</span> <span class="main">=</span> <span class="free">ℬ'</span> <span class="main">⟹</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">=</span> sys1.multiple_blocks <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Design_Operations-combine_multiple2"><span class="command">lemma</span></span> combine_multiple2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒱</span> <span class="main">=</span> <span class="free">𝒱'</span> <span class="main">⟹</span> <span class="free">ℬ</span> <span class="main">=</span> <span class="free">ℬ'</span> <span class="main">⟹</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">=</span> sys2.multiple_blocks <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Design_Operations-combine_multiplicity"><span class="command">lemma</span></span> combine_multiplicity<span class="main">:</span> <span class="quoted"><span class="quoted">"combine_sys.multiplicity <span class="free">b</span> <span class="main">=</span> sys1.multiplicity <span class="free">b</span> <span class="main">+</span> sys2.multiplicity <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Design_Operations-combine_block_sizes"><span class="command">lemma</span></span> combine_block_sizes<span class="main">:</span> <span class="quoted"><span class="quoted">"combine_sys.sys_block_sizes <span class="main">=</span> 
    sys1.sys_block_sizes <span class="main">∪</span> sys2.sys_block_sizes"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sys1.sys_block_sizes_def sys2.sys_block_sizes_def combine_sys.sys_block_sizes_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> two_fin_set_systems <span class="main">=</span> two_set_systems <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝒱'</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="main">+</span> sys1<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="main">+</span> 
  sys2<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="free">𝒱'</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="free">𝒱'</span> <span class="free">ℬ'</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  

<span class="keyword1"><span class="command">sublocale</span></span> combine_fin_sys<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="quoted">"<span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sys1.finite_sets sys2.finite_sets <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Design_Operations-combine_order"><span class="command">lemma</span></span> combine_order<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">≥</span> card <span class="free">𝒱</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Un_upper1 card_mono combine_fin_sys.finite_sets<span class="main">)</span>

<span class="keyword1" id="Design_Operations-combine_order_2"><span class="command">lemma</span></span>  combine_order_2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">≥</span> card <span class="free">𝒱'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Un_upper2 card_mono combine_fin_sys.finite_sets<span class="main">)</span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> two_designs <span class="main">=</span> two_fin_set_systems <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝒱'</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="main">+</span> des1<span class="main">:</span> design <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="main">+</span> 
  des2<span class="main">:</span> design <span class="quoted"><span class="free">𝒱'</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="free">𝒱'</span> <span class="free">ℬ'</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> combine_des<span class="main">:</span> design <span class="quoted"><span class="quoted">"<span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> des1.blocks_nempty_alt des2.blocks_nempty_alt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> two_designs_proper <span class="main">=</span> two_designs <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> blocks_nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℬ</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∨</span> <span class="free">ℬ'</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Design_Operations-des1_is_proper"><span class="command">lemma</span></span> des1_is_proper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℬ</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> proper_design <span class="free">𝒱</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Design_Operations-des2_is_proper"><span class="command">lemma</span></span> des2_is_proper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℬ'</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> proper_design <span class="free">𝒱'</span> <span class="free">ℬ'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Design_Operations-min_one_proper_design"><span class="command">lemma</span></span> min_one_proper_design<span class="main">:</span> <span class="quoted"><span class="quoted">"proper_design <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="main">∨</span> proper_design <span class="free">𝒱'</span> <span class="free">ℬ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> blocks_nempty des1_is_proper des2_is_proper <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> combine_proper_des<span class="main">:</span> proper_design <span class="quoted"><span class="quoted">"<span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> blocks_nempty of_nat_0_eq_iff size_eq_0_iff_empty subset_mset.zero_eq_add_iff_both_eq_0<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Block_Designs">
<div class="head">
<h1>Theory Block_Designs</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Block_Designs.thy
   Author: Chelsea Edmonds
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Block and Balanced Designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a selection of the many different types of block and balanced designs, building up 
to properties required for defining a BIBD, in addition to several base generalisations›</span></span> 

<span class="keyword1"><span class="command">theory</span></span> Block_Designs <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Design_Operations">Design_Operations</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Block Designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A block design is a design where all blocks have the same size.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹K Block Designs›</span></span> 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An important generalisation of a typical block design is the $\mathcal{K}$ block design, 
where all blocks must have a size $x$ where $x \in \mathcal{K}$›</span></span>
<span class="keyword1"><span class="command">locale</span></span> K_block_design <span class="main">=</span> proper_design <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sizes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">𝒦</span></span></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> block_sizes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="main">(</span>int <span class="main">(</span>card <span class="free">bl</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒦</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> positive_ints<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒦</span></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-sys_block_size_subset"><span class="command">lemma</span></span> sys_block_size_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"sys_block_sizes <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒦</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> block_sizes sys_block_sizes_obtain_bl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Uniform Block Design›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The typical uniform block design is defined below›</span></span>
<span class="keyword1"><span class="command">locale</span></span> block_design <span class="main">=</span> proper_design <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u_block_size</span> <span class="main">::</span> <span class="quoted">int</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">𝗄</span></span></span></span></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> uniform <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> card <span class="free">bl</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-k_non_zero"><span class="command">lemma</span></span> k_non_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bl</span></span> <span class="keyword2"><span class="keyword">where</span></span> bl_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> design_blocks_nempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>card <span class="skolem">bl</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> block_size_gt_0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_not_refl less_one not_le_imp_less of_nat_1 of_nat_less_iff<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bl_in<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Block_Designs-uniform_alt_def_all"><span class="command">lemma</span></span> uniform_alt_def_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span>card <span class="bound">bl</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uniform <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Block_Designs-uniform_unfold_point_set"><span class="command">lemma</span></span> uniform_unfold_point_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> card <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">bl</span><span class="main">}</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uniform wellformed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_conj_eq inf.absorb_iff2<span class="main">)</span> 

<span class="keyword1" id="Block_Designs-uniform_unfold_point_set_mset"><span class="command">lemma</span></span> uniform_unfold_point_set_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> size <span class="main">{#</span><span class="bound">p</span> <span class="main">∈#</span> mset_set <span class="keyword1"><span class="free">𝒱</span></span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">bl</span> <span class="main">#}</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uniform_unfold_point_set <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_sets<span class="main">)</span> 

<span class="keyword1" id="Block_Designs-sys_block_sizes_uniform"><span class="command">lemma</span></span> sys_block_sizes_uniform <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"sys_block_sizes  <span class="main">=</span> <span class="main">{</span><span class="keyword1"><span class="free">𝗄</span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sys_block_sizes <span class="main">=</span> <span class="main">{</span><span class="bound">bs</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bs</span> <span class="main">=</span> card <span class="bound">bl</span> <span class="main">∧</span> <span class="bound">bl</span><span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sys_block_sizes_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sys_block_sizes  <span class="main">=</span> <span class="main">{</span><span class="bound">bs</span> <span class="main">.</span> <span class="bound">bs</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> uniform uniform_unfold_point_set 
      b_positive block_set_nempty_imp_block_ex
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> Collect_cong design_blocks_nempty<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Block_Designs-sys_block_sizes_uniform_single"><span class="command">lemma</span></span> sys_block_sizes_uniform_single<span class="main">:</span> <span class="quoted"><span class="quoted">"is_singleton <span class="main">(</span>sys_block_sizes<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Block_Designs-uniform_size_incomp"><span class="command">lemma</span></span> uniform_size_incomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">≤</span> 𝗏 <span class="main">-</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> incomplete_block <span class="free">bl</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uniform k_non_zero of_nat_less_iff zle_diff1_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Block_Designs-uniform_complement_block_size"><span class="command">lemma</span></span> uniform_complement_block_size<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">bl</span> <span class="main">=</span> 𝗏 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bl'</span></span> <span class="keyword2"><span class="keyword">where</span></span> bl_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">=</span> <span class="skolem">bl'</span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span> <span class="main">∧</span> <span class="skolem">bl'</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> wellformed assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complement_blocks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>card <span class="skolem">bl'</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> bl_assm block_complement_size wellformed
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_size_lt_order of_nat_diff<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Block_Designs-uniform_complement"><span class="command">lemma</span></span> uniform_complement<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">≤</span> 𝗏 <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"block_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> proper_design <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span>  uniform_size_incomp assms complement_proper_design <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms uniform_complement_block_size <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Block_Designs-block_size_lt_v"><span class="command">lemma</span></span> block_size_lt_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">≤</span> 𝗏"</span></span>
  <span class="keyword1"><span class="command">using</span></span> v_non_zero block_size_lt_v design_blocks_nempty uniform <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> proper_design<span class="main">)</span> block_designI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> card <span class="bound">bl</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span> 
  <span class="main">⟹</span> block_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> block_design 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-block_design_multiple"><span class="command">lemma</span></span> block_design_multiple<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> block_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> elem_in_repeat_in_original multiple_proper_design proper_design.block_designI 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> block_set_nempty_imp_block_ex design_blocks_nempty int_int_eq uniform_alt_def_all<span class="main">)</span> 

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A uniform block design is clearly a type of $K$\_block\_design with a singleton $K$ set›</span></span>
<span class="keyword1"><span class="command">sublocale</span></span> block_design <span class="main">⊆</span> K_block_design <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="keyword1"><span class="free">𝗄</span></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> k_non_zero uniform <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Incomplete Designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An incomplete design is a design where $k &lt; v$, i.e. no block is equal to the point set›</span></span>
<span class="keyword1"><span class="command">locale</span></span> incomplete_design <span class="main">=</span> block_design <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> incomplete<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">&lt;</span> 𝗏"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-incomplete_imp_incomp_block"><span class="command">lemma</span></span> incomplete_imp_incomp_block<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> incomplete_block <span class="free">bl</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> incomplete uniform uniform_size_incomp <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  

<span class="keyword1" id="Block_Designs-incomplete_imp_proper_subset"><span class="command">lemma</span></span> incomplete_imp_proper_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">⊂</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incomplete_block_proper_subset incomplete_imp_incomp_block wellformed<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> block_design<span class="main">)</span> incomplete_designI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">&lt;</span> 𝗏 <span class="main">⟹</span> incomplete_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> incomplete_design
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-multiple_incomplete"><span class="command">lemma</span></span> multiple_incomplete<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> incomplete_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> block_design_multiple incomplete <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_design.incomplete_designI<span class="main">)</span> 

<span class="keyword1" id="Block_Designs-complement_incomplete"><span class="command">lemma</span></span> complement_incomplete<span class="main">:</span> <span class="quoted"><span class="quoted">"incomplete_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span><span class="main">)</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">&lt;</span> 𝗏"</span></span> <span class="keyword1"><span class="command">using</span></span> v_non_zero k_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> uniform_complement incomplete incomplete_designI
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_design.incomplete_designI<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Balanced Designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹t-wise balance is a design with the property that all point subsets of size $t$ occur in 
$\lambda_t$ blocks›</span></span>

<span class="keyword1"><span class="command">locale</span></span> t_wise_balance <span class="main">=</span> proper_design <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">grouping</span> <span class="main">::</span> <span class="quoted">int</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">𝗍</span></span></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">index</span> <span class="main">::</span> <span class="quoted">int</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">Λ<span class="hidden">⇩</span><sub>t</sub></span></span></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t_non_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗍</span></span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t_lt_order<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗍</span></span> <span class="main">≤</span> 𝗏"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> balanced <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗍</span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-balanced_alt_def_all"><span class="command">lemma</span></span> balanced_alt_def_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">ps</span></span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">.</span> card <span class="bound">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗍</span></span> <span class="main">⟶</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="bound">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> balanced <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> proper_design<span class="main">)</span> t_wise_balanceI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝗍</span> <span class="main">≤</span> 𝗏 <span class="main">⟹</span> <span class="free">𝗍</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="main">⋀</span> <span class="bound">ps</span> <span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="bound">ps</span> <span class="main">=</span> <span class="free">𝗍</span>  <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="bound">ps</span> <span class="main">=</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span><span class="main">)</span> <span class="main">⟹</span> t_wise_balance <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="free">𝗍</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> t_wise_balance
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-obtain_t_subset_points"><span class="command">lemma</span></span> obtain_t_subset_points<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">T</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">T</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗍</span></span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> obtain_subset_with_card_int_n design_points_nempty t_lt_order t_non_zero finite_sets
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> dual_order.strict_trans2 not_le_imp_less of_nat_1 of_nat_less_0_iff<span class="main">)</span> 

<span class="keyword1" id="Block_Designs-multiple_t_wise_balance_index"><span class="command">lemma</span></span> multiple_t_wise_balance_index <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗍</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="main">*</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> multiple_point_index balanced assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="Block_Designs-multiple_t_wise_balance"><span class="command">lemma</span></span> multiple_t_wise_balance<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"t_wise_balance <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span> <span class="keyword1"><span class="free">𝗍</span></span> <span class="main">(</span><span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> proper_design <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms multiple_proper_design<span class="main">)</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> t_non_zero t_lt_order multiple_t_wise_balance_index 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Block_Designs-twise_set_pair_index"><span class="command">lemma</span></span> twise_set_pair_index<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="free">ps2</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">≠</span> <span class="free">ps2</span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗍</span></span> <span class="main">⟹</span> card <span class="free">ps2</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗍</span></span> 
  <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> balanced <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_eq_iff<span class="main">)</span> 

<span class="keyword1" id="Block_Designs-t_wise_balance_alt"><span class="command">lemma</span></span> t_wise_balance_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗍</span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">l2</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">ps</span> <span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="bound">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗍</span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="bound">ps</span> <span class="main">=</span> <span class="free">l2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> twise_set_pair_index <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Block_Designs-index_ge_zero"><span class="command">lemma</span></span> index_ge_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">∧</span> card <span class="skolem">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗍</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t_non_zero t_lt_order obtain_subset_with_card_n
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.trans of_nat_le_iff zero_le_imp_eq_int zero_le_one<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> balanced_alt_def_all of_nat_0_le_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Block_Designs-index_1_imp_mult_1"><span class="command">lemma</span></span> index_1_imp_mult_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">bl</span> <span class="main">≥</span> <span class="keyword1"><span class="free">𝗍</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>multiplicity <span class="free">bl</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">⊆</span> <span class="free">bl</span> <span class="main">∧</span> card <span class="skolem">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗍</span></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms obtain_t_subset_points
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> obtain_subset_with_card_int_n of_nat_0_le_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="skolem">ps</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m points_index_count_min ps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> balanced ps antisym_conv2 not_numeral_less_zero numeral_le_one_iff 
      points_index_ps_nin semiring_norm<span class="main">(</span>69<span class="main">)</span> zero_neq_numeral
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> int_int_eq int_ops<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Sub-types of t-wise balance›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pairwise balance is when $t = 2$. These are commonly of interest›</span></span>
<span class="keyword1"><span class="command">locale</span></span> pairwise_balance <span class="main">=</span> t_wise_balance <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="keyword1"><span class="free">Λ</span></span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">point_set</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒱</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">block_collection</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℬ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">index</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Λ</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can combine the balance properties with $K$\_block design to define tBD's 
(t-wise balanced designs), and PBD's (pairwise balanced designs)›</span></span>

<span class="keyword1"><span class="command">locale</span></span> tBD <span class="main">=</span> t_wise_balance <span class="main">+</span> K_block_design <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> block_size_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒦</span></span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≥</span> <span class="keyword1"><span class="free">𝗍</span></span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Λ_PBD <span class="main">=</span> pairwise_balance <span class="main">+</span> K_block_design <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> block_size_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒦</span></span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Λ_PBD <span class="main">⊆</span> tBD <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="keyword1"><span class="free">Λ</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">𝒦</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> t_lt_order block_size_gt_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> PBD <span class="main">=</span> Λ_PBD <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="keyword1"><span class="free">𝒦</span></span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">point_set</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒱</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">block_collection</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℬ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sizes</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒦</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Block_Designs-multiplicity_is_1"><span class="command">lemma</span></span> multiplicity_is_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> block_size_gt_t index_1_imp_mult_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms block_sizes<span class="main">)</span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> PBD <span class="main">⊆</span> simple_design
  <span class="keyword1"><span class="command">using</span></span> multiplicity_is_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹PBD's are often only used in the case where $k$ is uniform, defined here.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> k_Λ_PBD <span class="main">=</span> pairwise_balance <span class="main">+</span> block_design <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> block_size_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> k_Λ_PBD <span class="main">⊆</span> Λ_PBD <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">Λ</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="keyword1"><span class="free">𝗄</span></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> k_non_zero uniform block_size_t <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> k_PBD <span class="main">=</span> k_Λ_PBD <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="keyword1"><span class="free">𝗄</span></span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">point_set</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒱</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">block_collection</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℬ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">u_block_size</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝗄</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> k_PBD <span class="main">⊆</span> PBD <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="keyword1"><span class="free">𝗄</span></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  block_size_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Covering and Packing Designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Covering and packing designs involve a looser balance restriction. Upper/lower bounds
are placed on the points index, instead of a strict equality›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A t-covering design is a relaxed version of a tBD, where, for all point subsets of size t, 
a lower bound is put on the points index›</span></span>
<span class="keyword1"><span class="command">locale</span></span> t_covering_design <span class="main">=</span> block_design <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">grouping</span> <span class="main">::</span> <span class="quoted">int</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝗍</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">min_index</span> <span class="main">::</span> <span class="quoted">int</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Λ<span class="hidden">⇩</span><sub>t</sub></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> covering<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗍</span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">≥</span> <span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> block_size_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗍</span></span> <span class="main">≤</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t_non_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗍</span></span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-covering_alt_def_all"><span class="command">lemma</span></span> covering_alt_def_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">ps</span></span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">.</span> card <span class="bound">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗍</span></span> <span class="main">⟶</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="bound">ps</span> <span class="main">≥</span> <span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> covering <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> block_design<span class="main">)</span> t_covering_designI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="main">⋀</span> <span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="bound">ps</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="bound">ps</span> <span class="main">≥</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span><span class="main">)</span> <span class="main">⟹</span> t_covering_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="free">t</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A t-packing design is a relaxed version of a tBD, where, for all point subsets of size t, 
an upper bound is put on the points index›</span></span>
<span class="keyword1"><span class="command">locale</span></span> t_packing_design <span class="main">=</span> block_design <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">grouping</span> <span class="main">::</span> <span class="quoted">int</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝗍</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">min_index</span> <span class="main">::</span> <span class="quoted">int</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Λ<span class="hidden">⇩</span><sub>t</sub></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> packing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗍</span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">≤</span> <span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> block_size_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗍</span></span> <span class="main">≤</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t_non_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗍</span></span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-packing_alt_def_all"><span class="command">lemma</span></span> packing_alt_def_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">ps</span></span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">.</span> card <span class="bound">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗍</span></span> <span class="main">⟶</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="bound">ps</span> <span class="main">≤</span> <span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> packing <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> block_design<span class="main">)</span> t_packing_designI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="main">⋀</span> <span class="bound">ps</span> <span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="bound">ps</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="bound">ps</span> <span class="main">≤</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span><span class="main">)</span> <span class="main">⟹</span> t_packing_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="free">t</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Block_Designs-packing_covering_imp_balance"><span class="command">lemma</span></span> packing_covering_imp_balance<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"t_packing_design <span class="free">V</span> <span class="free">B</span> <span class="free">k</span> <span class="free">t</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"t_covering_design <span class="free">V</span> <span class="free">B</span> <span class="free">k</span> <span class="free">t</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"t_wise_balance <span class="free">V</span> <span class="free">B</span> <span class="free">t</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> proper_design <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">B</span></span> 
    <span class="keyword1"><span class="command">using</span></span> block_design.axioms<span class="main">(</span>1<span class="main">)</span> t_covering_design.axioms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_packing_design.t_non_zero<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤</span> des.𝗏"</span></span> <span class="keyword1"><span class="command">using</span></span> block_design.block_size_lt_v t_packing_design.axioms<span class="main">(</span>1<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dual_order.trans t_packing_design.block_size_t<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">⟹</span> card <span class="bound">ps</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">B</span> <span class="keyword1">index</span> <span class="bound">ps</span> <span class="main">=</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> t_packing_design.packing t_covering_design.covering <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms dual_order.antisym<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Constant Replication Design›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹When the replication number for all points in a design is constant, it is the 
design replication number.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> constant_rep_design <span class="main">=</span> proper_design <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">design_rep_number</span> <span class="main">::</span> <span class="quoted">int</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝗋</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rep_number <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span>  <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗋</span></span>"</span></span> 

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-rep_number_alt_def_all"><span class="command">lemma</span></span> rep_number_alt_def_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">.</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="bound">x</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗋</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Block_Designs-rep_number_unfold_set"><span class="command">lemma</span></span> rep_number_unfold_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> size <span class="main">{#</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">#}</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗋</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rep_number <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def<span class="main">)</span>

<span class="keyword1" id="Block_Designs-rep_numbers_constant"><span class="command">lemma</span></span> rep_numbers_constant <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"replication_numbers  <span class="main">=</span> <span class="main">{</span><span class="keyword1"><span class="free">𝗋</span></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> replication_numbers_def <span class="keyword1"><span class="command">using</span></span> rep_number design_points_nempty Collect_cong finite.cases 
    finite_sets insertCI singleton_conv
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_threshold<span class="main"><span class="main">)</span></span> fst_conv snd_conv<span class="main">)</span> 

<span class="keyword1" id="Block_Designs-replication_number_single"><span class="command">lemma</span></span> replication_number_single<span class="main">:</span> <span class="quoted"><span class="quoted">"is_singleton <span class="main">(</span>replication_numbers<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_singleton_the_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Block_Designs-constant_rep_point_pair"><span class="command">lemma</span></span> constant_rep_point_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="free">x2</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="free">x1</span> <span class="main">≠</span> <span class="free">x2</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x1</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rep_number <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Block_Designs-constant_rep_alt"><span class="command">lemma</span></span> constant_rep_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">r2</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Block_Designs-constant_rep_point_not_0"><span class="command">lemma</span></span> constant_rep_point_not_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rep_number assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span>  size <span class="main">{#</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">#}</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> design_blocks_nempty wf_design wf_design_iff wf_invalid_point
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ex_in_conv filter_mset_empty_conv multiset_nonemptyE size_eq_0_iff_empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Block_Designs-rep_not_zero"><span class="command">lemma</span></span> rep_not_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗋</span></span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rep_number constant_rep_point_not_0 design_points_nempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Block_Designs-r_gzero"><span class="command">lemma</span></span> r_gzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗋</span></span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> point_replication_number_def rep_number constant_rep_design.rep_not_zero
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> constant_rep_design.intro constant_rep_design_axioms.intro leI of_nat_less_0_iff 
      proper_design_axioms verit_la_disequality<span class="main">)</span> 

<span class="keyword1" id="Block_Designs-r_lt_eq_b"><span class="command">lemma</span></span> r_lt_eq_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗋</span></span> <span class="main">≤</span> 𝖻"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rep_number max_point_rep
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_not_in_conv design_points_nempty<span class="main">)</span> 

<span class="keyword1" id="Block_Designs-complement_rep_number"><span class="command">lemma</span></span> complement_rep_number<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> incomplete_block <span class="bound">bl</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constant_rep_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span> <span class="main">(</span>𝖻 <span class="main">-</span> <span class="keyword1"><span class="free">𝗋</span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">interpret</span></span> d<span class="main">:</span> proper_design <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> complement_proper_design
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> complement_rep_number rep_number <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Block_Designs-multiple_rep_number"><span class="command">lemma</span></span> multiple_rep_number<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constant_rep_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗋</span></span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">interpret</span></span> d<span class="main">:</span> proper_design <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> multiple_proper_design
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> multiple_point_rep_num <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> proper_design<span class="main">)</span> constant_rep_designI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">𝗋</span><span class="main">)</span> 
    <span class="main">⟹</span> constant_rep_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="free">𝗋</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹T-designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All the before mentioned designs build up to the concept of a t-design, which has uniform 
block size and is t-wise balanced. We limit $t$ to be less than $k$, so the balance condition has 
relevance›</span></span>
<span class="keyword1"><span class="command">locale</span></span> t_design <span class="main">=</span> incomplete_design <span class="main">+</span> t_wise_balance <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> block_size_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗍</span></span> <span class="main">≤</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-point_indices_balanced"><span class="command">lemma</span></span> point_indices_balanced<span class="main">:</span> <span class="quoted"><span class="quoted">"point_indices <span class="keyword1"><span class="free">𝗍</span></span> <span class="main">=</span> <span class="main">{</span><span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"point_indices <span class="keyword1"><span class="free">𝗍</span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">ps</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="bound">ps</span> <span class="main">∧</span> int <span class="main">(</span>card <span class="bound">ps</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗍</span></span> <span class="main">∧</span> <span class="bound">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_indices_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"point_indices  <span class="keyword1"><span class="free">𝗍</span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> balanced Collect_cong obtain_t_subset_points 
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Block_Designs-point_indices_singleton"><span class="command">lemma</span></span> point_indices_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"is_singleton <span class="main">(</span>point_indices <span class="keyword1"><span class="free">𝗍</span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> point_indices_balanced is_singleton_the_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Block_Designs-t_designI"><span class="command">lemma</span></span> t_designI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"incomplete_design <span class="free">V</span> <span class="free">B</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"t_wise_balance <span class="free">V</span> <span class="free">B</span> <span class="free">t</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"t_design <span class="free">V</span> <span class="free">B</span> <span class="free">k</span> <span class="free">t</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> t_design.intro t_design_axioms.intro<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> t_design <span class="main">⊆</span> t_covering_design <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">𝗄</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">𝗍</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span></span>
  <span class="keyword1"><span class="command">using</span></span> t_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_size_t<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> t_design <span class="main">⊆</span> t_packing_design <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">𝗄</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">𝗍</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span></span>
  <span class="keyword1"><span class="command">using</span></span> t_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_size_t<span class="main">)</span>

<span class="keyword1" id="Block_Designs-t_design_pack_cov"><span class="command">lemma</span></span> t_design_pack_cov <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> card <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"t_covering_design <span class="free">V</span> <span class="free">B</span> <span class="free">k</span> <span class="free">t</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"t_packing_design <span class="free">V</span> <span class="free">B</span> <span class="free">k</span> <span class="free">t</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"t_design <span class="free">V</span> <span class="free">B</span> <span class="free">k</span> <span class="free">t</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> id<span class="main">:</span> incomplete_design <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">k</span></span>
    <span class="keyword1"><span class="command">using</span></span> block_design.incomplete_designI t_packing_design.axioms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_less_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> balance<span class="main">:</span> t_wise_balance <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span> 
    <span class="keyword1"><span class="command">using</span></span> packing_covering_imp_balance <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_packing_design.block_size_t<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> t_design <span class="main">⊆</span> tBD <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">𝗍</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="keyword1"><span class="free">𝗄</span></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uniform k_non_zero block_size_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">context</span></span> t_design 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-multiple_t_design"><span class="command">lemma</span></span> multiple_t_design<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> t_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="keyword1"><span class="free">𝗍</span></span> <span class="main">(</span><span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> multiple_t_wise_balance multiple_incomplete block_size_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_designI<span class="main">)</span>

<span class="keyword1" id="Block_Designs-t_design_min_v"><span class="command">lemma</span></span> t_design_min_v<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> k_non_zero incomplete <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Steiner Systems›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Steiner systems are a special type of t-design where $\Lambda_t = 1$›</span></span>
<span class="keyword1"><span class="command">locale</span></span> steiner_system <span class="main">=</span> t_design <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">𝗄</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">𝗍</span></span></span> <span class="quoted"><span class="main">1</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">point_set</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒱</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">block_collection</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℬ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">u_block_size</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝗄</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">grouping</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝗍</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-block_multiplicity"><span class="command">lemma</span></span> block_multiplicity <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms block_size_t<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> steiner_system <span class="main">⊆</span> simple_design
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> t_design<span class="main">)</span> steiner_systemI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> steiner_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="keyword1"><span class="free">𝗍</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> t_non_zero t_lt_order block_size_t
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Combining block designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define some closure properties for various block designs under the combine operator.
This is done using locales to reason on multiple instances of the same type of design, building 
on what was presented in the design operations theory›</span></span>

<span class="keyword1"><span class="command">locale</span></span> two_t_wise_eq_points <span class="main">=</span> two_designs_proper <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="main">+</span> des1<span class="main">:</span> t_wise_balance <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝗍</span></span> <span class="quoted"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="main">+</span> 
  des2<span class="main">:</span> t_wise_balance <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="quoted"><span class="free">𝗍</span></span> <span class="quoted"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub>'</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="free">𝗍</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">ℬ'</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub>'</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-combine_t_wise_balance_index"><span class="command">lemma</span></span> combine_t_wise_balance_index<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="free">𝒱</span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="free">𝗍</span> <span class="main">⟹</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">+</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> des1.balanced des2.balanced <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> combine_points_index<span class="main">)</span>

<span class="keyword1" id="Block_Designs-combine_t_wise_balance"><span class="command">lemma</span></span> combine_t_wise_balance<span class="main">:</span> <span class="quoted"><span class="quoted">"t_wise_balance <span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">𝗍</span> <span class="main">(</span><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">+</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub>'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> des1.t_non_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span>  <span class="main">≥</span> card <span class="free">𝒱</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝗍</span> <span class="main">≤</span> card <span class="main">(</span><span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> des1.t_lt_order <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆</span> <span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟹</span> card <span class="bound">ps</span> <span class="main">=</span> <span class="free">𝗍</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span> <span class="keyword1">index</span> <span class="bound">ps</span><span class="main">)</span> <span class="main">=</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">+</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub>'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> combine_t_wise_balance_index <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> combine_t_wise_des<span class="main">:</span> t_wise_balance <span class="quoted"><span class="quoted">"<span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝗍</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">+</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> combine_t_wise_balance <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> two_k_block_designs <span class="main">=</span> two_designs_proper <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝒱'</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="main">+</span> des1<span class="main">:</span> block_design <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝗄</span></span> <span class="main">+</span> 
  des2<span class="main">:</span> block_design <span class="quoted"><span class="free">𝒱'</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="quoted"><span class="free">𝗄</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="free">𝗄</span> <span class="free">𝒱'</span> <span class="free">ℬ'</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-block_design_combine"><span class="command">lemma</span></span> block_design_combine<span class="main">:</span> <span class="quoted"><span class="quoted">"block_design <span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">𝗄</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> des1.uniform des2.uniform <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> combine_block_des<span class="main">:</span> block_design <span class="quoted"><span class="quoted">"<span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝗄</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> block_design_combine <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> two_rep_designs_eq_points <span class="main">=</span> two_designs_proper <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="main">+</span> des1<span class="main">:</span> constant_rep_design <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝗋</span></span> <span class="main">+</span> 
  des2<span class="main">:</span> constant_rep_design <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="quoted"><span class="free">𝗋'</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="free">𝗋</span> <span class="free">ℬ'</span> <span class="free">𝗋'</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-combine_rep_number"><span class="command">lemma</span></span> combine_rep_number<span class="main">:</span> <span class="quoted"><span class="quoted">"constant_rep_design <span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span> <span class="main">(</span><span class="free">𝗋</span> <span class="main">+</span> <span class="free">𝗋'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> combine_rep_number des1.rep_number des2.rep_number <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> combine_const_rep<span class="main">:</span> constant_rep_design <span class="quoted"><span class="quoted">"<span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">𝗋</span> <span class="main">+</span> <span class="free">𝗋'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> combine_rep_number <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> two_incomplete_designs <span class="main">=</span> two_k_block_designs <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝗄</span></span> <span class="quoted"><span class="free">𝒱'</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="main">+</span> des1<span class="main">:</span> incomplete_design <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝗄</span></span> <span class="main">+</span> 
  des2<span class="main">:</span> incomplete_design <span class="quoted"><span class="free">𝒱'</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="quoted"><span class="free">𝗄</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="free">𝗄</span> <span class="free">𝒱'</span> <span class="free">ℬ'</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-combine_is_incomplete"><span class="command">lemma</span></span> combine_is_incomplete<span class="main">:</span> <span class="quoted"><span class="quoted">"incomplete_design <span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">𝗄</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> combine_order des1.incomplete des2.incomplete <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> combine_incomplete<span class="main">:</span> incomplete_design <span class="quoted"><span class="quoted">"<span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝗄</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> combine_is_incomplete <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> two_t_designs_eq_points <span class="main">=</span> two_incomplete_designs <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝗄</span></span> <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ'</span></span> 
  <span class="main">+</span> two_t_wise_eq_points <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝗍</span></span> <span class="quoted"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="quoted"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub>'</span></span> <span class="main">+</span> des1<span class="main">:</span> t_design <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝗄</span></span> <span class="quoted"><span class="free">𝗍</span></span> <span class="quoted"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="main">+</span> 
  des2<span class="main">:</span> t_design <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="quoted"><span class="free">𝗄</span></span> <span class="quoted"><span class="free">𝗍</span></span> <span class="quoted"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub>'</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="free">𝗄</span> <span class="free">ℬ'</span> <span class="free">𝗍</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub>'</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Block_Designs-combine_is_t_des"><span class="command">lemma</span></span> combine_is_t_des<span class="main">:</span> <span class="quoted"><span class="quoted">"t_design <span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">𝗄</span> <span class="free">𝗍</span> <span class="main">(</span><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">+</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> des1.block_size_t des2.block_size_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> combine_t_des<span class="main">:</span> t_design <span class="quoted"><span class="quoted">"<span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝗄</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝗍</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">+</span> <span class="free">Λ<span class="hidden">⇩</span><sub>t</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> combine_is_t_des <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="BIBD">
<div class="head">
<h1>Theory BIBD</h1>
</div>
<pre class="source"><span class="comment1">(* Title: BIBD 
   Author: Chelsea Edmonds
*)</span>

<span class="keyword1"><span class="command">theory</span></span> BIBD <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Block_Designs">Block_Designs</a>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹BIBD's›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹BIBD's are perhaps the most commonly studied type of design in combinatorial design theory,
and usually the first type of design explored in a design theory course. 
These designs are a type of t-design, where $t = 2$›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹BIBD Basics›</span></span>
<span class="keyword1"><span class="command">locale</span></span> bibd <span class="main">=</span> t_design <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">𝗄</span></span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="keyword1"><span class="free">Λ</span></span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">point_set</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒱</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">block_collection</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℬ</span>"</span><span class="main">)</span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">u_block_size</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝗄</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">index</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Λ</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="BIBD-min_block_size_2"><span class="command">lemma</span></span> min_block_size_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> block_size_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BIBD-points_index_pair"><span class="command">lemma</span></span> points_index_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span>  size <span class="main">(</span><span class="main">{#</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> balanced card_2_iff empty_subsetI insert_subset points_index_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_numeral<span class="main">)</span>

<span class="keyword1" id="BIBD-index_one_empty_rm_blv"><span class="command">lemma</span></span> index_one_empty_rm_blv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">" <span class="free">blv</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⊆</span> <span class="free">blv</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">bl</span> <span class="main">∈#</span> remove1_mset <span class="free">blv</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">p</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> blv_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">blv</span> <span class="main">∈#</span> filter_mset <span class="main">(</span><span class="main">(⊆)</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms wellformed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>filter_mset <span class="main">(</span><span class="main">(⊆)</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> balanced assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> blv_in filter_diff_mset filter_single_mset
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add_mset_eq_single assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> insert_DiffM size_1_singleton_mset<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="BIBD-index_one_alt_bl_not_exist"><span class="command">lemma</span></span> index_one_alt_bl_not_exist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">" <span class="free">blv</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⊆</span> <span class="free">blv</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> remove1_mset <span class="free">blv</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="free">p</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">using</span></span> index_one_empty_rm_blv
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> filter_mset_empty_conv<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Necessary Conditions for Existence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The necessary conditions on the existence of a $(v, k, \lambda)$-bibd are one of the 
fundamental first theorems on designs. Proofs based off MATH3301 lecture notes \cite{HerkeLectureNotes2016}
 and Stinson \cite{stinsonCombinatorialDesignsConstructions2004}›</span></span>

<span class="keyword1" id="BIBD-necess_cond_1_rhs"><span class="command">lemma</span></span> necess_cond_1_rhs<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">{#</span> <span class="bound">p</span> <span class="main">∈#</span> <span class="main">(</span>mset_set <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">×#</span> <span class="main">{#</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">#}</span><span class="main">)</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">∈</span> snd <span class="bound">p</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏<span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mset_set <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> m_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms mset_points_distinct_diff_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> y_point<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="var">?M</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_sets<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> b_contents<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="var">?B</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">bl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="var">?M</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_sets<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span> <span class="main">.</span><span class="bound">y</span> <span class="main">∈#</span> <span class="var">?M</span> <span class="main">⟹</span> size <span class="main">(</span><span class="main">{#</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="var">?B</span> <span class="main">.</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> nat <span class="keyword1"><span class="free">Λ</span></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> points_index_pair filter_filter_mset_ss_member y_point assms finite_sets index_ge_zero 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat_0_le nat_int_comparison<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span> <span class="main">.</span><span class="bound">y</span> <span class="main">∈#</span> <span class="var">?M</span> <span class="main">⟹</span> size <span class="main">(</span><span class="main">{#</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="var">?B</span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> nat <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bl_set_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="var">?M</span> <span class="main">⟹</span> size <span class="main">(</span><span class="main">{#</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="var">?B</span> <span class="main">.</span>  <span class="bound">y</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> nat <span class="keyword1"><span class="free">Λ</span></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> b_contents <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> filter_mset_cong<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> final_size<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈#</span><span class="var">?M</span> <span class="main">.</span> <span class="main">(</span><span class="main">{#</span><span class="bound">p</span><span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="var">?B</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="var">?M</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>nat <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> m_distinct size_Union_distinct_cart_prod_filter bl_set_size index_ge_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="var">?M</span> <span class="main">=</span> 𝗏 <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v_non_zero
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> finite_sets<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> final_size 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_break_down_left index_ge_zero<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-necess_cond_1_lhs"><span class="command">lemma</span></span> necess_cond_1_lhs<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">{#</span> <span class="bound">p</span> <span class="main">∈#</span> <span class="main">(</span>mset_set <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">×#</span> <span class="main">{#</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">#}</span><span class="main">)</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">∈</span> snd <span class="bound">p</span><span class="main">#}</span><span class="main">)</span> 
      <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">{#</span> <span class="bound">p</span> <span class="main">∈#</span> <span class="main">(</span><span class="var">?M</span> <span class="main">×#</span> <span class="var">?B</span><span class="main">)</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">∈</span> snd <span class="bound">p</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> "</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="var">?M</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_sets<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> distinct_m<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms mset_points_distinct_diff_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> finite_M<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_sets <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> block_choices<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="var">?B</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> point_replication_number_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> bl_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="var">?B</span><span class="main">.</span> card <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">}</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span> "</span></span> <span class="keyword1"><span class="command">using</span></span> uniform_unfold_point_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> x_in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="var">?B</span> <span class="main">.</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="var">?B</span><span class="main">.</span> card <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">}</span> <span class="main">=</span> card <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_filter_diff_card<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="var">?B</span><span class="main">.</span> card <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">}</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> bl_size x_in_set card_Diff_subset finite_sets k_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="var">?B</span> <span class="main">⟹</span> size <span class="main">{#</span><span class="bound">p</span> <span class="main">∈#</span> <span class="var">?M</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">#}</span> <span class="main">=</span> nat <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms finite_M card_size_filter_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">∑</span><span class="bound">bl</span><span class="main">∈#</span><span class="var">?B</span><span class="main">.</span> <span class="main">(</span> <span class="main">{#</span> <span class="bound">p</span> <span class="main">∈#</span> <span class="var">?M</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span><span class="bound">bl</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="var">?B</span><span class="main">)</span> <span class="main">*</span> nat <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> distinct_m size_Union_distinct_cart_prod_filter2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> block_choices k_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_break_down_right<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-r_constant"><span class="command">lemma</span></span> r_constant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> necess_cond_1_rhs necess_cond_1_lhs design_points_nempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="BIBD-replication_number_value"><span class="command">lemma</span></span> replication_number_value<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> min_block_size_2 r_constant assms diff_gt_0_iff_gt diff_self zle_diff1_eq numeral_le_one_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_int_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> linorder_neqE_linordered_idom nonzero_mult_div_cancel_right semiring_norm<span class="main"><span class="main">(</span></span>69<span class="main"><span class="main">)</span></span><span class="main">)</span>
  
<span class="keyword1" id="BIBD-r_constant_alt"><span class="command">lemma</span></span> r_constant_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">.</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="bound">x</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_constant replication_number_value <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Using the first necessary condition, it is possible to show that a bibd has 
a constant replication number›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> bibd <span class="main">⊆</span> constant_rep_design <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_constant_alt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> t_design<span class="main">)</span> bibdI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗍</span></span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> bibd <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="keyword1"><span class="free">Λ<span class="hidden">⇩</span><sub>t</sub></span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> t_lt_order block_size_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> bibd
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝗋</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="BIBD-necessary_condition_one"><span class="command">lemma</span></span> necessary_condition_one<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> necess_cond_1_rhs necess_cond_1_lhs design_points_nempty rep_number <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BIBD-bibd_point_occ_rep"><span class="command">lemma</span></span> bibd_point_occ_rep<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">bl</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">bl</span><span class="main">#}</span><span class="main">)</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> 𝗋 <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms wf_invalid_point <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rep<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">blk</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">blk</span> <span class="main">#}</span> <span class="main">=</span> 𝗋"</span></span> <span class="keyword1"><span class="command">using</span></span> rep_number_unfold_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">bl</span><span class="main">#}</span><span class="main">)</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> size <span class="main">{#</span> <span class="bound">blk</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">bl</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">blk</span> <span class="main">#}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">bl</span><span class="main">#}</span><span class="main">)</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">=</span> size <span class="main">{#</span> <span class="bound">blk</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">blk</span> <span class="main">#}</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms size_Diff_singleton<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms rep r_gzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="BIBD-necess_cond_2_lhs"><span class="command">lemma</span></span> necess_cond_2_lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">(</span>mset_set <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">×#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span>  <span class="main">#}</span> <span class="main">=</span> 𝗏 <span class="main">*</span> 𝗋"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mset_set <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> <span class="var">?M</span> <span class="main">⟹</span> size <span class="main">(</span><span class="main">{#</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">#}</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">(</span>𝗋<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_sets rep_number_unfold_set r_gzero nat_eq_iff2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈#</span><span class="var">?M</span><span class="main">.</span> <span class="main">(</span><span class="main">{#</span><span class="bound">p</span><span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> size <span class="var">?M</span> <span class="main">*</span> nat <span class="main">(</span>𝗋<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> mset_points_distinct size_Union_distinct_cart_prod_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r_gzero
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_break_down_left<span class="main">)</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-necess_cond_2_rhs"><span class="command">lemma</span></span> necess_cond_2_rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">(</span>mset_set <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">×#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span>  <span class="main">#}</span> <span class="main">=</span> 𝖻<span class="main">*</span><span class="keyword1"><span class="free">𝗄</span></span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">(</span><span class="var">?M</span> <span class="main">×#</span> <span class="var">?B</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span>  <span class="main">#}</span> <span class="main">=</span> 𝖻<span class="main">*</span><span class="keyword1"><span class="free">𝗄</span></span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="var">?B</span> <span class="main">⟹</span> size <span class="main">(</span><span class="main">{#</span> <span class="bound">p</span> <span class="main">∈#</span> <span class="var">?M</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">#}</span><span class="main">)</span> <span class="main">=</span> nat <span class="keyword1"><span class="free">𝗄</span></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> uniform k_non_zero uniform_unfold_point_set_mset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">∑</span><span class="bound">bl</span><span class="main">∈#</span><span class="var">?B</span><span class="main">.</span> <span class="main">(</span> <span class="main">{#</span> <span class="bound">p</span> <span class="main">∈#</span> <span class="var">?M</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">#}</span> <span class="main">×#</span> <span class="main">{#</span><span class="bound">bl</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="var">?B</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>nat <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> mset_points_distinct size_Union_distinct_cart_prod_filter2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> k_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_break_down_right<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-necessary_condition_two"><span class="command">lemma</span></span> necessary_condition_two<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">*</span> 𝗋 <span class="main">=</span> 𝖻 <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> necess_cond_2_lhs necess_cond_2_rhs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> admissability_conditions<span class="main">:</span>
<span class="quoted"><span class="quoted">"𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="quoted"><span class="quoted">"𝗏 <span class="main">*</span> 𝗋 <span class="main">=</span> 𝖻 <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> necessary_condition_one necessary_condition_two <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹BIBD Param Relationships›</span></span>

<span class="keyword1" id="BIBD-bibd_block_number"><span class="command">lemma</span></span> bibd_block_number<span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> 𝗏 <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">=</span> <span class="main">(</span>𝗏 <span class="main">*</span> 𝗋<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> necessary_condition_two <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="keyword1">dvd</span> <span class="main">(</span>𝗏 <span class="main">*</span> 𝗋<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_triv_right<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">=</span> <span class="main">(</span>𝗏 <span class="main">*</span> 𝗋<span class="main">)</span> <span class="keyword1">div</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> necessary_condition_two min_block_size_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">=</span> <span class="main">(</span>𝗏 <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">=</span> <span class="main">(</span>𝗏 <span class="main">*</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> necessary_condition_one 
      necessary_condition_two dvd_div_div_eq_mult dvd_div_eq_0_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> dvd_triv_right mult.assoc mult.commute mult.left_commute mult_eq_0_iff <span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-symmetric_condition_1"><span class="command">lemma</span></span> symmetric_condition_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> 𝖻 <span class="main">=</span> 𝗏 <span class="main">∧</span> 𝗋 <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> b_non_zero bibd_block_number mult_eq_0_iff necessary_condition_two necessary_condition_one 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BIBD-index_lt_replication"><span class="command">lemma</span></span> index_lt_replication<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">&lt;</span> 𝗋"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> admissability_conditions <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> lhsnot0<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> no_zero_divisors rep_not_zero zdiv_eq_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rhsnot0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> 𝗏 <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> incomplete b_non_zero bibd_block_number not_less_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 lhsnot0 rhsnot0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> k_non_zero mult_le_less_imp_less r_gzero<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-index_not_zero"><span class="command">lemma</span></span> index_not_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> index_ge_zero index_lt_replication int_one_le_iff_zero_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="BIBD-r_ge_two"><span class="command">lemma</span></span> r_ge_two<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗋 <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> index_lt_replication index_not_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

<span class="keyword1" id="BIBD-block_num_gt_rep"><span class="command">lemma</span></span> block_num_gt_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">&gt;</span> 𝗋"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fact<span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">=</span> 𝗏 <span class="main">*</span> 𝗋"</span></span> <span class="keyword1"><span class="command">using</span></span> admissability_conditions <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lhsnot0<span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_non_zero b_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rhsnot0<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">*</span> 𝗋 <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fact <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> incomplete lhsnot0
    <span class="keyword1"><span class="command">using</span></span> complement_rep_number constant_rep_design.r_gzero incomplete_imp_incomp_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-bibd_subset_occ"><span class="command">lemma</span></span> bibd_subset_occ<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊆</span> <span class="free">bl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">blk</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">bl</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊆</span> <span class="bound">blk</span> <span class="main">#}</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> index<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">blk</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="free">x</span> <span class="main">⊆</span> <span class="bound">blk</span> <span class="main">#}</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> points_index_def balanced assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> of_nat_numeral subset_eq wf_invalid_point<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">blk</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">bl</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊆</span> <span class="bound">blk</span> <span class="main">#}</span> <span class="main">=</span> size <span class="main">{#</span> <span class="bound">blk</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="free">x</span> <span class="main">⊆</span> <span class="bound">blk</span> <span class="main">#}</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms size_Diff_singleton<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms index_not_zero index <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-necess_cond_one_param_balance"><span class="command">lemma</span></span> necess_cond_one_param_balance<span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">&gt;</span> 𝗏 <span class="main">⟹</span> 𝗋 <span class="main">&gt;</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> necessary_condition_two
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> mult_nonneg_nonneg nonzero_mult_div_cancel_right of_nat_0_le_iff r_gzero zdiv_mono2<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Constructing New bibd's›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There are many constructions on bibd's to establish new bibds (or other types of designs). 
This section demonstrates this using both existing constructions, and by defining new constructions.›</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹BIBD Complement, Multiple, Combine›</span></span>

<span class="keyword1" id="BIBD-comp_params_index_pair"><span class="command">lemma</span></span> comp_params_index_pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> 𝖻 <span class="main">+</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span>𝗋"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> yin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span>𝗋 <span class="main">≥</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_lt_replication
    <span class="keyword1"><span class="command">using</span></span> r_gzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span>  <span class="keyword1"><span class="free">Λ</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> points_index_pair assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lambda<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> nat <span class="keyword1"><span class="free">Λ</span></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> index_ge_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∉</span> <span class="bound">b</span> <span class="main">#}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> complement_index_2 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> size <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">(</span>size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">x</span> <span class="main">∉</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∉</span> <span class="bound">b</span><span class="main">)</span> <span class="main">#}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> size_filter_neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> size <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">(</span>size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> 𝖻 <span class="main">-</span> <span class="main">(</span>size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> 𝖻 <span class="main">-</span> <span class="main">(</span>size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">+</span>  
    size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">y</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">-</span>  size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">#}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_size_partition_dep<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> 𝖻 <span class="main">-</span> <span class="main">(</span>nat 𝗋 <span class="main">+</span> nat 𝗋 <span class="main">-</span> nat <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rep_number_unfold_set lambda xin yin
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> nat_int<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> 𝖻 <span class="main">-</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> index_ge_zero index_lt_replication <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ge diff_diff_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-complement_bibd_index"><span class="command">lemma</span></span> complement_bibd_index<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> 𝖻 <span class="main">+</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span>𝗋"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_non_zero bibd_block_number diff_is_0_eq incomplete 
    mult_0_right nat_less_le design_points_nempty assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_2_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> comp_params_index_pair assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-complement_bibd"><span class="command">lemma</span></span> complement_bibd<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">≤</span> 𝗏 <span class="main">-</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bibd <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="main">(</span>𝖻 <span class="main">+</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span>𝗋<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> incomplete_design <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>𝗏 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms complement_incomplete <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> des.𝗏"</span></span> <span class="keyword1"><span class="command">using</span></span> assms block_size_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="bound">ps</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> 
      <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>C</sup></span> <span class="keyword1">index</span> <span class="bound">ps</span> <span class="main">=</span> 𝖻 <span class="main">+</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>des.𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> complement_bibd_index <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> des.𝗏 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms block_size_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-multiple_bibd"><span class="command">lemma</span></span> multiple_bibd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> bibd <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> multiple_t_design <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bibd_def<span class="main">)</span>  

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">locale</span></span> two_bibd_eq_points <span class="main">=</span> two_t_designs_eq_points <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝗄</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="free">Λ</span></span> <span class="quoted"><span class="free">Λ'</span></span>
  <span class="main">+</span> des1<span class="main">:</span> bibd <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝗄</span></span> <span class="quoted"><span class="free">Λ</span></span> <span class="main">+</span> des2<span class="main">:</span> bibd <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="quoted"><span class="free">𝗄</span></span> <span class="quoted"><span class="free">Λ'</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="free">𝗄</span> <span class="free">ℬ'</span> <span class="free">Λ</span> <span class="free">Λ'</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="BIBD-combine_is_bibd"><span class="command">lemma</span></span> combine_is_bibd<span class="main">:</span> <span class="quoted"><span class="quoted">"bibd <span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">𝗄</span> <span class="main">(</span><span class="free">Λ</span> <span class="main">+</span> <span class="free">Λ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> combine_bibd<span class="main">:</span> bibd <span class="quoted"><span class="quoted">"<span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝗄</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Λ</span> <span class="main">+</span> <span class="free">Λ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Derived Designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A derived bibd takes a block from a valid bibd as the new point sets, and the intersection 
of that block with other blocks as it's block set›</span></span>

<span class="keyword1"><span class="command">locale</span></span> bibd_block_transformations <span class="main">=</span> bibd <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">block</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1">bl</span></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_block<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bl</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">derived_blocks</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set multiset"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span><span class="keyword3">)</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
<span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ<span class="hidden">⇧</span><sup>D</sup></span></span> <span class="main">≡</span> <span class="main">{#</span> <span class="keyword1"><span class="free">bl</span></span> <span class="main">∩</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="keyword1"><span class="free">bl</span></span><span class="main">#}</span><span class="main">)</span> <span class="main">#}</span>"</span></span>

<span class="keyword1" id="BIBD-derive_define_flip"><span class="command">lemma</span></span> derive_define_flip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">b</span> <span class="main">∩</span> <span class="keyword1"><span class="free">bl</span></span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="keyword1"><span class="free">bl</span></span><span class="main">#}</span><span class="main">)</span> <span class="main">#}</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derived_blocks_def inf_sup_aci<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="BIBD-derived_points_order"><span class="command">lemma</span></span> derived_points_order<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="keyword1"><span class="free">bl</span></span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uniform valid_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BIBD-derived_block_num"><span class="command">lemma</span></span> derived_block_num<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bl</span></span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> size <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span> <span class="main">=</span> 𝖻 <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derived_blocks_def size_remove1_mset_If valid_block<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> valid_block int_ops<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="BIBD-derived_is_wellformed"><span class="command">lemma</span></span> derived_is_wellformed<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">bl</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derived_blocks_def valid_block<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="BIBD-derived_point_subset_orig"><span class="command">lemma</span></span> derived_point_subset_orig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">bl</span></span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">⊂</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_block incomplete_imp_proper_subset subset_psubset_trans<span class="main">)</span> 

<span class="keyword1" id="BIBD-derived_obtain_orig_block"><span class="command">lemma</span></span> derived_obtain_orig_block<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">b2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">b2</span> <span class="main">∩</span> <span class="keyword1"><span class="free">bl</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b2</span> <span class="main">∈#</span> remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms derived_blocks_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">sublocale</span></span> derived_incidence_sys<span class="main">:</span> incidence_system <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bl</span></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> derived_is_wellformed valid_block <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> derived_fin_incidence_system<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bl</span></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_block finite_blocks <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="BIBD-derived_blocks_nempty"><span class="command">lemma</span></span> derived_blocks_nempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span><span class="bound">b</span> <span class="main">∈#</span> remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">bl</span></span> <span class="main">|∩|</span> <span class="bound">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bld</span> <span class="main">∈#</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">bld</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bl2</span></span> <span class="keyword2"><span class="keyword">where</span></span> inter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bld</span> <span class="main">=</span> <span class="skolem">bl2</span> <span class="main">∩</span> <span class="keyword1"><span class="free">bl</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> member<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bl2</span> <span class="main">∈#</span> remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms derived_obtain_orig_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bl</span></span> <span class="main">|∩|</span> <span class="skolem">bl2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> intersection_number_empty_iff finite_blocks valid_block
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_commute dual_order.irrefl inter<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-derived_is_design"><span class="command">lemma</span></span> derived_is_design<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">bl</span></span> <span class="main">|∩|</span> <span class="bound">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"design <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> fin<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bl</span></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms derived_blocks_nempty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-derived_is_proper"><span class="command">lemma</span></span> derived_is_proper<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">bl</span></span> <span class="main">|∩|</span> <span class="bound">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proper_design <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> design <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bl</span></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> derived_is_design assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">-</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> block_num_gt_rep r_ge_two <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derived_block_num valid_block<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Residual Designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Similar to derived designs, a residual design takes the complement of a block bl as it's new
point set, and the complement of all other blocks with respect to bl.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">residual_blocks</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set multiset"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span><span class="keyword3">)</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ<span class="hidden">⇧</span><sup>R</sup></span></span> <span class="main">≡</span> <span class="main">{#</span> <span class="bound">b</span> <span class="main">-</span> <span class="keyword1"><span class="free">bl</span></span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="keyword1"><span class="free">bl</span></span><span class="main">#}</span><span class="main">)</span> <span class="main">#}</span>"</span></span> 

<span class="keyword1" id="BIBD-residual_order"><span class="command">lemma</span></span> residual_order<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="keyword1"><span class="free">bl</span></span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span><span class="main">)</span> <span class="main">=</span> 𝗏 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_block wellformed block_complement_size<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> block_size_lt_v derived_points_order <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BIBD-residual_block_num"><span class="command">lemma</span></span> residual_block_num<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span><span class="main">)</span> <span class="main">=</span> 𝖻 <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> b_positive <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> residual_blocks_def size_remove1_mset_If valid_block int_ops<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="BIBD-residual_obtain_orig_block"><span class="command">lemma</span></span> residual_obtain_orig_block<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">bl2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">bl2</span> <span class="main">-</span> <span class="keyword1"><span class="free">bl</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl2</span> <span class="main">∈#</span> remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms residual_blocks_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BIBD-residual_blocks_ss"><span class="command">lemma</span></span> residual_blocks_ss<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1"><span class="free">bl</span></span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> residual_obtain_orig_block
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_mono assms block_complement_def in_diffD order_refl wellformed<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> block_complement_subset_points <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-residual_blocks_exclude"><span class="command">lemma</span></span> residual_blocks_exclude<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="keyword1"><span class="free">bl</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> residual_obtain_orig_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BIBD-residual_is_wellformed"><span class="command">lemma</span></span> residual_is_wellformed<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1"><span class="free">bl</span></span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> residual_blocks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffI block_complement_def in_diffD wf_invalid_point<span class="main">)</span> 

<span class="keyword1"><span class="command">sublocale</span></span> residual_incidence_sys<span class="main">:</span> incidence_system <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bl</span></span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> residual_is_wellformed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword1" id="BIBD-residual_is_finite"><span class="command">lemma</span></span> residual_is_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="keyword1"><span class="free">bl</span></span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_complement_def finite_sets<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> residual_fin_incidence_sys<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bl</span></span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> residual_is_finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> 

<span class="keyword1" id="BIBD-residual_blocks_nempty"><span class="command">lemma</span></span> residual_blocks_nempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bld</span> <span class="main">∈#</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="keyword1"><span class="free">bl</span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">bld</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bl2</span></span> <span class="keyword2"><span class="keyword">where</span></span> inter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bld</span> <span class="main">=</span> <span class="skolem">bl2</span> <span class="main">-</span> <span class="keyword1"><span class="free">bl</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> member<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bl2</span> <span class="main">∈#</span> remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms residual_blocks_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bl2</span> <span class="main">≠</span> <span class="keyword1"><span class="free">bl</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_eq_zero_iff in_diff_count less_one union_single_eq_member<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">bl2</span> <span class="main">=</span> card <span class="keyword1"><span class="free">bl</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> uniform valid_block member
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_diffD of_nat_eq_iff<span class="main">)</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">bl2</span> <span class="main">-</span> <span class="keyword1"><span class="free">bl</span></span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> finite_blocks member uniform set_card_diff_ge_zero valid_block <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_diffD ne<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inter <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-residual_is_design"><span class="command">lemma</span></span> residual_is_design<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicity <span class="keyword1"><span class="free">bl</span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> design <span class="main">(</span><span class="keyword1"><span class="free">bl</span></span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span><span class="main">)</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> residual_blocks_nempty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword1" id="BIBD-residual_is_proper"><span class="command">lemma</span></span> residual_is_proper<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="keyword1"><span class="free">bl</span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proper_design <span class="main">(</span><span class="keyword1"><span class="free">bl</span></span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span><span class="main">)</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> design <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bl</span></span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> residual_is_design assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">-</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r_ge_two block_num_gt_rep <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> residual_block_num <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Symmetric BIBD's›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Symmetric bibd's are those where the order of the design equals the number of blocks›</span></span>

<span class="keyword1"><span class="command">locale</span></span> symmetric_bibd <span class="main">=</span> bibd <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> symmetric<span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">=</span> 𝗏"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="BIBD-rep_value_sym"><span class="command">lemma</span></span> rep_value_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗋 <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> b_non_zero local.symmetric necessary_condition_two <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BIBD-symmetric_condition_2"><span class="command">lemma</span></span> symmetric_condition_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> necessary_condition_one rep_value_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BIBD-sym_design_vk_gt_kl"><span class="command">lemma</span></span> sym_design_vk_gt_kl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">≥</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">&gt;</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">&gt;</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span><span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">*</span><span class="main">(</span> <span class="numeral">2</span> <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> index_ge_zero mult_le_cancel_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">*</span><span class="main">(</span> <span class="numeral">2</span> <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symmetric_condition_2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">*</span><span class="main">(</span> <span class="numeral">2</span> <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute right_diff_distrib'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">∨</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_le_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">context</span></span> bibd
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="BIBD-symmetric_bibdI"><span class="command">lemma</span></span> symmetric_bibdI<span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">=</span> 𝗏 <span class="main">⟹</span> symmetric_bibd <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>

<span class="keyword1" id="BIBD-symmetric_bibdII"><span class="command">lemma</span></span> symmetric_bibdII<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> symmetric_bibd <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> symmetric_condition_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">blast</span> 

<span class="keyword1" id="BIBD-symmetric_not_admissable"><span class="command">lemma</span></span> symmetric_not_admissable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> symmetric_bibd <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> symmetric_bibd.symmetric_condition_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> symmetric_bibd
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Intersection Property on Symmetric BIBDs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Below is a proof of an important property on symmetric BIBD's regarding the equivalence
of intersection numbers and the design index. This is an intuitive counting proof, and involved
significantly more work in a formal environment. Based of Lecture Note \cite{HerkeLectureNotes2016}›</span></span>

<span class="keyword1" id="BIBD-intersect_mult_set_eq_block"><span class="command">lemma</span></span> intersect_mult_set_eq_block<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">blv</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">{#</span> mset_set <span class="main">(</span><span class="bound">bl</span> <span class="main">∩</span> <span class="free">blv</span><span class="main">)</span> <span class="main">.</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span><span class="main">#}</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">∈</span> <span class="free">blv</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms finite_blocks<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">blv</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="keyword1">rep</span> <span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bibd_point_occ_rep r_ge_two assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bl</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">∈</span> <span class="skolem">bl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms rep_number_g0_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈#</span>remove1_mset <span class="free">blv</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="free">p</span> <span class="main">∈#</span> mset_set <span class="main">(</span><span class="bound">x</span> <span class="main">∩</span> <span class="free">blv</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms assm finite_blocks <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-intersect_mult_set_block_subset_iff"><span class="command">lemma</span></span> intersect_mult_set_block_subset_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">blv</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">{#</span> mset_set <span class="main">{</span><span class="bound">y</span> <span class="main">.</span><span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="bound">b2</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">.</span><span class="bound">b2</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span><span class="main">#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⊆</span> <span class="free">blv</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">p</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈#</span> mset_set <span class="main">{</span><span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="skolem">b2</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">b2</span> <span class="main">∈#</span><span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="skolem">b2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> elem_mset_set equals0D infinite_set_mset_mset_set mem_Collect_eq<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">blv</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-intersect_mult_set_block_subset_card"><span class="command">lemma</span></span> intersect_mult_set_block_subset_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">blv</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">{#</span> mset_set <span class="main">{</span><span class="bound">y</span> <span class="main">.</span><span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="bound">b2</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">.</span><span class="bound">b2</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span><span class="main">#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈#</span> mset_set <span class="main">{</span><span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="skolem">b2</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">b2</span> <span class="main">∈#</span><span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> elem_mset_set equals0D infinite_set_mset_mset_set mem_Collect_eq<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-intersect_mult_set_block_with_point_exists"><span class="command">lemma</span></span> intersect_mult_set_block_with_point_exists<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">blv</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⊆</span> <span class="free">blv</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈#</span>remove1_mset <span class="free">blv</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="free">p</span> <span class="main">∈#</span> mset_set <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">⊆</span> <span class="bound">x</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">p</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> points_index_def assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> balanced_alt_def_all dual_order.trans of_nat_numeral wellformed<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="free">p</span> <span class="main">⊆</span> <span class="bound">bl</span><span class="main">#}</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_Diff_singleton<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bl</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">⊆</span> <span class="skolem">bl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms filter_mset_empty_conv
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_diff_cancel diff_is_0_eq' le_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> size_empty zero_neq_one<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms finite_blocks <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-intersect_mult_set_block_subset_iff_2"><span class="command">lemma</span></span> intersect_mult_set_block_subset_iff_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">blv</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⊆</span> <span class="free">blv</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">{#</span> mset_set <span class="main">{</span><span class="bound">y</span> <span class="main">.</span><span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="bound">b2</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">.</span><span class="bound">b2</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intersect_mult_set_block_with_point_exists assms<span class="main">)</span>

<span class="keyword1" id="BIBD-sym_sum_mset_inter_sets_count"><span class="command">lemma</span></span> sym_sum_mset_inter_sets_count<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">blv</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">blv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">{#</span> mset_set <span class="main">(</span><span class="bound">bl</span> <span class="main">∩</span> <span class="free">blv</span><span class="main">)</span> <span class="main">.</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> 𝗋 <span class="main">-</span> <span class="main">1</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="var">?M</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> 𝗋 <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> size_inter<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> mset_set <span class="main">(</span><span class="bound">bl</span> <span class="main">∩</span> <span class="free">blv</span><span class="main">)</span> <span class="main">|</span> <span class="bound"><span class="bound">bl</span></span>  <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">#}</span> <span class="main">=</span> 𝗋 <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bibd_point_occ_rep point_replication_number_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> size_image_mset<span class="main">)</span>  
  <span class="keyword1"><span class="command">have</span></span> inter_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> finite <span class="main">(</span><span class="bound">bl</span> <span class="main">∩</span> <span class="free">blv</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> finite_blocks<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">⟶</span> count <span class="main">(</span>mset_set <span class="main">(</span><span class="bound">bl</span> <span class="main">∩</span> <span class="free">blv</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms count_mset_set<span class="main">(</span>1<span class="main">)</span> inter_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="main">{#</span><span class="bound">b1</span> <span class="main">∈#</span><span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">b1</span><span class="main">#}</span> <span class="main">⟹</span> count <span class="main">(</span>mset_set <span class="main">(</span><span class="bound">bl</span> <span class="main">∩</span> <span class="free">blv</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> count_eq_zero_iff count_filter_mset<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈#</span> <span class="main">{#</span> mset_set <span class="main">(</span><span class="bound">bl</span> <span class="main">∩</span> <span class="free">blv</span><span class="main">)</span> <span class="main">|</span> <span class="bound"><span class="bound">bl</span></span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">#}</span> 
      <span class="main">⟹</span> count <span class="bound">P</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> <span class="main">{#</span> mset_set <span class="main">(</span><span class="bound">bl</span> <span class="main">∩</span> <span class="free">blv</span><span class="main">)</span> <span class="main">|</span> <span class="bound"><span class="bound">bl</span></span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">#}</span> 
      <span class="main">+</span> <span class="main">{#</span> mset_set <span class="main">(</span><span class="bound">bl</span> <span class="main">∩</span> <span class="free">blv</span><span class="main">)</span> <span class="main">|</span> <span class="bound"><span class="bound">bl</span></span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="free">p</span> <span class="main">∉</span> <span class="bound">bl</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_mset_union multiset_partition<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="var">?M</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> size <span class="main">{#</span> mset_set <span class="main">(</span><span class="bound">bl</span> <span class="main">∩</span> <span class="free">blv</span><span class="main">)</span> <span class="main">|</span> <span class="bound"><span class="bound">bl</span></span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">#}</span> "</span></span> 
    <span class="keyword1"><span class="command">using</span></span> pin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> count_sum_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> size_inter <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>   
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-sym_sum_mset_inter_sets_size"><span class="command">lemma</span></span> sym_sum_mset_inter_sets_size<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">blv</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">{#</span> mset_set <span class="main">(</span><span class="bound">bl</span> <span class="main">∩</span> <span class="free">blv</span><span class="main">)</span> <span class="main">.</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="var">?M</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">{#</span> mset_set <span class="main">(</span><span class="bound">bl</span> <span class="main">∩</span> <span class="free">blv</span><span class="main">)</span> <span class="main">.</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="free">blv</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> intersect_mult_set_eq_block assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set_mset <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="var">?M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="var">?M</span><span class="main">)</span> <span class="main">⟹</span> count <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="var">?M</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> 𝗋 <span class="main">-</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sym_sum_mset_inter_sets_count assms eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> k size_multiset_int_count <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-sym_sum_inter_num"><span class="command">lemma</span></span> sym_sum_inter_num<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b2</span> <span class="main">∈#</span><span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> <span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">b2</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b2</span> <span class="main">∈#</span><span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> <span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">b2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b2</span> <span class="main">∈#</span><span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> size <span class="main">(</span>mset_set <span class="main">(</span><span class="free">b1</span> <span class="main">∩</span> <span class="bound">b2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intersection_number_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> size <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">{#</span>mset_set <span class="main">(</span><span class="free">b1</span> <span class="main">∩</span> <span class="bound">bl</span><span class="main">)</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_big_union_sum<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  size <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">{#</span>mset_set <span class="main">(</span><span class="bound">bl</span> <span class="main">∩</span> <span class="free">b1</span><span class="main">)</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_commute<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b2</span> <span class="main">∈#</span><span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> <span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">b2</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sym_sum_mset_inter_sets_size assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-choose_two_int"><span class="command">lemma</span></span> choose_two_int<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">" <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="free">x</span> <span class="main">::</span> int<span class="main">)</span> <span class="keyword1">choose</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">::</span>int<span class="main">)</span> <span class="main">*</span> <span class="main">(</span> <span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> "</span></span> 
  <span class="keyword1"><span class="command">using</span></span> choose_two assms dvd_div_mult_self even_numeral int_nat_eq mult_cancel_right2 mult_eq_0_iff 
    mult_nonneg_nonneg nat_diff_distrib' nat_mult_distrib nat_one_as_int 
    numeral_Bit0_div_2 numerals<span class="main">(</span>1<span class="main">)</span> of_nat_numeral zdiv_int <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="comment1">(* Slow *)</span>

<span class="keyword1" id="BIBD-sym_sum_mset_inter2_sets_count"><span class="command">lemma</span></span> sym_sum_mset_inter2_sets_count<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">blv</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⊆</span> <span class="free">blv</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">{#</span>mset_set <span class="main">{</span><span class="bound">y</span> <span class="main">.</span><span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="bound">b2</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span><span class="main">.</span> <span class="bound">b2</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="var">?M</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> size_inter<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> mset_set <span class="main">{</span><span class="bound">y</span> <span class="main">.</span><span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="bound">b2</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">|</span> <span class="bound"><span class="bound">b2</span></span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="free">p</span> <span class="main">⊆</span> <span class="bound">b2</span><span class="main">#}</span> 
      <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bibd_subset_occ assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">b2</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="free">p</span> <span class="main">⊆</span> <span class="bound">b2</span> <span class="main">⟶</span> count <span class="main">(</span>mset_set<span class="main">{</span><span class="bound">y</span> <span class="main">.</span><span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="bound">b2</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> count_mset_set<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> finite_blocks<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="main">{#</span><span class="bound">b1</span> <span class="main">∈#</span><span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="free">p</span> <span class="main">⊆</span> <span class="bound">b1</span><span class="main">#}</span><span class="main">.</span> 
      count <span class="main">(</span>mset_set <span class="main">{</span><span class="bound">y</span> <span class="main">.</span><span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="bound">bl</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> count_eq_zero_iff count_filter_mset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈#</span> <span class="main">{#</span> mset_set <span class="main">{</span><span class="bound">y</span> <span class="main">.</span><span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="bound">b2</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">|</span> <span class="bound"><span class="bound">b2</span></span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="free">p</span> <span class="main">⊆</span> <span class="bound">b2</span><span class="main">#}</span><span class="main">.</span> 
      count <span class="bound">P</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> count_eq_zero_iff count_filter_mset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> <span class="main">{#</span> mset_set <span class="main">{</span><span class="bound">y</span> <span class="main">.</span><span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="bound">b2</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">|</span> <span class="bound"><span class="bound">b2</span></span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="free">p</span> <span class="main">⊆</span> <span class="bound">b2</span><span class="main">#}</span> <span class="main">+</span> 
              <span class="main">{#</span> mset_set <span class="main">{</span><span class="bound">y</span> <span class="main">.</span><span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="bound">b2</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">|</span> <span class="bound"><span class="bound">b2</span></span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">p</span> <span class="main">⊆</span> <span class="bound">b2</span><span class="main">)</span><span class="main">#}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_mset_union multiset_partition<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="var">?M</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> 
      size <span class="main">{#</span> mset_set <span class="main">{</span><span class="bound">y</span> <span class="main">.</span><span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="bound">b2</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">|</span> <span class="bound"><span class="bound">b2</span></span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span> <span class="main">.</span> <span class="free">p</span> <span class="main">⊆</span> <span class="bound">b2</span><span class="main">#}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> pin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> count_sum_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> size_inter <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-sym_sum_mset_inter2_sets_size"><span class="command">lemma</span></span> sym_sum_mset_inter2_sets_size<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">blv</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="main">{#</span>mset_set <span class="main">{</span><span class="bound">y</span> <span class="main">.</span><span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="bound">b2</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span><span class="main">.</span> <span class="bound">b2</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">(</span>nat <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="var">?M</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>nat <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b2</span> <span class="main">.</span> <span class="bound">b2</span> <span class="main">∈#</span> remove1_mset <span class="free">blv</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="main">{</span><span class="bound">y</span> <span class="main">.</span><span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">⊆</span> <span class="bound">b2</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> index_one_alt_bl_not_exist assms True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sum_mset.neutral True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> index_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_not_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">have</span></span> subset_card<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="var">?M</span><span class="main">)</span> <span class="main">⟹</span> card <span class="bound">x</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="var">?M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> mset_set <span class="main">{</span><span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∩</span> <span class="skolem">b2</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">b2</span> <span class="main">∈#</span><span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">blv</span><span class="main">#}</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">x</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mem_Collect_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> elem_mset_set equals0D infinite_set_mset_mset_set<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="var">?M</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∧</span> card <span class="bound">bl</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="var">?M</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∧</span> card <span class="bound">bl</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subset_card intersect_mult_set_block_subset_iff assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">⊆</span> <span class="free">blv</span> <span class="main">∧</span> card <span class="bound">bl</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">⊆</span> set_mset <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="var">?M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> intersect_mult_set_block_subset_iff_2 assms index_min <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">blv</span> <span class="main">=</span> <span class="main">(</span>nat <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> uniform assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat_int<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set_mset <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span><span class="var">?M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>nat <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq n_subsets
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_subsets assms finite_blocks<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> k size_multiset_int_count sym_sum_mset_inter2_sets_count assms eq subset_card
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> intersect_mult_set_block_subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-sum_choose_two_inter_num"><span class="command">lemma</span></span> sum_choose_two_inter_num<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b2</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>nat <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">b2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> div_fact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> div_fact_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> symmetric_condition_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b2</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>nat <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">b2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b2</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> nat <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|⇩</span><span class="numeral">2</span> <span class="bound">b2</span> <span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> n_inter_num_choose_design_inter assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_diffD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sum_fact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b2</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span><span class="main">(</span>nat <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">b2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> <span class="main">(</span><span class="main">(</span>nat <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms sym_sum_mset_inter2_sets_size 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_big_union_sum n_intersect_num_subset_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>nat <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> choose_two_int symmetric_condition_2 k_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>nat <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> div_fact div_fact_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> div_mult_swap mult.assoc mult.commute<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sum_fact <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-sym_sum_inter_num_sq"><span class="command">lemma</span></span> sym_sum_inter_num_sq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span> 𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="main">(</span> 𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b2</span> <span class="main">∈#</span><span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> int <span class="main">(</span>nat <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">b2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            <span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">*</span>  <span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> choose_two_int <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intersection_num_non_neg<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b2</span> <span class="main">∈#</span><span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> int <span class="main">(</span>nat <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">b2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
              <span class="main">(</span><span class="main">∑</span><span class="bound">b2</span> <span class="main">∈#</span><span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>nat <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">b2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b2</span> <span class="main">∈#</span><span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>nat <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">b2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span> 𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sum_choose_two_inter_num assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">*</span>  <span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> 
                        <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a b <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> sum_dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">*</span>  <span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_mset_dvd<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> 
      <span class="main">=</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> start <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_mset_distrib_div_if_dvd<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> 
      <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_dvd dvd 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dvd_div_eq_iff  div_mult_swap int_distrib<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> power2_eq_square sum_mset_add_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sym_sum_inter_num assms rep_value_sym symmetric_condition_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> diff_eq_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> int_distrib<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_numeral_1_right numeral_One<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-sym_sum_inter_num_to_zero"><span class="command">lemma</span></span> sym_sum_inter_num_to_zero<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> rm1_size<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">=</span> 𝗏 <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms b_non_zero int_ops<span class="main">(</span>6<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symmetric size_remove1_mset_If<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> 
              <span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_over_fun_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">+</span> <span class="main">(</span>𝗏 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sym_sum_inter_num_sq rm1_size 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sum_mset.distrib  sum_mset_add_diff sum_mset_distrib_left<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rep_value_sym symmetric_condition_2 sym_sum_inter_num assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> sym_block_intersections_index <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b2</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">b1</span><span class="main">#}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">|∩|</span> <span class="free">b2</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sym_sum_inter_num_to_zero assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span><span class="main">.</span>  <span class="bound">bl</span> <span class="main">∈</span> set_mset <span class="main">(</span>remove1_mset <span class="free">b1</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">b1</span> <span class="main">|∩|</span> <span class="bound">bl</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sum_mset_0_iff_ge_0 pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Symmetric BIBD is Simple›</span></span>

<span class="keyword1" id="BIBD-sym_block_mult_one"><span class="command">lemma</span></span> sym_block_mult_one <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>multiplicity <span class="free">bl</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> blleft<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="free">bl</span><span class="main">#}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_diff_count <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">|∩|</span> <span class="free">bl</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_non_zero assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intersection_number_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> keql<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sym_block_intersections_index blleft assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> keql index_lt_replication rep_value_sym block_size_lt_v diffs0_imp_equal k_non_zero zero_diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> incomplete
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">sublocale</span></span> symmetric_bibd <span class="main">⊆</span> simple_design
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Residual/Derived Sym BIBD Constructions›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Using the intersect result, we can reason further on residual and derived designs. 
Proofs based off lecture notes \cite{HerkeLectureNotes2016}›</span></span>

<span class="keyword1"><span class="command">locale</span></span> symmetric_bibd_block_transformations <span class="main">=</span> symmetric_bibd <span class="main">+</span> bibd_block_transformations
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1" id="BIBD-derived_block_size"><span class="command">lemma</span></span> derived_block_size <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">b</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bl2</span></span> <span class="keyword2"><span class="keyword">where</span></span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bl2</span> <span class="main">∈#</span> remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">bl2</span> <span class="main">∩</span> <span class="keyword1"><span class="free">bl</span></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> derived_blocks_def assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> derived_obtain_orig_block<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">b</span> <span class="main">=</span> <span class="skolem">bl2</span> <span class="main">|∩|</span> <span class="keyword1"><span class="free">bl</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intersection_number_def<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sym_block_intersections_index
    <span class="keyword1"><span class="command">using</span></span> set intersect_num_commute valid_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-derived_points_index"><span class="command">lemma</span></span> derived_points_index <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">bl</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span> <span class="keyword1">index</span>  <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> b_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">∩</span> <span class="keyword1"><span class="free">bl</span></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> orig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_block assms wellformed <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lam<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">#}</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> balanced
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>  points_index_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">#}</span> <span class="main">=</span> size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">#}</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms valid_block <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_Diff_submset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">#}</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> lam index_not_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size  <span class="main">{#</span> <span class="keyword1"><span class="free">bl</span></span> <span class="main">∩</span> <span class="bound">b</span> <span class="main">|</span>  <span class="bound"><span class="bound">b</span></span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">bl</span></span> <span class="main">∩</span> <span class="bound">b</span> <span class="main">#}</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> b_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Int_subset_iff filter_mset_cong size_image_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">{#</span> <span class="keyword1"><span class="free">bl</span></span> <span class="main">∩</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">#}</span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">x</span> <span class="main">#}</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_mset_filter_swap<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">x</span> <span class="main">#}</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derived_blocks_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-sym_derive_design_bibd"><span class="command">lemma</span></span> sym_derive_design_bibd<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bibd <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> proper_design <span class="quoted"><span class="keyword1"><span class="free">bl</span></span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>D</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> derived_is_proper assms valid_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">&lt;</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_lt_replication rep_value_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> derived_block_size assms derived_points_index derived_points_order
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-residual_block_size"><span class="command">lemma</span></span> residual_block_size <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">b</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bl2</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">bl2</span> <span class="main">-</span> <span class="keyword1"><span class="free">bl</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bl2</span> <span class="main">∈#</span> remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms residual_blocks_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">b</span> <span class="main">=</span> card <span class="skolem">bl2</span> <span class="main">-</span> card <span class="main">(</span><span class="skolem">bl2</span> <span class="main">∩</span> <span class="keyword1"><span class="free">bl</span></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_Diff_subset_Int valid_block finite_blocks
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Diff_subset_Int<span class="main">)</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">b</span> <span class="main">=</span> card <span class="skolem">bl2</span> <span class="main">-</span> <span class="skolem">bl2</span> <span class="main">|∩|</span> <span class="keyword1"><span class="free">bl</span></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> intersection_number_def finite_blocks card_inter_lt_single
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms derived_fin_incidence_system.finite_sets finite_Diff2 of_nat_diff 
        residual_fin_incidence_sys.finite_blocks sub<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sym_block_intersections_index uniform
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_block in_diffD intersect_num_commute mem<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-residual_index"><span class="command">lemma</span></span> residual_index <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">bl</span></span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="main">∈#</span> remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">⟹</span>  <span class="free">ps</span> <span class="main">⊆</span> <span class="main">(</span><span class="bound">b</span> <span class="main">-</span> <span class="keyword1"><span class="free">bl</span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> DiffI block_comp_elem_alt_left in_diffD subset_eq wellformed<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="main">∈#</span> remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span>  <span class="free">ps</span> <span class="main">⊆</span> <span class="main">(</span><span class="bound">b</span> <span class="main">-</span> <span class="keyword1"><span class="free">bl</span></span><span class="main">)</span> <span class="main">⟹</span>  <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> not_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">bl</span></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_diff_non_empty_not_subset blocks_nempty t_non_zero assms 
    block_complement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> size <span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">{#</span> <span class="bound">b</span> <span class="main">-</span> <span class="keyword1"><span class="free">bl</span></span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">#}</span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">x</span> <span class="main">#}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms valid_block <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def residual_blocks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> size  <span class="main">{#</span> <span class="bound">b</span> <span class="main">-</span> <span class="keyword1"><span class="free">bl</span></span> <span class="main">|</span>  <span class="bound"><span class="bound">b</span></span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">-</span> <span class="keyword1"><span class="free">bl</span></span> <span class="main">#}</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_mset_filter_swap<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> size  <span class="main">{#</span>  <span class="bound">b</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="keyword1"><span class="free">bl</span></span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">#}</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> a b
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> filter_mset_cong size_image_mset<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> balanced not_ss assms points_index_alt_def block_complement_subset_points <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BIBD-sym_residual_design_bibd"><span class="command">lemma</span></span> sym_residual_design_bibd<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">≥</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bibd <span class="main">(</span><span class="keyword1"><span class="free">bl</span></span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span><span class="main">)</span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> proper_design <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bl</span></span><span class="keyword1"><span class="hidden">⇧</span><sup>c</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇧</span><sup>R</sup></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> residual_is_proper assms<span class="main">(</span>1<span class="main">)</span> valid_block sym_block_mult_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> residual_block_size assms sym_design_vk_gt_kl residual_order residual_index 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹BIBD's and Other Block Designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹BIBD's are closely related to other block designs by indirect inheritance›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> bibd <span class="main">⊆</span> k_Λ_PBD <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">Λ</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">𝗄</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> block_size_gt_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="BIBD-incomplete_PBD_is_bibd"><span class="command">lemma</span></span> incomplete_PBD_is_bibd<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> card <span class="free">V</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"k_Λ_PBD <span class="free">V</span> <span class="free">B</span> <span class="free">Λ</span> <span class="free">k</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bibd <span class="free">V</span> <span class="free">B</span> <span class="free">k</span> <span class="free">Λ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> inc<span class="main">:</span> incomplete_design <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">k</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_design.incomplete_designI k_Λ_PBD.axioms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> pairwise_balance<span class="main">:</span> pairwise_balance <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">Λ</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k_Λ_PBD.axioms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms k_Λ_PBD.block_size_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bibd<span class="main">)</span> bibd_to_pbdI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"k_PBD <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> pbd<span class="main">:</span> k_Λ_PBD <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">Λ</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">𝗄</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k_Λ_PBD_axioms<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_lt_order min_block_size_2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> incomplete_PBD <span class="main">=</span> incomplete_design <span class="main">+</span> k_Λ_PBD

<span class="keyword1"><span class="command">sublocale</span></span> incomplete_PBD <span class="main">⊆</span> bibd
  <span class="keyword1"><span class="command">using</span></span> block_size_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Resolvable_Designs">
<div class="head">
<h1>Theory Resolvable_Designs</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Resolvable_Designs.thy
   Author: Chelsea Edmonds
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Resolvable Designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Resolvable designs have further structure, and can be "resolved" into a set of resolution 
classes. A resolution class is a subset of blocks which exactly partitions the point set. 
Definitions based off the handbook \cite{colbournHandbookCombinatorialDesigns2007}
 and Stinson \cite{stinsonCombinatorialDesignsConstructions2004}.
This theory includes a proof of an alternate statement of Bose's theorem›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Resolvable_Designs <span class="keyword2"><span class="keyword">imports</span></span> <a href="#BIBD">BIBD</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Resolutions and Resolution Classes›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A resolution class is a partition of the point set using a set of blocks from the design 
A resolution is a group of resolution classes partitioning the block collection›</span></span>

<span class="keyword1"><span class="command">context</span></span> incidence_system
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">resolution_class</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">resolution_class</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟷</span> partition_on <span class="keyword1"><span class="free">𝒱</span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">bl</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Resolvable_Designs-resolution_classI"><span class="command">lemma</span></span> resolution_classI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="keyword1"><span class="free">𝒱</span></span>  <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> 
    <span class="main">⟹</span> resolution_class <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resolution_class_def<span class="main">)</span>

<span class="keyword1" id="Resolvable_Designs-resolution_classD1"><span class="command">lemma</span></span> resolution_classD1<span class="main">:</span> <span class="quoted"><span class="quoted">"resolution_class <span class="free">S</span> <span class="main">⟹</span> partition_on <span class="keyword1"><span class="free">𝒱</span></span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resolution_class_def<span class="main">)</span>

<span class="keyword1" id="Resolvable_Designs-resolution_classD2"><span class="command">lemma</span></span> resolution_classD2<span class="main">:</span> <span class="quoted"><span class="quoted">"resolution_class <span class="free">S</span> <span class="main">⟹</span>  <span class="free">bl</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resolution_class_def<span class="main">)</span>

<span class="keyword1" id="Resolvable_Designs-resolution_class_empty_iff"><span class="command">lemma</span></span> resolution_class_empty_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"resolution_class <span class="main">{}</span> <span class="main">⟷</span> <span class="keyword1"><span class="free">𝒱</span></span>  <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resolution_class_def partition_on_def<span class="main">)</span>

<span class="keyword1" id="Resolvable_Designs-resolution_class_complete"><span class="command">lemma</span></span> resolution_class_complete<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒱</span></span>  <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">𝒱</span></span>  <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> resolution_class <span class="main">{</span><span class="keyword1"><span class="free">𝒱</span></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resolution_class_def partition_on_space<span class="main">)</span>

<span class="keyword1" id="Resolvable_Designs-resolution_class_union"><span class="command">lemma</span></span> resolution_class_union<span class="main">:</span> <span class="quoted"><span class="quoted">"resolution_class <span class="free">S</span> <span class="main">⟹</span> <span class="main">⋃</span><span class="free">S</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝒱</span></span> "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resolution_class_def partition_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> finite_incidence_system<span class="main">)</span> resolution_class_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"resolution_class <span class="free">S</span> <span class="main">⟹</span> finite <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_elements finite_sets <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resolution_class_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> design<span class="main">)</span> resolution_class_sum_card<span class="main">:</span> <span class="quoted"><span class="quoted">"resolution_class <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">.</span> card <span class="bound">bl</span><span class="main">)</span> <span class="main">=</span> 𝗏"</span></span>
  <span class="keyword1"><span class="command">using</span></span> resolution_class_union finite_blocks
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resolution_class_def partition_on_def card_Union_disjoint<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">resolution</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set multiset multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">resolution</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟷</span> partition_on_mset <span class="keyword1"><span class="free">ℬ</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">S</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">.</span> distinct_mset <span class="bound">S</span> <span class="main">∧</span> resolution_class <span class="main">(</span>set_mset <span class="bound">S</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Resolvable_Designs-resolutionI"><span class="command">lemma</span></span> resolutionI <span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="keyword1"><span class="free">ℬ</span></span> <span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">S</span> <span class="main">.</span> <span class="bound">S</span> <span class="main">∈#</span><span class="free">P</span> <span class="main">⟹</span> distinct_mset <span class="bound">S</span><span class="main">)</span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="main">⋀</span> <span class="bound">S</span> <span class="main">.</span> <span class="bound">S</span><span class="main">∈#</span> <span class="free">P</span> <span class="main">⟹</span> resolution_class <span class="main">(</span>set_mset <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> resolution <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resolution_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> proper_design<span class="main">)</span> resolution_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_mset <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> disjoint <span class="main">(</span>set_mset <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">⟹</span> 
    <span class="main">⋃</span><span class="main">(</span>set_mset <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> resolution <span class="main">{#</span><span class="keyword1"><span class="free">ℬ</span></span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> resolution_def resolution_class_def partition_on_mset_def partition_on_def
  <span class="keyword1"><span class="command">using</span></span> design_blocks_nempty blocks_nempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Resolvable Design Locale›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A resolvable design is one with a resolution P›</span></span>
<span class="keyword1"><span class="command">locale</span></span> resolvable_design <span class="main">=</span> design <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">partition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set multiset multiset"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1">𝒫</span></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> resolvable<span class="main">:</span> <span class="quoted"><span class="quoted">"resolution <span class="keyword1"><span class="free">𝒫</span></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Resolvable_Designs-resolutionD1"><span class="command">lemma</span></span> resolutionD1<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on_mset <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1"><span class="free">𝒫</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> resolvable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resolution_def<span class="main">)</span>

<span class="keyword1" id="Resolvable_Designs-resolutionD2"><span class="command">lemma</span></span> resolutionD2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈#</span><span class="keyword1"><span class="free">𝒫</span></span> <span class="main">⟹</span> distinct_mset <span class="free">S</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> resolvable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span>  <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resolution_def<span class="main">)</span>

<span class="keyword1" id="Resolvable_Designs-resolutionD3"><span class="command">lemma</span></span> resolutionD3<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">S</span><span class="main">∈#</span> <span class="keyword1"><span class="free">𝒫</span></span> <span class="main">⟹</span> resolution_class <span class="main">(</span>set_mset <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> resolvable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resolution_def<span class="main">)</span>

<span class="keyword1" id="Resolvable_Designs-resolution_class_blocks_disjoint"><span class="command">lemma</span></span> resolution_class_blocks_disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">𝒫</span></span> <span class="main">⟹</span> disjoint <span class="main">(</span>set_mset <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> resolutionD3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_def resolution_class_def<span class="main">)</span> 

<span class="keyword1" id="Resolvable_Designs-resolution_not_empty"><span class="command">lemma</span></span> resolution_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">𝒫</span></span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> partition_on_mset_not_empty resolutionD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Resolvable_Designs-resolution_blocks_subset"><span class="command">lemma</span></span> resolution_blocks_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">𝒫</span></span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">⊆#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> partition_on_mset_subsets resolutionD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> incidence_system<span class="main">)</span> resolvable_designI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"resolution <span class="free">𝒫</span> <span class="main">⟹</span> design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> 
    resolvable_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="free">𝒫</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resolvable_design.intro resolvable_design_axioms.intro<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Resolvable Block Designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An RBIBD is a resolvable BIBD - a common subclass of interest for block designs›</span></span>
<span class="keyword1"><span class="command">locale</span></span> r_block_design <span class="main">=</span> resolvable_design <span class="main">+</span> block_design
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Resolvable_Designs-resolution_class_blocks_constant_size"><span class="command">lemma</span></span> resolution_class_blocks_constant_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">𝒫</span></span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">∈#</span> <span class="free">S</span> <span class="main">⟹</span> card <span class="free">bl</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> resolutionD3 resolution_classD2 uniform_alt_def_all<span class="main">)</span>

<span class="keyword1" id="Resolvable_Designs-resolution_class_size1"><span class="command">lemma</span></span> resolution_class_size1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">𝒫</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> size <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="free">S</span> <span class="main">.</span> card <span class="bound">bl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈</span> <span class="main">(</span>set_mset <span class="free">S</span><span class="main">)</span> <span class="main">.</span> card <span class="bound">bl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> resolutionD2 assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  sum_unfold_sum_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eqv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="free">S</span> <span class="main">.</span> card <span class="bound">bl</span><span class="main">)</span> <span class="main">=</span> 𝗏"</span></span> <span class="keyword1"><span class="command">using</span></span> resolutionD3 assms resolution_class_sum_card
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="free">S</span> <span class="main">.</span> card <span class="bound">bl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">bl</span> <span class="main">∈#</span> <span class="free">S</span> <span class="main">.</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> resolution_class_blocks_constant_size assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eqv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.commute sum_mset_constant<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resolvable_Designs-resolution_class_size2"><span class="command">lemma</span></span> resolution_class_size2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">𝒫</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="free">S</span> <span class="main">=</span> 𝗏 <span class="keyword1">div</span> <span class="keyword1"><span class="free">𝗄</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> resolution_class_size1 assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nonzero_mult_div_cancel_left not_one_le_zero k_non_zero<span class="main">)</span>

<span class="keyword1" id="Resolvable_Designs-resolvable_necessary_cond_v"><span class="command">lemma</span></span> resolvable_necessary_cond_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="keyword1">dvd</span> 𝗏"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> s_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈#</span><span class="keyword1"><span class="free">𝒫</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> resolution_not_empty design_blocks_nempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> size <span class="skolem">S</span> <span class="main">=</span> 𝗏"</span></span> <span class="keyword1"><span class="command">using</span></span> resolution_class_size1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_triv_left<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> rbibd <span class="main">=</span> r_block_design <span class="main">+</span> bibd
 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Resolvable_Designs-resolvable_design_num_res_classes"><span class="command">lemma</span></span> resolvable_design_num_res_classes<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="keyword1"><span class="free">𝒫</span></span> <span class="main">=</span> 𝗋"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> k_ne0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">S</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">𝒫</span></span> <span class="main">.</span> size <span class="bound">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> partition_on_msetD1 resolutionD1 size_big_union_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">S</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">𝒫</span></span> <span class="main">.</span> 𝗏 <span class="keyword1">div</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> resolution_class_size2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">=</span> <span class="main">(</span>size <span class="keyword1"><span class="free">𝒫</span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>𝗏 <span class="keyword1">div</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="keyword1"><span class="free">𝒫</span></span> <span class="main">=</span> 𝖻 <span class="keyword1">div</span> <span class="main">(</span>𝗏 <span class="keyword1">div</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="keyword1"><span class="free">𝒫</span></span> <span class="main">=</span> <span class="main">(</span>𝖻 <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="keyword1">div</span> 𝗏"</span></span> <span class="keyword1"><span class="command">using</span></span> f2 resolvable_necessary_cond_v
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_div_div_same div_dvd_div dvd_triv_right k_ne0 nonzero_mult_div_cancel_right<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> necessary_condition_two
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nonzero_mult_div_cancel_left not_one_less_zero t_design_min_v<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resolvable_Designs-resolvable_necessary_cond_b"><span class="command">lemma</span></span> resolvable_necessary_cond_b<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗋 <span class="keyword1">dvd</span> 𝖻"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">S</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">𝒫</span></span> <span class="main">.</span> size <span class="bound">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> partition_on_msetD1 resolutionD1 size_big_union_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">S</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">𝒫</span></span> <span class="main">.</span> 𝗏 <span class="keyword1">div</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> resolution_class_size2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> resolvable_design_num_res_classes <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Bose's Inequality›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Boses inequality is an important theorem on RBIBD's. This is a proof 
of an alternate statement of the thm, which does not require a linear algebraic approach, 
taken directly from Stinson \cite{stinsonCombinatorialDesignsConstructions2004}›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> bose_inequality_alternate<span class="main">:</span> <span class="quoted"><span class="quoted">"𝖻 <span class="main">≥</span> 𝗏 <span class="main">+</span> 𝗋 <span class="main">-</span> <span class="main">1</span> <span class="main">⟷</span> 𝗋 <span class="main">≥</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">+</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> kdvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="keyword1">dvd</span> <span class="main">(</span>𝗏 <span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> necessary_condition_two <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_diff_distrib'<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> v_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">=</span> <span class="main">(</span>𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">)</span> <span class="keyword1">div</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> necessary_condition_one index_not_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ldvd<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> necessary_condition_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>𝖻 <span class="main">≥</span> 𝗏 <span class="main">+</span> 𝗋 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span>𝗏 <span class="main">*</span> 𝗋<span class="main">)</span> <span class="keyword1">div</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">≥</span> 𝗏 <span class="main">+</span> 𝗋 <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> necessary_condition_two k_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>𝗏 <span class="main">*</span> 𝗋<span class="main">)</span> <span class="main">-</span> <span class="main">(</span>𝗏 <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">≥</span> 𝗋 <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  k_non_zero div_mult_self3 k_non_zero necessary_condition_two <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span>𝗏 <span class="main">*</span> <span class="main">(</span> 𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span> 𝗋 <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> k_non_zero kdvd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_distrib<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mult_of_nat_commute<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">)</span> <span class="keyword1">div</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> v_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span> <span class="main">(</span>𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">)</span> <span class="keyword1">div</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span> <span class="main">(</span><span class="main">(</span>𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">≥</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_mult_swap dvd_add_triv_right_iff dvd_triv_left necessary_condition_one<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">)</span><span class="main">)</span>  <span class="main">≥</span>  <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ldvd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dvd_mult_div_cancel index_not_zero mult_strict_left_mono<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span>𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="main">*</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">)</span>  <span class="main">≥</span>  <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="main">*</span> 𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span>𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="main">*</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> mult.assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="main">*</span> 𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> 𝗋<span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span>𝗋 <span class="main">*</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span> <span class="main">-</span><span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> distrib_right <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left right_diff_distrib' left_diff_distrib'<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="main">*</span> 𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> 𝗋<span class="main">)</span>  <span class="main">-</span> <span class="main">(</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> 𝗋<span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="main">*</span> 𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span>  <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">*</span> 𝗋<span class="main">)</span><span class="main">)</span>  <span class="main">-</span> <span class="main">(</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> 𝗋<span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>  
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="main">*</span> 𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="keyword1"><span class="free">Λ</span></span>  <span class="main">*</span> <span class="main">(</span>𝗋 <span class="main">*</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span><span class="main">)</span>  <span class="main">-</span> <span class="main">(</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> 𝗋<span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>𝗋 <span class="main">-</span> <span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="main">*</span> 𝗋 <span class="main">*</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">*</span> 𝗋 <span class="main">*</span> <span class="main">(</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  mult.assoc int_distrib<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>𝖻 <span class="main">≥</span> 𝗏 <span class="main">+</span> 𝗋 <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>𝗋 <span class="main">≥</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">+</span> <span class="keyword1"><span class="free">Λ</span></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> index_lt_replication mult_right_le_imp_le r_gzero
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> mult_cancel_right k_non_zero<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Group_Divisible_Designs">
<div class="head">
<h1>Theory Group_Divisible_Designs</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Group_Divisible_Designs.thy
   Author: Chelsea Edmonds
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Group Divisible Designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definitions in this section taken from the handbook \cite{colbournHandbookCombinatorialDesigns2007}
and Stinson \cite{stinsonCombinatorialDesignsConstructions2004}›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Group_Divisible_Designs <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Resolvable_Designs">Resolvable_Designs</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Group design›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a group design to have an additional paramater $G$ which is a partition on the point 
set $V$. This is not defined in the handbook, but is a precursor to GDD's without index constraints›</span></span>

<span class="keyword1"><span class="command">locale</span></span> group_design <span class="main">=</span> proper_design <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">groups</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">𝒢</span></span></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> group_partitions<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> groups_size<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Group_Divisible_Designs-groups_not_empty"><span class="command">lemma</span></span> groups_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒢</span></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> groups_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Group_Divisible_Designs-num_groups_lt_points"><span class="command">lemma</span></span> num_groups_lt_points<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">≤</span> 𝗏"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_le_set_elements finite_sets group_partitions<span class="main">)</span> 

<span class="keyword1" id="Group_Divisible_Designs-groups_disjoint"><span class="command">lemma</span></span> groups_disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint <span class="keyword1"><span class="free">𝒢</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> group_partitions partition_onD2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Group_Divisible_Designs-groups_disjoint_pairwise"><span class="command">lemma</span></span> groups_disjoint_pairwise<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G1</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="free">G2</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="free">G1</span> <span class="main">≠</span> <span class="free">G2</span> <span class="main">⟹</span> disjnt <span class="free">G1</span> <span class="free">G2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> group_partitions partition_onD2 pairwiseD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="Group_Divisible_Designs-point_in_one_group"><span class="command">lemma</span></span> point_in_one_group<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">G1</span> <span class="main">⟹</span> <span class="free">G1</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="free">G2</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="free">G1</span> <span class="main">≠</span> <span class="free">G2</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">G2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> groups_disjoint_pairwise <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjnt_iff<span class="main">)</span> 

<span class="keyword1" id="Group_Divisible_Designs-point_has_unique_group"><span class="command">lemma</span></span> point_has_unique_group<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="main">∃!</span><span class="bound">G</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">G</span> <span class="main">∧</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> partition_on_partition_on_unique group_partitions
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="Group_Divisible_Designs-rep_number_point_group_one"><span class="command">lemma</span></span> rep_number_point_group_one<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">g</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">g</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">g'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms point_has_unique_group <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">g</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">g</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">g'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  group_partitions partition_onD4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-point_in_group"><span class="command">lemma</span></span> point_in_group<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> group_partitions partition_onD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Group_Divisible_Designs-point_subset_in_group"><span class="command">lemma</span></span> point_subset_in_group<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> point_in_group <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Group_Divisible_Designs-group_subset_point_subset"><span class="command">lemma</span></span> group_subset_point_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="free">G'</span> <span class="main">⊆</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="free">G'</span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> point_subset_in_group <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Group_Divisible_Designs-groups_finite"><span class="command">lemma</span></span> groups_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="keyword1"><span class="free">𝒢</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_elements finite_sets group_partitions <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Group_Divisible_Designs-group_elements_finite"><span class="command">lemma</span></span> group_elements_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> finite <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> groups_finite finite_sets group_partitions
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> finite_subset point_in_group subset_iff<span class="main">)</span>

<span class="keyword1" id="Group_Divisible_Designs-v_equals_sum_group_sizes"><span class="command">lemma</span></span> v_equals_sum_group_sizes<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">.</span> card <span class="bound">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> group_partitions groups_disjoint partition_onD1 card_Union_disjoint group_elements_finite 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="Group_Divisible_Designs-gdd_min_v"><span class="command">lemma</span></span> gdd_min_v<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> groups_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="bound">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> partition_onD3 group_partitions <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> card <span class="bound">G</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group_elements_finite card_0_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">∑</span><span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">.</span> card <span class="bound">G</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assm
    <span class="keyword1"><span class="command">using</span></span> sum_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> v_equals_sum_group_sizes
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-min_group_size"><span class="command">lemma</span></span> min_group_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> card <span class="free">G</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> partition_onD3 group_partitions
  <span class="keyword1"><span class="command">using</span></span> group_elements_finite not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  

<span class="keyword1" id="Group_Divisible_Designs-group_size_lt_v"><span class="command">lemma</span></span> group_size_lt_v<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">G</span> <span class="main">&lt;</span> 𝗏"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">G'</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">.</span> card <span class="bound">G'</span><span class="main">)</span> <span class="main">=</span> 𝗏"</span></span> <span class="keyword1"><span class="command">using</span></span> gdd_min_v v_equals_sum_group_sizes
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> split_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">G</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">G'</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1"><span class="free">𝒢</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">G</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> card <span class="bound">G'</span><span class="main">)</span> <span class="main">=</span> 𝗏"</span></span> <span class="keyword1"><span class="command">using</span></span> assms sum.remove
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> groups_finite v_equals_sum_group_sizes<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="keyword1"><span class="free">𝒢</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">G</span><span class="main">}</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> groups_size
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms groups_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G'</span></span> <span class="keyword2"><span class="keyword">where</span></span> gin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G'</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1"><span class="free">𝒢</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">G</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> elem_exists_non_empty_set less_le_trans less_numeral_extra<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">G'</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> min_group_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">G'</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1"><span class="free">𝒢</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">G</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> card <span class="bound">G'</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gin finite_Diff groups_finite leI less_one sum_eq_0_iff<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> split_sum
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Group Type›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹GDD's have a "type", which is defined by a sequence of group sizes $g_i$, and the number 
of groups of that size $a_i$: $g_1^{a_1}g2^{a_2}...g_n^{a_n}$›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">group_sizes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">group_sizes</span> <span class="main">≡</span> <span class="main">{</span>card <span class="bound">G</span> <span class="main">|</span> <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">groups_of_size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">groups_of_size</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> card <span class="main">{</span> <span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">group_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">group_type</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">g</span><span class="main">,</span> groups_of_size <span class="bound">g</span><span class="main">)</span> <span class="main">|</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> group_sizes <span class="main">}</span>"</span></span>

<span class="keyword1" id="Group_Divisible_Designs-group_sizes_min"><span class="command">lemma</span></span> group_sizes_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> group_sizes <span class="main">⟹</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">1</span> "</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> group_sizes_def <span class="keyword1"><span class="command">using</span></span> min_group_size group_size_lt_v <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Group_Divisible_Designs-group_sizes_max"><span class="command">lemma</span></span> group_sizes_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> group_sizes <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> 𝗏 "</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> group_sizes_def <span class="keyword1"><span class="command">using</span></span> min_group_size group_size_lt_v <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Group_Divisible_Designs-group_size_implies_group_existance"><span class="command">lemma</span></span> group_size_implies_group_existance<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> group_sizes <span class="main">⟹</span> <span class="main">∃</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">∧</span> card <span class="bound">G</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> group_sizes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Group_Divisible_Designs-groups_of_size_zero"><span class="command">lemma</span></span> groups_of_size_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"groups_of_size <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> min_group_size
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> groups_of_size_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-groups_of_size_max"><span class="command">lemma</span></span> groups_of_size_max<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≥</span> 𝗏"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"groups_of_size <span class="free">g</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="free">g</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> group_size_lt_v assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> groups_of_size_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="free">g</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-group_type_contained_sizes"><span class="command">lemma</span></span> group_type_contained_sizes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> group_type <span class="main">⟹</span> <span class="free">g</span> <span class="main">∈</span> group_sizes"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> group_type_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Group_Divisible_Designs-group_type_contained_count"><span class="command">lemma</span></span> group_type_contained_count<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> group_type <span class="main">⟹</span> card <span class="main">{</span><span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="free">g</span><span class="main">}</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> group_type_def groups_of_size_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Group_Divisible_Designs-group_card_in_sizes"><span class="command">lemma</span></span> group_card_in_sizes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> card <span class="free">g</span> <span class="main">∈</span> group_sizes"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> group_sizes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Group_Divisible_Designs-group_card_non_zero_groups_of_size_min"><span class="command">lemma</span></span> group_card_non_zero_groups_of_size_min<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">g</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"groups_of_size <span class="free">a</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groups_finite<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> groups_of_size_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-elem_in_group_sizes_min_of_size"><span class="command">lemma</span></span> elem_in_group_sizes_min_of_size<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> group_sizes"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"groups_of_size <span class="free">a</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms group_card_non_zero_groups_of_size_min group_size_implies_group_existance <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Group_Divisible_Designs-group_card_non_zero_groups_of_size_max"><span class="command">lemma</span></span> group_card_non_zero_groups_of_size_max<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"groups_of_size <span class="free">a</span> <span class="main">≤</span> 𝗏"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span> <span class="main">≤</span> card <span class="keyword1"><span class="free">𝒢</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_mono groups_finite<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> groups_of_size_def num_groups_lt_points <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-group_card_in_type"><span class="command">lemma</span></span> group_card_in_type<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">x</span> <span class="main">.</span> <span class="main">(</span>card <span class="free">g</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> group_type <span class="main">∧</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> group_type_def <span class="keyword1"><span class="command">using</span></span> group_card_non_zero_groups_of_size_min
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> group_card_in_sizes<span class="main">)</span>

<span class="keyword1" id="Group_Divisible_Designs-partition_groups_on_size"><span class="command">lemma</span></span> partition_groups_on_size<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">{</span><span class="main">{</span> <span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="bound">g</span> <span class="main">}</span> <span class="main">|</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> group_sizes<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> partition_onI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> group_sizes"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟶</span> card <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> a1 group_size_implies_group_existance <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xa</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">g</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="bound">g</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">∈</span> group_sizes<span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">xa</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  group_card_in_sizes <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-group_size_partition_covers_points"><span class="command">lemma</span></span> group_size_partition_covers_points<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="main">⋃</span><span class="main">{</span><span class="main">{</span> <span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="bound">g</span> <span class="main">}</span> <span class="main">|</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> group_sizes<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> group_partitions partition_groups_on_size partition_onD1<span class="main">)</span>

<span class="keyword1" id="Group_Divisible_Designs-groups_of_size_alt_def_count"><span class="command">lemma</span></span> groups_of_size_alt_def_count<span class="main">:</span> <span class="quoted"><span class="quoted">"groups_of_size <span class="free">g</span> <span class="main">=</span> count <span class="main">{#</span> card <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈#</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">#}</span> <span class="free">g</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"groups_of_size <span class="free">g</span> <span class="main">=</span>  card <span class="main">{</span> <span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="free">g</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> groups_of_size_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"groups_of_size <span class="free">g</span> <span class="main">=</span>  size <span class="main">{#</span> <span class="bound">G</span> <span class="main">∈#</span> <span class="main">(</span>mset_set <span class="keyword1"><span class="free">𝒢</span></span><span class="main">)</span> <span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="free">g</span> <span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> groups_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> size_repr<span class="main">:</span> <span class="quoted"><span class="quoted">"groups_of_size <span class="free">g</span> <span class="main">=</span>  size <span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">{#</span> card <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈#</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">#}</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> groups_finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_mset_image_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"group_sizes <span class="main">=</span> set_mset <span class="main">(</span><span class="main">{#</span> card <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈#</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">#}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> group_sizes_def groups_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> size_repr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> count_size_set_repr<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-v_sum_type_rep"><span class="command">lemma</span></span> v_sum_type_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">g</span> <span class="main">∈</span> group_sizes <span class="main">.</span> <span class="bound">g</span> <span class="main">*</span> <span class="main">(</span>groups_of_size <span class="bound">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">{#</span> card <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈#</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">#}</span> <span class="main">=</span> group_sizes"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> group_sizes_def <span class="keyword1"><span class="command">using</span></span> groups_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">=</span> card <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main">⋃</span><span class="main">{</span><span class="main">{</span> <span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="bound">g</span> <span class="main">}</span> <span class="main">|</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> group_sizes<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group_size_partition_covers_points <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span> <span class="main">{#</span> card <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈#</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">#}</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_unfold_sum_mset v_equals_sum_group_sizes<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> set_mset <span class="main">{#</span> card <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈#</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">#}</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span>count <span class="main">{#</span> card <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈#</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">#}</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> mset_set_size_card_count <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gs groups_of_size_alt_def_count <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Uniform Group designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A group design requiring all groups are the same size›</span></span>
<span class="keyword1"><span class="command">locale</span></span> uniform_group_design <span class="main">=</span> group_design <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u_group_size</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝗆</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> uniform_groups<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> card <span class="free">G</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗆</span></span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Group_Divisible_Designs-m_positive"><span class="command">lemma</span></span> m_positive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗆</span></span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> groups_size elem_exists_non_empty_set gr_implies_not_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> uniform_groups min_group_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-uniform_groups_alt"><span class="command">lemma</span></span> uniform_groups_alt<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">∀</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗆</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uniform_groups <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="Group_Divisible_Designs-uniform_groups_group_sizes"><span class="command">lemma</span></span> uniform_groups_group_sizes<span class="main">:</span> <span class="quoted"><span class="quoted">"group_sizes <span class="main">=</span> <span class="main">{</span><span class="keyword1"><span class="free">𝗆</span></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> design_points_nempty group_card_in_sizes group_size_implies_group_existance 
    point_has_unique_group uniform_groups_alt <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Group_Divisible_Designs-uniform_groups_group_size_singleton"><span class="command">lemma</span></span> uniform_groups_group_size_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"is_singleton <span class="main">(</span>group_sizes<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uniform_groups_group_sizes <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Group_Divisible_Designs-set_filter_eq_P_forall"><span class="command">lemma</span></span> set_filter_eq_P_forall<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> Set.filter <span class="free">P</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_conj_eq Int_absorb2 Set.filter_def subsetI<span class="main">)</span>

<span class="keyword1" id="Group_Divisible_Designs-uniform_groups_groups_of_size_m"><span class="command">lemma</span></span> uniform_groups_groups_of_size_m<span class="main">:</span> <span class="quoted"><span class="quoted">"groups_of_size <span class="keyword1"><span class="free">𝗆</span></span> <span class="main">=</span> card <span class="keyword1"><span class="free">𝒢</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groups_of_size_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗆</span></span><span class="main">}</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> uniform_groups_alt set_filter_eq_P_forall <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">.</span> card <span class="bound">G</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗆</span></span><span class="main">}</span> <span class="main">=</span> card <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-uniform_groups_of_size_not_m"><span class="command">lemma</span></span> uniform_groups_of_size_not_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="keyword1"><span class="free">𝗆</span></span> <span class="main">⟹</span> groups_of_size <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groups_of_size_def card_eq_0_iff uniform_groups<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹GDD›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A GDD extends a group design with an additional index parameter.
Each pair of elements must occur either \Lambda times if in diff groups, or 0 times if in the same 
group›</span></span>

<span class="keyword1"><span class="command">locale</span></span> GDD <span class="main">=</span> group_design <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">index</span> <span class="main">::</span> <span class="quoted">int</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">Λ</span></span></span></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> index_ge_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> index_together<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> index_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G1</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="free">G2</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="free">G1</span> <span class="main">≠</span> <span class="free">G2</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">G1</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">G2</span> <span class="main">⟹</span> 
    <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Group_Divisible_Designs-points_sep_groups_ne"><span class="command">lemma</span></span> points_sep_groups_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G1</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="free">G2</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="free">G1</span> <span class="main">≠</span> <span class="free">G2</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">G1</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">G2</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> point_in_one_group<span class="main">)</span>

<span class="keyword1" id="Group_Divisible_Designs-index_together_alt_ss"><span class="command">lemma</span></span> index_together_alt_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> index_together <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_2_iff insert_subset<span class="main">)</span> 

<span class="keyword1" id="Group_Divisible_Designs-index_distinct_alt_ss"><span class="command">lemma</span></span> index_distinct_alt_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">G</span><span class="main">)</span> <span class="main">⟹</span> 
    <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> index_distinct <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_2_iff empty_subsetI insert_subset point_has_unique_group<span class="main">)</span> 

<span class="keyword1" id="Group_Divisible_Designs-gdd_index_options"><span class="command">lemma</span></span> gdd_index_options<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> index_distinct_alt_ss index_together_alt_ss <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Group_Divisible_Designs-index_zero_implies_same_group"><span class="command">lemma</span></span> index_zero_implies_same_group<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> 
    <span class="main">∃</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_distinct_alt_ss gr_implies_not_zero
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> index_ge_1 less_one of_nat_0 of_nat_1 of_nat_le_0_iff<span class="main">)</span>

<span class="keyword1" id="Group_Divisible_Designs-index_zero_implies_same_group_unique"><span class="command">lemma</span></span> index_zero_implies_same_group_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> 
    <span class="main">∃!</span> <span class="bound"><span class="bound">G</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">G</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> GDD.index_zero_implies_same_group GDD_axioms card_2_iff' group_design.point_in_one_group 
      group_design_axioms in_mono<span class="main">)</span>

<span class="keyword1" id="Group_Divisible_Designs-index_not_zero_impl_diff_group"><span class="command">lemma</span></span> index_not_zero_impl_diff_group<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">⟹</span>  
    <span class="main">(</span><span class="main">⋀</span> <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> index_ge_1 index_together_alt_ss <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Group_Divisible_Designs-index_zero_implies_one_group"><span class="command">lemma</span></span> index_zero_implies_one_group<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span>  mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> ging<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> psin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="skolem">G</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> index_zero_implies_same_group groups_size assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">G2</span> <span class="main">.</span> <span class="bound">G2</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="skolem">G</span> <span class="main">≠</span> <span class="bound">G2</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">G2</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> index_zero_implies_same_group_unique <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">G'</span><span class="main">.</span> <span class="bound">G'</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟷</span> <span class="bound">G'</span> <span class="main">∈#</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groups_finite<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span>  mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> mset_set <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_mset_mset_set groups_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">G</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> unique psin
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Collect_cong ging singleton_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_mset<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-index_distinct_group_num_alt_def"><span class="command">lemma</span></span> index_distinct_group_num_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> 
    size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span>  mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gdd_index_options index_zero_implies_one_group numeral_One zero_neq_numeral<span class="main">)</span>

<span class="keyword1" id="Group_Divisible_Designs-index_non_zero_implies_no_group"><span class="command">lemma</span></span> index_non_zero_implies_no_group<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span>  mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span>  <span class="main">¬</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_not_zero_impl_diff_group assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span>  mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_mset_empty_if_finite_and_filter_set_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-gdd_index_non_zero_iff"><span class="command">lemma</span></span> gdd_index_non_zero_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> 
    <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span> <span class="main">⟷</span> size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span>  mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> index_non_zero_implies_no_group index_distinct_group_num_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Group_Divisible_Designs-gdd_index_zero_iff"><span class="command">lemma</span></span> gdd_index_zero_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> 
    <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span>  mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_zero_implies_one_group<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> GDD.gdd_index_options GDD_axioms index_non_zero_implies_no_group old.nat.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Group_Divisible_Designs-points_index_upper_bound"><span class="command">lemma</span></span> points_index_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">≤</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gdd_index_options index_ge_1
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> int_one_le_iff_zero_less le_refl of_nat_0 of_nat_0_le_iff of_nat_le_iff zero_less_imp_eq_int<span class="main">)</span> 

<span class="keyword1" id="Group_Divisible_Designs-index_1_imp_mult_1"><span class="command">lemma</span></span> index_1_imp_mult_1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">bl</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>multiplicity <span class="free">bl</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">bl</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">⊆</span> <span class="free">bl</span> <span class="main">∧</span> card <span class="skolem">ps</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nat_int_comparison<span class="main">(</span>3<span class="main">)</span> obtain_subset_with_card_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="skolem">ps</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m points_index_count_min ps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms index_distinct ps antisym_conv2 not_numeral_less_zero 
      numeral_le_one_iff points_index_ps_nin semiring_norm<span class="main">(</span>69<span class="main">)</span> zero_neq_numeral
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gdd_index_options int_int_eq int_ops<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-simple_if_block_size_gt_2"><span class="command">lemma</span></span> simple_if_block_size_gt_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> card <span class="bound">bl</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"simple_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> index_1_imp_mult_1 assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card.empty not_numeral_le_zero<span class="main">)</span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Sub types of GDD's›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In literature, a GDD is usually defined in a number of different ways, 
including factors such as block size limitations›</span></span>
<span class="keyword1"><span class="command">locale</span></span> K_Λ_GDD <span class="main">=</span> K_block_design <span class="main">+</span> GDD

<span class="keyword1"><span class="command">locale</span></span> k_Λ_GDD <span class="main">=</span> block_design <span class="main">+</span> GDD

<span class="keyword1"><span class="command">sublocale</span></span> k_Λ_GDD <span class="main">⊆</span> K_Λ_GDD <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="keyword1"><span class="free">𝗄</span></span><span class="main">}</span>"</span></span> <span class="quoted"><span class="keyword1"><span class="free">𝒢</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">Λ</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> K_GDD <span class="main">=</span> K_Λ_GDD <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">𝒦</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">𝒢</span></span></span> <span class="quoted"><span class="main">1</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">point_set</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒱</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">block_collection</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℬ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sizes</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒦</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">groups</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒢</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> k_GDD <span class="main">=</span> k_Λ_GDD <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">𝗄</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">𝒢</span></span></span> <span class="quoted"><span class="main">1</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">point_set</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒱</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">block_collection</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℬ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">u_block_size</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝗄</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">groups</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒢</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> k_GDD <span class="main">⊆</span> K_GDD <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="keyword1"><span class="free">𝗄</span></span><span class="main">}</span>"</span></span> <span class="quoted"><span class="keyword1"><span class="free">𝒢</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> K_GDD<span class="main">)</span> multiplicity_1<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> card <span class="free">bl</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span> multiplicity <span class="free">bl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> index_1_imp_mult_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">locale</span></span> RGDD <span class="main">=</span> GDD <span class="main">+</span> resolvable_design

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹GDD and PBD Constructions›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹GDD's are commonly studied alongside PBD's (pairwise balanced designs). Many constructions
have been developed for designs to create a GDD from a PBD and vice versa. In particular, 
Wilsons Construction is a well known construction, which is formalised in this section. It
should be noted that many of the more basic constructions in this section are often stated without
proof/all the necessary assumptions in textbooks/course notes.›</span></span>

<span class="keyword1"><span class="command">context</span></span> GDD
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹GDD Delete Point construction›</span></span>
<span class="keyword1" id="Group_Divisible_Designs-delete_point_index_zero"><span class="command">lemma</span></span> delete_point_index_zero<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">≠</span> <span class="free">y</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>del_point_blocks <span class="free">x</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G'</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="skolem">G'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ss ing group_subset_point_subset<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span>del_point <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">≠</span> <span class="free">x</span>›</span></span> del_point_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> delete_point_index_eq index_together
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> in_mono ing ss<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-delete_point_index"><span class="command">lemma</span></span> delete_point_index<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G1</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G2</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G1</span> <span class="main">≠</span> <span class="free">G2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">G1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="free">G2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"del_point_blocks <span class="free">x</span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ing1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G1'</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G1</span> <span class="main">=</span> <span class="skolem">G1'</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ing2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G2'</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G2</span> <span class="main">=</span> <span class="skolem">G2'</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ss1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G1</span> <span class="main">⊆</span> <span class="skolem">G1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ss2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G2</span> <span class="main">⊆</span> <span class="skolem">G2'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ing1 ing2 ss1 ss2 assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_subsetI insert_absorb insert_subset point_in_group<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span> <span class="main">⊆</span> del_point <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">≠</span> <span class="free">x</span>›</span></span> del_point_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> indx<span class="main">:</span> <span class="quoted"><span class="quoted">"del_point_blocks <span class="free">x</span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> delete_point_index_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G1'</span> <span class="main">≠</span> <span class="skolem">G2'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms t1 t2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> index_distinct
    <span class="keyword1"><span class="command">using</span></span> indx assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> ing1 ing2 t1 t2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-delete_point_group_size"><span class="command">lemma</span></span> delete_point_group_size<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> card <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1"><span class="free">𝒢</span></span> <span class="main">-</span> <span class="main">{</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="bound">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> disjnt_insert1 groups_disjoint pairwise_alt<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> simpg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1"><span class="free">𝒢</span></span> <span class="main">-</span> <span class="main">{</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="bound">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">-</span> <span class="main">{</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">-</span> <span class="main">{</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> simpg 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span> Collect_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span>  <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">-</span> <span class="main">{</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_self_img_compr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="keyword1"><span class="free">𝒢</span></span> <span class="main">-</span> <span class="main">{</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> card <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groups_finite<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True assms eq diff_is_0_eq' <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g'</span> <span class="bound">y</span><span class="main">.</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∉</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="bound">g'</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="bound">g'</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">g'</span> <span class="main">=</span> <span class="bound">y</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_not_in_conv insert_Diff_single insert_absorb insert_iff points_sep_groups_ne<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_onI False<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> card <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inj groups_finite card_image
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_image setcompr_eq_image<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> groups_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-GDD_by_deleting_point"><span class="command">lemma</span></span> GDD_by_deleting_point<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">bl</span> <span class="main">⟹</span> <span class="numeral">2</span> <span class="main">≤</span> card <span class="bound">bl</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> card <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"GDD <span class="main">(</span>del_point <span class="free">x</span><span class="main">)</span> <span class="main">(</span>del_point_blocks <span class="free">x</span><span class="main">)</span> <span class="main">{</span><span class="bound">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≠</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> pd<span class="main">:</span> proper_design <span class="quoted"><span class="quoted">"del_point <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"del_point_blocks <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> delete_point_proper assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> delete_point_index_zero delete_point_index assms delete_point_group_size
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_remove_pt group_partitions index_ge_1 del_point_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> K_GDD <span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹PBD construction from GDD›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Two well known PBD constructions involve taking a GDD and either combining the groups and
blocks to form a new block collection, or by adjoining a point›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First prove that combining the groups and block set results in a constant index›</span></span>
<span class="keyword1" id="Group_Divisible_Designs-kgdd1_points_index_group_block"><span class="command">lemma</span></span> kgdd1_points_index_group_block<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> index1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">G</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> index_distinct_alt_ss assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> groups1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> size <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span>  mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> index_zero_implies_one_group assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> size <span class="main">(</span>filter_mset <span class="main">(</span><span class="main">(⊆)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> index1 groups1 gdd_index_non_zero_iff gdd_index_zero_iff assms 
      gdd_index_options points_index_def filter_union_mset union_commute
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> empty_neutral<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less_irrefl_nat nonempty_has_size of_nat_1_eq_iff<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Combining blocks and the group set forms a PBD›</span></span>
<span class="keyword1" id="Group_Divisible_Designs-combine_block_groups_pairwise"><span class="command">lemma</span></span> combine_block_groups_pairwise<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise_balance <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span><span class="main">)</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="bound">G</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_in_group subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="bound">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> group_partitions
    <span class="keyword1"><span class="command">using</span></span> partition_onD3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> inc<span class="main">:</span> design <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="bound">G</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_set_mset_mset_set groups_finite ss union_iff wellformed<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="bound">G</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_sets<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">bl</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="bound">G</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="bound">bl</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> blocks_nempty groups_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inc.𝖻 <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_positive <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">::</span>int<span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> inc.𝗏"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gdd_min_v<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> int <span class="main">(</span>card <span class="bound">ps</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> int <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span><span class="main">)</span> <span class="keyword1">index</span> <span class="bound">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> kgdd1_points_index_group_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-combine_block_groups_PBD"><span class="command">lemma</span></span> combine_block_groups_PBD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> card <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒦</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒦</span></span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"PBD <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span><span class="main">)</span> <span class="keyword1"><span class="free">𝒦</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> inc<span class="main">:</span> pairwise_balance <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="quoted"><span class="main">1</span></span> <span class="keyword1"><span class="command">using</span></span> combine_block_groups_pairwise <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms block_sizes groups_finite positive_ints 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Prove adjoining a point to each group set results in a constant points index›</span></span>
<span class="keyword1" id="Group_Divisible_Designs-kgdd1_index_adjoin_group_block"><span class="command">lemma</span></span> kgdd1_index_adjoin_group_block<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> insert <span class="free">x</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(</span>insert<span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> inj_onI insert_ident point_in_group<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_set <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span> <span class="main">=</span> <span class="main">{#</span> insert <span class="free">x</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">∈#</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_mset_mset_set setcompr_eq_image<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">ps</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_2_iff doubleton_eq_iff insertE singletonD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ynex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">have</span></span> yinv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> y_ps ynex <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> all_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈#</span> <span class="main">(</span>mset_set <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span>insert <span class="free">x</span> <span class="bound">g</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="bound">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ynex <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True assms<span class="main">(</span>1<span class="main">)</span> points_index_ps_nin <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> 
        <span class="main">(</span>mset_set <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_index_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>mset_set <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">rep</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> points_index_pair_rep_num
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> all_g y_ps<span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span> <span class="main">.</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groups_finite rep_number_on_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> insert <span class="free">x</span> <span class="bound">g</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span> Collect_cong mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">=</span> card <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="bound">g</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">g</span></span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">.</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="bound">g</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 0 empty_iff eq groups_finite ynex insert_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> points_index_block_image_add_eq points_index_single_rep_num rep_number_on_set_def<span class="main">)</span>  
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> rep_number_point_group_one yinv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="keyword1"><span class="free">𝒢</span></span><span class="main">)</span> <span class="keyword1">index</span> <span class="free">ps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_block_image_add_eq False point_index_distrib<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> v assms kgdd1_points_index_group_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-pairwise_by_adjoining_point"><span class="command">lemma</span></span> pairwise_by_adjoining_point<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise_balance <span class="main">(</span>add_point <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="main">{</span> insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span><span class="main">)</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="main">{</span> insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"add_point <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> vdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> add_point_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> add_point_def <span class="keyword1"><span class="command">using</span></span> finite_sets b_positive 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> insert <span class="free">x</span> <span class="bound">G</span> <span class="main">⊆</span> <span class="var">?V</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_in_group subsetI vdef<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈#</span> <span class="main">(</span>mset_set <span class="main">{</span> insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">G</span> <span class="main">⊆</span> <span class="var">?V</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> del_insts<span class="main"><span class="main">)</span></span> elem_mset_set empty_iff infinite_set_mset_mset_set mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∨</span> <span class="bound">b</span> <span class="main">∈#</span> mset_set <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">⊆</span> insert <span class="free">x</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> wellformed add_point_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> insert <span class="free">x</span> <span class="bound">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> group_partitions
      <span class="keyword1"><span class="command">using</span></span> partition_onD3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gnempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈#</span> <span class="main">(</span>mset_set <span class="main">{</span> insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> del_insts<span class="main"><span class="main">)</span></span> elem_mset_set empty_iff infinite_set_mset_mset_set mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∨</span> <span class="bound">bl</span> <span class="main">∈#</span> mset_set <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">bl</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> blocks_nempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gdd_min_v <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="free">x</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> card_insert_le dual_order.trans finite_sets<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> int <span class="main">(</span>card <span class="main">(</span>insert <span class="free">x</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆</span> insert <span class="free">x</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span>
          card <span class="bound">ps</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">index</span> <span class="bound">ps</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> kgdd1_index_adjoin_group_block <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-PBD_by_adjoining_point"><span class="command">lemma</span></span> PBD_by_adjoining_point<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒦</span></span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"PBD <span class="main">(</span>add_point <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="main">{</span> insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="free">𝒦</span></span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span>card <span class="bound">g</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">|</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="main">{</span> insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_point <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> inc<span class="main">:</span> pairwise_balance <span class="var"><span class="quoted"><span class="var">?V</span></span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="quoted"><span class="main">1</span></span> <span class="keyword1"><span class="command">using</span></span> pairwise_by_adjoining_point assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span>  block_sizes positive_ints <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> xg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="bound">g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms point_in_group <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> card <span class="bound">bl</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒦</span></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_sizes<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> mset_set <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">bl</span> <span class="main">∈</span> <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groups_finite<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> mset_set <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span> <span class="main">⟹</span> 
      card <span class="bound">bl</span> <span class="main">∈</span>  <span class="main">{</span>int <span class="main">(</span>card <span class="bound">g</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bl</span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bl</span> <span class="main">∈#</span> mset_set <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bl</span> <span class="main">∈</span> <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groups_finite<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> gin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bl</span> <span class="main">=</span> insert <span class="free">x</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">bl</span> <span class="main">∈</span>  <span class="main">{</span>int <span class="main">(</span>card <span class="bound">g</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gin group_elements_finite i xg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="main">{</span>insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span> <span class="main">⟹</span> 
        int <span class="main">(</span>card <span class="bound">bl</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒦</span></span> <span class="main">∪</span> <span class="main">{</span>int <span class="main">(</span>card <span class="bound">g</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>  UnI1 UnI2 block_sizes union_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> mem_Collect_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒦</span></span> <span class="main">∪</span> <span class="main">{</span>int <span class="main">(</span>card <span class="bound">g</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> min_group_size positive_ints <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span>  <span class="bound">k</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒦</span></span> <span class="main">∪</span> <span class="main">{</span>int <span class="main">(</span>card <span class="bound">g</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span> <span class="main">⟹</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">k</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> min_group_size positive_ints assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Wilson's Construction›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Wilson's construction involves the combination of multiple k-GDD's. This proof was
based of Stinson \cite{stinsonCombinatorialDesignsConstructions2004}›</span></span>

<span class="keyword1" id="Group_Divisible_Designs-wilsons_construction_proper"><span class="command">lemma</span></span> wilsons_construction_proper<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">𝒦'</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">B</span> <span class="main">.</span> <span class="bound">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> K_GDD <span class="main">(</span><span class="bound">B</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">B</span><span class="main">)</span> <span class="free">𝒦'</span> <span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">B</span> <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proper_design <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"proper_design <span class="var">?Y</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈#</span><span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">×</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈#</span><span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="skolem">b</span> <span class="main">∈#</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> kgdd<span class="main">:</span> K_GDD <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">B</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">𝒦'</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">×</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> kgdd.wellformed
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈#</span> <span class="free">f</span> <span class="skolem">B</span>›</span></span> wellformed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_sets assms bot_nat_0.not_eq_extremum card.infinite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">bl</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈#</span><span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">bl</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bl</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈#</span><span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="skolem">bl</span> <span class="main">∈#</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bl</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> kgdd<span class="main">:</span> K_GDD <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">B</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">𝒦'</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bl</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> kgdd.blocks_nempty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bl</span> <span class="main">∈#</span> <span class="free">f</span> <span class="skolem">B</span>›</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">∈#</span><span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> design_blocks_nempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> kgdd<span class="main">:</span> K_GDD <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">B</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">𝒦'</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">B</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> kgdd.design_blocks_nempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">∈#</span><span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-pair_construction_block_sizes"><span class="command">lemma</span></span> pair_construction_block_sizes<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"K_GDD <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">B</span><span class="main">)</span> <span class="free">𝒦'</span> <span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">f</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">b</span> <span class="main">∈</span> <span class="free">𝒦'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> bkgdd<span class="main">:</span> K_GDD <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">𝒦'</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="free">b</span> <span class="main">∈</span> <span class="free">𝒦'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bkgdd.block_sizes <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>assms<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-wilsons_construction_index_0"><span class="command">lemma</span></span> wilsons_construction_index_0<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">B</span> <span class="main">.</span> <span class="bound">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> K_GDD <span class="main">(</span><span class="bound">B</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">B</span><span class="main">)</span> <span class="free">𝒦'</span> <span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">B</span> <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">GG</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">GG</span><span class="main">.</span> <span class="bound">GG</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>image_mset <span class="free">f</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G'</span></span> <span class="keyword2"><span class="keyword">where</span></span> gi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">=</span> <span class="skolem">G'</span> <span class="main">×</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ging<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G'</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ix</span></span> <span class="skolem"><span class="skolem">iy</span></span> <span class="keyword2"><span class="keyword">where</span></span> xpair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">ix</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ypair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">iy</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ixin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ix</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">G'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms gi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> iyin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">iy</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ying<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">G'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms ypair gi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ne_index_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ying xing index_together ging <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">B</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> kgdd<span class="main">:</span> K_GDD <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">B</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">𝒦'</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> not_ss_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">B</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kgdd.points_index_ps_nin<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne_index_0 assm points_index_0_left_imp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> empty_subsetI insert_subset mem_Sigma_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nexy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">B</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_ss_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">B</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">ix</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">ix</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">g</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> kgdd.index_together
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> SigmaD1 SigmaD2 SigmaI assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> gi mem_Collect_eq xpair ypair<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">B</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_ss_0 nexy <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈#</span> <span class="main">(</span>image_mset <span class="free">f</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">B</span> <span class="keyword1">index</span> <span class="main">{</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>image_mset <span class="free">f</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_sum xpair ypair<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-wilsons_construction_index_1"><span class="command">lemma</span></span> wilsons_construction_index_1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">B</span> <span class="main">.</span> <span class="bound">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> K_GDD <span class="main">(</span><span class="bound">B</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">B</span><span class="main">)</span> <span class="free">𝒦'</span> <span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">B</span> <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G1</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">G</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G2</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">G</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G1</span> <span class="main">≠</span> <span class="free">G2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ix</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">iy</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>image_mset <span class="free">f</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span>int<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> gi1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G1</span> <span class="main">=</span> <span class="skolem">G1'</span> <span class="main">×</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ging1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G1'</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> gi2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G2</span> <span class="main">=</span> <span class="skolem">G2'</span> <span class="main">×</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ging2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G2'</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> xing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">G1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms gi1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> ying<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="skolem">G2'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms gi2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> gne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G1'</span> <span class="main">≠</span> <span class="skolem">G2'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms gi1 gi2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> xyne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xing ying ging1 ging2 point_in_one_group <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">bl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_distinct points_index_one_unique_block
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ging1 ging2 gne of_nat_1_eq_iff xing ying<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bl</span></span> <span class="keyword2"><span class="keyword">where</span></span> blinb<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xyblss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">bl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">bl</span><span class="main">#}</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> points_index_one_not_unique_block
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ging1 ging2 gne index_distinct int_ops<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nat_int_comparison<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> xing ying<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">bl</span><span class="main">#}</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="bound">b</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> SigmaD1 empty_subsetI insert_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pi0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">bl</span><span class="main">#}</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">iy</span><span class="main">)</span><span class="main">}</span>  <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">bl</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_diffD<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> kgdd<span class="main">:</span> K_GDD <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">𝒦'</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">b</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm not_ss <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kgdd.points_index_ps_nin<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">bl</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> bkgdd<span class="main">:</span> K_GDD <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">bl</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">bl</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">𝒦'</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms blinb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g1</span></span> <span class="skolem"><span class="skolem">g2</span></span> <span class="keyword2"><span class="keyword">where</span></span> xing1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ix</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">g1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ying2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">iy</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">g2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g1g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g1</span> <span class="main">∈</span> <span class="var">?G</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> g2g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g2</span> <span class="main">∈</span> <span class="var">?G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> gi1 gi2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> bkgdd.point_has_unique_group insert_subset mem_Sigma_iff xyblss<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g1</span> <span class="main">≠</span> <span class="skolem">g2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xyne <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pi1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">bl</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> bkgdd.index_distinct xing1 ying2 g1g g2g <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>image_mset <span class="free">f</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">B</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>image_mset <span class="free">f</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">iy</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈#</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">bl</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">B</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">iy</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">bl</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ix</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">iy</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add.commute blinb insert_DiffM sum_mset.insert<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pi0 pi1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Wilsons_Construction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">𝒦'</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">B</span> <span class="main">.</span> <span class="bound">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> K_GDD <span class="main">(</span><span class="bound">B</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">B</span><span class="main">)</span> <span class="free">𝒦'</span> <span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">B</span> <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"K_GDD <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span> <span class="free">𝒦'</span> <span class="main">{</span><span class="bound">G</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span> <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒱</span></span> <span class="main">×</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?H</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">G</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span> <span class="bound">G</span> <span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="bound">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> pd<span class="main">:</span> proper_design <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="keyword1"><span class="command">using</span></span> wilsons_construction_proper assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> card <span class="bound">bl</span> <span class="main">∈</span> <span class="free">𝒦'</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> assms pair_construction_block_sizes <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> kdes<span class="main">:</span> K_block_design <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="quoted"><span class="free">𝒦'</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span><span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> gdd<span class="main">:</span> GDD <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="var"><span class="quoted"><span class="var">?H</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">::</span> int"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span> <span class="main">{</span><span class="bound">G</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms groups_not_empty design_points_nempty group_partitions
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_cart_prod<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span> <span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span> <span class="keyword1"><span class="free">𝒢</span></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inj_on_def pd.design_points_nempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">G</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span> <span class="main">=</span> card <span class="keyword1"><span class="free">𝒢</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_image <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Setcompr_eq_image<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">G</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> groups_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">::</span>int<span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> gdd_fact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">B</span> <span class="main">.</span> <span class="bound">B</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> K_GDD <span class="main">(</span><span class="bound">B</span> <span class="main">×</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">B</span><span class="main">)</span> <span class="free">𝒦'</span> <span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">B</span> <span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">G</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">GG</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">GG</span><span class="main">.</span> <span class="bound">GG</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">∈</span> <span class="bound">G</span> <span class="main">⟹</span> <span class="bound">Y</span> <span class="main">∈</span> <span class="bound">G</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">≠</span> <span class="bound">Y</span> 
        <span class="main">⟹</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>image_mset <span class="free">f</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wilsons_construction_index_0<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">G1</span> <span class="bound">G2</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="bound">G1</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">G</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">G2</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">G</span> <span class="main">×</span> <span class="free">I</span> <span class="main">|</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span> 
      <span class="main">⟹</span> <span class="bound">G1</span> <span class="main">≠</span> <span class="bound">G2</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">∈</span> <span class="bound">G1</span> <span class="main">⟹</span> <span class="bound">Y</span> <span class="main">∈</span> <span class="bound">G2</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>image_mset <span class="free">f</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span>int<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wilsons_construction_index_1<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> pairwise_balance
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Group_Divisible_Designs-PBD_by_deleting_point"><span class="command">lemma</span></span> PBD_by_deleting_point<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"𝗏 <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> card <span class="bound">bl</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise_balance <span class="main">(</span>del_point <span class="free">x</span><span class="main">)</span> <span class="main">(</span>del_point_blocks <span class="free">x</span><span class="main">)</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> design <span class="quoted"><span class="quoted">"del_point <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"del_point_blocks <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> delete_point_design assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms design_blocks_nempty del_point_def del_point_blocks_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> 𝗏 <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> <span class="numeral">2</span> <span class="main">≤</span> card <span class="bound">bl</span><span class="main">)</span> <span class="main">⟹</span> <span class="numeral">2</span> <span class="main">≤</span> int <span class="main">(</span>card <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_Diff_singleton_if diff_diff_cancel diff_le_mono2 finite_sets less_one
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> int_ops<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_nat_zero_code nat_le_linear verit_comp_simplify1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> zle_int<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ps</span> <span class="main">.</span> <span class="bound">ps</span>  <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟹</span> card <span class="bound">ps</span> <span class="main">=</span> <span class="numeral">2</span>  <span class="main">⟹</span> <span class="main">{#</span><span class="bound">bl</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">#}</span> <span class="keyword1">index</span> <span class="bound">ps</span> <span class="main">=</span> <span class="keyword1"><span class="free">Λ</span></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> delete_point_index_eq del_point_def del_point_blocks_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> del_invalid_point del_invalid_point_blocks pairwise_balance_axioms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> k_GDD
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Group_Divisible_Designs-bibd_from_kGDD"><span class="command">lemma</span></span> bibd_from_kGDD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝗄</span></span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span> <span class="main">⟹</span> card <span class="bound">g</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">" <span class="free">x</span> <span class="main">∉</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bibd <span class="main">(</span>add_point <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="main">{</span> insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="free">𝗄</span></span><span class="main">)</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="keyword1"><span class="free">𝗄</span></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span>card <span class="bound">g</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">|</span> <span class="bound">g</span> <span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1"><span class="free">𝗄</span></span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> pbd<span class="main">:</span> PBD <span class="quoted"><span class="quoted">"<span class="main">(</span>add_point <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="main">+</span> mset_set <span class="main">{</span> insert <span class="free">x</span> <span class="bound">g</span> <span class="main">|</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒢</span></span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="keyword1"><span class="free">𝗄</span></span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> PBD_by_adjoining_point assms sys_block_sizes_obtain_bl add_point_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> Collect_cong sys_block_sizes_uniform uniform_alt_def_all<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms pbd.block_sizes block_size_lt_v finite_sets add_point_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> PBD 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Group_Divisible_Designs-pbd_points_index1"><span class="command">lemma</span></span> pbd_points_index1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> card <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> balanced <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> int_eq_iff_numeral of_nat_1_eq_iff<span class="main">)</span> 

<span class="keyword1" id="Group_Divisible_Designs-pbd_index1_points_imply_unique_block"><span class="command">lemma</span></span> pbd_index1_points_imply_unique_block<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b2</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">≠</span> <span class="free">b2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">b1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">b2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">b2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">y</span> <span class="main">∉</span> <span class="free">b2</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">b2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">b2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈#</span> <span class="var">?ps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b2</span> <span class="main">∈#</span> <span class="var">?ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="var">?ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_noteq_member mset_add mset_subset_eq_add_mset_cancel single_subset_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">#}</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ge2<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="var">?ps</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms ss <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> size_mset_mono<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> pair<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms wellformed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pbd_points_index1 pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> points_index_def ge2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> numeral_le_one_iff semiring_norm<span class="main"><span class="main">(</span></span>69<span class="main"><span class="main">)</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-strong_delete_point_groups_index_zero"><span class="command">lemma</span></span> strong_delete_point_groups_index_zero<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>str_del_point_blocks <span class="free">x</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">xa</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_0_iff str_del_point_blocks_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">∈</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="skolem">b</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">=</span> <span class="skolem">b'</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> a1 a2 a3 a4 assms pbd_index1_points_imply_unique_block
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-strong_delete_point_groups_index_one"><span class="command">lemma</span></span> strong_delete_point_groups_index_one<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G1</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G2</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G1</span> <span class="main">≠</span> <span class="free">G2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">∈</span> <span class="free">G1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">G2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span>str_del_point_blocks <span class="free">x</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">xa</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="keyword2"><span class="keyword">where</span></span> gb1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G1</span> <span class="main">=</span> <span class="skolem">b1</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b1in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xin1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">b1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="keyword2"><span class="keyword">where</span></span> gb2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G2</span> <span class="main">=</span> <span class="skolem">b2</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b2in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xin2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">b2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> bneq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">≠</span> <span class="skolem">b2</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> gb1 gb2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gb1 b1in xin1 gb2 b2in xin2 assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> insert_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> Diff_eq_empty_iff Diff_iff empty_Diff insertCI pbd_index1_points_imply_unique_block<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pair<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="free">xa</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">xa</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gb1 b1in gb2 b2in assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_cancel Diff_subset insert_Diff insert_subset wellformed<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">bl</span><span class="main">#}</span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">xa</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_0_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">∈</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> yxss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">b2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> gb2 xin2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">xa</span><span class="main">,</span> <span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">b1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> gb1 xin1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">∉</span> <span class="skolem">b2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pbd_index1_points_imply_unique_block
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffE assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> b1in b2in bneq gb1 singletonI xin2<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> pbd_index1_points_imply_unique_block
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffD2 yxss a1 a2 a4 assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> b2in gb2 insertI1<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>str_del_point_blocks <span class="free">x</span><span class="main">)</span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">xa</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="main">{</span><span class="free">xa</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> multiset_partition plus_nat.add_0 point_index_distrib str_del_point_blocks_def<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pbd_points_index1 pair inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-blocks_with_x_partition"><span class="command">lemma</span></span> blocks_with_x_partition<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">{</span><span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> partition_onI <span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> gtt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> card <span class="bound">bl</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> block_size_gt_t
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_sizes nat_int_comparison<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> ptx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xinb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ge2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">b</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gtt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_int_comparison<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card.infinite not_numeral_le_zero<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">p</span> <span class="main">=</span> card <span class="skolem">b</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xinb ptx <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">p</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ge2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">{</span><span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span> <span class="main">=</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subset_antisym subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">{</span><span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf_invalid_point <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pair<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">xa</span><span class="main">,</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">xa</span><span class="main">,</span> <span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> design_support <span class="main">.</span> <span class="main">{</span><span class="skolem">xa</span><span class="main">,</span> <span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> balanced points_index_simple_def pbd_points_index1 assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pair<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> des<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> design_support"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">xa</span><span class="main">,</span> <span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> card_1_singletonE mem_Collect_eq singletonI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">{</span><span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> des ss nex design_support_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span> <span class="main">⟹</span> 
    <span class="bound">p</span> <span class="main">≠</span> <span class="bound">p'</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">∩</span> <span class="bound">p'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">p'</span>
    <span class="keyword3"><span class="command">assume</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> pne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">p'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b1in<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xinb1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> b2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="skolem">b'</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b2in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xinb2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">b'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pne b1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">b</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∉</span> <span class="skolem">b'</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> b1in b2in xinb1 xinb2 pbd_index1_points_imply_unique_block
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> empty_subsetI insert_subset<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">p</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∉</span> <span class="skolem">p'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff b1 b2 insertI1<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∩</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> disjoint_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-KGDD_by_deleting_point"><span class="command">lemma</span></span> KGDD_by_deleting_point<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">&lt;</span> 𝖻"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"K_GDD <span class="main">(</span>del_point <span class="free">x</span><span class="main">)</span> <span class="main">(</span>str_del_point_blocks <span class="free">x</span><span class="main">)</span> <span class="keyword1"><span class="free">𝒦</span></span> <span class="main">{</span> <span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span><span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> card <span class="bound">bl</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> block_size_gt_t 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_sizes nat_int_comparison<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> proper_design <span class="quoted"><span class="quoted">"<span class="main">(</span>del_point <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>str_del_point_blocks <span class="free">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> strong_delete_point_proper assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> blocks_with_x_partition strong_delete_point_groups_index_zero 
      strong_delete_point_groups_index_one str_del_point_blocks_def del_point_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_sizes positive_ints assms<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> ge1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> replication_num_simple_def design_support_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">{</span><span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> inj_on_def mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> card_image fin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj card_image setcompr_eq_image<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ge1
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Group_Divisible_Designs-card_singletons_eq"><span class="command">lemma</span></span> card_singletons_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">|</span> <span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span> <span class="main">=</span> card <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_image Setcompr_eq_image<span class="main">)</span>

<span class="keyword1" id="Group_Divisible_Designs-KGDD_from_PBD"><span class="command">lemma</span></span> KGDD_from_PBD<span class="main">:</span> <span class="quoted"><span class="quoted">"K_GDD <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1"><span class="free">𝒦</span></span> <span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Setcompr_eq_image partition_on_singletons<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t_lt_order card_singletons_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Collect_mem_eq nat_leq_as_int of_nat_numeral setcompr_eq_image<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xa</span> <span class="bound">xb</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="bound">xb</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="main">{</span><span class="bound">xa</span><span class="main">,</span> <span class="bound">xb</span><span class="main">}</span> <span class="main">≠</span> Suc <span class="main">0</span> <span class="main">⟹</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">xb</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> <span class="skolem">xb</span>
    <span class="keyword3"><span class="command">assume</span></span> ain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xb</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ne1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="main">{</span><span class="skolem">xa</span><span class="main">,</span> <span class="skolem">xb</span><span class="main">}</span> <span class="main">≠</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">≠</span> <span class="skolem">xb</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">xa</span><span class="main">,</span> <span class="skolem">xb</span><span class="main">}</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">index</span> <span class="main">{</span><span class="skolem">xa</span><span class="main">,</span> <span class="skolem">xb</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ain bin pbd_points_index1<span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> ne1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> bibd
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Group_Divisible_Designs-kGDD_from_bibd"><span class="command">lemma</span></span> kGDD_from_bibd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Λ</span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1"><span class="free">𝒱</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"k_GDD <span class="main">(</span>del_point <span class="free">x</span><span class="main">)</span> <span class="main">(</span>str_del_point_blocks <span class="free">x</span><span class="main">)</span> <span class="keyword1"><span class="free">𝗄</span></span> <span class="main">{</span> <span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> pbd<span class="main">:</span> PBD <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="keyword1"><span class="free">𝗄</span></span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">using</span></span> PBD.intro Λ_PBD_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">&lt;</span> 𝖻"</span></span> <span class="keyword1"><span class="command">using</span></span> block_num_gt_rep
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r_ge_two assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> kgdd<span class="main">:</span> K_GDD <span class="quoted"><span class="quoted">"<span class="main">(</span>del_point <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"str_del_point_blocks <span class="free">x</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="keyword1"><span class="free">𝗄</span></span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">b</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pbd.KGDD_by_deleting_point lt assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> del_point_def str_del_point_blocks_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Designs_And_Graphs">
<div class="head">
<h1>Theory Designs_And_Graphs</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Designs_And_Graphs.thy
   Author: Chelsea Edmonds 
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Graphs and Designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There are many links between graphs and design - most fundamentally that graphs are designs›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Designs_And_Graphs <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Block_Designs">Block_Designs</a> <a href="../../graph_theory/theories/#Digraph">Graph_Theory.Digraph</a> <a href="../../graph_theory/theories/#Digraph_Component">Graph_Theory.Digraph_Component</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Non-empty digraphs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First, we define the concept of a non-empty digraph. This mirrors the idea of a "proper design"
in the design theory library›</span></span>
<span class="keyword1"><span class="command">locale</span></span> non_empty_digraph <span class="main">=</span> wf_digraph <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> arcs_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"arcs <span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1" id="Designs_And_Graphs-verts_not_empty"><span class="command">lemma</span></span> verts_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"verts <span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf arcs_not_empty head_in_verts <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Arcs to Blocks›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A digraph uses a pair of points to define an ordered edge. In the case of simple graphs, 
both possible orderings will be in the arcs set. Blocks are inherently unordered, and as such 
a method is required to convert between the two representations›</span></span>
<span class="keyword1"><span class="command">context</span></span> graph
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">arc_to_block</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arc_to_block</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="main">{</span>tail <span class="free">G</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> head <span class="free">G</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Designs_And_Graphs-arc_to_block_to_ends"><span class="command">lemma</span></span> arc_to_block_to_ends<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>fst <span class="main">(</span>arc_to_ends <span class="free">G</span> <span class="free">e</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>arc_to_ends <span class="free">G</span> <span class="free">e</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> arc_to_block <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arc_to_ends_def arc_to_block_def<span class="main">)</span>

<span class="keyword1" id="Designs_And_Graphs-arc_to_block_to_ends_swap"><span class="command">lemma</span></span> arc_to_block_to_ends_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>snd <span class="main">(</span>arc_to_ends <span class="free">G</span> <span class="free">e</span><span class="main">)</span><span class="main">,</span> fst <span class="main">(</span>arc_to_ends <span class="free">G</span> <span class="free">e</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> arc_to_block <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arc_to_block_to_ends
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arc_to_block_to_ends insert_commute<span class="main">)</span> 

<span class="keyword1" id="Designs_And_Graphs-arc_to_ends_to_block"><span class="command">lemma</span></span> arc_to_ends_to_block<span class="main">:</span> <span class="quoted"><span class="quoted">"arc_to_block <span class="free">e</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">⟹</span> 
  arc_to_ends <span class="free">G</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∨</span> arc_to_ends <span class="free">G</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arc_to_block_def arc_to_ends_def doubleton_eq_iff<span class="main">)</span>

<span class="keyword1" id="Designs_And_Graphs-arc_to_block_sym"><span class="command">lemma</span></span> arc_to_block_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"arc_to_ends <span class="free">G</span> <span class="free">e1</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> arc_to_ends <span class="free">G</span> <span class="free">e2</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">⟹</span> 
  arc_to_block <span class="free">e1</span> <span class="main">=</span> arc_to_block <span class="free">e2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arc_to_block_def arc_to_ends_def insert_commute<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">arcs_blocks</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arcs_blocks</span> <span class="main">≡</span> mset_set <span class="main">(</span>arc_to_block <span class="main">`</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Designs_And_Graphs-arcs_blocks_ends"><span class="command">lemma</span></span>  arcs_blocks_ends<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> arcs_ends <span class="free">G</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">∈#</span> arcs_blocks"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arcs_ends_def arcs_blocks_def <span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span>
  <span class="keyword3"><span class="command">assume</span></span> assm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> arc_to_ends <span class="free">G</span> <span class="skolem">xa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> assm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> zin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">(</span>arc_to_block <span class="main">`</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> arc_to_block <span class="skolem">xa</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assm2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">∈</span> arc_to_block <span class="main">`</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assm1 arc_to_block_to_ends
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv snd_conv<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Designs_And_Graphs-arc_ends_blocks_subset"><span class="command">lemma</span></span> arc_ends_blocks_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">⊆</span> arcs <span class="free">G</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span>arc_to_ends <span class="free">G</span><span class="main">)</span> <span class="main">`</span> <span class="free">E</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">∈</span> <span class="main">(</span>arc_to_block <span class="main">`</span> <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arc_to_ends_def arc_to_block_def <span class="main">)</span>

<span class="keyword1" id="Designs_And_Graphs-arc_blocks_end_subset"><span class="command">lemma</span></span> arc_blocks_end_subset<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">⊆</span> arcs <span class="free">G</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">∈</span> <span class="main">(</span>arc_to_block <span class="main">`</span> <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span>arc_to_ends <span class="free">G</span><span class="main">)</span> <span class="main">`</span> <span class="free">E</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span>arc_to_ends <span class="free">G</span><span class="main">)</span> <span class="main">`</span> <span class="free">E</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"arc_to_block <span class="skolem">e</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arc_to_ends <span class="free">G</span> <span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∨</span> arc_to_ends <span class="free">G</span> <span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> arc_to_ends_to_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">∈</span> <span class="free">E</span>›</span></span> image_iff<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Designs_And_Graphs-arcs_ends_blocks"><span class="command">lemma</span></span> arcs_ends_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">∈#</span> arcs_blocks <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> arcs_ends <span class="free">G</span> <span class="main">∧</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> arcs_ends <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arcs_ends_def arcs_blocks_def <span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span>
  <span class="keyword3"><span class="command">assume</span></span> assm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> arc_to_block  <span class="skolem">xa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> assm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> zin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">(</span>arc_to_ends <span class="free">G</span> <span class="main">`</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> arc_to_ends <span class="free">G</span> <span class="skolem">xa</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assm2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> arc_to_block_to_ends assm1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arc_to_ends_def doubleton_eq_iff fst_conv snd_conv<span class="main">)</span> <span class="comment1">(* Slow *)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> arc_to_ends <span class="free">G</span> <span class="main">`</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assm2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arcs_ends_def arcs_ends_symmetric sym_arcs zin<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span>
  <span class="keyword3"><span class="command">assume</span></span> assm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> arc_to_block  <span class="skolem">xa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> assm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> arc_to_ends <span class="free">G</span> <span class="main">`</span> arcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> arcs_ends_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> arc_blocks_end_subset graph_symmetric image_iff subset_refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Designs_And_Graphs-arcs_blocks_iff"><span class="command">lemma</span></span> arcs_blocks_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">∈#</span> arcs_blocks <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> arcs_ends <span class="free">G</span> <span class="main">∧</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> arcs_ends <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arcs_ends_blocks arcs_blocks_ends <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="Designs_And_Graphs-arcs_ends_wf"><span class="command">lemma</span></span> arcs_ends_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> arcs_ends <span class="free">G</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Designs_And_Graphs-arcs_blocks_elem"><span class="command">lemma</span></span> arcs_blocks_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> arcs_blocks <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">.</span> <span class="free">bl</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arcs_blocks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> arc_to_block_def<span class="main">)</span>

<span class="keyword1" id="Designs_And_Graphs-arcs_ends_blocks_wf"><span class="command">lemma</span></span> arcs_ends_blocks_wf<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> arcs_blocks"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">⊆</span> verts <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> blpair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> arcs_blocks_elem assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> arcs_ends <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> arcs_ends_blocks assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> arcs_ends_wf blpair <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Designs_And_Graphs-arcs_blocks_simple"><span class="command">lemma</span></span> arcs_blocks_simple<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> arcs_blocks <span class="main">⟹</span> count <span class="main">(</span>arcs_blocks<span class="main">)</span> <span class="free">bl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arcs_blocks_def<span class="main">)</span>

<span class="keyword1" id="Designs_And_Graphs-arcs_blocks_ne"><span class="command">lemma</span></span> arcs_blocks_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"arcs <span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> arcs_blocks <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arcs_blocks_iff arcs_blocks_def mset_set_empty_iff<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Graphs are designs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Prove that a graph is a number of different types of designs›</span></span>
<span class="keyword1"><span class="command">sublocale</span></span> graph <span class="main">⊆</span> design <span class="quoted"><span class="quoted">"verts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"arcs_blocks"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arcs_ends_blocks_wf arcs_blocks_elem <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> graph <span class="main">⊆</span> simple_design <span class="quoted"><span class="quoted">"verts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"arcs_blocks"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arcs_ends_blocks_wf arcs_blocks_elem arcs_blocks_simple <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> non_empty_graph <span class="main">=</span> graph <span class="main">+</span> non_empty_digraph

<span class="keyword1"><span class="command">sublocale</span></span> non_empty_graph <span class="main">⊆</span> proper_design <span class="quoted"><span class="quoted">"verts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"arcs_blocks"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arcs_blocks_ne arcs_not_empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> graph_block_size<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> arcs_blocks"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">bl</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> blrep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms arcs_blocks_elem
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> arcs_ends <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> arcs_ends_blocks assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> no_loops <span class="keyword1"><span class="command">using</span></span> adj_not_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> blrep <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> non_empty_graph <span class="main">⊆</span> block_design <span class="quoted"><span class="quoted">"verts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"arcs_blocks"</span></span> <span class="quoted"><span class="numeral">2</span></span>
  <span class="keyword1"><span class="command">using</span></span> arcs_not_empty graph_block_size arcs_blocks_ne <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹R-regular graphs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹To reason on r-regular graphs and their link to designs, we require a number of extensions to 
lemmas reasoning around the degrees of vertices›</span></span>
<span class="keyword1"><span class="command">context</span></span> sym_digraph
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Designs_And_Graphs-in_out_arcs_reflexive"><span class="command">lemma</span></span> in_out_arcs_reflexive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">e</span> <span class="main">∈</span> <span class="main">(</span>in_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> 
    <span class="main">∃</span> <span class="bound">e'</span> <span class="main">.</span> <span class="main">(</span><span class="bound">e'</span> <span class="main">∈</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span> <span class="main">∧</span> head <span class="free">G</span> <span class="bound">e'</span> <span class="main">=</span> tail <span class="free">G</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> symmetric_conv sym_arcs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="Designs_And_Graphs-out_in_arcs_reflexive"><span class="command">lemma</span></span> out_in_arcs_reflexive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">e</span> <span class="main">∈</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> 
    <span class="main">∃</span> <span class="bound">e'</span> <span class="main">.</span> <span class="main">(</span><span class="bound">e'</span> <span class="main">∈</span> <span class="main">(</span>in_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span> <span class="main">∧</span> tail <span class="free">G</span> <span class="bound">e'</span> <span class="main">=</span> head <span class="free">G</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> symmetric_conv sym_arcs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> nomulti_digraph
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Designs_And_Graphs-in_arcs_single_per_vert"><span class="command">lemma</span></span> in_arcs_single_per_vert<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">∈</span> in_arcs <span class="free">G</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">" <span class="free">e2</span> <span class="main">∈</span> in_arcs <span class="free">G</span> <span class="free">v</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">e1</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="free">e2</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> in_arcs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> in_arcs2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arc_to_ends <span class="free">G</span> <span class="free">e1</span> <span class="main">=</span> arc_to_ends <span class="free">G</span> <span class="free">e2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms arc_to_ends_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_in_arcs_conv<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> in_arcs1 in_arcs2 no_multi_arcs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Designs_And_Graphs-out_arcs_single_per_vert"><span class="command">lemma</span></span> out_arcs_single_per_vert<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">∈</span> out_arcs <span class="free">G</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">" <span class="free">e2</span> <span class="main">∈</span> out_arcs <span class="free">G</span> <span class="free">v</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">e1</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="free">e2</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> in_arcs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> in_arcs2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arc_to_ends <span class="free">G</span> <span class="free">e1</span> <span class="main">=</span> arc_to_ends <span class="free">G</span> <span class="free">e2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms arc_to_ends_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_out_arcs_conv<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> in_arcs1 in_arcs2 no_multi_arcs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some helpers on the transformation arc definition›</span></span>
<span class="keyword1"><span class="command">context</span></span> graph
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Designs_And_Graphs-arc_to_block_is_inj_in_arcs"><span class="command">lemma</span></span> arc_to_block_is_inj_in_arcs<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on arc_to_block <span class="main">(</span>in_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arc_to_block_def inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arc_to_ends_def doubleton_eq_iff no_multi_arcs<span class="main">)</span>

<span class="keyword1" id="Designs_And_Graphs-arc_to_block_is_inj_out_arcs"><span class="command">lemma</span></span> arc_to_block_is_inj_out_arcs<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on arc_to_block <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arc_to_block_def inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arc_to_ends_def doubleton_eq_iff no_multi_arcs<span class="main">)</span>

<span class="keyword1" id="Designs_And_Graphs-in_out_arcs_reflexive_uniq"><span class="command">lemma</span></span> in_out_arcs_reflexive_uniq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">e</span> <span class="main">∈</span> <span class="main">(</span>in_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> 
    <span class="main">∃!</span> <span class="bound">e'</span> <span class="main">.</span> <span class="main">(</span><span class="bound">e'</span> <span class="main">∈</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span> <span class="main">∧</span> head <span class="free">G</span> <span class="bound">e'</span> <span class="main">=</span> tail <span class="free">G</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> symmetric_conv <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">using</span></span> out_arcs_single_per_vert <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> head_in_verts in_out_arcs_conv<span class="main">)</span> 

<span class="keyword1" id="Designs_And_Graphs-out_in_arcs_reflexive_uniq"><span class="command">lemma</span></span> out_in_arcs_reflexive_uniq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">∈</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> 
    <span class="main">∃!</span> <span class="bound">e'</span> <span class="main">.</span> <span class="main">(</span><span class="bound">e'</span> <span class="main">∈</span> <span class="main">(</span>in_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span> <span class="main">∧</span> tail <span class="free">G</span> <span class="bound">e'</span> <span class="main">=</span> head <span class="free">G</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> symmetric_conv <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">using</span></span> in_arcs_single_per_vert <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tail_in_verts in_in_arcs_conv<span class="main">)</span> 

<span class="keyword1" id="Designs_And_Graphs-in_eq_out_arc_ends"><span class="command">lemma</span></span> in_eq_out_arc_ends<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span>arc_to_ends <span class="free">G</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>in_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> 
    <span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span>arc_to_ends <span class="free">G</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arc_to_ends_def in_in_arcs_conv in_out_arcs_conv
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> Pair_inject adj_in_verts<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dominatesI image_iff out_in_arcs_reflexive_uniq<span class="main">)</span>

<span class="keyword1" id="Designs_And_Graphs-in_degree_eq_card_arc_ends"><span class="command">lemma</span></span> in_degree_eq_card_arc_ends<span class="main">:</span> <span class="quoted"><span class="quoted">"in_degree <span class="free">G</span> <span class="free">v</span> <span class="main">=</span> card <span class="main">(</span><span class="main">(</span>arc_to_ends <span class="free">G</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>in_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_degree_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span>  no_multi_arcs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_image in_arcs_in_arcs inj_onI<span class="main">)</span>

<span class="keyword1" id="Designs_And_Graphs-in_degree_eq_card_arc_blocks"><span class="command">lemma</span></span> in_degree_eq_card_arc_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"in_degree <span class="free">G</span> <span class="free">v</span> <span class="main">=</span> card <span class="main">(</span>arc_to_block <span class="main">`</span> <span class="main">(</span>in_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_degree_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> no_multi_arcs arc_to_block_is_inj_in_arcs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span>

<span class="keyword1" id="Designs_And_Graphs-out_degree_eq_card_arc_blocks"><span class="command">lemma</span></span> out_degree_eq_card_arc_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"out_degree <span class="free">G</span> <span class="free">v</span> <span class="main">=</span> card <span class="main">(</span>arc_to_block <span class="main">`</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> out_degree_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> no_multi_arcs arc_to_block_is_inj_out_arcs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span> 

<span class="keyword1" id="Designs_And_Graphs-out_degree_eq_card_arc_ends"><span class="command">lemma</span></span> out_degree_eq_card_arc_ends<span class="main">:</span> <span class="quoted"><span class="quoted">"out_degree <span class="free">G</span> <span class="free">v</span> <span class="main">=</span> card <span class="main">(</span><span class="main">(</span>arc_to_ends <span class="free">G</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> out_degree_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> no_multi_arcs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_image out_arcs_in_arcs inj_onI<span class="main">)</span>

<span class="keyword1" id="Designs_And_Graphs-bij_betw_in_out_arcs"><span class="command">lemma</span></span> bij_betw_in_out_arcs<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>arc_to_ends <span class="free">G</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>in_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span><span class="main">(</span>arc_to_ends <span class="free">G</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betw_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap_inj_on<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject arc_to_ends_def image_eqI in_eq_out_arc_ends in_in_arcs_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arc_to_ends_def imageI in_eq_out_arc_ends in_out_arcs_conv pair_imageI<span class="main">)</span>

<span class="keyword1" id="Designs_And_Graphs-in_eq_out_degree"><span class="command">lemma</span></span> in_eq_out_degree<span class="main">:</span> <span class="quoted"><span class="quoted">"in_degree <span class="free">G</span> <span class="free">v</span> <span class="main">=</span> out_degree <span class="free">G</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij_betw_in_out_arcs bij_betw_same_card in_degree_eq_card_arc_ends 
    out_degree_eq_card_arc_ends <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Designs_And_Graphs-in_out_arcs_blocks"><span class="command">lemma</span></span> in_out_arcs_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"arc_to_block <span class="main">`</span> <span class="main">(</span>in_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> arc_to_block <span class="main">`</span> <span class="main">(</span>out_arcs <span class="free">G</span> <span class="free">v</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> 
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> head <span class="free">G</span> <span class="skolem">xa</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> in_arcs <span class="free">G</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> out<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> out_arcs <span class="free">G</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"head <span class="free">G</span> <span class="skolem">e</span> <span class="main">=</span> tail <span class="free">G</span> <span class="skolem">xa</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> out_in_arcs_reflexive_uniq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arc_to_ends <span class="free">G</span> <span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span> tail <span class="free">G</span> <span class="skolem">xa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arc_to_ends_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arc_to_block <span class="skolem">xa</span> <span class="main">=</span> arc_to_block <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> arc_to_block_sym <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a2 arc_to_ends_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"arc_to_block <span class="skolem">xa</span> <span class="main">∈</span> arc_to_block <span class="main">`</span> out_arcs <span class="free">G</span> <span class="main">(</span>head <span class="free">G</span> <span class="skolem">xa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> out a2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> 
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> arcs <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> tail <span class="free">G</span> <span class="skolem">xa</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> out_arcs <span class="free">G</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> ina<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> in_arcs <span class="free">G</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"tail <span class="free">G</span> <span class="skolem">e</span> <span class="main">=</span> head <span class="free">G</span> <span class="skolem">xa</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> out_in_arcs_reflexive_uniq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arc_to_ends <span class="free">G</span> <span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span>head <span class="free">G</span> <span class="skolem">xa</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arc_to_ends_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arc_to_block <span class="skolem">xa</span> <span class="main">=</span> arc_to_block <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> arc_to_block_sym <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a2 arc_to_ends_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"arc_to_block <span class="skolem">xa</span> <span class="main">∈</span> arc_to_block <span class="main">`</span> in_arcs <span class="free">G</span> <span class="main">(</span>tail <span class="free">G</span> <span class="skolem">xa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ina a2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A regular digraph is defined as one where the in degree equals the out degree which in turn 
equals some fixed integer $\mathrm{r}$›</span></span>
<span class="keyword1"><span class="command">locale</span></span> regular_digraph <span class="main">=</span> wf_digraph <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">𝗋</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> in_deg_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">⟹</span> in_degree <span class="free">G</span> <span class="free">v</span> <span class="main">=</span> <span class="free">𝗋</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> out_deg_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">⟹</span> out_degree <span class="free">G</span> <span class="free">v</span> <span class="main">=</span> <span class="free">𝗋</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> regular_graph <span class="main">=</span> graph <span class="main">+</span> regular_digraph
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Designs_And_Graphs-rep_vertices_in_blocks"><span class="command">lemma</span></span> rep_vertices_in_blocks <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">e</span> <span class="main">∈#</span> arcs_blocks <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">e</span> <span class="main">#}</span> <span class="main">=</span> <span class="free">𝗋</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">e</span> <span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> <span class="main">(</span>arc_to_block <span class="main">`</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">e</span> <span class="main">⟹</span> <span class="bound">e</span> <span class="main">∈</span> <span class="main">(</span>arc_to_block <span class="main">`</span> in_arcs <span class="free">G</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> arc_to_block_def in_in_arcs_conv insert_commute insert_iff singleton_iff sym_arcs 
      symmetric_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> <span class="main">(</span>arc_to_block <span class="main">`</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">e</span><span class="main">}</span> <span class="main">=</span>  <span class="main">(</span>arc_to_block <span class="main">`</span> <span class="main">(</span>in_arcs <span class="free">G</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> arc_to_block_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span> <span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> <span class="main">(</span>arc_to_block <span class="main">`</span> <span class="main">(</span>arcs <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">e</span><span class="main">}</span> <span class="main">=</span> <span class="free">𝗋</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> in_deg_r in_degree_eq_card_arc_blocks assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> arcs_blocks_def finite_arcs <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intro rules for regular graphs›</span></span>
<span class="keyword1" id="Designs_And_Graphs-graph_in_degree_r_imp_reg"><span class="command">lemma</span></span> graph_in_degree_r_imp_reg<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"graph <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">v</span> <span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="main">(</span>verts <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> in_degree <span class="free">G</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">𝗋</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular_graph <span class="free">G</span> <span class="free">𝗋</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> g<span class="main">:</span> graph <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">interpret</span></span> wf<span class="main">:</span> wf_digraph <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g.wf_digraph_axioms<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> g.in_eq_out_degree <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Designs_And_Graphs-graph_out_degree_r_imp_reg"><span class="command">lemma</span></span> graph_out_degree_r_imp_reg<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"graph <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">v</span> <span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="main">(</span>verts <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> out_degree <span class="free">G</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">𝗋</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular_graph <span class="free">G</span> <span class="free">𝗋</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> g<span class="main">:</span> graph <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">interpret</span></span> wf<span class="main">:</span> wf_digraph <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g.wf_digraph_axioms<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> g.in_eq_out_degree <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Regular graphs (non-empty) can be shown to be a constant rep design›</span></span>
<span class="keyword1"><span class="command">locale</span></span> non_empty_regular_graph <span class="main">=</span> regular_graph <span class="main">+</span> non_empty_digraph

<span class="keyword1"><span class="command">sublocale</span></span> non_empty_regular_graph <span class="main">⊆</span> non_empty_graph
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">sublocale</span></span> non_empty_regular_graph <span class="main">⊆</span> constant_rep_design <span class="quoted"><span class="quoted">"verts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"arcs_blocks"</span></span> <span class="quoted"><span class="free">𝗋</span></span>
  <span class="keyword1"><span class="command">using</span></span> arcs_blocks_ne arcs_not_empty
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Sub_Designs">
<div class="head">
<h1>Theory Sub_Designs</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Sub_Designs.thy 
   Author: Chelsea Edmonds
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Sub-designs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sub designs are a relationship between two designs using the subset and submultiset relations
This theory defines the concept at the incidence system level, before extending to defining on 
well defined designs›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sub_Designs <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Design_Operations">Design_Operations</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sub-system and Sub-design Locales›</span></span>
<span class="keyword1"><span class="command">locale</span></span> sub_set_system <span class="main">=</span> incidence_system <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="quoted">"<span class="free">𝒰</span>"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"<span class="free">𝒜</span>"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"<span class="free">𝒱</span>"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"<span class="free">ℬ</span>"</span> <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> points_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒰</span> <span class="main">⊆</span> <span class="free">𝒱</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> blocks_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒜</span> <span class="main">⊆#</span> <span class="free">ℬ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Sub_Designs-sub_points"><span class="command">lemma</span></span> sub_points<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">𝒰</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">𝒱</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> points_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Sub_Designs-sub_blocks"><span class="command">lemma</span></span> sub_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="free">𝒜</span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">∈#</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> blocks_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Sub_Designs-sub_blocks_count"><span class="command">lemma</span></span> sub_blocks_count<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="free">𝒜</span> <span class="free">b</span> <span class="main">≤</span> count <span class="free">ℬ</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_subset_eq_count blocks_subset<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> sub_incidence_system <span class="main">=</span> sub_set_system <span class="main">+</span> ins<span class="main">:</span> incidence_system <span class="quoted"><span class="free">𝒰</span></span> <span class="quoted"><span class="free">𝒜</span></span>

<span class="keyword1"><span class="command">locale</span></span> sub_design <span class="main">=</span> sub_incidence_system <span class="main">+</span> des<span class="main">:</span> design <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1" id="Sub_Designs-sub_non_empty_blocks"><span class="command">lemma</span></span> sub_non_empty_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="free">𝒜</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> des.blocks_nempty sub_blocks <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1"><span class="command">sublocale</span></span> sub_des<span class="main">:</span> design <span class="quoted"><span class="free">𝒰</span></span> <span class="quoted"><span class="free">𝒜</span></span>
  <span class="keyword1"><span class="command">using</span></span> des.finite_sets finite_subset points_subset sub_non_empty_blocks 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> proper_sub_set_system <span class="main">=</span> incidence_system <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="quoted">"<span class="free">𝒰</span>"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"<span class="free">𝒜</span>"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"<span class="free">𝒱</span>"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"<span class="free">ℬ</span>"</span> <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> points_psubset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒰</span> <span class="main">⊂</span> <span class="free">𝒱</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> blocks_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒜</span> <span class="main">⊆#</span> <span class="free">ℬ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Sub_Designs-point_sets_ne"><span class="command">lemma</span></span> point_sets_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒰</span> <span class="main">≠</span> <span class="free">𝒱</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> points_psubset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> proper_sub_set_system <span class="main">⊆</span> sub_set_system 
  <span class="keyword1"><span class="command">using</span></span> points_psubset blocks_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">context</span></span> sub_set_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Sub_Designs-sub_is_proper"><span class="command">lemma</span></span> sub_is_proper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒰</span> <span class="main">≠</span> <span class="free">𝒱</span> <span class="main">⟹</span> proper_sub_set_system <span class="free">𝒰</span> <span class="free">𝒜</span> <span class="free">𝒱</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> blocks_subset incidence_system_axioms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_subset proper_sub_set_system.intro proper_sub_set_system_axioms_def psubsetI<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> proper_sub_incidence_system <span class="main">=</span> proper_sub_set_system <span class="main">+</span> ins<span class="main">:</span> incidence_system <span class="quoted"><span class="free">𝒰</span></span> <span class="quoted"><span class="free">𝒜</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> proper_sub_incidence_system <span class="main">⊆</span> sub_incidence_system 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> sub_incidence_system
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Sub_Designs-sub_is_proper"><span class="command">lemma</span></span> sub_is_proper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒰</span> <span class="main">≠</span> <span class="free">𝒱</span> <span class="main">⟹</span> proper_sub_incidence_system <span class="free">𝒰</span> <span class="free">𝒜</span> <span class="free">𝒱</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins.incidence_system_axioms proper_sub_incidence_system_def sub_is_proper<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> proper_sub_design <span class="main">=</span> proper_sub_incidence_system <span class="main">+</span> des<span class="main">:</span> design <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> proper_sub_design <span class="main">⊆</span> sub_design
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> sub_design
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Sub_Designs-sub_is_proper"><span class="command">lemma</span></span> sub_is_proper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒰</span> <span class="main">≠</span> <span class="free">𝒱</span> <span class="main">⟹</span> proper_sub_design <span class="free">𝒰</span> <span class="free">𝒜</span> <span class="free">𝒱</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> des.wf_design proper_sub_design.intro sub_is_proper<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Sub_Designs-ss_proper_implies_sub"><span class="command">lemma</span></span> ss_proper_implies_sub <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"proper_sub_set_system <span class="free">𝒰</span> <span class="free">𝒜</span> <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="main">⟹</span> sub_set_system <span class="free">𝒰</span> <span class="free">𝒜</span> <span class="free">𝒱</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proper_sub_set_system.axioms<span class="main">(</span>1<span class="main">)</span> proper_sub_set_system.blocks_subset psubsetE
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> proper_sub_set_system.points_psubset sub_set_system.intro sub_set_system_axioms_def<span class="main">)</span>

<span class="keyword1" id="Sub_Designs-sub_ssI"><span class="command">lemma</span></span> sub_ssI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"incidence_system <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="main">⟹</span> <span class="free">𝒰</span> <span class="main">⊆</span> <span class="free">𝒱</span> <span class="main">⟹</span> <span class="free">𝒜</span> <span class="main">⊆#</span> <span class="free">ℬ</span> <span class="main">⟹</span> sub_set_system <span class="free">𝒰</span> <span class="free">𝒜</span> <span class="free">𝒱</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> incidence_system_def subset_iff 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incidence_system.wellformed<span class="main">)</span>

<span class="keyword1" id="Sub_Designs-sub_ss_equality"><span class="command">lemma</span></span> sub_ss_equality<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sub_set_system <span class="free">𝒰</span> <span class="free">𝒜</span> <span class="free">𝒱</span> <span class="free">ℬ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sub_set_system <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="free">𝒰</span> <span class="free">𝒜</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒰</span> <span class="main">=</span> <span class="free">𝒱</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒜</span> <span class="main">=</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> sub_set_system.points_subset <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sub_set_system.blocks_subset subset_mset.eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reasoning on Sub-designs›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Reasoning on Incidence Sys property relationships›</span></span>

<span class="keyword1"><span class="command">context</span></span> sub_incidence_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Sub_Designs-sub_sys_block_sizes"><span class="command">lemma</span></span> sub_sys_block_sizes<span class="main">:</span> <span class="quoted"><span class="quoted">"ins.sys_block_sizes <span class="main">⊆</span> sys_block_sizes"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sys_block_sizes_def ins.sys_block_sizes_def blocks_subset sub_blocks<span class="main">)</span>

<span class="keyword1" id="Sub_Designs-sub_point_rep_number_le"><span class="command">lemma</span></span> sub_point_rep_number_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">𝒰</span> <span class="main">⟹</span> <span class="free">𝒜</span> <span class="keyword1">rep</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">ℬ</span> <span class="keyword1">rep</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def blocks_subset multiset_filter_mono size_mset_mono<span class="main">)</span>

<span class="keyword1" id="Sub_Designs-sub_point_index_le"><span class="command">lemma</span></span> sub_point_index_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="free">𝒰</span> <span class="main">⟹</span> <span class="free">𝒜</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">≤</span> <span class="free">ℬ</span> <span class="keyword1">index</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def blocks_subset multiset_filter_mono size_mset_mono<span class="main">)</span>

<span class="keyword1" id="Sub_Designs-sub_sys_intersection_numbers"><span class="command">lemma</span></span> sub_sys_intersection_numbers<span class="main">:</span> <span class="quoted"><span class="quoted">"ins.intersection_numbers <span class="main">⊆</span> intersection_numbers"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intersection_numbers_def ins.intersection_numbers_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> blocks_subset insert_DiffM insert_subset_eq_iff<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Reasoning on Incidence Sys/Design operations›</span></span>
<span class="keyword1"><span class="command">context</span></span> incidence_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Sub_Designs-sub_set_sysI"><span class="command">lemma</span></span> sub_set_sysI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒰</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="free">𝒜</span> <span class="main">⊆#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> sub_set_system <span class="free">𝒰</span> <span class="free">𝒜</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub_ssI incidence_system_axioms<span class="main">)</span> 

<span class="keyword1" id="Sub_Designs-sub_inc_sysI"><span class="command">lemma</span></span> sub_inc_sysI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"incidence_system <span class="free">𝒰</span> <span class="free">𝒜</span> <span class="main">⟹</span> <span class="free">𝒰</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">⟹</span> <span class="free">𝒜</span> <span class="main">⊆#</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> 
    sub_incidence_system <span class="free">𝒰</span> <span class="free">𝒜</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub_incidence_system.intro sub_set_sysI<span class="main">)</span>

<span class="keyword1" id="Sub_Designs-multiple_orig_sub_system"><span class="command">lemma</span></span> multiple_orig_sub_system<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> multiple_block_in_original wellformed multiple_blocks_sub assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Sub_Designs-add_point_sub_sys"><span class="command">lemma</span></span> add_point_sub_sys<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">(</span>add_point <span class="free">p</span><span class="main">)</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_point_wf add_point_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub_ssI subset_insertI incidence_system_axioms sub_incidence_system.intro<span class="main">)</span> 

<span class="keyword1" id="Sub_Designs-strong_del_point_sub_sys"><span class="command">lemma</span></span> strong_del_point_sub_sys<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_incidence_system <span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span> <span class="main">(</span>str_del_point_blocks <span class="free">p</span><span class="main">)</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> "</span></span>
  <span class="keyword1"><span class="command">using</span></span> strong_del_point_incidence_wf wf_invalid_point del_point_def str_del_point_blocks_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Sub_Designs-add_block_sub_sys"><span class="command">lemma</span></span> add_block_sub_sys<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">∪</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>add_block <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_block_wf wf_invalid_point add_block_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Sub_Designs-delete_block_sub_sys"><span class="command">lemma</span></span> delete_block_sub_sys<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>del_block <span class="free">b</span><span class="main">)</span>  <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> "</span></span>
  <span class="keyword1"><span class="command">using</span></span> delete_block_wf delete_block_subset incidence_system_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
                       
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> two_set_systems<span class="main">)</span> combine_sub_sys<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_incidence_system <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> two_set_systems<span class="main">)</span> combine_sub_sys_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_incidence_system <span class="free">𝒱'</span> <span class="free">ℬ'</span> <span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> design
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Sub_Designs-sub_designI"><span class="command">lemma</span></span> sub_designI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"design <span class="free">𝒰</span> <span class="free">𝒜</span> <span class="main">⟹</span> sub_incidence_system <span class="free">𝒰</span> <span class="free">𝒜</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">⟹</span> sub_design <span class="free">𝒰</span> <span class="free">𝒜</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub_design.intro wf_design<span class="main">)</span>

<span class="keyword1" id="Sub_Designs-sub_designII"><span class="command">lemma</span></span> sub_designII <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"design <span class="free">𝒰</span> <span class="free">𝒜</span> <span class="main">⟹</span> sub_incidence_system <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="free">𝒰</span> <span class="free">𝒜</span> <span class="main">⟹</span> sub_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="free">𝒰</span> <span class="free">𝒜</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub_design_def<span class="main">)</span>

<span class="keyword1" id="Sub_Designs-multiple_orig_sub_des"><span class="command">lemma</span></span> multiple_orig_sub_des<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>multiple_blocks <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> multiple_is_design assms multiple_orig_sub_system <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub_design.intro<span class="main">)</span> 

<span class="keyword1" id="Sub_Designs-add_point_sub_des"><span class="command">lemma</span></span> add_point_sub_des<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">(</span>add_point <span class="free">p</span><span class="main">)</span> <span class="keyword1"><span class="free">ℬ</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_point_design add_point_sub_sys sub_design.intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="Sub_Designs-strong_del_point_sub_des"><span class="command">lemma</span></span> strong_del_point_sub_des<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_design <span class="main">(</span>del_point <span class="free">p</span><span class="main">)</span> <span class="main">(</span>str_del_point_blocks <span class="free">p</span><span class="main">)</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> "</span></span>
  <span class="keyword1"><span class="command">using</span></span> strong_del_point_sub_sys sub_design.intro wf_design <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="Sub_Designs-add_block_sub_des"><span class="command">lemma</span></span> add_block_sub_des<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> sub_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span> <span class="main">∪</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>add_block <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_block_sub_sys add_block_design sub_designII <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Sub_Designs-delete_block_sub_des"><span class="command">lemma</span></span> delete_block_sub_des<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_design <span class="keyword1"><span class="free">𝒱</span></span> <span class="main">(</span>del_block <span class="free">b</span><span class="main">)</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> "</span></span>
  <span class="keyword1"><span class="command">using</span></span> delete_block_design delete_block_sub_sys sub_designI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> two_designs<span class="main">)</span> combine_sub_des<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_design <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> two_designs<span class="main">)</span> combine_sub_des_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_design <span class="free">𝒱'</span> <span class="free">ℬ'</span> <span class="keyword1">𝒱<span class="hidden">⇧</span><sup>+</sup></span> <span class="keyword1">ℬ<span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Design_Isomorphisms">
<div class="head">
<h1>Theory Design_Isomorphisms</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Design_Isomorphisms
   Author: Chelsea Edmonds 
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Design Isomorphisms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Design_Isomorphisms <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Design_Basics">Design_Basics</a> <a href="#Sub_Designs">Sub_Designs</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Images of Set Systems›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We loosely define the concept of taking the "image" of a set system, as done in isomorphisms. 
Note that this is not based off mathematical theory, but is for ease of notation›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">blocks_image</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set multiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> set multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">blocks_image</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> image_mset <span class="main">(</span><span class="main">(`)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

<span class="keyword1" id="Design_Isomorphisms-image_block_set_constant_size"><span class="command">lemma</span></span> image_block_set_constant_size<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="free">B</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span>blocks_image <span class="free">B</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocks_image_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> incidence_system<span class="main">)</span> image_set_system_wellformed<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"incidence_system <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">)</span> <span class="main">(</span>blocks_image <span class="keyword1"><span class="free">ℬ</span></span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocks_image_def<span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> image_eqI wf_invalid_point<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> finite_incidence_system<span class="main">)</span> image_set_system_finite<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite_incidence_system <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="keyword1"><span class="free">𝒱</span></span><span class="main">)</span> <span class="main">(</span>blocks_image <span class="keyword1"><span class="free">ℬ</span></span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> image_set_system_wellformed finite_sets 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocks_image_def finite_incidence_system_axioms.intro<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Incidence System Isomorphisms›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Isomorphism's are defined by the Handbook of Combinatorial Designs 
\cite{colbournHandbookCombinatorialDesigns2007}›</span></span>

<span class="keyword1"><span class="command">locale</span></span> incidence_system_isomorphism <span class="main">=</span> source<span class="main">:</span> incidence_system <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="main">+</span> target<span class="main">:</span> incidence_system <span class="quoted"><span class="free">𝒱'</span></span> <span class="quoted"><span class="free">ℬ'</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="quoted">"<span class="free">𝒱</span>"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"<span class="free">ℬ</span>"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"<span class="free">𝒱'</span>"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"<span class="free">ℬ'</span>"</span> <span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">bij_map</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">π</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="keyword1"><span class="free">π</span></span> <span class="free">𝒱</span> <span class="free">𝒱'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> block_img<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset <span class="main">(</span><span class="main">(`)</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="free">ℬ</span> <span class="main">=</span> <span class="free">ℬ'</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Design_Isomorphisms-iso_eq_order"><span class="command">lemma</span></span> iso_eq_order<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">𝒱</span> <span class="main">=</span> card <span class="free">𝒱'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij bij_betw_same_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Design_Isomorphisms-iso_eq_block_num"><span class="command">lemma</span></span> iso_eq_block_num<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="free">ℬ</span> <span class="main">=</span> size <span class="free">ℬ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> block_img <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> size_image_mset<span class="main">)</span> 

<span class="keyword1" id="Design_Isomorphisms-iso_block_img_alt_rep"><span class="command">lemma</span></span> iso_block_img_alt_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="free">ℬ</span><span class="main">#}</span> <span class="main">=</span> <span class="free">ℬ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> block_img <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Design_Isomorphisms-inv_iso_block_img"><span class="command">lemma</span></span> inv_iso_block_img<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset <span class="main">(</span><span class="main">(`)</span> <span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span><span class="main">)</span> <span class="free">ℬ'</span> <span class="main">=</span> <span class="free">ℬ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒱</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij bij_betw_inv_into_left comp_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">bl</span>  <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> source.wellformed <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> img<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">⟹</span> image <span class="main">(</span><span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="bound">bl</span> <span class="main">=</span> <span class="bound">bl</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"image_mset <span class="main">(</span><span class="main">(`)</span> <span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span><span class="main">)</span> <span class="free">ℬ'</span> <span class="main">=</span> image_mset <span class="main">(</span><span class="main">(`)</span> <span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>image_mset <span class="main">(</span><span class="main">(`)</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="free">ℬ</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> block_img <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"image_mset <span class="main">(</span><span class="main">(`)</span> <span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span><span class="main">)</span> <span class="free">ℬ'</span> <span class="main">=</span> image_mset <span class="main">(</span><span class="main">(`)</span> <span class="main">(</span><span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span><span class="main">)</span> <span class="free">ℬ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> comp_apply image_comp multiset.map_comp multiset.map_cong0<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> img <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Isomorphisms-inverse_incidence_sys_iso"><span class="command">lemma</span></span> inverse_incidence_sys_iso<span class="main">:</span> <span class="quoted"><span class="quoted">"incidence_system_isomorphism <span class="free">𝒱'</span> <span class="free">ℬ'</span> <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij bij_betw_inv_into inv_iso_block_img <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Design_Isomorphisms-iso_points_map"><span class="command">lemma</span></span> iso_points_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">𝒱</span> <span class="main">=</span> <span class="free">𝒱'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betw_imp_surj_on<span class="main">)</span>

<span class="keyword1" id="Design_Isomorphisms-iso_points_inv_map"><span class="command">lemma</span></span> iso_points_inv_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="main">`</span>  <span class="free">𝒱'</span> <span class="main">=</span> <span class="free">𝒱</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> incidence_system_isomorphism.iso_points_map inverse_incidence_sys_iso <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Design_Isomorphisms-iso_points_ss_card"><span class="command">lemma</span></span> iso_points_ss_card<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="free">𝒱</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">ps</span> <span class="main">=</span> card <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms bij bij_betw_same_card bij_betw_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Design_Isomorphisms-iso_block_in"><span class="command">lemma</span></span> iso_block_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">bl</span><span class="main">)</span> <span class="main">∈#</span> <span class="free">ℬ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> iso_block_img_alt_rep
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_eqI in_image_mset<span class="main">)</span>

<span class="keyword1" id="Design_Isomorphisms-iso_inv_block_in"><span class="command">lemma</span></span> iso_inv_block_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">ℬ'</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(`)</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> set_mset <span class="free">ℬ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> block_img in_image_mset<span class="main">)</span>

<span class="keyword1" id="Design_Isomorphisms-iso_img_block_orig_exists"><span class="command">lemma</span></span> iso_img_block_orig_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">ℬ'</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">bl</span> <span class="main">.</span> <span class="bound">bl</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="bound">bl</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> iso_inv_block_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Design_Isomorphisms-iso_blocks_map_inj"><span class="command">lemma</span></span> iso_blocks_map_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">x</span> <span class="main">=</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> image_inv_into_cancel incidence_system.wellformed iso_points_inv_map iso_points_map
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> source.incidence_system_axioms subset_image_iff<span class="main">)</span>

<span class="keyword1" id="Design_Isomorphisms-iso_bij_betwn_block_sets"><span class="command">lemma</span></span> iso_bij_betwn_block_sets<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">(`)</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">ℬ</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">ℬ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betw_def inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> iso_block_in iso_inv_block_in iso_blocks_map_inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Design_Isomorphisms-iso_bij_betwn_block_sets_inv"><span class="command">lemma</span></span> iso_bij_betwn_block_sets_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">(`)</span> <span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">ℬ'</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">ℬ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> incidence_system_isomorphism.iso_bij_betwn_block_sets inverse_incidence_sys_iso <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="Design_Isomorphisms-iso_bij_betw_individual_blocks"><span class="command">lemma</span></span> iso_bij_betw_individual_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">⟹</span> bij_betw <span class="keyword1"><span class="free">π</span></span> <span class="free">bl</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">bl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij bij_betw_subset source.wellformed <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="Design_Isomorphisms-iso_bij_betw_individual_blocks_inv"><span class="command">lemma</span></span> iso_bij_betw_individual_blocks_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">⟹</span> bij_betw <span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">bl</span><span class="main">)</span> <span class="free">bl</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij bij_betw_subset source.wellformed bij_betw_inv_into_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="Design_Isomorphisms-iso_bij_betw_individual_blocks_inv_alt"><span class="command">lemma</span></span> iso_bij_betw_individual_blocks_inv_alt<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="free">ℬ'</span> <span class="main">⟹</span> bij_betw <span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="free">bl</span> <span class="main">(</span><span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="main">`</span> <span class="free">bl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> incidence_system_isomorphism.iso_bij_betw_individual_blocks inverse_incidence_sys_iso
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  
<span class="keyword1" id="Design_Isomorphisms-iso_inv_block_in_alt"><span class="command">lemma</span></span> iso_inv_block_in_alt<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">bl</span><span class="main">)</span> <span class="main">∈#</span> <span class="free">ℬ'</span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">⊆</span> <span class="free">𝒱</span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">∈#</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> image_eqI image_inv_into_cancel inv_iso_block_img iso_points_inv_map
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> iso_points_map multiset.set_map subset_image_iff<span class="main">)</span>

<span class="keyword1" id="Design_Isomorphisms-iso_img_block_not_in"><span class="command">lemma</span></span> iso_img_block_not_in<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉#</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊆</span> <span class="free">𝒱</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">x</span><span class="main">)</span> <span class="main">∉#</span> <span class="free">ℬ'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">x</span> <span class="main">∉#</span> <span class="free">ℬ'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">x</span> <span class="main">∈#</span> <span class="free">ℬ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">𝒱</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> target.wf_invalid_point iso_points_inv_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(`)</span> <span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈#</span> <span class="free">ℬ</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> iso_bij_betwn_block_sets_inv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> a bij_betw_apply<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> a assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> iso_inv_block_in_alt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Isomorphisms-iso_block_multiplicity"><span class="command">lemma</span></span> iso_block_multiplicity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">⊆</span> <span class="free">𝒱</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"source.multiplicity <span class="free">bl</span> <span class="main">=</span> target.multiplicity <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">bl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="free">ℬ</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(`)</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">ℬ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betw_imp_inj_on iso_bij_betwn_block_sets <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="free">ℬ</span> <span class="free">bl</span> <span class="main">=</span> count <span class="free">ℬ'</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">bl</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> count_image_mset_le_count_inj_on count_image_mset_ge_count True block_img inv_into_f_f 
      less_le_not_le order.not_eq_order_implies_strict <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>  
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> s_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"source.multiplicity <span class="free">bl</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False count_eq_zero_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"target.multiplicity <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">bl</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False count_inI iso_inv_block_in_alt
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> s_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Isomorphisms-iso_point_in_block_img_iff"><span class="command">lemma</span></span> iso_point_in_block_img_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">𝒱</span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> <span class="free">bl</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">bl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij bij_betw_imp_surj_on iso_bij_betw_individual_blocks_inv bij_betw_inv_into_left imageI<span class="main">)</span>

<span class="keyword1" id="Design_Isomorphisms-iso_point_subset_block_iff"><span class="command">lemma</span></span> iso_point_subset_block_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⊆</span> <span class="free">𝒱</span> <span class="main">⟹</span> <span class="free">bl</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">⊆</span> <span class="free">bl</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">p</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">bl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> image_subset_iff iso_point_in_block_img_iff subset_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Design_Isomorphisms-iso_is_image_block"><span class="command">lemma</span></span> iso_is_image_block<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℬ'</span> <span class="main">=</span> blocks_image <span class="free">ℬ</span> <span class="keyword1"><span class="free">π</span></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> blocks_image_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_img iso_points_map<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Design Isomorphisms›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Apply the concept of isomorphisms to designs only›</span></span>

<span class="keyword1"><span class="command">locale</span></span> design_isomorphism <span class="main">=</span> incidence_system_isomorphism <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="quoted"><span class="free">𝒱'</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="quoted"><span class="keyword1"><span class="free">π</span></span></span> <span class="main">+</span> source<span class="main">:</span> design <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="main">+</span> 
  target<span class="main">:</span> design <span class="quoted"><span class="free">𝒱'</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">𝒱</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℬ</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒱'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℬ'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bij_map</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">π</span>"</span><span class="main">)</span>
  
<span class="keyword1"><span class="command">context</span></span> design_isomorphism
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Design_Isomorphisms-inverse_design_isomorphism"><span class="command">lemma</span></span> inverse_design_isomorphism<span class="main">:</span> <span class="quoted"><span class="quoted">"design_isomorphism <span class="free">𝒱'</span> <span class="free">ℬ'</span> <span class="free">𝒱</span> <span class="free">ℬ</span> <span class="main">(</span>inv_into <span class="free">𝒱</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inverse_incidence_sys_iso source.wf_design target.wf_design
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> design_isomorphism.intro<span class="main">)</span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Isomorphism Operation›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Define the concept of isomorphic designs outside the scope of locale›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isomorphic_designs</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≅<span class="hidden">⇩</span><sub>D</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">𝒟</span></span></span> <span class="keyword1"><span class="free">≅<span class="hidden">⇩</span><sub>D</sub></span></span> <span class="free"><span class="bound"><span class="entity">𝒟'</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">π</span> <span class="main">.</span> design_isomorphism <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">𝒟</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">𝒟</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">𝒟'</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">𝒟'</span></span></span><span class="main">)</span> <span class="bound">π</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Design_Isomorphisms-isomorphic_designs_symmetric"><span class="command">lemma</span></span> isomorphic_designs_symmetric<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">𝒱</span><span class="main">,</span> <span class="free">ℬ</span><span class="main">)</span> <span class="keyword1">≅<span class="hidden">⇩</span><sub>D</sub></span> <span class="main">(</span><span class="free">𝒱'</span><span class="main">,</span> <span class="free">ℬ'</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">𝒱'</span><span class="main">,</span> <span class="free">ℬ'</span><span class="main">)</span> <span class="keyword1">≅<span class="hidden">⇩</span><sub>D</sub></span> <span class="main">(</span><span class="free">𝒱</span><span class="main">,</span> <span class="free">ℬ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> isomorphic_designs_def design_isomorphism.inverse_design_isomorphism
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Design_Isomorphisms-isomorphic_designs_implies_bij"><span class="command">lemma</span></span> isomorphic_designs_implies_bij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">𝒱</span><span class="main">,</span> <span class="free">ℬ</span><span class="main">)</span> <span class="keyword1">≅<span class="hidden">⇩</span><sub>D</sub></span> <span class="main">(</span><span class="free">𝒱'</span><span class="main">,</span> <span class="free">ℬ'</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">π</span> <span class="main">.</span> bij_betw <span class="bound">π</span> <span class="free">𝒱</span> <span class="free">𝒱'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> incidence_system_isomorphism.bij isomorphic_designs_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> design_isomorphism.axioms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fst_conv<span class="main">)</span>

<span class="keyword1" id="Design_Isomorphisms-isomorphic_designs_implies_block_map"><span class="command">lemma</span></span> isomorphic_designs_implies_block_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">𝒱</span><span class="main">,</span> <span class="free">ℬ</span><span class="main">)</span> <span class="keyword1">≅<span class="hidden">⇩</span><sub>D</sub></span> <span class="main">(</span><span class="free">𝒱'</span><span class="main">,</span> <span class="free">ℬ'</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">π</span> <span class="main">.</span> image_mset <span class="main">(</span><span class="main">(`)</span> <span class="bound">π</span><span class="main">)</span> <span class="free">ℬ</span> <span class="main">=</span> <span class="free">ℬ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> incidence_system_isomorphism.block_img isomorphic_designs_def
  <span class="keyword1"><span class="command">using</span></span> design_isomorphism.axioms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">context</span></span> design
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1" id="Design_Isomorphisms-isomorphic_designsI"><span class="command">lemma</span></span> isomorphic_designsI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"design <span class="free">𝒱'</span> <span class="free">ℬ'</span> <span class="main">⟹</span> bij_betw <span class="free">π</span> <span class="keyword1"><span class="free">𝒱</span></span> <span class="free">𝒱'</span> <span class="main">⟹</span> image_mset <span class="main">(</span><span class="main">(`)</span> <span class="free">π</span><span class="main">)</span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="main">=</span> <span class="free">ℬ'</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span><span class="main">,</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="keyword1">≅<span class="hidden">⇩</span><sub>D</sub></span> <span class="main">(</span><span class="free">𝒱'</span><span class="main">,</span> <span class="free">ℬ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> design_isomorphism.intro isomorphic_designs_def wf_design image_set_system_wellformed
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_betw_imp_surj_on blocks_image_def fst_conv incidence_system_axioms 
      incidence_system_isomorphism.intro incidence_system_isomorphism_axioms_def snd_conv<span class="main">)</span>

<span class="keyword1" id="Design_Isomorphisms-eq_designs_isomorphic"><span class="command">lemma</span></span> eq_designs_isomorphic<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒱</span></span> <span class="main">=</span> <span class="free">𝒱'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="main">=</span> <span class="free">ℬ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">𝒱</span></span><span class="main">,</span> <span class="keyword1"><span class="free">ℬ</span></span><span class="main">)</span> <span class="keyword1">≅<span class="hidden">⇩</span><sub>D</sub></span> <span class="main">(</span><span class="free">𝒱'</span><span class="main">,</span> <span class="free">ℬ'</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> d1<span class="main">:</span> design <span class="quoted"><span class="keyword1"><span class="free">𝒱</span></span></span> <span class="quoted"><span class="keyword1"><span class="free">ℬ</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">using</span></span> wf_design <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">interpret</span></span> d2<span class="main">:</span> design <span class="quoted"><span class="free">𝒱'</span></span> <span class="quoted"><span class="free">ℬ'</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">using</span></span> wf_design <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"design_isomorphism <span class="keyword1"><span class="free">𝒱</span></span> <span class="keyword1"><span class="free">ℬ</span></span> <span class="free">𝒱'</span> <span class="free">ℬ'</span> id"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> isomorphic_designs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> design_isomorphism
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Design Properties/Operations under Isomorphism›</span></span>

<span class="keyword1" id="Design_Isomorphisms-design_iso_point_rep_num_eq"><span class="command">lemma</span></span> design_iso_point_rep_num_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">𝒱</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℬ</span> <span class="keyword1">rep</span> <span class="free">p</span> <span class="main">=</span> <span class="free">ℬ'</span> <span class="keyword1">rep</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">.</span> <span class="keyword1"><span class="free">π</span></span> <span class="free">p</span> <span class="main">∈</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="bound">b</span><span class="main">#}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms filter_mset_cong iso_point_in_block_img_iff assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="free">ℬ'</span> <span class="main">.</span> <span class="keyword1"><span class="free">π</span></span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> image_mset <span class="main">(</span><span class="main">(`)</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_mset_filter_swap block_img<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> point_replication_number_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Isomorphisms-design_iso_rep_numbers_eq"><span class="command">lemma</span></span> design_iso_rep_numbers_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"source.replication_numbers <span class="main">=</span> target.replication_numbers"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> source.replication_numbers_def target.replication_numbers_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span>  design_iso_point_rep_num_eq design_isomorphism.design_iso_point_rep_num_eq iso_points_map
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> imageI inverse_design_isomorphism iso_points_inv_map<span class="main">)</span>

<span class="keyword1" id="Design_Isomorphisms-design_iso_block_size_eq"><span class="command">lemma</span></span> design_iso_block_size_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">⟹</span> card <span class="free">bl</span> <span class="main">=</span> card <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">bl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> card_image_le finite_subset_image image_inv_into_cancel
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iso_points_inv_map iso_points_map le_antisym source.finite_blocks source.wellformed<span class="main">)</span>
  
<span class="keyword1" id="Design_Isomorphisms-design_iso_block_sizes_eq"><span class="command">lemma</span></span> design_iso_block_sizes_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"source.sys_block_sizes <span class="main">=</span> target.sys_block_sizes"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> source.sys_block_sizes_def target.sys_block_sizes_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> design_iso_block_size_eq iso_block_in iso_img_block_orig_exists<span class="main">)</span> 

<span class="keyword1" id="Design_Isomorphisms-design_iso_points_index_eq"><span class="command">lemma</span></span> design_iso_points_index_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">⊆</span> <span class="free">𝒱</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℬ</span> <span class="keyword1">index</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">ℬ'</span> <span class="keyword1">index</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">ps</span><span class="main">)</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> iso_point_subset_block_iff assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">.</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">ps</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="bound">b</span><span class="main">)</span><span class="main">#}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms filter_mset_cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="free">ℬ'</span> <span class="main">.</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span> <span class="main">=</span> image_mset <span class="main">(</span><span class="main">(`)</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="main">{#</span><span class="bound">b</span> <span class="main">∈#</span> <span class="free">ℬ</span> <span class="main">.</span> <span class="free">ps</span> <span class="main">⊆</span> <span class="bound">b</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_mset_filter_swap block_img<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> points_index_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Isomorphisms-design_iso_points_indices_imp"><span class="command">lemma</span></span> design_iso_points_indices_imp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> source.point_indices <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> target.point_indices <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">ps</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">⊆</span> <span class="free">𝒱</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℬ</span> <span class="keyword1">index</span> <span class="skolem">ps</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> source.point_indices_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">ℬ'</span> <span class="keyword1">index</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> design_iso_points_index_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> x_img<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">𝒱'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ss bij iso_points_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t ss iso_points_ss_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> target.point_indices_elem_in x_img x_val <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Isomorphisms-design_iso_points_indices_eq"><span class="command">lemma</span></span> design_iso_points_indices_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"source.point_indices <span class="free">t</span> <span class="main">=</span> target.point_indices <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inverse_design_isomorphism design_isomorphism.design_iso_points_indices_imp
    design_iso_points_indices_imp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="Design_Isomorphisms-design_iso_block_intersect_num_eq"><span class="command">lemma</span></span> design_iso_block_intersect_num_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈#</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b2</span> <span class="main">∈#</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">|∩|</span> <span class="free">b2</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">b1</span><span class="main">)</span> <span class="main">|∩|</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">b2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="main">(</span><span class="free">b1</span> <span class="main">∩</span> <span class="free">b2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">b1</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">b2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms bij bij_betw_inter_subsets
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> source.wellformed<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> source.wellformed
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intersection_number_def iso_points_ss_card split assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> inf.coboundedI2<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Isomorphisms-design_iso_inter_numbers_imp"><span class="command">lemma</span></span> design_iso_inter_numbers_imp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> source.intersection_numbers"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> target.intersection_numbers"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">∈#</span> <span class="free">ℬ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="skolem">b1</span> <span class="free">ℬ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">b1</span> <span class="main">|∩|</span> <span class="skolem">b2</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> source.intersection_numbers_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pi1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="skolem">b1</span> <span class="main">∈#</span> <span class="free">ℬ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iso_block_in<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> pi2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="skolem">b2</span> <span class="main">∈#</span> <span class="main">(</span>remove1_mset <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="skolem">b1</span><span class="main">)</span> <span class="free">ℬ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> iso_block_in 2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"1"</span> block_img image_mset_remove1_mset_if in_remove1_mset_neq 
        iso_blocks_map_inj more_than_one_mset_mset_diff multiset.set_map<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="skolem">b1</span><span class="main">)</span> <span class="main">|∩|</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="skolem">b2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 design_iso_block_intersect_num_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_diffD xval<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b1</span> <span class="main">|∩|</span> <span class="bound">b2</span> <span class="main">|</span> <span class="bound">b1</span> <span class="bound">b2</span> <span class="main">.</span> <span class="bound">b1</span> <span class="main">∈#</span> <span class="free">ℬ'</span> <span class="main">∧</span> <span class="bound">b2</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">ℬ'</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">b1</span><span class="main">#}</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> pi1 pi2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> target.intersection_numbers_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Isomorphisms-design_iso_intersection_numbers"><span class="command">lemma</span></span> design_iso_intersection_numbers<span class="main">:</span> <span class="quoted"><span class="quoted">"source.intersection_numbers <span class="main">=</span> target.intersection_numbers"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inverse_design_isomorphism design_isomorphism.design_iso_inter_numbers_imp 
      design_iso_inter_numbers_imp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Design_Isomorphisms-design_iso_n_intersect_num"><span class="command">lemma</span></span> design_iso_n_intersect_num<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈#</span> <span class="free">ℬ</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b2</span> <span class="main">∈#</span> <span class="free">ℬ</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">|∩|⇩</span><span class="free">n</span> <span class="free">b2</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">b1</span><span class="main">)</span> <span class="main">|∩|⇩</span><span class="free">n</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">b2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">b1</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">b2</span> <span class="main">∧</span> card <span class="bound">x</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">b1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">b2</span><span class="main">)</span> <span class="main">∧</span> card <span class="bound">y</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> b1v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">⊆</span> <span class="free">𝒱</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> source.wellformed<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> b2v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b2</span> <span class="main">⊆</span> <span class="free">𝒱</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> source.wellformed<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">b1</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">b2</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">⊆</span> <span class="free">b1</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">⊆</span> <span class="free">b2</span> <span class="main">⟹</span>  <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="bound">x</span> <span class="main">=</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b1v bij <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_betw_imp_surj_on bij_betw_inv_into_subset dual_order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(`)</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> eqcard<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xa</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">⊆</span> <span class="free">b1</span> <span class="main">⟹</span> <span class="bound">xa</span> <span class="main">⊆</span> <span class="free">b2</span> <span class="main">⟹</span> card <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">=</span> card <span class="bound">xa</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b1v b2v bij
    <span class="keyword1"><span class="command">using</span></span> iso_points_ss_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> surj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">b1</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">b2</span>  <span class="main">⟹</span> 
                <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">|</span> <span class="bound">xa</span> <span class="main">.</span> <span class="bound">xa</span> <span class="main">⊆</span> <span class="free">b1</span> <span class="main">∧</span> <span class="bound">xa</span> <span class="main">⊆</span> <span class="free">b2</span> <span class="main">∧</span> card <span class="bound">xa</span> <span class="main">=</span> card <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">b1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">b2</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xa</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">⊆</span> <span class="free">𝒱</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b1v dual_order.trans subset_imageE<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">⊆</span> <span class="free">b1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> iso_point_subset_block_iff<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">⊆</span> <span class="free">b2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_x ss assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> iso_point_subset_block_iff x2<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">xa</span> <span class="main">=</span> card <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bij <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_x ss iso_points_ss_card<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">|</span> <span class="bound">xa</span> <span class="main">.</span> <span class="bound">xa</span> <span class="main">⊆</span> <span class="free">b1</span> <span class="main">∧</span> <span class="bound">xa</span> <span class="main">⊆</span> <span class="free">b2</span> <span class="main">∧</span> card <span class="bound">xa</span> <span class="main">=</span> card <span class="skolem">x</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> f1 f2 f3 <span class="quoted"><span class="quoted">‹<span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span> <span class="main">(`)</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="var">?A</span> <span class="var">?B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betw_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(`)</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">b1</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">b2</span> <span class="main">∧</span> card <span class="bound">x</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xa</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">⊆</span> <span class="free">b1</span> <span class="main">⟹</span> <span class="bound">xa</span> <span class="main">⊆</span> <span class="free">b2</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">=</span> card <span class="bound">xa</span> <span class="main">⟹</span> card <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">=</span> card <span class="bound">xa</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> eqcard <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">b1</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">⊆</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">b2</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">=</span> card <span class="bound">x</span> <span class="main">⟹</span> 
            <span class="bound">x</span> <span class="main">∈</span> <span class="main">(`)</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">⊆</span> <span class="free">b1</span> <span class="main">∧</span> <span class="bound">xa</span> <span class="main">⊆</span> <span class="free">b2</span> <span class="main">∧</span> card <span class="bound">xa</span> <span class="main">=</span> card <span class="bound">x</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> surj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> setcompr_eq_image<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betw_same_card <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_intersect_number_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Isomorphisms-subdesign_iso_implies"><span class="command">lemma</span></span> subdesign_iso_implies<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sub_set_system <span class="free">V</span> <span class="free">B</span> <span class="free">𝒱</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_set_system <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">V</span><span class="main">)</span> <span class="main">(</span>blocks_image <span class="free">B</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="free">𝒱'</span> <span class="free">ℬ'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">V</span> <span class="main">⊆</span> <span class="free">𝒱'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms image_mono iso_points_map sub_set_system.points_subset<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"blocks_image <span class="free">B</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">⊆#</span> <span class="free">ℬ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms block_img blocks_image_def image_mset_subseteq_mono sub_set_system.blocks_subset<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Isomorphisms-subdesign_image_is_design"><span class="command">lemma</span></span> subdesign_image_is_design<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sub_set_system <span class="free">V</span> <span class="free">B</span> <span class="free">𝒱</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"design <span class="free">V</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"design <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">V</span><span class="main">)</span> <span class="main">(</span>blocks_image <span class="free">B</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> fin<span class="main">:</span> finite_incidence_system <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">V</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>blocks_image <span class="free">B</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> design.axioms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> finite_incidence_system.image_set_system_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> sub_design <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">𝒱</span></span> <span class="quoted"><span class="free">ℬ</span></span> <span class="keyword1"><span class="command">using</span></span> assms design.wf_design_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub_set_system.points_subset sub_set_system.blocks_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> bl_img<span class="main">:</span> <span class="quoted"><span class="quoted">"blocks_image <span class="free">B</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">⊆#</span> <span class="free">ℬ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocks_image_def des.blocks_subset image_mset_subseteq_mono iso_is_image_block<span class="main">)</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∈#</span> blocks_image <span class="free">B</span> <span class="keyword1"><span class="free">π</span></span> <span class="main">⟹</span> False"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms subdesign_iso_implies target.blocks_nempty bl_img <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Design_Isomorphisms-sub_design_isomorphism"><span class="command">lemma</span></span> sub_design_isomorphism<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sub_set_system <span class="free">V</span> <span class="free">B</span> <span class="free">𝒱</span> <span class="free">ℬ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"design <span class="free">V</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"design_isomorphism <span class="free">V</span> <span class="free">B</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">V</span><span class="main">)</span> <span class="main">(</span>blocks_image <span class="free">B</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="keyword1"><span class="free">π</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> design <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">V</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>blocks_image <span class="free">B</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subdesign_image_is_design<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> des<span class="main">:</span> design <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">B</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="keyword1"><span class="free">π</span></span> <span class="free">V</span> <span class="main">(</span><span class="keyword1"><span class="free">π</span></span> <span class="main">`</span> <span class="free">V</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bij
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bij_betw_subset sub_set_system.points_subset<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"image_mset <span class="main">(</span><span class="main">(`)</span> <span class="keyword1"><span class="free">π</span></span><span class="main">)</span> <span class="free">B</span> <span class="main">=</span> blocks_image <span class="free">B</span> <span class="keyword1"><span class="free">π</span></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocks_image_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Design_Theory_Root">
<div class="head">
<h1>Theory Design_Theory_Root</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Design_Theory_Root.thy
   Author: Chelsea Edmonds
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Design_Theory_Root
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Multisets_Extras">Multisets_Extras</a>

  <a href="#Design_Basics">Design_Basics</a>
  <a href="#Design_Operations">Design_Operations</a>
  <a href="#Block_Designs">Block_Designs</a>
  <a href="#BIBD">BIBD</a>

  <a href="#Resolvable_Designs">Resolvable_Designs</a>
  <a href="#Group_Divisible_Designs">Group_Divisible_Designs</a>
  <a href="#Designs_And_Graphs">Designs_And_Graphs</a>
  <a href="#Design_Isomorphisms">Design_Isomorphisms</a>
  <a href="#Sub_Designs">Sub_Designs</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>