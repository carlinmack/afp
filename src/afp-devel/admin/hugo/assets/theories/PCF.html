<div id="Basis">
<div class="head">
<h1>Theory Basis</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Basis.thy
    Author:     Peter Gammie
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Basis
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOLCF/HOLCF.html">HOLCF</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Product_Order.html">HOL-Library.Product_Order</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Dual_Ordered_Lattice.html">HOL-Library.Dual_Ordered_Lattice</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOLCF-Library/Nat_Discrete.html">HOLCF-Library.Nat_Discrete</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Auxiliary lemmas›</span></span>

<span class="keyword1" id="Basis-cfun_map_below_ID"><span class="command">lemma</span></span> cfun_map_below_ID<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊑</span> ID"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cfun_map<span class="main">⋅</span><span class="free">e</span><span class="main">⋅</span><span class="free">e</span> <span class="main">⊑</span> ID"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> cfun_belowI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">from</span></span> e <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cfun_map<span class="main">⋅</span><span class="free">e</span><span class="main">⋅</span><span class="free">e</span><span class="main">⋅</span><span class="skolem">f</span><span class="main">⋅</span><span class="skolem">x</span> <span class="main">⊑</span> ID<span class="main">⋅</span><span class="main">(</span><span class="skolem">f</span><span class="main">⋅</span><span class="main">(</span>ID<span class="main">⋅</span><span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ID1<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> monofun_cfun<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"cfun_map<span class="main">⋅</span><span class="free">e</span><span class="main">⋅</span><span class="free">e</span><span class="main">⋅</span><span class="skolem">f</span><span class="main">⋅</span><span class="skolem">x</span> <span class="main">⊑</span> ID<span class="main">⋅</span><span class="skolem">f</span><span class="main">⋅</span><span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Basis-cfun_below_ID"><span class="command">lemma</span></span> cfun_below_ID<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span> <span class="main">⊑</span> ID<span class="main">;</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">⋅</span><span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_below_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span>

<span class="keyword1" id="Basis-oo_below"><span class="command">lemma</span></span> oo_below<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span> <span class="main">⊑</span> <span class="free">f'</span><span class="main">;</span> <span class="free">g</span> <span class="main">⊑</span> <span class="free">g'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="keyword1">oo</span> <span class="free">g</span> <span class="main">⊑</span> <span class="free">f'</span> <span class="keyword1">oo</span> <span class="free">g'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oo_def cfun_below_iff monofun_cfun<span class="main">)</span>

<span class="keyword1" id="Basis-cont_case_nat"><span class="command">lemma</span></span> cont_case_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> case_nat <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Basis-cont2cont_if_below_const"><span class="command">lemma</span></span> cont2cont_if_below_const <span class="main">[</span><span class="operator">cont2cont</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free">d</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cont_apply <span class="main"><span class="main">[</span></span><span class="operator">OF</span> f<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> cont <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">⊑</span> <span class="free">d</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cont_def is_lub_def is_ub_def ball_simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lub_below_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">⊑</span> <span class="free">d</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Basis-cont2cont_foldl"><span class="command">lemma</span></span> cont2cont_foldl <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">cont2cont</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>cpo <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>cpo <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>cpo <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> foldl <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">z</span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_cont_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cont_apply<span class="main">)</span>

<span class="keyword1" id="Basis-cont2cont_foldr"><span class="command">lemma</span></span> cont2cont_foldr <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">cont2cont</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>cpo <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>cpo <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>cpo <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> foldr <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">(</span><span class="free">z</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_cont_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cont_apply<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The following proof is due to
\citet[Eqn~2.28]{DBLP:journals/siamcomp/Scott76}.

›</span></span>

<span class="keyword1" id="Basis-fix_argument_promote"><span class="command">lemma</span></span> fix_argument_promote<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> fix<span class="main">⋅</span><span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fix<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> f x<span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="bound">f</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span>fix<span class="main">⋅</span><span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> fix<span class="main">⋅</span><span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹cont <span class="free">g</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fix<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> f x<span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="bound">f</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> fix<span class="main">⋅</span><span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fix_least cont2cont_LAM<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> fix<span class="main">⋅</span><span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> fix<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> f x<span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="bound">f</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> cfun_belowI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹cont <span class="free">g</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">y</span><span class="main">⋅</span><span class="main">(</span>fix<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> f x<span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="bound">f</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> fix<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> f x<span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="bound">f</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cont2cont_LAM<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹cont <span class="free">g</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> fix<span class="main">⋅</span><span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">y</span> <span class="main">⊑</span> fix<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> f x<span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="bound">f</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fix_least<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Basis-fix_argument_promote_fun"><span class="command">lemma</span></span> fix_argument_promote_fun<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>type <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>pcpo <span class="main">→</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fix<span class="main">⋅</span><span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span>fix<span class="main">⋅</span><span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fix<span class="main">⋅</span><span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">μ</span> <span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fix<span class="main">⋅</span><span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fix_least cont_fun<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fix<span class="main">⋅</span><span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">y</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">μ</span> <span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cont_fun<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fix<span class="main">⋅</span><span class="main">(</span><span class="free">g</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fix_least<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Basis-adm_cart_prod"><span class="command">lemma</span></span> adm_cart_prod <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">×</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> admI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">×</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Ai <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span><span class="skolem">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mem_Times_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> A X Y <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Lub <span class="skolem">A</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">×</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> admD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> adm_subst <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lub_prod<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Basis-adm_exists_unique"><span class="command">lemma</span></span> adm_exists_unique <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x'</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> admI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span> <span class="keyword3"><span class="command">assume</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Yi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> Py<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> P Q Y Yi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span>Lub <span class="skolem">Y</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> admD<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Py <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="main">(</span>Lub <span class="skolem">Y</span><span class="main">)</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Order monics›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Order monics are invertible with respect to the partial order. They
don't need to be continuous!

All domain data constructors are <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">below_monic_cfun</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">below_monic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>cpo <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>cpo<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">below_monic</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">below_monic_cfun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>cpo <span class="main">→</span> <span class="tfree">'b</span><span class="main">::</span>cpo<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">below_monic_cfun</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> below_monic <span class="main">(</span>Rep_cfun <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Basis-below_monicI"><span class="command">lemma</span></span> below_monicI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> below_monic <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> below_monic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Basis-below_monicE"><span class="command">lemma</span></span> below_monicE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> below_monic <span class="free">f</span><span class="main">;</span> <span class="free">f</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">f</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> below_monic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Basis-below_monic_inj"><span class="command">lemma</span></span> below_monic_inj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"below_monic <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>cpo <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>cpo<span class="main">)</span> <span class="main">⟹</span> inj <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> below_antisym injI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_monicE<span class="main">)</span>

<span class="keyword1" id="Basis-below_monic_indexed"><span class="command">lemma</span></span> below_monic_indexed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"below_monic_cfun <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"below_monic <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span><span class="main">⋅</span><span class="main">(</span><span class="bound">y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms below_fun_def below_monicE below_monicI<span class="main">)</span>

<span class="keyword1" id="Basis-below_monic_ID"><span class="command">lemma</span></span> below_monic_ID <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"below_monic_cfun ID"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_monicI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Basis-below_monic_cfcomp"><span class="command">lemma</span></span> below_monic_cfcomp <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"below_monic_cfun <span class="free">f</span> <span class="main">⟹</span> below_monic_cfun <span class="main">(</span>cfcomp<span class="main">⋅</span><span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_monicI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_below_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_monicE<span class="main">)</span>

<span class="keyword1" id="Basis-below_monic_K"><span class="command">lemma</span></span> below_monic_K <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"below_monic_cfun <span class="free">f</span> <span class="main">⟹</span> below_monic_cfun <span class="main">(</span><span class="keyword1">Λ</span> c <span class="main">_</span><span class="main">.</span> <span class="free">f</span><span class="main">⋅</span><span class="bound">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_monicI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_below_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_monicE<span class="main">)</span>

<span class="keyword1" id="Basis-below_monic_fun_K"><span class="command">lemma</span></span> below_monic_fun_K <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"below_monic_cfun <span class="free">f</span> <span class="main">⟹</span> below_monic_cfun <span class="main">(</span><span class="keyword1">Λ</span> c<span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">f</span><span class="main">⋅</span><span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_monicI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_below_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> below_monicE<span class="main">)</span>

<span class="keyword1" id="Basis-below_monic_cfcomp2"><span class="command">lemma</span></span> below_monic_cfcomp2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> below_monic_cfun <span class="free">f</span><span class="main">;</span> below_monic_cfun <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span> below_monic_cfun <span class="main">(</span><span class="free">f</span> <span class="keyword1">oo</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_monicI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_below_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_monicE<span class="main">)</span>

<span class="keyword1" id="Basis-below_monic_pair"><span class="command">lemma</span></span> below_monic_pair <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> below_monic_cfun <span class="free">f</span><span class="main">;</span> below_monic_cfun <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span> below_monic_cfun <span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">⋅</span><span class="bound">x</span><span class="main">,</span> <span class="free">g</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_monicI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_below_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_monicE<span class="main">)</span>

<span class="keyword1" id="Basis-below_monic_pair_split"><span class="command">lemma</span></span> below_monic_pair_split <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> below_monic_cfun <span class="free">f</span><span class="main">;</span> below_monic_cfun <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span> below_monic_cfun <span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="free">g</span><span class="main">⋅</span><span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_monicI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_below_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_monicE<span class="main">)</span>

<span class="keyword1" id="Basis-below_monic_sinl"><span class="command">lemma</span></span> below_monic_sinl <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"below_monic_cfun sinl"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_monicI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_below_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_monicE<span class="main">)</span>

<span class="keyword1" id="Basis-below_monic_sinr"><span class="command">lemma</span></span> below_monic_sinr <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"below_monic_cfun sinr"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_monicI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_below_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_monicE<span class="main">)</span>

<span class="keyword1" id="Basis-below_monic_chain_inv"><span class="command">lemma</span></span> below_monic_chain_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>cpo <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>cpo"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="free">Y</span> <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>cpo<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Yi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"below_monic <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Y'</span><span class="main">.</span> chain <span class="bound">Y'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="bound">Y'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="bound">Y'</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">y</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chain <span class="var">?Y'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> chainI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="free">Y</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">y</span><span class="main">.</span> <span class="free">Y</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">using</span></span> spec<span class="main">[</span><span class="operator">OF</span> Yi<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> spec<span class="main">[</span><span class="operator">OF</span> Yi<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> someI2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> someI2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_monicE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> chain_mono<span class="main">[</span><span class="operator">OF</span> Y<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> Yi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="var">?Y'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="var">?Y'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> someI_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Basis-adm_below_monic_exists"><span class="command">lemma</span></span> adm_below_monic_exists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> adm <span class="free">P</span><span class="main">;</span> below_monic <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>cpo <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>cpo<span class="main">)</span><span class="main">;</span> cont <span class="free">f</span> <span class="main">⟧</span> <span class="main">⟹</span> adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> admI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> below_monic_chain_inv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> admD cont2contlubE lub_eq<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Logical_Relations">
<div class="head">
<h1>Theory Logical_Relations</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Logical_Relations.thy
    Author:     Peter Gammie
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Pitts's method for solving recursive domain predicates›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">theory</span></span> Logical_Relations
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Basis">Basis</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We adopt the general theory of \citet{PittsAM:relpod} for solving
recursive domain predicates. This is based on the idea of
\emph{minimal invariants} that \citet[Def 2]{DBLP:conf/mfps/Pitts93}
ascribes ``essentially to D. Scott''.

Ideally we would like to do the proofs once and use Pitts's
\emph{relational structures}. Unfortunately it seems we need
higher-order polymorphism (type functions) to make this work (but see
\citet{Huffman:MonadTransformers:2012}). Here we develop three
versions, one for each of our applications. The proofs are similar
(but not quite identical) in all cases.

We begin by defining an \emph{admissible} set (aka an \emph{inclusive
predicate}) to be one that contains <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊥</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and is closed under
countable chains:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">admS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>pcpo set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">admS</span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">R</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">.</span> <span class="main">⊥</span> <span class="main">∈</span> <span class="bound">R</span> <span class="main">∧</span> adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">R</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="quoted">pcpo</span><span class="main">)</span> admS <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>pcpo set <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> admS <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> unlr mklr <span class="keyword1"><span class="command">unfolding</span></span> admS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

These sets form a complete lattice.

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="Logical_Relations-admSI"><span class="command">lemma</span></span> admSI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⊥</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">∈</span> admS"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> admS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logical_Relations-bottom_in_unlr"><span class="command">lemma</span></span> bottom_in_unlr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">∈</span> unlr <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> admS.unlr <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admS_def<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-adm_unlr"><span class="command">lemma</span></span> adm_unlr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> unlr <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> admS.unlr <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admS_def<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-adm_cont_unlr"><span class="command">lemma</span></span> adm_cont_unlr <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∈</span> unlr <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> adm_subst<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> admS.mklr_inverse<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">]</span>

<span class="keyword1"><span class="command">instantiation</span></span> admS <span class="main">::</span> <span class="main">(</span><span class="quoted">pcpo</span><span class="main">)</span> <span class="quoted">order</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> unlr <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊆</span> unlr <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> unlr <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊂</span> unlr <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_admS_def less_admS_def admS.unlr_inject<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Logical_Relations-mklr_leq"><span class="command">lemma</span></span> mklr_leq <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∈</span> admS<span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> admS <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>mklr <span class="free">x</span> <span class="main">≤</span> mklr <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">≤</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_admS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logical_Relations-unlr_leq"><span class="command">lemma</span></span> unlr_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unlr <span class="free">x</span> <span class="main">≤</span> unlr <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">≤</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_admS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instantiation</span></span> admS <span class="main">::</span> <span class="main">(</span><span class="quoted">pcpo</span><span class="main">)</span> <span class="quoted">lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"inf <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> mklr <span class="main">(</span>unlr <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∩</span> unlr <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"sup <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> mklr <span class="main">(</span>unlr <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∪</span> unlr <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Logical_Relations-unlr_inf"><span class="command">lemma</span></span> unlr_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"unlr <span class="main">(</span>inf <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> unlr <span class="free">x</span> <span class="main">∩</span> unlr <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inf_admS_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admS_def<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-unlr_sup"><span class="command">lemma</span></span> unlr_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"unlr <span class="main">(</span>sup <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> unlr <span class="free">x</span> <span class="main">∪</span> unlr <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sup_admS_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admS_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_admS_def unlr_inf unlr_sup<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> admS <span class="main">::</span> <span class="main">(</span><span class="quoted">pcpo</span><span class="main">)</span> <span class="quoted">bounded_lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">bot_admS</span></span> <span class="main">≡</span> mklr <span class="main">{</span><span class="main">⊥</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Logical_Relations-unlr_bot"><span class="command">lemma</span></span> unlr_bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unlr bot <span class="main">=</span> <span class="main">{</span><span class="main">⊥</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admS_def bot_admS_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">top_admS</span></span> <span class="main">≡</span> mklr UNIV"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> admS"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bot <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bot_admS_def less_eq_admS_def admS_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> admS"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> top"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> top_admS_def less_eq_admS_def admS_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> admS <span class="main">::</span> <span class="main">(</span><span class="quoted">pcpo</span><span class="main">)</span> <span class="quoted">complete_lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"Inf <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> mklr <span class="main">(</span>Inf <span class="main">(</span>unlr <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"Sup <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">::</span><span class="tfree">'a</span> admS set<span class="main">)</span> <span class="main">=</span> Inf <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Logical_Relations-mklr_Inf"><span class="command">lemma</span></span> mklr_Inf<span class="main">:</span> <span class="quoted"><span class="quoted">"unlr <span class="main">(</span>Inf <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Inf <span class="main">(</span>unlr <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Inf_admS_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admS_def<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-INT_admS_bot"><span class="command">lemma</span></span> INT_admS_bot <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋂</span><span class="bound">R</span><span class="main">.</span> unlr <span class="bound">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">⊥</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> singletonE unlr_bot<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
      less_eq_admS_def mklr_Inf Sup_admS_def
      Inf_admS_def bot_admS_def top_admS_def admS_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Sets of vectors›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The simplest case involves the recursive definition of a set of
vectors over a single domain. This involves taking the fixed point of
a functor where the \emph{positive} (covariant) occurrences of the
recursion variable are separated from the \emph{negative}
(contravariant) ones. (See \S\ref{sec:por} etc. for examples.)

By dually ordering the negative uses of the recursion variable the
functor is made monotonic with respect to the order on the domain
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'d</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Here the type constructor <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> dual"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> yields a type
with the same elements as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> but with the reverse order. The
functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"dual"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"undual"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> mediate the isomorphism.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'d</span> lf_rep <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> admS dual <span class="main">×</span> <span class="tfree">'d</span> admS <span class="main">⇒</span> <span class="tfree">'d</span> set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'d</span> lf <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> admS dual <span class="main">×</span> <span class="tfree">'d</span> admS <span class="main">⇒</span> <span class="tfree">'d</span> admS"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">eRSV</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> encodes our notion of relation.  (This is
Pitts's <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>e : R ⊂ S›</span></span></span></span>.) We model a vector as a function from
some index type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the domain <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'d</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Note that the
minimal invariant is for the domain <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'d</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> only.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">eRSV</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span><span class="main">::</span>pcpo <span class="main">→</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>type <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> admS dual <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> admS <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eRSV</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">d</span> <span class="main">∈</span> unlr <span class="main">(</span>undual <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="bound">d</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unlr <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

In general we can also assume that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> here is strict, but we
do not need to do so for our examples.

Our locale captures the key ingredients in Pitts's scheme:
\begin{itemize}

\item that the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">δ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a minimal invariant;

\item that the functor defining the relation is suitably monotonic; and

\item that the functor is closed with respect to the minimal invariant.

\end{itemize}

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> DomSol <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order dual <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>order <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> monoF<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">F</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sym_lr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dual <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> dual <span class="main">×</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sym_lr</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">rm</span><span class="main">,</span> <span class="bound">rp</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>dual <span class="main">(</span><span class="free">F</span> <span class="main">(</span>dual <span class="bound">rp</span><span class="main">,</span> undual <span class="bound">rm</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">F</span> <span class="main">(</span><span class="bound">rm</span><span class="main">,</span> <span class="bound">rp</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Logical_Relations-sym_lr_mono"><span class="command">lemma</span></span> sym_lr_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mono sym_lr"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dual <span class="main">×</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="skolem"><span class="skolem">y1</span></span> <span class="skolem"><span class="skolem">y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> monoF <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">F</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dual <span class="skolem">y2</span><span class="main">,</span> undual <span class="skolem">y1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>dual <span class="skolem">x2</span><span class="main">,</span> undual <span class="skolem">x1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dual_less_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> monoF <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">(</span>dual <span class="skolem">y2</span><span class="main">,</span> undual <span class="skolem">y1</span><span class="main">)</span> <span class="main">≤</span> <span class="free">F</span> <span class="main">(</span>dual <span class="skolem">x2</span><span class="main">,</span> undual <span class="skolem">x1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">F</span> <span class="skolem">y</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sym_lr <span class="skolem">x</span> <span class="main">≤</span> sym_lr <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sym_lr_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> DomSolV <span class="main">=</span> DomSol <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>type <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">::</span>pcpo<span class="main">)</span> lf"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">F</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span><span class="main">::</span>pcpo <span class="main">→</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">→</span> <span class="tfree">'d</span> <span class="main">→</span> <span class="tfree">'d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> min_inv_ID<span class="main">:</span> <span class="quoted"><span class="quoted">"fix<span class="main">⋅</span><span class="free">δ</span> <span class="main">=</span> ID"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eRSV_deltaF<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">e</span> <span class="main">::</span> <span class="tfree">'d</span> <span class="main">→</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">(</span><span class="bound">R</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> admS dual<span class="main">)</span> <span class="main">(</span><span class="bound">S</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> admS<span class="main">)</span><span class="main">.</span>
          eRSV <span class="bound">e</span> <span class="bound">R</span> <span class="bound">S</span> <span class="main">⟹</span> eRSV <span class="main">(</span><span class="free">δ</span><span class="main">⋅</span><span class="bound">e</span><span class="main">)</span> <span class="main">(</span>dual <span class="main">(</span><span class="free">F</span> <span class="main">(</span>dual <span class="bound">S</span><span class="main">,</span> undual <span class="bound">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">(</span><span class="bound">R</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">context</span></span> DomSolV
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">f_lim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> admS dual <span class="main">×</span> <span class="main">(</span><span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> admS"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f_lim</span> <span class="main">≡</span> lfp sym_lr"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">delta_neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> admS dual"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delta_neg</span> <span class="main">=</span> fst f_lim"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">delta_pos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> admS"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delta_pos</span> <span class="main">=</span> snd f_lim"</span></span>

<span class="keyword1" id="Logical_Relations-delta"><span class="command">lemma</span></span> delta<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>delta_neg<span class="main">,</span> delta_pos<span class="main">)</span> <span class="main">=</span> f_lim"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delta_neg_def delta_pos_def<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-delta_neg_sol"><span class="command">lemma</span></span> delta_neg_sol<span class="main">:</span>
  <span class="quoted"><span class="quoted">"delta_neg <span class="main">=</span> dual <span class="main">(</span><span class="free">F</span> <span class="main">(</span>dual delta_pos<span class="main">,</span> undual delta_neg<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_unfold delta_neg_def delta_pos_def fst_conv lfp_unfold sym_lr_def sym_lr_mono<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-delta_pos_sol"><span class="command">lemma</span></span> delta_pos_sol<span class="main">:</span>
  <span class="quoted"><span class="quoted">"delta_pos <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>delta_neg<span class="main">,</span> delta_pos<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_conv delta lfp_unfold snd_conv sym_lr_def sym_lr_mono<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-delta_pos_neg_least"><span class="command">lemma</span></span> delta_pos_neg_least<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rm</span> <span class="main">≤</span> <span class="free">F</span> <span class="main">(</span>dual <span class="free">rp</span><span class="main">,</span> <span class="free">rm</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">(</span>dual <span class="free">rm</span><span class="main">,</span> <span class="free">rp</span><span class="main">)</span> <span class="main">≤</span> <span class="free">rp</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"delta_neg <span class="main">≤</span> dual <span class="free">rm</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"delta_pos <span class="main">≤</span> <span class="free">rp</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> rm rp
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>delta_neg<span class="main">,</span> delta_pos<span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>dual <span class="free">rm</span><span class="main">,</span> <span class="free">rp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delta lfp_lowerbound sym_lr_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"delta_neg <span class="main">≤</span> dual <span class="free">rm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"delta_pos <span class="main">≤</span> <span class="free">rp</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logical_Relations-delta_eq"><span class="command">lemma</span></span> delta_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"undual delta_neg <span class="main">=</span> delta_pos"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"delta_pos <span class="main">≤</span> undual delta_neg"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> delta_neg_sol delta_pos_neg_least<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> delta_pos_sol order_refl undual_dual<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eRSV <span class="bound">x</span> <span class="main">(</span>delta_neg<span class="main">)</span> <span class="main">(</span>delta_pos<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>fix<span class="main">⋅</span><span class="free">δ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fix_ind<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inst_fun_pcpo<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> delta_neg_sol delta_pos_sol eRSV_deltaF<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> min_inv_ID
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"undual delta_neg <span class="main">≤</span> delta_pos"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unlr_leq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

From these assumptions we can show that there is a unique object that
is a solution to the recursive equation specified by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">F</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">delta</span> <span class="main">≡</span> delta_pos"</span></span>

<span class="keyword1" id="Logical_Relations-delta_sol"><span class="command">lemma</span></span> delta_sol<span class="main">:</span> <span class="quoted"><span class="quoted">"delta <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>dual delta<span class="main">,</span> delta<span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">unfolding</span></span> delta_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> delta_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> delta_pos_sol<span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1" id="Logical_Relations-delta_unique"><span class="command">lemma</span></span> delta_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">(</span>dual <span class="free">r</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> delta"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">unfolding</span></span> delta_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"delta_pos <span class="main">≤</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delta_pos_neg_least<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> rm<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> rp<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"delta_neg <span class="main">≤</span> dual <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delta_pos_neg_least<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> rm<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> rp<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> undual delta_neg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_dual_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> delta_pos"</span></span>
    <span class="keyword1"><span class="command">using</span></span> delta_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We use this to show certain functions are not PCF-definable in
\S\ref{sec:pcfdefinability}.

›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Relations between domains and syntax›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:synlr}

To show computational adequacy (\S\ref{sec:compad}) we need to relate
elements of a domain to their syntactic counterparts. An advantage of
Pitts's technique is that this is straightforward to do.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">synlr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span><span class="main">::</span>pcpo <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>type<span class="main">)</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">synlr</span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">R</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set<span class="main">.</span> <span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span> <span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">R</span> <span class="main">}</span> <span class="main">∈</span> admS <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="tfree">'d</span><span class="main">::</span><span class="quoted">pcpo</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">::</span><span class="quoted">type</span><span class="main">)</span> synlr <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">x</span><span class="main">::</span><span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set<span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> synlr <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> unsynlr mksynlr <span class="keyword1"><span class="command">unfolding</span></span> synlr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

An alternative representation (suggested by Brian Huffman) is to
directly use the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> <span class="main"><span class="main">⇒</span></span> <span class="tfree"><span class="tfree">'b</span></span> admS"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as this is automatically
a complete lattice. However we end up fighting the automatic methods a
lot.

›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1" id="Logical_Relations-synlrI"><span class="command">lemma</span></span> synlrI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="main">⊥</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">∈</span> synlr"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> synlr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Logical_Relations-bottom_in_unsynlr"><span class="command">lemma</span></span> bottom_in_unsynlr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⊥</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> unsynlr <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> synlr.unsynlr <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> synlr_def admS_def<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-adm_unsynlr"><span class="command">lemma</span></span> adm_unsynlr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> unsynlr <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> synlr.unsynlr<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> synlr_def admS_def<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-adm_cont_unsynlr"><span class="command">lemma</span></span> adm_cont_unsynlr <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> unsynlr <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> adm_subst<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> synlr.mksynlr_inverse<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Lattice machinery.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> synlr <span class="main">::</span> <span class="main">(</span><span class="quoted">pcpo</span><span class="main">,</span> <span class="quoted">type</span><span class="main">)</span> <span class="quoted">order</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> unsynlr <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> unsynlr <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> unsynlr <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> unsynlr <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_synlr_def less_synlr_def synlr.unsynlr_inject<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Logical_Relations-mksynlr_leq"><span class="command">lemma</span></span> mksynlr_leq <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∈</span> synlr<span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> synlr <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>mksynlr <span class="free">x</span> <span class="main">≤</span> mksynlr <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">≤</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_synlr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Logical_Relations-unsynlr_leq"><span class="command">lemma</span></span> unsynlr_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unsynlr <span class="free">x</span> <span class="main">≤</span> unsynlr <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">≤</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_synlr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instantiation</span></span> synlr <span class="main">::</span> <span class="main">(</span><span class="quoted">pcpo</span><span class="main">,</span> <span class="quoted">type</span><span class="main">)</span> <span class="quoted">lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"inf <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> mksynlr <span class="main">(</span>unsynlr <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∩</span> unsynlr <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"sup <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> mksynlr <span class="main">(</span>unsynlr <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∪</span> unsynlr <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Logical_Relations-unsynlr_inf"><span class="command">lemma</span></span> unsynlr_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"unsynlr <span class="main">(</span>inf <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> unsynlr <span class="free">x</span> <span class="main">∩</span> unsynlr <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inf_synlr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admS_def synlr_def<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-unsynlr_sup"><span class="command">lemma</span></span> unsynlr_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"unsynlr <span class="main">(</span>sup <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> unsynlr <span class="free">x</span> <span class="main">∪</span> unsynlr <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sup_synlr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admS_def synlr_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_synlr_def unsynlr_inf unsynlr_sup<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> synlr <span class="main">::</span> <span class="main">(</span><span class="quoted">pcpo</span><span class="main">,</span> <span class="quoted">type</span><span class="main">)</span> <span class="quoted">bounded_lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">bot_synlr</span></span> <span class="main">≡</span> mksynlr <span class="main">(</span><span class="main">{</span><span class="main">⊥</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>

<span class="keyword1" id="Logical_Relations-unsynlr_bot"><span class="command">lemma</span></span> unsynlr_bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unsynlr bot <span class="main">=</span> <span class="main">{</span><span class="main">⊥</span><span class="main">}</span> <span class="main">×</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admS_def synlr_def bot_synlr_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">top_synlr</span></span> <span class="main">≡</span> mksynlr UNIV"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> synlr"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bot <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bot_synlr_def less_eq_synlr_def admS_def synlr_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> synlr"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> top"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> top_synlr_def less_eq_synlr_def admS_def synlr_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> synlr <span class="main">::</span> <span class="main">(</span><span class="quoted">pcpo</span><span class="main">,</span> <span class="quoted">type</span><span class="main">)</span> <span class="quoted">complete_lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"Inf <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> mksynlr <span class="main">(</span>Inf <span class="main">(</span>unsynlr <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"Sup <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> synlr set<span class="main">)</span> <span class="main">=</span> Inf <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Logical_Relations-mksynlr_Inf"><span class="command">lemma</span></span> mksynlr_Inf<span class="main">:</span> <span class="quoted"><span class="quoted">"unsynlr <span class="main">(</span>Inf <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Inf <span class="main">(</span>unsynlr <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Inf_synlr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admS_def synlr_def<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-INT_synlr_bot"><span class="command">lemma</span></span> INT_synlr_bot <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋂</span><span class="bound">R</span><span class="main">.</span> unsynlr <span class="bound">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">⊥</span><span class="main">}</span> <span class="main">×</span> UNIV"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"mksynlr <span class="main"><span class="main">(</span></span><span class="main"><span class="main">{</span></span><span class="main"><span class="main">⊥</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">×</span></span> UNIV<span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> bot_synlr_def mem_Sigma_iff singletonE unsynlr_bot<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_synlr_def mksynlr_Inf Sup_synlr_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_synlr_def bot_synlr_def top_synlr_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Again we define functors on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'d</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'a</span></span><span class="main"><span class="main">)</span></span> synlr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> synlf_rep <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> synlr dual <span class="main">×</span> <span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> synlr <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> synlf <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> synlr dual <span class="main">×</span> <span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> synlr <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> synlr"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We capture our relations as before. Note we need the inclusion <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to be strict for our example.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">eRSS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span><span class="main">::</span>pcpo <span class="main">→</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">::</span>type<span class="main">)</span> synlr dual <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> synlr <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eRSS</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> unsynlr <span class="main">(</span>undual <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">d</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> unsynlr <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> DomSolSyn <span class="main">=</span>  DomSol <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'d</span><span class="main">::</span>pcpo<span class="main">,</span> <span class="tfree">'a</span><span class="main">::</span>type<span class="main">)</span> synlf"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">F</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span><span class="main">::</span>pcpo <span class="main">→</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">→</span> <span class="tfree">'d</span> <span class="main">→</span> <span class="tfree">'d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> min_inv_ID<span class="main">:</span> <span class="quoted"><span class="quoted">"fix<span class="main">⋅</span><span class="free">δ</span> <span class="main">=</span> ID"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> min_inv_strict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">δ</span><span class="main">⋅</span><span class="bound">r</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eRS_deltaF<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">e</span> <span class="main">::</span> <span class="tfree">'d</span> <span class="main">→</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">(</span><span class="bound">R</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> synlr dual<span class="main">)</span> <span class="main">(</span><span class="bound">S</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> synlr<span class="main">)</span><span class="main">.</span>
          <span class="main">⟦</span> <span class="bound">e</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">;</span> eRSS <span class="bound">e</span> <span class="bound">R</span> <span class="bound">S</span> <span class="main">⟧</span> <span class="main">⟹</span> eRSS <span class="main">(</span><span class="free">δ</span><span class="main">⋅</span><span class="bound">e</span><span class="main">)</span> <span class="main">(</span>dual <span class="main">(</span><span class="free">F</span> <span class="main">(</span>dual <span class="bound">S</span><span class="main">,</span> undual <span class="bound">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">(</span><span class="bound">R</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">context</span></span> DomSolSyn
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">f_lim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> synlr dual <span class="main">×</span> <span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> synlr"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f_lim</span> <span class="main">≡</span> lfp sym_lr"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">delta_neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> synlr dual"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delta_neg</span> <span class="main">=</span> fst f_lim"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">delta_pos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> synlr"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delta_pos</span> <span class="main">=</span> snd f_lim"</span></span>

<span class="keyword1" id="Logical_Relations-delta"><span class="command">lemma</span></span> delta<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>delta_neg<span class="main">,</span> delta_pos<span class="main">)</span> <span class="main">=</span> f_lim"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delta_neg_def delta_pos_def<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-delta_neg_sol"><span class="command">lemma</span></span> delta_neg_sol<span class="main">:</span>
  <span class="quoted"><span class="quoted">"delta_neg <span class="main">=</span> dual <span class="main">(</span><span class="free">F</span> <span class="main">(</span>dual delta_pos<span class="main">,</span> undual delta_neg<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_unfold delta_neg_def delta_pos_def fst_conv lfp_unfold sym_lr_def sym_lr_mono<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-delta_pos_sol"><span class="command">lemma</span></span> delta_pos_sol<span class="main">:</span>
  <span class="quoted"><span class="quoted">"delta_pos <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>delta_neg<span class="main">,</span> delta_pos<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_conv delta lfp_unfold snd_conv sym_lr_def sym_lr_mono<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-delta_pos_neg_least"><span class="command">lemma</span></span> delta_pos_neg_least<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rm</span> <span class="main">≤</span> <span class="free">F</span> <span class="main">(</span>dual <span class="free">rp</span><span class="main">,</span> <span class="free">rm</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">(</span>dual <span class="free">rm</span><span class="main">,</span> <span class="free">rp</span><span class="main">)</span> <span class="main">≤</span> <span class="free">rp</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"delta_neg <span class="main">≤</span> dual <span class="free">rm</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"delta_pos <span class="main">≤</span> <span class="free">rp</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> rm rp
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>delta_neg<span class="main">,</span> delta_pos<span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>dual <span class="free">rm</span><span class="main">,</span> <span class="free">rp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delta lfp_lowerbound sym_lr_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"delta_neg <span class="main">≤</span> dual <span class="free">rm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"delta_pos <span class="main">≤</span> <span class="free">rp</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logical_Relations-delta_eq"><span class="command">lemma</span></span> delta_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"undual delta_neg <span class="main">=</span> delta_pos"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"delta_pos <span class="main">≤</span> undual delta_neg"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> delta_neg_sol delta_pos_neg_least<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> delta_pos_sol order_refl undual_dual<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">∧</span> eRSS <span class="bound">x</span> <span class="main">(</span>delta_neg<span class="main">)</span> <span class="main">(</span>delta_pos<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>fix<span class="main">⋅</span><span class="free">δ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fix_ind<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> delta_neg_sol delta_pos_sol eRS_deltaF min_inv_strict<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> min_inv_ID
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"undual delta_neg <span class="main">≤</span> delta_pos"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unsynlr_leq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delta</span> <span class="main">≡</span> delta_pos"</span></span>

<span class="keyword1" id="Logical_Relations-delta_sol"><span class="command">lemma</span></span> delta_sol<span class="main">:</span>
  <span class="quoted"><span class="quoted">"delta <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>dual delta<span class="main">,</span> delta<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> delta_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> delta_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> delta_pos_sol<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-delta_unique"><span class="command">lemma</span></span> delta_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">(</span>dual <span class="free">r</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> delta"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> delta_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"delta_pos <span class="main">≤</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delta_pos_neg_least<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> rm<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> rp<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"delta_neg <span class="main">≤</span> dual <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delta_pos_neg_least<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> rm<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> rp<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> undual delta_neg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_dual_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> delta_pos"</span></span>
    <span class="keyword1"><span class="command">using</span></span> delta_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Again, from these assumptions we can construct the unique solution to
the recursive equation specified by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">F</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Relations between pairs of domains›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Following \citet{DBLP:conf/icalp/Reynolds74} and
\citet{DBLP:journals/tcs/Filinski07}, we want to relate two pairs of
mutually-recursive domains. Each of the pairs represents a (monadic)
computation and value space.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'am</span><span class="main">,</span> <span class="tfree">'bm</span><span class="main">,</span> <span class="tfree">'av</span><span class="main">,</span> <span class="tfree">'bv</span><span class="main">)</span> lr_pair <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'am</span> <span class="main">×</span> <span class="tfree">'bm</span><span class="main">)</span> admS <span class="main">×</span> <span class="main">(</span><span class="tfree">'av</span> <span class="main">×</span> <span class="tfree">'bv</span><span class="main">)</span> admS"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'am</span><span class="main">,</span> <span class="tfree">'bm</span><span class="main">,</span> <span class="tfree">'av</span><span class="main">,</span> <span class="tfree">'bv</span><span class="main">)</span> lf_pair_rep <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'am</span><span class="main">,</span> <span class="tfree">'bm</span><span class="main">,</span> <span class="tfree">'av</span><span class="main">,</span> <span class="tfree">'bv</span><span class="main">)</span> lr_pair dual <span class="main">×</span> <span class="main">(</span><span class="tfree">'am</span><span class="main">,</span> <span class="tfree">'bm</span><span class="main">,</span> <span class="tfree">'av</span><span class="main">,</span> <span class="tfree">'bv</span><span class="main">)</span> lr_pair <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'am</span> <span class="main">×</span> <span class="tfree">'bm</span><span class="main">)</span> set <span class="main">×</span> <span class="main">(</span><span class="tfree">'av</span> <span class="main">×</span> <span class="tfree">'bv</span><span class="main">)</span> set<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'am</span><span class="main">,</span> <span class="tfree">'bm</span><span class="main">,</span> <span class="tfree">'av</span><span class="main">,</span> <span class="tfree">'bv</span><span class="main">)</span> lf_pair <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'am</span><span class="main">,</span> <span class="tfree">'bm</span><span class="main">,</span> <span class="tfree">'av</span><span class="main">,</span> <span class="tfree">'bv</span><span class="main">)</span> lr_pair dual <span class="main">×</span> <span class="main">(</span><span class="tfree">'am</span><span class="main">,</span> <span class="tfree">'bm</span><span class="main">,</span> <span class="tfree">'av</span><span class="main">,</span> <span class="tfree">'bv</span><span class="main">)</span> lr_pair <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'am</span> <span class="main">×</span> <span class="tfree">'bm</span><span class="main">)</span> admS <span class="main">×</span> <span class="main">(</span><span class="tfree">'av</span> <span class="main">×</span> <span class="tfree">'bv</span><span class="main">)</span> admS<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The inclusions need to be strict to get our example through.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">eRSP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'am</span><span class="main">::</span>pcpo <span class="main">→</span> <span class="tfree">'am</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'av</span><span class="main">::</span>pcpo <span class="main">→</span> <span class="tfree">'av</span><span class="main">)</span><span class="main">)</span>
       <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'bm</span><span class="main">::</span>pcpo <span class="main">→</span> <span class="tfree">'bm</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'bv</span><span class="main">::</span>pcpo <span class="main">→</span> <span class="tfree">'bv</span><span class="main">)</span><span class="main">)</span>
       <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'am</span> <span class="main">×</span> <span class="tfree">'bm</span><span class="main">)</span> admS <span class="main">×</span> <span class="main">(</span><span class="tfree">'av</span> <span class="main">×</span> <span class="tfree">'bv</span><span class="main">)</span> admS<span class="main">)</span> dual
       <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'am</span> <span class="main">×</span> <span class="tfree">'bm</span><span class="main">)</span> admS <span class="main">×</span> <span class="main">(</span><span class="tfree">'av</span> <span class="main">×</span> <span class="tfree">'bv</span><span class="main">)</span> admS
       <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eRSP</span> <span class="free"><span class="bound"><span class="entity">ea</span></span></span> <span class="free"><span class="bound"><span class="entity">eb</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">am</span><span class="main">,</span> <span class="bound">bm</span><span class="main">)</span> <span class="main">∈</span> unlr <span class="main">(</span>fst <span class="main">(</span>undual <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">ea</span></span></span><span class="main">⋅</span><span class="bound">am</span><span class="main">,</span> fst <span class="free"><span class="bound"><span class="entity">eb</span></span></span><span class="main">⋅</span><span class="bound">bm</span><span class="main">)</span> <span class="main">∈</span> unlr <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">av</span><span class="main">,</span> <span class="bound">bv</span><span class="main">)</span> <span class="main">∈</span> unlr <span class="main">(</span>snd <span class="main">(</span>undual <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">ea</span></span></span><span class="main">⋅</span><span class="bound">av</span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">eb</span></span></span><span class="main">⋅</span><span class="bound">bv</span><span class="main">)</span> <span class="main">∈</span> unlr <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> DomSolP <span class="main">=</span> DomSol <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'am</span><span class="main">::</span>pcpo<span class="main">,</span> <span class="tfree">'bm</span><span class="main">::</span>pcpo<span class="main">,</span> <span class="tfree">'av</span><span class="main">::</span>pcpo<span class="main">,</span> <span class="tfree">'bv</span><span class="main">::</span>pcpo<span class="main">)</span> lf_pair"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">F</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ad</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'am</span> <span class="main">→</span> <span class="tfree">'am</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'av</span> <span class="main">→</span> <span class="tfree">'av</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'am</span> <span class="main">→</span> <span class="tfree">'am</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'av</span> <span class="main">→</span> <span class="tfree">'av</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">bd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'bm</span> <span class="main">→</span> <span class="tfree">'bm</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'bv</span> <span class="main">→</span> <span class="tfree">'bv</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'bm</span> <span class="main">→</span> <span class="tfree">'bm</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'bv</span> <span class="main">→</span> <span class="tfree">'bv</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ad_ID<span class="main">:</span> <span class="quoted"><span class="quoted">"fix<span class="main">⋅</span><span class="free">ad</span> <span class="main">=</span> <span class="main">(</span>ID<span class="main">,</span> ID<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bd_ID<span class="main">:</span> <span class="quoted"><span class="quoted">"fix<span class="main">⋅</span><span class="free">bd</span> <span class="main">=</span> <span class="main">(</span>ID<span class="main">,</span> ID<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ad_strict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> fst <span class="main">(</span><span class="free">ad</span><span class="main">⋅</span><span class="bound">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> snd <span class="main">(</span><span class="free">ad</span><span class="main">⋅</span><span class="bound">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bd_strict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> fst <span class="main">(</span><span class="free">bd</span><span class="main">⋅</span><span class="bound">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> snd <span class="main">(</span><span class="free">bd</span><span class="main">⋅</span><span class="bound">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eRSP_deltaF<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> eRSP <span class="free">ea</span> <span class="free">eb</span> <span class="free">R</span> <span class="free">S</span><span class="main">;</span> fst <span class="free">ea</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">;</span> snd <span class="free">ea</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">;</span> fst <span class="free">eb</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">;</span> snd <span class="free">ea</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟧</span>
      <span class="main">⟹</span> eRSP <span class="main">(</span><span class="free">ad</span><span class="main">⋅</span><span class="free">ea</span><span class="main">)</span> <span class="main">(</span><span class="free">bd</span><span class="main">⋅</span><span class="free">eb</span><span class="main">)</span> <span class="main">(</span>dual <span class="main">(</span><span class="free">F</span> <span class="main">(</span>dual <span class="free">S</span><span class="main">,</span> undual <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">(</span><span class="free">R</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">context</span></span> DomSolP
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">f_lim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'am</span><span class="main">,</span> <span class="tfree">'bm</span><span class="main">,</span> <span class="tfree">'av</span><span class="main">,</span> <span class="tfree">'bv</span><span class="main">)</span> lr_pair dual <span class="main">×</span> <span class="main">(</span><span class="tfree">'am</span><span class="main">,</span> <span class="tfree">'bm</span><span class="main">,</span> <span class="tfree">'av</span><span class="main">,</span> <span class="tfree">'bv</span><span class="main">)</span> lr_pair"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f_lim</span> <span class="main">≡</span> lfp sym_lr"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">delta_neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'am</span><span class="main">,</span> <span class="tfree">'bm</span><span class="main">,</span> <span class="tfree">'av</span><span class="main">,</span> <span class="tfree">'bv</span><span class="main">)</span> lr_pair dual"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delta_neg</span> <span class="main">=</span> fst f_lim"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">delta_pos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'am</span><span class="main">,</span> <span class="tfree">'bm</span><span class="main">,</span> <span class="tfree">'av</span><span class="main">,</span> <span class="tfree">'bv</span><span class="main">)</span> lr_pair"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delta_pos</span> <span class="main">=</span> snd f_lim"</span></span>

<span class="keyword1" id="Logical_Relations-delta"><span class="command">lemma</span></span> delta<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>delta_neg<span class="main">,</span> delta_pos<span class="main">)</span> <span class="main">=</span> f_lim"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delta_neg_def delta_pos_def<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-delta_neg_sol"><span class="command">lemma</span></span> delta_neg_sol<span class="main">:</span>
  <span class="quoted"><span class="quoted">"delta_neg <span class="main">=</span> dual <span class="main">(</span><span class="free">F</span> <span class="main">(</span>dual delta_pos<span class="main">,</span> undual delta_neg<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_unfold delta_neg_def delta_pos_def fst_conv lfp_unfold sym_lr_def sym_lr_mono<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-delta_pos_sol"><span class="command">lemma</span></span> delta_pos_sol<span class="main">:</span>
  <span class="quoted"><span class="quoted">"delta_pos <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>delta_neg<span class="main">,</span> delta_pos<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_conv delta lfp_unfold snd_conv sym_lr_def sym_lr_mono<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-delta_pos_neg_least"><span class="command">lemma</span></span> delta_pos_neg_least<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rm</span> <span class="main">≤</span> <span class="free">F</span> <span class="main">(</span>dual <span class="free">rp</span><span class="main">,</span> <span class="free">rm</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">(</span>dual <span class="free">rm</span><span class="main">,</span> <span class="free">rp</span><span class="main">)</span> <span class="main">≤</span> <span class="free">rp</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"delta_neg <span class="main">≤</span> dual <span class="free">rm</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"delta_pos <span class="main">≤</span> <span class="free">rp</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> rm rp
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>delta_neg<span class="main">,</span> delta_pos<span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>dual <span class="free">rm</span><span class="main">,</span> <span class="free">rp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delta lfp_lowerbound sym_lr_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"delta_neg <span class="main">≤</span> dual <span class="free">rm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"delta_pos <span class="main">≤</span> <span class="free">rp</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logical_Relations-delta_eq"><span class="command">lemma</span></span> delta_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"undual delta_neg <span class="main">=</span> delta_pos"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"delta_pos <span class="main">≤</span> undual delta_neg"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> delta_neg_sol delta_pos_neg_least<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> delta_pos_sol order_refl undual_dual<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">ea</span><span class="main">,</span> <span class="bound">eb</span><span class="main">)</span><span class="main">.</span> eRSP <span class="bound">ea</span> <span class="bound">eb</span> <span class="main">(</span>delta_neg<span class="main">)</span> <span class="main">(</span>delta_pos<span class="main">)</span> <span class="main">∧</span> fst <span class="bound">ea</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">∧</span> snd <span class="bound">ea</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">∧</span> fst <span class="bound">eb</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">∧</span> snd <span class="bound">eb</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>fix<span class="main">⋅</span><span class="free">ad</span><span class="main">,</span> fix<span class="main">⋅</span><span class="free">bd</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_fix_ind<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">using</span></span> ad_strict bd_strict
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> ea<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">a</span><span class="main">,</span> <span class="improper">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> eb<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">aa</span><span class="main">,</span> <span class="improper">ba</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> eRSP_deltaF<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">delta_neg</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">delta_pos</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delta_pos_sol<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> delta_neg_sol<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> delta_neg_sol<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="main">(</span>ID<span class="main">,</span> ID<span class="main">)</span><span class="main">,</span> <span class="main">(</span>ID<span class="main">,</span> ID<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ad_ID bd_ID<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"undual delta_neg <span class="main">≤</span> delta_pos"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unlr_leq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> less_eq_prod_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delta</span> <span class="main">≡</span> delta_pos"</span></span>

<span class="keyword1" id="Logical_Relations-delta_sol"><span class="command">lemma</span></span> delta_sol<span class="main">:</span>
  <span class="quoted"><span class="quoted">"delta <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>dual delta<span class="main">,</span> delta<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> delta_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> delta_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> delta_pos_sol<span class="main">)</span>

<span class="keyword1" id="Logical_Relations-delta_unique"><span class="command">lemma</span></span> delta_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">(</span>dual <span class="free">r</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> delta"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> delta_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"delta_pos <span class="main">≤</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delta_pos_neg_least<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> rm<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> rp<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"delta_neg <span class="main">≤</span> dual <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delta_pos_neg_least<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> rm<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> rp<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> undual delta_neg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_dual_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> delta_pos"</span></span>
    <span class="keyword1"><span class="command">using</span></span> delta_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We use this solution to relate the direct and continuation semantics
for PCF in \S\ref{sec:continuations}.

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="PCF">
<div class="head">
<h1>Theory PCF</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      PCF.thy
    Author:     Peter Gammie
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Logical relations for definability in PCF›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">theory</span></span> PCF
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Basis">Basis</a>
  <a href="#Logical_Relations">Logical_Relations</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:directsem}

Using this machinery we can demonstrate some classical results about
PCF \citep{Plotkin77}. We diverge from the traditional treatment by
considering PCF as an untyped language and including both call-by-name
(CBN) and call-by-value (CBV) abstractions following
\citet{DBLP:conf/icalp/Reynolds74}. We also adopt some of the
presentation of \citet[Chapter~11]{Winskel:1993}, in particular by
making the fixed point operator a binding construct.

We model the syntax of PCF as a HOL datatype, where variables have
names drawn from the naturals:

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> var <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">datatype</span></span> expr <span class="main">=</span>
    Var <span class="quoted">var</span>
  <span class="main">|</span> App <span class="quoted">expr</span> <span class="quoted">expr</span>
  <span class="main">|</span> AbsN <span class="quoted">var</span> <span class="quoted">expr</span> <span class="comment1">(* non-strict fns *)</span>
  <span class="main">|</span> AbsV <span class="quoted">var</span> <span class="quoted">expr</span> <span class="comment1">(* strict fns *)</span>
  <span class="main">|</span> Diverge <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">Ω</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span>
  <span class="main">|</span> Fix <span class="quoted">var</span> <span class="quoted">expr</span>
  <span class="main">|</span> tt
  <span class="main">|</span> ff
  <span class="main">|</span> Cond <span class="quoted">expr</span> <span class="quoted">expr</span> <span class="quoted">expr</span>
  <span class="main">|</span> Num <span class="quoted">nat</span>
  <span class="main">|</span> Succ <span class="quoted">expr</span>
  <span class="main">|</span> Pred <span class="quoted">expr</span>
  <span class="main">|</span> IsZero <span class="quoted">expr</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Direct denotational semantics›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:densem}

We give this language a direct denotational semantics by interpreting
it into a domain of values.

›</span></span>

<span class="keyword1"><span class="command">domain</span></span> ValD <span class="main">=</span>
   ValF <span class="main">(</span><span class="keyword2"><span class="keyword">lazy</span></span> appF <span class="main">::</span> <span class="quoted"><span class="quoted">"ValD <span class="main">→</span> ValD"</span></span><span class="main">)</span>
 <span class="main">|</span> ValTT <span class="main">|</span> ValFF
 <span class="main">|</span> ValN <span class="main">(</span><span class="keyword2"><span class="keyword">lazy</span></span> <span class="quoted"><span class="quoted">"nat"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The \textbf{lazy} keyword means that the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ValF"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> constructor is
lifted, i.e. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ValF<span class="main"><span class="main">⋅</span></span><span class="main"><span class="main">⊥</span></span> <span class="main"><span class="main">≠</span></span> <span class="main"><span class="main">⊥</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which further means that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"ValF<span class="main"><span class="main">⋅</span></span><span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">Λ</span></span> x<span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⊥</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">≠</span></span> <span class="main"><span class="main">⊥</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

The naturals are discretely ordered.

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="PCF-ValD_case_ID"><span class="command">lemma</span></span> ValD_case_ID <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ValD_case<span class="main">⋅</span>ValF<span class="main">⋅</span>ValTT<span class="main">⋅</span>ValFF<span class="main">⋅</span>ValN <span class="main">=</span> ID"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PCF-below_monic_ValF"><span class="command">lemma</span></span> below_monic_ValF <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"below_monic_cfun ValF"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_monicI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="PCF-below_monic_ValN"><span class="command">lemma</span></span> below_monic_ValN <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"below_monic_cfun ValN"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_monicI<span class="main">)</span> <span class="operator">simp</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The minimal invariant for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"ValD"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is straightforward; the
function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"cfun_map<span class="main"><span class="main">⋅</span></span><span class="free"><span class="free">f</span></span><span class="main"><span class="main">⋅</span></span><span class="free"><span class="free">g</span></span><span class="main"><span class="main">⋅</span></span><span class="free"><span class="free">h</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> denotes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span> <span class="keyword1"><span class="keyword1">oo</span></span> <span class="free"><span class="free">h</span></span> <span class="keyword1"><span class="keyword1">oo</span></span> <span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">ValD_copy_rec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ValD <span class="main">→</span> ValD<span class="main">)</span> <span class="main">→</span> <span class="main">(</span>ValD <span class="main">→</span> ValD<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ValD_copy_rec</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⋅</span><span class="main">(</span>ValF<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> ValF<span class="main">⋅</span><span class="main">(</span>cfun_map<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ValD_copy_rec</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⋅</span><span class="main">(</span>ValTT<span class="main">)</span> <span class="main">=</span> ValTT"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ValD_copy_rec</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⋅</span><span class="main">(</span>ValFF<span class="main">)</span> <span class="main">=</span> ValFF"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ValD_copy_rec</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⋅</span><span class="main">(</span>ValN<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> ValN<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="PCF-ValD_copy_rec_strict"><span class="command">lemma</span></span> ValD_copy_rec_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ValD_copy_rec<span class="main">⋅</span><span class="free">r</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ValD_copy</span> <span class="main">≡</span> fix<span class="main">⋅</span>ValD_copy_rec"</span></span>

<span class="keyword1" id="PCF-ValD_copy_strict"><span class="command">lemma</span></span> ValD_copy_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ValD_copy<span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="PCF-ValD_copy_ID"><span class="command">lemma</span></span> ValD_copy_ID <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ValD_copy <span class="main">=</span> ID"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">ValD</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ValD_take <span class="skolem">i</span><span class="main">⋅</span><span class="main">(</span>ValD_copy<span class="main">⋅</span><span class="main">(</span>ValD_take <span class="skolem">i</span><span class="main">⋅</span><span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ValD_take <span class="skolem">i</span><span class="main">⋅</span><span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_map_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">::</span> ValD<span class="main">.</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> ValD_take <span class="bound">i</span><span class="main">⋅</span><span class="main">(</span>ValD_copy<span class="main">⋅</span><span class="main">(</span>ValD_take <span class="bound">i</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> ValD_take <span class="bound">i</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lub_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lub_distribs ValD.lub_take cfun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We interpret the PCF constants in the obvious ways. ``Ill-typed'' uses
of these combinators are mapped to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊥</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cond</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ValD <span class="main">→</span> ValD <span class="main">→</span> ValD <span class="main">→</span> ValD"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="main">≡</span> <span class="keyword1">Λ</span> i t e<span class="main">.</span> <span class="keyword1">case</span> <span class="bound">i</span> <span class="keyword1">of</span> ValF<span class="main">⋅</span><span class="bound">f</span> <span class="main">⇒</span> <span class="main">⊥</span> <span class="main">|</span> ValTT <span class="main">⇒</span> <span class="bound">t</span> <span class="main">|</span> ValFF <span class="main">⇒</span> <span class="bound">e</span> <span class="main">|</span> ValN<span class="main">⋅</span><span class="bound">n</span> <span class="main">⇒</span> <span class="main">⊥</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ValD <span class="main">→</span> ValD"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succ</span> <span class="main">≡</span> <span class="keyword1">Λ</span> <span class="main">(</span>ValN<span class="main">⋅</span>n<span class="main">)</span><span class="main">.</span> ValN<span class="main">⋅</span><span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ValD <span class="main">→</span> ValD"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pred</span> <span class="main">≡</span> <span class="keyword1">Λ</span> <span class="main">(</span>ValN<span class="main">⋅</span>n<span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">n</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">⊥</span> <span class="main">|</span> Suc <span class="bound">n</span> <span class="main">⇒</span> ValN<span class="main">⋅</span><span class="bound">n</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isZero</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ValD <span class="main">→</span> ValD"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isZero</span> <span class="main">≡</span> <span class="keyword1">Λ</span> <span class="main">(</span>ValN<span class="main">⋅</span>n<span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> ValTT <span class="keyword1">else</span> ValFF"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We model environments simply as continuous functions from variable
names to values.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> Var <span class="main">=</span> <span class="quoted"><span class="quoted">"var"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> Env <span class="main">=</span> <span class="quoted"><span class="quoted">"Var <span class="main">→</span> <span class="tfree">'a</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">env_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Env"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">env_empty</span> <span class="main">≡</span> <span class="main">⊥</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">env_ext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Var <span class="main">→</span> <span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'a</span> Env <span class="main">→</span> <span class="tfree">'a</span> Env"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">env_ext</span> <span class="main">≡</span> <span class="keyword1">Λ</span> v x ρ v'<span class="main">.</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">v'</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="bound">ρ</span><span class="main">⋅</span><span class="bound">v'</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="PCF-env_ext_same"><span class="command">lemma</span></span> env_ext_same<span class="main">:</span> <span class="quoted"><span class="quoted">"env_ext<span class="main">⋅</span><span class="free">v</span><span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">ρ</span><span class="main">⋅</span><span class="free">v</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_ext_def<span class="main">)</span>

<span class="keyword1" id="PCF-env_ext_neq"><span class="command">lemma</span></span> env_ext_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="free">v'</span> <span class="main">⟹</span> env_ext<span class="main">⋅</span><span class="free">v</span><span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">ρ</span><span class="main">⋅</span><span class="free">v'</span> <span class="main">=</span> <span class="free">ρ</span><span class="main">⋅</span><span class="free">v'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_ext_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> env_ext_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> env_ext_same env_ext_neq

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The semantics is given by a function defined by primitive recursion
over the syntax.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> EnvD <span class="main">=</span> <span class="quoted"><span class="quoted">"ValD Env"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">evalD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"expr <span class="main">⇒</span> EnvD <span class="main">→</span> ValD"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">evalD</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="bound">ρ</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalD</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> appF<span class="main">⋅</span><span class="main">(</span><span class="free">evalD</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">evalD</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalD</span> <span class="main">(</span>AbsN <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="free">evalD</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="main">(</span>env_ext<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalD</span> <span class="main">(</span>AbsV <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span>strictify<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="free">evalD</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="main">(</span>env_ext<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalD</span> <span class="main">(</span>Diverge<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalD</span> <span class="main">(</span>Fix <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="keyword1">μ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">evalD</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="main">(</span>env_ext<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalD</span> <span class="main">(</span>tt<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> ValTT<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalD</span> <span class="main">(</span>ff<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> ValFF<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalD</span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> cond<span class="main">⋅</span><span class="main">(</span><span class="free">evalD</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">evalD</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">evalD</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalD</span> <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> ValN<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalD</span> <span class="main">(</span>Succ <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> succ<span class="main">⋅</span><span class="main">(</span><span class="free">evalD</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalD</span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> pred<span class="main">⋅</span><span class="main">(</span><span class="free">evalD</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalD</span> <span class="main">(</span>IsZero <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> isZero<span class="main">⋅</span><span class="main">(</span><span class="free">evalD</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">eval'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"expr <span class="main">⇒</span> ValD Env <span class="main">⇒</span> ValD"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟦</span>_<span class="keyword1">⟧</span>_"</span> <span class="main">[</span>0<span class="main">,</span>1000<span class="main">]</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval'</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">≡</span> evalD <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The Y Combinator›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can shown the Y combinator is the least fixed point operator using
just the minimal invariant.  In other words, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"fix"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is
definable in untyped PCF minus the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Fix"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> construct.

This is Example~3.6 from \citet{PittsAM:relpod}. He attributes the
proof to Plotkin.

These two functions are <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Δ ≡ λf x. f (x x)›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Y ≡
λf. (Δ f) (Δ f)›</span></span></span></span>.

Note the numbers here are names, not de Bruijn indices.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Y_delta</span> <span class="main">::</span> <span class="quoted">expr</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Y_delta</span> <span class="main">≡</span> AbsN <span class="main">0</span> <span class="main">(</span>AbsN <span class="main">1</span> <span class="main">(</span>App <span class="main">(</span>Var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>App <span class="main">(</span>Var <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Var <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ycomb</span> <span class="main">::</span> <span class="quoted">expr</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ycomb</span> <span class="main">≡</span> AbsN <span class="main">0</span> <span class="main">(</span>App <span class="main">(</span>App Y_delta <span class="main">(</span>Var <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>App Y_delta <span class="main">(</span>Var <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fixD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ValD <span class="main">→</span> ValD"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fixD</span> <span class="main">≡</span> <span class="keyword1">Λ</span> <span class="main">(</span>ValF<span class="main">⋅</span>f<span class="main">)</span><span class="main">.</span> fix<span class="main">⋅</span><span class="bound">f</span>"</span></span>

<span class="keyword1" id="PCF-Y"><span class="command">lemma</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Ycomb<span class="main">⟧</span><span class="free">ρ</span> <span class="main">=</span> ValF<span class="main">⋅</span>fixD"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ValF<span class="main">⋅</span>fixD <span class="main">⊑</span> <span class="main">⟦</span>Ycomb<span class="main">⟧</span><span class="free">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fixD_def Ycomb_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_below_iff eta_cfun<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_least<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Y_delta_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">ρ</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> ID <span class="main">∧</span> appF<span class="main">⋅</span><span class="main">(</span><span class="bound">x</span><span class="main">⋅</span><span class="main">(</span>appF<span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span>Y_delta<span class="main">⟧</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>ValF<span class="main">⋅</span><span class="skolem">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>appF<span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span>Y_delta<span class="main">⟧</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>ValF<span class="main">⋅</span><span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> fixD<span class="main">⋅</span><span class="main">(</span>ValF<span class="main">⋅</span><span class="skolem">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> ValD_copy"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_ind<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_belowI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">xa</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> cfun_map_below_ID<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_below_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fixD_def eta_cfun<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Y_delta_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_below_ID<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monofun_cfun_arg<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="main">(</span><span class="improper">x</span><span class="main">⋅</span><span class="main">(</span>appF<span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span>Y_delta<span class="main">⟧</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>ValF<span class="main">⋅</span><span class="skolem">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="improper">x</span><span class="main">⋅</span><span class="main">(</span>appF<span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span>Y_delta<span class="main">⟧</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>ValF<span class="main">⋅</span><span class="skolem">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                        <span class="main">⊑</span> appF<span class="main">⋅</span><span class="main">(</span><span class="improper">x</span><span class="main">⋅</span><span class="main">(</span>appF<span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span>Y_delta<span class="main">⟧</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>ValF<span class="main">⋅</span><span class="skolem">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>appF<span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span>Y_delta<span class="main">⟧</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>ValF<span class="main">⋅</span><span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> below_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monofun_cfun_arg cfun_below_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Ycomb<span class="main">⟧</span><span class="free">ρ</span> <span class="main">⊑</span> ValF<span class="main">⋅</span>fixD"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Ycomb_def fixD_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_below_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Y_delta_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Y_delta_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* FIXME could also try to show uniformity, cf Gunter, Plotkin "3 Inadequate Models". *)</span>

<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Logical relations for definability›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:pcfdefinability}

An element of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"ValD"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is definable if there is an expression
that denotes it.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">definable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ValD <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">definable</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">M</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">M</span><span class="main">⟧</span>env_empty <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

A classical result about PCF is that while the denotational semantics
is \emph{adequate}, as we show in \S\ref{sec:opsem}, it is not
\emph{fully abstract}, i.e. it contains undefinable values (junk).

One way of showing this is to reason operationally; see, for instance,
\citet[\S4]{Plotkin77} and \citet[\S6.1]{Gunter:1992}.

Another is to use \emph{logical relations}, following
\citet{Plotkin:1973}, and also
\citet{Mitchell:1996,Sieber:1992,DBLP:conf/mfps/Stoughton93}.

For this purpose we define a logical relation to be a set of vectors
over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"ValD"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that is closed under continuous functions of type
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"ValD <span class="main"><span class="main">→</span></span> ValD"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This is complicated by the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ValF"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> tag
and having strict function abstraction.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">logical_relation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>type <span class="main">⇒</span> ValD<span class="main">)</span> set <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">logical_relation</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">fs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> appF<span class="main">⋅</span><span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">fs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> strictify<span class="main">⋅</span><span class="main">(</span>appF<span class="main">⋅</span><span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">fs</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">fs</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> strictify<span class="main">⋅</span><span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span>strictify<span class="main">⋅</span><span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> fixD<span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">cs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">ts</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">es</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> cond<span class="main">⋅</span><span class="main">(</span><span class="bound">cs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ts</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">es</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> succ<span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> pred<span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> isZero<span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="PCF-logical_relationI"><span class="command">lemma</span></span> logical_relationI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">fs</span> <span class="bound">xs</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">fs</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> appF<span class="main">⋅</span><span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">fs</span> <span class="bound">xs</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">fs</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> strictify<span class="main">⋅</span><span class="main">(</span>appF<span class="main">⋅</span><span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">fs</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">fs</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> strictify<span class="main">⋅</span><span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span>strictify<span class="main">⋅</span><span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> fixD<span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">cs</span> <span class="bound">ts</span> <span class="bound">es</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">cs</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> <span class="bound">ts</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> <span class="bound">es</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> cond<span class="main">⋅</span><span class="main">(</span><span class="bound">cs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ts</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">es</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> succ<span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> pred<span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> isZero<span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> logical_relation <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> logical_relation_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfcomp1<span class="main">)</span>

<span class="keyword1" id="PCF-lr_l2r"><span class="command">lemma</span></span> lr_l2r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">fs</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> logical_relation <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> appF<span class="main">⋅</span><span class="main">(</span><span class="free">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">fs</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> logical_relation <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> strictify<span class="main">⋅</span><span class="main">(</span>appF<span class="main">⋅</span><span class="main">(</span><span class="free">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> logical_relation <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> fixD<span class="main">⋅</span><span class="main">(</span><span class="free">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">cs</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> <span class="free">ts</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> <span class="free">es</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> logical_relation <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> cond<span class="main">⋅</span><span class="main">(</span><span class="free">cs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">ts</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">es</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> logical_relation <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> succ<span class="main">⋅</span><span class="main">(</span><span class="free">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> logical_relation <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> pred<span class="main">⋅</span><span class="main">(</span><span class="free">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> logical_relation <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> isZero<span class="main">⋅</span><span class="main">(</span><span class="free">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> logical_relation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="PCF-lr_r2l"><span class="command">lemma</span></span> lr_r2l<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> logical_relation <span class="free">R</span><span class="main">;</span> <span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="free">fs</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> logical_relation_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfcomp1<span class="main">)</span>

<span class="keyword1" id="PCF-lr_r2l_strict"><span class="command">lemma</span></span> lr_r2l_strict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> logical_relation <span class="free">R</span><span class="main">;</span> <span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> strictify<span class="main">⋅</span><span class="main">(</span><span class="free">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span>strictify<span class="main">⋅</span><span class="main">(</span><span class="free">fs</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> logical_relation_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfcomp1<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

In the context of PCF these relations also need to respect the
constants.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">PCF_consts_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>type <span class="main">⇒</span> ValD<span class="main">)</span> set <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PCF_consts_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
       <span class="main">⊥</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>
     <span class="main">∧</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValTT<span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>
     <span class="main">∧</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValFF<span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>
     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValN<span class="main">⋅</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="PCF-PCF_consts_rel_simps"><span class="command">lemma</span></span> PCF_consts_rel_simps <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"PCF_consts_rel <span class="free">R</span> <span class="main">⟹</span> <span class="main">⊥</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"PCF_consts_rel <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValTT<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"PCF_consts_rel <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValFF<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"PCF_consts_rel <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValN<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> PCF_consts_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="PCF-PCF_consts_relI"><span class="command">lemma</span></span> PCF_consts_relI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⊥</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span>
     <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValTT<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span>
     <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValFF<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValN<span class="main">⋅</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> PCF_consts_rel <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> PCF_consts_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PCF_lr</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">∧</span> logical_relation <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> PCF_consts_rel <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The fundamental property of logical relations states that all PCF
expressions satisfy all PCF logical relations. This result is
essentially due to \citet{Plotkin:1973}.  The proof is by a
straightforward induction on the expression <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">M</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1" id="PCF-lr_fundamental"><span class="command">lemma</span></span> lr_fundamental<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lr<span class="main">:</span> <span class="quoted"><span class="quoted">"PCF_lr <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">ρ</span> <span class="bound">i</span><span class="main">⋅</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="free">M</span><span class="main">⟧</span><span class="main">(</span><span class="free">ρ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> ρ
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">v</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> lr lr_l2r<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> fs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="skolem">e1</span><span class="main">⟧</span><span class="main">(</span><span class="skolem">ρ</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="skolem">e2</span><span class="main">⟧</span><span class="main">(</span><span class="skolem">ρ</span> <span class="bound">j</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AbsN <span class="skolem">v</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> lr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> lr_r2l<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> fs<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">.</span></span> <span class="keyword1"><span class="keyword1">Λ</span></span> x<span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⟦</span></span><span class="skolem"><span class="skolem">e</span></span><span class="main"><span class="main">⟧</span></span><span class="main"><span class="main">(</span></span>env_ext<span class="main"><span class="main">⋅</span></span><span class="skolem"><span class="skolem">v</span></span><span class="main"><span class="main">⋅</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">⋅</span></span><span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">ρ</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> ρ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> env_ext<span class="main">⋅</span><span class="skolem">v</span><span class="main">⋅</span><span class="main">(</span><span class="improper">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">ρ</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> AbsN.hyps<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_ext_def<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> AbsN<span class="main">(</span>2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">=</span><span class="improper">va</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AbsV <span class="skolem">v</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> lr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lr_r2l_strict<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> fs<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">.</span></span> <span class="keyword1"><span class="keyword1">Λ</span></span> x<span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⟦</span></span><span class="skolem"><span class="skolem">e</span></span><span class="main"><span class="main">⟧</span></span><span class="main"><span class="main">(</span></span>env_ext<span class="main"><span class="main">⋅</span></span><span class="skolem"><span class="skolem">v</span></span><span class="main"><span class="main">⋅</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">⋅</span></span><span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">ρ</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> fs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="main">⟦</span><span class="skolem">e</span><span class="main">⟧</span><span class="main">(</span>env_ext<span class="main">⋅</span><span class="skolem">v</span><span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">ρ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> lr_l2r<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> lr_r2l<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> fs<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">.</span></span> <span class="keyword1"><span class="keyword1">Λ</span></span> x<span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⟦</span></span><span class="skolem"><span class="skolem">e</span></span><span class="main"><span class="main">⟧</span></span><span class="main"><span class="main">(</span></span>env_ext<span class="main"><span class="main">⋅</span></span><span class="skolem"><span class="skolem">v</span></span><span class="main"><span class="main">⋅</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">⋅</span></span><span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">ρ</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> ρ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> env_ext<span class="main">⋅</span><span class="skolem">v</span><span class="main">⋅</span><span class="main">(</span><span class="improper">xsa</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">ρ</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> AbsV.hyps<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_ext_def<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> AbsV<span class="main">(</span>2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">=</span><span class="improper">va</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fix <span class="skolem">v</span> <span class="skolem">e</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_argument_promote_fun<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_ind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> F<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">Λ</span></span> f<span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">Λ</span></span> xa<span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⟦</span></span><span class="skolem"><span class="skolem">e</span></span><span class="main"><span class="main">⟧</span></span><span class="main"><span class="main">(</span></span>env_ext<span class="main"><span class="main">⋅</span></span><span class="skolem"><span class="skolem">v</span></span><span class="main"><span class="main">⋅</span></span><span class="bound"><span class="bound">xa</span></span><span class="main"><span class="main">⋅</span></span><span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">ρ</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">⋅</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">f</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lr<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lr inst_fun_pcpo<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> ρ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> env_ext<span class="main">⋅</span><span class="skolem">v</span><span class="main">⋅</span><span class="main">(</span><span class="improper">x</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">ρ</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Fix.hyps<span class="main">)</span>
     <span class="keyword1"><span class="command">unfolding</span></span> env_ext_def
     <span class="keyword1"><span class="command">using</span></span> Fix<span class="main">(</span>2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">=</span><span class="improper">va</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cont_fun<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cond <span class="skolem">i</span> <span class="skolem">t</span> <span class="skolem">e</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> lr lr_l2r<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> cs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="skolem">i</span><span class="main">⟧</span><span class="main">(</span><span class="skolem">ρ</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ts<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="skolem">t</span><span class="main">⟧</span><span class="main">(</span><span class="skolem">ρ</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> es<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="skolem">e</span><span class="main">⟧</span><span class="main">(</span><span class="skolem">ρ</span> <span class="bound">j</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Succ <span class="skolem">e</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> lr lr_l2r<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="skolem">e</span><span class="main">⟧</span><span class="main">(</span><span class="skolem">ρ</span> <span class="bound">j</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">e</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> lr lr_l2r<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="skolem">e</span><span class="main">⟧</span><span class="main">(</span><span class="skolem">ρ</span> <span class="bound">j</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IsZero <span class="skolem">e</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> lr lr_l2r<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="skolem">e</span><span class="main">⟧</span><span class="main">(</span><span class="skolem">ρ</span> <span class="bound">j</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Diverge <span class="keyword1"><span class="command">with</span></span> lr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inst_fun_pcpo<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> lr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can use this result to show that there is no PCF term that maps the
vector <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">args</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">result</span></span> <span class="main"><span class="main">∉</span></span> <span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for some logical
relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. If we further show that there is a function
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ValD</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span> <span class="free"><span class="free">args</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">result</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> then
we can conclude that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not definable.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">appFLv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ValD <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>type <span class="main">⇒</span> ValD<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span> <span class="main">⇒</span> ValD<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">appFLv</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> appF<span class="main">⋅</span><span class="bound">f</span><span class="main">⋅</span><span class="main">(</span><span class="bound">x</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PCF-lr_appFLv"><span class="command">lemma</span></span> lr_appFLv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lr<span class="main">:</span> <span class="quoted"><span class="quoted">"logical_relation <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">::</span><span class="tfree">'i</span><span class="main">::</span>type<span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> args<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">args</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"appFLv <span class="free">f</span> <span class="free">args</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> args
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">args</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> f <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lr_l2r<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ _ lr<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> fs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> appF<span class="main">⋅</span><span class="bound">f</span><span class="main">⋅</span><span class="main">(</span><span class="bound">x</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> not_definable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>type <span class="main">⇒</span> ValD<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">args</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span> <span class="main">⇒</span> ValD<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">result</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> ValD"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lr<span class="main">:</span> <span class="quoted"><span class="quoted">"PCF_lr <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> args<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">args</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> result<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">result</span> <span class="main">∉</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">f</span><span class="main">::</span>ValD<span class="main">)</span><span class="main">.</span> definable <span class="bound">f</span> <span class="main">∧</span> appFLv <span class="bound">f</span> <span class="free">args</span> <span class="main">=</span> <span class="free">result</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> definable <span class="bound">f</span> <span class="main">∧</span> appFLv <span class="bound">f</span> <span class="free">args</span> <span class="main">=</span> <span class="free">result</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> df<span class="main">:</span> <span class="quoted"><span class="quoted">"definable <span class="skolem">f</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"appFLv <span class="skolem">f</span> <span class="free">args</span> <span class="main">=</span> <span class="free">result</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> df <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> Mf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="skolem">M</span><span class="main">⟧</span>env_empty <span class="main">=</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> definable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> lr lr_fundamental<span class="main">[</span><span class="operator">OF</span> lr<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ρ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> env_empty"</span></span><span class="main">]</span>
       f args lr_appFLv<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> args<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">args</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">result</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> env_empty_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inst_fun_pcpo<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> result <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Parallel OR is not definable›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹

\label{sec:por}

We show that parallel-or is not <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-definable following
\citet{Sieber:1992} and \citet{DBLP:conf/mfps/Stoughton93}.

Parallel-or is similar to the familiar short-circuting or except that
if the first argument is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊥</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the second one is
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ValTT"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we get <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ValTT"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (and not <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊥</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). It is continuous and then have included in the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span>
<span class="quoted"><span class="quoted">"ValD"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> domain.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">por</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ValD <span class="main">⇒</span> ValD <span class="main">⇒</span> ValD"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">por</span> _"</span> <span class="main">[</span>31<span class="main">,</span>30<span class="main">]</span> 30<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">por</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ValTT <span class="keyword1">then</span> ValTT
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ValTT <span class="keyword1">then</span> ValTT
              <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ValFF <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ValFF<span class="main">)</span> <span class="keyword1">then</span> ValFF <span class="keyword1">else</span> <span class="main">⊥</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The defining properties of parallel-or.›</span></span>

<span class="keyword1" id="PCF-POR_simps"><span class="command">lemma</span></span> POR_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ValTT <span class="keyword1">por</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> ValTT"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="keyword1">por</span> ValTT<span class="main">)</span> <span class="main">=</span> ValTT"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ValFF <span class="keyword1">por</span> ValFF<span class="main">)</span> <span class="main">=</span> ValFF"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ValFF <span class="keyword1">por</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ValFF <span class="keyword1">por</span> ValN<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ValFF <span class="keyword1">por</span> ValF<span class="main">⋅</span><span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⊥</span> <span class="keyword1">por</span> ValFF<span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ValN<span class="main">⋅</span><span class="free">n</span> <span class="keyword1">por</span> ValFF<span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ValF<span class="main">⋅</span><span class="free">f</span> <span class="keyword1">por</span> ValFF<span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⊥</span> <span class="keyword1">por</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⊥</span> <span class="keyword1">por</span> ValN<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⊥</span> <span class="keyword1">por</span> ValF<span class="main">⋅</span><span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ValN<span class="main">⋅</span><span class="free">n</span> <span class="keyword1">por</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ValF<span class="main">⋅</span><span class="free">f</span> <span class="keyword1">por</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ValN<span class="main">⋅</span><span class="free">m</span> <span class="keyword1">por</span> ValN<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ValN<span class="main">⋅</span><span class="free">n</span> <span class="keyword1">por</span> ValF<span class="main">⋅</span><span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ValF<span class="main">⋅</span><span class="free">f</span> <span class="keyword1">por</span> ValN<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ValF<span class="main">⋅</span><span class="free">f</span> <span class="keyword1">por</span> ValF<span class="main">⋅</span><span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> por_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We show that parallel-or is a continuous function.

›</span></span>

<span class="keyword1" id="PCF-POR_sym"><span class="command">lemma</span></span> POR_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="keyword1">por</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="keyword1">por</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> por_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PCF-ValTT_below_iff"><span class="command">lemma</span></span> ValTT_below_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ValTT <span class="main">⊑</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> ValTT"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="PCF-ValFF_below_iff"><span class="command">lemma</span></span> ValFF_below_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ValFF <span class="main">⊑</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> ValFF"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="PCF-monofun_por"><span class="command">lemma</span></span> monofun_por<span class="main">:</span> <span class="quoted"><span class="quoted">"monofun <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">por</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> por_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monofunI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PCF-mic2mic"><span class="command">lemma</span></span> mic2mic<span class="main">:</span> <span class="quoted"><span class="quoted">"max_in_chain <span class="free">i</span> <span class="free">Y</span> <span class="main">⟹</span> max_in_chain <span class="free">i</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> max_in_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PCF-cont_por1"><span class="command">lemma</span></span> cont_por1<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">por</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> contI2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monofun_por<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"Lub <span class="improper">Y</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>

   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> compact_imp_max_in_chain<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> mic2mic<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="keyword1"><span class="keyword1">por</span></span> <span class="free"><span class="free">y</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> maxinch_is_thelub<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxinch_is_thelub<span class="main">)</span>

   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> compact_imp_max_in_chain<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> mic2mic<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="keyword1"><span class="keyword1">por</span></span> <span class="free"><span class="free">y</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> maxinch_is_thelub<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxinch_is_thelub<span class="main">)</span>

   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PCF-cont_por"><span class="command">lemma</span></span> cont_por<span class="main">[</span><span class="operator">cont2cont</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">por</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">y</span><span class="main">.</span> cont <span class="bound">f</span> <span class="main">⟹</span> cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="keyword1">por</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cont_apply<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cont_por1<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> A<span class="main">[</span><span class="operator">OF</span> f<span class="main">]</span> A<span class="main">[</span><span class="operator">OF</span> g<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cont_por1 POR_sym <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cont_apply<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We need three-element vectors.

›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> Three <span class="main">=</span> One <span class="main">|</span> Two <span class="main">|</span> Three

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The standard logical relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that demonstrates POR is not
definable is:
\[
  (x, y, z) \in R\ \mbox{iff}\ x = y = z \lor (x = \bot \lor y = \bot)
\]
That POR satisfies this relation can be seen from its truth table (see
below).

Note we restrict the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x = y = z›</span></span></span></span> clause to non-function
values. Adding functions breaks the ``logical relations'' property.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">POR_base_lf_rep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Three <span class="main">⇒</span> ValD<span class="main">)</span> lf_rep"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">POR_base_lf_rep</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">mR</span><span class="main">,</span> <span class="bound">pR</span><span class="main">)</span><span class="main">.</span>
     <span class="main">{</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValTT<span class="main">)</span> <span class="main">}</span> <span class="main">∪</span> <span class="main">{</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValFF<span class="main">)</span> <span class="main">}</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>x = y = z›</span></span> for bools›</span>
   <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValN<span class="main">⋅</span><span class="bound">n</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>x = y = z›</span></span> for numerals›</span>
   <span class="main">∪</span> <span class="main">{</span> <span class="bound">f</span> <span class="main">.</span> <span class="bound">f</span> One <span class="main">=</span> <span class="main">⊥</span> <span class="main">}</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>x = ⊥›</span></span>›</span>
   <span class="main">∪</span> <span class="main">{</span> <span class="bound">f</span> <span class="main">.</span> <span class="bound">f</span> Two <span class="main">=</span> <span class="main">⊥</span> <span class="main">}</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>y = ⊥›</span></span>›</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We close this relation with respect to continuous functions. This
functor yields an admissible relation for all <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and is
monotonic.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">fn_lf_rep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>type <span class="main">⇒</span> ValD<span class="main">)</span> lf_rep"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fn_lf_rep</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">mR</span><span class="main">,</span> <span class="bound">pR</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="bound">fs</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span><span class="bound">fs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> unlr <span class="main">(</span>undual <span class="bound">mR</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unlr <span class="bound">pR</span> <span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="PCF-adm_POR_base_lf_rep"><span class="command">lemma</span></span> adm_POR_base_lf_rep<span class="main">:</span>
  <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> POR_base_lf_rep <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> POR_base_lf_rep_def
<span class="keyword1"><span class="command">using</span></span> adm_below_monic_exists<span class="main">[</span><span class="operator">OF</span> _ below_monic_fun_K<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"ValN"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> adm_disj <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cont_fun<span class="main">)</span>

<span class="keyword1" id="PCF-mono_POR_base_lf_rep"><span class="command">lemma</span></span> mono_POR_base_lf_rep<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mono POR_base_lf_rep"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> POR_base_lf_rep_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> monoI<span class="main">)</span>

<span class="keyword1" id="PCF-adm_fn"><span class="command">lemma</span></span> adm_fn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> fn_lf_rep <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fn_lf_rep_def
<span class="keyword1"><span class="command">using</span></span> adm_below_monic_exists<span class="main">[</span><span class="operator">OF</span> _ below_monic_fun_K<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"ValF"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> adm_below_monic_exists<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cont_fun below_monic_indexed<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*
  by (fastforce simp: split_def intro: adm_below_monic_exists)
*)</span>

<span class="keyword1" id="PCF-mono_fn_lf_rep"><span class="command">lemma</span></span> mono_fn_lf_rep<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mono fn_lf_rep"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> ValD<span class="main">)</span> admS dual <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> ValD<span class="main">)</span> admS"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="skolem"><span class="skolem">y1</span></span> <span class="skolem"><span class="skolem">y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fn_lf_rep <span class="skolem">x</span> <span class="main">⊆</span> fn_lf_rep <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fn_lf_rep_def<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> dual_less_eq_iff less_eq_admS_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">POR_lf_rep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Three <span class="main">⇒</span> ValD<span class="main">)</span> lf_rep"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">POR_lf_rep</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> POR_base_lf_rep <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∪</span> fn_lf_rep <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">POR_lf</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> mklr <span class="main">(</span>POR_lf_rep <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="PCF-admS_POR_lf"><span class="command">lemma</span></span> admS_POR_lf <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"POR_lf_rep <span class="free">r</span> <span class="main">∈</span> admS"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">∈</span> POR_lf_rep <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> POR_lf_rep_def POR_base_lf_rep_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> POR_lf_rep <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> POR_lf_rep_def
    <span class="keyword1"><span class="command">using</span></span> adm_POR_base_lf_rep<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> adm_fn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PCF-mono_POR_lf"><span class="command">lemma</span></span> mono_POR_lf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mono POR_lf"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">unfolding</span></span> POR_lf_rep_def
  <span class="keyword1"><span class="command">using</span></span> mono_fn_lf_rep mono_POR_base_lf_rep
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monoD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Again it yields an admissible relation and is monotonic.

We need to show the functor respects the minimal invariant.

›</span></span>

<span class="keyword1" id="PCF-min_inv_POR_lf"><span class="command">lemma</span></span> min_inv_POR_lf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eRSV <span class="free">e</span> <span class="free">R'</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eRSV <span class="main">(</span>ValD_copy_rec<span class="main">⋅</span><span class="free">e</span><span class="main">)</span> <span class="main">(</span>dual <span class="main">(</span>POR_lf <span class="main">(</span>dual <span class="free">S'</span><span class="main">,</span> undual <span class="free">R'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>POR_lf <span class="main">(</span><span class="free">R'</span><span class="main">,</span> <span class="free">S'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> POR_lf_rep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> POR_base_lf_rep_def eta_cfun cfcomp1 cfun_eq_iff<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fn_lf_rep_def eta_cfun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfcomp1 cfun_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">Λ</span> xa<span class="main">.</span> <span class="free">e</span><span class="main">⋅</span><span class="main">(</span><span class="improper">fs</span> <span class="bound">i</span><span class="main">⋅</span><span class="main">(</span><span class="free">e</span><span class="main">⋅</span><span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">interpretation</span></span> POR<span class="main">:</span> DomSolV <span class="quoted">POR_lf</span> <span class="quoted">ValD_copy_rec</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mono_POR_lf<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ValD_copy_ID<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> min_inv_POR_lf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PCF-PORI"><span class="command">lemma</span></span> PORI <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValTT<span class="main">)</span> <span class="main">∈</span> unlr POR.delta"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValFF<span class="main">)</span> <span class="main">∈</span> unlr POR.delta"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValN<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> unlr POR.delta"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> One <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> unlr POR.delta"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> Two <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> unlr POR.delta"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> unlr POR.delta <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unlr POR.delta <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="free">fs</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unlr POR.delta"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> POR.delta_sol<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> POR_lf_rep_def<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> POR_base_lf_rep_def fn_lf_rep_def eta_cfun cfcomp1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="PCF-PORE"><span class="command">lemma</span></span> PORE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">∈</span> unlr POR.delta<span class="main">;</span>
     <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValTT<span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValFF<span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValN<span class="main">⋅</span><span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="free">a</span> One <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="free">a</span> Two <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="main">⋀</span><span class="bound">fs</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="bound">fs</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> unlr POR.delta <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unlr POR.delta <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> POR.delta_sol<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> POR_lf_rep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> POR_base_lf_rep_def fn_lf_rep_def eta_cfun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PCF-POR_strict_appI"><span class="command">lemma</span></span> POR_strict_appI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> unlr POR.delta"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> unlr POR.delta <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="free">fs</span> <span class="bound">j</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unlr POR.delta"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> strictify<span class="main">⋅</span><span class="main">(</span><span class="free">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unlr POR.delta"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">erule</span> PORE<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="PCF-logical_relation_POR"><span class="command">lemma</span></span> logical_relation_POR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"logical_relation <span class="main">(</span>unlr POR.delta<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> logical_relationI<span class="main">)</span>

  <span class="comment1">(* Strict application *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> fs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> appF<span class="main">⋅</span><span class="main">(</span><span class="improper">fs</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> POR_strict_appI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> PORE<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="comment1">(* FIXME fixD *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> PORE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fixD_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_argument_promote_fun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">Λ</span> f<span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="improper">fs</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fix_ind<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cont_fun<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> PORE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cond_def isZero_def pred_def succ_def eta_cfun <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PCF-PCF_consts_rel_POR"><span class="command">lemma</span></span> PCF_consts_rel_POR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PCF_consts_rel <span class="main">(</span>unlr POR.delta<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> PCF_consts_relI<span class="main">)</span> <span class="operator">simp_all</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can show that the solution satisfies the expectations of the
fundamental theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] "lr_fundamental"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1" id="PCF-PCF_lr_POR_delta"><span class="command">lemma</span></span> PCF_lr_POR_delta<span class="main">:</span> <span class="quoted"><span class="quoted">"PCF_lr <span class="main">(</span>unlr POR.delta<span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> logical_relation_POR PCF_consts_rel_POR <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This is the truth-table for POR rendered as a vector: we seek a
function that simultaneously maps the two argument vectors to the
result.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">POR_arg1_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">POR_arg1_rel</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">i</span> <span class="keyword1">of</span> One <span class="main">⇒</span> ValTT <span class="main">|</span> Two <span class="main">⇒</span> <span class="main">⊥</span> <span class="main">|</span> Three <span class="main">⇒</span> ValFF"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">POR_arg2_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">POR_arg2_rel</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">i</span> <span class="keyword1">of</span> One <span class="main">⇒</span> <span class="main">⊥</span> <span class="main">|</span> Two <span class="main">⇒</span> ValTT <span class="main">|</span> Three <span class="main">⇒</span> ValFF"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">POR_result_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">POR_result_rel</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">i</span> <span class="keyword1">of</span> One <span class="main">⇒</span> ValTT <span class="main">|</span> Two <span class="main">⇒</span> ValTT <span class="main">|</span> Three <span class="main">⇒</span> ValFF"</span></span>

<span class="keyword1" id="PCF-lr_POR_arg1_rel"><span class="command">lemma</span></span> lr_POR_arg1_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"POR_arg1_rel <span class="main">∈</span> unlr POR.delta"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> POR_arg1_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PCF-lr_POR_arg2_rel"><span class="command">lemma</span></span> lr_POR_arg2_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"POR_arg2_rel <span class="main">∈</span> unlr POR.delta"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> POR_arg2_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PCF-lr_POR_result_rel"><span class="command">lemma</span></span> lr_POR_result_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"POR_result_rel <span class="main">∉</span> unlr POR.delta"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> POR_result_rel_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> PORE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> fun_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Three.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Parallel-or satisfies these tests:

›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> POR_sat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"appFLv <span class="main">(</span>ValF<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> y<span class="main">.</span> <span class="bound">x</span> <span class="keyword1">por</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>POR_arg1_rel<span class="main">,</span> POR_arg2_rel<span class="main">]</span> <span class="main">=</span> POR_result_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> POR_arg1_rel_def POR_arg2_rel_def POR_result_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Three.splits<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

... but is not PCF-definable:

›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> POR_is_not_definable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> definable <span class="bound">f</span> <span class="main">∧</span> appFLv <span class="bound">f</span> <span class="main">[</span>POR_arg1_rel<span class="main">,</span> POR_arg2_rel<span class="main">]</span> <span class="main">=</span> POR_result_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> not_definable<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"unlr POR.delta"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> lr_POR_arg1_rel lr_POR_arg2_rel lr_POR_result_rel PCF_lr_POR_delta
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Plotkin's existential quantifier›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can also show that the existential quantifier of
\citet[\S5]{Plotkin77} is not PCF-definable using logical relations.

Our definition is quite loose; if the argument function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
maps any value to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ValTT"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">plotkin_exists</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> yields
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ValTT"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. It may be more plausible to test <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on
numerals only.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">plotkin_exists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ValD <span class="main">⇒</span> ValD"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">plotkin_exists</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span>
     <span class="keyword1">if</span> <span class="main">(</span>appF<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> ValFF<span class="main">)</span>
       <span class="keyword1">then</span> ValFF
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> appF<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="bound">n</span> <span class="main">=</span> ValTT<span class="main">)</span> <span class="keyword1">then</span> ValTT <span class="keyword1">else</span> <span class="main">⊥</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="PCF-plotkin_exists_simps"><span class="command">lemma</span></span> plotkin_exists_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"plotkin_exists <span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"plotkin_exists <span class="main">(</span>ValF<span class="main">⋅</span><span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"plotkin_exists <span class="main">(</span>ValF<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> <span class="main">_</span><span class="main">.</span> ValFF<span class="main">)</span><span class="main">)</span> <span class="main">=</span> ValFF"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> plotkin_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="PCF-plotkin_exists_tt"><span class="command">lemma</span></span> plotkin_exists_tt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>ValN<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> ValTT <span class="main">⟹</span> plotkin_exists <span class="free">f</span> <span class="main">=</span> ValTT"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> plotkin_exists_def
  <span class="keyword1"><span class="command">using</span></span> monofun_cfun_arg<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⊥</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PCF-monofun_pe"><span class="command">lemma</span></span> monofun_pe<span class="main">:</span>
  <span class="quoted"><span class="quoted">"monofun plotkin_exists"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> monofunI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="keyword3"><span class="command">assume</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">::</span>ValD<span class="main">)</span> <span class="main">⊑</span> <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?goal</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"plotkin_exists <span class="skolem">f</span> <span class="main">⊑</span> plotkin_exists <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> fbot<span class="main">:</span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="skolem">f</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> ValFF"</span></span>
    <span class="keyword1"><span class="command">with</span></span> fg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="skolem">g</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> ValFF"</span></span>
      <span class="keyword1"><span class="command">using</span></span> monofun_cfun<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⊥</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monofun_cfun_arg<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> fbot <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?goal</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plotkin_exists_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> efn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> appF<span class="main">⋅</span><span class="skolem">f</span><span class="main">⋅</span><span class="bound">n</span> <span class="main">=</span> ValTT"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> fn<span class="main">:</span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="skolem">f</span><span class="main">⋅</span><span class="skolem">n</span> <span class="main">=</span> ValTT"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fbot<span class="main">:</span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="skolem">f</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">≠</span> ValFF"</span></span>
      <span class="keyword1"><span class="command">using</span></span> monofun_cfun_arg<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⊥</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> fg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="skolem">f</span><span class="main">⋅</span><span class="skolem">n</span> <span class="main">⊑</span> appF<span class="main">⋅</span><span class="skolem">g</span><span class="main">⋅</span><span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> monofun_cfun_arg<span class="main">[</span><span class="operator">OF</span> fg<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">appF</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> cfun_below_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> fn <span class="keyword1"><span class="command">have</span></span> gn<span class="main">:</span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="skolem">g</span><span class="main">⋅</span><span class="skolem">n</span> <span class="main">=</span> ValTT"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ValD.nchotomy<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="skolem">g</span><span class="main">⋅</span><span class="main">⊥</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gbot<span class="main">:</span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="skolem">g</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">≠</span> ValFF"</span></span>
      <span class="keyword1"><span class="command">using</span></span> monofun_cfun_arg<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⊥</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> fn gn fbot gbot <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?goal</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> plotkin_exists_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> fbot<span class="main">:</span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="skolem">f</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">≠</span> ValFF"</span></span> <span class="keyword2"><span class="keyword">and</span></span> efn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> appF<span class="main">⋅</span><span class="skolem">f</span><span class="main">⋅</span><span class="bound">n</span> <span class="main">=</span> ValTT<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?goal</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plotkin_exists_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?goal</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> plotkin_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can show this function is continuous.

›</span></span>

<span class="keyword1" id="PCF-cont_pe"><span class="command">lemma</span></span> cont_pe <span class="main">[</span><span class="operator">cont2cont</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cont plotkin_exists"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> contI2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monofun_pe<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span> <span class="keyword3"><span class="command">assume</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="skolem">Y</span> <span class="main">::</span> nat <span class="main">⇒</span> ValD<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?goal</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"plotkin_exists <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> plotkin_exists <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> peY<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> plotkin_exists <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> chainI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monofunE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monofun_pe<span class="main"><span class="main">]</span></span> chainE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Y<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> appF<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> ValFF"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> Yi<span class="main">:</span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y</span> <span class="skolem">i</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> ValFF"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="skolem">i</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_ub_thelub<span class="main">[</span><span class="operator">OF</span> Y<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y</span> <span class="skolem">i</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">⊑</span> appF<span class="main">⋅</span><span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> monofun_cfun<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Yi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ValFF <span class="main">⊑</span> appF<span class="main">⋅</span><span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> ValFF"</span></span> <span class="keyword1"><span class="command">using</span></span> ValD.nchotomy<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Yi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plotkin_exists <span class="main">(</span><span class="skolem">Y</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> ValFF"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plotkin_exists_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ValFF <span class="main">⊑</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> plotkin_exists <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_ub_thelub<span class="main">[</span><span class="operator">OF</span> peY<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ValFF <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> plotkin_exists <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ValD.nchotomy<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> plotkin_exists <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?goal</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plotkin_exists_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> appF<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="bound">j</span> <span class="main">=</span> ValTT"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> Yij<span class="main">:</span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y</span> <span class="skolem">i</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">j</span> <span class="main">=</span> ValTT"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> Yij <span class="keyword1"><span class="command">have</span></span> Yib<span class="main">:</span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y</span> <span class="skolem">i</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">≠</span> ValFF"</span></span>
      <span class="keyword1"><span class="command">using</span></span> monofun_cfun_arg<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⊥</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Yij <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y</span> <span class="skolem">i</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">j</span> <span class="main">⊑</span> appF<span class="main">⋅</span><span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_ub_thelub<span class="main">[</span><span class="operator">OF</span> Y<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> monofun_cfun<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Yij <span class="keyword1"><span class="command">have</span></span> Yjlub<span class="main">:</span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">j</span> <span class="main">=</span> ValTT"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ValD.nchotomy<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">j</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Yjlub <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">≠</span> ValFF"</span></span>
      <span class="keyword1"><span class="command">using</span></span> monofun_cfun_arg<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⊥</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Yib Yij <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plotkin_exists <span class="main">(</span><span class="skolem">Y</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> ValTT"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plotkin_exists_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ValTT <span class="main">⊑</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> plotkin_exists <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_ub_thelub<span class="main">[</span><span class="operator">OF</span> peY<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ValTT <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> plotkin_exists <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ValD.nchotomy<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> plotkin_exists <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?goal</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plotkin_exists_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nFF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> appF<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> ValFF<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nTT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> appF<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="bound">j</span> <span class="main">=</span> ValTT<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Y <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?goal</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> plotkin_exists_def
      <span class="keyword1"><span class="command">using</span></span> compact_below_lub_iff<span class="main">[</span><span class="operator">OF</span> ValD.compacts<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            compact_below_lub_iff<span class="main">[</span><span class="operator">OF</span> ValD.compacts<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> contlub_cfun_arg contlub_cfun_fun<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?goal</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PCF-cont_pe2"><span class="command">lemma</span></span> cont_pe2<span class="main">[</span><span class="operator">cont2cont</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> plotkin_exists <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cont_apply<span class="main">)</span> <span class="operator">simp_all</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Again we construct argument and result test vectors such that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"plotkin_exists"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> satisfies these tests but no PCF-definable term
does.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PE_arg_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PE_arg_rel</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="keyword1">case</span> <span class="bound">i</span> <span class="keyword1">of</span>
        <span class="main">0</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="main">_</span><span class="main">.</span> ValFF<span class="main">)</span>
      <span class="main">|</span> Suc <span class="bound">n</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="main">(</span>ValN<span class="main">⋅</span>x<span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> Suc <span class="bound">n</span> <span class="keyword1">then</span> ValTT <span class="keyword1">else</span> <span class="main">⊥</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PE_result_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PE_result_rel</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">i</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> ValFF <span class="main">|</span> Suc <span class="bound">n</span> <span class="main">⇒</span> ValTT"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Note that unlike the POR case the argument relation does not
characterise PE: we don't treat functions that return <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ValTT"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ValFF"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s.

The Plotkin existential satisfies these tests:

›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> pe_sat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"appFLv <span class="main">(</span>ValF<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> plotkin_exists <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>PE_arg_rel<span class="main">]</span> <span class="main">=</span> PE_result_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> PE_arg_rel_def PE_result_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

As for POR, the difference between the two vectors is that the
argument can diverge but not the result.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PE_base_lf_rep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> ValD<span class="main">)</span> lf_rep"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PE_base_lf_rep</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">mR</span><span class="main">,</span> <span class="bound">pR</span><span class="main">)</span><span class="main">.</span>
     <span class="main">{</span> <span class="main">⊥</span> <span class="main">}</span>
   <span class="main">∪</span> <span class="main">{</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValTT<span class="main">)</span> <span class="main">}</span> <span class="main">∪</span> <span class="main">{</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValFF<span class="main">)</span> <span class="main">}</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>x = y = z›</span></span> for bools›</span>
   <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValN<span class="main">⋅</span><span class="bound">n</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>x = y = z›</span></span> for numerals›</span>
   <span class="main">∪</span> <span class="main">{</span> <span class="bound">f</span> <span class="main">.</span> <span class="bound">f</span> <span class="main">1</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">∨</span> <span class="bound">f</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">}</span> <span class="comment1">― ‹Vectors that diverge on one or two.›</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="PCF-adm_PE_base_lf_rep"><span class="command">lemma</span></span> adm_PE_base_lf_rep<span class="main">:</span>
  <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> PE_base_lf_rep <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> PE_base_lf_rep_def
<span class="keyword1"><span class="command">using</span></span> adm_below_monic_exists<span class="main">[</span><span class="operator">OF</span> _ below_monic_fun_K<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ValN</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> adm_disj <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cont_fun<span class="main">)</span>

<span class="keyword1" id="PCF-mono_PE_base_lf_rep"><span class="command">lemma</span></span> mono_PE_base_lf_rep<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mono PE_base_lf_rep"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> PE_base_lf_rep_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> monoI<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Again we close this under the function space, and show that it is
admissible, monotonic and respects the minimal invariant.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PE_lf_rep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> ValD<span class="main">)</span> lf_rep"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PE_lf_rep</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> PE_base_lf_rep <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∪</span> fn_lf_rep <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">PE_lf</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> mklr <span class="main">(</span>PE_lf_rep <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="PCF-admS_PE_lf"><span class="command">lemma</span></span> admS_PE_lf <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"PE_lf_rep <span class="free">r</span> <span class="main">∈</span> admS"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">∈</span> PE_lf_rep <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> PE_lf_rep_def PE_base_lf_rep_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> PE_lf_rep <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> PE_lf_rep_def
    <span class="keyword1"><span class="command">using</span></span> adm_PE_base_lf_rep<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> adm_fn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PCF-mono_PE_lf"><span class="command">lemma</span></span> mono_PE_lf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mono PE_lf"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">unfolding</span></span> PE_lf_rep_def
  <span class="keyword1"><span class="command">using</span></span> mono_fn_lf_rep mono_PE_base_lf_rep
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monoD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PCF-min_inv_PE_lf"><span class="command">lemma</span></span> min_inv_PE_lf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eRSV <span class="free">e</span> <span class="free">R'</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eRSV <span class="main">(</span>ValD_copy_rec<span class="main">⋅</span><span class="free">e</span><span class="main">)</span> <span class="main">(</span>dual <span class="main">(</span>PE_lf <span class="main">(</span>dual <span class="free">S'</span><span class="main">,</span> undual <span class="free">R'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PE_lf <span class="main">(</span><span class="free">R'</span><span class="main">,</span> <span class="free">S'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PE_lf_rep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PE_base_lf_rep_def eta_cfun cfcomp1 cfun_eq_iff<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fn_lf_rep_def eta_cfun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfcomp1 cfun_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">Λ</span> xa<span class="main">.</span> <span class="free">e</span><span class="main">⋅</span><span class="main">(</span><span class="improper">fs</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="free">e</span><span class="main">⋅</span><span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">interpretation</span></span> PE<span class="main">:</span> DomSolV <span class="quoted">PE_lf</span> <span class="quoted">ValD_copy_rec</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mono_PE_lf<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ValD_copy_ID<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> min_inv_PE_lf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PCF-PEI"><span class="command">lemma</span></span> PEI <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">∈</span> unlr PE.delta"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValTT<span class="main">)</span> <span class="main">∈</span> unlr PE.delta"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValFF<span class="main">)</span> <span class="main">∈</span> unlr PE.delta"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValN<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> unlr PE.delta"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">1</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> unlr PE.delta"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> unlr PE.delta"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> unlr PE.delta <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unlr PE.delta <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="free">fs</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unlr PE.delta"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> PE.delta_sol<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> PE_lf_rep_def<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PE_base_lf_rep_def fn_lf_rep_def eta_cfun cfcomp1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="PCF-PE_fun_constI"><span class="command">lemma</span></span> PE_fun_constI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> unlr PE.delta <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="free">f</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unlr PE.delta <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValF<span class="main">⋅</span><span class="free">f</span><span class="main">)</span> <span class="main">∈</span> unlr PE.delta"</span></span>
  <span class="keyword1"><span class="command">using</span></span> PEI<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> fs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">f</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PCF-PEE"><span class="command">lemma</span></span> PEE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">∈</span> unlr PE.delta<span class="main">;</span>
     <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValTT<span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValFF<span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ValN<span class="main">⋅</span><span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="free">a</span> <span class="main">1</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="free">a</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="main">⋀</span><span class="bound">fs</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> unlr PE.delta <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unlr PE.delta <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> PE.delta_sol<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> PE_lf_rep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PE_base_lf_rep_def fn_lf_rep_def eta_cfun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PCF-PEE_strict_appI"><span class="command">lemma</span></span> PEE_strict_appI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> unlr PE.delta"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> unlr PE.delta <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="free">fs</span> <span class="bound">j</span><span class="main">⋅</span><span class="main">(</span><span class="bound">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unlr PE.delta"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> strictify<span class="main">⋅</span><span class="main">(</span><span class="free">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unlr PE.delta"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> PEE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PCF-logical_relation_PE"><span class="command">lemma</span></span> logical_relation_PE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"logical_relation <span class="main">(</span>unlr PE.delta<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> logical_relationI<span class="main">)</span>

  <span class="comment1">(* Strict application *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> fs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> appF<span class="main">⋅</span><span class="main">(</span><span class="improper">fs</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> PEE_strict_appI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> PEE<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="comment1">(* FIXME fixD *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> PEE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fixD_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_argument_promote_fun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">Λ</span> f<span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="improper">fs</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fix_ind<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cont_fun<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> PEE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cond_def isZero_def pred_def succ_def eta_cfun <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PCF-PCF_consts_rel_PE"><span class="command">lemma</span></span> PCF_consts_rel_PE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PCF_consts_rel <span class="main">(</span>unlr PE.delta<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> PCF_consts_relI<span class="main">)</span> <span class="operator">simp_all</span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The solution satisfies the expectations of the fundamental theorem:

›</span></span>

<span class="keyword1" id="PCF-PCF_lr_PE_delta"><span class="command">lemma</span></span> PCF_lr_PE_delta<span class="main">:</span> <span class="quoted"><span class="quoted">"PCF_lr <span class="main">(</span>unlr PE.delta<span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> logical_relation_PE PCF_consts_rel_PE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1" id="PCF-lr_PE_arg_rel"><span class="command">lemma</span></span> lr_PE_arg_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"PE_arg_rel <span class="main">∈</span> unlr PE.delta"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> PE_arg_rel_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> PEI<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> PEE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">nat</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1" id="PCF-lr_PE_result_rel"><span class="command">lemma</span></span> lr_PE_result_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"PE_result_rel <span class="main">∉</span> unlr PE.delta"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">unfolding</span></span> PE_result_rel_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> PEE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> fun_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">theorem</span></span> PE_is_not_definable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> definable <span class="bound">f</span> <span class="main">∧</span> appFLv <span class="bound">f</span> <span class="main">[</span>PE_arg_rel<span class="main">]</span> <span class="main">=</span> PE_result_rel<span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> not_definable<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"unlr PE.delta"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> lr_PE_arg_rel lr_PE_result_rel PCF_lr_PE_delta
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Concluding remarks›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

These techniques could be used to show that Haskell's <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>seq›</span></span></span></span>
operation is not PCF-definable. (It is definable for each base
``type'' separately, and requires some care on function values.) If we
added an (unlifted) product type then it should be provable that
parallel evaluation is required to support <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>seq›</span></span></span></span> on these
objects (given <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>seq›</span></span></span></span> on all other objects). (See
\citet[\S5.4]{DBLP:conf/hopl/HudakHJW07} and sundry posts to the
internet by Lennart Augustsson.) This may be difficult to do plausibly
without adding a type system.

›</span></span>

<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="OpSem">
<div class="head">
<h1>Theory OpSem</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      OpSem.thy
    Author:     Peter Gammie
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Logical relations for computational adequacy›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">theory</span></span> OpSem
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Basis">Basis</a>
  <a href="#PCF">PCF</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* FIXME

Show Sangiorgi's divergence results. Convergence should be simply the
big-step semantics.

*)</span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:opsem}

We relate the denotational semantics for PCF of \S\ref{sec:densem} to
a \emph{big-step} (or \emph{natural}) operational semantics. This
follows \citet{DBLP:conf/mfps/Pitts93}.

›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Direct semantics using de Bruijn notation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:directsem_db}

In contrast to \S\ref{sec:directsem} we must be more careful in our
treatment of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>α›</span></span></span></span>-equivalent terms, as we would like our
operational semantics to identify of all these. To that end we adopt
de Bruijn notation, adapting the work of
\citet{DBLP:journals/jar/Nipkow01}, and show that it is suitably
equivalent to our original syntactic story.

›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> db <span class="main">=</span>
    DBVar <span class="quoted">var</span>
  <span class="main">|</span> DBApp <span class="quoted">db</span> <span class="quoted">db</span>
  <span class="main">|</span> DBAbsN <span class="quoted">db</span>
  <span class="main">|</span> DBAbsV <span class="quoted">db</span>
  <span class="main">|</span> DBDiverge
  <span class="main">|</span> DBFix <span class="quoted">db</span>
  <span class="main">|</span> DBtt
  <span class="main">|</span> DBff
  <span class="main">|</span> DBCond <span class="quoted">db</span> <span class="quoted">db</span> <span class="quoted">db</span>
  <span class="main">|</span> DBNum <span class="quoted">nat</span>
  <span class="main">|</span> DBSucc <span class="quoted">db</span>
  <span class="main">|</span> DBPred <span class="quoted">db</span>
  <span class="main">|</span> DBIsZero <span class="quoted">db</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Nipkow et al's substitution operation is defined for arbitrary open
terms. In our case we only substitute closed terms into terms where
only the variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> may be free, and while we could develop
a simpler account, we retain the traditional one.

›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">lift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"db <span class="main">⇒</span> nat <span class="main">⇒</span> db"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>DBVar <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBVar <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>DBAbsN <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBAbsN <span class="main">(</span><span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>DBAbsV <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBAbsV <span class="main">(</span><span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>DBApp <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBApp <span class="main">(</span><span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>DBFix <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBFix <span class="main">(</span><span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>DBCond <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBCond <span class="main">(</span><span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>DBSucc <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBSucc <span class="main">(</span><span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>DBPred <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBPred <span class="main">(</span><span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>DBIsZero <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBIsZero <span class="main">(</span><span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"db <span class="main">⇒</span> db <span class="main">⇒</span> var <span class="main">⇒</span> db"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">&lt;</span>_<span class="keyword1">'/</span>_<span class="keyword1">&gt;</span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  subst_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>DBVar <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> DBVar <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> DBVar <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> subst_AbsN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>DBAbsN <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="main">=</span> DBAbsN <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">&lt;</span></span>lift <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">0</span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main"><span class="free">&gt;</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> subst_AbsV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>DBAbsV <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="main">=</span> DBAbsV <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">&lt;</span></span>lift <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">0</span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main"><span class="free">&gt;</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> subst_App<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>DBApp <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="main">=</span> DBApp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>DBFix <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="main">=</span> DBFix <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">&lt;</span></span>lift <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">0</span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main"><span class="free">&gt;</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>DBCond <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="main">=</span> DBCond <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>DBSucc <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="main">=</span> DBSucc <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>DBPred <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="main">=</span> DBPred <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>DBIsZero <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="main">=</span> DBIsZero <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> subst_Consts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">declare</span></span> subst_Var <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="OpSem-subst_eq"><span class="command">lemma</span></span> subst_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>DBVar <span class="free">k</span><span class="main">)</span><span class="main">&lt;</span><span class="free">u</span><span class="main">/</span><span class="free">k</span><span class="main">&gt;</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_Var<span class="main">)</span>

<span class="keyword1" id="OpSem-subst_gt"><span class="command">lemma</span></span> subst_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">(</span>DBVar <span class="free">j</span><span class="main">)</span><span class="main">&lt;</span><span class="free">u</span><span class="main">/</span><span class="free">i</span><span class="main">&gt;</span> <span class="main">=</span> DBVar <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_Var<span class="main">)</span>

<span class="keyword1" id="OpSem-subst_lt"><span class="command">lemma</span></span> subst_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">(</span>DBVar <span class="free">j</span><span class="main">)</span><span class="main">&lt;</span><span class="free">u</span><span class="main">/</span><span class="free">i</span><span class="main">&gt;</span> <span class="main">=</span> DBVar <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_Var<span class="main">)</span>

<span class="keyword1" id="OpSem-lift_lift"><span class="command">lemma</span></span> lift_lift<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> lift <span class="main">(</span>lift <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> lift <span class="main">(</span>lift <span class="free">t</span> <span class="free">k</span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="OpSem-lift_subst"><span class="command">lemma</span></span> lift_subst<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> lift <span class="main">(</span><span class="free">t</span><span class="main">&lt;</span><span class="free">s</span><span class="main">/</span><span class="free">j</span><span class="main">&gt;</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>lift <span class="free">t</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">&lt;</span>lift <span class="free">s</span> <span class="free">i</span> <span class="main">/</span> <span class="free">j</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_Suc subst_Var lift_lift <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="OpSem-lift_subst_lt"><span class="command">lemma</span></span> lift_subst_lt<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> lift <span class="main">(</span><span class="free">t</span><span class="main">&lt;</span><span class="free">s</span><span class="main">/</span><span class="free">j</span><span class="main">&gt;</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>lift <span class="free">t</span> <span class="free">i</span><span class="main">)</span><span class="main">&lt;</span>lift <span class="free">s</span> <span class="free">i</span> <span class="main">/</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_Var lift_lift<span class="main">)</span>

<span class="keyword1" id="OpSem-subst_lift"><span class="command">lemma</span></span> subst_lift<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>lift <span class="free">t</span> <span class="free">k</span><span class="main">)</span><span class="main">&lt;</span><span class="free">s</span><span class="main">/</span><span class="free">k</span><span class="main">&gt;</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_eq subst_gt subst_lt<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> subst_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  subst_eq
  subst_gt
  subst_lt
  lift_subst
  subst_lift

<span class="keyword1" id="OpSem-subst_subst"><span class="command">lemma</span></span> subst_subst<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">t</span><span class="main">&lt;</span>lift <span class="free">v</span> <span class="free">i</span><span class="main">/</span>Suc <span class="free">j</span><span class="main">&gt;</span><span class="main">&lt;</span><span class="free">u</span><span class="main">&lt;</span><span class="free">v</span><span class="main">/</span><span class="free">j</span><span class="main">&gt;</span><span class="main">/</span><span class="free">i</span><span class="main">&gt;</span> <span class="main">=</span> <span class="free">t</span><span class="main">&lt;</span><span class="free">u</span><span class="main">/</span><span class="free">i</span><span class="main">&gt;</span><span class="main">&lt;</span><span class="free">v</span><span class="main">/</span><span class="free">j</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_Suc subst_Var lift_lift <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> lift_subst_lt
             <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We elide the standard lemmas about these operations.

A variable is free in a de Bruijn term in the standard way.

›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">freedb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"db <span class="main">⇒</span> var <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">freedb</span> <span class="main">(</span>DBVar <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">freedb</span> <span class="main">(</span>DBAbsN <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">freedb</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">freedb</span> <span class="main">(</span>DBAbsV <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">freedb</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">freedb</span> <span class="main">(</span>DBApp <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">freedb</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∨</span> <span class="free">freedb</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">freedb</span> <span class="main">(</span>DBFix <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">freedb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">freedb</span> <span class="main">(</span>DBCond <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">freedb</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∨</span> <span class="free">freedb</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∨</span> <span class="free">freedb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">freedb</span> <span class="main">(</span>DBSucc <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">freedb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">freedb</span> <span class="main">(</span>DBPred <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">freedb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> "</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">freedb</span> <span class="main">(</span>DBIsZero <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">freedb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">freedb</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="OpSem-subst_not_free"><span class="command">lemma</span></span> subst_not_free <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> freedb <span class="free">s</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">s</span><span class="main">&lt;</span><span class="free">t</span><span class="main">/</span><span class="free">i</span><span class="main">&gt;</span> <span class="main">=</span> <span class="free">s</span><span class="main">&lt;</span><span class="free">u</span><span class="main">/</span><span class="free">i</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_Var<span class="main">)</span>

<span class="keyword1" id="OpSem-free_lift"><span class="command">lemma</span></span> free_lift <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"freedb <span class="main">(</span>lift <span class="free">t</span> <span class="free">k</span><span class="main">)</span> <span class="free">i</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">∧</span> freedb <span class="free">t</span> <span class="free">i</span> <span class="main">∨</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> freedb <span class="free">t</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>

<span class="keyword1" id="OpSem-free_subst"><span class="command">lemma</span></span> free_subst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"freedb <span class="main">(</span><span class="free">s</span><span class="main">&lt;</span><span class="free">t</span><span class="main">/</span><span class="free">k</span><span class="main">&gt;</span><span class="main">)</span> <span class="free">i</span> <span class="main">⟷</span> <span class="main">(</span>freedb <span class="free">s</span> <span class="free">k</span> <span class="main">∧</span> freedb <span class="free">t</span> <span class="free">i</span> <span class="main">∨</span> freedb <span class="free">s</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="keyword1">then</span> <span class="free">i</span> <span class="keyword1">else</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  subst_Var <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> lift_subst_dummy<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> freedb <span class="free">s</span> <span class="free">i</span> <span class="main">⟹</span> lift <span class="main">(</span><span class="free">s</span><span class="main">&lt;</span><span class="free">dummy</span><span class="main">/</span><span class="free">i</span><span class="main">&gt;</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">dummy</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less_eq if_not_P<span class="main">)</span>

<span class="keyword1" id="OpSem-closed_lift"><span class="command">lemma</span></span> closed_lift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span> lift <span class="free">e</span> <span class="free">k</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> less_Suc_eq_0_disj nat.exhaust<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="OpSem-closed_subst"><span class="command">lemma</span></span> closed_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">&lt;</span><span class="free">s</span><span class="main">/</span><span class="free">k</span><span class="main">&gt;</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBAbsN <span class="skolem">e</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> lessE not_less_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBAbsV <span class="skolem">e</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> lessE not_less_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBFix <span class="skolem">e</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> lessE not_less_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Programs are closed expressions.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"db <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> freedb <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">i</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="OpSem-closed_inv"><span class="command">lemma</span></span> closed_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closed <span class="main">(</span>DBApp <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> closed <span class="free">f</span> <span class="main">∧</span> closed <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed DBDiverge"</span></span>
  <span class="quoted"><span class="quoted">"closed DBtt"</span></span>
  <span class="quoted"><span class="quoted">"closed DBff"</span></span>
  <span class="quoted"><span class="quoted">"closed <span class="main">(</span>DBCond <span class="free">c</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> closed <span class="free">c</span> <span class="main">∧</span> closed <span class="free">t</span> <span class="main">∧</span> closed <span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed <span class="main">(</span>DBNum <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed <span class="main">(</span>DBSucc <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> closed <span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed <span class="main">(</span>DBPred <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> closed <span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed <span class="main">(</span>DBIsZero <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> closed <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="OpSem-closed_binders"><span class="command">lemma</span></span> closed_binders<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closed <span class="main">(</span>DBAbsN <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed <span class="main">(</span>DBAbsV <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed <span class="main">(</span>DBFix <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closed_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">i</span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> closed_invs <span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span>
  closed_inv
  closed_binders

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The direct denotational semantics is almost identical to that given in
\S\ref{sec:densem}, apart from this change in the representation of
environments.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">env_empty_db</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Env"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">env_empty_db</span> <span class="main">≡</span> <span class="main">⊥</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">env_ext_db</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'a</span> Env <span class="main">→</span> <span class="tfree">'a</span> Env"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">env_ext_db</span> <span class="main">≡</span> <span class="keyword1">Λ</span> x ρ v<span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="bound">x</span> <span class="main">|</span> Suc <span class="bound">v'</span> <span class="main">⇒</span> <span class="bound">ρ</span><span class="main">⋅</span><span class="bound">v'</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="OpSem-env_ext_same_db"><span class="command">lemma</span></span> env_ext_same_db<span class="main">:</span> <span class="quoted"><span class="quoted">"env_ext_db<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">ρ</span><span class="main">⋅</span><span class="main">0</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_ext_db_def<span class="main">)</span>

<span class="keyword1" id="OpSem-env_ext_neq_db"><span class="command">lemma</span></span> env_ext_neq_db<span class="main">:</span> <span class="quoted"><span class="quoted">"env_ext_db<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">ρ</span><span class="main">⋅</span><span class="main">(</span>Suc <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ</span><span class="main">⋅</span><span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_ext_db_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> env_ext_db_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  env_ext_same_db
  env_ext_neq_db
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">evalDdb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"db <span class="main">⇒</span> ValD Env <span class="main">→</span> ValD"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">evalDdb</span> <span class="main">(</span>DBVar <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="bound">ρ</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalDdb</span> <span class="main">(</span>DBApp <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> appF<span class="main">⋅</span><span class="main">(</span><span class="free">evalDdb</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">evalDdb</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalDdb</span> <span class="main">(</span>DBAbsN <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="free">evalDdb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="main">(</span>env_ext_db<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalDdb</span> <span class="main">(</span>DBAbsV <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span>strictify<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="free">evalDdb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="main">(</span>env_ext_db<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalDdb</span> <span class="main">(</span>DBDiverge<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalDdb</span> <span class="main">(</span>DBFix <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="keyword1">μ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">evalDdb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="main">(</span>env_ext_db<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalDdb</span> <span class="main">(</span>DBtt<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> ValTT<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalDdb</span> <span class="main">(</span>DBff<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> ValFF<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalDdb</span> <span class="main">(</span>DBCond <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> cond<span class="main">⋅</span><span class="main">(</span><span class="free">evalDdb</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">evalDdb</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">evalDdb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalDdb</span> <span class="main">(</span>DBNum <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> ValN<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalDdb</span> <span class="main">(</span>DBSucc <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> succ<span class="main">⋅</span><span class="main">(</span><span class="free">evalDdb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalDdb</span> <span class="main">(</span>DBPred <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> pred<span class="main">⋅</span><span class="main">(</span><span class="free">evalDdb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalDdb</span> <span class="main">(</span>DBIsZero <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> isZero<span class="main">⋅</span><span class="main">(</span><span class="free">evalDdb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="comment1">(* This proof is trivial but Isabelle doesn't seem keen enough to
apply the induction hypothesises in the obvious ways. *)</span>
<span class="keyword1" id="OpSem-evalDdb_env_cong"><span class="command">lemma</span></span> evalDdb_env_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="free">ρ</span><span class="main">⋅</span><span class="bound">v</span> <span class="main">=</span> <span class="free">ρ'</span><span class="main">⋅</span><span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evalDdb <span class="free">e</span><span class="main">⋅</span><span class="free">ρ</span> <span class="main">=</span> evalDdb <span class="free">e</span><span class="main">⋅</span><span class="free">ρ'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">ρ'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBApp <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">ρ</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> DBApp.hyps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ρ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ρ</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ρ'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ρ'</span></span></span></span><span class="main">]</span> DBApp.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBAbsN <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">from</span></span> DBAbsN.hyps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ρ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"env_ext_db<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ρ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"env_ext_db<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">ρ'</span>"</span></span><span class="main">]</span> DBAbsN.prems
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"evalDdb <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>env_ext_db<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">=</span> evalDdb <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>env_ext_db<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">ρ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_ext_db_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBAbsV <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">from</span></span> DBAbsV.hyps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ρ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"env_ext_db<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ρ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"env_ext_db<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">ρ'</span>"</span></span><span class="main">]</span> DBAbsV.prems
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"evalDdb <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>env_ext_db<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">=</span> evalDdb <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>env_ext_db<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">ρ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_ext_db_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBFix <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="skolem">ρ'</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> parallel_fix_ind<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_ext_db_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBCond <span class="skolem">i</span> <span class="skolem">t</span> <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> DBCond.hyps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ρ<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ρ</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> ρ'<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ρ'</span></span></span></span></span></span><span class="main">]</span> DBCond.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBSucc <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> DBSucc.hyps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ρ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ρ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ρ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ρ'</span></span><span class="main">]</span> DBSucc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBPred <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> DBPred.hyps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ρ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ρ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ρ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ρ'</span></span><span class="main">]</span> DBPred.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBIsZero <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> DBIsZero.hyps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ρ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ρ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ρ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ρ'</span></span><span class="main">]</span> DBIsZero.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff<span class="main">)</span>

<span class="keyword1" id="OpSem-evalDdb_env_closed"><span class="command">lemma</span></span> evalDdb_env_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evalDdb <span class="free">e</span><span class="main">⋅</span><span class="free">ρ</span> <span class="main">=</span> evalDdb <span class="free">e</span><span class="main">⋅</span><span class="free">ρ'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> evalDdb_env_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> closed_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We show that our direct semantics using de Bruijn notation coincides
with the evaluator of \S\ref{sec:directsem} by translating between the
syntaxes and showing that the evaluators yield identical results.

Firstly we show how to translate an expression using names into a
nameless term. The following function finds the first mention of a
variable in a list of variables.

›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var list <span class="main">⇒</span> var <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> <span class="free">index</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">transdb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"expr <span class="main">⇒</span> var list <span class="main">⇒</span> db"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">transdb</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> DBVar <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> DBApp <span class="main">(</span><span class="free">transdb</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">transdb</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb</span> <span class="main">(</span>AbsN <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> DBAbsN <span class="main">(</span><span class="free">transdb</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb</span> <span class="main">(</span>AbsV <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> DBAbsV <span class="main">(</span><span class="free">transdb</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb</span> <span class="main">(</span>Diverge<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> DBDiverge"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb</span> <span class="main">(</span>Fix <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> DBFix <span class="main">(</span><span class="free">transdb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb</span> <span class="main">(</span>tt<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> DBtt"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb</span> <span class="main">(</span>ff<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> DBff"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb</span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> DBCond <span class="main">(</span><span class="free">transdb</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">transdb</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">transdb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb</span> <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">(</span>DBNum <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb</span> <span class="main">(</span>Succ <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> DBSucc <span class="main">(</span><span class="free">transdb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb</span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> DBPred <span class="main">(</span><span class="free">transdb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb</span> <span class="main">(</span>IsZero <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> DBIsZero <span class="main">(</span><span class="free">transdb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This semantics corresponds with the direct semantics for named
expressions.

›</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The free variables of an expression using names.›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">free</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"expr <span class="main">⇒</span> var list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">free</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">free</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">@</span> <span class="free">free</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free</span> <span class="main">(</span>AbsN <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> removeAll <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free">free</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free</span> <span class="main">(</span>AbsV <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> removeAll <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free">free</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free</span> <span class="main">(</span>Fix <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> removeAll <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free">free</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free</span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">free</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">@</span> <span class="free">free</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">@</span> <span class="free">free</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free</span> <span class="main">(</span>Succ <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">free</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free</span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">free</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free</span> <span class="main">(</span>IsZero <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">free</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">free</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1" id="OpSem-index_Suc"><span class="command">lemma</span></span> index_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"index <span class="free">Γ</span> <span class="free">v</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>index <span class="free">Γ</span> <span class="free">v</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="OpSem-evalD_evalDdb_open"><span class="command">lemma</span></span> evalD_evalDdb_open<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>free <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set <span class="free">Γ</span><span class="main">.</span> <span class="free">ρ'</span><span class="main">⋅</span><span class="main">(</span>index <span class="free">Γ</span> <span class="bound">v</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ</span><span class="main">⋅</span><span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">e</span><span class="main">⟧</span><span class="free">ρ</span> <span class="main">=</span> evalDdb <span class="main">(</span>transdb <span class="free">e</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ρ'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">ρ'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> AbsN <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> AbsN.hyps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff env_ext_db_def index_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> AbsV <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span><span class="main">=</span><span class="main">⊥</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> AbsV.hyps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff env_ext_db_def index_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Fix <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_fix_ind<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Fix.hyps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff env_ext_db_def index_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1" id="OpSem-evalD_evalDdb"><span class="command">lemma</span></span> evalD_evalDdb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"free <span class="free">e</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">e</span><span class="main">⟧</span><span class="free">ρ</span> <span class="main">=</span> evalDdb <span class="main">(</span>transdb <span class="free">e</span> <span class="main">[]</span><span class="main">)</span><span class="main">⋅</span><span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> evalD_evalDdb_open<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Conversely, all de Bruijn expressions have named equivalents.

›</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">transdb_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"db <span class="main">⇒</span> <span class="main">(</span>var <span class="main">⇒</span> var<span class="main">)</span> <span class="main">⇒</span> var <span class="main">⇒</span> var <span class="main">⇒</span> expr"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">transdb_inv</span> <span class="main">(</span>DBVar <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> Var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb_inv</span> <span class="main">(</span>DBApp <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> App <span class="main">(</span><span class="free">transdb_inv</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">transdb_inv</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb_inv</span> <span class="main">(</span>DBAbsN <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> AbsN <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">transdb_inv</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>case_nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb_inv</span> <span class="main">(</span>DBAbsV <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> AbsV <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">transdb_inv</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>case_nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb_inv</span> <span class="main">(</span>DBDiverge<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> Diverge"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb_inv</span> <span class="main">(</span>DBFix <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> Fix <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">transdb_inv</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>case_nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb_inv</span> <span class="main">(</span>DBtt<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> tt"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb_inv</span> <span class="main">(</span>DBff<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> ff"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb_inv</span> <span class="main">(</span>DBCond <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span>
                     Cond <span class="main">(</span><span class="free">transdb_inv</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">transdb_inv</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">transdb_inv</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb_inv</span> <span class="main">(</span>DBNum <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb_inv</span> <span class="main">(</span>DBSucc <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> Succ <span class="main">(</span><span class="free">transdb_inv</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb_inv</span> <span class="main">(</span>DBPred <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> Pred <span class="main">(</span><span class="free">transdb_inv</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">transdb_inv</span> <span class="main">(</span>DBIsZero <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> IsZero <span class="main">(</span><span class="free">transdb_inv</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="comment1">(* FIXME These proofs are ghastly. Is there a better way to do this? *)</span>

<span class="keyword1" id="OpSem-transdb_inv_open"><span class="command">lemma</span></span> transdb_inv_open<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">&lt;</span> <span class="free">c</span> <span class="main">+</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="free">Γ</span> <span class="bound">v</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">v</span> <span class="keyword1">then</span> <span class="bound">v</span> <span class="main">-</span> <span class="free">k</span> <span class="keyword1">else</span> <span class="free">c</span> <span class="main">+</span> <span class="free">k</span> <span class="main">-</span> <span class="bound">v</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">v</span> <span class="keyword1">then</span> index <span class="free">Γ'</span> <span class="main">(</span><span class="bound">v</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">else</span> index <span class="free">Γ'</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="free">k</span> <span class="main">-</span> <span class="bound">v</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"transdb <span class="main">(</span>transdb_inv <span class="free">e</span> <span class="free">Γ</span> <span class="free">c</span> <span class="free">k</span><span class="main">)</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">Γ'</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> DBVar <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBApp <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">Γ</span> <span class="skolem">Γ'</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ'</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBAbsN <span class="skolem">e</span> <span class="skolem">Γ</span> <span class="skolem">Γ'</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> DBAbsN.hyps<span class="main">)</span>

    <span class="keyword1"><span class="command">using</span></span> DBAbsN
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">using</span></span> DBAbsN
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

    <span class="keyword1"><span class="command">using</span></span> DBAbsN
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> index_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBAbsV <span class="skolem">e</span> <span class="skolem">Γ</span> <span class="skolem">Γ'</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> DBAbsV.hyps<span class="main">)</span>

    <span class="keyword1"><span class="command">using</span></span> DBAbsV
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">using</span></span> DBAbsV
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

    <span class="keyword1"><span class="command">using</span></span> DBAbsV
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> index_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBFix <span class="skolem">e</span> <span class="skolem">Γ</span> <span class="skolem">Γ'</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> DBFix.hyps<span class="main">)</span>

    <span class="keyword1"><span class="command">using</span></span> DBFix
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">using</span></span> DBFix
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

    <span class="keyword1"><span class="command">using</span></span> DBFix
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> index_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBCond <span class="skolem">i</span> <span class="skolem">t</span> <span class="skolem">e</span> <span class="skolem">Γ</span> <span class="skolem">Γ'</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ'</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1" id="OpSem-transdb_inv"><span class="command">lemma</span></span> transdb_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"transdb <span class="main">(</span>transdb_inv <span class="free">e</span> <span class="free">Γ</span> <span class="free">c</span> <span class="free">k</span><span class="main">)</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> transdb_inv_open assms
  <span class="keyword1"><span class="command">unfolding</span></span> closed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="OpSem-closed_transdb_inv_aux"><span class="command">lemma</span></span> closed_transdb_inv_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="free">Γ</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">k</span> <span class="main">-</span> <span class="bound">v</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>free <span class="main">(</span>transdb_inv <span class="free">e</span> <span class="free">Γ</span> <span class="main">0</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">∧</span> freedb <span class="free">e</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBAbsN <span class="skolem">e</span> <span class="skolem">Γ</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"case_nat <span class="skolem">k</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="skolem">e</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">&lt;</span> Suc <span class="skolem">k</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="skolem">e</span> <span class="bound">v</span> <span class="main">⟶</span> case_nat <span class="skolem">k</span> <span class="skolem">Γ</span> <span class="bound">v</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">-</span> <span class="bound">v</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">-</span> <span class="free">i</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">-</span> <span class="free">i</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBAbsV <span class="skolem">e</span> <span class="skolem">Γ</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"case_nat <span class="skolem">k</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="skolem">e</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">&lt;</span> Suc <span class="skolem">k</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="skolem">e</span> <span class="bound">v</span> <span class="main">⟶</span> case_nat <span class="skolem">k</span> <span class="skolem">Γ</span> <span class="bound">v</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">-</span> <span class="bound">v</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">-</span> <span class="free">i</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">-</span> <span class="free">i</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBFix <span class="skolem">e</span> <span class="skolem">Γ</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"case_nat <span class="skolem">k</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="skolem">e</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">&lt;</span> Suc <span class="skolem">k</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="skolem">e</span> <span class="bound">v</span> <span class="main">⟶</span> case_nat <span class="skolem">k</span> <span class="skolem">Γ</span> <span class="bound">v</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">-</span> <span class="bound">v</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">-</span> <span class="free">i</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">-</span> <span class="free">i</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="OpSem-closed_transdb_inv"><span class="command">lemma</span></span> closed_transdb_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"free <span class="main">(</span>transdb_inv <span class="free">e</span> <span class="free">Γ</span> <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms closed_transdb_inv_aux<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> e<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">e</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> closed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="comment1">(*&gt;*)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Operational Semantics›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹

The evaluation relation (big-step, or natural operational
semantics). This is similar to \citet[\S6.2]{Gunter:1992},
\citet{DBLP:conf/mfps/Pitts93} and \citet[Chapter~11]{Winskel:1993}.

We firstly define the \emph{values} that expressions can evaluate to:
these are either constants or closed abstractions.

›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"db <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  v_Num<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">val</span> <span class="main">(</span>DBNum <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> v_FF<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">val</span> DBff"</span></span>
<span class="main">|</span> v_TT<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">val</span> DBtt"</span></span>
<span class="main">|</span> v_AbsN<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">val</span> <span class="main">(</span>DBAbsN <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> v_AbsV<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">val</span> <span class="main">(</span>DBAbsV <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">evalOP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"db <span class="main">⇒</span> db <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⇓</span> _"</span> <span class="main">[</span>50<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  evalOP_AppN<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⇓</span></span> DBAbsN <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> DBApp <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span>"</span></span> <span class="comment1">(* Non-strict application *)</span>
<span class="main">|</span> evalOP_AppV<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⇓</span></span> DBAbsV <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> DBApp <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span>"</span></span> <span class="comment1">(* Strict application *)</span>
<span class="main">|</span> evalOP_AbsN<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"val <span class="main">(</span>DBAbsN <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">⟹</span> DBAbsN <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇓</span></span> DBAbsN <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> evalOP_AbsV<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"val <span class="main">(</span>DBAbsV <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">⟹</span> DBAbsV <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇓</span></span> DBAbsV <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> evalOP_Fix<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">&lt;</span>DBFix <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟹</span> DBFix <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span>"</span></span> <span class="comment1">(* Non-strict fix *)</span>
<span class="main">|</span> evalOP_tt<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"DBtt <span class="main"><span class="free">⇓</span></span> DBtt"</span></span>
<span class="main">|</span> evalOP_ff<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"DBff <span class="main"><span class="free">⇓</span></span> DBff"</span></span>
<span class="main">|</span> evalOP_CondTT<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main"><span class="free">⇓</span></span> DBtt<span class="main">;</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> DBCond <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span>"</span></span>
<span class="main">|</span> evalOP_CondFF<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main"><span class="free">⇓</span></span> DBff<span class="main">;</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> DBCond <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span>  <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span>"</span></span>
<span class="main">|</span> evalOP_Num<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"DBNum <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⇓</span></span> DBNum <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> evalOP_Succ<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⇓</span></span> DBNum <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span> DBSucc <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⇓</span></span> DBNum <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> evalOP_Pred<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⇓</span></span> DBNum <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">⟹</span> DBPred <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⇓</span></span> DBNum <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> evalOP_IsZeroTT<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main"><span class="free">⇓</span></span> DBNum <span class="main">0</span> <span class="main">⟧</span> <span class="main">⟹</span> DBIsZero <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main"><span class="free">⇓</span></span> DBtt"</span></span>
<span class="main">|</span> evalOP_IsZeroFF<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main"><span class="free">⇓</span></span> DBNum <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> DBIsZero <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main"><span class="free">⇓</span></span> DBff"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

It is straightforward to show that this relation is deterministic and
sound with respect to the denotational semantics.

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> evalOP_inv <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DBApp <span class="free">P</span> <span class="free">Q</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBAbsN <span class="free">e</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBAbsV <span class="free">e</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBFix <span class="free">P</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBtt <span class="main">⇓</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBff <span class="main">⇓</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBCond <span class="free">C</span> <span class="free">T</span> <span class="free">E</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBNum <span class="free">n</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBSucc <span class="free">E</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBPred <span class="free">E</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBIsZero <span class="free">E</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span>

<span class="keyword1" id="OpSem-eval_val"><span class="command">lemma</span></span> eval_val<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"val <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⇓</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="OpSem-eval_to"><span class="command">lemma</span></span> eval_to <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⇓</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"val <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="OpSem-evalOP_deterministic"><span class="command">lemma</span></span> evalOP_deterministic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇓</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇓</span> <span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="free">V'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">V'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evalOP.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> evalOP_AppV <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> db.distinct<span class="main"><span class="main">(</span></span>47<span class="main"><span class="main">)</span></span> db.inject<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> evalOP_inv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="OpSem-evalOP_closed"><span class="command">lemma</span></span> evalOP_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇓</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">V</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">using</span></span> closed_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The denotational semantics respects substitution.›</span></span>

<span class="keyword1" id="OpSem-evalDdb_lift"><span class="command">lemma</span></span> evalDdb_lift <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"evalDdb <span class="main">(</span>lift <span class="free">s</span> <span class="free">k</span><span class="main">)</span><span class="main">⋅</span><span class="free">ρ</span> <span class="main">=</span> evalDdb <span class="free">s</span><span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> i<span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="keyword1">then</span> <span class="free">ρ</span><span class="main">⋅</span><span class="bound">i</span> <span class="keyword1">else</span> <span class="free">ρ</span><span class="main">⋅</span><span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> DBAbsN <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff env_ext_db_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_arg_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> DBAbsV <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff env_ext_db_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span><span class="main">=</span><span class="main">⊥</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> cfun_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> cfun_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> cfun_cong<span class="main">)</span> <span class="comment1">(* FIXME weird *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> cfun_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBFix <span class="skolem">s</span> <span class="skolem">k</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff env_ext_db_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_fix_ind<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_arg_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="OpSem-evalDdb_subst"><span class="command">lemma</span></span> evalDdb_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evalDdb <span class="main">(</span><span class="free">e</span><span class="main">&lt;</span><span class="free">s</span><span class="main">/</span><span class="free">x</span><span class="main">&gt;</span><span class="main">)</span><span class="main">⋅</span><span class="free">ρ</span> <span class="main">=</span> evalDdb <span class="free">e</span><span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> i<span class="main">.</span> <span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="keyword1">then</span> <span class="free">ρ</span><span class="main">⋅</span><span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> evalDdb <span class="free">s</span><span class="main">⋅</span><span class="free">ρ</span> <span class="keyword1">else</span> <span class="free">ρ</span><span class="main">⋅</span><span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBFix <span class="skolem">e</span> <span class="skolem">s</span> <span class="skolem">x</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> evalDdb.simps subst.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_fix_ind<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff eta_cfun env_ext_db_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cfun_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff eta_cfun env_ext_db_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cfun_cong<span class="main">)</span>

<span class="keyword1" id="OpSem-evalDdb_subst_env_ext_db"><span class="command">lemma</span></span> evalDdb_subst_env_ext_db<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evalDdb <span class="main">(</span><span class="free">e</span><span class="main">&lt;</span><span class="free">s</span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span><span class="main">)</span><span class="main">⋅</span><span class="free">ρ</span> <span class="main">=</span> evalDdb <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>env_ext_db<span class="main">⋅</span><span class="main">(</span>evalDdb <span class="free">s</span><span class="main">⋅</span><span class="free">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="free">ρ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> evalDdb_subst env_ext_db_def cfun_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cfun_arg_cong<span class="main">)</span>

<span class="keyword1" id="OpSem-eval_val_not_bot"><span class="command">lemma</span></span> eval_val_not_bot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇓</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evalDdb <span class="free">V</span><span class="main">⋅</span><span class="free">ρ</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> val.induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eval_to<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">theorem</span></span> evalOP_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⇓</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evalDdb <span class="free">P</span><span class="main">⋅</span><span class="free">ρ</span> <span class="main">=</span> evalDdb <span class="free">V</span><span class="main">⋅</span><span class="free">ρ</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> evalOP_AppN <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> evalOP_AppN<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> evalDdb_subst_env_ext_db<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>evalOP_AppV <span class="skolem">P</span> <span class="skolem">M</span> <span class="skolem">Q</span> <span class="skolem">q</span> <span class="skolem">V</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> evalOP_AppV<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_val_not_bot strictify_cancel evalDdb_subst_env_ext_db<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>evalOP_Fix <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"evalDdb <span class="skolem">V</span><span class="main">⋅</span><span class="skolem">ρ</span> <span class="main">=</span> evalDdb <span class="main">(</span><span class="skolem">P</span><span class="main">&lt;</span>DBFix <span class="skolem">P</span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> evalOP_Fix <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> evalDdb <span class="skolem">P</span><span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> i<span class="main">.</span> <span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="keyword1">then</span> <span class="skolem">ρ</span><span class="main">⋅</span><span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">x</span><span class="main">.</span> evalDdb <span class="skolem">P</span><span class="main">⋅</span><span class="main">(</span>env_ext_db<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="skolem">ρ</span><span class="main">⋅</span><span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> evalDdb_subst<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_arg_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> evalDdb <span class="main">(</span>DBFix <span class="skolem">P</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fix_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_ext_db_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_arg_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff env_ext_db_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_def isZero_def pred_def succ_def<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can use soundness to conclude that POR is not definable
operationally either. We rely on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] "transdb_inv"<span class="antiquote"><span class="antiquote">}</span></span></span></span> to map
our de Bruijn term into the syntactic universe of
\S\ref{sec:directsem} and appeal to the results of
\S\ref{sec:por}. This takes some effort as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"ValD"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> contains
irrelevant junk that makes it hard to draw obvious conclusions; we use
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>DBCond›</span></span></span></span> to restrict the arguments to the putative witness.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isPORdb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> closed <span class="free"><span class="bound"><span class="entity">e</span></span></span>
    <span class="main">∧</span> DBApp <span class="main">(</span>DBApp <span class="free"><span class="bound"><span class="entity">e</span></span></span> DBtt<span class="main">)</span> DBDiverge <span class="main">⇓</span> DBtt
    <span class="main">∧</span> DBApp <span class="main">(</span>DBApp <span class="free"><span class="bound"><span class="entity">e</span></span></span> DBDiverge<span class="main">)</span> DBtt <span class="main">⇓</span> DBtt
    <span class="main">∧</span> DBApp <span class="main">(</span>DBApp <span class="free"><span class="bound"><span class="entity">e</span></span></span> DBff<span class="main">)</span> DBff <span class="main">⇓</span> DBff"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1" id="OpSem-ValD_strict"><span class="command">lemma</span></span> ValD_strict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span><span class="main">⋅</span><span class="free">a</span><span class="main">⋅</span><span class="free">b</span> <span class="main">=</span> ValTT<span class="main">;</span> <span class="free">f</span><span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span> <span class="main">=</span> ValFF <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> monofun_cfun<span class="main">[</span><span class="operator">OF</span> monofun_cfun_arg<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">⊥</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⊥</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">y</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      monofun_cfun<span class="main">[</span><span class="operator">OF</span> monofun_cfun_arg<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">⊥</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⊥</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">⋅</span><span class="main">⊥</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="OpSem-ValD_ValTT"><span class="command">lemma</span></span> ValD_ValTT<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">⋅</span>ValTT <span class="main">=</span> ValTT<span class="main">;</span> <span class="free">f</span><span class="main">⋅</span>ValTT<span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> ValTT <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">⋅</span>ValTT<span class="main">⋅</span>ValTT <span class="main">=</span> ValTT"</span></span>
<span class="keyword1"><span class="command">using</span></span> monofun_cfun<span class="main">[</span><span class="operator">OF</span> monofun_cfun_arg<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">⊥</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ValTT"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ValTT"</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span>ValTT<span class="main">⋅</span>ValTT"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1" id="OpSem-POR_is_not_operationally_definable"><span class="command">lemma</span></span> POR_is_not_operationally_definable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>isPORdb <span class="free">e</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> notI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"isPORdb <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?porV</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ValF<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> y<span class="main">.</span> <span class="bound">x</span> <span class="keyword1">por</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">e</span>
     <span class="main">∧</span> evalDdb <span class="main">(</span>DBApp <span class="main">(</span>DBApp <span class="free">e</span> DBtt<span class="main">)</span> DBDiverge<span class="main">)</span><span class="main">⋅</span><span class="skolem">ρ</span> <span class="main">=</span> ValTT
     <span class="main">∧</span> evalDdb <span class="main">(</span>DBApp <span class="main">(</span>DBApp <span class="free">e</span> DBDiverge<span class="main">)</span> DBtt<span class="main">)</span><span class="main">⋅</span><span class="skolem">ρ</span> <span class="main">=</span> ValTT
     <span class="main">∧</span> evalDdb <span class="main">(</span>DBApp <span class="main">(</span>DBApp <span class="free">e</span> DBff<span class="main">)</span> DBff<span class="main">)</span><span class="main">⋅</span><span class="skolem">ρ</span> <span class="main">=</span> ValFF"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ρ</span>
    <span class="keyword1"><span class="command">unfolding</span></span> isPORdb_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> evalOP_sound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ρ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">ρ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="free">e</span>
      <span class="main">∧</span> <span class="main">⟦</span>transdb_inv <span class="main">(</span>DBApp <span class="main">(</span>DBApp <span class="free">e</span> DBtt<span class="main">)</span> DBDiverge<span class="main">)</span> id <span class="main">0</span> <span class="main">0</span><span class="main">⟧</span><span class="skolem">ρ</span> <span class="main">=</span> ValTT
      <span class="main">∧</span> <span class="main">⟦</span>transdb_inv <span class="main">(</span>DBApp <span class="main">(</span>DBApp <span class="free">e</span> DBDiverge<span class="main">)</span> DBtt<span class="main">)</span> id <span class="main">0</span> <span class="main">0</span><span class="main">⟧</span><span class="skolem">ρ</span> <span class="main">=</span> ValTT
      <span class="main">∧</span> <span class="main">⟦</span>transdb_inv <span class="main">(</span>DBApp <span class="main">(</span>DBApp <span class="free">e</span> DBff<span class="main">)</span> DBff<span class="main">)</span> id <span class="main">0</span> <span class="main">0</span><span class="main">⟧</span><span class="skolem">ρ</span> <span class="main">=</span> ValFF"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ρ</span>
    <span class="comment1">(* id is arbitrary here *)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> evalD_evalDdb transdb_inv closed_transdb_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> F <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="main">(</span>appF<span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span>transdb_inv <span class="free">e</span> id <span class="main">0</span> <span class="main">0</span><span class="main">⟧</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ρ</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ValD_strict<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="keyword1">Λ</span> x y<span class="main">.</span> appF<span class="main">⋅</span><span class="main">(</span>appF<span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span>transdb_inv <span class="free">e</span> id <span class="main">0</span> <span class="main">0</span><span class="main">⟧</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span><span class="main">⋅</span><span class="bound">y</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> F <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"appF<span class="main">⋅</span><span class="main">(</span>appF<span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span>transdb_inv <span class="free">e</span> id <span class="main">0</span> <span class="main">0</span><span class="main">⟧</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">⋅</span>ValTT<span class="main">)</span><span class="main">⋅</span>ValTT <span class="main">=</span> ValTT"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ρ</span>
    <span class="keyword1"><span class="command">using</span></span> ValD_ValTT<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">Λ</span> x y<span class="main">.</span> appF<span class="main">⋅</span><span class="main">(</span>appF<span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span>transdb_inv <span class="free">e</span> id <span class="main">0</span> <span class="main">0</span><span class="main">⟧</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span><span class="main">⋅</span><span class="bound">y</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"AbsN <span class="main">0</span> <span class="main">(</span>AbsN <span class="main">1</span> <span class="main">(</span>App <span class="main">(</span>App <span class="main">(</span>transdb_inv <span class="free">e</span> id <span class="main">0</span> <span class="main">0</span><span class="main">)</span>
                                     <span class="main">(</span>Cond <span class="main">(</span>Var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Cond <span class="main">(</span>Var <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Var <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Var <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span>
                                     <span class="main">(</span>Cond <span class="main">(</span>Var <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Var <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Cond <span class="main">(</span>Var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Var <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> F G H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="var">?f</span><span class="main">⟧</span>env_empty <span class="main">=</span> <span class="var">?porV</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff cond_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">xa</span></span></span></span></span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> POR_sat <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"definable <span class="var">?porV</span> <span class="main">∧</span> appFLv <span class="var">?porV</span> <span class="main">[</span>POR_arg1_rel<span class="main">,</span> POR_arg2_rel<span class="main">]</span> <span class="main">=</span> POR_result_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> definable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> POR_is_not_definable <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Computational Adequacy›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:compad}

The lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] "evalOP_sound"<span class="antiquote"><span class="antiquote">}</span></span></span></span> tells us that the operational
semantics preserves the denotational semantics. We might also hope
that the two are somehow equivalent, but due to the junk in the
domain-theoretic model (see \S\ref{sec:pcfdefinability}) we cannot
expect this to be entirely straightforward. Here we show that the
denotational semantics is \emph{computationally adequate}, which means
that it can be used to soundly reason about contextual equivalence.

We follow \citet{DBLP:conf/mfps/Pitts93,PittsAM:relpod} by defining a
suitable logical relation between our <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"ValD"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> domain and the set
of programs (closed terms). These are termed "formal approximation
relations" by Plotkin. The machinery of \S\ref{sec:synlr} requires us
to define a unique bottom element, which in this case is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="main"><span class="main">⊥</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">×</span></span>
<span class="main"><span class="main">{</span></span> <span class="bound"><span class="bound">P</span></span> <span class="main"><span class="main">.</span></span> closed <span class="bound"><span class="bound">P</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. To that end we define the type of programs.

›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> Prog <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">P</span><span class="main">.</span> closed <span class="bound">P</span> <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> unProg mkProg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ca_lf_rep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ValD<span class="main">,</span> Prog<span class="main">)</span> synlf_rep"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ca_lf_rep</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">rm</span><span class="main">,</span> <span class="bound">rp</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="main">{</span><span class="main">⊥</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span>
     <span class="main">∪</span> <span class="main">{</span> <span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">P</span><span class="main">)</span> <span class="main">|</span><span class="bound">d</span> <span class="bound">P</span><span class="main">.</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">d</span> <span class="main">=</span> ValN<span class="main">⋅</span><span class="bound">n</span> <span class="main">∧</span> unProg <span class="bound">P</span> <span class="main">⇓</span> DBNum <span class="bound">n</span><span class="main">)</span>
      <span class="main">∨</span> <span class="main">(</span><span class="bound">d</span> <span class="main">=</span> ValTT <span class="main">∧</span> unProg <span class="bound">P</span> <span class="main">⇓</span> DBtt<span class="main">)</span>
      <span class="main">∨</span> <span class="main">(</span><span class="bound">d</span> <span class="main">=</span> ValFF <span class="main">∧</span> unProg <span class="bound">P</span> <span class="main">⇓</span> DBff<span class="main">)</span>
      <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">d</span> <span class="main">=</span> ValF<span class="main">⋅</span><span class="bound">f</span> <span class="main">∧</span> unProg <span class="bound">P</span> <span class="main">⇓</span> DBAbsN <span class="bound">M</span>
              <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> unsynlr <span class="main">(</span>undual <span class="bound">rm</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span><span class="main">⋅</span><span class="bound">x</span><span class="main">,</span> mkProg <span class="main">(</span><span class="bound">M</span><span class="main">&lt;</span>unProg <span class="bound">X</span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unsynlr <span class="bound">rp</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">d</span> <span class="main">=</span> ValF<span class="main">⋅</span><span class="bound">f</span> <span class="main">∧</span> unProg <span class="bound">P</span> <span class="main">⇓</span> DBAbsV <span class="bound">M</span> <span class="main">∧</span> <span class="bound">f</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>
              <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> unsynlr <span class="main">(</span>undual <span class="bound">rm</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">V</span><span class="main">.</span> unProg <span class="bound">X</span> <span class="main">⇓</span> <span class="bound">V</span>
                     <span class="main">⟶</span> <span class="main">(</span><span class="bound">f</span><span class="main">⋅</span><span class="bound">x</span><span class="main">,</span> mkProg <span class="main">(</span><span class="bound">M</span><span class="main">&lt;</span><span class="bound">V</span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unsynlr <span class="bound">rp</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ca_lr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ValD<span class="main">,</span> Prog<span class="main">)</span> synlf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ca_lr</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> mksynlr <span class="main">(</span>ca_lf_rep <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Intuitively we relate domain-theoretic values to all programs that
converge to the corresponding syntatic values. If a program has a
non-<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊥</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> denotation then we can use this relation to conclude
something about the value it (operationally) converges to.

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">lemmas</span></span> Prog_simps <span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span>
  unProg_inverse
  mkProg_inverse<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="OpSem-bot_ca_lf_rep"><span class="command">lemma</span></span> bot_ca_lf_rep <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⊥</span><span class="main">,</span> <span class="free">P</span><span class="main">)</span> <span class="main">∈</span> ca_lf_rep <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ca_lf_rep_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="keyword1" id="OpSem-synlr_cal_lr_rep"><span class="command">lemma</span></span> synlr_cal_lr_rep <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ca_lf_rep <span class="free">r</span> <span class="main">∈</span> synlr"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ca_lf_rep_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> adm_conj adm_disj adm_below_monic_exists
                  <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_def
                  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> evalOP_deterministic<span class="main">)</span>

<span class="keyword1" id="OpSem-mono_ca_lr"><span class="command">lemma</span></span> mono_ca_lr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mono ca_lr"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ValD<span class="main">,</span> Prog<span class="main">)</span> synlr dual <span class="main">×</span> <span class="main">(</span>ValD<span class="main">,</span> Prog<span class="main">)</span> synlr"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="skolem"><span class="skolem">y1</span></span> <span class="skolem"><span class="skolem">y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ca_lf_rep <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">⊆</span> ca_lf_rep <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ca_lf_rep_def unsynlr_leq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> dual_less_eq_iff split_def<span class="main">)</span>
      <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ca_lr <span class="skolem">x</span> <span class="main">≤</span> ca_lr <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="OpSem-min_inv_ca_lr"><span class="command">lemma</span></span> min_inv_ca_lr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eRSS <span class="free">e</span> <span class="free">R'</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eRSS <span class="main">(</span>ValD_copy_rec<span class="main">⋅</span><span class="free">e</span><span class="main">)</span> <span class="main">(</span>dual <span class="main">(</span>ca_lr <span class="main">(</span>dual <span class="free">S'</span><span class="main">,</span> undual <span class="free">R'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ca_lr <span class="main">(</span><span class="free">R'</span><span class="main">,</span> <span class="free">S'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">unfolding</span></span> ca_lf_rep_def <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>

  <span class="comment1">(* FIXME fastforce gets lost ?? AbsN *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bspec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bspec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bspec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="comment1">(* FIXME fastforce gets lost ?? AbsV *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bspec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bspec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bspec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">bestsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> ca<span class="main">:</span> DomSolSyn <span class="quoted">ca_lr</span> <span class="quoted">ValD_copy_rec</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mono_ca_lr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ValD_copy_ID<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> min_inv_ca_lr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ca_lr_syn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ValD <span class="main">⇒</span> db <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">◃</span> _"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main"><span class="free">◃</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> unProg <span class="bound">Y</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">Y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> unsynlr ca.delta <span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="OpSem-adm_ca_lr"><span class="command">lemma</span></span> adm_ca_lr <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"closed <span class="free">P</span> <span class="main">⟹</span> adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">◃</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ca_lr_syn_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unProg_inject<span class="main">)</span>

<span class="keyword1" id="OpSem-closed_ca_lr"><span class="command">lemma</span></span> closed_ca_lr <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">◃</span> <span class="free">P</span> <span class="main">⟹</span> closed <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ca_lr_syn_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ca.delta_sol<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ca_lf_rep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">Y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="OpSem-ca_lrI"><span class="command">lemma</span></span> ca_lrI <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"closed <span class="free">P</span> <span class="main">⟹</span> <span class="main">⊥</span> <span class="main">◃</span> <span class="free">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⇓</span> DBtt<span class="main">;</span> closed <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> ValTT <span class="main">◃</span> <span class="free">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⇓</span> DBff<span class="main">;</span> closed <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> ValFF <span class="main">◃</span> <span class="free">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⇓</span> DBNum <span class="free">n</span><span class="main">;</span> closed <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> ValN<span class="main">⋅</span><span class="free">n</span> <span class="main">◃</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ca_lr_syn_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"mkProg <span class="free">P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> ca.delta_sol<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> ca_lf_rep_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"mkProg <span class="free">P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="OpSem-ca_lr_DBAbsNI"><span class="command">lemma</span></span> ca_lr_DBAbsNI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⇓</span> DBAbsN <span class="free">M</span><span class="main">;</span> closed <span class="free">P</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">◃</span> <span class="bound">X</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">⋅</span><span class="bound">x</span> <span class="main">◃</span> <span class="free">M</span><span class="main">&lt;</span><span class="bound">X</span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span> <span class="main">⟧</span> <span class="main">⟹</span> ValF<span class="main">⋅</span><span class="free">f</span> <span class="main">◃</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ca_lr_syn_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ca.delta_sol<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"mkProg <span class="free"><span class="free">P</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ca_lf_rep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="OpSem-ca_lr_DBAbsVI"><span class="command">lemma</span></span> ca_lr_DBAbsVI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⇓</span> DBAbsV <span class="free">M</span><span class="main">;</span> closed <span class="free">P</span><span class="main">;</span> <span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">X</span> <span class="bound">V</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">◃</span> <span class="bound">X</span><span class="main">;</span> <span class="bound">X</span> <span class="main">⇓</span> <span class="bound">V</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">⋅</span><span class="bound">x</span> <span class="main">◃</span> <span class="free">M</span><span class="main">&lt;</span><span class="bound">V</span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span> <span class="main">⟧</span> <span class="main">⟹</span> ValF<span class="main">⋅</span><span class="free">f</span> <span class="main">◃</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ca_lr_syn_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ca.delta_sol<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"mkProg <span class="free"><span class="free">P</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ca_lf_rep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="OpSem-ca_lrE"><span class="command">lemma</span></span> ca_lrE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">d</span> <span class="main">◃</span> <span class="free">P</span><span class="main">;</span>
     <span class="main">⟦</span> <span class="free">d</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">;</span> closed <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">;</span>
     <span class="main">⟦</span> <span class="free">d</span> <span class="main">=</span> ValTT<span class="main">;</span> closed <span class="free">P</span><span class="main">;</span> <span class="free">P</span> <span class="main">⇓</span> DBtt <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">;</span>
     <span class="main">⟦</span> <span class="free">d</span> <span class="main">=</span> ValFF<span class="main">;</span> closed <span class="free">P</span><span class="main">;</span> <span class="free">P</span> <span class="main">⇓</span> DBff <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">d</span> <span class="main">=</span> ValN<span class="main">⋅</span><span class="bound">n</span><span class="main">;</span> closed <span class="free">P</span><span class="main">;</span> <span class="free">P</span> <span class="main">⇓</span> DBNum <span class="bound">n</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">f</span> <span class="bound">M</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">d</span> <span class="main">=</span> ValF<span class="main">⋅</span><span class="bound">f</span><span class="main">;</span> closed <span class="free">P</span><span class="main">;</span> <span class="free">P</span> <span class="main">⇓</span> DBAbsN <span class="bound">M</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">◃</span> <span class="bound">X</span> <span class="main">⟹</span> <span class="bound">f</span><span class="main">⋅</span><span class="bound">x</span> <span class="main">◃</span> <span class="bound">M</span><span class="main">&lt;</span><span class="bound">X</span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">f</span> <span class="bound">M</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">d</span> <span class="main">=</span> ValF<span class="main">⋅</span><span class="bound">f</span><span class="main">;</span> <span class="bound">f</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">;</span> closed <span class="free">P</span><span class="main">;</span> <span class="free">P</span> <span class="main">⇓</span> DBAbsV <span class="bound">M</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">X</span> <span class="bound">V</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">◃</span> <span class="bound">X</span><span class="main">;</span> <span class="bound">X</span> <span class="main">⇓</span> <span class="bound">V</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">f</span><span class="main">⋅</span><span class="bound">x</span> <span class="main">◃</span> <span class="bound">M</span><span class="main">&lt;</span><span class="bound">V</span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> closed_ca_lr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ca_lr_syn_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ca.delta_sol<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ca_lf_rep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">Y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">Y</span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> unProg <span class="bound">Y</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> unsynlr <span class="main">(</span>DomSolSyn.delta ca_lr<span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">Y</span><span class="main">.</span> <span class="improper">M</span><span class="main">&lt;</span><span class="bound">X</span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span> <span class="main">=</span> unProg <span class="bound">Y</span> <span class="main">∧</span> <span class="main">(</span><span class="improper">f</span><span class="main">⋅</span><span class="bound">x</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> unsynlr <span class="main">(</span>DomSolSyn.delta ca_lr<span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"mkProg <span class="main">(</span><span class="improper">M</span><span class="main">&lt;</span>unProg <span class="improper">Y</span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mkProg_inverse<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> evalOP_closed<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> closed_binders<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_def
             <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">Y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">X</span> <span class="bound">V</span><span class="main">.</span> <span class="main">⟦</span><span class="main">∃</span><span class="bound">Y</span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> unProg <span class="bound">Y</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> unsynlr <span class="main">(</span>DomSolSyn.delta ca_lr<span class="main">)</span><span class="main">;</span> <span class="bound">X</span> <span class="main">⇓</span> <span class="bound">V</span><span class="main">⟧</span>
                      <span class="main">⟹</span> <span class="main">∃</span><span class="bound">Y</span><span class="main">.</span> <span class="improper">M</span><span class="main">&lt;</span><span class="bound">V</span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span> <span class="main">=</span> unProg <span class="bound">Y</span> <span class="main">∧</span> <span class="main">(</span><span class="improper">f</span><span class="main">⋅</span><span class="bound">x</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> unsynlr <span class="main">(</span>DomSolSyn.delta ca_lr<span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bspec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"mkProg <span class="main">(</span><span class="improper">M</span><span class="main">&lt;</span><span class="improper">V</span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mkProg_inverse<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> evalOP_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> closed_def closed_invs<span class="main">(</span>11<span class="main">)</span> evalOP_closed unProg <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

To establish this result we need a ``closing substitution'' operation.
It seems easier to define it directly in this simple-minded way than
reusing the standard substitution operation.

This is quite similar to a context-plugging (non-capturing)
substitution operation, where the ``holes'' are free variables, and
indeed we use it as such below.

›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">closing_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"db <span class="main">⇒</span> <span class="main">(</span>var <span class="main">⇒</span> db<span class="main">)</span> <span class="main">⇒</span> var <span class="main">⇒</span> db"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closing_subst</span> <span class="main">(</span>DBVar <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">else</span> DBVar <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closing_subst</span> <span class="main">(</span>DBApp <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBApp <span class="main">(</span><span class="free">closing_subst</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">closing_subst</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closing_subst</span> <span class="main">(</span>DBAbsN <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBAbsN <span class="main">(</span><span class="free">closing_subst</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closing_subst</span> <span class="main">(</span>DBAbsV <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBAbsV <span class="main">(</span><span class="free">closing_subst</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closing_subst</span> <span class="main">(</span>DBFix <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBFix <span class="main">(</span><span class="free">closing_subst</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closing_subst</span> <span class="main">(</span>DBCond <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span>
            DBCond <span class="main">(</span><span class="free">closing_subst</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">closing_subst</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">closing_subst</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closing_subst</span> <span class="main">(</span>DBSucc <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBSucc <span class="main">(</span><span class="free">closing_subst</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closing_subst</span> <span class="main">(</span>DBPred <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBPred <span class="main">(</span><span class="free">closing_subst</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closing_subst</span> <span class="main">(</span>DBIsZero <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> DBIsZero <span class="main">(</span><span class="free">closing_subst</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closing_subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can show it has the expected properties when all terms in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are closed.

›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1" id="OpSem-freedb_closing_subst"><span class="command">lemma</span></span> freedb_closing_subst <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">v</span> <span class="main">⟶</span> closed <span class="main">(</span><span class="free">Γ</span> <span class="main">(</span><span class="bound">v</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"freedb <span class="main">(</span>closing_subst <span class="free">e</span> <span class="free">Γ</span> <span class="free">k</span><span class="main">)</span> <span class="free">i</span> <span class="main">⟷</span> <span class="main">(</span>freedb <span class="free">e</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> Suc_le_D
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_def not_less_eq diff_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">∀</span></span></span></span></span></span></span></span></span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">v</span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">.</span></span></span></span></span></span></span></span></span> freedb <span class="improper"><span class="improper"><span class="improper"><span class="improper"><span class="improper"><span class="improper"><span class="improper"><span class="improper"><span class="improper">e</span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">v</span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">∧</span></span></span></span></span></span></span></span></span> Suc <span class="improper"><span class="improper"><span class="improper"><span class="improper"><span class="improper"><span class="improper"><span class="improper"><span class="improper"><span class="improper">k</span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">≤</span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">v</span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">⟶</span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">∀</span></span></span></span></span></span></span></span></span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">j</span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">.</span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">¬</span></span></span></span></span></span></span></span></span> freedb <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free">Γ</span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">v</span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">-</span></span></span></span></span></span></span></span></span> Suc <span class="improper"><span class="improper"><span class="improper"><span class="improper"><span class="improper"><span class="improper"><span class="improper"><span class="improper"><span class="improper">k</span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">j</span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span>"</span></span></span></span></span></span></span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> Suc_le_D <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="OpSem-closed_closing_subst"><span class="command">lemma</span></span> closed_closing_subst <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">v</span> <span class="main">⟶</span> closed <span class="main">(</span><span class="free">Γ</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>closing_subst <span class="free">e</span> <span class="free">Γ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms freedb_closing_subst<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> e<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">e</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">unfolding</span></span> closed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="OpSem-subst_closing_subst"><span class="command">lemma</span></span> subst_closing_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="bound">v</span> <span class="main">⟶</span> closed <span class="main">(</span><span class="free">Γ</span> <span class="main">(</span><span class="bound">v</span> <span class="main">-</span> Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>closing_subst <span class="free">e</span> <span class="free">Γ</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">&lt;</span><span class="free">X</span><span class="main">/</span><span class="free">k</span><span class="main">&gt;</span> <span class="main">=</span> closing_subst <span class="free">e</span> <span class="main">(</span>case_nat <span class="free">X</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> DBVar <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_le_eq closed_subst<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_Suc old.nat.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> DBAbsN <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> Suc_less_eq2 closed_def closed_lift diff_Suc_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> DBAbsV <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> Suc_less_eq2 closed_def closed_lift diff_Suc_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> DBFix <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> Suc_less_eq2 closed_def closed_lift diff_Suc_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="OpSem-closing_subst_closed"><span class="command">lemma</span></span> closing_subst_closed <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closing_subst <span class="free">e</span> <span class="free">Γ</span> <span class="free">k</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> gr_implies_not0 nat.exhaust not_less_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="OpSem-closing_subst_evalDdb_cong"><span class="command">lemma</span></span> closing_subst_evalDdb_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> closed <span class="main">(</span><span class="free">Γ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> closed <span class="main">(</span><span class="free">Γ'</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> evalDdb <span class="main">(</span><span class="free">Γ</span> <span class="bound">v</span><span class="main">)</span><span class="main">⋅</span>env_empty_db <span class="main">=</span> evalDdb <span class="main">(</span><span class="free">Γ'</span> <span class="bound">v</span><span class="main">)</span><span class="main">⋅</span>env_empty_db"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evalDdb <span class="main">(</span>closing_subst <span class="free">e</span> <span class="free">Γ</span> <span class="free">k</span><span class="main">)</span><span class="main">⋅</span><span class="free">ρ</span> <span class="main">=</span> evalDdb <span class="main">(</span>closing_subst <span class="free">e</span> <span class="free">Γ'</span> <span class="free">k</span><span class="main">)</span><span class="main">⋅</span><span class="free">ρ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> DBVar <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> evalDdb_env_closed<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ρ'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">env_empty_db</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The key lemma is shown by induction over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for arbitrary
environments (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ρ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>):

›</span></span>

<span class="keyword1" id="OpSem-ca_open"><span class="command">lemma</span></span> ca_open<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="free">e</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="free">ρ</span><span class="main">⋅</span><span class="bound">v</span> <span class="main">◃</span> <span class="free">Γ</span> <span class="bound">v</span> <span class="main">∧</span> closed <span class="main">(</span><span class="free">Γ</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evalDdb <span class="free">e</span><span class="main">⋅</span><span class="free">ρ</span> <span class="main">◃</span> closing_subst <span class="free">e</span> <span class="free">Γ</span> <span class="main">0</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBApp <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">Γ</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> DBApp.prems DBApp.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ρ</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ca_lrE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"evalDdb <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"closing_subst <span class="skolem">e2</span> <span class="skolem">Γ</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ca_lrE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ca_lr_DBAbsNI ca_lr_DBAbsVI<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>6<span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"evalDdb <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">ρ</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">V</span><span class="main">.</span> closing_subst <span class="skolem">e2</span> <span class="skolem">Γ</span> <span class="main">0</span> <span class="main">⇓</span> <span class="bound">V</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"evalDdb <span class="skolem">e2</span><span class="main">⋅</span><span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"closing_subst <span class="skolem">e2</span> <span class="skolem">Γ</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">V</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ca_lrE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ca_lr_DBAbsNI ca_lr_DBAbsVI<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>6<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ca_lrE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBAbsN <span class="skolem">e</span> <span class="skolem">Γ</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> DBAbsN.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ca_lr_DBAbsNI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval_val<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> v_AbsN<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_closing_subst<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> ρ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"env_ext_db<span class="main">⋅</span><span class="improper">x</span><span class="main">⋅</span><span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"case_nat <span class="improper">X</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> DBAbsN.hyps<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="skolem">e</span> <span class="bound">v</span> <span class="main">⟶</span> env_ext_db<span class="main">⋅</span><span class="improper">x</span><span class="main">⋅</span><span class="skolem">ρ</span><span class="main">⋅</span><span class="bound">v</span> <span class="main">◃</span> case_nat <span class="improper">X</span> <span class="skolem">Γ</span> <span class="bound">v</span> <span class="main">∧</span> closed <span class="main">(</span>case_nat <span class="improper">X</span> <span class="skolem">Γ</span> <span class="bound">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> env_ext_db_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBAbsV <span class="skolem">e</span> <span class="skolem">Γ</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> DBAbsV.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ca_lr_DBAbsVI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval_val<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> v_AbsV<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> closed_ca_lr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> evalOP_closed<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span><span class="main">=</span><span class="main">⊥</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ca_lrI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_closing_subst<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat.split_sels<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_closing_subst<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> ρ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"env_ext_db<span class="main">⋅</span><span class="improper">x</span><span class="main">⋅</span><span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"case_nat <span class="improper">V</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> DBAbsV.hyps<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="skolem">e</span> <span class="bound">v</span> <span class="main">⟶</span> env_ext_db<span class="main">⋅</span><span class="improper">x</span><span class="main">⋅</span><span class="skolem">ρ</span><span class="main">⋅</span><span class="bound">v</span> <span class="main">◃</span> case_nat <span class="improper">V</span> <span class="skolem">Γ</span> <span class="bound">v</span> <span class="main">∧</span> closed <span class="main">(</span>case_nat <span class="improper">V</span> <span class="skolem">Γ</span> <span class="bound">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> env_ext_db_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ca_lrE<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> evalOP_deterministic<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">V</span> <span class="main">=</span> DBAbsN <span class="improper">M</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ca_lr_DBAbsNI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval_val<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> evalOP_deterministic<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">V</span> <span class="main">=</span> DBAbsV <span class="improper">M</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ca_lr_DBAbsVI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> evalOP_deterministic<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBFix <span class="skolem">e</span> <span class="skolem">Γ</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_ind<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"env_ext_db<span class="main">⋅</span><span class="improper">x</span><span class="main">⋅</span><span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"case_nat <span class="main">(</span>closing_subst <span class="main">(</span>DBFix <span class="skolem">e</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> freedb <span class="skolem">e</span> <span class="bound">v</span> <span class="main">⟶</span> env_ext_db<span class="main">⋅</span><span class="improper">x</span><span class="main">⋅</span><span class="skolem">ρ</span><span class="main">⋅</span><span class="bound">v</span> <span class="main">◃</span> case_nat <span class="main">(</span>closing_subst <span class="main">(</span>DBFix <span class="skolem">e</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="bound">v</span> <span class="main">∧</span> closed <span class="main">(</span>case_nat <span class="main">(</span>closing_subst <span class="main">(</span>DBFix <span class="skolem">e</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="bound">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ca_lrE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ca_lrI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_closing_subst<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ca_lrI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_closing_subst<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ca_lrI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_closing_subst<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ca_lr_DBAbsNI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_closing_subst<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ca_lr_DBAbsVI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_closing_subst<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> env_ext_db_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBCond <span class="skolem">c</span> <span class="skolem">t</span> <span class="skolem">e</span> <span class="skolem">Γ</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ρ</span></span></span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ca_lrE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ca_lr_DBAbsNI ca_lr_DBAbsVI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBSucc <span class="skolem">e</span> <span class="skolem">Γ</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succ_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ρ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ca_lrE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ca_lr_DBAbsNI ca_lr_DBAbsVI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBPred <span class="skolem">e</span> <span class="skolem">Γ</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pred_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ρ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ca_lrE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ca_lr_DBAbsNI ca_lr_DBAbsVI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DBIsZero <span class="skolem">e</span> <span class="skolem">Γ</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isZero_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ρ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ca_lrE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ca_lr_DBAbsNI ca_lr_DBAbsVI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1" id="OpSem-ca_closed"><span class="command">lemma</span></span> ca_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evalDdb <span class="free">e</span><span class="main">⋅</span>env_empty_db <span class="main">◃</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ca_open<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> e<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">e</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ρ<span class="main"><span class="main">=</span></span><span class="quoted">env_empty_db</span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> ca<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nb<span class="main">:</span> <span class="quoted"><span class="quoted">"evalDdb <span class="free">e</span><span class="main">⋅</span>env_empty_db <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">V</span><span class="main">.</span> <span class="free">e</span> <span class="main">⇓</span> <span class="bound">V</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ca_closed<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹closed <span class="free">e</span>›</span></span><span class="main">]</span> nb
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ca_lrE<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This last result justifies reasoning about contextual equivalence
using the denotational semantics, as we now show.

›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Contextual Equivalence›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

As we are using an un(i)typed language, we take a context <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">C</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
to be an arbitrary term, where the free variables are the
``holes''. We substitute a closed expression <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> uniformly for
all of the free variables in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">C</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. If open, the term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be closed using enough <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"AbsN"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s. This seems to be a
standard trick now, see e.g. \citet{DBLP:conf/popl/KoutavasW06}. If we
didn't have CBN (only CBV) then it might be worth showing that this is
an adequate treatment.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ctxt_sub</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"db <span class="main">⇒</span> db <span class="main">⇒</span> db"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword1">&lt;</span>_<span class="keyword1">&gt;</span><span class="keyword3">)</span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="main">≡</span> closing_subst <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">0</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="OpSem-ctxt_sub_closed"><span class="command">lemma</span></span> ctxt_sub_closed <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"closed <span class="free">e</span> <span class="main">⟹</span> closed <span class="main">(</span><span class="free">C</span><span class="main">&lt;</span><span class="free">e</span><span class="main">&gt;</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ctxt_sub_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="OpSem-ctxt_sub_cong"><span class="command">lemma</span></span> ctxt_sub_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">e1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">e2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evalDdb <span class="free">e1</span><span class="main">⋅</span>env_empty_db <span class="main">=</span> evalDdb <span class="free">e2</span><span class="main">⋅</span>env_empty_db"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evalDdb <span class="main">(</span><span class="free">C</span><span class="main">&lt;</span><span class="free">e1</span><span class="main">&gt;</span><span class="main">)</span><span class="main">⋅</span>env_empty_db <span class="main">=</span> evalDdb <span class="main">(</span><span class="free">C</span><span class="main">&lt;</span><span class="free">e2</span><span class="main">&gt;</span><span class="main">)</span><span class="main">⋅</span>env_empty_db"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ctxt_sub_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> closing_subst_evalDdb_cong<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Following \citet{PittsAM:relpod} we define a relation between values
that ``have the same form''. This is weak at functional values. We
don't distinguish between strict and non-strict abstractions.

›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">have_the_same_form</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"db <span class="main">⇒</span> db <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∼</span> _"</span> <span class="main">[</span>50<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"DBAbsN <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">∼</span></span> DBAbsN <span class="free"><span class="bound"><span class="entity">e'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"DBAbsN <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">∼</span></span> DBAbsV <span class="free"><span class="bound"><span class="entity">e'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"DBAbsV <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">∼</span></span> DBAbsN <span class="free"><span class="bound"><span class="entity">e'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"DBAbsV <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">∼</span></span> DBAbsV <span class="free"><span class="bound"><span class="entity">e'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"DBFix <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">∼</span></span> DBFix <span class="free"><span class="bound"><span class="entity">e'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"DBtt <span class="main"><span class="free">∼</span></span> DBtt"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"DBff <span class="main"><span class="free">∼</span></span> DBff"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"DBNum <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">∼</span></span> DBNum <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">declare</span></span> have_the_same_form.intros <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="OpSem-have_the_same_form_sound"><span class="command">lemma</span></span> have_the_same_form_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"evalDdb <span class="free">v1</span><span class="main">⋅</span><span class="free">ρ</span> <span class="main">=</span> evalDdb <span class="free">v2</span><span class="main">⋅</span><span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"val <span class="free">v1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"val <span class="free">v2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">∼</span> <span class="free">v2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹val <span class="free">v1</span>›</span></span> D
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> val.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹val <span class="free">v2</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> val.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹val <span class="free">v2</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> val.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹val <span class="free">v2</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> val.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹val <span class="free">v2</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> val.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹val <span class="free">v2</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> val.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* FIXME could also show compatability, i.e. that the
contextually_equivalent relation is compatible with the language. *)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

A program <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \emph{refines} the program <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if it
converges in context at least as often. This is a preorder on
programs.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">refines</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"db <span class="main">⇒</span> db <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊴</span> _"</span> <span class="main">[</span>50<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⊴</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">C</span><span class="main">.</span> <span class="main">∃</span><span class="bound">V1</span><span class="main">.</span> <span class="bound">C</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">&gt;</span> <span class="main">⇓</span> <span class="bound">V1</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">V2</span><span class="main">.</span> <span class="bound">C</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">&gt;</span> <span class="main">⇓</span> <span class="bound">V2</span> <span class="main">∧</span> <span class="bound">V1</span> <span class="main">∼</span> <span class="bound">V2</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Contextually-equivalent programs refine each other.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">contextually_equivalent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"db <span class="main">⇒</span> db <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≈</span> _"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">⊴</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">⊴</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="OpSem-refinesI"><span class="command">lemma</span></span> refinesI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">C</span> <span class="bound">V1</span><span class="main">.</span> <span class="bound">C</span><span class="main">&lt;</span><span class="free">e1</span><span class="main">&gt;</span> <span class="main">⇓</span> <span class="bound">V1</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">V2</span><span class="main">.</span> <span class="bound">C</span><span class="main">&lt;</span><span class="free">e2</span><span class="main">&gt;</span> <span class="main">⇓</span> <span class="bound">V2</span> <span class="main">∧</span> <span class="bound">V1</span> <span class="main">∼</span> <span class="bound">V2</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⟹</span> <span class="free">e1</span> <span class="main">⊴</span> <span class="free">e2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> refines_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="OpSem-computational_adequacy_refines"><span class="command">lemma</span></span> computational_adequacy_refines<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">e1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">e2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"evalDdb <span class="free">e1</span><span class="main">⋅</span>env_empty_db <span class="main">=</span> evalDdb <span class="free">e2</span><span class="main">⋅</span>env_empty_db"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">⊴</span> <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refinesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="skolem">V1</span> <span class="keyword3"><span class="command">assume</span></span> V1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">&lt;</span><span class="free">e1</span><span class="main">&gt;</span> <span class="main">⇓</span> <span class="skolem">V1</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"evalDdb <span class="main">(</span><span class="skolem">C</span><span class="main">&lt;</span><span class="free">e2</span><span class="main">&gt;</span><span class="main">)</span><span class="main">⋅</span>env_empty_db <span class="main">=</span> evalDdb <span class="main">(</span><span class="skolem">C</span><span class="main">&lt;</span><span class="free">e1</span><span class="main">&gt;</span><span class="main">)</span><span class="main">⋅</span>env_empty_db"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ctxt_sub_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> D <span class="quoted"><span class="quoted">‹closed <span class="free">e2</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">V2</span></span> <span class="keyword2"><span class="keyword">where</span></span> V2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">&lt;</span><span class="free">e2</span><span class="main">&gt;</span> <span class="main">⇓</span> <span class="skolem">V2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> evalOP_sound<span class="main">[</span><span class="operator">OF</span> V1<span class="main">]</span> ca<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> e<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">&lt;</span><span class="free">e2</span><span class="main">&gt;</span>"</span></span><span class="main">]</span> eval_val_not_bot<span class="main">[</span><span class="operator">OF</span> V1<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> D V1 V2 <span class="keyword1"><span class="command">have</span></span> V1V2<span class="main">:</span> <span class="quoted"><span class="quoted">"evalDdb <span class="skolem">V1</span><span class="main">⋅</span>env_empty_db <span class="main">=</span> evalDdb <span class="skolem">V2</span><span class="main">⋅</span>env_empty_db"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> evalOP_sound<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> V1 V2 V1V2
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">V2</span><span class="main">.</span> <span class="skolem">C</span><span class="main">&lt;</span><span class="free">e2</span><span class="main">&gt;</span> <span class="main">⇓</span> <span class="bound">V2</span> <span class="main">∧</span> <span class="skolem">V1</span> <span class="main">∼</span> <span class="bound">V2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> have_the_same_form_sound<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Our ultimate theorem states that if two programs have the same
denotation then they are contextually equivalent.

›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> computational_adequacy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="free">e1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="free">e2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"evalDdb <span class="free">e1</span><span class="main">⋅</span>env_empty_db <span class="main">=</span> evalDdb <span class="free">e2</span><span class="main">⋅</span>env_empty_db"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">≈</span> <span class="free">e2</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> contextually_equivalent_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> computational_adequacy_refines<span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This gives us a sound but incomplete method for demonstrating
contextual equivalence. We expect this result is useful for showing
contextual equivalence for \emph{typed} programs as well, but leave it
to future work to demonstrate this.

See \citet[\S6.2]{Gunter:1992} for further discussion of computational
adequacy at higher types.

The reader may wonder why we did not use Nominal syntax to define our
operational semantics, following
\citet{DBLP:journals/entcs/UrbanN09}. The reason is that Nominal2 does
not support the definition of continuous functions over Nominal
syntax, which is required by the evaluators of \S\ref{sec:directsem}
and \S\ref{sec:directsem_db}. As observed above, in the setting of
traditional programming language semantics one can get by with a much
simpler notion of substitution than is needed for investigations into
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-calculi. Clearly this does not hold of languages that
reduce ``under binders''.

The ``fast and loose reasoning is morally correct'' work of
\citet{DBLP:conf/popl/DanielssonHJG06} can be seen as a kind of
adequacy result.

\citet{DBLP:conf/tphol/BentonKV09} demonstrate a similar computational
adequacy result in Coq. However their system is only geared up for
this kind of metatheory, and not reasoning about particular programs;
its term language is combinatory.

\citet{DBLP:conf/ppdp/BentonKBH07,DBLP:conf/ppdp/BentonKBH09} have
shown that it is difficult to scale this domain-theoretic approach up
to richer languages, such as those with dynamic allocation of mutable
references, especially if these references can contain (arbitrary)
functional values.

›</span></span>

<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Continuations">
<div class="head">
<h1>Theory Continuations</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Continuations.thy
    Author:     Peter Gammie
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Relating direct and continuation semantics›</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Continuations
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#PCF">PCF</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:continuations}

This is a fairly literal version of
\citet{DBLP:conf/icalp/Reynolds74}, adapted to untyped PCF. A more
abstract account has been given by
\citet{DBLP:journals/tcs/Filinski07} in terms of a monadic meta
language, which is difficult to model in Isabelle (but see
\citet{Huffman:MonadTransformers:2012}).

We begin by giving PCF a continuation semantics following the modern
account of \citet{wadler92:_essence_of_funct_progr}.  We use the
symmetric function space <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>('o ValK, 'o) K → ('o ValK, 'o) K›</span></span></span></span>
as our language includes call-by-name.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> K <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'o</span><span class="main">)</span> <span class="main">→</span> <span class="tfree">'o</span>"</span></span>

<span class="keyword1"><span class="command">domain</span></span> <span class="tfree">'o</span> ValK
  <span class="main">=</span> ValKF <span class="main">(</span><span class="keyword2"><span class="keyword">lazy</span></span> appKF <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'o</span> ValK<span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> K <span class="main">→</span> <span class="main">(</span><span class="tfree">'o</span> ValK<span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> K"</span></span><span class="main">)</span>
  <span class="main">|</span> ValKTT <span class="main">|</span> ValKFF
  <span class="main">|</span> ValKN <span class="main">(</span><span class="keyword2"><span class="keyword">lazy</span></span> <span class="quoted"><span class="quoted">"nat"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'o</span> ValKM <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'o</span> ValK<span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> K"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="Continuations-ValK_case_ID"><span class="command">lemma</span></span> ValK_case_ID <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ValK_case<span class="main">⋅</span>ValKF<span class="main">⋅</span>ValKTT<span class="main">⋅</span>ValKFF<span class="main">⋅</span>ValKN <span class="main">=</span> ID"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Continuations-below_monic_ValKF"><span class="command">lemma</span></span> below_monic_ValKF <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"below_monic_cfun ValKF"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_monicI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Continuations-below_monic_ValKN"><span class="command">lemma</span></span> below_monic_ValKN <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"below_monic_cfun ValKN"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_monicI<span class="main">)</span> <span class="operator">simp</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We use the standard continuation monad to ease the semantic
definition.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unitK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> ValK <span class="main">→</span> <span class="tfree">'o</span> ValKM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unitK</span> <span class="main">≡</span> <span class="keyword1">Λ</span> a<span class="main">.</span> <span class="keyword1">Λ</span> c<span class="main">.</span> <span class="bound">c</span><span class="main">⋅</span><span class="bound">a</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bindK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="main">(</span><span class="tfree">'o</span> ValK <span class="main">→</span> <span class="tfree">'o</span> ValKM<span class="main">)</span> <span class="main">→</span> <span class="tfree">'o</span> ValKM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bindK</span> <span class="main">≡</span> <span class="keyword1">Λ</span> m k<span class="main">.</span> <span class="keyword1">Λ</span> c<span class="main">.</span> <span class="bound">m</span><span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> <span class="bound">k</span><span class="main">⋅</span><span class="bound">a</span><span class="main">⋅</span><span class="bound">c</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">appKM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">appKM</span> <span class="main">≡</span> <span class="keyword1">Λ</span> fK xK<span class="main">.</span> bindK<span class="main">⋅</span><span class="bound">fK</span><span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> <span class="main">(</span>ValKF<span class="main">⋅</span>f<span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">⋅</span><span class="bound">xK</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="Continuations-unitK_simps"><span class="command">lemma</span></span> unitK_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unitK<span class="main">⋅</span><span class="free">v</span><span class="main">⋅</span><span class="free">c</span> <span class="main">=</span> <span class="free">c</span><span class="main">⋅</span><span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> unitK_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Continuations-bindK_strict"><span class="command">lemma</span></span> bindK_strict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bindK<span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bindK_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun<span class="main">)</span>

<span class="keyword1" id="Continuations-bindK_unitl"><span class="command">lemma</span></span> bindK_unitl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bindK<span class="main">⋅</span><span class="main">(</span>unitK<span class="main">⋅</span><span class="free">e</span><span class="main">)</span><span class="main">⋅</span><span class="free">f</span> <span class="main">=</span> <span class="free">f</span><span class="main">⋅</span><span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bindK_def unitK_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun<span class="main">)</span>

<span class="keyword1" id="Continuations-bindK_unitr"><span class="command">lemma</span></span> bindK_unitr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bindK<span class="main">⋅</span><span class="free">e</span><span class="main">⋅</span>unitK <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bindK_def unitK_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun<span class="main">)</span>

<span class="keyword1" id="Continuations-bindK_assoc"><span class="command">lemma</span></span> bindK_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bindK<span class="main">⋅</span><span class="main">(</span>bindK<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">g</span><span class="main">)</span><span class="main">⋅</span><span class="free">h</span> <span class="main">=</span> bindK<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> bindK<span class="main">⋅</span><span class="main">(</span><span class="free">g</span><span class="main">⋅</span><span class="bound">v</span><span class="main">)</span><span class="main">⋅</span><span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bindK_def unitK_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> bindK_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> bindK_strict bindK_unitl bindK_unitr bindK_assoc

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The interpretations of the constants.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">condK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">condK</span> <span class="main">≡</span> <span class="keyword1">Λ</span> iK tK eK<span class="main">.</span> bindK<span class="main">⋅</span><span class="bound">iK</span><span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> i<span class="main">.</span> <span class="keyword1">case</span> <span class="bound">i</span> <span class="keyword1">of</span>
                ValKF<span class="main">⋅</span><span class="bound">f</span> <span class="main">⇒</span> <span class="main">⊥</span> <span class="main">|</span> ValKTT <span class="main">⇒</span> <span class="bound">tK</span> <span class="main">|</span> ValKFF <span class="main">⇒</span> <span class="bound">eK</span> <span class="main">|</span> ValKN<span class="main">⋅</span><span class="bound">n</span> <span class="main">⇒</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">succK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succK</span> <span class="main">≡</span> <span class="keyword1">Λ</span> nK<span class="main">.</span> bindK<span class="main">⋅</span><span class="bound">nK</span><span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> <span class="main">(</span>ValKN<span class="main">⋅</span>n<span class="main">)</span><span class="main">.</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKN<span class="main">⋅</span><span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">predK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">predK</span> <span class="main">≡</span> <span class="keyword1">Λ</span> nK<span class="main">.</span> bindK<span class="main">⋅</span><span class="bound">nK</span><span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> <span class="main">(</span>ValKN<span class="main">⋅</span>n<span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">n</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">⊥</span> <span class="main">|</span> Suc <span class="bound">n</span> <span class="main">⇒</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKN<span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isZeroK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isZeroK</span> <span class="main">≡</span> <span class="keyword1">Λ</span> nK<span class="main">.</span> bindK<span class="main">⋅</span><span class="bound">nK</span><span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> <span class="main">(</span>ValKN<span class="main">⋅</span>n<span class="main">)</span><span class="main">.</span> unitK<span class="main">⋅</span><span class="main">(</span><span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> ValKTT <span class="keyword1">else</span> ValKFF<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹

A continuation semantics for PCF. If we had defined our direct
semantics using a monad then the correspondence would be more
syntactically obvious.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'o</span> EnvK <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> ValKM Env"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">evalK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"expr <span class="main">⇒</span> <span class="tfree">'o</span> EnvK <span class="main">→</span> <span class="tfree">'o</span> ValKM"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">evalK</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="bound">ρ</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalK</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> appKM<span class="main">⋅</span><span class="main">(</span><span class="free">evalK</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">evalK</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalK</span> <span class="main">(</span>AbsN <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKF<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="free">evalK</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="main">(</span>env_ext<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalK</span> <span class="main">(</span>AbsV <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKF<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x c<span class="main">.</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x'<span class="main">.</span> <span class="free">evalK</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="main">(</span>env_ext<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⋅</span><span class="main">(</span>unitK<span class="main">⋅</span><span class="bound">x'</span><span class="main">)</span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalK</span> <span class="main">(</span>Diverge<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalK</span> <span class="main">(</span>Fix <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="keyword1">μ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">evalK</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="main">(</span>env_ext<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalK</span> <span class="main">(</span>tt<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> unitK<span class="main">⋅</span>ValKTT<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalK</span> <span class="main">(</span>ff<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> unitK<span class="main">⋅</span>ValKFF<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalK</span> <span class="main">(</span>Cond <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> condK<span class="main">⋅</span><span class="main">(</span><span class="free">evalK</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">evalK</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">evalK</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalK</span> <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKN<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalK</span> <span class="main">(</span>Succ <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> succK<span class="main">⋅</span><span class="main">(</span><span class="free">evalK</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalK</span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> predK<span class="main">⋅</span><span class="main">(</span><span class="free">evalK</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalK</span> <span class="main">(</span>IsZero <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> isZeroK<span class="main">⋅</span><span class="main">(</span><span class="free">evalK</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

To establish the chain completeness (admissibility) of our logical
relation, we need to show that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"unitK"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is an \emph{order
monic}, i.e., if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"unitK<span class="main"><span class="main">⋅</span></span><span class="free"><span class="free">x</span></span> <span class="main"><span class="main">⊑</span></span> unitK<span class="main"><span class="main">⋅</span></span><span class="free"><span class="free">y</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">⊑</span></span>
<span class="free"><span class="free">y</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This is an order-theoretic version of injectivity.

In order to define a continuation that witnesses this, we need to be
able to distinguish converging and diverging computations. We
therefore require our observation domain to contain at least two
elements:

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> at_least_two_elements <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">some_non_bottom_element</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span><span class="main">::</span>domain"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> some_non_bottom_element<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">some_non_bottom_element</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Following \citet{DBLP:conf/icalp/Reynolds74} and \citet[Remark
47]{DBLP:journals/tcs/Filinski07} we use the following continuation:

›</span></span>

<span class="keyword1" id="Continuations-cont_below"><span class="command">lemma</span></span> cont_below <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">cont2cont</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>pcpo<span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free">d</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> contI2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"monofun <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free">d</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monofunI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> z<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> below_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>pcpo"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="skolem">Y</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">Y</span> <span class="bound">i</span> <span class="main">⊑</span> <span class="free">d</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">d</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> <span class="free">c</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">Y</span> <span class="bound">i</span> <span class="main">⊑</span> <span class="free">d</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span> <span class="main">⊑</span> <span class="free">d</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Lub <span class="skolem">Y</span> <span class="main">⊑</span> <span class="free">d</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lub_below_iff<span class="main">[</span><span class="operator">OF</span> Y<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">Y</span> <span class="bound">i</span> <span class="main">⊑</span> <span class="free">d</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> LubY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Lub <span class="skolem">Y</span> <span class="main">⊑</span> <span class="free">d</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lub_below_iff<span class="main">[</span><span class="operator">OF</span> Y<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="var">?f</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> chainI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> chain_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Y<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">(</span>Suc <span class="improper">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> z<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> below_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> Yi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">Y</span> <span class="skolem">i</span> <span class="main">⊑</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"max_in_chain <span class="skolem">i</span> <span class="var">?f</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> max_in_chainI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> chain_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Y<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="improper">j</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> z<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> below_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">from</span></span> LubY Yi <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> maxinch_is_thelub<span class="main">,</span> <span class="operator">OF</span> F M<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> at_least_two_elements<span class="main">)</span> below_monic_unitK <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"below_monic_cfun <span class="main">(</span>unitK <span class="main">::</span> <span class="tfree">'o</span> ValK <span class="main">→</span> <span class="tfree">'o</span> ValKM<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> below_monicI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> ValK"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> vv'<span class="main">:</span> <span class="quoted"><span class="quoted">"unitK<span class="main">⋅</span><span class="skolem">v</span> <span class="main">⊑</span> unitK<span class="main">⋅</span><span class="skolem">v'</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Λ</span> x<span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="skolem">v'</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> <span class="free">some_non_bottom_element</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> vv' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitK<span class="main">⋅</span><span class="skolem">v</span><span class="main">⋅</span><span class="var">?k</span> <span class="main">⊑</span> unitK<span class="main">⋅</span><span class="skolem">v'</span><span class="main">⋅</span><span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monofun_cfun_fun<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span><span class="main">⋅</span><span class="skolem">v</span> <span class="main">⊑</span> <span class="var">?k</span><span class="main">⋅</span><span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unitK_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> some_non_bottom_element <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊑</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Logical relation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We follow \citet{DBLP:conf/icalp/Reynolds74} by simultaneously
defining a pair of relations over values and functions. Both are
bottom-reflecting, in contrast to the situation for computational
adequacy in \S\ref{sec:compad}.  \citet{DBLP:journals/tcs/Filinski07}
differs by assuming that values are always defined, and relates values
and monadic computations.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'o</span> lfr <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ValD<span class="main">,</span> <span class="tfree">'o</span> ValKM<span class="main">,</span> ValD <span class="main">→</span> ValD<span class="main">,</span> <span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM<span class="main">)</span> lf_pair_rep"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'o</span> lflf <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ValD<span class="main">,</span> <span class="tfree">'o</span> ValKM<span class="main">,</span> ValD <span class="main">→</span> ValD<span class="main">,</span> <span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM<span class="main">)</span> lf_pair"</span></span>

<span class="keyword1"><span class="command">context</span></span> at_least_two_elements
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lr_eta_rep_N</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lr_eta_rep_N</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">e'</span><span class="main">)</span> <span class="main">.</span>
       <span class="main">(</span><span class="bound">e</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">∧</span> <span class="bound">e'</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span>
     <span class="main">∨</span> <span class="main">(</span><span class="bound">e</span> <span class="main">=</span> ValTT <span class="main">∧</span> <span class="bound">e'</span> <span class="main">=</span> unitK<span class="main">⋅</span>ValKTT<span class="main">)</span>
     <span class="main">∨</span> <span class="main">(</span><span class="bound">e</span> <span class="main">=</span> ValFF <span class="main">∧</span> <span class="bound">e'</span> <span class="main">=</span> unitK<span class="main">⋅</span>ValKFF<span class="main">)</span>
     <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">e</span> <span class="main">=</span> ValN<span class="main">⋅</span><span class="bound">n</span> <span class="main">∧</span> <span class="bound">e'</span> <span class="main">=</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKN<span class="main">⋅</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lr_eta_rep_F</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lr_eta_rep_F</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">rm</span><span class="main">,</span> <span class="bound">rp</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">e'</span><span class="main">)</span> <span class="main">.</span>
       <span class="main">(</span><span class="bound">e</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">∧</span> <span class="bound">e'</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span>
     <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="bound">f'</span><span class="main">.</span> <span class="bound">e</span> <span class="main">=</span> ValF<span class="main">⋅</span><span class="bound">f</span> <span class="main">∧</span> <span class="bound">e'</span> <span class="main">=</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKF<span class="main">⋅</span><span class="bound">f'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">f'</span><span class="main">)</span> <span class="main">∈</span> unlr <span class="main">(</span>snd <span class="bound">rp</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lr_eta_rep</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lr_eta_rep</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> lr_eta_rep_N <span class="main">∪</span> lr_eta_rep_F <span class="bound">r</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lr_theta_rep</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lr_theta_rep</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">rm</span><span class="main">,</span> <span class="bound">rp</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">f'</span><span class="main">)</span> <span class="main">.</span>
     <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> unlr <span class="main">(</span>fst <span class="main">(</span>undual <span class="bound">rm</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span><span class="main">⋅</span><span class="bound">x</span><span class="main">,</span> <span class="bound">f'</span><span class="main">⋅</span><span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> unlr <span class="main">(</span>fst <span class="bound">rp</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lr_rep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> lfr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lr_rep</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span>lr_eta_rep <span class="bound">r</span><span class="main">,</span> lr_theta_rep <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> lflf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lr</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span>mklr <span class="main">(</span>fst <span class="main">(</span>lr_rep <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> mklr <span class="main">(</span>snd <span class="main">(</span>lr_rep <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Properties of the logical relation.

›</span></span>

<span class="keyword1" id="Continuations-admS_eta_rep"><span class="command">lemma</span></span> admS_eta_rep <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lr_rep <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> admS"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lr_rep_def lr_eta_rep_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> adm_disj <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> adm_below_monic_exists<span class="main">[</span><span class="operator">OF</span> _ below_monic_pair<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below_monic_ValN below_monic_cfcomp2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below_monic_unitK below_monic_ValKN<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main">]</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> adm_below_monic_exists<span class="main">[</span><span class="operator">OF</span> _ below_monic_pair_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below_monic_ValF below_monic_cfcomp2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below_monic_unitK below_monic_ValKF<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> unlr <span class="main">(</span>snd <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Continuations-admS_theta_rep"><span class="command">lemma</span></span> admS_theta_rep <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lr_rep <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> admS"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">∈</span> snd <span class="main">(</span>lr_rep <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lr_rep_def lr_theta_rep_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> snd <span class="main">(</span>lr_rep <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> admI<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> lr_rep_def lr_theta_rep_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> admD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> adm_subst<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuations-mono_lr"><span class="command">lemma</span></span> mono_lr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>lr <span class="main">::</span> <span class="tfree">'o</span> lflf<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monoI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lr_rep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lr_eta_rep_def split_def dual_less_eq_iff unlr_leq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="comment1">(* FIXME stuck with the projections on the product *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lr_theta_rep_def split_def dual_less_eq_iff unlr_leq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">ae</span><span class="main">,</span> <span class="improper">bc</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">ab</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unlr_leq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context at_least_two_elements *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

It takes some effort to set up the minimal invariant relating the two
pairs of domains. One might hope this would be easier using deflations
(which might compose) rather than ``copy'' functions (which certainly
don't).

We elide these as they are tedious.

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">ValD_copy_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ValD <span class="main">→</span> ValD"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ValD_copy_i</span> <span class="main">0</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ValD_copy_i</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span> ValF<span class="main">⋅</span><span class="bound">f</span> <span class="main">⇒</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="free">ValD_copy_i</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">oo</span> <span class="bound">f</span> <span class="keyword1">oo</span> <span class="free">ValD_copy_i</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">|</span> ValTT <span class="main">⇒</span> ValTT <span class="main">|</span> ValFF <span class="main">⇒</span> ValFF <span class="main">|</span> ValN<span class="main">⋅</span><span class="bound">m</span> <span class="main">⇒</span> ValN<span class="main">⋅</span><span class="bound">m</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ValD_copy_lub</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> ValD_copy_i <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Continuations-ValD_copy_chain"><span class="command">lemma</span></span> ValD_copy_chain <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"chain ValD_copy_i"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> chainI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ValD_copy_i <span class="skolem">i</span> <span class="main">⊑</span> ValD_copy_i <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ValD_copy_i <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">x</span> <span class="main">⊑</span> ValD_copy_i <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ValF <span class="skolem">f</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfcomp1 cfun_below_iff monofun_cfun<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_below_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuations-ValD_copy_lub_ID"><span class="command">lemma</span></span> ValD_copy_lub_ID<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ValD_copy_lub <span class="main">=</span> ID"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">ValD</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ValD_take <span class="skolem">i</span><span class="main">⋅</span><span class="main">(</span>ValD_copy_i <span class="skolem">i</span><span class="main">⋅</span><span class="main">(</span>ValD_take <span class="skolem">i</span><span class="main">⋅</span><span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ValD_take <span class="skolem">i</span><span class="main">⋅</span><span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_map_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">::</span> ValD<span class="main">.</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> ValD_take <span class="bound">i</span><span class="main">⋅</span><span class="main">(</span>ValD_copy_i <span class="bound">i</span><span class="main">⋅</span><span class="main">(</span>ValD_take <span class="bound">i</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> ValD_take <span class="bound">i</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lub_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lub_distribs ValD.lub_take cfun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Continuations: we need to ensure the observation type is always the
same.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">KM_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'o</span> ValK <span class="main">→</span> <span class="tfree">'o</span> ValK<span class="main">)</span> <span class="main">→</span> <span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">KM_map</span> <span class="main">≡</span> <span class="keyword1">Λ</span> f<span class="main">.</span> cfun_map<span class="main">⋅</span><span class="main">(</span>cfun_map<span class="main">⋅</span><span class="bound">f</span><span class="main">⋅</span>ID<span class="main">)</span><span class="main">⋅</span>ID"</span></span>

<span class="keyword1" id="Continuations-KM_map_id"><span class="command">lemma</span></span> KM_map_id <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"KM_map<span class="main">⋅</span>ID <span class="main">=</span> ID"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> KM_map_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_map_ID<span class="main">)</span>

<span class="keyword1" id="Continuations-KM_map_strict"><span class="command">lemma</span></span> KM_map_strict <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"KM_map<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> KM_map_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">ValK_copy_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'o</span> ValK <span class="main">→</span> <span class="tfree">'o</span> ValK"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ValK_copy_i</span> <span class="main">0</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ValK_copy_i</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span> ValKF<span class="main">⋅</span><span class="bound">f</span> <span class="main">⇒</span> ValKF<span class="main">⋅</span><span class="main">(</span>cfun_map<span class="main">⋅</span><span class="main">(</span>KM_map<span class="main">⋅</span><span class="main">(</span><span class="free">ValK_copy_i</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>KM_map<span class="main">⋅</span><span class="main">(</span><span class="free">ValK_copy_i</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="bound">f</span><span class="main">)</span> <span class="main">|</span> ValKTT <span class="main">⇒</span> ValKTT <span class="main">|</span> ValKFF <span class="main">⇒</span> ValKFF <span class="main">|</span> ValKN<span class="main">⋅</span><span class="bound">m</span> <span class="main">⇒</span> ValKN<span class="main">⋅</span><span class="bound">m</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ValK_copy</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> ValK_copy_i <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Continuations-ValK_copy_chain"><span class="command">lemma</span></span> ValK_copy_chain <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"chain <span class="main">(</span>ValK_copy_i <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'o</span> ValK <span class="main">→</span> <span class="tfree">'o</span> ValK<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> chainI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ValK_copy_i <span class="skolem">i</span> <span class="main">⊑</span> <span class="main">(</span>ValK_copy_i <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'o</span> ValK <span class="main">→</span> <span class="tfree">'o</span> ValK<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> ValK"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ValK_copy_i <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">x</span> <span class="main">⊑</span> ValK_copy_i <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ValKF <span class="skolem">f</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> monofun_cfun KM_map_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_below_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuations-ValK_copy_fix"><span class="command">lemma</span></span> ValK_copy_fix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ValK_copy <span class="main">=</span> <span class="main">(</span>ID <span class="main">::</span> <span class="tfree">'o</span> ValK <span class="main">→</span> <span class="tfree">'o</span> ValK<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> ValK"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ValK_take <span class="skolem">i</span><span class="main">⋅</span><span class="main">(</span>ValK_copy_i <span class="skolem">i</span><span class="main">⋅</span><span class="main">(</span>ValK_take <span class="skolem">i</span><span class="main">⋅</span><span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ValK_take <span class="skolem">i</span><span class="main">⋅</span><span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> KM_map_def cfun_map_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">::</span> <span class="tfree">'o</span> ValK<span class="main">.</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> ValK_take <span class="bound">i</span><span class="main">⋅</span><span class="main">(</span>ValK_copy_i <span class="bound">i</span><span class="main">⋅</span><span class="main">(</span>ValK_take <span class="bound">i</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> ValK_take <span class="bound">i</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lub_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lub_distribs ValK.lub_take cfun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuations-ValK_strict"><span class="command">lemma</span></span> ValK_strict <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ValK_copy<span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ValK_copy_fix<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We need to respect the purported domain structure, and positive and
negative occurrences.

›</span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">ValD_copy_rec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>ValD <span class="main">→</span> ValD<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span>ValD <span class="main">→</span> ValD<span class="main">)</span> <span class="main">→</span> <span class="main">(</span>ValD <span class="main">→</span> ValD<span class="main">)</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">→</span> <span class="main">(</span><span class="main">(</span>ValD <span class="main">→</span> ValD<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span>ValD <span class="main">→</span> ValD<span class="main">)</span> <span class="main">→</span> <span class="main">(</span>ValD <span class="main">→</span> ValD<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ValD_copy_rec</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span> ValF<span class="main">⋅</span><span class="bound">f</span> <span class="main">⇒</span> ValF<span class="main">⋅</span><span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⋅</span><span class="bound">f</span><span class="main">)</span> <span class="main">|</span> ValTT <span class="main">⇒</span> ValTT <span class="main">|</span> ValFF <span class="main">⇒</span> ValFF <span class="main">|</span> ValN<span class="main">⋅</span><span class="bound">n</span> <span class="main">⇒</span> ValN<span class="main">⋅</span><span class="bound">n</span><span class="main">,</span>
      <span class="keyword1">Λ</span> f<span class="main">.</span> cfun_map<span class="main">⋅</span><span class="main">(</span>strictify<span class="main">⋅</span><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>strictify<span class="main">⋅</span><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="bound">f</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">ValD_copy_eta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ValD <span class="main">→</span> ValD"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ValD_copy_eta</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>iterate <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⋅</span>ValD_copy_rec<span class="main">⋅</span><span class="main">⊥</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">ValD_copy_theta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>ValD <span class="main">→</span> ValD<span class="main">)</span> <span class="main">→</span> <span class="main">(</span>ValD <span class="main">→</span> ValD<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ValD_copy_theta</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>iterate <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⋅</span>ValD_copy_rec<span class="main">⋅</span><span class="main">⊥</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Continuations-ValD_copy_eta_theta_strict"><span class="command">lemma</span></span> ValD_copy_eta_theta_strict <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ValD_copy_eta <span class="free">n</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"ValD_copy_theta <span class="free">n</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_map_def<span class="main">)</span>

<span class="keyword1" id="Continuations-ValD_copy_fix_strict"><span class="command">lemma</span></span> ValD_copy_fix_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fix<span class="main">⋅</span>ValD_copy_rec<span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"snd <span class="main">(</span>fix<span class="main">⋅</span>ValD_copy_rec<span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_map_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Continuations-ValD_copy_rec_ValD_copy_lub"><span class="command">lemma</span></span> ValD_copy_rec_ValD_copy_lub<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fix<span class="main">⋅</span>ValD_copy_rec <span class="main">=</span> <span class="main">(</span>ValD_copy_lub<span class="main">,</span> cfun_map<span class="main">⋅</span>ValD_copy_lub<span class="main">⋅</span>ValD_copy_lub<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊑</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun strictify_cancel ValD_copy_lub_ID cfun_map_def ID_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ValD_copy_i <span class="skolem">i</span> <span class="main">⊑</span> fst <span class="main">(</span>fix<span class="main">⋅</span>ValD_copy_rec<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun strictify_cancel cfcomp1 cfun_map_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun_fun monofun_cfun_arg<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun strictify_cancel monofun_cfun cfcomp1 cfun_map_def cfun_below_iff<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"ValD_copy_lub <span class="main">⊑</span> fst <span class="main">(</span>fix<span class="main">⋅</span>ValD_copy_rec<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lub_below_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> D
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cfun_map<span class="main">⋅</span>ValD_copy_lub<span class="main">⋅</span>ValD_copy_lub <span class="main">⊑</span> snd <span class="main">(</span>fix<span class="main">⋅</span>ValD_copy_rec<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun strictify_cancel monofun_cfun<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊑</span> <span class="var">?lhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_belowI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuations-fix_ValD_copy_rec_ID"><span class="command">lemma</span></span> fix_ValD_copy_rec_ID<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fix<span class="main">⋅</span>ValD_copy_rec <span class="main">=</span> <span class="main">(</span>ID<span class="main">,</span> ID<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ValD_copy_rec_ValD_copy_lub ValD_copy_lub_ID cfun_map_ID
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">ValK_copy_rec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM<span class="main">)</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">→</span> <span class="main">(</span><span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ValK_copy_rec</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">Λ</span> vm<span class="main">.</span> KM_map<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span> ValKF<span class="main">⋅</span><span class="bound">f</span> <span class="main">⇒</span> ValKF<span class="main">⋅</span><span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⋅</span><span class="bound">f</span><span class="main">)</span> <span class="main">|</span> ValKTT <span class="main">⇒</span> ValKTT <span class="main">|</span> ValKFF <span class="main">⇒</span> ValKFF <span class="main">|</span> ValKN<span class="main">⋅</span><span class="bound">a</span> <span class="main">⇒</span> ValKN<span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">⋅</span><span class="bound">vm</span><span class="main">,</span>
      <span class="keyword1">Λ</span> f<span class="main">.</span> cfun_map<span class="main">⋅</span><span class="main">(</span>strictify<span class="main">⋅</span><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>strictify<span class="main">⋅</span><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="bound">f</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">ValK_copy_eta</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ValK_copy_eta</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>iterate <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⋅</span>ValK_copy_rec<span class="main">⋅</span><span class="main">⊥</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">ValK_copy_theta</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ValK_copy_theta</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>iterate <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⋅</span>ValK_copy_rec<span class="main">⋅</span><span class="main">⊥</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Continuations-ValK_copy_strict"><span class="command">lemma</span></span> ValK_copy_strict <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ValK_copy_eta <span class="free">n</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">(</span><span class="main">⊥</span> <span class="main">::</span> <span class="tfree">'o</span> ValKM<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"ValK_copy_theta <span class="free">n</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">(</span><span class="main">⊥</span> <span class="main">::</span> <span class="tfree">'o</span> ValKM <span class="main">→</span> <span class="tfree">'o</span> ValKM<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_map_def<span class="main">)</span>

<span class="keyword1" id="Continuations-ValK_copy_fix_strict"><span class="command">lemma</span></span> ValK_copy_fix_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fix<span class="main">⋅</span>ValK_copy_rec<span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"snd <span class="main">(</span>fix<span class="main">⋅</span>ValK_copy_rec<span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_map_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Continuations-ValK_copy_rec_ValK_copy"><span class="command">lemma</span></span> ValK_copy_rec_ValK_copy<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fix<span class="main">⋅</span>ValK_copy_rec
  <span class="main">=</span> <span class="main">(</span>KM_map<span class="main">⋅</span><span class="main">(</span>ValK_copy <span class="main">::</span> <span class="tfree">'o</span> ValK <span class="main">→</span> <span class="tfree">'o</span> ValK<span class="main">)</span><span class="main">,</span>
     cfun_map<span class="main">⋅</span><span class="main">(</span>KM_map<span class="main">⋅</span>ValK_copy<span class="main">)</span><span class="main">⋅</span><span class="main">(</span>KM_map<span class="main">⋅</span>ValK_copy<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊑</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun strictify_cancel cfun_map_def ID_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> cfun_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> KM_map_def cfun_map_def ValK_copy_fix eta_cfun<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"KM_map<span class="main">⋅</span><span class="main">(</span>ValK_copy_i <span class="skolem">i</span> <span class="main">::</span> <span class="tfree">'o</span> ValK <span class="main">→</span> <span class="tfree">'o</span> ValK<span class="main">)</span> <span class="main">⊑</span> fst <span class="main">(</span>fix<span class="main">⋅</span>ValK_copy_rec<span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ValK_copy_i <span class="skolem">i</span> <span class="main">::</span> <span class="tfree">'o</span> ValK <span class="main">→</span> <span class="tfree">'o</span> ValK<span class="main">)</span> <span class="main">⊑</span> ValK_case<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> f<span class="main">.</span> ValKF<span class="main">⋅</span><span class="main">(</span>snd <span class="main">(</span>fix<span class="main">⋅</span>ValK_copy_rec<span class="main">)</span><span class="main">⋅</span><span class="bound">f</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span>ValKTT<span class="main">⋅</span>ValKFF<span class="main">⋅</span>ValKN"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> cfun_below_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> monofun_cfun_arg <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> KM_map_def cfun_map_def eta_cfun<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun strictify_cancel cfcomp1 cfun_map_def KM_map_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> cfun_belowI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun strictify_cancel cfcomp1 cfun_map_def KM_map_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun_arg<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> cfun_belowI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun strictify_cancel cfcomp1 cfun_map_def KM_map_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun_arg<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun strictify_cancel monofun_cfun cfcomp1 cfun_map_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> cfun_belowI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun strictify_cancel monofun_cfun cfcomp1 cfun_map_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> cfun_belowI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun strictify_cancel monofun_cfun cfcomp1 KM_map_def cfun_map_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> cfun_belowI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun strictify_cancel monofun_cfun cfcomp1 KM_map_def cfun_map_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> cfun_belowI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> cfun_belowI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eta_cfun strictify_cancel cfcomp1 cfun_map_def KM_map_def cfun_below_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> monofun_cfun<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> KM_map<span class="main">⋅</span><span class="main">(</span>ValK_copy_i <span class="bound">i</span> <span class="main">::</span> <span class="tfree">'o</span> ValK <span class="main">→</span> <span class="tfree">'o</span> ValK<span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> fst <span class="main">(</span>fix<span class="main">⋅</span>ValK_copy_rec<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lub_below_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"KM_map<span class="main">⋅</span><span class="main">(</span>ValK_copy <span class="main">::</span> <span class="tfree">'o</span> ValK <span class="main">→</span> <span class="tfree">'o</span> ValK<span class="main">)</span> <span class="main">⊑</span> fst <span class="main">(</span>fix<span class="main">⋅</span>ValK_copy_rec<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> contlub_cfun_arg<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> D
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"cfun_map<span class="main">⋅</span><span class="main">(</span>KM_map<span class="main">⋅</span><span class="main">(</span>ValK_copy <span class="main">::</span> <span class="tfree">'o</span> ValK <span class="main">→</span> <span class="tfree">'o</span> ValK<span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>KM_map<span class="main">⋅</span>ValK_copy<span class="main">)</span> <span class="main">⊑</span> snd <span class="main">(</span>fix<span class="main">⋅</span>ValK_copy_rec<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun strictify_cancel KM_map_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊑</span> <span class="var">?lhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_belowI D E<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuations-fix_ValK_copy_rec_ID"><span class="command">lemma</span></span> fix_ValK_copy_rec_ID<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fix<span class="main">⋅</span>ValK_copy_rec <span class="main">=</span> <span class="main">(</span>ID<span class="main">,</span> ID<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ValK_copy_rec_ValK_copy ValK_copy_fix cfun_map_ID<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> at_least_two_elements<span class="main">)</span> min_inv_lr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">ea</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">eb</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eRSP <span class="free">ea</span> <span class="free">eb</span> <span class="free">R</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eRSP <span class="main">(</span>ValD_copy_rec<span class="main">⋅</span><span class="free">ea</span><span class="main">)</span> <span class="main">(</span>ValK_copy_rec<span class="main">⋅</span><span class="free">eb</span><span class="main">)</span> <span class="main">(</span>dual <span class="main">(</span><span class="main">(</span>lr <span class="main">::</span> <span class="tfree">'o</span> lflf<span class="main">)</span> <span class="main">(</span>dual <span class="free">S</span><span class="main">,</span> undual <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lr <span class="main">(</span><span class="free">R</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms some_non_bottom_element
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_def lr_rep_def lr_eta_rep_def lr_theta_rep_def KM_map_def cfun_map_def unitK_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_map_def strictify_cancel unitK_def<span class="main">)</span> <span class="comment1">(* FIXME obvious but auto misses it *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">sublocale</span></span> at_least_two_elements <span class="main">&lt;</span> F<span class="main">:</span> DomSolP <span class="quoted">lr</span> <span class="quoted">ValD_copy_rec</span> <span class="quoted">ValK_copy_rec</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mono_lr<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_ValD_copy_rec_ID<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_ValK_copy_rec_ID<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_map_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> min_inv_lr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹A retraction between the two definitions›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can use the relation to establish a strong connection between the
direct and continuation semantics.  All results depend on the
observation type being rich enough.

›</span></span>

<span class="keyword1"><span class="command">context</span></span> at_least_two_elements
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">mrel</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">η:</span> _ <span class="keyword1">↦</span> _"</span> <span class="main">[</span>50<span class="main">,</span> 51<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">η:</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span><span class="main">)</span> <span class="main">∈</span> unlr <span class="main">(</span>fst F.delta<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">vrel</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">θ:</span> _ <span class="keyword1">↦</span> _"</span> <span class="main">[</span>50<span class="main">,</span> 51<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">θ:</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">)</span> <span class="main">∈</span> unlr <span class="main">(</span>snd F.delta<span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1" id="Continuations-F_bottom_triv"><span class="command">lemma</span></span> F_bottom_triv <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">η:</span> <span class="main">⊥</span> <span class="main">↦</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">θ:</span> <span class="main">⊥</span> <span class="main">↦</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Continuations-etaI"><span class="command">lemma</span></span> etaI <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">η:</span> ValTT <span class="main">↦</span> unitK<span class="main">⋅</span>ValKTT"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">η:</span> ValFF <span class="main">↦</span> unitK<span class="main">⋅</span>ValKFF"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">η:</span> ValN<span class="main">⋅</span><span class="free">n</span> <span class="main">↦</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKN<span class="main">⋅</span><span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> F.delta_sol<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lr_rep_def lr_eta_rep_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Continuations-eta_F"><span class="command">lemma</span></span> eta_F<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">θ:</span> <span class="free">f</span> <span class="main">↦</span> <span class="free">f'</span> <span class="main">⟹</span> <span class="keyword1">η:</span> ValF<span class="main">⋅</span><span class="free">f</span> <span class="main">↦</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKF<span class="main">⋅</span><span class="free">f'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> F.delta_sol<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lr_rep_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lr_eta_rep_def split_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Continuations-theta_F"><span class="command">lemma</span></span> theta_F<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="keyword1">η:</span> <span class="bound">x</span> <span class="main">↦</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="keyword1">η:</span> <span class="free">f</span><span class="main">⋅</span><span class="bound">x</span> <span class="main">↦</span> <span class="free">f'</span><span class="main">⋅</span><span class="bound">x'</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">θ:</span> <span class="free">f</span> <span class="main">↦</span> <span class="free">f'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> F.delta_sol<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lr_rep_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lr_theta_rep_def split_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Continuations-eta_induct"><span class="command">lemma</span></span> eta_induct<span class="main">[</span><span class="operator">case_names</span> bottom N F<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="keyword1">η:</span> <span class="free">x</span> <span class="main">↦</span> <span class="free">x'</span><span class="main">;</span>
     <span class="main">⟦</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">;</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="free">x'</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">x</span> <span class="main">=</span> ValTT<span class="main">;</span> <span class="free">x'</span> <span class="main">=</span> unitK<span class="main">⋅</span>ValKTT <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="free">x'</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">x</span> <span class="main">=</span> ValFF<span class="main">;</span> <span class="free">x'</span> <span class="main">=</span> unitK<span class="main">⋅</span>ValKFF <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="free">x'</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">x</span> <span class="main">=</span> ValN<span class="main">⋅</span><span class="bound">n</span><span class="main">;</span> <span class="free">x'</span> <span class="main">=</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKN<span class="main">⋅</span><span class="bound">n</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="free">x'</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">f</span> <span class="bound">f'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">x</span> <span class="main">=</span> ValF<span class="main">⋅</span><span class="bound">f</span><span class="main">;</span> <span class="free">x'</span> <span class="main">=</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKF<span class="main">⋅</span><span class="bound">f'</span><span class="main">)</span><span class="main">;</span> <span class="keyword1">θ:</span> <span class="bound">f</span> <span class="main">↦</span> <span class="bound">f'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="free">x'</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="free">x'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> F.delta_sol<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lr_rep_def lr_eta_rep_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> F.delta_sol<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lr_rep_def lr_eta_rep_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> F.delta_sol<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lr_rep_def lr_eta_rep_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> F.delta_sol<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lr_rep_def lr_eta_rep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> F.delta_sol<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> lr_rep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> lr_eta_rep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Continuations-theta_induct"><span class="command">lemma</span></span> theta_induct<span class="main">[</span><span class="operator">case_names</span> F<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="keyword1">θ:</span> <span class="free">f</span> <span class="main">↦</span> <span class="free">f'</span><span class="main">;</span>
     <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="keyword1">η:</span> <span class="bound">x</span> <span class="main">↦</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="keyword1">η:</span> <span class="free">f</span><span class="main">⋅</span><span class="bound">x</span> <span class="main">↦</span> <span class="free">f'</span><span class="main">⋅</span><span class="bound">x'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">f</span> <span class="free">f'</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">f</span> <span class="free">f'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> F.delta_sol<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> lr_rep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> lr_theta_rep_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Theorem 1 from \citet{DBLP:conf/icalp/Reynolds74}.

›</span></span>

<span class="keyword1" id="Continuations-AbsV_aux"><span class="command">lemma</span></span> AbsV_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">η:</span> ValF<span class="main">⋅</span><span class="free">f</span> <span class="main">↦</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKF<span class="main">⋅</span><span class="free">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">η:</span> ValF<span class="main">⋅</span><span class="main">(</span>strictify<span class="main">⋅</span><span class="free">f</span><span class="main">)</span> <span class="main">↦</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKF<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x c<span class="main">.</span> <span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x'<span class="main">.</span> <span class="free">f'</span><span class="main">⋅</span><span class="main">(</span>unitK<span class="main">⋅</span><span class="bound">x'</span><span class="main">)</span><span class="main">⋅</span><span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eta_F<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> theta_F<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eta_induct<span class="main">)</span> <span class="comment1">(* FIXME special rule would help *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> injD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below_monic_inj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below_monic_unitK<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> theta_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eta_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun eta_F<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Theorem1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">η:</span> <span class="free">ρ</span><span class="main">⋅</span><span class="bound">v</span> <span class="main">↦</span> <span class="free">ρ'</span><span class="main">⋅</span><span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">η:</span> evalD <span class="free">e</span><span class="main">⋅</span><span class="free">ρ</span> <span class="main">↦</span> evalK <span class="free">e</span><span class="main">⋅</span><span class="free">ρ'</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">ρ'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> App <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> appKM_def bindK_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> App.hyps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> App<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eta_induct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> theta_induct<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> App.hyps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> App<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> AbsN <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eta_F<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> theta_F<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AbsN.hyps<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> AbsN<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> env_ext_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AbsV <span class="skolem">v</span> <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">η:</span> ValF<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> evalD <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>env_ext<span class="main">⋅</span><span class="skolem">v</span><span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">↦</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKF<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> evalK <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span>env_ext<span class="main">⋅</span><span class="skolem">v</span><span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="skolem">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eta_F<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> theta_F<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AbsV.hyps<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> AbsV<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> env_ext_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> AbsV_aux<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Fix <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_fix_ind<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_ext_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cond <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_def condK_def eta_cfun<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Cond<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Cond<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eta_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Succ <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succ_def succK_def eta_cfun<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Succ<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Succ<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eta_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Pred <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pred_def predK_def eta_cfun<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Pred<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Pred<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eta_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> IsZero <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isZero_def isZeroK_def eta_cfun<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> IsZero<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> IsZero<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eta_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The retraction between the two value and monadic value spaces.

Note we need to work with an observation type that can represent the
``explicit values'', i.e. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'o</span></span> ValK"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> value_retraction <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">VtoO</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> ValK <span class="main">→</span> <span class="tfree">'o</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">OtoV</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> <span class="main">→</span> <span class="tfree">'o</span> ValK"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> OV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">OtoV</span> <span class="keyword1">oo</span> <span class="free">VtoO</span> <span class="main">=</span> ID"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> value_retraction <span class="main">&lt;</span> at_least_two_elements <span class="quoted"><span class="quoted">"<span class="free">VtoO</span><span class="main">⋅</span><span class="main">(</span>ValKN<span class="main">⋅</span><span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> OV <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> injection_defined cfcomp1 cfun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> value_retraction
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">DtoKM_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ValD <span class="main">→</span> <span class="tfree">'o</span> ValKM"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">KMtoD_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'o</span> ValKM <span class="main">→</span> ValD"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">DtoKM_i</span> <span class="main">0</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">DtoKM_i</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span>
     ValF<span class="main">⋅</span><span class="bound">f</span> <span class="main">⇒</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKF<span class="main">⋅</span><span class="main">(</span>cfun_map<span class="main">⋅</span><span class="main">(</span><span class="free">KMtoD_i</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">DtoKM_i</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="bound">f</span><span class="main">)</span><span class="main">)</span>
   <span class="main">|</span> ValTT <span class="main">⇒</span> unitK<span class="main">⋅</span>ValKTT
   <span class="main">|</span> ValFF <span class="main">⇒</span> unitK<span class="main">⋅</span>ValKFF
   <span class="main">|</span> ValN<span class="main">⋅</span><span class="bound">m</span> <span class="main">⇒</span> unitK<span class="main">⋅</span><span class="main">(</span>ValKN<span class="main">⋅</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">KMtoD_i</span> <span class="main">0</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">KMtoD_i</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="keyword1">case</span> <span class="free">OtoV</span><span class="main">⋅</span><span class="main">(</span><span class="bound">v</span><span class="main">⋅</span><span class="free">VtoO</span><span class="main">)</span> <span class="keyword1">of</span>
     ValKF<span class="main">⋅</span><span class="bound">f</span> <span class="main">⇒</span> ValF<span class="main">⋅</span><span class="main">(</span>cfun_map<span class="main">⋅</span><span class="main">(</span><span class="free">DtoKM_i</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">KMtoD_i</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="bound">f</span><span class="main">)</span>
   <span class="main">|</span> ValKTT <span class="main">⇒</span> ValTT
   <span class="main">|</span> ValKFF <span class="main">⇒</span> ValFF
   <span class="main">|</span> ValKN<span class="main">⋅</span><span class="bound">m</span> <span class="main">⇒</span> ValN<span class="main">⋅</span><span class="bound">m</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">DtoKM</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> DtoKM_i <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">KMtoD</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> KMtoD_i <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="Continuations-DtoKM_KMtoD_chain"><span class="command">lemma</span></span> DtoKM_KMtoD_chain <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"chain DtoKM_i"</span></span>
  <span class="quoted"><span class="quoted">"chain KMtoD_i"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>DtoKM_i <span class="bound">i</span><span class="main">,</span> KMtoD_i <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chain <span class="var">?C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> chainI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="skolem">i</span> <span class="main">⊑</span> <span class="var">?C</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> monofun_pair<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"DtoKM_i <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">⊑</span> DtoKM_i <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> cfun_belowI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"DtoKM_i <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">x</span> <span class="main">⊑</span> DtoKM_i <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> monofun_cfun <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_map_def cfun_below_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"KMtoD_i <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">⊑</span> KMtoD_i <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> cfun_belowI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"KMtoD_i <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">x</span> <span class="main">⊑</span> KMtoD_i <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun_fun monofun_cfun_arg<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> cfun_belowI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> monofun_cfun<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chain DtoKM_i"</span></span> <span class="quoted"><span class="quoted">"chain KMtoD_i"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ch2ch_fst ch2ch_snd<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Lemma 1 from \citet{DBLP:conf/icalp/Reynolds74}.

›</span></span>

<span class="keyword1" id="Continuations-Lemma1"><span class="command">lemma</span></span> Lemma1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">η:</span> <span class="free">x</span> <span class="main">↦</span> DtoKM<span class="main">⋅</span><span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">η:</span> <span class="free">x</span> <span class="main">↦</span> <span class="free">x'</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> KMtoD<span class="main">⋅</span><span class="free">x'</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">η:</span> ValD_copy_i <span class="skolem">i</span><span class="main">⋅</span><span class="skolem">x</span> <span class="main">↦</span> DtoKM_i <span class="skolem">i</span><span class="main">⋅</span><span class="skolem">x</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">η:</span> <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">x'</span> <span class="main">⟹</span> ValD_copy_i <span class="skolem">i</span><span class="main">⋅</span><span class="skolem">x</span> <span class="main">=</span> KMtoD_i <span class="skolem">i</span><span class="main">⋅</span><span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">x'</span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">x'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eta_F<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> theta_F<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> Suc
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eta_induct<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> OV
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_eq_iff retraction_strict<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cfun_eq_iff<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> theta_induct<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> Suc
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>ValD_copy_i <span class="bound">i</span><span class="main">,</span> DtoKM_i <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="keyword1">η:</span> <span class="main">(</span>fst <span class="bound">f</span><span class="main">)</span><span class="main">⋅</span><span class="free">x</span> <span class="main">↦</span> <span class="main">(</span>snd <span class="bound">f</span><span class="main">)</span><span class="main">⋅</span><span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adm <span class="var">?P1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> adm_subst<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> K
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P1</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> ValD_copy_i <span class="bound">i</span><span class="main">,</span> <span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> DtoKM_i <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> admD<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?P1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?C1</span>"</span></span><span class="main">]</span> lub_prod<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?C1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">ValD</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> ValKM"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>ValD_copy_i <span class="bound">i</span><span class="main">,</span> KMtoD_i <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">f</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>snd <span class="bound">f</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">x'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="var">?P2</span> <span class="bound">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">η:</span> <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">x'</span> <span class="main">⟹</span> <span class="var">?P2</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> ValD_copy_i <span class="bound">i</span><span class="main">,</span> <span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> KMtoD_i <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> admD<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?P2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?C2</span>"</span></span><span class="main">]</span> lub_prod<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?C2</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">η:</span> <span class="free">x</span> <span class="main">↦</span> DtoKM<span class="main">⋅</span><span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">η:</span> <span class="free">x</span> <span class="main">↦</span> <span class="free">x'</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> KMtoD<span class="main">⋅</span><span class="free">x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ValD_copy_lub_ID<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Theorem 2 from \citet{DBLP:conf/icalp/Reynolds74}.

›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Theorem2<span class="main">:</span> <span class="quoted"><span class="quoted">"evalD <span class="free">e</span><span class="main">⋅</span><span class="free">ρ</span> <span class="main">=</span> KMtoD<span class="main">⋅</span><span class="main">(</span>evalK <span class="free">e</span><span class="main">⋅</span><span class="main">(</span>DtoKM <span class="keyword1">oo</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Lemma1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Theorem1<span class="main">]</span> Lemma1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfcomp1<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\citet[Remark~48]{DBLP:journals/tcs/Filinski07} observes that there
will not be a retraction between direct and continuation semantics for
languages with richer notions of effects.

It should be routine to extend the above approach to the higher-order
backtracking language of \citet{DBLP:conf/icfp/WandV04}.

I wonder if it is possible to construct continuation semantics from
direct semantics as proposed by
\citet{DBLP:journals/jacm/SethiT80}. Roughly we might hope to lift a
retraction between two value domains to a retraction at higher types
by synthesising a suitable logical relation.

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="SmallStep">
<div class="head">
<h1>Theory SmallStep</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SmallStep.thy
    Author:     Peter Gammie
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A small-step (reduction) operational semantics for PCF›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">theory</span></span> SmallStep
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#OpSem">OpSem</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

A small-step semantics allows us to express more things, like the
progress of well-typed programs.

FIXME adjust: This relation is non-deterministic, but only <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>β›</span></span></span></span>-reduces terms where the argument is a value. Moreover if we
start with a closed term then our values are also closed. So while in
general (i.e., for open terms) our substitution operation is wrong and
this relation is too big, we show that things work out if we start
reducing from a closed term (i.e., a program).

FIXME following Tolmach <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">url</span></span>
"https://www.cis.upenn.edu/~bcpierce/sf/current/Norm.html"<span class="antiquote"><span class="antiquote">}</span></span></span></span> we make
this relation deterministic. Eases the normalization proof.

›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">reduction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"db <span class="main">⇒</span> db <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  betaN<span class="main">:</span> <span class="quoted"><span class="quoted">"DBApp <span class="main">(</span>DBAbsN <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span>"</span></span>
<span class="main">|</span> betaV<span class="main">:</span> <span class="quoted"><span class="quoted">"val <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟹</span> DBApp <span class="main">(</span>DBAbsV <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">⟹</span> DBApp <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>v</sub></span></span> DBApp <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> DBAbsV <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> DBApp <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>v</sub></span></span> DBApp <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"DBFix <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">&lt;</span>DBFix <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">/</span><span class="main">0</span><span class="main">&gt;</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"DBCond DBtt <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"DBCond DBff <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"DBSucc <span class="main">(</span>DBNum <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>v</sub></span></span> DBNum <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"DBPred <span class="main">(</span>DBNum <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>v</sub></span></span> DBNum <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"DBIsZero <span class="main">(</span>DBNum <span class="main">0</span><span class="main">)</span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>v</sub></span></span> DBtt"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span> DBIsZero <span class="main">(</span>DBNum <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>v</sub></span></span> DBff"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="comment1">― ‹The transitive, reflexive closure of the reduction relation.›</span>
  <span class="entity">reduction_trc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"db <span class="main">⇒</span> db <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub><span class="hidden">⇧</span><sup>*</sup></span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 100<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reduction_trc</span> <span class="main">≡</span> rtranclp reduction"</span></span>

<span class="keyword1"><span class="command">declare</span></span> reduction.intros<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> reduction_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"DBVar <span class="free">v</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t'</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBApp <span class="free">f</span> <span class="free">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t'</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBAbsN <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t'</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBAbsV <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t'</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBFix <span class="free">f</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t'</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBCond <span class="free">i</span> <span class="free">t</span> <span class="free">e</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t'</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBff <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t'</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBtt <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t'</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBNum <span class="free">n</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t'</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBSucc <span class="free">n</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t'</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBPred <span class="free">n</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t'</span>"</span></span>
  <span class="quoted"><span class="quoted">"DBIsZero <span class="free">n</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t'</span>"</span></span>

<span class="keyword1" id="SmallStep-reduction_val"><span class="command">lemma</span></span> reduction_val<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"val <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> val.cases reduction_inv<span class="main">)</span>

<span class="keyword1" id="SmallStep-reduction_deterministic"><span class="command">lemma</span></span> reduction_deterministic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t''</span> <span class="main">=</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t''</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> reduction_val <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> reduction_inv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹ Reduction is consistent with evaluation ›</span></span>

<span class="keyword1" id="SmallStep-reduction_eval"><span class="command">lemma</span></span> reduction_eval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> evalOP_inv val.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval_val<span class="main">)</span>

<span class="keyword1" id="SmallStep-reduction_trc_eval"><span class="command">lemma</span></span> reduction_trc_eval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reduction_eval<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> reduction_trc_val_eval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>v</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"val <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtranclp_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval_val reduction_trc_eval<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We show the converse (of sorts) using the frame stack machinery of the
next section.

›</span></span>

<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>