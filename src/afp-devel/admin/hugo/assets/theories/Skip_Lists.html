<div id="Pi_pmf">
<div class="head">
<h1>Theory Pi_pmf</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Pi_pmf.thy
  Authors: Manuel Eberl, Max W. Haslbeck
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Indexed products of PMFs›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Pi_pmf
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1" id="Pi_pmf-pmf_expectation_eq_infsetsum"><span class="command">lemma</span></span> pmf_expectation_eq_infsetsum<span class="main">:</span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">p</span> <span class="free">f</span> <span class="main">=</span> infsetsum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> infsetsum_def measure_pmf_eq_density <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_density<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Pi_pmf-measure_pmf_prob_product"><span class="command">lemma</span></span> measure_pmf_prob_product<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"countable <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"countable <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>pair_pmf <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> measure_pmf.prob <span class="free">M</span> <span class="free">A</span> <span class="main">*</span> measure_pmf.prob <span class="free">N</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>pair_pmf <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">.</span> pmf <span class="free">M</span> <span class="bound">a</span> <span class="main">*</span> pmf <span class="free">N</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> infsetsum_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf_conv_infsetsum pmf_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> measure_pmf.prob <span class="free">M</span> <span class="free">A</span> <span class="main">*</span> measure_pmf.prob <span class="free">N</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_product<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf_conv_infsetsum<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In analogy to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> PiM<span class="antiquote"><span class="antiquote">}</span></span></span></span>, we define an indexed product of PMFs. In the literature, this
  is typically called taking a vector of independent random variables. Note that the components
  do not have to be identically distributed.

  The operation takes an explicit index set <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">A</span></span> <span class="main"><span class="main">::</span></span> <span class="tfree"><span class="tfree">'a</span></span> set›</span></span></span></span> and a function <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">f</span></span> <span class="main"><span class="main">::</span></span> <span class="tfree"><span class="tfree">'a</span></span> <span class="main"><span class="main">⇒</span></span> <span class="tfree"><span class="tfree">'b</span></span> pmf›</span></span></span></span>
  that maps each element from <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">A</span></span>›</span></span></span></span> to a PMF and defines the product measure
  $\bigotimes_{i\in A} f(i)$ , which is represented as a <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'a</span></span> <span class="main"><span class="main">⇒</span></span> <span class="tfree"><span class="tfree">'b</span></span><span class="main"><span class="main">)</span></span> pmf›</span></span></span></span>.

  Note that unlike <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> PiM<span class="antiquote"><span class="antiquote">}</span></span></span></span>, this only works for <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹finite›</span></span> index sets. It could
  be extended to countable sets and beyond, but the construction becomes somewhat more involved.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Pi_pmf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> pmf<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Pi_pmf</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
     embed_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> pmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A technical subtlety that needs to be addressed is this: Intuitively, the functions in the
  support of a product distribution have domain <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>. However, since HOL is a total logic, these
  functions must still return <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹some›</span></span> value for inputs outside <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>. The product measure
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> PiM<span class="antiquote"><span class="antiquote">}</span></span></span></span> simply lets these functions return <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> undefined<span class="antiquote"><span class="antiquote">}</span></span></span></span> in these cases. We chose a
  different solution here, which is to supply a default value <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">dflt</span></span> <span class="main"><span class="main">::</span></span> <span class="tfree"><span class="tfree">'b</span></span>›</span></span></span></span> that is returned
  in these cases.

  As one possible application, one could model the result of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> different independent coin
  tosses as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">..&lt;</span></span><span class="free"><span class="free">n</span></span><span class="main"><span class="main">}</span></span> False <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> bernoulli_pmf <span class="main"><span class="main">(</span></span><span class="main"><span class="main">1</span></span> <span class="main"><span class="main">/</span></span> <span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This returns a function
  of type <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹nat <span class="main"><span class="main">⇒</span></span> bool›</span></span></span></span> that maps every natural number below <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> to the result of the
  corresponding coin toss, and every other natural number to <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹False›</span></span></span></span>.
›</span></span>

<span class="keyword1" id="Pi_pmf-pmf_Pi"><span class="command">lemma</span></span> pmf_Pi<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span>
             <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dflt</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Pi_pmf_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pmf_embed_pmf<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dflt</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> set_pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> neutral_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">xa</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> PiE <span class="free">A</span> <span class="skolem">B</span> <span class="main">-</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> restrict <span class="bound">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">)</span> <span class="free">A</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> restrict <span class="bound">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> imageI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PiE_def Pi_def extensional_def fun_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> neutral_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">xa</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> restrict <span class="bound">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">S</span> <span class="main">-</span> PiE <span class="free">A</span> <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> restrict <span class="skolem">f'</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">f'</span> <span class="free">A</span> <span class="main">∉</span> PiE <span class="free">A</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span><span class="free">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_def set_pmf_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> f' <span class="keyword2"><span class="keyword">and</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> PiE <span class="free">A</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_summable_on_prod_PiE A<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> restrict <span class="bound">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_summable_on_cong_neutral neutral_left neutral_right<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>restrict <span class="bound">f</span> <span class="free">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_summable_on_reindex_iff <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def fun_eq_iff S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dflt</span> <span class="keyword1">then</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>
                          <span class="keyword1">abs_summable_on</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_summable_on_cong_neutral<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> summable<span class="main">:</span> <span class="quoted"><span class="main">…</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">1</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">y</span><span class="main">∈</span><span class="skolem">B</span> <span class="bound">x</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_pmf_eq_1<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">y</span><span class="main">∈</span><span class="skolem">B</span> <span class="bound">x</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">f</span><span class="main">∈</span>Pi<span class="hidden">⇩</span><sub>E</sub> <span class="free">A</span> <span class="skolem">B</span><span class="main">.</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_prod_PiE <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> A<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">f</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> restrict <span class="bound">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">.</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cong_neutral neutral_left neutral_right refl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">f</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>restrict <span class="bound">f</span> <span class="free">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> infsetsum_reindex<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def fun_eq_iff S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">f</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">f</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dflt</span> <span class="keyword1">then</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cong_neutral<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">f</span><span class="main">.</span> ennreal <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dflt</span>
                             <span class="keyword1">then</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_conv_infsetsum <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> summable<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_nonneg<span class="main">)</span>

<span class="keyword1" id="Pi_pmf-pmf_Pi'"><span class="command">lemma</span></span> pmf_Pi'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dflt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_Pi<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_pmf-pmf_Pi_outside"><span class="command">lemma</span></span> pmf_Pi_outside<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">dflt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_Pi<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pi_pmf-pmf_Pi_empty"><span class="command">lemma</span></span> pmf_Pi_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="main">{}</span> <span class="free">dflt</span> <span class="free">p</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">dflt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> pmf_Pi<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def<span class="main">)</span>

<span class="keyword1" id="Pi_pmf-set_Pi_pmf_subset"><span class="command">lemma</span></span> set_Pi_pmf_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> set_pmf <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">dflt</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_pmf_eq pmf_Pi<span class="main">)</span>

<span class="keyword1" id="Pi_pmf-Pi_pmf_cong"><span class="command">lemma</span></span> Pi_pmf_cong <span class="main">[</span><span class="operator">cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">dflt</span> <span class="main">=</span> <span class="free">dflt'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">f</span> <span class="main">=</span> Pi_pmf <span class="free">A'</span> <span class="free">dflt'</span> <span class="free">f'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext prod.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pi_pmf_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Dependent product sets with a default›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following describes a dependent product of sets where the functions are required to return
  the default value <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">dflt</span></span>›</span></span></span></span> outside their domain, in analogy to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> PiE<span class="antiquote"><span class="antiquote">}</span></span></span></span>, which uses
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> undefined<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PiE_dflt</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">PiE_dflt</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Pi_pmf-restrict_PiE_dflt"><span class="command">lemma</span></span> restrict_PiE_dflt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> restrict <span class="bound">h</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="free">B</span> <span class="main">=</span> PiE <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> restrict <span class="bound">h</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="free">B</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> PiE <span class="free">A</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PiE_dflt_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> PiE <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"restrict <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="skolem">h</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">)</span> <span class="free">A</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> restrict <span class="bound">h</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> imageI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PiE_def extensional_def PiE_dflt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="skolem">h</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> restrict <span class="bound">h</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_pmf-dflt_image_PiE"><span class="command">lemma</span></span> dflt_image_PiE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">h</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="bound">h</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">)</span> <span class="main">`</span> PiE <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="free">B</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="var">?X</span> <span class="main">=</span> <span class="var">?Y</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> <span class="var">?f</span> <span class="main">`</span> <span class="var">?X</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> <span class="var">?Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PiE_dflt_def PiE_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> <span class="var">?Y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span>restrict <span class="skolem">h</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?f</span> <span class="main">`</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> imageI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PiE_def extensional_def PiE_dflt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span>restrict <span class="skolem">h</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff PiE_dflt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> <span class="var">?f</span> <span class="main">`</span> <span class="var">?X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_pmf-finite_PiE_dflt"><span class="command">lemma</span></span> finite_PiE_dflt <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finite <span class="main">(</span>PiE_dflt <span class="free">A</span> <span class="free">d</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"PiE_dflt <span class="free">A</span> <span class="free">d</span> <span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">d</span><span class="main">)</span> <span class="main">`</span> PiE <span class="free">A</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dflt_image_PiE <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_imageI finite_PiE assms<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_pmf-card_PiE_dflt"><span class="command">lemma</span></span> card_PiE_dflt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"card <span class="main">(</span>PiE_dflt <span class="free">A</span> <span class="free">d</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> card <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> card <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>PiE <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_PiE <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"PiE <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> restrict <span class="bound">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> PiE_dflt <span class="free">A</span> <span class="free">d</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> restrict_PiE_dflt <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> card <span class="main">(</span>PiE_dflt <span class="free">A</span> <span class="free">d</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_image<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def restrict_def fun_eq_iff PiE_dflt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_pmf-PiE_dflt_empty_iff"><span class="command">lemma</span></span> PiE_dflt_empty_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">B</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dflt_image_PiE <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> PiE_eq_empty_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The probability of an independent combination of events is precisely the product
  of the probabilities of each individual event.
›</span></span>
<span class="keyword1" id="Pi_pmf-measure_Pi_pmf_PiE_dflt"><span class="command">lemma</span></span> measure_Pi_pmf_PiE_dflt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> measure_pmf.prob <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">B</span> <span class="bound">x</span> <span class="main">∩</span> set_pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">h</span><span class="main">∈</span>PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="free">B</span><span class="main">.</span> pmf <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="bound">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measure_pmf_conv_infsetsum<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">h</span><span class="main">∈</span>PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="free">B</span><span class="main">.</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> pmf_Pi'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PiE_dflt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">h</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> restrict <span class="bound">h</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="free">B</span><span class="main">.</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_reindex<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def PiE_dflt_def fun_eq_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> restrict <span class="bound">h</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="free">B</span> <span class="main">=</span> PiE <span class="free">A</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> restrict_PiE_dflt<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">h</span><span class="main">∈</span>PiE <span class="free">A</span> <span class="free">B</span><span class="main">.</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">h</span><span class="main">∈</span>PiE <span class="free">A</span> <span class="skolem">B'</span><span class="main">.</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cong_neutral<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B'_def set_pmf_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">h</span><span class="main">∈</span>PiE <span class="free">A</span> <span class="skolem">B'</span><span class="main">.</span> <span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> infsetsum <span class="main">(</span>pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">B'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_prod_PiE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> infsetsum <span class="main">(</span>pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod.cong infsetsum_cong_neutral<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B'_def set_pmf_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> measure_pmf.prob <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measure_pmf_conv_infsetsum<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_pmf-set_Pi_pmf_subset'"><span class="command">lemma</span></span> set_Pi_pmf_subset'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">⊆</span> PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span>set_pmf <span class="main">∘</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_pmf_eq pmf_Pi PiE_dflt_def<span class="main">)</span>

<span class="keyword1" id="Pi_pmf-Pi_pmf_return_pmf"><span class="command">lemma</span></span> Pi_pmf_return_pmf <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_pmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_pmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
          PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span>set_pmf <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_pmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> set_Pi_pmf_subset' assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PiE_dflt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_pmf_subset_singleton<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_pmf-Pi_pmf_return_pmf'"><span class="command">lemma</span></span> Pi_pmf_return_pmf' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> return_pmf <span class="free">dflt</span><span class="main">)</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">dflt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pi_pmf-measure_Pi_pmf_Pi"><span class="command">lemma</span></span> measure_Pi_pmf_Pi<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>Pi <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> measure_pmf.prob <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> measure_pmf.prob <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measure_prob_cong_0<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PiE_dflt_def PiE_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pmf_Pi_outside<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_Pi_pmf_PiE_dflt<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Common PMF operations on products›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Pi_pmf<span class="antiquote"><span class="antiquote">}</span></span></span></span> distributes over the `bind' operation in the Giry monad:
›</span></span>
<span class="keyword1" id="Pi_pmf-Pi_pmf_bind"><span class="command">lemma</span></span> Pi_pmf_bind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="free">d</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bind_pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">q</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="keyword1">do</span> <span class="main">{</span><span class="bound">f</span> <span class="main">←</span> Pi_pmf <span class="free">A</span> <span class="free">d'</span> <span class="free">p</span><span class="main">;</span> Pi_pmf <span class="free">A</span> <span class="free">d</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">q</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pmf_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">-</span><span class="free">A</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">d</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> set_pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"countable <span class="main">(</span><span class="skolem">B</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_def<span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="skolem">B</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_abs_summable<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>pmf <span class="main">(</span><span class="free">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">1</span><span class="main">)</span> <span class="main">≥</span> norm <span class="main">(</span>pmf <span class="main">(</span><span class="free">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">q</span> <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
        <span class="keyword1"><span class="command">unfolding</span></span> norm_mult <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pmf_le_1<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">a</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">q</span> <span class="skolem">x</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="skolem">B</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_summable_on_comparison_test<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> summable <span class="main">=</span> this

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?rhs</span> <span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">g</span><span class="main">.</span> pmf <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">d'</span> <span class="free">p</span><span class="main">)</span> <span class="bound">g</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">q</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_bind<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> pmf_Pi'<span class="main">)</span>
         <span class="main">(</span><span class="operator">insert</span> assms False<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_expectation_eq_infsetsum<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">g</span><span class="main">∈</span>PiE_dflt <span class="free">A</span> <span class="free">d'</span> <span class="skolem">B</span><span class="main">.</span>
                      pmf <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">d'</span> <span class="free">p</span><span class="main">)</span> <span class="bound">g</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">q</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cong_neutral<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pmf_Pi PiE_dflt_def set_pmf_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">g</span><span class="main">∈</span>PiE_dflt <span class="free">A</span> <span class="free">d'</span> <span class="skolem">B</span><span class="main">.</span>
                      <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">q</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pmf_Pi PiE_dflt_def prod.distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">g</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> restrict <span class="bound">g</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> PiE_dflt <span class="free">A</span> <span class="free">d'</span> <span class="skolem">B</span><span class="main">.</span>
                      <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">q</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_reindex<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PiE_dflt_def inj_on_def fun_eq_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> restrict <span class="bound">g</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> PiE_dflt <span class="free">A</span> <span class="free">d'</span> <span class="skolem">B</span> <span class="main">=</span> PiE <span class="free">A</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> restrict_PiE_dflt<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">g</span><span class="main">∈</span><span class="main">…</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">q</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">a</span><span class="main">∈</span><span class="skolem">B</span> <span class="bound">x</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">a</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">q</span> <span class="bound">x</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms summable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_prod_PiE<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">a</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">a</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">q</span> <span class="bound">x</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod.cong infsetsum_cong_neutral<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_def set_pmf_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf <span class="var">?lhs</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_Pi'<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_bind pmf_expectation_eq_infsetsum<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?rhs</span> <span class="skolem">f</span> <span class="main">=</span>
            measure_pmf.expectation <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">d'</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pmf <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">d</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> <span class="free">q</span> <span class="bound">xa</span> <span class="main">(</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_bind<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> measure_pmf.expectation <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">d'</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Bochner_Integration.integral_cong pmf_Pi_outside<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf <span class="var">?lhs</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_Pi_outside<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Analogously any componentwise mapping can be pulled outside the product:
›</span></span>
<span class="keyword1" id="Pi_pmf-Pi_pmf_map"><span class="command">lemma</span></span> Pi_pmf_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">dflt</span> <span class="main">=</span> <span class="free">dflt'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="free">dflt'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_pmf <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="free">f</span> <span class="main">∘</span> <span class="bound">h</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="free">dflt'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_pmf <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          Pi_pmf <span class="free">A</span> <span class="free">dflt'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> return_pmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_pmf_def Pi_pmf_bind<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">g</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> return_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="main">(</span><span class="bound">h</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">dflt'</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_bind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> d' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">dflt</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="free">f</span> <span class="main">∘</span> <span class="bound">h</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_pmf_def <span class="keyword1"><span class="command">using</span></span> set_Pi_pmf_subset'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">dflt</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">return_pmf</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff PiE_dflt_def assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can exchange the default value in a product of PMFs like this:
›</span></span>
<span class="keyword1" id="Pi_pmf-Pi_pmf_default_swap"><span class="command">lemma</span></span> Pi_pmf_default_swap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">dflt'</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span>
             Pi_pmf <span class="free">A</span> <span class="free">dflt'</span> <span class="free">p</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pmf_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">dflt'</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">f</span><span class="main">}</span> <span class="main">∩</span> PiE_dflt <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> UNIV<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">-</span><span class="free">A</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">dflt'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">dflt</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?lhs</span> <span class="skolem">f</span> <span class="main">=</span> measure_pmf.prob <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> pmf_map
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measure_prob_cong_0<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PiE_dflt_def pmf_Pi_outside<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">=</span> <span class="main">{</span><span class="var">?f'</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff PiE_dflt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">{</span><span class="var">?f'</span><span class="main">}</span> <span class="main">=</span> pmf <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="var">?f'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf_single<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf <span class="var">?rhs</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> pmf_Pi<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?lhs</span> <span class="skolem">f</span> <span class="main">=</span> measure_pmf.prob <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> pmf_map
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measure_prob_cong_0<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PiE_dflt_def pmf_Pi_outside<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> pmf <span class="var">?rhs</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_Pi_outside <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following rule allows reindexing the product:
›</span></span>
<span class="keyword1" id="Pi_pmf-Pi_pmf_bij_betw"><span class="command">lemma</span></span> Pi_pmf_bij_betw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">h</span> <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">h</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∘</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">B</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms bij_betw_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?lhs</span> <span class="skolem">g</span> <span class="main">=</span> pmf <span class="var">?rhs</span> <span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">g</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟶</span> <span class="skolem">g</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">dflt</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h'</span> <span class="main">=</span> the_inv_into <span class="free">A</span> <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> h'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h'</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">unfolding</span></span> h'_def <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betw_def the_inv_into_f_f<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">(</span><span class="skolem">h'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">unfolding</span></span> h'_def <span class="keyword1"><span class="command">using</span></span> that assms f_the_inv_into_f_bij_betw <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?rhs</span> <span class="skolem">g</span> <span class="main">=</span> measure_pmf.prob <span class="main">(</span>Pi_pmf <span class="free">B</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∘</span> <span class="free">h</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">g</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pmf_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> measure_pmf.prob <span class="main">(</span>Pi_pmf <span class="free">B</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>
                                <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∘</span> <span class="free">h</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">g</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> PiE_dflt <span class="free">B</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> UNIV<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measure_prob_cong_0<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PiE_dflt_def pmf_Pi_outside<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf <span class="main">(</span>Pi_pmf <span class="free">B</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="keyword1">then</span> <span class="skolem">g</span> <span class="main">(</span><span class="skolem">h'</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">h</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="keyword1">then</span> <span class="skolem">g</span> <span class="main">(</span><span class="skolem">h'</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">using</span></span> h' assms True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betwE<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∘</span> <span class="free">h</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">g</span><span class="main">}</span> <span class="main">∩</span> PiE_dflt <span class="free">B</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> UNIV<span class="main">)</span> <span class="main">=</span>
            <span class="main">{</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="keyword1">then</span> <span class="skolem">g</span> <span class="main">(</span><span class="skolem">h'</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms h' h True <span class="keyword1"><span class="command">unfolding</span></span> PiE_dflt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf_single<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B assms True  h'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_Pi <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod.reindex_bij_betw bij_betw_the_inv_into<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?rhs</span> <span class="skolem">g</span> <span class="main">=</span> infsetsum <span class="main">(</span>pmf <span class="main">(</span>Pi_pmf <span class="free">B</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∘</span> <span class="free">h</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">g</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf_conv_infsetsum pmf_map<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> infsetsum <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">g</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">g</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">g</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B False assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cong pmf_Pi_outside<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_Pi pmf_map<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pmf_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A product of uniform random choices is again a uniform distribution.
›</span></span>
<span class="keyword1" id="Pi_pmf-Pi_pmf_of_set"><span class="command">lemma</span></span> Pi_pmf_of_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="free">d</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pmf_of_set <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pmf_of_set <span class="main">(</span>PiE_dflt <span class="free">A</span> <span class="free">d</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pmf_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">d</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?lhs</span> <span class="skolem">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_Pi_outside<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PiE_dflt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∉</span> PiE_dflt <span class="free">A</span> <span class="free">d</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PiE_dflt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> pmf <span class="var">?rhs</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_of_set<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?lhs</span> <span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span>pmf_of_set <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_Pi'<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> indicator <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>card <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod.cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> pmf_of_set<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms False <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> indicator <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> card <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod_dividef<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> indicator <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">=</span> indicator <span class="main">(</span>PiE_dflt <span class="free">A</span> <span class="free">d</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def PiE_dflt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> card <span class="main">(</span><span class="free">B</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>PiE_dflt <span class="free">A</span> <span class="free">d</span> <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_PiE_dflt <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"indicator <span class="main">(</span>PiE_dflt <span class="free">A</span> <span class="free">d</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">f</span> <span class="main">/</span> <span class="main">…</span> <span class="main">=</span> pmf <span class="var">?rhs</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_of_set <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Merging and splitting PMF products›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma shows that we can add a single PMF to a product:
›</span></span>
<span class="keyword1" id="Pi_pmf-Pi_pmf_insert"><span class="command">lemma</span></span> Pi_pmf_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Pi_pmf <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="free">dflt</span> <span class="free">p</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pair_pmf <span class="main">(</span><span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pair_pmf <span class="main">(</span><span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="var">?M</span><span class="main">)</span> <span class="skolem">f</span> <span class="main">=</span>
          measure_pmf.prob <span class="var">?M</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">f</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_map<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">f</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">y'</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="skolem">f</span> <span class="free">x</span><span class="main">,</span> <span class="skolem">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y'</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_def fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="var">?M</span> <span class="main">…</span> <span class="main">=</span> measure_pmf.prob <span class="var">?M</span> <span class="main">{</span><span class="main">(</span><span class="skolem">f</span> <span class="free">x</span><span class="main">,</span> <span class="skolem">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">dflt</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measure_prob_cong_0<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pmf_pair pmf_Pi <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf <span class="main">(</span><span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> pmf <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">dflt</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf_single pmf_pair pmf_Pi<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf <span class="main">(</span>Pi_pmf <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∉</span> insert <span class="free">x</span> <span class="free">A</span> <span class="main">⟶</span> <span class="skolem">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">dflt</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span><span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> pmf <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">dflt</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                       pmf <span class="main">(</span><span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">xa</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">dflt</span><span class="main">)</span><span class="main">)</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_Pi'<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">xa</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">dflt</span><span class="main">)</span><span class="main">)</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">xa</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">p</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod.cong<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span><span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> pmf <span class="main">(</span>Pi_pmf <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_Pi'<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pmf_Pi<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf <span class="main">(</span>map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="var">?M</span><span class="main">)</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_pmf-Pi_pmf_insert'"><span class="command">lemma</span></span> Pi_pmf_insert'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Pi_pmf <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="free">dflt</span> <span class="free">p</span> <span class="main">=</span>
             <span class="keyword1">do</span> <span class="main">{</span><span class="bound">y</span> <span class="main">←</span> <span class="free">p</span> <span class="free">x</span><span class="main">;</span> <span class="bound">f</span> <span class="main">←</span> Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">;</span> return_pmf <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_insert<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_pmf_def pair_pmf_def case_prod_beta' bind_return_pmf bind_assoc_pmf<span class="main">)</span>

<span class="keyword1" id="Pi_pmf-Pi_pmf_singleton"><span class="command">lemma</span></span> Pi_pmf_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Pi_pmf <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="free">dflt</span> <span class="free">p</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="free">dflt</span> <span class="free">p</span> <span class="main">=</span> map_pmf <span class="main">(</span>fun_upd <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">dflt</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_insert<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_return_pmf2 pmf.map_comp o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fun_upd <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">dflt</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="bound">z</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_def fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Projecting a product of PMFs onto a component yields the expected result:
›</span></span>
<span class="keyword1" id="Pi_pmf-Pi_pmf_component"><span class="command">lemma</span></span> Pi_pmf_component<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="free">p</span> <span class="free">x</span> <span class="keyword1">else</span> return_pmf <span class="free">dflt</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">=</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword1"><span class="command">have</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> insert <span class="free">x</span> <span class="skolem">A'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_insert<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A'_def pmf.map_comp o_def case_prod_unfold map_fst_pair_pmf<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">dflt</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms False set_Pi_pmf_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">dflt</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf.map_cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_pmf_eq pmf_Pi_outside<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can take merge two PMF products on disjoint sets like this:
›</span></span>
<span class="keyword1" id="Pi_pmf-Pi_pmf_union"><span class="command">lemma</span></span> Pi_pmf_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Pi_pmf <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">dflt</span> <span class="free">p</span> <span class="main">=</span>
             map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="bound">g</span> <span class="bound">x</span><span class="main">)</span>
             <span class="main">(</span>pair_pmf <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">B</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="var">?h</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="var">?q</span> <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span><span class="var">?h</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?q</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword1">do</span> <span class="main">{</span><span class="bound">v</span> <span class="main">←</span> <span class="free">p</span> <span class="skolem">x</span><span class="main">;</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">←</span> pair_pmf <span class="main">(</span>Pi_pmf <span class="skolem">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">B</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span><span class="main">;</span>
              return_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">A</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="bound">g</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_insert<span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> insert.hyps insert.prems<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_pmf_def map_bind_pmf bind_map_pmf bind_assoc_pmf bind_return_pmf<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">v</span> <span class="main">←</span> <span class="free">p</span> <span class="skolem">x</span><span class="main">;</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">←</span> <span class="var">?q</span> <span class="skolem">A</span><span class="main">;</span> return_pmf <span class="main">(</span><span class="main">(</span><span class="var">?h</span> <span class="skolem">A</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">v</span> <span class="main">←</span> <span class="free">p</span> <span class="skolem">x</span><span class="main">;</span> <span class="bound">f</span> <span class="main">←</span> map_pmf <span class="main">(</span><span class="var">?h</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span><span class="var">?q</span> <span class="skolem">A</span><span class="main">)</span><span class="main">;</span> return_pmf <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_pmf map_bind_pmf case_prod_unfold <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">v</span> <span class="main">←</span> <span class="free">p</span> <span class="skolem">x</span><span class="main">;</span> <span class="bound">f</span> <span class="main">←</span> Pi_pmf <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">;</span> return_pmf <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert.hyps <span class="keyword2"><span class="keyword">and</span></span> insert.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong insert.IH <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> refl<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Pi_pmf <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="free">dflt</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_insert<span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> assms insert.hyps insert.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pair_pmf_def map_bind_pmf<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold map_snd_pair_pmf<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can also project a product to a subset of the indices by mapping all the other
  indices to the default value:
›</span></span>
<span class="keyword1" id="Pi_pmf-Pi_pmf_subset"><span class="command">lemma</span></span> Pi_pmf_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A'</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A'</span> <span class="free">dflt</span> <span class="free">p</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A'</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pair_pmf <span class="main">(</span>Pi_pmf <span class="free">A'</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">A'</span><span class="main">)</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">A'</span> <span class="main">∪</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">A'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="main">…</span> <span class="free">dflt</span> <span class="free">p</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A'</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="bound">g</span> <span class="bound">x</span><span class="main">)</span> <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Pi_pmf_union<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A'</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">)</span> <span class="main">…</span> <span class="main">=</span> map_pmf fst <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_pmf_comp o_def case_prod_unfold
    <span class="keyword1"><span class="command">using</span></span> set_Pi_pmf_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A'</span></span> <span class="quoted"><span class="free">dflt</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_pmf_cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Pi_pmf <span class="free">A'</span> <span class="free">dflt</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_fst_pair_pmf<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_pmf-Pi_pmf_subset'"><span class="command">lemma</span></span> Pi_pmf_subset'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> pmf"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> return_pmf <span class="free">dflt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">f</span> <span class="main">=</span> Pi_pmf <span class="free">B</span> <span class="free">dflt</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="main">(</span><span class="free">B</span> <span class="main">∪</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="free">dflt</span> <span class="free">f</span> <span class="main">=</span>
          map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="bound">g</span> <span class="bound">x</span><span class="main">)</span>
                  <span class="main">(</span>pair_pmf <span class="main">(</span>Pi_pmf <span class="free">B</span> <span class="free">dflt</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="free">dflt</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Pi_pmf_union<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="free">dflt</span> <span class="free">f</span> <span class="main">=</span> Pi_pmf <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> return_pmf <span class="free">dflt</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Pi_pmf_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">dflt</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="bound">g</span> <span class="bound">x</span><span class="main">)</span>
                  <span class="main">(</span>pair_pmf <span class="main">(</span>Pi_pmf <span class="free">B</span> <span class="free">dflt</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>return_pmf <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">dflt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">B</span> <span class="free">dflt</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_pmf_def pair_pmf_def bind_assoc_pmf bind_return_pmf bind_return_pmf'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Pi_pmf <span class="free">B</span> <span class="free">dflt</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Pi_pmf_default_swap<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∪</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_pmf-Pi_pmf_if_set"><span class="command">lemma</span></span> Pi_pmf_if_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">b</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">else</span> return_pmf <span class="free">dflt</span><span class="main">)</span> <span class="main">=</span>
           Pi_pmf <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">b</span> <span class="bound">x</span><span class="main">}</span> <span class="free">dflt</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">b</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">else</span> return_pmf <span class="free">dflt</span><span class="main">)</span> <span class="main">=</span>
          Pi_pmf <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">b</span> <span class="bound">x</span><span class="main">}</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">b</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">else</span> return_pmf <span class="free">dflt</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Pi_pmf_subset'<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Pi_pmf <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">b</span> <span class="bound">x</span><span class="main">}</span> <span class="free">dflt</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Pi_pmf_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pi_pmf-Pi_pmf_if_set'"><span class="command">lemma</span></span> Pi_pmf_if_set'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">b</span> <span class="bound">x</span> <span class="keyword1">then</span> return_pmf <span class="free">dflt</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span>
         Pi_pmf <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">¬</span><span class="free">b</span> <span class="bound">x</span><span class="main">}</span> <span class="free">dflt</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">b</span> <span class="bound">x</span> <span class="keyword1">then</span> return_pmf <span class="free">dflt</span> <span class="keyword1">else</span>  <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span>
          Pi_pmf <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">¬</span><span class="free">b</span> <span class="bound">x</span><span class="main">}</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">b</span> <span class="bound">x</span> <span class="keyword1">then</span> return_pmf <span class="free">dflt</span> <span class="keyword1">else</span>  <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Pi_pmf_subset'<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Pi_pmf <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">¬</span><span class="free">b</span> <span class="bound">x</span><span class="main">}</span> <span class="free">dflt</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Pi_pmf_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Lastly, we can delete a single component from a product:
›</span></span>
<span class="keyword1" id="Pi_pmf-Pi_pmf_remove"><span class="command">lemma</span></span> Pi_pmf_remove<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Pi_pmf <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">dflt</span> <span class="free">p</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">dflt</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">dflt</span> <span class="free">p</span> <span class="main">=</span>
          map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">xa</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">xa</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="bound">xa</span> <span class="keyword1">else</span> <span class="free">dflt</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Pi_pmf_subset<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">dflt</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_Pi_pmf_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">dflt</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_pmf_cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Applications›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Choosing a subset of a set uniformly at random is equivalent to tossing a fair coin
  independently for each element and collecting all the elements that came up heads.
›</span></span>
<span class="keyword1" id="Pi_pmf-pmf_of_set_Pow_conv_bernoulli"><span class="command">lemma</span></span> pmf_of_set_Pow_conv_bernoulli<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pmf_of_set <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pmf_of_set <span class="main">(</span>PiE_dflt <span class="free">A</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> UNIV<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_pmf_half_conv_pmf_of_set Pi_pmf_of_set<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">…</span> <span class="main">=</span> pmf_of_set <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>PiE_dflt <span class="free">A</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betwI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">B</span></span></span> <span class="bound"><span class="bound"><span class="bound">b</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">if</span></span></span> <span class="bound"><span class="bound"><span class="bound">b</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> <span class="free"><span class="free"><span class="free">A</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">then</span></span></span> <span class="bound"><span class="bound"><span class="bound">b</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> <span class="bound"><span class="bound"><span class="bound">B</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">else</span></span></span> <span class="free"><span class="free"><span class="free">P</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PiE_dflt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_pmf_of_set_bij_betw<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A binomial distribution can be seen as the number of successes in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> independent coin tosses.
›</span></span>
<span class="keyword1" id="Pi_pmf-binomial_pmf_altdef'"><span class="command">lemma</span></span> binomial_pmf_altdef'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"binomial_pmf <span class="free">n</span> <span class="free">p</span> <span class="main">=</span>
             map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> card <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> binomial_pmf <span class="main">(</span>card <span class="free">A</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">with</span></span> p <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_pmf_0<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> insert.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="skolem">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"binomial_pmf <span class="main">…</span> <span class="free">p</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                                     <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="free">p</span><span class="main">;</span>
                                     <span class="bound">f</span> <span class="main">←</span> Pi_pmf <span class="skolem">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">;</span>
                                     return_pmf <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">+</span> card <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>
                                   <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_pmf_Suc insert.IH bind_map_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="free">p</span><span class="main">;</span>
                      <span class="bound">f</span> <span class="main">←</span> Pi_pmf <span class="skolem">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">;</span>
                      return_pmf <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>
                    <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">b</span> <span class="skolem">f</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">+</span> card <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">}</span> <span class="main">=</span> card <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> card <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>
                      <span class="main">(</span>Pi_pmf <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_insert<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_pmf_def map_bind_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Misc">
<div class="head">
<h1>Theory Misc</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Misc.thy
  Authors: Max W. Haslbeck, Manuel Eberl
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary material›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Misc
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Analysis/Analysis.html">HOL-Analysis.Analysis</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Based on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sorted_list_of_set</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">the_inv_into</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> we construct a bijection between
  a finite set A of type 'a::linorder and a set of natural numbers <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{..&lt;</span></span> card <span class="free"><span class="free">A</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Misc-bij_betw_mono_on_the_inv_into"><span class="command">lemma</span></span> bij_betw_mono_on_the_inv_into<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">::</span>linorder set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_on <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_on <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> mono_on <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≤</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≥</span> the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="bound">r</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mono_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="skolem">s</span> <span class="main">&lt;</span> the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">using</span></span> that assms f_the_inv_into_f_bij_betw <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="skolem">s</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rs assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betw_def the_inv_into_into<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> rs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mono_onD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> m<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rs f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-rev_removeAll_removeAll_rev"><span class="command">lemma</span></span> rev_removeAll_removeAll_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span>removeAll <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> removeAll <span class="free">x</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> removeAll_filter_not_eq rev_filter<span class="main">)</span>

<span class="keyword1" id="Misc-sorted_list_of_set_Min_Cons"><span class="command">lemma</span></span> sorted_list_of_set_Min_Cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="free">A</span> <span class="main">=</span> Min <span class="free">A</span> <span class="main">#</span> sorted_list_of_set <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span>Min <span class="free">A</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> insert <span class="main">(</span>Min <span class="free">A</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Min_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="free">A</span> <span class="main">=</span> insort <span class="main">(</span>Min <span class="free">A</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span>Min <span class="free">A</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> sorted_list_of_set_insert<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Min <span class="free">A</span> <span class="main">#</span> sorted_list_of_set <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span>Min <span class="free">A</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> insort_is_Cons<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-sorted_list_of_set_filter"><span class="command">lemma</span></span> sorted_list_of_set_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> filter <span class="free">P</span> <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="free">A</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons sorted_list_of_set list.set_intros<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="skolem">A</span> <span class="main">=</span> Min <span class="skolem">A</span> <span class="main">#</span> sorted_list_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>Min <span class="skolem">A</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sorted_list_of_set_Min_Cons<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Min <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> Px<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> Min <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="main">#</span> sorted_list_of_set <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span>Min <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Px Cons 1 sorted_list_of_set_eq_Nil_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sorted_list_of_set_Min_Cons<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons 1 Px x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Min_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span><span class="main">}</span> <span class="main">=</span> filter <span class="free">P</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Cons<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> filter <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="main">(</span>sorted_list_of_set <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> filter <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Px <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> sorted_list_of_set <span class="skolem">A</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> Px<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">…</span> <span class="main">=</span> filter <span class="free">P</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Cons<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> filter <span class="free">P</span> <span class="main">(</span>sorted_list_of_set <span class="skolem">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 Px <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> sorted_list_of_set <span class="skolem">A</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> sorted_list_of_set_eq_Nil_iff <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1" id="Misc-sorted_list_of_set_Max_snoc"><span class="command">lemma</span></span> sorted_list_of_set_Max_snoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="free">A</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span>Max <span class="free">A</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>Max <span class="free">A</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> insert <span class="main">(</span>Max <span class="free">A</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Max_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="free">A</span> <span class="main">=</span> insort <span class="main">(</span>Max <span class="free">A</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span>Max <span class="free">A</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> sorted_list_of_set_insert<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span>Max <span class="free">A</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>Max <span class="free">A</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sorted_insort_is_snoc<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-sorted_list_of_set_image"><span class="command">lemma</span></span> sorted_list_of_set_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mono_on <span class="free">g</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">g</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map <span class="free">g</span> <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="free">A</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> sorted_list_of_set_eq_Nil_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> not_empty_A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons sorted_list_of_set_eq_Nil_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span>Min <span class="skolem">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span>Min <span class="skolem">A</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
        <span class="keyword1"><span class="command">using</span></span> that Cons Min_in Min_le not_empty_A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mono_onD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons not_empty_A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Min_eqI<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">`</span> <span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             Min <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">#</span> sorted_list_of_set <span class="main">(</span><span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>Min <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_Min_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>Min <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="free">g</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>Min <span class="skolem">A</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons Min_in not_empty_A * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> inj_on_image_set_diff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>Min <span class="skolem">A</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map <span class="free">g</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>Min <span class="skolem">A</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_empty_A Cons mono_on_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>Min <span class="skolem">A</span><span class="main">}</span>"</span></span><span class="main">]</span> inj_on_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>Min <span class="skolem">A</span><span class="main">}</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Cons<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_Min_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons not_empty_A * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_Min_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_image_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-sorted_list_of_set_length"><span class="command">lemma</span></span> sorted_list_of_set_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_card sorted_list_of_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Misc-sorted_list_of_set_bij_betw"><span class="command">lemma</span></span> sorted_list_of_set_bij_betw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> sorted_list_of_set <span class="free">A</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_nth<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sorted_list_of_set_length<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Misc-nth_mono_on"><span class="command">lemma</span></span> nth_mono_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_on <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mono_onI sorted_nth_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_card<span class="main">)</span>

<span class="keyword1" id="Misc-sorted_list_of_set_mono_on"><span class="command">lemma</span></span> sorted_list_of_set_mono_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> mono_on <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> sorted_list_of_set <span class="free">A</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_mono_on<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bij_mono_map_set_to_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bij_mono_map_set_to_nat</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> the_inv_into <span class="main">{..&lt;</span>card <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>sorted_list_of_set <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>
                  <span class="keyword1">else</span> card <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Misc-bij_mono_map_set_to_nat"><span class="command">lemma</span></span> bij_mono_map_set_to_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>bij_mono_map_set_to_nat <span class="free">A</span><span class="main">)</span> <span class="free">A</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"mono_on <span class="main">(</span>bij_mono_map_set_to_nat <span class="free">A</span><span class="main">)</span> <span class="free">A</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span>bij_mono_map_set_to_nat <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"bij_mono_map_set_to_nat <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>the_inv_into <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sorted_list_of_set_bij_betw  bij_betw_the_inv_into <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>the_inv_into <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span>
                     <span class="main">=</span> bij_betw <span class="var">?f</span> <span class="free">A</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_mono_map_set_to_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_cong<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>bij_mono_map_set_to_nat <span class="free">A</span><span class="main">)</span> <span class="free">A</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mono_on <span class="main">(</span>the_inv_into <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sorted_list_of_set_bij_betw
      sorted_list_of_set_mono_on <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bij_betw_mono_on_the_inv_into<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mono_on <span class="main">(</span>bij_mono_map_set_to_nat <span class="free">A</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_mono_map_set_to_nat_def <span class="keyword1"><span class="command">using</span></span> mono_onD <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mono_onI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms bij_betw_imp_surj_on * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Geometric_PMF">
<div class="head">
<h1>Theory Geometric_PMF</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Pi_pmf.thy
  Authors: Manuel Eberl, Max W. Haslbeck
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Theorems about the Geometric Distribution›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Geometric_PMF
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span>
    <a href="#Pi_pmf">Pi_pmf</a>
    <span class="quoted">"<a href="../../monad_normalisation/theories/#Monad_Normalisation">Monad_Normalisation.Monad_Normalisation</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Geometric_PMF-nn_integral_geometric_pmf"><span class="command">lemma</span></span> nn_integral_geometric_pmf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"nn_integral <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span> real <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">/</span> <span class="free">p</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms expectation_geometric_pmf integrable_real_geometric_pmf
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_eq_integral<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Geometric_PMF-geometric_pmf_prob_atMost"><span class="command">lemma</span></span> geometric_pmf_prob_atMost<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span> <span class="main">{..</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf_conv_infsetsum<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Geometric_PMF-geometric_pmf_prob_lessThan"><span class="command">lemma</span></span> geometric_pmf_prob_lessThan<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf_conv_infsetsum<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Geometric_PMF-geometric_pmf_prob_greaterThan"><span class="command">lemma</span></span> geometric_pmf_prob_greaterThan<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span> <span class="main">{</span><span class="free">n</span><span class="main">&lt;..}</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">n</span><span class="main">&lt;..}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measure_pmf.finite_measure_Diff<span class="main">)</span>
                   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> geometric_pmf_prob_atMost<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Geometric_PMF-geometric_pmf_prob_atLeast"><span class="command">lemma</span></span> geometric_pmf_prob_atLeast<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span> <span class="main">{</span><span class="free">n</span><span class="main">..}</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">n</span><span class="main">..}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measure_pmf.finite_measure_Diff<span class="main">)</span>
                   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> geometric_pmf_prob_lessThan<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Geometric_PMF-bernoulli_pmf_of_set'"><span class="command">lemma</span></span> bernoulli_pmf_of_set'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pmf_of_set <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> pmf_of_set <span class="main">(</span>UNIV <span class="main">::</span> bool set<span class="main">)</span><span class="main">)</span> <span class="main">=</span> pmf_of_set <span class="main">(</span>PiE_dflt <span class="free">A</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> UNIV <span class="main">::</span> bool set<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Pi_pmf_of_set<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> pmf_of_set UNIV<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bernoulli_pmf_half_conv_pmf_of_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>pmf_of_set <span class="main">(</span>PiE_dflt <span class="free">A</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_of_set<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf_of_set <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>PiE_dflt <span class="free">A</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betwI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">B</span></span></span> <span class="bound"><span class="bound"><span class="bound">b</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">if</span></span></span> <span class="bound"><span class="bound"><span class="bound">b</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> <span class="free"><span class="free"><span class="free">A</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">then</span></span></span> <span class="main"><span class="main"><span class="main">¬</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">b</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> <span class="bound"><span class="bound"><span class="bound">B</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">else</span></span></span> <span class="free"><span class="free"><span class="free">P</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PiE_dflt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_pmf_of_set_bij_betw<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Geometric_PMF-Pi_pmf_pmf_of_set_Suc"><span class="command">lemma</span></span> Pi_pmf_pmf_of_set_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> geometric_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">B</span> <span class="main">←</span> pmf_of_set <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span><span class="main">;</span>
         Pi_pmf <span class="bound">B</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> geometric_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        Pi_pmf <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">⤜</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> return_pmf <span class="main">0</span> <span class="keyword1">else</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> geometric_bind_pmf_unfold<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
             Pi_pmf <span class="free">A</span> False <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> Pi_pmf <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="bound">x</span> <span class="keyword1">then</span> return_pmf <span class="main">0</span> <span class="keyword1">else</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_bind<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">False</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
             <span class="keyword1">do</span> <span class="main">{</span><span class="bound">b</span> <span class="main">←</span> Pi_pmf <span class="free">A</span> False <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                 Pi_pmf <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">~</span><span class="bound">b</span> <span class="bound">x</span><span class="main">}</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_if_set'<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
             <span class="keyword1">do</span> <span class="main">{</span><span class="bound">B</span> <span class="main">←</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> False <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                 Pi_pmf <span class="bound">B</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_pmf_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_assoc_pmf<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_return_pmf<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf_of_set <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">B</span><span class="main">.</span> Pi_pmf <span class="bound">B</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bernoulli_pmf_of_set'<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Geometric_PMF-Pi_pmf_pmf_of_set_Suc'"><span class="command">lemma</span></span> Pi_pmf_pmf_of_set_Suc'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> geometric_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">B</span> <span class="main">←</span> pmf_of_set <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span><span class="main">;</span>
         Pi_pmf <span class="bound">B</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> geometric_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        Pi_pmf <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">⤜</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> return_pmf <span class="main">0</span> <span class="keyword1">else</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> geometric_bind_pmf_unfold<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
             Pi_pmf <span class="free">A</span> False <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> Pi_pmf <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="bound">x</span> <span class="keyword1">then</span> return_pmf <span class="main">0</span> <span class="keyword1">else</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_bind<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">False</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
             <span class="keyword1">do</span> <span class="main">{</span><span class="bound">b</span> <span class="main">←</span> Pi_pmf <span class="free">A</span> False <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                 Pi_pmf <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">~</span><span class="bound">b</span> <span class="bound">x</span><span class="main">}</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_if_set'<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
             <span class="keyword1">do</span> <span class="main">{</span><span class="bound">B</span> <span class="main">←</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> False <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                 Pi_pmf <span class="bound">B</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_pmf_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_assoc_pmf bind_return_pmf<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf_of_set <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">B</span><span class="main">.</span> Pi_pmf <span class="bound">B</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bernoulli_pmf_of_set'<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Geometric_PMF-binomial_pmf_altdef'"><span class="command">lemma</span></span> binomial_pmf_altdef'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"binomial_pmf <span class="free">n</span> <span class="free">p</span> <span class="main">=</span>
             map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> card <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> binomial_pmf <span class="main">(</span>card <span class="free">A</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">with</span></span> p <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_pmf_0<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> insert.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="skolem">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"binomial_pmf <span class="main">…</span> <span class="free">p</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                                     <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="free">p</span><span class="main">;</span>
                                     <span class="bound">f</span> <span class="main">←</span> Pi_pmf <span class="skolem">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">;</span>
                                     return_pmf <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">+</span> card <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>
                                   <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_pmf_Suc insert.IH bind_map_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="free">p</span><span class="main">;</span>
                      <span class="bound">f</span> <span class="main">←</span> Pi_pmf <span class="skolem">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">;</span>
                      return_pmf <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>
                    <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">b</span> <span class="skolem">f</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">+</span> card <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">}</span> <span class="main">=</span> card <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> card <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>
                      <span class="main">(</span>Pi_pmf <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_insert<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_pmf_def map_bind_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Geometric_PMF-bernoulli_pmf_Not"><span class="command">lemma</span></span> bernoulli_pmf_Not<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bernoulli_pmf <span class="free">p</span> <span class="main">=</span> map_pmf Not <span class="main">(</span>bernoulli_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Not <span class="main">-`</span> <span class="main">{</span>True<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>False<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Not <span class="main">-`</span> <span class="main">{</span>False<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span> <span class="skolem">b</span> <span class="main">=</span> pmf <span class="main">(</span>map_pmf Not <span class="main">(</span>bernoulli_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_map * measure_pmf_single<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pmf_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Geometric_PMF-binomial_pmf_altdef''"><span class="command">lemma</span></span> binomial_pmf_altdef''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"binomial_pmf <span class="free">n</span> <span class="free">p</span> <span class="main">=</span>
           map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> binomial_pmf_altdef'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{..&lt;</span></span></span><span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> monad_normalisation
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Geometric_PMF-Pi_pmf_geometric_filter"><span class="command">lemma</span></span> Pi_pmf_geometric_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> geometric_pmf <span class="free">p</span><span class="main">)</span> <span class="main">=</span>
       <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">fb</span> <span class="main">←</span> Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">;</span>
         Pi_pmf <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">fb</span> <span class="bound">x</span><span class="main">}</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> geometric_pmf <span class="free">p</span><span class="main">)</span> <span class="main">=</span>
        Pi_pmf <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span> <span class="main">⤜</span>
                   <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> return_pmf <span class="main">0</span> <span class="keyword1">else</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> geometric_bind_pmf_unfold<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
             Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span> <span class="main">⤜</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> Pi_pmf <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="bound">x</span> <span class="keyword1">then</span> return_pmf <span class="main">0</span> <span class="keyword1">else</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_bind<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">dflt</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
             <span class="keyword1">do</span> <span class="main">{</span><span class="bound">b</span> <span class="main">←</span> Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">;</span>
                 Pi_pmf <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">}</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_if_set'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Geometric_PMF-Pi_pmf_geometric_filter'"><span class="command">lemma</span></span> Pi_pmf_geometric_filter'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> geometric_pmf <span class="free">p</span><span class="main">)</span> <span class="main">=</span>
       <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">fb</span> <span class="main">←</span> Pi_pmf <span class="free">A</span> <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
         Pi_pmf <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">fb</span> <span class="bound">x</span><span class="main">}</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pi_pmf_geometric_filter<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">dflt</span>"</span></span><span class="main"><span class="main">]</span></span> bernoulli_pmf_Not<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">]</span></span>
      Pi_pmf_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">dflt</span></span><span class="main"><span class="main">]</span></span> map_pmf_def<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(∘)</span> Not<span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Skip_List">
<div class="head">
<h1>Theory Skip_List</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Skip_List.thy
  Authors: Max W. Haslbeck, Manuel Eberl
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Randomized Skip Lists›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Skip_List
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Geometric_PMF">Geometric_PMF</a>
          <a href="#Misc">Misc</a>
          <span class="quoted">"<a href="../../monad_normalisation/theories/#Monad_Normalisation">Monad_Normalisation.Monad_Normalisation</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1" id="Skip_List-bind_pmf_if'"><span class="command">lemma</span></span> bind_pmf_if'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span><span class="bound">c</span> <span class="main">←</span> <span class="free">C</span><span class="main">;</span>
                         <span class="bound">ab</span> <span class="main">←</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c</span> <span class="keyword1">then</span> <span class="free">A</span> <span class="keyword1">else</span> <span class="free">B</span><span class="main">)</span><span class="main">;</span>
                         <span class="free">D</span> <span class="bound">ab</span><span class="main">}</span><span class="main">::</span><span class="tfree">'a</span> pmf<span class="main">)</span> <span class="main">=</span>
                     <span class="keyword1">do</span> <span class="main">{</span><span class="bound">c</span> <span class="main">←</span> <span class="free">C</span><span class="main">;</span>
                         <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">A</span> <span class="main">⤜</span> <span class="free">D</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">B</span> <span class="main">⤜</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">Max<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Max<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> Max <span class="main">(</span><span class="bound">A</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of a Randomised Skip List›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given a set A we assign a geometric random variable (counting the number of failed Bernoulli
  trials before the first success) to every element in A. That means an arbitrary element of A is
  on level n with probability $(1-p)^{n}p$. We define he height of the skip list as the maximum
  assigned level. So a skip list with only one level has height 0 but the calculation of the
  expected height is cleaner this way.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> random_skip_list <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span><span class="quoted">real</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">q</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">p</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span> pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SL</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> Pi_pmf <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> geometric_pmf <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SL<span class="hidden">⇩</span><sub>N</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SL<span class="hidden">⇩</span><sub>N</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> SL <span class="main">{..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Height of Skip List›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">H</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>SL <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">H<span class="hidden">⇩</span><sub>N</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">H<span class="hidden">⇩</span><sub>N</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> H <span class="main">{..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> monad_normalisation
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The height of a skip list is independent of the values in a set A. For simplicity we can
  therefore work on the skip list over the set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{..&lt;</span></span> card <span class="free"><span class="free">A</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"H <span class="free">A</span> <span class="main">=</span> H<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span>card <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span>
                             <span class="keyword1">then</span> the_inv_into <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>
                             <span class="keyword1">else</span> card <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> bij_f'<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f'</span> <span class="free">A</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="comment1">(* I know the proof looks weird, but for some reason all tools have problems with this proof *)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>the_inv_into <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f'_def <span class="keyword1"><span class="command">using</span></span> sorted_list_of_set_bij_betw assms bij_betw_the_inv_into <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>the_inv_into <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span>
                     <span class="main">=</span> bij_betw <span class="skolem">f'</span> <span class="free">A</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_cong<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="main">(</span><span class="skolem">f</span> <span class="main">∘</span> <span class="skolem">f'</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  bij_betw_imp_surj_on bij_f' image_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H <span class="free">A</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∘</span> <span class="skolem">f'</span><span class="main">)</span> <span class="main">(</span>SL<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span>card <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms bij_f' <span class="keyword1"><span class="command">unfolding</span></span> H_def SL_def SL<span class="hidden">⇩</span><sub>N</sub>_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_bij_betw<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">f'</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{..&lt;</span></span></span>card <span class="free"><span class="free"><span class="free">A</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  H<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span>card <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> H<span class="hidden">⇩</span><sub>N</sub>_def H_def SL<span class="hidden">⇩</span><sub>N</sub>_def <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pmf_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_pmf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The cumulative distribution function (CDF) of the height is the CDF of the geometric PMF to the
  power of n
›</span></span>

<span class="keyword1" id="Skip_List-prob_Max_IID_geometric_atMost"><span class="command">lemma</span></span> prob_Max_IID_geometric_atMost<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> <span class="main">{..</span><span class="free">i</span><span class="main">}</span>
       <span class="main">=</span> <span class="main">(</span>measure_pmf.prob <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span> <span class="main">{..</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> SL_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> SL<span class="hidden">⇩</span><sub>N</sub>_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> H_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> H<span class="hidden">⇩</span><sub>N</sub>_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span><span class="main">.</span> Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="free">i</span><span class="main">}</span>  <span class="main">=</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">→</span> <span class="main">{..</span><span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> measure_pmf.prob <span class="main">(</span>SL<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">→</span> <span class="main">{..</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> measure_pmf.prob <span class="main">(</span>SL<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PiE_dflt <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{..</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measure_prob_cong_0<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PiE_dflt_def pmf_Pi <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> measure_pmf.prob <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span> <span class="main">{..</span><span class="free">i</span><span class="main">}</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_Pi_pmf_PiE_dflt<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Skip_List-prob_Max_IID_geometric_greaterThan"><span class="command">lemma</span></span> prob_Max_IID_geometric_greaterThan<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> <span class="main">{</span><span class="free">i</span><span class="main">&lt;..}</span> <span class="main">=</span>
         <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> q <span class="main">^</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">-</span> <span class="main">{..</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">&lt;..}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> <span class="main">{</span><span class="free">i</span><span class="main">&lt;..}</span> <span class="main">=</span> measure_pmf.prob <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>space <span class="main">(</span>measure_pmf <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{..</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span>measure_pmf.prob <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span> <span class="main">{..</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measure_pmf.prob_compl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prob_Max_IID_geometric_atMost<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>   <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> q <span class="main">^</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> geometric_pmf_prob_atMost<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context includes monad_normalisation *)</span>
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* locale skip_list *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An alternative definition of the expected value of a non-negative random variable
  \footnote{\url{https://en.wikipedia.org/w/index.php?title=Expected\_value&amp;oldid=881384346\#Formula\_for\_non-negative\_random\_variables}}
›</span></span>

<span class="keyword1" id="Skip_List-expectation_prob_atLeast"><span class="command">lemma</span></span> expectation_prob_atLeast<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> measure_pmf.prob <span class="free">N</span> <span class="main">{</span><span class="bound">i</span><span class="main">..}</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="main">1</span><span class="main">..}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">N</span> real <span class="main">=</span> infsetsum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> measure_pmf.prob <span class="free">N</span> <span class="main">{</span><span class="bound">i</span><span class="main">..}</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..}</span>"</span></span>
    <span class="quoted"><span class="quoted">"integrable <span class="free">N</span> real"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> pmf <span class="free">N</span> <span class="bound">y</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> Sigma <span class="main">{</span>Suc <span class="main">0</span><span class="main">..}</span> atLeast"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf_conv_infsetsum abs_summable_on_Sigma_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> summable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> pmf <span class="free">N</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> Sigma <span class="main">{</span>Suc <span class="main">0</span><span class="main">..}</span> <span class="main">(</span>atLeastAtMost <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> abs_summable_on_reindex_bij_betw<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bij_betw_imageI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def case_prod_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">N</span> real <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">N</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> real <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infsetsum_def integral_density measure_pmf_eq_density<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>Suc <span class="main">0</span><span class="main">..}</span><span class="main">)</span><span class="main">.</span> pmf <span class="free">N</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> real <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> infsetsum_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>Suc <span class="main">0</span><span class="main">..}</span><span class="main">.</span> pmf <span class="free">N</span> <span class="bound">x</span> <span class="main">*</span> real <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">N</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> real <span class="bound">x</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>Suc <span class="main">0</span><span class="main">..}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> summable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> abs_summable_on_Sigma_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_Un_Int<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>Sigma <span class="main">{</span>Suc <span class="main">0</span><span class="main">..}</span> <span class="main">(</span>atLeastAtMost <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> pmf <span class="free">N</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> summable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_Sigma<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">x</span><span class="main">∈</span>Sigma <span class="main">{</span>Suc <span class="main">0</span><span class="main">..}</span> atLeast<span class="main">.</span> pmf <span class="free">N</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_reindex_bij_betw<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bij_betw_imageI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def case_prod_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> infsetsum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> measure_pmf.prob <span class="free">N</span> <span class="main">{</span><span class="bound">i</span><span class="main">..}</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_Sigma<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf_conv_infsetsum abs_summable_on_Sigma_iff infsetsum_Sigma'<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">N</span> real <span class="main">=</span> infsetsum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> measure_pmf.prob <span class="free">N</span> <span class="main">{</span><span class="bound">i</span><span class="main">..}</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">N</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> real <span class="bound">x</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>Suc <span class="main">0</span><span class="main">..}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> summable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> abs_summable_on_Sigma_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">N</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> real <span class="bound">x</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeast_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">N</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> real <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> abs_summable_on_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">N</span> real"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measure_pmf_eq_density<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> integrable_density<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The expected height of a skip list has no closed-form expression but we can approximate it. We
  start by showing how we can calculate an infinite sum over the natural numbers with an integral
  over the positive reals and the floor function.
›</span></span>

<span class="keyword1" id="Skip_List-infsetsum_set_nn_integral_reals"><span class="command">lemma</span></span> infsetsum_set_nn_integral_reals<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">abs_summable_on</span> UNIV"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infsetsum <span class="free">f</span> UNIV <span class="main">=</span> set_nn_integral lborel <span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">(</span>floor <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span>floor <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">real</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> real <span class="bound">n</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">+</span> real <span class="bound">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that of_nat_floor <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"nat <span class="main"><span class="main"><span class="main">(</span></span></span>floor <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="main">{</span>real <span class="bound">n</span><span class="main">..&lt;</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..}</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main">∂</span>lborel <span class="main">=</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>real <span class="bound">n</span><span class="main">..&lt;</span><span class="main">1</span> <span class="main">+</span> real <span class="bound">n</span><span class="main">}</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_family_on_def nn_integral_disjoint_family<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>real <span class="bound">n</span><span class="main">..&lt;</span><span class="main">1</span> <span class="main">+</span> real <span class="bound">n</span><span class="main">}</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span><span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> suminf_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> nn_integral_cong_AE<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventuallyI  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indicator_def floor_eq4<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> suminf_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_cmult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> infsetsum <span class="free">f</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms suminf_ennreal2 abs_summable_on_nat_iff' summable_norm_cancel
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infsetsum_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Skip_List-nn_integral_nats_reals"><span class="command">lemma</span></span> nn_integral_nats_reals<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">i</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..}</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main">∂</span>lborel"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span>floor <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">real</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> real <span class="bound">n</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">+</span> real <span class="bound">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that of_nat_floor <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"nat <span class="main"><span class="main"><span class="main">(</span></span></span>floor <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="main">{</span>real <span class="bound">n</span><span class="main">..&lt;</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..}</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">∂</span>lborel <span class="main">=</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>real <span class="bound">n</span><span class="main">..&lt;</span><span class="main">1</span> <span class="main">+</span> real <span class="bound">n</span><span class="main">}</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_family_on_def nn_integral_disjoint_family<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>real <span class="bound">n</span><span class="main">..&lt;</span><span class="main">1</span> <span class="main">+</span> real <span class="bound">n</span><span class="main">}</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span><span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> suminf_cong<span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> nn_integral_cong_AE<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventuallyI  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indicator_def floor_eq4<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> suminf_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_cmult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">i</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_count_space_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Skip_List-nn_integral_floor_less_eq"><span class="command">lemma</span></span> nn_integral_floor_less_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..}</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">∂</span>lborel <span class="main">≤</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..}</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main">∂</span>lborel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indicator_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_mono ennreal_leI<span class="main">)</span>

<span class="keyword1" id="Skip_List-nn_integral_finite_imp_abs_sumable_on"><span class="command">lemma</span></span> nn_integral_finite_imp_abs_sumable_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>banach<span class="main">,</span> second_countable_topology<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nn_integral <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">∞</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">abs_summable_on</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> abs_summable_on_def integrable_iff_bounded <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Skip_List-nn_integral_finite_imp_abs_sumable_on'"><span class="command">lemma</span></span> nn_integral_finite_imp_abs_sumable_on'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nn_integral <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">∞</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">abs_summable_on</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> abs_summable_on_def integrable_iff_bounded <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now show that $\int_0^\infty 1 - (1 - q^x) ^ n\;dx = \frac{- H_n}{\ln q}$ if $0 &lt; q &lt; 1$.
›</span></span>

<span class="keyword1" id="Skip_List-harm_integral_x_raised_n"><span class="command">lemma</span></span> harm_integral_x_raised_n<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?thesis1</span></span></span><span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">LBINT</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> harm <span class="free">n</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?thesis2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> borel_integrable_atLeastAtMost'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis1</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> borel_integrable_atLeastAtMost'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis2</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LBINT</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">.</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword1">LBINT</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">LBINT</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">(</span>einterval <span class="main">0</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_integrable_subset<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> h <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> einterval_def›</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">(</span>einterval <span class="main">0</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> borel_integrable_atLeastAtMost'<span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> borel_integrable_atLeastAtMost' <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_integrable_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> einterval_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> borel_integrable_atLeastAtMost' <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  interval_lebesgue_integrable_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LBINT</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> real <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LBINT</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">LBINT</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> indicator <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="bound">x</span> "</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> lborel<span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> indicator <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="bound">x</span> <span class="main">=</span> indicator <span class="main">(</span>einterval <span class="main">0</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_conj<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  AE_lborel_singleton<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span>
                  AE_lborel_singleton<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indicator_def einterval_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> integral_cong_AE <span class="keyword1"><span class="command">unfolding</span></span> interval_lebesgue_integral_def set_lebesgue_integral_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integral_cong_AE<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> integral_power<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> harm_def inverse_eq_divide<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> harm_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Skip_List-harm_integral_0_1_fraction"><span class="command">lemma</span></span> harm_integral_0_1_fraction<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LBINT</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> harm <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="keyword1">in</span> lborel<span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">(^)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> AE_lborel_singleton<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_gp_strict<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> harm_integral_x_raised_n <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> set_integrable_cong_AE<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span> <span class="keyword1">in</span> lborel<span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">(^)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_gp_strict<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"einterval <span class="main">(</span>min <span class="main">0</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>max <span class="main">0</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def max_def einterval_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LBINT</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> harm <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> harm_integral_x_raised_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> interval_integral_cong_AE<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Skip_List-one_minus_one_minus_q_x_n_integral"><span class="command">lemma</span></span> one_minus_one_minus_q_x_n_integral<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">(</span>einterval <span class="main">0</span> <span class="main">∞</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">q</span> <span class="keyword1">powr</span> <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LBINT</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="main">∞</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">q</span> <span class="keyword1">powr</span> <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">powr</span> <span class="main">(</span>log <span class="free">q</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> powr_log_cancel<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>ereal <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> log <span class="free">q</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> real_of_ereal<span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_right <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> zero_ereal_def ereal_tendsto_simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>ereal <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> log <span class="free">q</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> real_of_ereal<span class="main">)</span> <span class="main">⤏</span> <span class="main">∞</span><span class="main">)</span> <span class="main">(</span>at_left <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="main">(</span><span class="main">(-)</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>at_right <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_left <span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> filterlim_at_withinI eventually_at_leftI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LIM</span> <span class="bound">x</span> at_left <span class="main">1</span><span class="main">.</span> <span class="main">-</span> inverse <span class="main">(</span>ln <span class="free">q</span><span class="main">)</span> <span class="main">*</span> <span class="main">-</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">:&gt;</span> at_top"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> filterlim_tendsto_pos_mult_at_top <span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_const<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filterlim_uminus_at_top <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filterlim_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ln_at_0<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> one_ereal_def ereal_tendsto_simps log_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">(</span>einterval <span class="main">0</span> <span class="main">1</span><span class="main">)</span>
     <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">q</span> <span class="keyword1">powr</span> <span class="main">(</span>log <span class="free">q</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>ln <span class="free">q</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">(</span>einterval <span class="main">0</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="free">q</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> set_integrable_mult_right<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> harm_integral_0_1_fraction <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> set_integrable_subset <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> einterval_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> set_integrable_cong_AE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span> <span class="main"><span class="main"><span class="main">/</span></span></span> ln <span class="free"><span class="free"><span class="free">q</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="main"><span class="main"><span class="main">^</span></span></span> <span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">/</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventuallyI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> einterval_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LBINT</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">q</span> <span class="keyword1">powr</span> log <span class="free">q</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>ln <span class="free">q</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span>harm <span class="free">n</span> <span class="main">/</span> ln <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="keyword1">LBINT</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span> <span class="main">/</span> ln <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> interval_integral_cong_AE<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventuallyI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def einterval_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> harm <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">/</span> ln <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> harm_integral_0_1_fraction <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> interval_lebesgue_integral_mult_left<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">note</span></span> sub <span class="main">=</span> interval_integral_substitution_nonneg
             <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">1</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">1</span></span> <span class="main"><span class="main">-</span></span> <span class="free"><span class="free">q</span></span> <span class="keyword1"><span class="keyword1">powr</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">^</span></span> <span class="free"><span class="free">n</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> log <span class="free"><span class="free">q</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">-</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
                    <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> g'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">/</span></span> <span class="main"><span class="main">(</span></span>ln <span class="free"><span class="free">q</span></span> <span class="main"><span class="main">*</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">1</span></span> <span class="main"><span class="main">-</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> a <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">(</span>einterval <span class="main">0</span> <span class="main">∞</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">q</span> <span class="keyword1">powr</span> <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms 1 2 3 4
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sub<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> mult_nonneg_nonpos2 <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> power_le_one<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LBINT</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="main">∞</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">q</span> <span class="keyword1">powr</span> <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms 1 2 3 4
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sub<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> mult_nonneg_nonpos2 <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> power_le_one<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Skip_List-one_minus_one_minus_q_x_n_nn_integral"><span class="command">lemma</span></span> one_minus_one_minus_q_x_n_nn_integral<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_nn_integral lborel <span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">q</span> <span class="keyword1">powr</span> <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="keyword1">LBINT</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="main">∞</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">q</span> <span class="keyword1">powr</span> <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_nn_integral  lborel <span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">q</span> <span class="keyword1">powr</span> <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        nn_integral lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> indicator <span class="main">(</span>einterval <span class="main">0</span> <span class="main">∞</span><span class="main">)</span> <span class="bound">x</span> <span class="main">*</span>  <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">q</span> <span class="keyword1">powr</span> <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong_AE eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> AE_lborel_singleton<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indicator_def einterval_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="keyword1">LBINT</span> <span class="bound">x</span><span class="main">.</span> indicator <span class="main">(</span>einterval <span class="main">0</span> <span class="main">∞</span><span class="main">)</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">q</span> <span class="keyword1">powr</span> <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> one_minus_one_minus_q_x_n_integral assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> nn_integral_eq_integral<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indicator_def einterval_def set_integrable_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventuallyI power_le_one powr_le1<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interval_lebesgue_integral_def set_lebesgue_integral_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can now derive bounds for the expected height.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> random_skip_list
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EH<span class="hidden">⇩</span><sub>N</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EH<span class="hidden">⇩</span><sub>N</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> measure_pmf.expectation <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> real"</span></span>

<span class="keyword1" id="Skip_List-EH"><span class="command">lemma</span></span> EH<span class="hidden">⇩</span><sub>N</sub>_bounds'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span>"</span></span>
     <span class="quoted"><span class="quoted">"EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">≤</span> <span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q"</span></span>
     <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> real"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> q <span class="main">^</span> <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> q <span class="keyword1">powr</span> <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"q <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> f_descending<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">using</span></span> that q
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> power_mono <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_decreasing power_le_one_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f'_descending<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">f'</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">unfolding</span></span> f'_def <span class="keyword1"><span class="command">using</span></span> that q
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> power_mono <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ln_powr powr_def mult_nonneg_nonpos<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"harm <span class="free">n</span> <span class="main">/</span> ln q <span class="main">&lt;=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> harm_nonneg ln_ge_zero_imp_ge_one q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_nonneg_neg<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> f_nn_integral_harm<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q <span class="main">≤</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..}</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nn_integral_nats_reals <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..}</span><span class="main">.</span> ennreal <span class="main">(</span><span class="skolem">f'</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">∂</span>lborel"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> q <span class="main">*</span> q <span class="main">^</span> nat <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> q <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> real_of_int <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">real</span>
        <span class="keyword1"><span class="command">using</span></span> q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> powr_realpow <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> powr_add<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> f_def f'_def <span class="keyword1"><span class="command">using</span></span> q
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong ennreal_cong  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_real_of_int indicator_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> set_nn_integral lborel <span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="skolem">f'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> real_of_int <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indicator_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> f'_descending nn_integral_mono ennreal_leI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> harm_integral_f'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f'_def <span class="keyword1"><span class="command">using</span></span> q
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ennreal_cong
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_minus_one_minus_q_x_n_nn_integral one_minus_one_minus_q_x_n_integral<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> harm_integral_f'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_nn_integral lborel <span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="skolem">f'</span> <span class="main">≤</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..}</span><span class="main">.</span> <span class="skolem">f'</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">∂</span>lborel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms f'_descending
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indicator_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_mono ennreal_leI<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..}</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">∂</span>lborel"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f_def f'_def
      <span class="keyword1"><span class="command">using</span></span> q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong ennreal_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_real_of_int indicator_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nn_integral_nats_reals <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q <span class="main">≤</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">∂</span>count_space UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f1_abs_summable_on<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">using</span></span> q
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_finite_imp_abs_sumable_on'<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def le_less_trans <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> power_le_one mult_le_one<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f_abs_summable_on<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="main">1</span><span class="main">..}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc_le_lessD greaterThan_0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> abs_summable_on_reindex_bij_betw<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"UNIV"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="main">1</span><span class="main">..}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure_pmf.prob <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">..}</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="main">1</span><span class="main">..}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure_pmf.prob <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">..}</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="main">1</span><span class="main">..}</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure_pmf.prob <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">&lt;..}</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="main">1</span><span class="main">..}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measure_prob_cong_0 abs_summable_on_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="main">1</span><span class="main">..}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_summable_on_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def prob_Max_IID_geometric_greaterThan<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> EH<span class="hidden">⇩</span><sub>N</sub>_sum<span class="main">:</span>
    <span class="quoted"><span class="quoted">"EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..}</span><span class="main">.</span> measure_pmf.prob <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> <span class="main">{</span><span class="bound">i</span><span class="main">..}</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>measure_pmf <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span><span class="main">)</span> real"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> EH<span class="hidden">⇩</span><sub>N</sub>_def <span class="keyword1"><span class="command">using</span></span> expectation_prob_atLeast <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>measure_pmf <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span><span class="main">)</span> real"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> EH<span class="hidden">⇩</span><sub>N</sub>_sum'<span class="main">:</span> <span class="quoted"><span class="quoted">"EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">=</span> infsetsum <span class="skolem">f</span> <span class="main">{</span><span class="main">1</span><span class="main">..}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..}</span><span class="main">.</span> measure_pmf.prob <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> <span class="main">{</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">&lt;..}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> EH<span class="hidden">⇩</span><sub>N</sub>_sum <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measure_prob_cong_0 infsetsum_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> infsetsum <span class="skolem">f</span> <span class="main">{</span><span class="main">1</span><span class="main">..}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def prob_Max_IID_geometric_greaterThan<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">k</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc_le_lessD greaterThan_0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_reindex_bij_betw<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"UNIV"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..}</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f1_abs_summable_on q
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_set_nn_integral_reals<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def mult_le_one power_le_one<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nn_integral_nats_reals <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f_nn_integral_harm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">≤</span> <span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ennreal_le_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>Suc <span class="main">0</span><span class="main">..}</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> EH<span class="hidden">⇩</span><sub>N</sub>_sum'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> infsetsum <span class="skolem">f</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f_abs_summable_on <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_Un_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> infsetsum_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..}</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">abs_summable_on</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">1</span><span class="main">..}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f_abs_summable_on <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_summable_on_union<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">::</span>nat<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">1</span><span class="main">..}</span> <span class="main">=</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> q
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_set_nn_integral_reals<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def mult_le_one power_le_one<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nn_integral_nats_reals <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≥</span> <span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f_nn_integral_harm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q <span class="main">≤</span> EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ennreal_le_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EH<span class="hidden">⇩</span><sub>N</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> EH<span class="hidden">⇩</span><sub>N</sub>_bounds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">≤</span> <span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q"</span></span>
    <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> real"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms EH<span class="hidden">⇩</span><sub>N</sub>_bounds'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EH<span class="hidden">⇩</span><sub>N</sub>_def H<span class="hidden">⇩</span><sub>N</sub>_def H_def SL_def harm_expand<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">≤</span> <span class="main">-</span> harm <span class="free">n</span> <span class="main">/</span> ln q"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms EH<span class="hidden">⇩</span><sub>N</sub>_bounds'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EH<span class="hidden">⇩</span><sub>N</sub>_def H<span class="hidden">⇩</span><sub>N</sub>_def H_def SL_def harm_expand<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> real"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms EH<span class="hidden">⇩</span><sub>N</sub>_bounds'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H<span class="hidden">⇩</span><sub>N</sub>_def H_def SL_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integrable_measure_pmf_finite<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context random_skip_list *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Expected Length of Search Path›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'a</span></span><span class="main"><span class="main">::</span></span>linorder set"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'a</span></span> <span class="main"><span class="main">⇒</span></span> nat"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where f is an abstract description
  of a skip list (assign each value its maximum level). steps A f s u l starts on the rightmost element
  on level s in the skip lists. If possible it moves up, if not it moves to the left. For every step
  up it adds cost u and for every step to the left it adds cost l. steps A f 0 1 1 therefore walks
  from the bottom right corner of a skip list to the top left corner of a skip list and counts
  all steps.
›</span></span>

<span class="comment1">― ‹NOTE: You could also define steps with lsteps and then prove that the following recursive
    definition holds›</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">steps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">steps</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> infinite <span class="free"><span class="bound"><span class="entity">A</span></span></span>
              <span class="keyword1">then</span> <span class="main">0</span>
              <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> Max <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span>       <span class="free">steps</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="bound">m</span><span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="free"><span class="bound"><span class="entity">left</span></span></span>
                                      <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">m</span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="main">+</span> <span class="free">steps</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="free"><span class="bound"><span class="entity">left</span></span></span>
                                      <span class="keyword1">else</span>                  <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">+</span> <span class="free">steps</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="bound">m</span><span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="free"><span class="bound"><span class="entity">left</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span><span class="bound">f</span><span class="main">,</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> card <span class="bound">A</span><span class="main">)</span> <span class="keyword1">&lt;*mlex*&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span><span class="bound">f</span><span class="main">,</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> Max <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> <span class="bound">A</span><span class="main">)</span> <span class="main">-</span> <span class="bound">l</span><span class="main">)</span> <span class="keyword1">&lt;*mlex*&gt;</span> <span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> wf_mlex wf_empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mlex_less<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_gt_0_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">A</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">-</span> Suc <span class="skolem">l</span> <span class="main">&lt;</span> Max <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Max_gr_iff Max_in diff_less_mono2 finite_imageI imageI image_is_empty lessI<span class="main">)</span>
   <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">f</span><span class="main">,</span> <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">,</span> <span class="skolem">A</span><span class="main">,</span> <span class="skolem">f</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> Max <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> <span class="bound">A</span><span class="main">)</span> <span class="main">-</span> <span class="bound">l</span><span class="main">)</span> <span class="keyword1">&lt;*mlex*&gt;</span> <span class="main">{}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mlex_less<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mlex_leq<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mlex_less<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_gt_0_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> steps.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  lsteps is similar to steps but is using lists instead of sets. This makes the proofs where we use
  induction easier.
›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">lsteps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lsteps</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lsteps</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span>       <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="free">lsteps</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="free"><span class="bound"><span class="entity">left</span></span></span>
                                 <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="main">+</span> <span class="free">lsteps</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="free"><span class="bound"><span class="entity">left</span></span></span>
                                 <span class="keyword1">else</span>                        <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">+</span> <span class="free">lsteps</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="free"><span class="bound"><span class="entity">left</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">f</span><span class="main">,</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> length <span class="bound">xs</span><span class="main">)</span> <span class="keyword1">&lt;*mlex*&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">f</span><span class="main">,</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span>
                 Max <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> set <span class="bound">xs</span><span class="main">)</span> <span class="main">-</span> <span class="bound">l</span><span class="main">)</span> <span class="keyword1">&lt;*mlex*&gt;</span> <span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
       <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> wf_mlex wf_empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mlex_less <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_gt_0_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mlex_leq<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> 3 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">:</span> mlex_less mlex_leq <span class="quasi_keyword">intro</span><span class="main">!</span><span class="main">:</span>  diff_less_mono2 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> Max_gr_iff›</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mlex_less<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_gt_0_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> lsteps.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Skip_List-steps_empty"><span class="command">lemma</span></span> steps_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"steps <span class="main">{}</span> <span class="free">f</span> <span class="free">l</span> <span class="free">up</span> <span class="free">left</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> steps.simps<span class="main">)</span>

<span class="keyword1" id="Skip_List-steps_lsteps"><span class="command">lemma</span></span> steps_lsteps<span class="main">:</span> <span class="quoted"><span class="quoted">"steps <span class="free">A</span> <span class="free">f</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span> <span class="main">=</span> lsteps <span class="main">(</span>rev <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rev <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lsteps.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">u</span> <span class="skolem">v</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> y_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> Max <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span>  <span class="main">=</span> rev <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_Max_snoc<span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">f</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span> <span class="main">|</span> <span class="main">(</span>c<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"steps <span class="skolem">A</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">u</span> <span class="skolem">v</span> <span class="main">=</span> lsteps <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">u</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> a
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> steps.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> lsteps.simps<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> y_ys 2 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> b
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> y_ys 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> steps.simps lsteps.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> c
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>Max <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">u</span> <span class="skolem">v</span> <span class="main">=</span>
                 lsteps <span class="main">(</span>rev <span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>Max <span class="skolem">A</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">u</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span>Max <span class="skolem">A</span><span class="main">}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> y_ys 2 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">!</span><span class="main">:</span> 2<span class="main">(</span>3<span class="main">)</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> steps.simps›</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> steps.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> lsteps.simps<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> y_ys 2 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> steps.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> steps.simps<span class="main">)</span>

<span class="keyword1" id="Skip_List-lsteps_comp_map"><span class="command">lemma</span></span> lsteps_comp_map<span class="main">:</span> <span class="quoted"><span class="quoted">"lsteps <span class="free">zs</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span> <span class="main">=</span> lsteps <span class="main">(</span>map <span class="free">g</span> <span class="free">zs</span><span class="main">)</span> <span class="free">f</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">zs</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∘</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lsteps.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lsteps.simps<span class="main">)</span>

<span class="keyword1" id="Skip_List-steps_image"><span class="command">lemma</span></span> steps_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"mono_on <span class="free">g</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">g</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span> <span class="main">=</span> steps <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="free">f</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sorted_list_of_set <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map <span class="free">g</span> <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_list_of_set_image assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="main">…</span> <span class="main">=</span> map <span class="free">g</span> <span class="main">(</span>rev <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> steps_lsteps lsteps_comp_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Skip_List-lsteps_cong"><span class="command">lemma</span></span> lsteps_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="free">l'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lsteps <span class="free">xs</span> <span class="free">f</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span> <span class="main">=</span> lsteps <span class="free">ys</span> <span class="free">g</span> <span class="free">l'</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">l'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lsteps.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">up</span> <span class="skolem">left</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> lsteps.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lsteps.simps<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Skip_List-steps_cong"><span class="command">lemma</span></span> steps_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="free">l'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"steps <span class="free">A</span> <span class="free">f</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span> <span class="main">=</span> steps <span class="free">B</span> <span class="free">g</span> <span class="free">l'</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> infinite <span class="free">A</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> steps_lsteps steps.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lsteps_cong<span class="main">)</span>

<span class="keyword1" id="Skip_List-lsteps_f_add'"><span class="command">lemma</span></span> lsteps_f_add'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lsteps <span class="free">xs</span> <span class="free">f</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span> <span class="main">=</span> lsteps <span class="free">xs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lsteps.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lsteps.simps<span class="main">)</span>

<span class="keyword1" id="Skip_List-steps_f_add'"><span class="command">lemma</span></span> steps_f_add'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">A</span> <span class="free">f</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span> <span class="main">=</span> steps <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> infinite <span class="free">A</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> steps_lsteps steps.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lsteps_f_add'<span class="main">)</span>

<span class="keyword1" id="Skip_List-lsteps_smaller_set"><span class="command">lemma</span></span> lsteps_smaller_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lsteps <span class="free">xs</span> <span class="free">f</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span> <span class="main">=</span> lsteps <span class="main">[</span><span class="bound">x</span> <span class="main">←</span> <span class="free">xs</span><span class="main">.</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span><span class="main">]</span> <span class="free">f</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lsteps.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lsteps.simps<span class="main">)</span>

<span class="keyword1" id="Skip_List-steps_smaller_set"><span class="command">lemma</span></span> steps_smaller_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">A</span> <span class="free">f</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span> <span class="main">=</span> steps <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">m</span><span class="main">}</span> <span class="free">f</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> infinite <span class="free">A</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> steps_lsteps steps.simps rev_filter sorted_list_of_set_filter
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lsteps_smaller_set<span class="main">)</span>

<span class="keyword1" id="Skip_List-lsteps_level_greater_fun_image"><span class="command">lemma</span></span> lsteps_level_greater_fun_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"lsteps <span class="free">xs</span> <span class="free">f</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lsteps.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lsteps.simps<span class="main">)</span>

<span class="keyword1" id="Skip_List-lsteps_smaller_card_Max_fun'"><span class="command">lemma</span></span> lsteps_smaller_card_Max_fun'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"lsteps <span class="free">xs</span> <span class="free">f</span> <span class="free">l</span> <span class="free">u</span> <span class="free">v</span> <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">u</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">*</span> length <span class="free">xs</span> <span class="main">+</span> <span class="free">u</span> <span class="main">*</span> Max <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lsteps.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">up</span> <span class="skolem">left</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">up</span> <span class="skolem">left</span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="bound">y</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lsteps <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">up</span> <span class="skolem">left</span> <span class="main">+</span> <span class="skolem">l</span> <span class="main">*</span> <span class="skolem">up</span> <span class="main">=</span> lsteps <span class="skolem">xs</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">up</span> <span class="skolem">left</span> <span class="main">+</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">up</span> <span class="main">+</span> <span class="skolem">left</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lsteps.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lsteps <span class="skolem">xs</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">up</span> <span class="skolem">left</span> <span class="main">+</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">up</span> <span class="main">≤</span> <span class="skolem">left</span> <span class="main">*</span> length <span class="skolem">xs</span> <span class="main">+</span> <span class="skolem">up</span> <span class="main">*</span> Max <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> set <span class="skolem">xs</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">up</span> <span class="main">*</span> Max <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> set <span class="skolem">xs</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">up</span> <span class="main">*</span> Max <span class="main">(</span>insert <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span>  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lsteps <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">up</span> <span class="skolem">left</span> <span class="main">+</span> <span class="skolem">l</span> <span class="main">*</span> <span class="skolem">up</span> <span class="main">=</span> lsteps <span class="skolem">xs</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">up</span> <span class="skolem">left</span> <span class="main">+</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">up</span> <span class="main">+</span> <span class="skolem">left</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lsteps.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lsteps <span class="skolem">xs</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">up</span> <span class="skolem">left</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lsteps_level_greater_fun_image<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">up</span> <span class="main">≤</span> <span class="skolem">up</span> <span class="main">*</span> Max <span class="main">(</span>insert <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lsteps <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">up</span> <span class="skolem">left</span> <span class="main">=</span> lsteps <span class="skolem">xs</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">up</span> <span class="skolem">left</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lsteps.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">+</span> <span class="skolem">l</span> <span class="main">*</span> <span class="skolem">up</span> <span class="main">≤</span> <span class="skolem">left</span> <span class="main">*</span> length <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">up</span> <span class="main">*</span> Max <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> Max <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lsteps.simps<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Skip_List-steps_smaller_card_Max_fun'"><span class="command">lemma</span></span> steps_smaller_card_Max_fun'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"steps <span class="free">A</span> <span class="free">f</span> <span class="free">l</span> <span class="free">up</span> <span class="free">left</span> <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">up</span> <span class="main">≤</span> <span class="free">left</span> <span class="main">*</span> card <span class="free">A</span> <span class="main">+</span> <span class="free">up</span> <span class="main">*</span> Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">A</span> <span class="free">f</span> <span class="free">l</span> <span class="free">up</span> <span class="free">left</span>  <span class="main">=</span> lsteps <span class="main">(</span>rev <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">l</span> <span class="free">up</span> <span class="free">left</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> steps_lsteps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">up</span> <span class="main">≤</span> <span class="free">left</span> <span class="main">*</span> length <span class="var">?xs</span> <span class="main">+</span> <span class="free">up</span> <span class="main">*</span> Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> set <span class="var">?xs</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lsteps_smaller_card_Max_fun'<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">left</span> <span class="main">*</span> length <span class="var">?xs</span> <span class="main">=</span> <span class="free">left</span> <span class="main">*</span> card <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sorted_list_of_set_length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?xs</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Skip_List-lsteps_height"><span class="command">lemma</span></span> lsteps_height<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lsteps <span class="free">xs</span> <span class="free">f</span> <span class="free">l</span> <span class="free">up</span> <span class="main">0</span> <span class="main">+</span> <span class="free">up</span> <span class="main">*</span> <span class="free">l</span> <span class="main">=</span> <span class="free">up</span> <span class="main">*</span> Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">up</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">::</span>nat"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lsteps.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">up</span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="bound">y</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
   <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xa</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="bound">xa</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 0 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≤</span> Max <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> set <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 0 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Max_ge_iff<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>Max <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Max <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 0 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 0 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lsteps.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>insert <span class="skolem">l</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lsteps <span class="skolem">xs</span> <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">up</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lsteps_level_greater_fun_image<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lsteps.simps<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xa</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="bound">xa</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 0 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≤</span> Max <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> set <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 0 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Max_ge_iff<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>Max <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> set <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 0 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 0 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lsteps.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lsteps.simps<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Skip_List-steps_height"><span class="command">lemma</span></span> steps_height<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"steps <span class="free">A</span> <span class="free">f</span> <span class="main">0</span> <span class="free">up</span> <span class="main">0</span> <span class="main">=</span> <span class="free">up</span> <span class="main">*</span> Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">A</span> <span class="free">f</span> <span class="main">0</span> <span class="free">up</span> <span class="main">0</span> <span class="main">=</span> lsteps <span class="main">(</span>rev <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">0</span> <span class="free">up</span> <span class="main">0</span> <span class="main">+</span> <span class="free">up</span> <span class="main">*</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> steps_lsteps<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">up</span> <span class="main">*</span> Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lsteps_height<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> random_skip_list
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can now define the pmf describing the length of the search path in a skip list.
  Like the height it only depends on the number of elements in the skip list's underlying set.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> steps <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">f</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>SL <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R<span class="hidden">⇩</span><sub>N</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R<span class="hidden">⇩</span><sub>N</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> R <span class="main">{..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>


<span class="keyword1" id="Skip_List-R"><span class="command">lemma</span></span> R<span class="hidden">⇩</span><sub>N</sub>_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"R<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="bound">f</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>SL<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SL<span class="hidden">⇩</span><sub>N</sub>_def R<span class="hidden">⇩</span><sub>N</sub>_def R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> monad_normalisation
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Skip_List-R_R"><span class="command">lemma</span></span> R_R<span class="hidden">⇩</span><sub>N</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"R <span class="free">A</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> R<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span>card <span class="free">A</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?steps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span> <span class="bound">f</span><span class="main">.</span> steps <span class="bound">A</span> <span class="bound">f</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"bij_mono_map_set_to_nat <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R <span class="free">A</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> SL <span class="free">A</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> return_pmf <span class="main">(</span><span class="var">?steps</span> <span class="free">A</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> R_def map_pmf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> SL<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span>card <span class="free">A</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> return_pmf <span class="main">(</span><span class="var">?steps</span> <span class="free">A</span> <span class="main">(</span><span class="bound">f</span> <span class="main">∘</span> <span class="var">?f'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f'</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> bij_mono_map_set_to_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms bij_mono_map_set_to_nat <span class="keyword1"><span class="command">unfolding</span></span> SL_def SL<span class="hidden">⇩</span><sub>N</sub>_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_bij_betw<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f'</span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{..&lt;</span></span></span>card <span class="free"><span class="free"><span class="free">A</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_pmf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> SL<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span>card <span class="free">A</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> return_pmf <span class="main">(</span><span class="var">?steps</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms bij_mono_map_set_to_nat bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> steps_image<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> R<span class="hidden">⇩</span><sub>N</sub>_def R_def SL<span class="hidden">⇩</span><sub>N</sub>_def SL_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_pmf_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> R<span class="hidden">⇩</span><sub>N</sub><span class="antiquote"><span class="antiquote">}</span></span></span></span> fulfills a recurrence relation. If we move up or to the left the ``remaining'' length of the
  search path is again a slightly different probability distribution over the length.
›</span></span>

<span class="keyword1" id="Skip_List-R"><span class="command">lemma</span></span> R<span class="hidden">⇩</span><sub>N</sub>_recurrence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"R<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span>
             <span class="keyword1">do</span> <span class="main">{</span>
               <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="free">p</span><span class="main">;</span>
               <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span>               <span class="comment1">― ‹leftwards›</span>
                 map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>R<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span>
               <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>               <span class="comment1">― ‹upwards›</span>
                 <span class="bound">m</span> <span class="main">←</span> binomial_pmf <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span><span class="main">;</span>
                 map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>R<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span>
               <span class="main">}</span>
             <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> insert <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="bound">f</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>SL<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R<span class="hidden">⇩</span><sub>N</sub>_def R_def SL<span class="hidden">⇩</span><sub>N</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="bound">f</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span>
                          <span class="main">(</span>map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pair_pmf <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span> <span class="main">(</span>SL<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pi_pmf <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> geometric_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pair_pmf <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span>
                     <span class="main">(</span>Pi_pmf <span class="main">{..&lt;</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">}</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> geometric_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_insert<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{..&lt;</span></span></span><span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">-</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">-</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> geometric_pmf <span class="free"><span class="free"><span class="free">p</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>  <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SL<span class="hidden">⇩</span><sub>N</sub>_def SL_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
        <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">g</span> <span class="main">←</span> geometric_pmf <span class="free">p</span><span class="main">;</span>
             <span class="bound">f</span> <span class="main">←</span> SL<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
             return_pmf <span class="main">(</span>steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta map_pmf_def pair_pmf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
        <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">b</span> <span class="main">←</span>  bernoulli_pmf <span class="free">p</span><span class="main">;</span>
             <span class="bound">g</span> <span class="main">←</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> return_pmf <span class="main">0</span> <span class="keyword1">else</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span><span class="main">;</span>
             <span class="bound">f</span> <span class="main">←</span> SL<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
             return_pmf <span class="main">(</span>steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> geometric_bind_pmf_unfold<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
        <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="free">p</span><span class="main">;</span>
             <span class="keyword1">if</span> <span class="bound">b</span>
               <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">g</span> <span class="main">←</span> return_pmf <span class="main">0</span><span class="main">;</span>
                         <span class="bound">f</span> <span class="main">←</span> SL<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
                         return_pmf <span class="main">(</span>steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span> <span class="main">}</span>
               <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">g</span> <span class="main">←</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span><span class="main">;</span>
                         <span class="bound">f</span> <span class="main">←</span> SL<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
                         return_pmf <span class="main">(</span>steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span> <span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bind_pmf_if'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span> <span class="bound">g</span> <span class="main">←</span> return_pmf <span class="main">0</span><span class="main">;</span>
                       <span class="bound">f</span> <span class="main">←</span> SL<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
                       return_pmf <span class="main">(</span>steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span> <span class="main">}</span>  <span class="main">=</span>
              <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">f</span> <span class="main">←</span> SL<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
                        return_pmf <span class="main">(</span>steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bind_return_pmf<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> steps <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="bound">f</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>SL<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> <span class="free">l</span> <span class="main">+</span> steps <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="skolem">f</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> steps.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> steps_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_ac map_pmf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>R<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> R<span class="hidden">⇩</span><sub>N</sub>_def R_def SL<span class="hidden">⇩</span><sub>N</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf Suc <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span> <span class="main">⤜</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> SL<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⤜</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> return_pmf <span class="main">(</span>steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
             <span class="main">=</span>
             Pi_pmf <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> True <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span> <span class="main">⤜</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span> <span class="main">⤜</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> Pi_pmf <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">}</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> return_pmf <span class="main">(</span>steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> SL<span class="hidden">⇩</span><sub>N</sub>_def SL_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_geometric_filter<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
             <span class="keyword1">do</span> <span class="main">{</span>
             <span class="bound">b</span> <span class="main">←</span> Pi_pmf <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> True <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">;</span>
             <span class="bound">f</span> <span class="main">←</span> Pi_pmf <span class="main">(</span>insert <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
             return_pmf <span class="main">(</span>steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="bound">f</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_insert'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
             <span class="keyword1">do</span> <span class="main">{</span>
               <span class="bound">b</span> <span class="main">←</span> Pi_pmf <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> True <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">;</span>
               <span class="bound">f</span> <span class="main">←</span> Pi_pmf <span class="main">(</span><span class="skolem">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">1</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> map_pmf Suc <span class="main">(</span>geometric_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
               return_pmf <span class="main">(</span>steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">B</span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_default_swap<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_pmf_def B_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
             <span class="keyword1">do</span> <span class="main">{</span>
               <span class="bound">b</span> <span class="main">←</span> Pi_pmf <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> True <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">;</span>
               <span class="bound">f</span> <span class="main">←</span> SL <span class="main">(</span><span class="skolem">B</span> <span class="bound">b</span><span class="main">)</span><span class="main">;</span>
               return_pmf <span class="main">(</span>steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">B</span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1">then</span> Suc <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Suc <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> return_pmf <span class="main">(</span>steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="main">(</span>Suc <span class="main">∘</span> <span class="bound">f</span><span class="main">)</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> return_pmf <span class="main">(</span>steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="skolem">b</span> <span class="keyword1">then</span> Suc <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_pmf_def B_def SL_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
               <span class="keyword1">do</span> <span class="main">{</span>
               <span class="bound">b</span> <span class="main">←</span> Pi_pmf <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> True <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">;</span>
               <span class="bound">r</span> <span class="main">←</span> R <span class="main">(</span><span class="skolem">B</span> <span class="bound">b</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span><span class="main">;</span>
               return_pmf <span class="main">(</span><span class="free">u</span> <span class="main">+</span> <span class="bound">r</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="skolem">b</span> <span class="keyword1">then</span> Suc <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> <span class="free">u</span> <span class="main">+</span> steps <span class="main">(</span><span class="skolem">B</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">f</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_eqI<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="skolem">b</span> <span class="keyword1">then</span> Suc <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span>
              <span class="free">u</span> <span class="main">+</span> <span class="main">(</span>steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">B</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1">then</span> Suc <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">1</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> steps.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">B</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1">then</span> Suc <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">1</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span>
                   steps <span class="main">(</span><span class="skolem">B</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">B</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1">then</span> Suc <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">1</span> <span class="free">u</span> <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="skolem">b</span> <span class="keyword1">then</span> Suc <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">B</span> <span class="skolem">b</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> steps_smaller_set<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> steps <span class="main">(</span><span class="skolem">B</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">1</span> <span class="free">u</span> <span class="free">l</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> steps_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> steps <span class="main">(</span><span class="skolem">B</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">f</span> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> steps_f_add'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_def map_pmf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                   <span class="bound">b</span> <span class="main">←</span> Pi_pmf <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> False <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                   <span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                   <span class="bound">r</span> <span class="main">←</span> R <span class="main">{..&lt;</span><span class="bound">m</span><span class="main">}</span> <span class="free">u</span> <span class="free">l</span><span class="main">;</span>
                   return_pmf <span class="main">(</span><span class="free">u</span> <span class="main">+</span> <span class="bound">r</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span>Suc <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_insert_if<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pi_pmf <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> True <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="free">p</span><span class="main">)</span> <span class="main">=</span>
              Pi_pmf <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> True <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> map_pmf Not <span class="main">(</span>bernoulli_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bernoulli_pmf_Not<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">(∘)</span> Not<span class="main">)</span> <span class="main">(</span>Pi_pmf <span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>  False <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Pi_pmf_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">False</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">using</span></span> assms *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> R_R<span class="hidden">⇩</span><sub>N</sub><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_R<span class="hidden">⇩</span><sub>N</sub> map_pmf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> binomial_pmf <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>R<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> binomial_pmf_altdef'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{..&lt;</span></span></span><span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> dflt <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"False"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R<span class="hidden">⇩</span><sub>N</sub>_def R_def SL_def map_pmf_def <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context includes monad_normalisation *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The expected height and length of search path defined as non-negative integral. It's easier
  to prove the recurrence relation of the expected length of the search path using non-negative
  integrals.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NH<span class="hidden">⇩</span><sub>N</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NH<span class="hidden">⇩</span><sub>N</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> nn_integral <span class="main">(</span>H<span class="hidden">⇩</span><sub>N</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> real"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NR<span class="hidden">⇩</span><sub>N</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NR<span class="hidden">⇩</span><sub>N</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> nn_integral <span class="main">(</span>R<span class="hidden">⇩</span><sub>N</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> real"</span></span>

<span class="keyword1" id="Skip_List-NH"><span class="command">lemma</span></span> NH<span class="hidden">⇩</span><sub>N</sub>_EH<span class="hidden">⇩</span><sub>N</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"NH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">=</span> EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms EH<span class="hidden">⇩</span><sub>N</sub>_bounds <span class="keyword1"><span class="command">unfolding</span></span> EH<span class="hidden">⇩</span><sub>N</sub>_def NH<span class="hidden">⇩</span><sub>N</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_eq_integral<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Skip_List-R"><span class="command">lemma</span></span> R<span class="hidden">⇩</span><sub>N</sub>_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"R<span class="hidden">⇩</span><sub>N</sub> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> return_pmf <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> R<span class="hidden">⇩</span><sub>N</sub>_def R_def SL_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> steps.simps<span class="main">)</span>

<span class="keyword1" id="Skip_List-NR"><span class="command">lemma</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_bounds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span> <span class="free">l</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="free">u</span> <span class="main">*</span> NH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∂</span>measure_pmf <span class="main">(</span>R<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_def R<span class="hidden">⇩</span><sub>N</sub>_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ennreal_of_nat_eq_real_of_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∂</span><span class="main">(</span>measure_pmf <span class="main">(</span>map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="free">l</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="free">u</span> <span class="main">*</span> Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>SL<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> of_nat_mono<span class="main">[</span><span class="operator">OF</span> steps_smaller_card_Max_fun'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> R<span class="hidden">⇩</span><sub>N</sub>_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">l</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="free">u</span> <span class="main">*</span> NH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> NH<span class="hidden">⇩</span><sub>N</sub>_def H<span class="hidden">⇩</span><sub>N</sub>_def H_def SL<span class="hidden">⇩</span><sub>N</sub>_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_add nn_integral_cmult ennreal_of_nat_eq_real_of_nat ennreal_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="free">u</span> <span class="main">*</span> NH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Skip_List-NR"><span class="command">lemma</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_recurrence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span> <span class="main">+</span>
                     q <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="main">(</span>binomial_pmf <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> q<span class="main">)</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>q <span class="main">^</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="bound">k</span><span class="main">.</span> pmf <span class="main">(</span>binomial_pmf <span class="bound">n</span> q<span class="main">)</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"q <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"q <span class="main">^</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms power_Suc_less_one <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qn<span class="main">:</span> <span class="quoted"><span class="quoted">"q <span class="main">^</span> <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span> <span class="main">+</span>
                    q <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">+</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">k</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span>  <span class="main">∂</span>measure_pmf <span class="main">(</span>binomial_pmf <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> q<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> R<span class="hidden">⇩</span><sub>N</sub>_recurrence<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> nn_integral_add q_def ennreal_of_nat_eq_real_of_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">m</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span>  <span class="main">∂</span>measure_pmf <span class="main">(</span>binomial_pmf <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> q<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> B_def q_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_measure_pmf_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span> <span class="main">+</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">*</span> q <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> B_def q_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span> <span class="main">+</span>
                            q <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span> <span class="main">+</span> <span class="free">u</span><span class="main">)</span> <span class="main">+</span>
                            NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">*</span> <span class="main">(</span>q <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> q"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> numerals<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">*</span> <span class="main">(</span>q <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> q <span class="main">=</span> <span class="main">(</span>q <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> q power_minus_mult<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted">q</span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mult_ac<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> ennreal_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span> <span class="main">+</span>
                               q <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
                               <span class="main">(</span>q <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">-</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≠</span> <span class="main">⊤</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">::</span><span class="quoted">ennreal</span>
     <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> that<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="free">u</span> <span class="main">*</span> NH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_bounds <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ennreal_of_nat_eq_real_of_nat<span class="main">)</span>
   <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">=</span> EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> assms NH<span class="hidden">⇩</span><sub>N</sub>_EH<span class="hidden">⇩</span><sub>N</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="free">u</span> <span class="main">*</span> ennreal <span class="main">(</span>EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">⊤</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ennreal_mult_less_top of_nat_less_top<span class="main">)</span>
   <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">≠</span> <span class="main">⊤</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">⊤</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">::</span><span class="quoted">ennreal</span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">-</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> that<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ennreal_mult_eq_top_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span>ennreal <span class="main">1</span> <span class="main">-</span> ennreal <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac ennreal_right_diff_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">1</span> <span class="main">-</span> ennreal <span class="skolem">a</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ennreal_minus<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that ennreal_minus_eq_0 not_less <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mult_divide_eq_ennreal<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span> <span class="main">+</span>
                     q <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>q <span class="main">^</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 3 assms qn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> 2<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Skip_List-NR"><span class="command">lemma</span></span> NR<span class="hidden">⇩</span><sub>n</sub>_NH<span class="hidden">⇩</span><sub>N</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="main">0</span> <span class="main">=</span> <span class="free">u</span> <span class="main">*</span> NH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="main">0</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">f</span><span class="main">.</span> steps <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="bound">f</span> <span class="main">0</span> <span class="free">u</span> <span class="main">0</span> <span class="main">∂</span>measure_pmf <span class="main">(</span>SL<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_def R<span class="hidden">⇩</span><sub>N</sub>_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ennreal_of_nat_eq_real_of_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">f</span><span class="main">.</span> of_nat <span class="free">u</span> <span class="main">*</span> of_nat <span class="main">(</span>Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>measure_pmf <span class="main">(</span>SL<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> steps_height<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">u</span> <span class="main">*</span> NH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> NH<span class="hidden">⇩</span><sub>N</sub>_def H<span class="hidden">⇩</span><sub>N</sub>_def H_def SL<span class="hidden">⇩</span><sub>N</sub>_def  ennreal_of_nat_eq_real_of_nat nn_integral_cmult<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Skip_List-NR"><span class="command">lemma</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_recurrence'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="free">l</span> <span class="main">+</span> <span class="free">p</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span> <span class="main">+</span>
                     q <span class="main">*</span> <span class="free">u</span> <span class="main">+</span> q <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="main">(</span>binomial_pmf <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> q<span class="main">)</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>q <span class="main">^</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_recurrence<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> ennreal_of_nat_eq_real_of_nat ennreal_mult' ennreal_mult''<span class="main">)</span>


<span class="keyword1" id="Skip_List-NR"><span class="command">lemma</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_l_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="main">0</span> <span class="main">+</span>
                     q <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="main">0</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="main">(</span>binomial_pmf <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> q<span class="main">)</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>q <span class="main">^</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_recurrence<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Skip_List-NR"><span class="command">lemma</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_u_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">0</span> <span class="free">l</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">0</span> <span class="free">l</span><span class="main">)</span> <span class="main">+</span>
                     q <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">0</span> <span class="free">l</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="main">(</span>binomial_pmf <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> q<span class="main">)</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>q <span class="main">^</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_recurrence<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Skip_List-NR"><span class="command">lemma</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">0</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_def R<span class="hidden">⇩</span><sub>N</sub>_def R_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Skip_List-NR"><span class="command">lemma</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">1</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">/</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">1</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> <span class="main">(</span>ennreal <span class="free">p</span> <span class="main">*</span> of_nat <span class="free">l</span> <span class="main">+</span> ennreal q <span class="main">*</span> of_nat <span class="free">u</span><span class="main">)</span> <span class="main">/</span> ennreal <span class="main">(</span><span class="main">1</span> <span class="main">-</span> q<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> NR<span class="hidden">⇩</span><sub>N</sub>_recurrence<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ennreal <span class="free">p</span> <span class="main">*</span> of_nat <span class="free">l</span> <span class="main">+</span> ennreal q <span class="main">*</span> of_nat <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ennreal_plus<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> ennreal_mult' ennreal_of_nat_eq_real_of_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">/</span> ennreal <span class="main">(</span><span class="main">1</span> <span class="main">-</span> q<span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> q<span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> q_def assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_ennreal<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Skip_List-NR"><span class="command">lemma</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_NR<span class="hidden">⇩</span><sub>N</sub>_l_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">/</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="free">u</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="main">*</span> q"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">/</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">/</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">*</span> q <span class="main">/</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms q_def 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">using</span></span> p q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ennreal_divide_self<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="skolem">i</span> <span class="free">u</span> <span class="free">l</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">/</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> c_def True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> NR<span class="hidden">⇩</span><sub>N</sub>_1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">/</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">/</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">using</span></span> assms q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ennreal_mult''<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">/</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">/</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span> <span class="main">*</span> q <span class="main">/</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">/</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">/</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">/</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">::</span><span class="quoted"><span class="quoted">"real"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> I<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="skolem">i</span> <span class="free">u</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> True c_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> NR<span class="hidden">⇩</span><sub>N</sub>_1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">/</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span> <span class="main">*</span> ennreal <span class="main">(</span>pmf <span class="main">(</span>binomial_pmf <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> q<span class="main">)</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="skolem">i</span> <span class="free">u</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="main">0</span> <span class="main">+</span>
                     q <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="main">0</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="main">(</span>binomial_pmf <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> q<span class="main">)</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>q <span class="main">^</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> NR<span class="hidden">⇩</span><sub>N</sub>_l_0<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"q <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="main">0</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="main">(</span>binomial_pmf <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> q<span class="main">)</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             q <span class="main">*</span> <span class="free">u</span> <span class="main">+</span> q <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="main">0</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="main">(</span>binomial_pmf <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> q<span class="main">)</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms q_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> ennreal_of_nat_eq_real_of_nat ennreal_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">using</span></span> less i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> less<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="main">0</span> <span class="main">*</span> ennreal <span class="main">(</span>pmf <span class="main">(</span>binomial_pmf <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> q<span class="main">)</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span> <span class="main">*</span> ennreal <span class="main">(</span>pmf <span class="main">(</span>binomial_pmf <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> q<span class="main">)</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less c_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_distrib_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong mult_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"q <span class="main">*</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>q <span class="main">*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>q <span class="main">*</span> real <span class="free">u</span><span class="main">)</span> <span class="main">=</span> q <span class="main">*</span> <span class="free">u</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> q_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>real <span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> real <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ennreal_mult''<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> ennreal <span class="main">(</span>real <span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> real <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>ennreal q <span class="main">*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span>
             <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>ennreal <span class="main">(</span>real <span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> real <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>ennreal q <span class="main">*</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>ennreal <span class="free">p</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>ennreal <span class="free">p</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>ennreal <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> ennreal q <span class="main">*</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span>
            <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>ennreal <span class="free">p</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>ennreal <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> ennreal q <span class="main">*</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>ennreal <span class="free">p</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span> <span class="main">+</span> <span class="main">(</span>ennreal <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> ennreal q <span class="main">*</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> ennreal <span class="main">(</span><span class="main">1</span> <span class="main">-</span> q <span class="main">^</span> <span class="skolem">i</span><span class="main">)</span>
         <span class="main">=</span>  <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>ennreal <span class="free">p</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span> <span class="main">+</span> <span class="main">(</span>ennreal <span class="main">(</span><span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> ennreal q <span class="main">*</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> ennreal <span class="main">(</span><span class="main">1</span> <span class="main">-</span> q <span class="main">^</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ennreal_times_divide<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ennreal <span class="free">p</span> <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">u</span> <span class="free">l</span> <span class="main">+</span> <span class="main">(</span>ennreal <span class="main">(</span>real <span class="free">u</span> <span class="main">*</span> q <span class="main">+</span> real <span class="free">l</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> ennreal q <span class="main">*</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> ennreal <span class="main">(</span><span class="main">1</span> <span class="main">-</span> q <span class="main">^</span> <span class="skolem">i</span><span class="main">)</span>
        <span class="main">=</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="skolem">i</span> <span class="free">u</span> <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_recurrence'<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> i assms q_def <span class="keyword1"><span class="command">by</span></span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> B_def ennreal_of_nat_eq_real_of_nat ennreal_mult' ennreal_mult''<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Assigning 1 as the cost for going up and/or left, we can now show the relation between the
  expected length of the reverse search path and the expected height.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EL<span class="hidden">⇩</span><sub>N</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EL<span class="hidden">⇩</span><sub>N</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> measure_pmf.expectation <span class="main">(</span>R<span class="hidden">⇩</span><sub>N</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">1</span> <span class="main">1</span><span class="main">)</span> real"</span></span>


<span class="keyword1"><span class="command">theorem</span></span> EH<span class="hidden">⇩</span><sub>N</sub>_EL<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>p</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> q <span class="main">*</span> EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">=</span> EL<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">y</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">*</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">r</span><span class="main">::</span><span class="quoted">ennreal</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ennreal_mult''<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> that<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>ennreal <span class="skolem">y</span> <span class="main">*</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ennreal_mult''<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">=</span> NH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NH<span class="hidden">⇩</span><sub>N</sub>_EH<span class="hidden">⇩</span><sub>N</sub> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">=</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">1</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NR<span class="hidden">⇩</span><sub>n</sub>_NH<span class="hidden">⇩</span><sub>N</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">1</span> <span class="main">0</span> <span class="main">=</span> q <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">1</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NR<span class="hidden">⇩</span><sub>N</sub>_NR<span class="hidden">⇩</span><sub>N</sub>_l_0<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> that assms q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> q <span class="main">*</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">1</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> q <span class="main">*</span> EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">=</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">1</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that assms q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> 1<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EH<span class="hidden">⇩</span><sub>N</sub>_def H<span class="hidden">⇩</span><sub>N</sub>_def H_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> q <span class="main">*</span> EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">=</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">1</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EH<span class="hidden">⇩</span><sub>N</sub>_def H<span class="hidden">⇩</span><sub>N</sub>_def H_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span><span class="main">1</span> <span class="main">/</span> q <span class="main">*</span> EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">1</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NR<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">1</span> <span class="main">1</span> <span class="main">=</span> EL<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 assms EH<span class="hidden">⇩</span><sub>N</sub>_bounds <span class="keyword1"><span class="command">unfolding</span></span> EL<span class="hidden">⇩</span><sub>N</sub>_def NR<span class="hidden">⇩</span><sub>N</sub>_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> nn_integral_eq_integral<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integrableI_nn_integral_finite<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"EH<span class="hidden">⇩</span><sub>N</sub> <span class="free">n</span> <span class="main">/</span> q"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms q_def ennreal_inj <span class="keyword1"><span class="command">unfolding</span></span> EL<span class="hidden">⇩</span><sub>N</sub>_def EH<span class="hidden">⇩</span><sub>N</sub>_def H<span class="hidden">⇩</span><sub>N</sub>_def H_def SL_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context random_skip_list *)</span>

<span class="keyword1"><span class="command">thm</span></span> random_skip_list.EH<span class="hidden">⇩</span><sub>N</sub>_EL<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>p</sub><span class="main">[</span><span class="operator">unfolded</span> random_skip_list.q_def<span class="main">]</span>
    random_skip_list.EH<span class="hidden">⇩</span><sub>N</sub>_bounds'<span class="main">[</span><span class="operator">unfolded</span> random_skip_list.q_def<span class="main">]</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>