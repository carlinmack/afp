<div id="Merkle_Interface">
<div class="head">
<h1>Theory Merkle_Interface</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Andreas Lochbihler, Digital Asset
   Author: Ognjen Maric, Digital Asset *)</span>

<span class="keyword1"><span class="command">theory</span></span> Merkle_Interface
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Conditional_Parametricity.html">HOL-Library.Conditional_Parametricity</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">alias</span></span> vimage2p <span class="main">=</span> BNF_Def.vimage2p
<span class="keyword1"><span class="command">alias</span></span> Grp <span class="main">=</span> BNF_Def.Grp
<span class="keyword1"><span class="command">alias</span></span> setl <span class="main">=</span> Basic_BNFs.setl
<span class="keyword1"><span class="command">alias</span></span> setr <span class="main">=</span> Basic_BNFs.setr
<span class="keyword1"><span class="command">alias</span></span> fsts <span class="main">=</span> Basic_BNFs.fsts
<span class="keyword1"><span class="command">alias</span></span> snds <span class="main">=</span> Basic_BNFs.snds

<span class="keyword1"><span class="command">attribute_setup</span></span> locale_witness <span class="main">=</span> <span class="quoted">‹Scan.succeed <span class="entity">Locale.witness_add</span>›</span>

<span class="keyword1" id="Merkle_Interface-vimage2p_mono'"><span class="command">lemma</span></span> vimage2p_mono'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≤</span> <span class="free">S</span> <span class="main">⟹</span> vimage2p <span class="free">f</span> <span class="free">g</span> <span class="free">R</span> <span class="main">≤</span> vimage2p <span class="free">f</span> <span class="free">g</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage2p_def le_fun_def<span class="main">)</span>

<span class="keyword1" id="Merkle_Interface-vimage2p_map_rel_prod"><span class="command">lemma</span></span> vimage2p_map_rel_prod<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"vimage2p <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>map_prod <span class="free">f'</span> <span class="free">g'</span><span class="main">)</span> <span class="main">(</span>rel_prod <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> rel_prod <span class="main">(</span>vimage2p <span class="free">f</span> <span class="free">f'</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>vimage2p <span class="free">g</span> <span class="free">g'</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage2p_def prod.rel_map<span class="main">)</span>

<span class="keyword1" id="Merkle_Interface-vimage2p_map_list_all2"><span class="command">lemma</span></span> vimage2p_map_list_all2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vimage2p <span class="main">(</span>map <span class="free">f</span><span class="main">)</span> <span class="main">(</span>map <span class="free">g</span><span class="main">)</span> <span class="main">(</span>list_all2 <span class="free">A</span><span class="main">)</span> <span class="main">=</span> list_all2 <span class="main">(</span>vimage2p <span class="free">f</span> <span class="free">g</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage2p_def list.rel_map<span class="main">)</span>

<span class="keyword1" id="Merkle_Interface-equivclp_least"><span class="command">lemma</span></span> equivclp_least<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"equivp <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"equivclp <span class="free">r</span> <span class="main">≤</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> predicate2I<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> equivclp_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> equivp_reflp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="main"><span class="main">]</span></span> equivp_transp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="main"><span class="main">]</span></span> equivp_symp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="main"><span class="main">]</span></span> le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Merkle_Interface-reflp_eq_onp"><span class="command">lemma</span></span> reflp_eq_onp<span class="main">:</span> <span class="quoted"><span class="quoted">"reflp <span class="free">R</span> <span class="main">⟷</span> eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span> <span class="main">≤</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reflp_def eq_onp_def<span class="main">)</span>

<span class="keyword1" id="Merkle_Interface-eq_onpE"><span class="command">lemma</span></span> eq_onpE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eq_onp <span class="free">P</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>

<span class="keyword1" id="Merkle_Interface-case_unit_parametric"><span class="command">lemma</span></span> case_unit_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fun <span class="free">A</span> <span class="main">(</span>rel_fun <span class="main">(=)</span> <span class="free">A</span><span class="main">)</span> case_unit case_unit"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> unit.split<span class="main">)</span>


<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Authenticated Data Structures›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Interface›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Types ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span>"</span></span> <span class="comment1">― ‹Type of hash operation›</span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> blinding_of <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> merge <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> option"</span></span> <span class="comment1">― ‹ merging that can fail for values with different hashes›</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Properties ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">locale</span></span> merkle_interface <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> blinding_of"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> merge"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> merge_respects_hashes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">a</span> <span class="main">=</span> <span class="free">h</span> <span class="free">b</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="free">m</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> Some <span class="bound">ab</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> idem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">a</span> <span class="free">a</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="free">m</span> <span class="free">b</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⤜</span> <span class="free">m</span> <span class="free">c</span> <span class="main">=</span> <span class="free">m</span> <span class="free">b</span> <span class="free">c</span> <span class="main">⤜</span> <span class="free">m</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bo_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">m</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> Some <span class="free">b</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Merkle_Interface-reflp"><span class="command">lemma</span></span> reflp<span class="main">:</span> <span class="quoted"><span class="quoted">"reflp <span class="free">bo</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bo_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> reflpI<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> idem<span class="main">)</span>

<span class="keyword1" id="Merkle_Interface-antisymp"><span class="command">lemma</span></span> antisymp<span class="main">:</span> <span class="quoted"><span class="quoted">"antisymp <span class="free">bo</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bo_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> antisympI<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> commute<span class="main">)</span>

<span class="keyword1" id="Merkle_Interface-transp"><span class="command">lemma</span></span> transp<span class="main">:</span> <span class="quoted"><span class="quoted">"transp <span class="free">bo</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> transpI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y z <span class="keyword1"><span class="command">using</span></span> assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> commute bo_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Merkle_Interface-hash"><span class="command">lemma</span></span> hash<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="main">≤</span> vimage2p <span class="free">h</span> <span class="free">h</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bo_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage2p_def merge_respects_hashes<span class="main">)</span>

<span class="keyword1" id="Merkle_Interface-join"><span class="command">lemma</span></span> join<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> Some <span class="free">ab</span> <span class="main">⟷</span> <span class="free">bo</span> <span class="free">a</span> <span class="free">ab</span> <span class="main">∧</span> <span class="free">bo</span> <span class="free">b</span> <span class="free">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="free">bo</span> <span class="free">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="free">bo</span> <span class="free">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="free">bo</span> <span class="free">ab</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bo_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Option.bind_cong bind.bind_lunit commute idem merkle_interface.assoc merkle_interface_axioms<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The equivalence closure of the blinding relation are the equivalence classes of the hash function (the kernel).›</span></span>

<span class="keyword1" id="Merkle_Interface-equivclp_blinding_of"><span class="command">lemma</span></span> equivclp_blinding_of<span class="main">:</span> <span class="quoted"><span class="quoted">"equivclp <span class="free">bo</span> <span class="main">=</span> vimage2p <span class="free">h</span> <span class="free">h</span> <span class="main">(=)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≤</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> equivclp_least<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hash<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">rule</span> equivp_vimage2p<span class="main"><span class="main">[</span></span><span class="operator">OF</span> identity_equivp<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">≤</span> <span class="var">?lhs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vimage2p_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> predicate2I<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">h</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xy</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="skolem">xy</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> merge_respects_hashes <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="skolem">x</span> <span class="skolem">xy</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="skolem">y</span> <span class="skolem">xy</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> join <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"equivclp <span class="free">bo</span> <span class="skolem">x</span> <span class="skolem">xy</span>"</span></span> <span class="quoted"><span class="quoted">"equivclp <span class="free">bo</span> <span class="skolem">xy</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"equivclp <span class="free">bo</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> equivclp_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Auxiliary definitions ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Directly proving that an interface satisfies the specification of a Merkle interface as given
above is difficult. Instead, we provide several layers of auxiliary definitions that can easily be
proved layer-by-layer. 

In particular, proving that an interface on recursive datatypes is a Merkle interface requires
induction. As the induction hypothesis only applies to a subset of values of a type, we add
auxiliary definitions equipped with an explicit set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of values to which the definition
applies. Once the induction proof is complete, we can typically instantiate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">UNIV</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In particular, in the induction proof for a layer, we can assume that properties for the
earlier layers hold for <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹all›</span></span> values, not just those in the induction hypothesis.
›</span></span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Blinding ›</span></span>
<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">locale</span></span> blinding_respects_hashes <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> blinding_of"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hash<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="main">≤</span> vimage2p <span class="free">h</span> <span class="free">h</span> <span class="main">(=)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Merkle_Interface-blinding_hash_eq"><span class="command">lemma</span></span> blinding_hash_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">h</span> <span class="free">x</span> <span class="main">=</span> <span class="free">h</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">drule</span> hash<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage2p_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> blinding_of_on <span class="main">=</span>
  blinding_respects_hashes <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> blinding_of"</span></span>
  <span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">bo</span> <span class="free">x</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">bo</span> <span class="free">x</span> <span class="free">y</span><span class="main">;</span> <span class="free">bo</span> <span class="free">y</span> <span class="free">z</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">bo</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">bo</span> <span class="free">x</span> <span class="free">y</span><span class="main">;</span> <span class="free">bo</span> <span class="free">y</span> <span class="free">x</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Merkle_Interface-refl_pointfree"><span class="command">lemma</span></span> refl_pointfree<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> <span class="free">bo</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_onpE <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> refl<span class="main">)</span>

<span class="keyword1" id="Merkle_Interface-blinding_respects_hashes"><span class="command">lemma</span></span> blinding_respects_hashes<span class="main">:</span> <span class="quoted"><span class="quoted">"blinding_respects_hashes <span class="free">h</span> <span class="free">bo</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> hash <span class="main">=</span> hash

<span class="keyword1" id="Merkle_Interface-trans_pointfree"><span class="command">lemma</span></span> trans_pointfree<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">OO</span> <span class="free">bo</span> <span class="keyword1">OO</span> <span class="free">bo</span> <span class="main">≤</span> <span class="free">bo</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_onpE <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main">)</span>

<span class="keyword1" id="Merkle_Interface-antisym_pointfree"><span class="command">lemma</span></span> antisym_pointfree<span class="main">:</span> <span class="quoted"><span class="quoted">"inf <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">OO</span> <span class="free">bo</span><span class="main">)</span> <span class="free">bo</span><span class="main">¯¯</span> <span class="main">≤</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_onpE <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> antisym<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Merging ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ In general, we prove the properties of blinding before the properties of merging. Thus,
  in the following definitions we assume that the blinding properties already hold on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">UNIV</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Ball</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> restricts the argument of the merge operation on which induction will be done. ›</span></span>

<span class="keyword1"><span class="command">locale</span></span> merge_on <span class="main">=</span>
  blinding_of_on <span class="quoted">UNIV</span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> blinding_of"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> merge"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> join<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h</span> <span class="free">a</span> <span class="main">=</span> <span class="free">h</span> <span class="free">b</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="free">m</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> <span class="free">bo</span> <span class="free">a</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="free">bo</span> <span class="free">b</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="free">bo</span> <span class="free">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="free">bo</span> <span class="free">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="free">bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> undefined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">h</span> <span class="free">b</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> None"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Merkle_Interface-same"><span class="command">lemma</span></span> same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">m</span> <span class="free">a</span> <span class="free">a</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> join<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> antisym<span class="main">)</span>

<span class="keyword1" id="Merkle_Interface-blinding_of_antisym_on"><span class="command">lemma</span></span> blinding_of_antisym_on<span class="main">:</span> <span class="quoted"><span class="quoted">"blinding_of_on UNIV <span class="free">h</span> <span class="free">bo</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Merkle_Interface-transp"><span class="command">lemma</span></span> transp<span class="main">:</span> <span class="quoted"><span class="quoted">"transp <span class="free">bo</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> transpI trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> hash <span class="main">=</span> hash
  <span class="keyword2"><span class="keyword">and</span></span> refl <span class="main">=</span> refl
  <span class="keyword2"><span class="keyword">and</span></span> antisym <span class="main">=</span> antisym<span class="main">[</span><span class="operator">OF</span> _ _ UNIV_I<span class="main">]</span>

<span class="keyword1" id="Merkle_Interface-respects_hashes"><span class="command">lemma</span></span> respects_hashes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">h</span> <span class="free">a</span> <span class="main">=</span> <span class="free">h</span> <span class="free">b</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="free">m</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> Some <span class="bound">ab</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> join undefined
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Merkle_Interface-join'"><span class="command">lemma</span></span> join'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">ab</span><span class="main">.</span> <span class="free">m</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">⟷</span> <span class="free">bo</span> <span class="free">a</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="free">bo</span> <span class="free">b</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="free">bo</span> <span class="free">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="free">bo</span> <span class="free">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="free">bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> join undefined
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> hash local.antisym option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.sel predicate2D vimage2p_def<span class="main">)</span>

<span class="keyword1" id="Merkle_Interface-merge_on_subset"><span class="command">lemma</span></span> merge_on_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> merge_on <span class="free">B</span> <span class="free">h</span> <span class="free">bo</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> same join undefined<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Interface equality ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Here, we prove that the auxiliary definitions specify the same interface as the original ones.›</span></span>

<span class="keyword1" id="Merkle_Interface-merkle_interface_aux"><span class="command">lemma</span></span> merkle_interface_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"merkle_interface <span class="free">h</span> <span class="free">bo</span> <span class="free">m</span> <span class="main">=</span> merge_on UNIV <span class="free">h</span> <span class="free">bo</span> <span class="free">m</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> merkle_interface <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="quoted"><span class="free">m</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> that<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="main">≤</span> vimage2p <span class="free">h</span> <span class="free">h</span> <span class="main">(=)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> hash<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="skolem">x</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> reflp <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reflp_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword1"><span class="command">using</span></span> transp that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> transpD<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword1"><span class="command">using</span></span> antisymp that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> antisympD<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> <span class="free">bo</span> <span class="skolem">a</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="free">bo</span> <span class="skolem">b</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="free">bo</span> <span class="skolem">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="free">bo</span> <span class="skolem">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="free">bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">h</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_respects_hashes join<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="free">h</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_respects_hashes<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> merge_on <span class="quoted">UNIV</span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="quoted"><span class="free">m</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> that<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">h</span> <span class="skolem">b</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> respects_hashes<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> idem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">a</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> same<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> <span class="free">m</span> <span class="skolem">b</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> 
      <span class="keyword1"><span class="command">using</span></span> join<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> join<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> undefined antisym <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> undefined_partitioned<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">a</span> <span class="skolem">c</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="main">=</span> Some <span class="skolem">bc</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">bc</span>
      <span class="keyword1"><span class="command">using</span></span> that eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> merge_twice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="skolem">c</span> <span class="main">⟹</span> <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">c</span> <span class="main">=</span> Some <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join'<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">⤜</span> <span class="free">m</span> <span class="skolem">c</span> <span class="main">=</span> <span class="free">m</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="main">⤜</span> <span class="free">m</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Option.bind_split<span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"None <span class="main">=</span> <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">d</span> <span class="keyword1"><span class="command">using</span></span> that
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> undefined_partitioned merge_twice<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">d</span> <span class="keyword1"><span class="command">using</span></span> that
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> commute merge_twice undefined_partitioned<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ab</span> <span class="skolem">bc</span>
      <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="skolem">ab</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="main">=</span> Some <span class="skolem">bc</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cab</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">abc</span></span> <span class="keyword2"><span class="keyword">where</span></span> cab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">c</span> <span class="skolem">ab</span> <span class="main">=</span> Some <span class="skolem">cab</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> abc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">a</span> <span class="skolem">bc</span> <span class="main">=</span> Some <span class="skolem">abc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq<span class="main">[</span><span class="operator">THEN</span> iffD2<span class="main">,</span> <span class="operator">OF</span> exI<span class="main">]</span> eq<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> merge_twice<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">c</span> <span class="skolem">ab</span> <span class="main">=</span> <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">bc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join'<span class="main">)</span><span class="main">(</span><span class="operator">metis</span> UNIV_I abc cab local.antisym local.trans<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">⟷</span> <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> idem join' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Merkle_Interface-merkle_interfaceI"><span class="command">lemma</span></span> merkle_interfaceI <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"merge_on UNIV <span class="free">h</span> <span class="free">bo</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="free">h</span> <span class="free">bo</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> merkle_interface_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> merkle_interface<span class="main">)</span> merkle_interfaceD<span class="main">:</span> <span class="quoted"><span class="quoted">"merge_on UNIV <span class="free">h</span> <span class="free">bo</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> merkle_interface_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Parametricity rules ›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">parametric_constant</span></span> le_fun_parametric<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> le_fun_def
<span class="keyword1"><span class="command">parametric_constant</span></span> vimage2p_parametric<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> vimage2p_def
<span class="keyword1"><span class="command">parametric_constant</span></span> blinding_respects_hashes_parametric_aux<span class="main">:</span> blinding_respects_hashes_def

<span class="keyword1" id="Merkle_Interface-blinding_respects_hashes_parametric"><span class="command">lemma</span></span> blinding_respects_hashes_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A1</span> <span class="main">===&gt;</span> <span class="free">A2</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">A1</span> <span class="main">===&gt;</span> <span class="free">A1</span> <span class="main">===&gt;</span> <span class="main">(⟷)</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(⟷)</span><span class="main">)</span>
   blinding_respects_hashes blinding_respects_hashes"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique <span class="free">A2</span>"</span></span> <span class="quoted"><span class="quoted">"bi_total <span class="free">A1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> blinding_respects_hashes_parametric_aux that le_fun_parametric <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">parametric_constant</span></span> blinding_of_on_axioms_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  blinding_of_on_axioms_def<span class="main">[</span><span class="operator">folded</span> Ball_def<span class="main">,</span> <span class="operator">unfolded</span> le_fun_def le_bool_def eq_onp_def relcompp.simps<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">parametric_constant</span></span> blinding_of_on_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> blinding_of_on_def
<span class="keyword1"><span class="command">parametric_constant</span></span> antisymp_parametric<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> antisymp_def
<span class="keyword1"><span class="command">parametric_constant</span></span> transp_parametric<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> transp_def

<span class="keyword1"><span class="command">parametric_constant</span></span> merge_on_axioms_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> merge_on_axioms_def
<span class="keyword1"><span class="command">parametric_constant</span></span> merge_on_parametric<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> merge_on_def

<span class="keyword1"><span class="command">parametric_constant</span></span> merkle_interface_parametric<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> merkle_interface_def
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="ADS_Construction">
<div class="head">
<h1>Theory ADS_Construction</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Andreas Lochbihler, Digital Asset
   Author: Ognjen Maric, Digital Asset *)</span>

<span class="keyword1"><span class="command">theory</span></span> ADS_Construction <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Merkle_Interface">Merkle_Interface</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Simps_Case_Conv.html">HOL-Library.Simps_Case_Conv</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Building blocks for authenticated data structures on datatypes ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Building Block: Identity Functor ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If nothing is blindable in a type, then the type itself is the hash and the ADS of itself.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_discrete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">hash_discrete</span> <span class="main">≡</span> id"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">blinding_of_discrete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_discrete</span> <span class="main">≡</span> <span class="main">(=)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_discrete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_discrete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="ADS_Construction-blinding_of_discrete_hash"><span class="command">lemma</span></span> blinding_of_discrete_hash<span class="main">:</span>
  <span class="quoted"><span class="quoted">"blinding_of_discrete <span class="main">≤</span> vimage2p hash_discrete hash_discrete <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage2p_def<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-blinding_of_on_discrete"><span class="command">lemma</span></span> blinding_of_on_discrete <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"blinding_of_on UNIV hash_discrete blinding_of_discrete"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> OO_eq eq_onp_def blinding_of_discrete_hash<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-merge_on_discrete"><span class="command">lemma</span></span> merge_on_discrete <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"merge_on UNIV hash_discrete blinding_of_discrete merge_discrete"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_discrete_def<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-merkle_discrete"><span class="command">lemma</span></span> merkle_discrete <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"merkle_interface hash_discrete blinding_of_discrete merge_discrete"</span></span>
  <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">parametric_constant</span></span> merge_discrete_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> merge_discrete_def

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Example: instantiation for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">unit</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_unit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unit<span class="main">,</span> unit<span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">hash_unit</span> <span class="main">≡</span> hash_discrete"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">blinding_of_unit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_unit</span> <span class="main">≡</span> blinding_of_discrete"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">merge_unit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">merge_unit</span> <span class="main">≡</span> merge_discrete"</span></span>

<span class="keyword1" id="ADS_Construction-blinding_of_unit_hash"><span class="command">lemma</span></span> blinding_of_unit_hash<span class="main">:</span>
  <span class="quoted"><span class="quoted">"blinding_of_unit <span class="main">≤</span> vimage2p hash_unit hash_unit <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> blinding_of_discrete_hash<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-blinding_of_on_unit"><span class="command">lemma</span></span> blinding_of_on_unit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"blinding_of_on UNIV hash_unit blinding_of_unit"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> blinding_of_on_discrete<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-merge_on_unit"><span class="command">lemma</span></span> merge_on_unit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"merge_on UNIV hash_unit blinding_of_unit merge_unit"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> merge_on_discrete<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-merkle_interface_unit"><span class="command">lemma</span></span> merkle_interface_unit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"merkle_interface hash_unit blinding_of_unit merge_unit"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> merkle_interfaceI merge_on_unit<span class="main">)</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Building Block: Blindable Position ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> blindable <span class="main">=</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The following type represents the hashes of a datatype. We model hashes as being injective,
  but not surjective; some hashes do not correspond to any values of the original datatypes. We
  model such values as "garbage" coming from a countable set (here, naturals). ›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> garbage <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> blindable<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> Content <span class="tfree"><span class="quoted"><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span></span></span> <span class="main">|</span> Garbage <span class="quoted">garbage</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> blindable<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> Unblinded <span class="tfree"><span class="quoted"><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span></span></span> <span class="main">|</span> Blinded <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> blindable<span class="hidden">⇩</span><sub>h</sub>"</span></span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Hashes ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">hash_blindable'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> blindable<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> blindable<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_blindable'</span> <span class="main">(</span>Unblinded <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Content <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">hash_blindable'</span> <span class="main">(</span>Blinded <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hash_blindable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> blindable<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> blindable<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_blindable</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> hash_blindable' <span class="main">∘</span> map_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">h</span></span></span> id"</span></span>

<span class="keyword1" id="ADS_Construction-hash_blindable_simps"><span class="command">lemma</span></span> hash_blindable_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"hash_blindable <span class="free">h</span> <span class="main">(</span>Unblinded <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Content <span class="main">(</span><span class="free">h</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"hash_blindable <span class="free">h</span> <span class="main">(</span>Blinded <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hash_blindable_def blindable<span class="hidden">⇩</span><sub>h</sub>.map_id<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-hash_map_blindable_simp"><span class="command">lemma</span></span> hash_map_blindable_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hash_blindable <span class="free">f</span> <span class="main">(</span>map_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="free">f'</span> id <span class="free">x</span><span class="main">)</span> <span class="main">=</span> hash_blindable <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">f'</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hash_blindable_def blindable<span class="hidden">⇩</span><sub>h</sub>.map_comp<span class="main">)</span>

<span class="keyword1"><span class="command">parametric_constant</span></span> hash_blindable'_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> hash_blindable'_def

<span class="keyword1"><span class="command">parametric_constant</span></span> hash_blindable_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> hash_blindable_def

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Blinding ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> blinding_of"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">blinding_of_blindable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> blindable<span class="hidden">⇩</span><sub>m</sub> blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_blindable</span> <span class="main">(</span>Unblinded <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Unblinded <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">blinding_of_blindable</span> <span class="main">(</span>Blinded <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"hash_blindable <span class="free">h</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_simps</span></span> blinding_of_blindable_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"blinding_of_blindable <span class="main">(</span>Unblinded <span class="free">x</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="quoted"><span class="quoted">"blinding_of_blindable <span class="main">(</span>Blinded <span class="free">x</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="quoted"><span class="quoted">"blinding_of_blindable <span class="free">z</span> <span class="main">(</span>Unblinded <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"blinding_of_blindable <span class="free">z</span> <span class="main">(</span>Blinded <span class="free">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_simps</span></span> blinding_of_blindable_simps2<span class="main">:</span>
   <span class="quoted"><span class="quoted">"blinding_of_blindable <span class="main">(</span>Unblinded <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Unblinded <span class="free">y</span><span class="main">)</span>"</span></span>
   <span class="quoted"><span class="quoted">"blinding_of_blindable <span class="main">(</span>Unblinded <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Blinded <span class="free">y'</span><span class="main">)</span>"</span></span>
   <span class="quoted"><span class="quoted">"blinding_of_blindable <span class="main">(</span>Blinded <span class="free">x'</span><span class="main">)</span> <span class="main">(</span>Unblinded <span class="free">y</span><span class="main">)</span>"</span></span>
   <span class="quoted"><span class="quoted">"blinding_of_blindable <span class="main">(</span>Blinded <span class="free">x'</span><span class="main">)</span> <span class="main">(</span>Blinded <span class="free">y'</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="ADS_Construction-blinding_of_blindable_mono"><span class="command">lemma</span></span> blinding_of_blindable_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="main">≤</span> <span class="free">bo'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_blindable <span class="free">h</span> <span class="free">bo</span> <span class="main">≤</span> blinding_of_blindable <span class="free">h</span> <span class="free">bo'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> predicate2I<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> blinding_of_blindable.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">hypsubst</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> blinding_of_blindable.intros<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> blinding_of_blindable.intros<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ADS_Construction-blinding_of_blindable_hash"><span class="command">lemma</span></span> blinding_of_blindable_hash<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="main">≤</span> vimage2p <span class="free">h</span> <span class="free">h</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_blindable <span class="free">h</span> <span class="free">bo</span> <span class="main">≤</span> vimage2p <span class="main">(</span>hash_blindable <span class="free">h</span><span class="main">)</span> <span class="main">(</span>hash_blindable <span class="free">h</span><span class="main">)</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> predicate2I vimage2pI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> blinding_of_blindable.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">hypsubst</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">THEN</span> predicate2D<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage2p_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ADS_Construction-blinding_of_on_blindable"><span class="command">lemma</span></span> blinding_of_on_blindable <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="free">A</span> <span class="free">h</span> <span class="free">bo</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span> <span class="main">(</span>hash_blindable <span class="free">h</span><span class="main">)</span> <span class="main">(</span>blinding_of_blindable <span class="free">h</span> <span class="free">bo</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> blinding_of_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="main">≤</span> vimage2p <span class="var">?h</span> <span class="var">?h</span> <span class="main">(=)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> blinding_of_blindable_hash<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> hash<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refl<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blinding_of_blindable.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trans blinding_hash_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blinding_of_blindable.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> blinding_of_blindable <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> blinding_of_on_blindable<span class="main">[</span><span class="operator">of</span> <span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1"><span class="command">case_of_simps</span></span> blinding_of_blindable_alt_def<span class="main">:</span> blinding_of_blindable_simps2
<span class="keyword1"><span class="command">parametric_constant</span></span> blinding_of_blindable_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> blinding_of_blindable_alt_def

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Merging ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> merge"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_blindable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> blindable<span class="hidden">⇩</span><sub>m</sub> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_blindable</span> <span class="main">(</span>Unblinded <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Unblinded <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> map_option Unblinded <span class="main">(</span><span class="free">m</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_blindable</span> <span class="main">(</span>Blinded <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Unblinded <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Content <span class="main">(</span><span class="free">h</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="main">(</span>Unblinded <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_blindable</span> <span class="main">(</span>Unblinded <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>Blinded <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Content <span class="main">(</span><span class="free">h</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="main">(</span>Unblinded <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_blindable</span> <span class="main">(</span>Blinded <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>Blinded <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>Blinded <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="ADS_Construction-merge_on_blindable"><span class="command">lemma</span></span> merge_on_blindable <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="free">A</span> <span class="free">h</span> <span class="free">bo</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span> <span class="main">(</span>hash_blindable <span class="free">h</span><span class="main">)</span> <span class="main">(</span>blinding_of_blindable <span class="free">h</span> <span class="free">bo</span><span class="main">)</span> merge_blindable"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span> <span class="var">?m</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> merge_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="quoted"><span class="free">m</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">=</span> <span class="var">?h</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_blindable.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refl <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> join<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="var">?h</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> 
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_blindable.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> undefined<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> merge_blindable <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> 
  merge_on_blindable<span class="main">[</span><span class="operator">of</span> <span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="ADS_Construction-merge_blindable_alt_def"><span class="command">lemma</span></span> merge_blindable_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"merge_blindable <span class="free">h</span> <span class="free">m</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>Unblinded <span class="bound">x</span><span class="main">,</span> Unblinded <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> map_option Unblinded <span class="main">(</span><span class="free">m</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>Blinded <span class="bound">x</span><span class="main">,</span> Unblinded <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> Content <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span> <span class="keyword1">then</span> Some <span class="main">(</span>Unblinded <span class="bound">y</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>Unblinded <span class="bound">y</span><span class="main">,</span> Blinded <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> Content <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span> <span class="keyword1">then</span> Some <span class="main">(</span>Unblinded <span class="bound">y</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>Blinded <span class="bound">t</span><span class="main">,</span> Blinded <span class="bound">u</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">t</span> <span class="main">=</span> <span class="bound">u</span> <span class="keyword1">then</span> Some <span class="main">(</span>Blinded <span class="bound">u</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> blindable<span class="hidden">⇩</span><sub>m</sub>.split blindable<span class="hidden">⇩</span><sub>h</sub>.split<span class="main">)</span>

<span class="keyword1"><span class="command">parametric_constant</span></span> merge_blindable_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> merge_blindable_alt_def

<span class="keyword1" id="ADS_Construction-merge_blindable_cong"><span class="command">lemma</span></span> merge_blindable_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">∈</span> set1_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span><span class="main">;</span> <span class="bound">b</span> <span class="main">∈</span> set1_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">m'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_blindable <span class="free">h</span> <span class="free">m</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> merge_blindable <span class="free">h</span> <span class="free">m'</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_blindable_alt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> blindable<span class="hidden">⇩</span><sub>m</sub>.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"map_option <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Merkle interface ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1" id="ADS_Construction-merkle_blindable"><span class="command">lemma</span></span> merkle_blindable <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="free">h</span> <span class="free">bo</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="main">(</span>hash_blindable <span class="free">h</span><span class="main">)</span> <span class="main">(</span>blinding_of_blindable <span class="free">h</span> <span class="free">bo</span><span class="main">)</span> <span class="main">(</span>merge_blindable <span class="free">h</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> merge_on <span class="quoted">UNIV</span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="quoted"><span class="free">m</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merkle_interface_aux<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> merkle_interface_aux <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Non-recursive blindable positions ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ For a non-recursive data type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the type of hashes in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> blindable<span class="hidden">⇩</span><sub>m</sub><span class="antiquote"><span class="antiquote">}</span></span></span></span> is fixed
to be simply <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> blindable<span class="hidden">⇩</span><sub>h</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. We obtain this by instantiating the type variable with the
identity building block. ›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> nr_blindable <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> blindable<span class="hidden">⇩</span><sub>m</sub>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">hash_nr_blindable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> nr_blindable<span class="main">,</span> <span class="tfree">'a</span> blindable<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_nr_blindable</span> <span class="main">≡</span> hash_blindable hash_discrete"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">blinding_of_nr_blindable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nr_blindable blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_nr_blindable</span> <span class="main">≡</span> blinding_of_blindable hash_discrete blinding_of_discrete"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">merge_nr_blindable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nr_blindable merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_nr_blindable</span> <span class="main">≡</span> merge_blindable hash_discrete merge_discrete"</span></span>

<span class="keyword1" id="ADS_Construction-merge_on_nr_blindable"><span class="command">lemma</span></span> merge_on_nr_blindable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"merge_on UNIV hash_nr_blindable blinding_of_nr_blindable merge_nr_blindable"</span></span>
  <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="ADS_Construction-merkle_nr_blindable"><span class="command">lemma</span></span> merkle_nr_blindable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"merkle_interface hash_nr_blindable blinding_of_nr_blindable merge_nr_blindable"</span></span>
  <span class="keyword1"><span class="command">..</span></span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Building block: Sums ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We prove that we can lift the ADS construction through sums.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> sum<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">+</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
<span class="keyword1"><span class="command">type_notation</span></span> sum<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">+<span class="hidden">⇩</span><sub>h</sub></span>"</span> 10<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> sum<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">+</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span>"</span></span>
  <span class="comment1">― ‹If a functor does not introduce blindable positions, then we don't need the type variable copies.›</span>
<span class="keyword1"><span class="command">type_notation</span></span> sum<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">+<span class="hidden">⇩</span><sub>m</sub></span>"</span> 10<span class="main">)</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Hashes ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_sum'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>h</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>h</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_sum'</span> <span class="main">≡</span> id"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_sum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>m</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>h</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">hash_sum</span> <span class="main">≡</span> map_sum"</span></span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Blinding ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">blinding_of_sum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> blinding_of <span class="main">⇒</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> blinding_of <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>m</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_sum</span> <span class="main">≡</span> rel_sum"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> blinding_of_sum_mono <span class="main">=</span> sum.rel_mono

<span class="keyword1" id="ADS_Construction-blinding_of_sum_hash"><span class="command">lemma</span></span> blinding_of_sum_hash<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">boa</span> <span class="main">≤</span> vimage2p <span class="free">rha</span> <span class="free">rha</span> <span class="main">(=)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bob</span> <span class="main">≤</span> vimage2p <span class="free">rhb</span> <span class="free">rhb</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_sum <span class="free">boa</span> <span class="free">bob</span> <span class="main">≤</span> vimage2p <span class="main">(</span>hash_sum <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(</span>hash_sum <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage2p_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_sum.cases<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-blinding_of_on_sum"><span class="command">lemma</span></span> blinding_of_on_sum <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="free">A</span> <span class="free">rha</span> <span class="free">boa</span>"</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="free">B</span> <span class="free">rhb</span> <span class="free">bob</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> setl <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> setr <span class="bound">x</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span> <span class="main">(</span>hash_sum <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(</span>blinding_of_sum <span class="free">boa</span> <span class="free">bob</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> blinding_of_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">rha</span></span> <span class="quoted"><span class="free">boa</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> b<span class="main">:</span> blinding_of_on <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">rhb</span></span> <span class="quoted"><span class="free">bob</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> sum.rel_refl_strong<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a.refl b.refl<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_sum.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> a.trans b.trans<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> 
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_sum.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> a.antisym b.antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">rule</span> blinding_of_sum_hash a.hash b.hash<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> blinding_of_sum <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> blinding_of_on_sum<span class="main">[</span><span class="operator">of</span> <span class="quoted">UNIV</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Merging ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> merge"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">mb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> merge"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_sum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1">+<span class="hidden">⇩</span><sub>m</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_sum</span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> map_option Inl <span class="main">(</span><span class="free">ma</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_sum</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> map_option Inr <span class="main">(</span><span class="free">mb</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_sum</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1" id="ADS_Construction-merge_on_sum"><span class="command">lemma</span></span> merge_on_sum <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="free">A</span> <span class="free">rha</span> <span class="free">boa</span> <span class="free">ma</span>"</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="free">B</span> <span class="free">rhb</span> <span class="free">bob</span> <span class="free">mb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> setl <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> setr <span class="bound">x</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span> <span class="main">(</span>hash_sum <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(</span>blinding_of_sum <span class="free">boa</span> <span class="free">bob</span><span class="main">)</span> merge_sum"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span> <span class="var">?m</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> merge_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">rha</span></span> <span class="quoted"><span class="free">boa</span></span> <span class="quoted"><span class="free">ma</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> b<span class="main">:</span> merge_on <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">rhb</span></span> <span class="quoted"><span class="free">bob</span></span> <span class="quoted"><span class="free">mb</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">=</span> <span class="var">?h</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_sum.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a.join b.join <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_sum.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="var">?h</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_sum.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a.undefined b.undefined<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> merge_sum <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> merge_on_sum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="ADS_Construction-merge_sum_alt_def"><span class="command">lemma</span></span> merge_sum_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"merge_sum <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>Inl <span class="bound">x</span><span class="main">,</span> Inl <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> map_option Inl <span class="main">(</span><span class="free">ma</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>Inr <span class="bound">x</span><span class="main">,</span> Inr <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> map_option Inr <span class="main">(</span><span class="free">mb</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="ADS_Construction-merge_sum_cong"><span class="command">lemma</span></span> merge_sum_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span><span class="main">;</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y'</span><span class="main">;</span> 
    <span class="main">⋀</span><span class="bound">xl</span> <span class="bound">yl</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">x</span> <span class="main">=</span> Inl <span class="bound">xl</span><span class="main">;</span> <span class="free">y</span> <span class="main">=</span> Inl <span class="bound">yl</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ma</span> <span class="bound">xl</span> <span class="bound">yl</span> <span class="main">=</span> <span class="free">ma'</span> <span class="bound">xl</span> <span class="bound">yl</span><span class="main">;</span>
    <span class="main">⋀</span><span class="bound">xr</span> <span class="bound">yr</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">x</span> <span class="main">=</span> Inr <span class="bound">xr</span><span class="main">;</span> <span class="free">y</span> <span class="main">=</span> Inr <span class="bound">yr</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">mb</span> <span class="bound">xr</span> <span class="bound">yr</span> <span class="main">=</span> <span class="free">mb'</span> <span class="bound">xr</span> <span class="bound">yr</span> <span class="main">⟧</span> <span class="main">⟹</span>
    merge_sum <span class="free">ma</span> <span class="free">mb</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> merge_sum <span class="free">ma'</span> <span class="free">mb'</span> <span class="free">x'</span> <span class="free">y'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">parametric_constant</span></span> merge_sum_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> merge_sum_alt_def

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Merkle interface ›</span></span>

<span class="keyword1" id="ADS_Construction-merkle_sum"><span class="command">lemma</span></span> merkle_sum <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="free">rha</span> <span class="free">boa</span> <span class="free">ma</span>"</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="free">rhb</span> <span class="free">bob</span> <span class="free">mb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="main">(</span>hash_sum <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(</span>blinding_of_sum <span class="free">boa</span> <span class="free">bob</span><span class="main">)</span> <span class="main">(</span>merge_sum <span class="free">ma</span> <span class="free">mb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> merge_on <span class="quoted">UNIV</span> <span class="quoted"><span class="free">rha</span></span> <span class="quoted"><span class="free">boa</span></span> <span class="quoted"><span class="free">ma</span></span> <span class="keyword1"><span class="command">unfolding</span></span> merkle_interface_aux<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> b<span class="main">:</span> merge_on <span class="quoted">UNIV</span> <span class="quoted"><span class="free">rhb</span></span> <span class="quoted"><span class="free">bob</span></span> <span class="quoted"><span class="free">mb</span></span> <span class="keyword1"><span class="command">unfolding</span></span> merkle_interface_aux<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> merkle_interface_aux<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Building Block: Products›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We prove that we can lift the ADS construction through products.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> prod<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">×</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
<span class="keyword1"><span class="command">type_notation</span></span> prod<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>21<span class="main">,</span> 20<span class="main">]</span> 20<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> prod<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">×</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span>"</span></span>
  <span class="comment1">― ‹If a functor does not introduce blindable positions, then we don't need the type variable copies.›</span>
<span class="keyword1"><span class="command">type_notation</span></span> prod<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">×<span class="hidden">⇩</span><sub>m</sub></span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>21<span class="main">,</span> 20<span class="main">]</span> 20<span class="main">)</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Hashes ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_prod'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_prod'</span> <span class="main">≡</span> id"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_prod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>m</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">hash_prod</span> <span class="main">≡</span> map_prod"</span></span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Blinding ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">blinding_of_prod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> blinding_of <span class="main">⇒</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> blinding_of <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>m</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_prod</span> <span class="main">≡</span> rel_prod"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> blinding_of_prod_mono <span class="main">=</span> prod.rel_mono

<span class="keyword1" id="ADS_Construction-blinding_of_prod_hash"><span class="command">lemma</span></span> blinding_of_prod_hash<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">boa</span> <span class="main">≤</span> vimage2p <span class="free">rha</span> <span class="free">rha</span> <span class="main">(=)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bob</span> <span class="main">≤</span> vimage2p <span class="free">rhb</span> <span class="free">rhb</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_prod <span class="free">boa</span> <span class="free">bob</span> <span class="main">≤</span> vimage2p <span class="main">(</span>hash_prod <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(</span>hash_prod <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage2p_def<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-blinding_of_on_prod"><span class="command">lemma</span></span> blinding_of_on_prod <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="free">A</span> <span class="free">rha</span> <span class="free">boa</span>"</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="free">B</span> <span class="free">rhb</span> <span class="free">bob</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> fsts <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> snds <span class="bound">x</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span> <span class="main">(</span>hash_prod <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(</span>blinding_of_prod <span class="free">boa</span> <span class="free">bob</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> blinding_of_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">rha</span></span> <span class="quoted"><span class="free">boa</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> b<span class="main">:</span> blinding_of_on <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">rhb</span></span> <span class="quoted"><span class="free">bob</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a.refl b.refl<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_prod.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> a.trans b.trans<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_prod.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> a.antisym b.antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">rule</span> blinding_of_prod_hash a.hash b.hash<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> blinding_of_prod <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> blinding_of_on_prod<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Merging ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> merge"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">mb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> merge"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_prod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>m</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_prod</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">)</span> <span class="main">=</span> Option.bind <span class="main">(</span><span class="free">ma</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x''</span><span class="main">.</span> map_option <span class="main">(</span>Pair <span class="bound">x''</span><span class="main">)</span> <span class="main">(</span><span class="free">mb</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ADS_Construction-merge_on_prod"><span class="command">lemma</span></span> merge_on_prod <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="free">A</span> <span class="free">rha</span> <span class="free">boa</span> <span class="free">ma</span>"</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="free">B</span> <span class="free">rhb</span> <span class="free">bob</span> <span class="free">mb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> fsts <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> snds <span class="bound">x</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span> <span class="main">(</span>hash_prod <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(</span>blinding_of_prod <span class="free">boa</span> <span class="free">bob</span><span class="main">)</span> merge_prod"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span> <span class="var">?m</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> merge_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">rha</span></span> <span class="quoted"><span class="free">boa</span></span> <span class="quoted"><span class="free">ma</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> b<span class="main">:</span> merge_on <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">rhb</span></span> <span class="quoted"><span class="free">bob</span></span> <span class="quoted"><span class="free">mb</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">=</span> <span class="var">?h</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_prod.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a.join b.join<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="var">?h</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_prod.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a.undefined b.undefined<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> merge_prod <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> merge_on_prod<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="ADS_Construction-merge_prod_alt_def"><span class="command">lemma</span></span> merge_prod_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"merge_prod <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">y'</span><span class="main">)</span><span class="main">.</span> Option.bind <span class="main">(</span><span class="free">ma</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x''</span><span class="main">.</span> map_option <span class="main">(</span>Pair <span class="bound">x''</span><span class="main">)</span> <span class="main">(</span><span class="free">mb</span> <span class="bound">y</span> <span class="bound">y'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="ADS_Construction-merge_prod_cong"><span class="command">lemma</span></span> merge_prod_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">∈</span> fsts <span class="free">p1</span><span class="main">;</span> <span class="bound">b</span> <span class="main">∈</span> fsts <span class="free">p2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ma</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">ma'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">∈</span> snds <span class="free">p1</span><span class="main">;</span> <span class="bound">b</span> <span class="main">∈</span> snds <span class="free">p2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">mb</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">mb'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_prod <span class="free">ma</span> <span class="free">mb</span> <span class="free">p1</span> <span class="free">p2</span> <span class="main">=</span> merge_prod <span class="free">ma'</span> <span class="free">mb'</span> <span class="free">p1</span> <span class="free">p2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">p2</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">parametric_constant</span></span> merge_prod_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> merge_prod_alt_def

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Merkle Interface ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1" id="ADS_Construction-merkle_product"><span class="command">lemma</span></span> merkle_product <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="free">rha</span> <span class="free">boa</span> <span class="free">ma</span>"</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="free">rhb</span> <span class="free">bob</span> <span class="free">mb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="main">(</span>hash_prod <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(</span>blinding_of_prod <span class="free">boa</span> <span class="free">bob</span><span class="main">)</span> <span class="main">(</span>merge_prod <span class="free">ma</span> <span class="free">mb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> merge_on <span class="quoted">UNIV</span> <span class="quoted"><span class="free">rha</span></span> <span class="quoted"><span class="free">boa</span></span> <span class="quoted"><span class="free">ma</span></span> <span class="keyword1"><span class="command">unfolding</span></span> merkle_interface_aux<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> b<span class="main">:</span> merge_on <span class="quoted">UNIV</span> <span class="quoted"><span class="free">rhb</span></span> <span class="quoted"><span class="free">bob</span></span> <span class="quoted"><span class="free">mb</span></span> <span class="keyword1"><span class="command">unfolding</span></span> merkle_interface_aux<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> merkle_interface_aux<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Building Block: Lists›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The ADS construction on lists is done the easiest through a separate isomorphic datatype
  that has only a single constructor. We hide this construction in a locale. ›</span></span>

<span class="keyword1"><span class="command">locale</span></span> list_R1 <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> list_F <span class="main">=</span> <span class="quoted"><span class="quoted">"unit <span class="main">+</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">set_base_F<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> setr <span class="bound">x</span> <span class="main">⤜</span> fsts"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">set_rec_F<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">A</span><span class="main">.</span> setr <span class="bound">A</span> <span class="main">⤜</span> snds"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">map_F</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">fb</span> <span class="bound">fr</span><span class="main">.</span> map_sum id <span class="main">(</span>map_prod <span class="bound">fb</span> <span class="bound">fr</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> list_R1 <span class="main">=</span> list_R1 <span class="main">(</span><span class="free"><span class="entity">unR</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span> list_R1<span class="main">)</span> list_F"</span></span><span class="main">)</span>

<span class="keyword1" id="ADS_Construction-list_R1_const_into_dest"><span class="command">lemma</span></span> list_R1_const_into_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"list_R1 <span class="free">F</span> <span class="main">=</span> <span class="free">l</span> <span class="main">⟷</span> <span class="free">F</span> <span class="main">=</span> unR <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> list_R1.split<span class="main">[</span><span class="operator">split</span><span class="main">]</span>

<span class="keyword1" id="ADS_Construction-list_R1_induct"><span class="command">lemma</span></span> list_R1_induct<span class="main">[</span><span class="operator">case_names</span> list_R1<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">F</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">l'</span><span class="main">.</span> <span class="bound">l'</span> <span class="main">∈</span> set_rec_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">F</span>  <span class="main">⟹</span> <span class="free">P</span> <span class="bound">l'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>list_R1 <span class="bound">F</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">l</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> list_R1.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ADS_Construction-set_list_R1_eq"><span class="command">lemma</span></span> set_list_R1_eq<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> set_base_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> set_rec_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span> <span class="main">=</span>
   <span class="main">{</span><span class="bound">x</span><span class="main">.</span> setl <span class="bound">x</span> <span class="main">⊆</span> UNIV <span class="main">∧</span> setr <span class="bound">x</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> fsts <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> snds <span class="bound">x</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION<span class="main">)</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ The Isomorphism ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="main">(</span>transfer<span class="main">)</span> <span class="entity">list_R1_to_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list_R1 <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_R1_to_list</span> <span class="main">(</span>list_R1 <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> map_sum id <span class="main">(</span>map_prod id <span class="free">list_R1_to_list</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> Inl <span class="main">()</span> <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Inr <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ADS_Construction-list_R1_to_list_simps"><span class="command">lemma</span></span> list_R1_to_list_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_R1_to_list <span class="main">(</span>list_R1 <span class="main">(</span>Inl <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"list_R1_to_list <span class="main">(</span>list_R1 <span class="main">(</span>Inr <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> list_R1_to_list <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> unit.split<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> list_R1_to_list.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="main">(</span>transfer<span class="main">)</span> <span class="entity">list_to_list_R1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list_R1"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_to_list_R1</span> <span class="main">[]</span> <span class="main">=</span> list_R1 <span class="main">(</span>Inl <span class="main">()</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_to_list_R1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> list_R1 <span class="main">(</span>Inr <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free">list_to_list_R1</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ADS_Construction-R1_of_list"><span class="command">lemma</span></span> R1_of_list<span class="main">:</span> <span class="quoted"><span class="quoted">"list_R1_to_list <span class="main">(</span>list_to_list_R1 <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="ADS_Construction-list_of_R1"><span class="command">lemma</span></span> list_of_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_to_list_R1 <span class="main">(</span>list_R1_to_list <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ADS_Construction-list_R1_def"><span class="command">lemma</span></span> list_R1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"type_definition list_to_list_R1 list_R1_to_list UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R1_of_list list_of_R1<span class="main">)</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> list_R1_def

<span class="keyword1" id="ADS_Construction-map_list_R1_list_to_list_R1"><span class="command">lemma</span></span> map_list_R1_list_to_list_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"map_list_R1 <span class="free">f</span> <span class="main">(</span>list_to_list_R1 <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> list_to_list_R1 <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ADS_Construction-list_R1_map_trans"><span class="command">lemma</span></span> list_R1_map_trans <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">===&gt;</span> pcr_list <span class="main">(=)</span> <span class="main">===&gt;</span> pcr_list <span class="main">(=)</span><span class="main">)</span> map_list_R1 map"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pcr_cr_eq rel_fun_eq cr_list_def map_list_R1_list_to_list_R1<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-set_list_R1_list_to_list_R1"><span class="command">lemma</span></span> set_list_R1_list_to_list_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"set_list_R1 <span class="main">(</span>list_to_list_R1 <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ADS_Construction-list_R1_set_trans"><span class="command">lemma</span></span> list_R1_set_trans <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>pcr_list <span class="main">(=)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> set_list_R1 set"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pcr_cr_eq cr_list_def set_list_R1_list_to_list_R1<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-rel_list_R1_list_to_list_R1"><span class="command">lemma</span></span> rel_list_R1_list_to_list_R1<span class="main">:</span>
   <span class="quoted"><span class="quoted">"rel_list_R1 <span class="free">R</span> <span class="main">(</span>list_to_list_R1 <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>list_to_list_R1 <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> list_all2 <span class="free">R</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">=</span> list_to_list_R1 <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys'</span> <span class="main">=</span> list_to_list_R1 <span class="free">ys</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rel_list_R1 <span class="free">R</span> <span class="skolem">xs'</span> <span class="skolem">ys'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">(</span>list_R1_to_list <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span>list_R1_to_list <span class="skolem">ys'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_sum.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs'_def ys'_def R1_of_list<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ADS_Construction-list_R1_rel_trans"><span class="command">lemma</span></span> list_R1_rel_trans<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> <span class="main">(=)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">===&gt;</span> pcr_list <span class="main">(=)</span> <span class="main">===&gt;</span> pcr_list <span class="main">(=)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> rel_list_R1 list_all2"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pcr_cr_eq rel_fun_eq cr_list_def rel_list_R1_list_to_list_R1<span class="main">)</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Hashes ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> list_F<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"unit <span class="keyword1">+<span class="hidden">⇩</span><sub>h</sub></span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> list_F<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"unit <span class="keyword1">+<span class="hidden">⇩</span><sub>m</sub></span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>m</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> list_R1<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> list_R1"</span></span> 
  <span class="comment1">― ‹In theory, we should define a separate datatype here of the functor <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> list_F<span class="hidden">⇩</span><sub>h</sub>"</span><span class="antiquote">}</span></span>.
    We take a shortcut because they're isomorphic.›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> list_R1<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> list_R1"</span></span>
  <span class="comment1">― ‹In theory, we should define a separate datatype here of the functor <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> list_F<span class="hidden">⇩</span><sub>m</sub>"</span><span class="antiquote">}</span></span>.
    We take a shortcut because they're isomorphic.›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hash_F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> list_F<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> list_F<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">hash_F</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">rhL</span></span></span> <span class="main">=</span> hash_sum hash_unit <span class="main">(</span>hash_prod <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">rhL</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_R1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> list_R1<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> list_R1<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_R1</span> <span class="main">≡</span> map_list_R1"</span></span>

<span class="keyword1"><span class="command">parametric_constant</span></span> hash_F_parametric<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> hash_F_def

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Blinding ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">blinding_of_F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> blinding_of <span class="main">⇒</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> blinding_of <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> list_F<span class="hidden">⇩</span><sub>m</sub> blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_F</span> <span class="free"><span class="bound"><span class="entity">bo</span></span></span> <span class="free"><span class="bound"><span class="entity">bL</span></span></span> <span class="main">=</span> blinding_of_sum blinding_of_unit <span class="main">(</span>blinding_of_prod <span class="free"><span class="bound"><span class="entity">bo</span></span></span> <span class="free"><span class="bound"><span class="entity">bL</span></span></span><span class="main">)</span>"</span></span>
 
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">blinding_of_R1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> blinding_of <span class="main">⇒</span> <span class="tfree">'a</span> list_R1 blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_R1</span> <span class="main">≡</span> rel_list_R1"</span></span>

<span class="keyword1" id="ADS_Construction-blinding_of_hash_R1"><span class="command">lemma</span></span> blinding_of_hash_R1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="main">≤</span> vimage2p <span class="free">h</span> <span class="free">h</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_R1 <span class="free">bo</span> <span class="main">≤</span> vimage2p <span class="main">(</span>hash_R1 <span class="free">h</span><span class="main">)</span> <span class="main">(</span>hash_R1 <span class="free">h</span><span class="main">)</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> predicate2I vimage2pI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> predicate2D_vimage2p<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_R1.rel_induct rel_sum.cases rel_prod.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ADS_Construction-blinding_of_on_R1"><span class="command">lemma</span></span> blinding_of_on_R1 <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="free">A</span> <span class="free">h</span> <span class="free">bo</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set_list_R1 <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span> <span class="main">(</span>hash_R1 <span class="free">h</span><span class="main">)</span> <span class="main">(</span>blinding_of_R1 <span class="free">bo</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> blinding_of_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> hash<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="main">≤</span> vimage2p <span class="var">?h</span> <span class="var">?h</span> <span class="main">(=)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a.hash <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> blinding_of_hash_R1<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">x</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>list_R1 <span class="skolem">x</span> <span class="skolem">y'</span> <span class="skolem">z'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> list_R1.prems <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"set_base_F<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">x</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> list_R1.prems <span class="keyword1"><span class="command">have</span></span> s3<span class="main">:</span> <span class="quoted"><span class="quoted">"set_rec_F<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">x</span> <span class="main">⤜</span> set_list_R1 <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_bexI<span class="main">)</span>
     
      <span class="keyword1"><span class="command">interpret</span></span> F<span class="main">:</span> blinding_of_on <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> set_base_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">y</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> set_rec_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">y</span> <span class="main">⊆</span> set_rec_F<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">x</span><span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"hash_F <span class="free">h</span> <span class="main">(</span>hash_R1 <span class="free">h</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"blinding_of_F <span class="free">bo</span> <span class="main">(</span>blinding_of_R1 <span class="free">bo</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> hash_F_def blinding_of_F_def set_list_R1_eq
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"setr <span class="skolem">x</span> <span class="main">⤜</span> snds"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?bo'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rel_list_R1 <span class="free">bo</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo'</span> <span class="skolem">x</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> that list_R1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo'</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo'</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo'</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> 
          <span class="keyword1"><span class="command">using</span></span> that list_R1.IH<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> list_R1.prems
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION prod_set_defs<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo'</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo'</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
          <span class="keyword1"><span class="command">using</span></span> that list_R1.IH<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> list_R1.prems
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_set_defs<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">rule</span> hash<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> list_R1.prems
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> F.refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> s1 <span class="keyword1"><span class="command">unfolding</span></span> blinding_of_F_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_R1.rel_intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> s1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_R1.rel_cases F.trans<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> blinding_of_F_def<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_R1.rel_intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> s1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_R1.rel_cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> F.antisym<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> blinding_of_F_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">⟹</span> <span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">x</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">;</span> <span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">;</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">;</span> <span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">x</span><span class="main">;</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> blinding_of_R1 <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> blinding_of_on_R1<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1"><span class="command">parametric_constant</span></span> blinding_of_F_parametric<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> blinding_of_F_def

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Merging ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> merge <span class="main">⇒</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> merge <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> list_F<span class="hidden">⇩</span><sub>m</sub> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">merge_F</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">mL</span></span></span> <span class="main">=</span> merge_sum merge_unit <span class="main">(</span>merge_prod <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">mL</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ADS_Construction-merge_F_cong"><span class="command">lemma</span></span> merge_F_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">∈</span> set_base_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span><span class="main">;</span> <span class="bound">b</span> <span class="main">∈</span> set_base_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">m'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">∈</span> set_rec_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span><span class="main">;</span> <span class="bound">b</span> <span class="main">∈</span> set_rec_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">mL</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">mL'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_F <span class="free">m</span> <span class="free">mL</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> merge_F <span class="free">m'</span> <span class="free">mL'</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_F_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"map_option <span class="main"><span class="main">_</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> merge_prod_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> merge"</span></span> 
  <span class="keyword2"><span class="keyword">notes</span></span> setr.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_R1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> list_R1<span class="hidden">⇩</span><sub>m</sub> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_R1</span> <span class="main">(</span>list_R1 <span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">)</span> <span class="main">(</span>list_R1 <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">=</span> map_option list_R1 <span class="main">(</span>merge_F <span class="free">m</span> <span class="free">merge_R1</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">case_of_simps</span></span> merge_cases <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> merge_R1.simps

<span class="keyword1" id="ADS_Construction-merge_on_R1"><span class="command">lemma</span></span> merge_on_R1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="free">A</span> <span class="free">h</span> <span class="free">bo</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set_list_R1 <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">}</span> <span class="main">(</span>hash_R1 <span class="free">h</span><span class="main">)</span> <span class="main">(</span>blinding_of_R1 <span class="free">bo</span><span class="main">)</span> <span class="main">(</span>merge_R1 <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span> <span class="var">?m</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> merge_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="quoted"><span class="free">m</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?h</span> <span class="skolem">a</span> <span class="main">=</span> <span class="var">?h</span> <span class="skolem">b</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="var">?h</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="var">?h</span> <span class="skolem">b</span> <span class="main">⟶</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> mem_Collect_eq
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_R1_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> wfInd<span class="main">:</span> <span class="main">(</span>list_R1 <span class="skolem">l</span><span class="main">)</span>
      <span class="keyword1"><span class="command">interpret</span></span> merge_on <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> set_base_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">y</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> set_rec_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">y</span> <span class="main">⊆</span> set_rec_F<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">l</span><span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"hash_F <span class="free">h</span> <span class="var">?h</span>"</span></span> <span class="quoted"><span class="quoted">"blinding_of_F <span class="free">bo</span> <span class="var">?bo</span>"</span></span> <span class="quoted"><span class="quoted">"merge_F <span class="free">m</span> <span class="var">?m</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> set_list_R1_eq hash_F_def merge_F_def blinding_of_F_def
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
        <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set_rec_F<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> wfInd.prems <span class="keyword1"><span class="command">have</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"set_list_R1 <span class="skolem">a</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hash_R1 <span class="free">h</span> <span class="skolem">a</span> <span class="main">=</span> hash_R1 <span class="free">h</span> <span class="skolem">b</span>
           <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">ab</span> <span class="main">∧</span>
                    <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="var">?h</span> <span class="skolem">b</span> <span class="main">⟹</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span>      
          <span class="keyword1"><span class="command">using</span></span> wfInd.IH<span class="main">[</span><span class="operator">OF</span> a a'<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sym<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> wfInd.prems
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> conjI strip<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> join<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> hash_F_def<span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blinding_of_F_def UN_subset_iff list_R1.rel_sel<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> undefined<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> hash_F_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">=</span> <span class="var">?h</span> <span class="skolem">b</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="var">?h</span> <span class="skolem">b</span> <span class="main">⟹</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> merge_R1 <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> merge_on_R1<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="ADS_Construction-merkle_list_R1"><span class="command">lemma</span></span> merkle_list_R1 <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="free">h</span> <span class="free">bo</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="main">(</span>hash_R1 <span class="free">h</span><span class="main">)</span> <span class="main">(</span>blinding_of_R1 <span class="free">bo</span><span class="main">)</span> <span class="main">(</span>merge_R1 <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> merge_on <span class="quoted">UNIV</span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="quoted"><span class="free">m</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> merkle_interface_aux<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> merkle_interface_aux<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ADS_Construction-merge_R1_cong"><span class="command">lemma</span></span> merge_R1_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">∈</span> set_list_R1 <span class="free">x</span><span class="main">;</span> <span class="bound">b</span> <span class="main">∈</span> set_list_R1 <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">m'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_R1 <span class="free">m</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> merge_R1 <span class="free">m'</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_R1.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> merge_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"map_option <span class="main"><span class="main">_</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> merge_F_cong<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> bind_UNION<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">parametric_constant</span></span> merge_F_parametric<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> merge_F_def

<span class="keyword1" id="ADS_Construction-merge_R1_parametric"><span class="command">lemma</span></span> merge_R1_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> merge_cases
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">A</span> <span class="main">===&gt;</span> rel_option <span class="free">A</span><span class="main">)</span> <span class="main">===&gt;</span> rel_list_R1 <span class="free">A</span> <span class="main">===&gt;</span> rel_list_R1 <span class="free">A</span> <span class="main">===&gt;</span> rel_option <span class="main">(</span>rel_list_R1 <span class="free">A</span><span class="main">)</span><span class="main">)</span>
   merge_R1 merge_R1"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> rel_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> m1 m2 xs1 xs2 ys1 ys2 <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs1</span></span> <span class="quoted"><span class="skolem">ys1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">xs2</span></span> <span class="quoted"><span class="skolem">ys2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_R1.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">elim</span> list_R1.rel_cases rel_sum.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option.rel_map merge_F_def merge_discrete_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">elim</span> meta_allE<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Transferring the Constructions to Lists ›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> list<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> list<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> list"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> list_R1 <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> list<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> list<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">hash_list</span> <span class="main">≡</span> map"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">blinding_of_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> blinding_of <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> list<span class="hidden">⇩</span><sub>m</sub> blinding_of"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">blinding_of_list</span> <span class="main">≡</span> list_all2"</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> merge_list <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> merge <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> list<span class="hidden">⇩</span><sub>m</sub> merge"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">merge_R1</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="ADS_Construction-blinding_of_list_mono"><span class="command">lemma</span></span> blinding_of_list_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">bo</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">bo'</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟧</span> <span class="main">⟹</span> 
  blinding_of_list <span class="free">bo</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟶</span> blinding_of_list <span class="free">bo'</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_R1.rel_mono_strong<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> blinding_of_list_hash <span class="main">=</span> blinding_of_hash_R1<span class="main">[</span><span class="operator">Transfer.transferred</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> blinding_of_on_list <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> blinding_of_on_R1<span class="main">[</span><span class="operator">Transfer.transferred</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> blinding_of_list <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> blinding_of_R1<span class="main">[</span><span class="operator">Transfer.transferred</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> merge_on_list <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> merge_on_R1<span class="main">[</span><span class="operator">Transfer.transferred</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> merge_list <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> merge_R1<span class="main">[</span><span class="operator">Transfer.transferred</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> merge_list_cong <span class="main">=</span> merge_R1_cong<span class="main">[</span><span class="operator">Transfer.transferred</span><span class="main">]</span>

<span class="keyword1" id="ADS_Construction-blinding_of_list_mono_pred"><span class="command">lemma</span></span> blinding_of_list_mono_pred<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≤</span> <span class="free">R'</span> <span class="main">⟹</span> blinding_of_list <span class="free">R</span> <span class="main">≤</span> blinding_of_list <span class="free">R'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> list_R1.rel_mono<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-blinding_of_list_simp"><span class="command">lemma</span></span> blinding_of_list_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"blinding_of_list <span class="main">=</span> list_all2"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-merkle_list"><span class="command">lemma</span></span> merkle_list <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"merkle_interface <span class="free">h</span> <span class="free">bo</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="main">(</span>hash_list <span class="free">h</span><span class="main">)</span> <span class="main">(</span>blinding_of_list <span class="free">bo</span><span class="main">)</span> <span class="main">(</span>merge_list <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">parametric_constant</span></span> merge_list_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> merge_list_def

<span class="keyword1"><span class="command">lifting_update</span></span> list.lifting
<span class="keyword1"><span class="command">lifting_forget</span></span> list.lifting

<span class="keyword2"><span class="keyword">end</span></span>


<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Building block: function space›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We prove that we can lift the ADS construction through functions.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> fun<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
<span class="keyword1"><span class="command">type_notation</span></span> fun<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⇒<span class="hidden">⇩</span><sub>h</sub></span>"</span> 0<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> fun<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span>"</span></span>
<span class="keyword1"><span class="command">type_notation</span></span> fun<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⇒<span class="hidden">⇩</span><sub>m</sub></span>"</span> 0<span class="main">)</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Hashes ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Only the range is live, the domain is dead like for BNFs. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_fun'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>m</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'a</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>h</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_fun'</span> <span class="main">≡</span> id"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>m</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>h</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">hash_fun</span> <span class="main">≡</span> comp"</span></span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Blinding ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">blinding_of_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> blinding_of <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>m</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_fun</span> <span class="main">≡</span> rel_fun <span class="main">(=)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> blinding_of_fun_mono <span class="main">=</span> fun.rel_mono

<span class="keyword1" id="ADS_Construction-blinding_of_fun_hash"><span class="command">lemma</span></span> blinding_of_fun_hash<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="main">≤</span> vimage2p <span class="free">rh</span> <span class="free">rh</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_fun <span class="free">bo</span> <span class="main">≤</span> vimage2p <span class="main">(</span>hash_fun <span class="free">rh</span><span class="main">)</span> <span class="main">(</span>hash_fun <span class="free">rh</span><span class="main">)</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage2p_def rel_fun_def le_fun_def<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-blinding_of_on_fun"><span class="command">lemma</span></span> blinding_of_on_fun <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="free">A</span> <span class="free">rh</span> <span class="free">bo</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> range <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span> <span class="main">(</span>hash_fun <span class="free">rh</span><span class="main">)</span> <span class="main">(</span>blinding_of_fun <span class="free">bo</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> blinding_of_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">rh</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a.refl<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a.trans<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff rel_fun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a.antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">rule</span> blinding_of_fun_hash a.hash<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> blinding_of_fun <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> blinding_of_on_fun<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Merging ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> merge"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>m</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_fun</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">m</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">≠</span> None <span class="keyword1">then</span> Some <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="free">m</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="ADS_Construction-merge_on_fun"><span class="command">lemma</span></span> merge_on_fun <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="free">A</span> <span class="free">rh</span> <span class="free">bo</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> range <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span> <span class="main">(</span>hash_fun <span class="free">rh</span><span class="main">)</span> <span class="main">(</span>blinding_of_fun <span class="free">bo</span><span class="main">)</span> merge_fun"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span> <span class="var">?m</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> merge_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">rh</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="quoted"><span class="free">m</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">=</span> <span class="var">?h</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> 
      <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> fun_cong<span class="main">,</span> <span class="operator">unfolded</span> o_apply<span class="main">,</span> <span class="operator">THEN</span> a.join<span class="main">,</span> <span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> mem_Collect_eq<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subsetD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> rangeI<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize</span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> choice_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_fun_def rel_fun_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="var">?h</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_fun_def fun_eq_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> a.undefined<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> merge_fun <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> merge_on_fun<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="ADS_Construction-merge_fun_cong"><span class="command">lemma</span></span> merge_fun_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">∈</span> range <span class="free">f</span><span class="main">;</span> <span class="bound">b</span> <span class="main">∈</span> range <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">m'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_fun <span class="free">m</span> <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> merge_fun <span class="free">m'</span> <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">OF</span> rangeI rangeI<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_fun_def<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-is_none_alt_def"><span class="command">lemma</span></span> is_none_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Option.is_none <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Option.is_none_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">parametric_constant</span></span> is_none_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> is_none_alt_def

<span class="keyword1" id="ADS_Construction-merge_fun_parametric"><span class="command">lemma</span></span> merge_fun_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">B</span> <span class="main">===&gt;</span> rel_option <span class="free">C</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> <span class="free">A</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="main">===&gt;</span> rel_option <span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span>
   merge_fun merge_fun"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> rel_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> merge"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">m'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> merge"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">g'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">B</span> <span class="main">===&gt;</span> rel_option <span class="free">C</span><span class="main">)</span> <span class="skolem">m</span> <span class="skolem">m'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">f</span> <span class="skolem">f'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">g</span> <span class="skolem">g'</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> cond <span class="main">[</span><span class="operator">unfolded</span> Option.is_none_def<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> Option.is_none <span class="main">(</span><span class="skolem">m</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> Option.is_none <span class="main">(</span><span class="skolem">m'</span> <span class="main">(</span><span class="skolem">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> <span class="free">C</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">m</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">m'</span> <span class="main">(</span><span class="skolem">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">m</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fg</span></span> <span class="skolem"><span class="skolem">fg'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">fg</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">fg'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> * *<span class="main">[</span><span class="operator">simplified</span> cond<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> choice_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="free">C</span> <span class="main">(</span>Some <span class="main">(</span><span class="skolem">fg</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="skolem">fg'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">unfolding</span></span> m<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> m'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def m m'<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> <span class="free">C</span><span class="main">)</span> <span class="main">(</span>merge_fun <span class="skolem">m</span> <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">(</span>merge_fun <span class="skolem">m'</span> <span class="skolem">f'</span> <span class="skolem">g'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> merge_fun_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Merkle Interface ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1" id="ADS_Construction-merkle_fun"><span class="command">lemma</span></span> merkle_fun <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="free">rh</span> <span class="free">bo</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="main">(</span>hash_fun <span class="free">rh</span><span class="main">)</span> <span class="main">(</span>blinding_of_fun <span class="free">bo</span><span class="main">)</span> <span class="main">(</span>merge_fun <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> merge_on <span class="quoted">UNIV</span> <span class="quoted"><span class="free">rh</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="quoted"><span class="free">m</span></span> <span class="keyword1"><span class="command">unfolding</span></span> merkle_interface_aux<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> merkle_interface_aux<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rose trees›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ 
We now define an ADS over rose trees, which is like a arbitrarily branching Merkle tree where each
node in the tree can be blinded, including the root. The number of children and the position of a
child among its siblings cannot be hidden. The construction allows to plug in further blindable
positions in the labels of the nodes.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rose_tree_F <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> list"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">map_rose_tree_F</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_rose_tree_F</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">≡</span> map_prod <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">f2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_rose_tree_F_const</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_rose_tree_F_const</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">≡</span> map_rose_tree_F <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> rose_tree <span class="main">=</span> Tree <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span> rose_tree<span class="main">)</span> rose_tree_F"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree_F<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span> list<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> blindable<span class="hidden">⇩</span><sub>h</sub>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> rose_tree<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> Tree<span class="hidden">⇩</span><sub>h</sub> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> rose_tree<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> rose_tree_F<span class="hidden">⇩</span><sub>h</sub>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree_F<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>m</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> list<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span> list<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> blindable<span class="hidden">⇩</span><sub>m</sub>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> Tree<span class="hidden">⇩</span><sub>m</sub> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> rose_tree<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> rose_tree_F<span class="hidden">⇩</span><sub>m</sub>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">map_rose_tree_F<span class="hidden">⇩</span><sub>m</sub></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ma</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'mr</span> <span class="main">⇒</span> <span class="tfree">'r</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ma</span><span class="main">,</span> <span class="tfree">'ha</span><span class="main">,</span> <span class="tfree">'mr</span><span class="main">,</span> <span class="tfree">'hr</span><span class="main">)</span> rose_tree_F<span class="hidden">⇩</span><sub>m</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ha</span><span class="main">,</span> <span class="tfree">'r</span><span class="main">,</span> <span class="tfree">'hr</span><span class="main">)</span> rose_tree_F<span class="hidden">⇩</span><sub>m</sub>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_rose_tree_F<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> map_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>map_prod <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span> id"</span></span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Hashes ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_rt_F'</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree_F<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree_F<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_rt_F'</span> <span class="main">≡</span> hash_blindable id"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hash_rt_F<span class="hidden">⇩</span><sub>m</sub></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> 
    <span class="main">(</span><span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree_F<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree_F<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_rt_F<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">rhm</span></span></span> <span class="main">≡</span> hash_rt_F' <span class="keyword1">o</span> map_rose_tree_F<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">rhm</span></span></span>"</span></span>

<span class="keyword1" id="ADS_Construction-hash_rt_F"><span class="command">lemma</span></span> hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"hash_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">h</span> <span class="free">rhm</span> <span class="main">=</span> hash_blindable <span class="main">(</span>map_prod <span class="free">h</span> <span class="main">(</span>map <span class="free">rhm</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_def fun_eq_iff hash_map_blindable_simp<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="main">(</span>transfer<span class="main">)</span> <span class="entity">hash_rt_tree'</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> rose_tree<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_rt_tree'</span> <span class="main">(</span>Tree<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Tree<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>hash_rt_F' <span class="main">(</span>map_rose_tree_F<span class="hidden">⇩</span><sub>m</sub> id <span class="free">hash_rt_tree'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hash_tree</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> rose_tree<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_tree</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> hash_rt_tree' <span class="keyword1">o</span> map_rose_tree<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">h</span></span></span> id"</span></span>

<span class="keyword1" id="ADS_Construction-blindable"><span class="command">lemma</span></span> blindable<span class="hidden">⇩</span><sub>m</sub>_map_compositionality<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="free">f</span> <span class="free">g</span> <span class="keyword1">o</span> map_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="free">f'</span> <span class="free">g'</span> <span class="main">=</span> map_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">f'</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">o</span> <span class="free">g'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blindable<span class="hidden">⇩</span><sub>m</sub>.map_comp<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-hash_tree_simps"><span class="command">lemma</span></span> hash_tree_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"hash_tree <span class="free">h</span> <span class="main">(</span>Tree<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Tree<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>hash_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">h</span> <span class="main">(</span>hash_tree <span class="free">h</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hash_tree_def hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_def 
      map_prod.comp map_sum.comp rose_tree<span class="hidden">⇩</span><sub>h</sub>.map_comp blindable<span class="hidden">⇩</span><sub>m</sub>.map_comp
      prod.map_id0 rose_tree<span class="hidden">⇩</span><sub>h</sub>.map_id0<span class="main">)</span>

<span class="keyword1"><span class="command">parametric_constant</span></span> hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_alt_def

<span class="keyword1"><span class="command">parametric_constant</span></span> hash_tree_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> hash_tree_def

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Blinding ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> blinding_of <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> blinding_of
      <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree_F<span class="hidden">⇩</span><sub>m</sub> blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">ha</span></span></span> <span class="free"><span class="bound"><span class="entity">boa</span></span></span> <span class="free"><span class="bound"><span class="entity">hb</span></span></span> <span class="free"><span class="bound"><span class="entity">bob</span></span></span> <span class="main">≡</span> blinding_of_blindable <span class="main">(</span>hash_prod <span class="free"><span class="bound"><span class="entity">ha</span></span></span> <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">hb</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>blinding_of_prod <span class="free"><span class="bound"><span class="entity">boa</span></span></span> <span class="main">(</span>blinding_of_list <span class="free"><span class="bound"><span class="entity">bob</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ADS_Construction-blinding_of_rt_F"><span class="command">lemma</span></span> blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub>_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">boa</span> <span class="main">≤</span> <span class="free">boa'</span><span class="main">;</span> <span class="free">bob</span> <span class="main">≤</span> <span class="free">bob'</span> <span class="main">⟧</span> <span class="main">⟹</span> blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">ha</span> <span class="free">boa</span> <span class="free">hb</span> <span class="free">bob</span> <span class="main">≤</span> blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">ha</span> <span class="free">boa'</span> <span class="free">hb</span> <span class="free">bob'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> blinding_of_blindable_mono prod.rel_mono list.rel_mono<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-blinding_of_rt_F"><span class="command">lemma</span></span> blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub>_mono_inductive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">boa</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">boa'</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">bob</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">bob'</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">ha</span> <span class="free">boa</span> <span class="free">hb</span> <span class="free">bob</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟶</span> blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">ha</span> <span class="free">boa'</span> <span class="free">hb</span> <span class="free">bob'</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub>_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> blinding_of"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">blinding_of_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub> blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_tree</span> <span class="main">(</span>Tree<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">(</span>Tree<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">h</span> <span class="free">bo</span> <span class="main">(</span>hash_tree <span class="free">h</span><span class="main">)</span> <span class="free">blinding_of_tree</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="keyword2"><span class="keyword">monos</span></span> blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub>_mono_inductive

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">inductive_simps</span></span> blinding_of_tree_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"blinding_of_tree <span class="free">h</span> <span class="free">bo</span> <span class="main">(</span>Tree<span class="hidden">⇩</span><sub>m</sub> <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>Tree<span class="hidden">⇩</span><sub>m</sub> <span class="free">t2</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ADS_Construction-blinding_of_rt_F"><span class="command">lemma</span></span> blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub>_hash<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">boa</span> <span class="main">≤</span> vimage2p <span class="free">ha</span> <span class="free">ha</span> <span class="main">(=)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bob</span> <span class="main">≤</span> vimage2p <span class="free">hb</span> <span class="free">hb</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">ha</span> <span class="free">boa</span> <span class="free">hb</span> <span class="free">bob</span> <span class="main">≤</span> vimage2p <span class="main">(</span>hash_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">ha</span> <span class="free">hb</span><span class="main">)</span> <span class="main">(</span>hash_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">ha</span> <span class="free">hb</span><span class="main">)</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> blinding_of_blindable_hash<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> <span class="dynamic"><span class="dynamic">relator_eq</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> vimage2p_map_rel_prod vimage2p_map_list_all2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> prod.rel_mono assms list.rel_mono<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_def vimage2p_comp o_apply hash_blindable_def blindable<span class="hidden">⇩</span><sub>m</sub>.map_id0 id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> vimage2p_id id_apply<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ADS_Construction-blinding_of_tree_hash"><span class="command">lemma</span></span> blinding_of_tree_hash<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="main">≤</span> vimage2p <span class="free">h</span> <span class="free">h</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_tree <span class="free">h</span> <span class="free">bo</span> <span class="main">≤</span> vimage2p <span class="main">(</span>hash_tree <span class="free">h</span><span class="main">)</span> <span class="main">(</span>hash_tree <span class="free">h</span><span class="main">)</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> predicate2I vimage2pI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> blinding_of_tree.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub>_hash<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> predicate2D_vimage2p<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vimage2pI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">set1_rt_F<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> rose_tree_F<span class="hidden">⇩</span><sub>m</sub> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set1_rt_F<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> set1_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⤜</span> fsts"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">set3_rt_F<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree_F<span class="hidden">⇩</span><sub>m</sub> <span class="main">⇒</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">set3_rt_F<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">(</span>set1_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⤜</span> snds<span class="main">)</span> <span class="main">⤜</span> set"</span></span>

<span class="keyword1" id="ADS_Construction-set_rt_F"><span class="command">lemma</span></span> set_rt_F<span class="hidden">⇩</span><sub>m</sub>_eq<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> set3_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span> <span class="main">=</span> 
   <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> fsts <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> snds <span class="bound">x</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set <span class="bound">x</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="ADS_Construction-hash_blindable_map"><span class="command">lemma</span></span> hash_blindable_map<span class="main">:</span> <span class="quoted"><span class="quoted">"hash_blindable <span class="free">f</span> <span class="main">∘</span> map_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="free">g</span> id <span class="main">=</span> hash_blindable <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hash_blindable_def blindable<span class="hidden">⇩</span><sub>m</sub>.map_comp<span class="main">)</span>

<span class="keyword1" id="ADS_Construction-blinding_of_on_tree"><span class="command">lemma</span></span> blinding_of_on_tree <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="free">A</span> <span class="free">h</span> <span class="free">bo</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_rose_tree<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span> <span class="main">(</span>hash_tree <span class="free">h</span><span class="main">)</span> <span class="main">(</span>blinding_of_tree <span class="free">h</span> <span class="free">bo</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> blinding_of_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="main">≤</span> vimage2p <span class="var">?h</span> <span class="var">?h</span> <span class="main">(=)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a.hash <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> blinding_of_tree_hash<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">x</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tree<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="main">(</span>set3_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>hash_tree <span class="free">h</span><span class="main">)</span> <span class="main">(</span>blinding_of_tree <span class="free">h</span> <span class="free">bo</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> blinding_of_tree_hash<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> a.hash<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> Tree<span class="hidden">⇩</span><sub>m</sub>.IH Tree<span class="hidden">⇩</span><sub>m</sub>.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y z <span class="keyword1"><span class="command">using</span></span> Tree<span class="hidden">⇩</span><sub>m</sub>.IH<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> Tree<span class="hidden">⇩</span><sub>m</sub>.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y <span class="keyword1"><span class="command">using</span></span> Tree<span class="hidden">⇩</span><sub>m</sub>.IH<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> Tree<span class="hidden">⇩</span><sub>m</sub>.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">interpret</span></span> blinding_of_on
        <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> set1_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">a</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> set3_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">a</span> <span class="main">⊆</span> set3_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">x</span><span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"hash_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">h</span> <span class="var">?h</span>"</span></span> <span class="quoted"><span class="quoted">"blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">h</span> <span class="free">bo</span> <span class="var">?h</span> <span class="var">?bo</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> set_rt_F<span class="hidden">⇩</span><sub>m</sub>_eq hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_alt_def <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">from</span></span> Tree<span class="hidden">⇩</span><sub>m</sub>.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blinding_of_tree.intros refl<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_alt_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blinding_of_tree.cases trans<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_alt_def<span class="main"><span class="main">]</span></span> 
                    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blinding_of_tree.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blinding_of_tree.cases antisym<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_alt_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">⟹</span> <span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">;</span> <span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">;</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">;</span> <span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">x</span><span class="main">;</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> blinding_of_tree <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> blinding_of_on_tree<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="ADS_Construction-blinding_of_tree_mono"><span class="command">lemma</span></span> blinding_of_tree_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="main">≤</span> <span class="free">bo'</span> <span class="main">⟹</span> blinding_of_tree <span class="free">h</span> <span class="free">bo</span> <span class="main">≤</span> blinding_of_tree <span class="free">h</span> <span class="free">bo'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> predicate2I<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> blinding_of_tree.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> blinding_of_tree.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub>_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Merging ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_rt_F<span class="hidden">⇩</span><sub>m</sub></span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> merge <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> merge <span class="main">⇒</span>
      <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree_F<span class="hidden">⇩</span><sub>m</sub> merge"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_rt_F<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">ha</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="free"><span class="bound"><span class="entity">hr</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="main">≡</span> merge_blindable <span class="main">(</span>hash_prod <span class="free"><span class="bound"><span class="entity">ha</span></span></span> <span class="main">(</span>hash_list <span class="free"><span class="bound"><span class="entity">hr</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>merge_prod <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="main">(</span>merge_list <span class="free"><span class="bound"><span class="entity">mr</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ADS_Construction-merge_rt_F"><span class="command">lemma</span></span> merge_rt_F<span class="hidden">⇩</span><sub>m</sub>_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">∈</span> set1_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span><span class="main">;</span> <span class="bound">b</span> <span class="main">∈</span> set1_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ma</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">ma'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">∈</span> set3_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span><span class="main">;</span> <span class="bound">b</span> <span class="main">∈</span> set3_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">mm</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">mm'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">ha</span> <span class="free">ma</span> <span class="free">hm</span> <span class="free">mm</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> merge_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">ha</span> <span class="free">ma'</span> <span class="free">hm</span> <span class="free">mm'</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_rt_F<span class="hidden">⇩</span><sub>m</sub>_def bind_UNION<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"map_option <span class="main"><span class="main">_</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> merge_prod_cong merge_list_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ADS_Construction-in_set1_blindable"><span class="command">lemma</span></span> in_set1_blindable<span class="hidden">⇩</span><sub>m</sub>_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set1_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="free">y</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">=</span> Unblinded <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> merge"</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> in_set1_blindable<span class="hidden">⇩</span><sub>m</sub>_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_tree</span> <span class="main">(</span>Tree<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Tree<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> map_option Tree<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>
    merge_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">h</span> <span class="free">ma</span> <span class="main">(</span>hash_tree <span class="free">h</span><span class="main">)</span> <span class="free">merge_tree</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="ADS_Construction-merge_on_tree"><span class="command">lemma</span></span> merge_on_tree <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="free">A</span> <span class="free">h</span> <span class="free">bo</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_rose_tree<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span> <span class="main">(</span>hash_tree <span class="free">h</span><span class="main">)</span> <span class="main">(</span>blinding_of_tree <span class="free">h</span> <span class="free">bo</span><span class="main">)</span> <span class="main">(</span>merge_tree <span class="free">h</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span> <span class="var">?m</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> merge_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="quoted"><span class="free">m</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?h</span> <span class="skolem">a</span> <span class="main">=</span> <span class="var">?h</span> <span class="skolem">b</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="var">?h</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="var">?h</span> <span class="skolem">b</span> <span class="main">⟶</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> mem_Collect_eq
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rose_tree<span class="hidden">⇩</span><sub>m</sub>.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tree<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
      <span class="keyword1"><span class="command">interpret</span></span> merge_on 
        <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> set1_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">y</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> set3_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">y</span> <span class="main">⊆</span> set3_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">x</span><span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"hash_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">h</span> <span class="var">?h</span>"</span></span>
        <span class="quoted"><span class="quoted">"blinding_of_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">h</span> <span class="free">bo</span> <span class="var">?h</span> <span class="var">?bo</span>"</span></span>
        <span class="quoted"><span class="quoted">"merge_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">h</span> <span class="free">m</span> <span class="var">?h</span> <span class="var">?m</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> set_rt_F<span class="hidden">⇩</span><sub>m</sub>_eq hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_alt_def merge_rt_F<span class="hidden">⇩</span><sub>m</sub>_def
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
        <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set3_rt_F<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> Tree<span class="hidden">⇩</span><sub>m</sub>.prems <span class="keyword1"><span class="command">have</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"set1_rose_tree<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">a</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION<span class="main">)</span>

        <span class="keyword1"><span class="command">from</span></span> a <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">ab</span></span> <span class="keyword2"><span class="keyword">where</span></span> a''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ab</span> <span class="main">∈</span> set1_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> snds <span class="skolem">ab</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION<span class="main">)</span>

        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
        <span class="keyword1"><span class="command">from</span></span> Tree<span class="hidden">⇩</span><sub>m</sub>.IH<span class="main">[</span><span class="operator">OF</span> a'' a'<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hash_tree <span class="free">h</span> <span class="skolem">a</span> <span class="main">=</span> hash_tree <span class="free">h</span> <span class="skolem">b</span>
           <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> merge_tree <span class="free">h</span> <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> blinding_of_tree <span class="free">h</span> <span class="free">bo</span> <span class="skolem">a</span> <span class="bound">ab</span> <span class="main">∧</span> blinding_of_tree <span class="free">h</span> <span class="free">bo</span> <span class="skolem">b</span> <span class="bound">ab</span> <span class="main">∧</span>
                    <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> blinding_of_tree <span class="free">h</span> <span class="free">bo</span> <span class="skolem">a</span> <span class="bound">u</span> <span class="main">⟶</span> blinding_of_tree <span class="free">h</span> <span class="free">bo</span> <span class="skolem">b</span> <span class="bound">u</span> <span class="main">⟶</span> blinding_of_tree <span class="free">h</span> <span class="free">bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hash_tree <span class="free">h</span> <span class="skolem">a</span> <span class="main">≠</span> hash_tree <span class="free">h</span> <span class="skolem">b</span> <span class="main">⟹</span> merge_tree <span class="free">h</span> <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sym<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Tree<span class="hidden">⇩</span><sub>m</sub>.prems
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> conjI strip<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> join <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blinding_of_tree.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> undefined<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">=</span> <span class="var">?h</span> <span class="skolem">b</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="var">?h</span> <span class="skolem">b</span> <span class="main">⟹</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> merge_tree <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> merge_on_tree<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="ADS_Construction-option_bind_comm"><span class="command">lemma</span></span> option_bind_comm<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> option<span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">c</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="bound">z</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">parametric_constant</span></span> merge_rt_F<span class="hidden">⇩</span><sub>m</sub>_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> merge_rt_F<span class="hidden">⇩</span><sub>m</sub>_def

<span class="comment1">(************************************************************)</span> 
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Merkle interface›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1" id="ADS_Construction-merkle_tree"><span class="command">lemma</span></span> merkle_tree <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="free">h</span> <span class="free">bo</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merkle_interface <span class="main">(</span>hash_tree <span class="free">h</span><span class="main">)</span> <span class="main">(</span>blinding_of_tree <span class="free">h</span> <span class="free">bo</span><span class="main">)</span> <span class="main">(</span>merge_tree <span class="free">h</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> merge_on <span class="quoted">UNIV</span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="quoted"><span class="free">m</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> merkle_interface_aux <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> merkle_interface_aux<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ADS_Construction-merge_tree_cong"><span class="command">lemma</span></span> merge_tree_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">∈</span> set1_rose_tree<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span><span class="main">;</span> <span class="bound">b</span> <span class="main">∈</span> set1_rose_tree<span class="hidden">⇩</span><sub>m</sub> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">m'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_tree <span class="free">h</span> <span class="free">m</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> merge_tree <span class="free">h</span> <span class="free">m'</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_tree.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"map_option <span class="main"><span class="main">_</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> merge_rt_F<span class="hidden">⇩</span><sub>m</sub>_cong<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Generic_ADS_Construction">
<div class="head">
<h1>Theory Generic_ADS_Construction</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Andreas Lochbihler, Digital Asset
   Author: Ognjen Maric, Digital Asset *)</span>

<span class="keyword1"><span class="command">theory</span></span> Generic_ADS_Construction <span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="#Merkle_Interface">Merkle_Interface</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/BNF_Axiomatization.html">HOL-Library.BNF_Axiomatization</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Generic construction of authenticated data structures›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Functors›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Source functor›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹

We want to allow ADSs of arbitrary ADTs, which we call "source trees". The ADTs we are interested in can
in general be represented as the least fixpoints of some bounded natural (bi-)functor (BNF) <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>('a, 'b) F›</span></span></span></span>, where
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the type of "source" data, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a recursion "handle".
However, Isabelle's type system does not support higher kinds, necessary to parameterize our definitions
over functors.
Instead, we first develop a general theory of ADSs over an arbitrary, but fixed functor,
and its least fixpoint. We show that the theory is compositional, in that the functor's least fixed point
can then be reused as the "source" data of another functor.

We start by defining the arbitrary fixed functor, its fixpoints, and showing how composition can be
done. A higher-level explanation is found in the paper.
›</span></span>


<span class="keyword1"><span class="command">bnf_axiomatization</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> F <span class="main">[</span>wits<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> F"</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">typedef_overloaded</span><span class="main">]</span><span class="main">]</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> T <span class="main">=</span> T <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span> T<span class="main">)</span> F"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Base Merkle functor›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This type captures the ADS hashes.
›</span></span>

<span class="keyword1"><span class="command">bnf_axiomatization</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> F<span class="hidden">⇩</span><sub>h</sub> <span class="main">[</span>wits<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> F<span class="hidden">⇩</span><sub>h</sub>"</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
It intuitively contains mixed garbage and source values.
The functor's recursive handle <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> might contain partial garbage.
›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This type captures the ADS inclusion proofs.
The functor <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>('a, 'a', 'b, 'b') F<span class="hidden">⇩</span><sub>m</sub>›</span></span></span></span> has all type variables doubled.
This type represents all values including the information which parts are blinded.
The original type variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> now represents the source data, which for compositionality can contain blindable positions.
The type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a recursive handle to inclusion sub-proofs (which can be partialy blinded). 
The type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> represent "hashes" of the source data in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, i.e., a mix of source values and garbage.
The type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'b'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a recursive handle to ADS hashes of subtrees.

The corresponding type of recursive authenticated trees is then a fixpoint of this functor.
›</span></span>

<span class="keyword1"><span class="command">bnf_axiomatization</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> F<span class="hidden">⇩</span><sub>m</sub> <span class="main">[</span>wits<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">⇒</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> F<span class="hidden">⇩</span><sub>m</sub>"</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Least fixpoint›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">typedef_overloaded</span><span class="main">]</span><span class="main">]</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> T<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> T<span class="hidden">⇩</span><sub>h</sub> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> T<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> F<span class="hidden">⇩</span><sub>h</sub>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">typedef_overloaded</span><span class="main">]</span><span class="main">]</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> T<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> T<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free"><span class="entity">the_T<span class="hidden">⇩</span><sub>m</sub></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> T<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> T<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> F<span class="hidden">⇩</span><sub>m</sub>"</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Composition ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Finally, we show how to compose two Merkle functors.
For simplicity, we reuse <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'a</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'b</span></span><span class="main"><span class="main">)</span></span> F›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">‹<span class="tfree"><span class="tfree">'a</span></span> T›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">typedef_overloaded</span><span class="main">]</span><span class="main">]</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> G <span class="main">=</span> G <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> T<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> F"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> G<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> G<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span><span class="free"><span class="entity">the_G<span class="hidden">⇩</span><sub>h</sub></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> T<span class="hidden">⇩</span><sub>h</sub><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> F<span class="hidden">⇩</span><sub>h</sub>"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> G<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> G<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free"><span class="entity">the_G<span class="hidden">⇩</span><sub>m</sub></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> T<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> T<span class="hidden">⇩</span><sub>h</sub><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> F<span class="hidden">⇩</span><sub>m</sub>"</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Root hash›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Base functor›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The root hash of an authenticated value is modelled as a blindable value of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'a'</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'b'</span></span><span class="main"><span class="main">)</span></span> F<span class="hidden">⇩</span><sub>h</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
(Actually, we want to use an abstract datatype for root hashes, but we omit this distinction here for simplicity.)
›</span></span>

<span class="keyword1"><span class="command">consts</span></span> root_hash_F' <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> F<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> F<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span>
  <span class="comment1">― ‹Root hash operation where we assume that all atoms have already been replaced by root hashes.
     This assumption is reflected in the equality of the type parameters of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type</span> F<span class="hidden">⇩</span><sub>m</sub><span class="antiquote">}</span></span> ›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash_F <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> F<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> F<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">root_hash_F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash_F"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_hash_F</span> <span class="free"><span class="bound"><span class="entity">rha</span></span></span> <span class="free"><span class="bound"><span class="entity">rhb</span></span></span> <span class="main">=</span> root_hash_F' <span class="main">∘</span> map_F<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">rha</span></span></span> id <span class="free"><span class="bound"><span class="entity">rhb</span></span></span> id"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Least fixpoint›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">root_hash_T'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> T<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> T<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_hash_T'</span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> T<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>root_hash_F' <span class="main">(</span>map_F<span class="hidden">⇩</span><sub>m</sub> id id <span class="free">root_hash_T'</span> id <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">root_hash_T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> T<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> T<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_hash_T</span> <span class="free"><span class="bound"><span class="entity">rha</span></span></span> <span class="main">=</span> root_hash_T' <span class="main">∘</span> map_T<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">rha</span></span></span> id"</span></span>

<span class="keyword1" id="Generic_ADS_Construction-root_hash_T_simps"><span class="command">lemma</span></span> root_hash_T_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"root_hash_T <span class="free">rha</span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> T<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>root_hash_F <span class="free">rha</span> <span class="main">(</span>root_hash_T <span class="free">rha</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> root_hash_T_def F<span class="hidden">⇩</span><sub>m</sub>.map_comp root_hash_F_def T<span class="hidden">⇩</span><sub>h</sub>.map_id0<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Composition›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">root_hash_G'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> G<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> G<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_hash_G'</span> <span class="main">(</span>G<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> G<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>root_hash_F' <span class="main">(</span>map_F<span class="hidden">⇩</span><sub>m</sub> root_hash_T' id id id <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">root_hash_G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> G<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> G<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_hash_G</span> <span class="free"><span class="bound"><span class="entity">rha</span></span></span> <span class="free"><span class="bound"><span class="entity">rhb</span></span></span> <span class="main">=</span> root_hash_G' <span class="main">∘</span> map_G<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">rha</span></span></span> id <span class="free"><span class="bound"><span class="entity">rhb</span></span></span> id"</span></span>

<span class="keyword1" id="Generic_ADS_Construction-root_hash_G_unfold"><span class="command">lemma</span></span> root_hash_G_unfold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"root_hash_G <span class="free">rha</span> <span class="free">rhb</span> <span class="main">=</span> G<span class="hidden">⇩</span><sub>h</sub> <span class="main">∘</span> root_hash_F <span class="main">(</span>root_hash_T <span class="free">rha</span><span class="main">)</span> <span class="free">rhb</span> <span class="main">∘</span> the_G<span class="hidden">⇩</span><sub>m</sub>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> root_hash_G_def fun_eq_iff root_hash_F_def root_hash_T_def F<span class="hidden">⇩</span><sub>m</sub>.map_comp T<span class="hidden">⇩</span><sub>m</sub>.map_comp o_def T<span class="hidden">⇩</span><sub>h</sub>.map_id id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Generic_ADS_Construction-root_hash_G_simps"><span class="command">lemma</span></span> root_hash_G_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"root_hash_G <span class="free">rha</span> <span class="free">rhb</span> <span class="main">(</span>G<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> G<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>root_hash_F <span class="main">(</span>root_hash_T <span class="free">rha</span><span class="main">)</span> <span class="free">rhb</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> root_hash_G_def root_hash_T_def F<span class="hidden">⇩</span><sub>m</sub>.map_comp root_hash_F_def T<span class="hidden">⇩</span><sub>h</sub>.map_id0<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Blinding relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The blinding relation determines whether one ADS value is a blinding of another.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Blinding on the base functor (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> F<span class="hidden">⇩</span><sub>m</sub><span class="antiquote"><span class="antiquote">}</span></span></span></span>) ›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> blinding_of_F <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> blinding_of <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> blinding_of <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> F<span class="hidden">⇩</span><sub>m</sub> blinding_of"</span></span>

<span class="comment1">― ‹ Computes whether a partially blinded ADS is a blinding of another one ›</span>
<span class="keyword1"><span class="command">axiomatization</span></span> <span class="free">blinding_of_F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> blinding_of_F"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  blinding_of_F_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">boa</span> <span class="main">≤</span> <span class="free">boa'</span><span class="main">;</span> <span class="free">bob</span> <span class="main">≤</span> <span class="free">bob'</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">blinding_of_F</span> <span class="free">rha</span> <span class="free">boa</span> <span class="free">rhb</span> <span class="free">bob</span> <span class="main">≤</span> <span class="free">blinding_of_F</span> <span class="free">rha</span> <span class="free">boa'</span> <span class="free">rhb</span> <span class="free">bob'</span>"</span></span>
    <span class="comment1">― ‹ Monotonicity must be unconditional (without the assumption <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"blinding_of_on"</span><span class="antiquote">}</span></span>) 
         such that we can justify the recursive definition for the least fixpoint. ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> blinding_respects_hashes_F <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> blinding_respects_hashes <span class="free">rha</span> <span class="free">boa</span><span class="main">;</span> blinding_respects_hashes <span class="free">rhb</span> <span class="free">bob</span> <span class="main">⟧</span>
   <span class="main">⟹</span> blinding_respects_hashes <span class="main">(</span>root_hash_F <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(</span><span class="free">blinding_of_F</span> <span class="free">rha</span> <span class="free">boa</span> <span class="free">rhb</span> <span class="free">bob</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> blinding_of_on_F <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> blinding_of_on <span class="free">A</span> <span class="free">rha</span> <span class="free">boa</span><span class="main">;</span> blinding_of_on <span class="free">B</span> <span class="free">rhb</span> <span class="free">bob</span> <span class="main">⟧</span>
   <span class="main">⟹</span> blinding_of_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> set3_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span> <span class="main">(</span>root_hash_F <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(</span><span class="free">blinding_of_F</span> <span class="free">rha</span> <span class="free">boa</span> <span class="free">rhb</span> <span class="free">bob</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Generic_ADS_Construction-blinding_of_F_mono_inductive"><span class="command">lemma</span></span> blinding_of_F_mono_inductive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">boa</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">boa'</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">bob</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">bob'</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_F <span class="free">rha</span> <span class="free">boa</span> <span class="free">rhb</span> <span class="free">bob</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟶</span> blinding_of_F <span class="free">rha</span> <span class="free">boa'</span> <span class="free">rhb</span> <span class="free">bob'</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> blinding_of_F_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> predicate2I predicate2I<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Blinding on least fixpoints ›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> blinding_of"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">blinding_of_T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> T<span class="hidden">⇩</span><sub>m</sub> blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_T</span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> 
  <span class="quoted"><span class="quoted">"blinding_of_F <span class="free">rh</span> <span class="free">bo</span> <span class="main">(</span>root_hash_T <span class="free">rh</span><span class="main">)</span> <span class="free">blinding_of_T</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="keyword2"><span class="keyword">monos</span></span> blinding_of_F_mono_inductive

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Generic_ADS_Construction-blinding_of_T_mono"><span class="command">lemma</span></span> blinding_of_T_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="main">≤</span> <span class="free">bo'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_T <span class="free">rh</span> <span class="free">bo</span> <span class="main">≤</span> blinding_of_T <span class="free">rh</span> <span class="free">bo'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> predicate2I<span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> blinding_of_T.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> blinding_of_T.intros blinding_of_F_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Generic_ADS_Construction-blinding_of_T_root_hash"><span class="command">lemma</span></span> blinding_of_T_root_hash<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="main">≤</span> vimage2p <span class="free">rh</span> <span class="free">rh</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_T <span class="free">rh</span> <span class="free">bo</span> <span class="main">≤</span> vimage2p <span class="main">(</span>root_hash_T <span class="free">rh</span><span class="main">)</span> <span class="main">(</span>root_hash_T <span class="free">rh</span><span class="main">)</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> predicate2I vimage2pI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> blinding_of_T.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> blinding_respects_hashes_F<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> blinding_respects_hashes_def<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vimage2pI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage2p_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Generic_ADS_Construction-blinding_respects_hashes_T"><span class="command">lemma</span></span> blinding_respects_hashes_T <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"blinding_respects_hashes <span class="free">rh</span> <span class="free">bo</span> <span class="main">⟹</span> blinding_respects_hashes <span class="main">(</span>root_hash_T <span class="free">rh</span><span class="main">)</span> <span class="main">(</span>blinding_of_T <span class="free">rh</span> <span class="free">bo</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> blinding_respects_hashes_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> blinding_of_T_root_hash<span class="main">)</span>

<span class="keyword1" id="Generic_ADS_Construction-blinding_of_on_T"><span class="command">lemma</span></span> blinding_of_on_T <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="free">A</span> <span class="free">rh</span> <span class="free">bo</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_T<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span> <span class="main">(</span>root_hash_T <span class="free">rh</span><span class="main">)</span> <span class="main">(</span>blinding_of_T <span class="free">rh</span> <span class="free">bo</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> blinding_of_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">rh</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">x</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">interpret</span></span> blinding_of_on 
        <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> set1_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">a</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> set3_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">a</span> <span class="main">⊆</span> set3_F<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">x</span><span class="main">}</span>"</span></span> 
        <span class="quoted"><span class="quoted">"root_hash_F <span class="free">rh</span> <span class="var">?h</span>"</span></span> 
        <span class="quoted"><span class="quoted">"blinding_of_F <span class="free">rh</span> <span class="free">bo</span> <span class="var">?h</span> <span class="var">?bo</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> blinding_of_on_F<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> T<span class="hidden">⇩</span><sub>m</sub>.IH T<span class="hidden">⇩</span><sub>m</sub>.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b c <span class="keyword1"><span class="command">using</span></span> T<span class="hidden">⇩</span><sub>m</sub>.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> T<span class="hidden">⇩</span><sub>m</sub>.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b <span class="keyword1"><span class="command">using</span></span> T<span class="hidden">⇩</span><sub>m</sub>.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> T<span class="hidden">⇩</span><sub>m</sub>.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> T<span class="hidden">⇩</span><sub>m</sub>.prems
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> blinding_of_T.intros refl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blinding_of_T.cases trans <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blinding_of_T.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blinding_of_T.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> antisym<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">⟹</span> <span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">x</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">;</span> <span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">;</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">;</span> <span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">x</span><span class="main">;</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> blinding_of_T <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> blinding_of_on_T<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Blinding on composition ›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rha</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">boa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> blinding_of"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rhb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bob</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> blinding_of"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">blinding_of_G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> G<span class="hidden">⇩</span><sub>m</sub> blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_G</span> <span class="main">(</span>G<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>G<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> 
  <span class="quoted"><span class="quoted">"blinding_of_F <span class="main">(</span>root_hash_T <span class="free">rha</span><span class="main">)</span> <span class="main">(</span>blinding_of_T <span class="free">rha</span> <span class="free">boa</span><span class="main">)</span> <span class="free">rhb</span> <span class="free">bob</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1" id="Generic_ADS_Construction-blinding_of_G_unfold"><span class="command">lemma</span></span> blinding_of_G_unfold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"blinding_of_G <span class="main">=</span> vimage2p the_G<span class="hidden">⇩</span><sub>m</sub> the_G<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>blinding_of_F <span class="main">(</span>root_hash_T <span class="free">rha</span><span class="main">)</span> <span class="main">(</span>blinding_of_T <span class="free">rha</span> <span class="free">boa</span><span class="main">)</span> <span class="free">rhb</span> <span class="free">bob</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blinding_of_G.simps fun_eq_iff vimage2p_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Generic_ADS_Construction-blinding_of_G_mono"><span class="command">lemma</span></span> blinding_of_G_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">boa</span> <span class="main">≤</span> <span class="free">boa'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bob</span> <span class="main">≤</span> <span class="free">bob'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_G <span class="free">rha</span> <span class="free">boa</span> <span class="free">rhb</span> <span class="free">bob</span> <span class="main">≤</span> blinding_of_G <span class="free">rha</span> <span class="free">boa'</span> <span class="free">rhb</span> <span class="free">bob'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> blinding_of_G_unfold
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> vimage2p_mono' blinding_of_F_mono blinding_of_T_mono assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Generic_ADS_Construction-blinding_of_G_root_hash"><span class="command">lemma</span></span> blinding_of_G_root_hash<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">boa</span> <span class="main">≤</span> vimage2p <span class="free">rha</span> <span class="free">rha</span> <span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">bob</span> <span class="main">≤</span> vimage2p <span class="free">rhb</span> <span class="free">rhb</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_G <span class="free">rha</span> <span class="free">boa</span> <span class="free">rhb</span> <span class="free">bob</span> <span class="main">≤</span> vimage2p <span class="main">(</span>root_hash_G <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(</span>root_hash_G <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> blinding_of_G_unfold root_hash_G_unfold vimage2p_comp o_apply
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> vimage2p_mono'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> blinding_respects_hashes_F<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> blinding_respects_hashes_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> blinding_of_T_root_hash<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> vimage2p_mono'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage2p_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Generic_ADS_Construction-blinding_of_on_G"><span class="command">lemma</span></span> blinding_of_on_G <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="free">A</span> <span class="free">rha</span> <span class="free">boa</span>"</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="free">B</span> <span class="free">rhb</span> <span class="free">bob</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_G<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> set3_G<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span> <span class="main">(</span>root_hash_G <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(</span>blinding_of_G <span class="free">rha</span> <span class="free">boa</span> <span class="free">rhb</span> <span class="free">bob</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"blinding_of_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> blinding_of_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">rha</span></span> <span class="quoted"><span class="free">boa</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> b<span class="main">:</span> blinding_of_on <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">rhb</span></span> <span class="quoted"><span class="free">bob</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> FT<span class="main">:</span> blinding_of_on 
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_T<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span> <span class="main">∧</span> set3_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span>"</span></span> 
    <span class="quoted"><span class="quoted">"root_hash_F <span class="main">(</span>root_hash_T <span class="free">rha</span><span class="main">)</span> <span class="free">rhb</span>"</span></span>
    <span class="quoted"><span class="quoted">"blinding_of_F <span class="main">(</span>root_hash_T <span class="free">rha</span><span class="main">)</span> <span class="main">(</span>blinding_of_T <span class="free">rha</span> <span class="free">boa</span><span class="main">)</span> <span class="free">rhb</span> <span class="free">bob</span>"</span></span>
    <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="main">≤</span> vimage2p <span class="var">?h</span> <span class="var">?h</span> <span class="main">(=)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a.hash b.hash
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> blinding_of_G_root_hash<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">hypsubst</span><span class="main">)</span><span class="main">(</span><span class="operator">rule</span> blinding_of_G.intros<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> FT.refl<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blinding_of_G.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blinding_of_G.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> FT.trans<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bo</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blinding_of_G.cases<span class="main">)</span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> FT.antisym<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> blinding_of_G <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> blinding_of_on_G<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Merging›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Two Merkle values with the same root hash can be merged into a less blinded Merkle value.
The operation is unspecified for trees with different root hashes.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Merging on the base functor ›</span></span>

<span class="keyword1"><span class="command">axiomatization</span></span> <span class="free">merge_F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> merge <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash <span class="main">⇒</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> merge 
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> F<span class="hidden">⇩</span><sub>m</sub> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  merge_F_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set1_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span> <span class="main">⟹</span> <span class="free">ma</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">ma'</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set3_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span> <span class="main">⟹</span> <span class="free">mb</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">mb'</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">merge_F</span> <span class="free">rha</span> <span class="free">ma</span> <span class="free">rhb</span> <span class="free">mb</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="free">merge_F</span> <span class="free">rha</span> <span class="free">ma'</span> <span class="free">rhb</span> <span class="free">mb'</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>
  merge_on_F <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> merge_on <span class="free">A</span> <span class="free">rha</span> <span class="free">boa</span> <span class="free">ma</span><span class="main">;</span> merge_on <span class="free">B</span> <span class="free">rhb</span> <span class="free">bob</span> <span class="free">mb</span> <span class="main">⟧</span>
  <span class="main">⟹</span> merge_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> set3_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span> <span class="main">(</span>root_hash_F <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(</span>blinding_of_F <span class="free">rha</span> <span class="free">boa</span> <span class="free">rhb</span> <span class="free">bob</span><span class="main">)</span> <span class="main">(</span><span class="free">merge_F</span> <span class="free">rha</span> <span class="free">ma</span> <span class="free">rhb</span> <span class="free">mb</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> merge_F <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> merge_on_F<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Merging on the least fixpoint ›</span></span>

<span class="keyword1" id="Generic_ADS_Construction-wfP_subterm_T"><span class="command">lemma</span></span> wfP_subterm_T<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set3_F<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>the_T<span class="hidden">⇩</span><sub>m</sub> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wfPUNIVI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> IH<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> P x
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Generic_ADS_Construction-irrefl_subterm_T"><span class="command">lemma</span></span> irrefl_subterm_T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set3_F<span class="hidden">⇩</span><sub>m</sub> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≠</span> the_T<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wfP_subterm_T <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wfP_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_irrefl<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> merge"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">merge_T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> T<span class="hidden">⇩</span><sub>m</sub> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_T</span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> map_option T<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>merge_F <span class="free">rh</span> <span class="free">m</span> <span class="main">(</span>root_hash_T <span class="free">rh</span><span class="main">)</span> <span class="free">merge_T</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set3_F<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>the_T<span class="hidden">⇩</span><sub>m</sub> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="keyword1">&lt;*lex*&gt;</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set3_F<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>the_T<span class="hidden">⇩</span><sub>m</sub> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wfP_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> wfP_subterm_T<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Generic_ADS_Construction-merge_on_T"><span class="command">lemma</span></span> merge_on_T <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="free">A</span> <span class="free">rh</span> <span class="free">bo</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_T<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span> <span class="main">(</span>root_hash_T <span class="free">rh</span><span class="main">)</span> <span class="main">(</span>blinding_of_T <span class="free">rh</span> <span class="free">bo</span><span class="main">)</span> merge_T"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span> <span class="var">?m</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> merge_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">rh</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="quoted"><span class="free">m</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?h</span> <span class="skolem">a</span> <span class="main">=</span> <span class="var">?h</span> <span class="skolem">b</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="var">?h</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="var">?h</span> <span class="skolem">b</span> <span class="main">⟶</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> mem_Collect_eq
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
      <span class="keyword1"><span class="command">interpret</span></span> merge_on <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> set1_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">y</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> set3_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">y</span> <span class="main">⊆</span> set3_F<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">x</span><span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"root_hash_F <span class="free">rh</span> <span class="var">?h</span>"</span></span> <span class="quoted"><span class="quoted">"blinding_of_F <span class="free">rh</span> <span class="free">bo</span> <span class="var">?h</span> <span class="var">?bo</span>"</span></span> <span class="quoted"><span class="quoted">"merge_F <span class="free">rh</span> <span class="free">m</span> <span class="var">?h</span> <span class="var">?m</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
        <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set3_F<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> T<span class="hidden">⇩</span><sub>m</sub>.prems <span class="keyword1"><span class="command">have</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"set1_T<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">a</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
        <span class="keyword1"><span class="command">from</span></span> T<span class="hidden">⇩</span><sub>m</sub>.IH<span class="main">[</span><span class="operator">OF</span> a a'<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"root_hash_T <span class="free">rh</span> <span class="skolem">a</span> <span class="main">=</span> root_hash_T <span class="free">rh</span> <span class="skolem">b</span>
           <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> merge_T <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> blinding_of_T <span class="free">rh</span> <span class="free">bo</span> <span class="skolem">a</span> <span class="bound">ab</span> <span class="main">∧</span> blinding_of_T <span class="free">rh</span> <span class="free">bo</span> <span class="skolem">b</span> <span class="bound">ab</span> <span class="main">∧</span>
                    <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> blinding_of_T <span class="free">rh</span> <span class="free">bo</span> <span class="skolem">a</span> <span class="bound">u</span> <span class="main">⟶</span> blinding_of_T <span class="free">rh</span> <span class="free">bo</span> <span class="skolem">b</span> <span class="bound">u</span> <span class="main">⟶</span> blinding_of_T <span class="free">rh</span> <span class="free">bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"root_hash_T <span class="free">rh</span> <span class="skolem">a</span> <span class="main">≠</span> root_hash_T <span class="free">rh</span> <span class="skolem">b</span> <span class="main">⟹</span> merge_T <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sym<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> T<span class="hidden">⇩</span><sub>m</sub>.prems
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> conjI strip<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> join <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blinding_of_T.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> undefined<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">=</span> <span class="var">?h</span> <span class="skolem">b</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="var">?h</span> <span class="skolem">b</span> <span class="main">⟹</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> merge_T <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> merge_on_T<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Generic_ADS_Construction-merge_T_cong"><span class="command">lemma</span></span> merge_T_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set1_T<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span> <span class="main">⟹</span> <span class="free">m</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">m'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_T <span class="free">rh</span> <span class="free">m</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> merge_T <span class="free">rh</span> <span class="free">m'</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_T.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"map_option <span class="main"><span class="main">_</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> merge_F_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Merging and composition ›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rha</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> merge"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rhb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> hash"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">mb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span> merge"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">merge_G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'b<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> G<span class="hidden">⇩</span><sub>m</sub> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_G</span> <span class="main">(</span>G<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">y'</span></span></span> <span class="keyword1">of</span> G<span class="hidden">⇩</span><sub>m</sub> <span class="bound">y</span> <span class="main">⇒</span>
    map_option G<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>merge_F <span class="main">(</span>root_hash_T <span class="free">rha</span><span class="main">)</span> <span class="main">(</span>merge_T <span class="free">rha</span> <span class="free">ma</span><span class="main">)</span> <span class="free">rhb</span> <span class="free">mb</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Generic_ADS_Construction-merge_G_simps"><span class="command">lemma</span></span> merge_G_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"merge_G <span class="main">(</span>G<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>G<span class="hidden">⇩</span><sub>m</sub> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> map_option G<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>merge_F <span class="main">(</span>root_hash_T <span class="free">rha</span><span class="main">)</span> <span class="main">(</span>merge_T <span class="free">rha</span> <span class="free">ma</span><span class="main">)</span> <span class="free">rhb</span> <span class="free">mb</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> merge_G.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Generic_ADS_Construction-merge_on_G"><span class="command">lemma</span></span> merge_on_G<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"merge_on <span class="free">A</span> <span class="free">rha</span> <span class="free">boa</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"merge_on <span class="free">B</span> <span class="free">rhb</span> <span class="free">bob</span> <span class="free">mb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_G<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> set3_G<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span> <span class="main">(</span>root_hash_G <span class="free">rha</span> <span class="free">rhb</span><span class="main">)</span> <span class="main">(</span>blinding_of_G <span class="free">rha</span> <span class="free">boa</span> <span class="free">rhb</span> <span class="free">bob</span><span class="main">)</span> merge_G"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"merge_on <span class="var">?A</span> <span class="var">?h</span> <span class="var">?bo</span> <span class="var">?m</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> merge_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">rha</span></span> <span class="quoted"><span class="free">boa</span></span> <span class="quoted"><span class="free">ma</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> b<span class="main">:</span> merge_on <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">rhb</span></span> <span class="quoted"><span class="free">bob</span></span> <span class="quoted"><span class="free">mb</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> F<span class="main">:</span> merge_on 
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> set1_T<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span> <span class="main">∧</span> set3_F<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"root_hash_F <span class="main">(</span>root_hash_T <span class="free">rha</span><span class="main">)</span> <span class="free">rhb</span>"</span></span>
    <span class="quoted"><span class="quoted">"blinding_of_F <span class="main">(</span>root_hash_T <span class="free">rha</span><span class="main">)</span> <span class="main">(</span>blinding_of_T <span class="free">rha</span> <span class="free">boa</span><span class="main">)</span> <span class="free">rhb</span> <span class="free">bob</span>"</span></span>
    <span class="quoted"><span class="quoted">"merge_F <span class="main">(</span>root_hash_T <span class="free">rha</span><span class="main">)</span> <span class="main">(</span>merge_T <span class="free">rha</span> <span class="free">ma</span><span class="main">)</span> <span class="free">rhb</span> <span class="free">mb</span>"</span></span>
    <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ab</span><span class="main">.</span> <span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Some <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="var">?bo</span> <span class="skolem">a</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="skolem">b</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="var">?bo</span> <span class="bound">ab</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">=</span> <span class="var">?h</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> F.join <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blinding_of_G.simps<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="var">?h</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> F.undefined<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> merge_G <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span> <span class="main">=</span> merge_on_G<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Generic_ADS_Construction-merge_G_cong"><span class="command">lemma</span></span> merge_G_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set1_G<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span> <span class="main">⟹</span> <span class="free">ma</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">ma'</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set3_G<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span> <span class="main">⟹</span> <span class="free">mb</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">mb'</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟧</span>
   <span class="main">⟹</span> merge_G <span class="free">rha</span> <span class="free">ma</span> <span class="free">rhb</span> <span class="free">mb</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> merge_G <span class="free">rha</span> <span class="free">ma'</span> <span class="free">rhb</span> <span class="free">mb'</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"map_option <span class="main"><span class="main">_</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> merge_F_cong merge_T_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Inclusion_Proof_Construction">
<div class="head">
<h1>Theory Inclusion_Proof_Construction</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Andreas Lochbihler, Digital Asset
   Author: Ognjen Maric, Digital Asset *)</span>

<span class="keyword1"><span class="command">theory</span></span> Inclusion_Proof_Construction <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#ADS_Construction">ADS_Construction</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">blind_blindable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> blindable<span class="hidden">⇩</span><sub>m</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> blindable<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blind_blindable</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>Blinded <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Blinded <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">blind_blindable</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>Unblinded <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Blinded <span class="main">(</span>Content <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-hash_blind_blindable"><span class="command">lemma</span></span> hash_blind_blindable <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hash_blindable <span class="free">h</span> <span class="main">(</span>blind_blindable <span class="free">h</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> hash_blindable <span class="free">h</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inclusion proof construction for rose trees›</span></span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Hashing, embedding and blinding source trees ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span>"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">hash_source_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rose_tree <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> rose_tree<span class="hidden">⇩</span><sub>h</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_source_tree</span> <span class="main">(</span>Tree <span class="main">(</span><span class="free"><span class="bound"><span class="entity">data</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">subtrees</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Tree<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>Content <span class="main">(</span><span class="free">h</span> <span class="free"><span class="bound"><span class="entity">data</span></span></span><span class="main">,</span> map <span class="free">hash_source_tree</span> <span class="free"><span class="bound"><span class="entity">subtrees</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span>"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">embed_source_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rose_tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">embed_source_tree</span> <span class="main">(</span>Tree <span class="main">(</span><span class="free"><span class="bound"><span class="entity">data</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">subtrees</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    Tree<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Unblinded <span class="main">(</span><span class="free">e</span> <span class="free"><span class="bound"><span class="entity">data</span></span></span><span class="main">,</span> map <span class="free">embed_source_tree</span> <span class="free"><span class="bound"><span class="entity">subtrees</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span>"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">blind_source_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rose_tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blind_source_tree</span> <span class="main">(</span>Tree <span class="main">(</span><span class="free"><span class="bound"><span class="entity">data</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">subtrees</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Tree<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Blinded <span class="main">(</span>Content <span class="main">(</span><span class="free">h</span> <span class="free"><span class="bound"><span class="entity">data</span></span></span><span class="main">,</span> map <span class="main">(</span>hash_source_tree <span class="free">h</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subtrees</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">case_of_simps</span></span> blind_source_tree_cases<span class="main">:</span> blind_source_tree.simps

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_blinded</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_blinded</span> <span class="main">(</span>Tree<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Blinded <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_blinded</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-hash_blinded_simp"><span class="command">lemma</span></span> hash_blinded_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"hash_tree <span class="free">h'</span> <span class="main">(</span>blind_source_tree <span class="free">h</span> <span class="free">st</span><span class="main">)</span> <span class="main">=</span> hash_source_tree <span class="free">h</span> <span class="free">st</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">st</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> blind_source_tree.cases<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_def<span class="main">)</span>

<span class="keyword1" id="Inclusion_Proof_Construction-hash_embedded_simp"><span class="command">lemma</span></span> hash_embedded_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hash_tree <span class="free">h</span> <span class="main">(</span>embed_source_tree <span class="free">e</span> <span class="free">st</span><span class="main">)</span> <span class="main">=</span> hash_source_tree <span class="main">(</span><span class="free">h</span> <span class="main">∘</span> <span class="free">e</span><span class="main">)</span> <span class="free">st</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">st</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> embed_source_tree.induct<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_def<span class="main">)</span>

<span class="keyword1" id="Inclusion_Proof_Construction-blinded_embedded_same_hash"><span class="command">lemma</span></span> blinded_embedded_same_hash<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hash_tree <span class="free">h''</span> <span class="main">(</span>blind_source_tree <span class="main">(</span><span class="free">h</span> <span class="keyword1">o</span> <span class="free">e</span><span class="main">)</span> <span class="free">st</span><span class="main">)</span> <span class="main">=</span> hash_tree <span class="free">h</span> <span class="main">(</span>embed_source_tree <span class="free">e</span> <span class="free">st</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hash_blinded_simp hash_embedded_simp<span class="main">)</span>

<span class="keyword1" id="Inclusion_Proof_Construction-blinding_blinds"><span class="command">lemma</span></span> blinding_blinds <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_blinded <span class="main">(</span>blind_source_tree <span class="free">h</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blind_source_tree_cases <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> rose_tree.split<span class="main">)</span>

<span class="keyword1" id="Inclusion_Proof_Construction-blinded_blinds_embedded"><span class="command">lemma</span></span> blinded_blinds_embedded<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"blinding_of_tree <span class="free">h</span> <span class="free">bo</span> <span class="main">(</span>blind_source_tree <span class="main">(</span><span class="free">h</span> <span class="keyword1">o</span> <span class="free">e</span><span class="main">)</span> <span class="free">st</span><span class="main">)</span> <span class="main">(</span>embed_source_tree <span class="free">e</span> <span class="free">st</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">st</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> blind_source_tree.cases<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hash_embedded_simp<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">embed_hash_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ha</span> rose_tree<span class="hidden">⇩</span><sub>h</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ha</span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">embed_hash_tree</span> <span class="main">(</span>Tree<span class="hidden">⇩</span><sub>h</sub> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> Tree<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Blinded <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span>


<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary definitions: selectors and list splits›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">children</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rose_tree <span class="main">⇒</span> <span class="tfree">'a</span> rose_tree list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">children</span> <span class="main">(</span>Tree <span class="main">(</span><span class="free"><span class="bound"><span class="entity">data</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">subtrees</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">subtrees</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">children<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">children<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>Tree<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Unblinded <span class="main">(</span><span class="free"><span class="bound"><span class="entity">data</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">subtrees</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">subtrees</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">children<span class="hidden">⇩</span><sub>m</sub></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">splits</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">splits</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">splits</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">#</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">splits</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-splits_iff"><span class="command">lemma</span></span> splits_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>splits <span class="free">ll</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ll</span> <span class="main">=</span> <span class="free">l</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ll</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_eq_append_conv<span class="main">)</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Zippers ›</span></span>
<span class="comment1">(************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Zippers provide a neat representation of tree-like ADSs when they have only a single 
  unblinded subtree. The zipper path provides the "inclusion proof" that the unblinded subtree is
  included in a larger structure. ›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> path_elem <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> rose_tree list <span class="main">×</span> <span class="tfree">'a</span> rose_tree list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> path <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> path_elem list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> zipper <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> path <span class="main">×</span> <span class="tfree">'a</span> rose_tree"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">zipper_of_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rose_tree <span class="main">⇒</span> <span class="tfree">'a</span> zipper"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zipper_of_tree</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
               
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tree_of_zipper</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zipper <span class="main">⇒</span> <span class="tfree">'a</span> rose_tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_of_zipper</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tree_of_zipper</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">tree_of_zipper</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="main">(</span>Tree <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">case_of_simps</span></span> tree_of_zipper_cases<span class="main">:</span> tree_of_zipper.simps

<span class="keyword1" id="Inclusion_Proof_Construction-tree_of_zipper_id"><span class="command">lemma</span></span> tree_of_zipper_id<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tree_of_zipper <span class="main">(</span>zipper_of_tree <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zipper_of_tree_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">zipper_children</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zipper <span class="main">⇒</span> <span class="tfree">'a</span> zipper list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zipper_children</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> Tree <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>splits <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-zipper_children_same_tree"><span class="command">lemma</span></span> zipper_children_same_tree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z'</span> <span class="main">∈</span> set <span class="main">(</span>zipper_children <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tree_of_zipper <span class="free">z'</span> <span class="main">=</span> tree_of_zipper <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> Tree <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zipper_children.cases<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> ltr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>splits <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> z <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splits_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> path_elem<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> path<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> path_elem<span class="hidden">⇩</span><sub>m</sub> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> path<span class="hidden">⇩</span><sub>m</sub> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">zipper_of_tree<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> zipper<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zipper_of_tree<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tree_of_zipper<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_of_zipper<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tree_of_zipper<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">tree_of_zipper<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> Tree<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Unblinded <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-tree_of_zipper"><span class="command">lemma</span></span> tree_of_zipper<span class="hidden">⇩</span><sub>m</sub>_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="free">p'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p'</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">zipper_children<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> zipper<span class="hidden">⇩</span><sub>m</sub> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zipper_children<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> Tree<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Unblinded <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>splits <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> "</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">zipper_children<span class="hidden">⇩</span><sub>m</sub></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-zipper_children_same_tree"><span class="command">lemma</span></span> zipper_children_same_tree<span class="hidden">⇩</span><sub>m</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z'</span> <span class="main">∈</span> set <span class="main">(</span>zipper_children<span class="hidden">⇩</span><sub>m</sub> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="free">z'</span> <span class="main">=</span> tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> Tree<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Unblinded <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zipper_children<span class="hidden">⇩</span><sub>m</sub>.cases<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> ltr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>splits <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> z <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splits_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">blind_path_elem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> path_elem <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> path_elem<span class="hidden">⇩</span><sub>m</sub>"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blind_path_elem</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> map <span class="main">(</span>blind_source_tree <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> map <span class="main">(</span>blind_source_tree <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">case_of_simps</span></span> blind_path_elem_cases<span class="main">:</span> blind_path_elem.simps

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">blind_path</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> path <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> path<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blind_path</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">≡</span> map <span class="main">(</span>blind_path_elem <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">embed_path_elem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> path_elem <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> path_elem<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">embed_path_elem</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span> map <span class="main">(</span>embed_source_tree <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> map <span class="main">(</span>embed_source_tree <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">embed_path</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> path <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> path<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">embed_path</span> <span class="free"><span class="bound"><span class="entity">embed_elem</span></span></span> <span class="main">≡</span> map <span class="main">(</span>embed_path_elem <span class="free"><span class="bound"><span class="entity">embed_elem</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-hash_tree_of_zipper_same_path"><span class="command">lemma</span></span> hash_tree_of_zipper_same_path<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"hash_tree <span class="free">h</span> <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hash_tree <span class="free">h</span> <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="main">)</span>
        <span class="main">⟷</span> hash_tree <span class="free">h</span> <span class="free">v</span> <span class="main">=</span> hash_tree <span class="free">h</span> <span class="free">v'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v'</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">hash_path_elem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> path_elem<span class="hidden">⇩</span><sub>m</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">×</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> rose_tree<span class="hidden">⇩</span><sub>h</sub> list <span class="main">×</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span> rose_tree<span class="hidden">⇩</span><sub>h</sub> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_path_elem</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> map <span class="main">(</span>hash_tree <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> map <span class="main">(</span>hash_tree <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-hash_view_zipper_eqI"><span class="command">lemma</span></span> hash_view_zipper_eqI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> hash_list <span class="main">(</span>hash_path_elem <span class="free">h</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> hash_list <span class="main">(</span>hash_path_elem <span class="free">h'</span><span class="main">)</span> <span class="free">p'</span><span class="main">;</span>
    hash_tree <span class="free">h</span> <span class="free">v</span> <span class="main">=</span> hash_tree <span class="free">h'</span> <span class="free">v'</span> <span class="main">⟧</span> <span class="main">⟹</span>
    hash_tree <span class="free">h</span> <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hash_tree <span class="free">h'</span> <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p'</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v'</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_def<span class="main">)</span>

<span class="keyword1" id="Inclusion_Proof_Construction-blind_embed_path_same_hash"><span class="command">lemma</span></span> blind_embed_path_same_hash<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hash_tree <span class="free">h</span> <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>blind_path <span class="free">e</span> <span class="free">h</span> <span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hash_tree <span class="free">h</span> <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>embed_path <span class="free">e</span> <span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hash_path_elem <span class="free">h</span> <span class="main">∘</span> blind_path_elem <span class="free">e</span> <span class="free">h</span> <span class="main">=</span> hash_path_elem <span class="free">h</span> <span class="main">∘</span> embed_path_elem <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hash_blinded_simp hash_embedded_simp fun_eq_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">hash_source_tree</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> hash_view_zipper_eqI<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> embed_path_def blind_path_def list.map_comp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-tree_of_embed_commute"><span class="command">lemma</span></span> tree_of_embed_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>embed_path <span class="free">e</span> <span class="free">p</span><span class="main">,</span> embed_source_tree <span class="free">e</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> embed_source_tree <span class="free">e</span> <span class="main">(</span>tree_of_zipper <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tree_of_zipper.induct<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> embed_path_def<span class="main">)</span>

<span class="keyword1" id="Inclusion_Proof_Construction-childz_same_tree"><span class="command">lemma</span></span> childz_same_tree<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">t</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>splits <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span>
  tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>embed_path <span class="free">e</span> <span class="free">p</span><span class="main">,</span> embed_source_tree <span class="free">e</span> <span class="main">(</span>Tree <span class="main">(</span><span class="free">d</span><span class="main">,</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">=</span> tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>embed_path <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">d</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span><span class="main">,</span> embed_source_tree <span class="free">e</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tree_of_embed_commute splits_iff <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> embed_source_tree.simps<span class="main">)</span>

<span class="keyword1" id="Inclusion_Proof_Construction-blinding_of_same_path"><span class="command">lemma</span></span> blinding_of_same_path<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bo<span class="main">:</span> <span class="quoted"><span class="quoted">"blinding_of_on UNIV <span class="free">h</span> <span class="free">bo</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"blinding_of_tree <span class="free">h</span> <span class="free">bo</span> <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⟷</span> blinding_of_tree <span class="free">h</span> <span class="free">bo</span> <span class="free">t</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> blinding_of_on <span class="quoted">UNIV</span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> tree<span class="main">:</span> blinding_of_on <span class="quoted">UNIV</span> <span class="quoted"><span class="quoted">"hash_tree <span class="free">h</span>"</span></span> <span class="quoted"><span class="quoted">"blinding_of_tree <span class="free">h</span> <span class="free">bo</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_append list.rel_refl a.refl tree.refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-zipper_children_size_change"><span class="command">lemma</span></span> zipper_children_size_change <span class="main">[</span><span class="operator">termination_simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zipper_children <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> size <span class="free">b</span> <span class="main">&lt;</span> size <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splits_iff Set.image_iff<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹All zippers of a rose tree›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span>"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">zippers_rose_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zipper <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span><span class="main">,</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span> zipper<span class="hidden">⇩</span><sub>m</sub> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zippers_rose_tree</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>blind_path <span class="free">e</span> <span class="free">h</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> embed_source_tree <span class="free">e</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">#</span> 
    concat <span class="main">(</span>map <span class="free">zippers_rose_tree</span> <span class="main">(</span>zipper_children <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span> <span class="main">=</span> zippers_rose_tree.simps zipper_children.simps

<span class="keyword1" id="Inclusion_Proof_Construction-zippers_rose_tree_same_hash'"><span class="command">lemma</span></span> zippers_rose_tree_same_hash'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> set <span class="main">(</span>zippers_rose_tree <span class="free">e</span> <span class="free">h</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hash_tree <span class="free">h</span> <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> 
    hash_tree <span class="free">h</span> <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>embed_path <span class="free">e</span> <span class="free">p</span><span class="main">,</span> embed_source_tree <span class="free">e</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zippers_rose_tree.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">p</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"1.prems"</span><span class="main">[</span><span class="operator">unfolded</span> zippers_rose_tree.simps<span class="main">]</span> 
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>find<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="main">(</span>blind_path <span class="free">e</span> <span class="free">h</span> <span class="skolem">p</span><span class="main">,</span> embed_source_tree <span class="free">e</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>rec<span class="main">)</span> <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">l</span> <span class="skolem">t'</span> <span class="skolem">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Tree <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>splits <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> set <span class="main">(</span>zippers_rose_tree <span class="free">e</span> <span class="free">h</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zipper_children.simps<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> rec
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="quoted">"1.hyps"</span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">l</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">r</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">p</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">t'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_image_eqI zipper_children.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> childz_same_tree comp_apply embed_source_tree.simps rec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blind_embed_path_same_hash<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-zippers_rose_tree_blinding_of"><span class="command">lemma</span></span> zippers_rose_tree_blinding_of<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"blinding_of_on UNIV <span class="free">h</span> <span class="free">bo</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> set <span class="main">(</span>zippers_rose_tree <span class="free">e</span> <span class="free">h</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_tree <span class="free">h</span> <span class="free">bo</span> <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="free">z</span><span class="main">)</span> <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>blind_path <span class="free">e</span> <span class="free">h</span> <span class="free">p</span><span class="main">,</span> embed_source_tree <span class="free">e</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> z
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zippers_rose_tree.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">p</span> <span class="skolem">t</span><span class="main">)</span>

  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> blinding_of_on <span class="quoted">UNIV</span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">bo</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> rt<span class="main">:</span> blinding_of_on <span class="quoted">UNIV</span> <span class="quoted"><span class="quoted">"hash_tree <span class="free">h</span>"</span></span> <span class="quoted"><span class="quoted">"blinding_of_tree <span class="free">h</span> <span class="free">bo</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"1.prems"</span><span class="main">[</span><span class="operator">unfolded</span> zippers_rose_tree.simps<span class="main">]</span> 
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>find<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="main">(</span>blind_path <span class="free">e</span> <span class="free">h</span> <span class="skolem">p</span><span class="main">,</span> embed_source_tree <span class="free">e</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>rec<span class="main">)</span> <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">l</span> <span class="skolem">t'</span> <span class="skolem">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Tree <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>splits <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> set <span class="main">(</span>zippers_rose_tree <span class="free">e</span> <span class="free">h</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zipper_children.simps<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> find
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rt.refl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> rec
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blinding_of_tree <span class="free">h</span> <span class="free">bo</span> 
      <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="free">z</span><span class="main">)</span> 
      <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>blind_path <span class="free">e</span> <span class="free">h</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">p</span><span class="main">)</span><span class="main">,</span> embed_source_tree <span class="free">e</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> 1<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_image_eqI zipper_children.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blinding_of_tree <span class="free">h</span> <span class="free">bo</span> 
      <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>blind_path <span class="free">e</span> <span class="free">h</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">p</span><span class="main">)</span><span class="main">,</span> embed_source_tree <span class="free">e</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>tree_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>blind_path <span class="free">e</span> <span class="free">h</span> <span class="skolem">p</span><span class="main">,</span> embed_source_tree <span class="free">e</span> <span class="main">(</span>Tree <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rec
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blind_path_def splits_iff blinding_of_same_path<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> a.refl list_all2_append list_all2_same list.rel_map blinded_blinds_embedded rt.refl<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>rt.trans<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rec <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-zippers_rose_tree_neq_Nil"><span class="command">lemma</span></span> zippers_rose_tree_neq_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"zippers_rose_tree <span class="free">e</span> <span class="free">h</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zippers_rose_tree.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> comp_fun_idem<span class="main">)</span> fold_set_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="free">f</span> <span class="free">z</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Finite_Set.fold <span class="free">f</span> <span class="main">(</span>Finite_Set.fold <span class="free">f</span> <span class="free">z</span> <span class="free">A</span><span class="main">)</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">context</span></span> merkle_interface <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-comp_fun_idem_merge"><span class="command">lemma</span></span> comp_fun_idem_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"comp_fun_idem <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bind_split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assoc bind.bind_lunit bind.bind_lzero idem option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">interpretation</span></span> merge<span class="main">:</span> comp_fun_idem <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> comp_fun_idem_merge<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> set <span class="main">⇒</span> <span class="tfree">'a<span class="hidden">⇩</span><sub>m</sub></span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Merge</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> infinite <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-Merge_empty"><span class="command">lemma</span></span> Merge_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Merge <span class="main">{}</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Merge_def<span class="main">)</span>

<span class="keyword1" id="Inclusion_Proof_Construction-Merge_infinite"><span class="command">lemma</span></span> Merge_infinite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="free">A</span> <span class="main">⟹</span> Merge <span class="free">A</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Merge_def<span class="main">)</span>

<span class="keyword1" id="Inclusion_Proof_Construction-Merge_cong_start"><span class="command">lemma</span></span> Merge_cong_start<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">x</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">y</span><span class="main">)</span> <span class="free">A</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">x</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">y</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">m</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> merge.fold_insert_idem2<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">y</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> merge.fold_insert_idem2<span class="main">)</span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-Merge_insert"><span class="command">lemma</span></span> Merge_insert <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Merge <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> Some <span class="free">x</span> <span class="keyword1">else</span> Merge <span class="free">A</span> <span class="main">⤜</span> <span class="free">m</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Merge_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> Merge_cong_start<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">SOME</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> <span class="free"><span class="free"><span class="free">A</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> someI<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Merge_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Merge_def idem<span class="main">)</span>

<span class="keyword1" id="Inclusion_Proof_Construction-Merge_insert_alt"><span class="command">lemma</span></span> Merge_insert_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Merge <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">x</span><span class="main">)</span> <span class="free">A</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">x</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">unfolding</span></span> Merge_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> Merge_cong_start<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> someI<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> merge.fold_insert_idem2<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> idem<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-Merge_None"><span class="command">lemma</span></span> Merge_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> None <span class="free">A</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Inclusion_Proof_Construction-Merge_union"><span class="command">lemma</span></span> Merge_union<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Merge <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> Merge <span class="free">B</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> Merge <span class="free">A</span> <span class="keyword1">else</span> <span class="main">(</span>Merge <span class="free">A</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Merge <span class="free">B</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="main">∪</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Merge_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> Merge_cong_start<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">SOME</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> <span class="free"><span class="free"><span class="free">B</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> someI<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Merge <span class="free">B</span><span class="main">)</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Merge_def merge.fold_set_union<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Merge <span class="free">A</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Merge <span class="free">B</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Merge <span class="free">B</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main">(</span><span class="operator">subst</span> Merge_insert_alt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> commute<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> commute<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Inclusion_Proof_Construction-Merge_upper"><span class="command">lemma</span></span> Merge_upper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"Merge <span class="free">A</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Merge <span class="free">A</span> <span class="main">=</span> Merge <span class="main">(</span>insert <span class="free">y</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Merge <span class="free">A</span> <span class="main">⤜</span> <span class="free">m</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">y</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bo_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-Merge_least"><span class="command">lemma</span></span> Merge_least<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"Merge <span class="free">A</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">bo</span> <span class="bound">a</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="free">x</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> m <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Merge_def a_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">bo</span> <span class="skolem">a</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI u <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> A * u <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">x</span> <span class="skolem">a</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> merge.fold_insert_idem2<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-Merge_defined"><span class="command">lemma</span></span> Merge_defined<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">h</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">h</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Merge <span class="free">A</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> ha<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">h</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">h</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">assume</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"Merge <span class="free">A</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⤜</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Merge_def a_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> ha
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">x</span> <span class="skolem">a</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> nothing <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main">:</span> merge.fold_insert_idem2›</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_respects_hashes<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join vimage2p_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> hash<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inclusion_Proof_Construction-Merge_hash"><span class="command">lemma</span></span> Merge_hash<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Merge <span class="free">A</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">a</span> <span class="main">=</span> <span class="free">h</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Merge_upper<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> hash <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage2p_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Canton_Transaction_Tree">
<div class="head">
<h1>Theory Canton_Transaction_Tree</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Canton_Transaction_Tree <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Inclusion_Proof_Construction">Inclusion_Proof_Construction</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Canton's hierarchical transaction trees›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> view_data
<span class="keyword1"><span class="command">typedecl</span></span> view_metadata
<span class="keyword1"><span class="command">typedecl</span></span> common_metadata
<span class="keyword1"><span class="command">typedecl</span></span> participant_metadata

<span class="keyword1"><span class="command">datatype</span></span> view <span class="main">=</span> View <span class="quoted">view_metadata</span> <span class="quoted">view_data</span> <span class="main">(</span><span class="free"><span class="entity">subviews</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"view list"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> transaction <span class="main">=</span> Transaction <span class="quoted">common_metadata</span> <span class="quoted">participant_metadata</span> <span class="main">(</span><span class="free"><span class="entity">views</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"view list"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Views as authenticated data structures›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> view_metadata<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"view_metadata blindable<span class="hidden">⇩</span><sub>h</sub>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> view_data<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"view_data blindable<span class="hidden">⇩</span><sub>h</sub>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> view<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> View<span class="hidden">⇩</span><sub>h</sub> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>view_metadata<span class="hidden">⇩</span><sub>h</sub> <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span> view_data<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span> view<span class="hidden">⇩</span><sub>h</sub> list<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> blindable<span class="hidden">⇩</span><sub>h</sub>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> view_metadata<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>view_metadata<span class="main">,</span> view_metadata<span class="main">)</span> blindable<span class="hidden">⇩</span><sub>m</sub>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> view_data<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>view_data<span class="main">,</span> view_data<span class="main">)</span> blindable<span class="hidden">⇩</span><sub>m</sub>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> view<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> View<span class="hidden">⇩</span><sub>m</sub> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>view_metadata<span class="hidden">⇩</span><sub>m</sub> <span class="keyword1">×<span class="hidden">⇩</span><sub>m</sub></span> view_data<span class="hidden">⇩</span><sub>m</sub><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>m</sub></span> view<span class="hidden">⇩</span><sub>m</sub> list<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span>
    <span class="main">(</span>view_metadata<span class="hidden">⇩</span><sub>h</sub> <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span> view_data<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span> view<span class="hidden">⇩</span><sub>h</sub> list<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> blindable<span class="hidden">⇩</span><sub>m</sub>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_view_data</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>view_data<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> view_data<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_view_data</span> <span class="main">≡</span> hash_blindable id"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">blinding_of_view_data</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view_data<span class="hidden">⇩</span><sub>m</sub> blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_view_data</span> <span class="main">≡</span> blinding_of_blindable id <span class="main">(=)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">merge_view_data</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view_data<span class="hidden">⇩</span><sub>m</sub> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_view_data</span> <span class="main">≡</span> merge_blindable id merge_discrete"</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-merkle_view_data"><span class="command">lemma</span></span> merkle_view_data<span class="main">:</span>
  <span class="quoted"><span class="quoted">"merkle_interface hash_view_data blinding_of_view_data merge_view_data"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_view_metadata</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>view_metadata<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> view_metadata<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_view_metadata</span> <span class="main">≡</span> hash_blindable id"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">blinding_of_view_metadata</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view_metadata<span class="hidden">⇩</span><sub>m</sub> blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_view_metadata</span> <span class="main">≡</span> blinding_of_blindable id <span class="main">(=)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">merge_view_metadata</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view_metadata<span class="hidden">⇩</span><sub>m</sub> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_view_metadata</span> <span class="main">≡</span> merge_blindable id merge_discrete"</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-merkle_view_metadata"><span class="command">lemma</span></span> merkle_view_metadata<span class="main">:</span>
  <span class="quoted"><span class="quoted">"merkle_interface hash_view_metadata blinding_of_view_metadata merge_view_metadata"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">type_synonym</span></span> view_content <span class="main">=</span> <span class="quoted"><span class="quoted">"view_metadata <span class="main">×</span> view_data"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> view_content<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"view_metadata<span class="hidden">⇩</span><sub>h</sub> <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span> view_data<span class="hidden">⇩</span><sub>h</sub>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> view_content<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"view_metadata<span class="hidden">⇩</span><sub>m</sub> <span class="keyword1">×<span class="hidden">⇩</span><sub>m</sub></span> view_data<span class="hidden">⇩</span><sub>m</sub>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> view_merkle <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> view<span class="hidden">⇩</span><sub>h</sub>' <span class="main">=</span> <span class="quoted"><span class="quoted">"view_content<span class="hidden">⇩</span><sub>h</sub> rose_tree<span class="hidden">⇩</span><sub>h</sub>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">from_view<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view<span class="hidden">⇩</span><sub>h</sub> <span class="main">⇒</span> view<span class="hidden">⇩</span><sub>h</sub>'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">from_view<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">(</span>View<span class="hidden">⇩</span><sub>h</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Tree<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>map_blindable<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>map_prod id <span class="main">(</span>map <span class="free">from_view<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">to_view<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view<span class="hidden">⇩</span><sub>h</sub>' <span class="main">⇒</span> view<span class="hidden">⇩</span><sub>h</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">to_view<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">(</span>Tree<span class="hidden">⇩</span><sub>h</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> View<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>map_blindable<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>map_prod id <span class="main">(</span>map <span class="free">to_view<span class="hidden">⇩</span><sub>h</sub></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-from_to_view"><span class="command">lemma</span></span> from_to_view<span class="hidden">⇩</span><sub>h</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"from_view<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>to_view<span class="hidden">⇩</span><sub>h</sub> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blindable<span class="hidden">⇩</span><sub>h</sub>.map_comp o_def prod.map_comp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> blindable<span class="hidden">⇩</span><sub>h</sub>.map_cong prod.map_cong list.map_cong <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blindable<span class="hidden">⇩</span><sub>h</sub>.map_id<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Canton_Transaction_Tree-to_from_view"><span class="command">lemma</span></span> to_from_view<span class="hidden">⇩</span><sub>h</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_view<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>from_view<span class="hidden">⇩</span><sub>h</sub> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blindable<span class="hidden">⇩</span><sub>h</sub>.map_comp o_def prod.map_comp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> blindable<span class="hidden">⇩</span><sub>h</sub>.map_cong prod.map_cong list.map_cong <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blindable<span class="hidden">⇩</span><sub>h</sub>.map_id<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Canton_Transaction_Tree-iso_view"><span class="command">lemma</span></span> iso_view<span class="hidden">⇩</span><sub>h</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"type_definition from_view<span class="hidden">⇩</span><sub>h</sub> to_view<span class="hidden">⇩</span><sub>h</sub> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> iso_view<span class="hidden">⇩</span><sub>h</sub>

<span class="keyword1" id="Canton_Transaction_Tree-cr_view"><span class="command">lemma</span></span> cr_view<span class="hidden">⇩</span><sub>h</sub>_Grp<span class="main">:</span> <span class="quoted"><span class="quoted">"cr_view<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> Grp UNIV to_view<span class="hidden">⇩</span><sub>h</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cr_view<span class="hidden">⇩</span><sub>h</sub>_def Grp_def fun_eq_iff<span class="main">)</span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-View"><span class="command">lemma</span></span> View<span class="hidden">⇩</span><sub>h</sub>_transfer <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_blindable<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span>list_all2 pcr_view<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> pcr_view<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>h</sub> View<span class="hidden">⇩</span><sub>h</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def view<span class="hidden">⇩</span><sub>h</sub>.pcr_cr_eq cr_view<span class="hidden">⇩</span><sub>h</sub>_Grp list.rel_Grp eq_alt prod.rel_Grp blindable<span class="hidden">⇩</span><sub>h</sub>.rel_Grp<span class="main">)</span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_def<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> view<span class="hidden">⇩</span><sub>m</sub>' <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>view_content<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> view_content<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> rose_tree<span class="hidden">⇩</span><sub>m</sub>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">from_view<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view<span class="hidden">⇩</span><sub>m</sub> <span class="main">⇒</span> view<span class="hidden">⇩</span><sub>m</sub>'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">from_view<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>View<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Tree<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>map_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>map_prod id <span class="main">(</span>map <span class="free">from_view<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_prod id <span class="main">(</span>map from_view<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">to_view<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view<span class="hidden">⇩</span><sub>m</sub>' <span class="main">⇒</span> view<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">to_view<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>Tree<span class="hidden">⇩</span><sub>m</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> View<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>map_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>map_prod id <span class="main">(</span>map <span class="free">to_view<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_prod id <span class="main">(</span>map to_view<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-from_to_view"><span class="command">lemma</span></span> from_to_view<span class="hidden">⇩</span><sub>m</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"from_view<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>to_view<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blindable<span class="hidden">⇩</span><sub>m</sub>.map_comp o_def prod.map_comp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> blindable<span class="hidden">⇩</span><sub>m</sub>.map_cong prod.map_cong list.map_cong <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blindable<span class="hidden">⇩</span><sub>m</sub>.map_id<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Canton_Transaction_Tree-to_from_view"><span class="command">lemma</span></span> to_from_view<span class="hidden">⇩</span><sub>m</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_view<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>from_view<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blindable<span class="hidden">⇩</span><sub>m</sub>.map_comp o_def prod.map_comp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> blindable<span class="hidden">⇩</span><sub>m</sub>.map_cong prod.map_cong list.map_cong <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blindable<span class="hidden">⇩</span><sub>m</sub>.map_id<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Canton_Transaction_Tree-iso_view"><span class="command">lemma</span></span> iso_view<span class="hidden">⇩</span><sub>m</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"type_definition from_view<span class="hidden">⇩</span><sub>m</sub> to_view<span class="hidden">⇩</span><sub>m</sub> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> iso_view<span class="hidden">⇩</span><sub>m</sub>

<span class="keyword1" id="Canton_Transaction_Tree-cr_view"><span class="command">lemma</span></span> cr_view<span class="hidden">⇩</span><sub>m</sub>_Grp<span class="main">:</span> <span class="quoted"><span class="quoted">"cr_view<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> Grp UNIV to_view<span class="hidden">⇩</span><sub>m</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cr_view<span class="hidden">⇩</span><sub>m</sub>_def Grp_def fun_eq_iff<span class="main">)</span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-View"><span class="command">lemma</span></span> View<span class="hidden">⇩</span><sub>m</sub>_transfer <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_blindable<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span>list_all2 pcr_view<span class="hidden">⇩</span><sub>m</sub><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span>list_all2 pcr_view<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> pcr_view<span class="hidden">⇩</span><sub>m</sub><span class="main">)</span> Tree<span class="hidden">⇩</span><sub>m</sub> View<span class="hidden">⇩</span><sub>m</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def view<span class="hidden">⇩</span><sub>h</sub>.pcr_cr_eq view<span class="hidden">⇩</span><sub>m</sub>.pcr_cr_eq cr_view<span class="hidden">⇩</span><sub>h</sub>_Grp cr_view<span class="hidden">⇩</span><sub>m</sub>_Grp list.rel_Grp eq_alt prod.rel_Grp blindable<span class="hidden">⇩</span><sub>m</sub>.rel_Grp<span class="main">)</span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">code_datatype</span></span> <span class="quoted">View<span class="hidden">⇩</span><sub>h</sub></span>
<span class="keyword1"><span class="command">code_datatype</span></span> <span class="quoted">View<span class="hidden">⇩</span><sub>m</sub></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> view_merkle <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_view_content</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>view_content<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> view_content<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_view_content</span> <span class="main">≡</span> hash_prod hash_view_metadata hash_view_data"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">blinding_of_view_content</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view_content<span class="hidden">⇩</span><sub>m</sub> blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_view_content</span> <span class="main">≡</span> blinding_of_prod blinding_of_view_metadata blinding_of_view_data"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">merge_view_content</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view_content<span class="hidden">⇩</span><sub>m</sub> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_view_content</span> <span class="main">≡</span> merge_prod merge_view_metadata merge_view_data"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> hash_view <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>view<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> view<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"hash_tree hash_view_content"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> blinding_of_view <span class="main">::</span> <span class="quoted"><span class="quoted">"view<span class="hidden">⇩</span><sub>m</sub> blinding_of"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"blinding_of_tree hash_view_content blinding_of_view_content"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> merge_view <span class="main">::</span> <span class="quoted"><span class="quoted">"view<span class="hidden">⇩</span><sub>m</sub> merge"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"merge_tree hash_view_content merge_view_content"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-merkle_view"><span class="command">lemma</span></span> merkle_view <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"merkle_interface hash_view blinding_of_view merge_view"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">unfold_locales</span>

<span class="keyword1" id="Canton_Transaction_Tree-hash_view_simps"><span class="command">lemma</span></span> hash_view_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"hash_view <span class="main">(</span>View<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> 
   View<span class="hidden">⇩</span><sub>h</sub> <span class="main">(</span>hash_blindable <span class="main">(</span>hash_prod hash_view_content <span class="main">(</span>hash_list hash_view<span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hash_rt_F<span class="hidden">⇩</span><sub>m</sub>_def prod.map_comp hash_blindable_def blindable<span class="hidden">⇩</span><sub>m</sub>.map_id<span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-blinding_of_view_iff"><span class="command">lemma</span></span> blinding_of_view_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"blinding_of_view <span class="main">(</span>View<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>View<span class="hidden">⇩</span><sub>m</sub> <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span>
   blinding_of_blindable <span class="main">(</span>hash_prod hash_view_content <span class="main">(</span>hash_list hash_view<span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>blinding_of_prod blinding_of_view_content <span class="main">(</span>blinding_of_list blinding_of_view<span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Canton_Transaction_Tree-blinding_of_view_induct"><span class="command">lemma</span></span> blinding_of_view_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> blinding_of_view<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"blinding_of_view <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> blinding_of_blindable <span class="main">(</span>hash_prod hash_view_content <span class="main">(</span>hash_list hash_view<span class="main">)</span><span class="main">)</span>
             <span class="main">(</span>blinding_of_prod blinding_of_view_content <span class="main">(</span>blinding_of_list <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> blinding_of_view <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="bound">y</span>
         <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>View<span class="hidden">⇩</span><sub>m</sub> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>View<span class="hidden">⇩</span><sub>m</sub> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> blinding_of_tree.induct<span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-merge_view_simps"><span class="command">lemma</span></span> merge_view_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"merge_view <span class="main">(</span>View<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>View<span class="hidden">⇩</span><sub>m</sub> <span class="free">y</span><span class="main">)</span> <span class="main">=</span>
   map_option View<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>merge_rt_F<span class="hidden">⇩</span><sub>m</sub> hash_view_content merge_view_content hash_view merge_view <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transaction trees as authenticated data structures›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> common_metadata<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"common_metadata blindable<span class="hidden">⇩</span><sub>h</sub>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> common_metadata<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>common_metadata<span class="main">,</span> common_metadata<span class="main">)</span> blindable<span class="hidden">⇩</span><sub>m</sub>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> participant_metadata<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"participant_metadata blindable<span class="hidden">⇩</span><sub>h</sub>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> participant_metadata<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>participant_metadata<span class="main">,</span> participant_metadata<span class="main">)</span> blindable<span class="hidden">⇩</span><sub>m</sub>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> transaction<span class="hidden">⇩</span><sub>h</sub> <span class="main">=</span> Transaction<span class="hidden">⇩</span><sub>h</sub> 
  <span class="main">(</span><span class="free"><span class="entity">the_Transaction<span class="hidden">⇩</span><sub>h</sub></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>common_metadata<span class="hidden">⇩</span><sub>h</sub> <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span> participant_metadata<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span> view<span class="hidden">⇩</span><sub>h</sub> list<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> blindable<span class="hidden">⇩</span><sub>h</sub>"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> transaction<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> Transaction<span class="hidden">⇩</span><sub>m</sub> 
  <span class="main">(</span><span class="free"><span class="entity">the_Transaction<span class="hidden">⇩</span><sub>m</sub></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>common_metadata<span class="hidden">⇩</span><sub>m</sub> <span class="keyword1">×<span class="hidden">⇩</span><sub>m</sub></span> participant_metadata<span class="hidden">⇩</span><sub>m</sub><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>m</sub></span> view<span class="hidden">⇩</span><sub>m</sub> list<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span>
    <span class="main">(</span>common_metadata<span class="hidden">⇩</span><sub>h</sub> <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span> participant_metadata<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>h</sub></span> view<span class="hidden">⇩</span><sub>h</sub> list<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> blindable<span class="hidden">⇩</span><sub>m</sub>"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_common_metadata</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>common_metadata<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> common_metadata<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_common_metadata</span> <span class="main">≡</span> hash_blindable id"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">blinding_of_common_metadata</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"common_metadata<span class="hidden">⇩</span><sub>m</sub> blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_common_metadata</span> <span class="main">≡</span> blinding_of_blindable id <span class="main">(=)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">merge_common_metadata</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"common_metadata<span class="hidden">⇩</span><sub>m</sub> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_common_metadata</span> <span class="main">≡</span> merge_blindable id merge_discrete"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">hash_participant_metadata</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>participant_metadata<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> participant_metadata<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash_participant_metadata</span> <span class="main">≡</span> hash_blindable id"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">blinding_of_participant_metadata</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"participant_metadata<span class="hidden">⇩</span><sub>m</sub> blinding_of"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blinding_of_participant_metadata</span> <span class="main">≡</span> blinding_of_blindable id <span class="main">(=)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">merge_participant_metadata</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"participant_metadata<span class="hidden">⇩</span><sub>m</sub> merge"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_participant_metadata</span> <span class="main">≡</span> merge_blindable id merge_discrete"</span></span>

<span class="keyword1"><span class="command">locale</span></span> transaction_merkle <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-iso_transaction"><span class="command">lemma</span></span> iso_transaction<span class="hidden">⇩</span><sub>h</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"type_definition the_Transaction<span class="hidden">⇩</span><sub>h</sub> Transaction<span class="hidden">⇩</span><sub>h</sub> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> iso_transaction<span class="hidden">⇩</span><sub>h</sub>

<span class="keyword1" id="Canton_Transaction_Tree-Transaction"><span class="command">lemma</span></span> Transaction<span class="hidden">⇩</span><sub>h</sub>_transfer <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> pcr_transaction<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> id Transaction<span class="hidden">⇩</span><sub>h</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transaction<span class="hidden">⇩</span><sub>h</sub>.pcr_cr_eq cr_transaction<span class="hidden">⇩</span><sub>h</sub>_def rel_fun_def<span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-iso_transaction"><span class="command">lemma</span></span> iso_transaction<span class="hidden">⇩</span><sub>m</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"type_definition the_Transaction<span class="hidden">⇩</span><sub>m</sub> Transaction<span class="hidden">⇩</span><sub>m</sub> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> iso_transaction<span class="hidden">⇩</span><sub>m</sub>

<span class="keyword1" id="Canton_Transaction_Tree-Transaction"><span class="command">lemma</span></span> Transaction<span class="hidden">⇩</span><sub>m</sub>_transfer <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> pcr_transaction<span class="hidden">⇩</span><sub>m</sub><span class="main">)</span> id Transaction<span class="hidden">⇩</span><sub>m</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transaction<span class="hidden">⇩</span><sub>m</sub>.pcr_cr_eq cr_transaction<span class="hidden">⇩</span><sub>m</sub>_def rel_fun_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">code_datatype</span></span> <span class="quoted">Transaction<span class="hidden">⇩</span><sub>h</sub></span>
<span class="keyword1"><span class="command">code_datatype</span></span> <span class="quoted">Transaction<span class="hidden">⇩</span><sub>m</sub></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> transaction_merkle <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> hash_transaction <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transaction<span class="hidden">⇩</span><sub>m</sub><span class="main">,</span> transaction<span class="hidden">⇩</span><sub>h</sub><span class="main">)</span> hash"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"hash_blindable <span class="main">(</span>hash_prod <span class="main">(</span>hash_prod hash_common_metadata hash_participant_metadata<span class="main">)</span> <span class="main">(</span>hash_list hash_view<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> blinding_of_transaction <span class="main">::</span> <span class="quoted"><span class="quoted">"transaction<span class="hidden">⇩</span><sub>m</sub> blinding_of"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"blinding_of_blindable 
     <span class="main">(</span>hash_prod <span class="main">(</span>hash_prod hash_common_metadata hash_participant_metadata<span class="main">)</span> <span class="main">(</span>hash_list hash_view<span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>blinding_of_prod <span class="main">(</span>blinding_of_prod blinding_of_common_metadata blinding_of_participant_metadata<span class="main">)</span> <span class="main">(</span>blinding_of_list blinding_of_view<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> merge_transaction <span class="main">::</span> <span class="quoted"><span class="quoted">"transaction<span class="hidden">⇩</span><sub>m</sub> merge"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"merge_blindable
     <span class="main">(</span>hash_prod <span class="main">(</span>hash_prod hash_common_metadata hash_participant_metadata<span class="main">)</span> <span class="main">(</span>hash_list hash_view<span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>merge_prod <span class="main">(</span>merge_prod merge_common_metadata merge_participant_metadata<span class="main">)</span> <span class="main">(</span>merge_list merge_view<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-merkle_transaction"><span class="command">lemma</span></span> merkle_transaction <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"merkle_interface hash_transaction blinding_of_transaction merge_transaction"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">lemmas</span></span> hash_transaction_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> hash_transaction.abs_eq
<span class="keyword1"><span class="command">lemmas</span></span> blinding_of_transaction_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> blinding_of_transaction.abs_eq
<span class="keyword1"><span class="command">lemmas</span></span> merge_transaction_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> merge_transaction.abs_eq

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> transaction<span class="main">:</span>
  merkle_interface <span class="quoted">hash_transaction</span> <span class="quoted">blinding_of_transaction</span> <span class="quoted">merge_transaction</span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> merkle_transaction<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹
Constructing authenticated data structures for views
›</span></span>

<span class="keyword1"><span class="command">context</span></span> view_merkle <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> view' <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>view_metadata <span class="main">×</span> view_data<span class="main">)</span> rose_tree"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">from_view</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view <span class="main">⇒</span> view'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">from_view</span> <span class="main">(</span>View <span class="free"><span class="bound"><span class="entity">vm</span></span></span> <span class="free"><span class="bound"><span class="entity">vd</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> Tree <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">vm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vd</span></span></span><span class="main">)</span><span class="main">,</span> map <span class="free">from_view</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">to_view</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view' <span class="main">⇒</span> view"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">to_view</span> <span class="main">(</span>Tree <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> View <span class="main">(</span>fst <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>map_prod id <span class="main">(</span>map <span class="free">to_view</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-from_to_view"><span class="command">lemma</span></span> from_to_view <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"from_view <span class="main">(</span>to_view <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> map_cong<span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-to_from_view"><span class="command">lemma</span></span> to_from_view <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_view <span class="main">(</span>from_view <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> map_cong<span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-iso_view"><span class="command">lemma</span></span> iso_view<span class="main">:</span> <span class="quoted"><span class="quoted">"type_definition from_view to_view UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> iso_view

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">View'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>view_metadata <span class="main">×</span> view_data<span class="main">)</span> <span class="main">×</span> view list <span class="main">⇒</span> view"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">View'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">vm</span><span class="main">,</span> <span class="bound">vd</span><span class="main">)</span><span class="main">,</span> <span class="bound">vs</span><span class="main">)</span><span class="main">.</span> View <span class="bound">vm</span> <span class="bound">vd</span> <span class="bound">vs</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-View_View'"><span class="command">lemma</span></span> View_View'<span class="main">:</span> <span class="quoted"><span class="quoted">"View <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">vm</span> <span class="bound">vd</span> <span class="bound">vs</span><span class="main">.</span> View' <span class="main">(</span><span class="main">(</span><span class="bound">vm</span><span class="main">,</span> <span class="bound">vd</span><span class="main">)</span><span class="main">,</span> <span class="bound">vs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> View'_def<span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-cr_view_Grp"><span class="command">lemma</span></span> cr_view_Grp<span class="main">:</span> <span class="quoted"><span class="quoted">"cr_view <span class="main">=</span> Grp UNIV to_view"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cr_view_def Grp_def fun_eq_iff<span class="main">)</span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-View'_transfer"><span class="command">lemma</span></span> View'_transfer <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span>list_all2 pcr_view<span class="main">)</span> <span class="main">===&gt;</span> pcr_view<span class="main">)</span> Tree View'"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> view.pcr_cr_eq cr_view_Grp eq_alt prod.rel_Grp rose_tree.rel_Grp list.rel_Grp<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_def View'_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">code_datatype</span></span> <span class="quoted">View</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> view_merkle <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">embed_view_content</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view_metadata <span class="main">×</span> view_data <span class="main">⇒</span> view_metadata<span class="hidden">⇩</span><sub>m</sub> <span class="main">×</span> view_data<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">embed_view_content</span> <span class="main">≡</span> map_prod Unblinded Unblinded"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> embed_view <span class="main">::</span> <span class="quoted"><span class="quoted">"view <span class="main">⇒</span> view<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"embed_source_tree embed_view_content"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-embed_view_simps"><span class="command">lemma</span></span> embed_view_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"embed_view <span class="main">(</span>View <span class="free">vm</span> <span class="free">vd</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> View<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Unblinded <span class="main">(</span><span class="main">(</span>Unblinded <span class="free">vm</span><span class="main">,</span> Unblinded <span class="free">vd</span><span class="main">)</span><span class="main">,</span> map embed_view <span class="free">vs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> View_View' <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> transaction_merkle <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">the_Transaction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transaction <span class="main">⇒</span> <span class="main">(</span>common_metadata <span class="main">×</span> participant_metadata<span class="main">)</span> <span class="main">×</span> view list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">the_Transaction</span> <span class="main">(</span>Transaction <span class="free"><span class="bound"><span class="entity">cm</span></span></span> <span class="free"><span class="bound"><span class="entity">pm</span></span></span> <span class="free"><span class="bound"><span class="entity">views</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pm</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">views</span></span></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">views</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Transaction'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>common_metadata <span class="main">×</span> participant_metadata<span class="main">)</span> <span class="main">×</span> view list <span class="main">⇒</span> transaction"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Transaction'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">cm</span><span class="main">,</span> <span class="bound">pm</span><span class="main">)</span><span class="main">,</span> <span class="bound">views</span><span class="main">)</span><span class="main">.</span> Transaction <span class="bound">cm</span> <span class="bound">pm</span> <span class="bound">views</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-Transaction_Transaction'"><span class="command">lemma</span></span> Transaction_Transaction'<span class="main">:</span> <span class="quoted"><span class="quoted">"Transaction <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">cm</span> <span class="bound">pm</span> <span class="bound">views</span><span class="main">.</span> Transaction' <span class="main">(</span><span class="main">(</span><span class="bound">cm</span><span class="main">,</span> <span class="bound">pm</span><span class="main">)</span><span class="main">,</span> <span class="bound">views</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Transaction'_def<span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-the_Transaction_inverse"><span class="command">lemma</span></span> the_Transaction_inverse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Transaction' <span class="main">(</span>the_Transaction <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Transaction'_def<span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-Transaction'_inverse"><span class="command">lemma</span></span> Transaction'_inverse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"the_Transaction <span class="main">(</span>Transaction' <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Transaction'_def split_def<span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-iso_transaction"><span class="command">lemma</span></span> iso_transaction<span class="main">:</span> <span class="quoted"><span class="quoted">"type_definition the_Transaction Transaction' UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> iso_transaction

<span class="keyword1" id="Canton_Transaction_Tree-Transaction'_transfer"><span class="command">lemma</span></span> Transaction'_transfer <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> pcr_transaction<span class="main">)</span> id Transaction'"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transaction.pcr_cr_eq cr_transaction_def rel_fun_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">code_datatype</span></span> <span class="quoted">Transaction</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> transaction_merkle <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> embed_transaction <span class="main">::</span> <span class="quoted"><span class="quoted">"transaction <span class="main">⇒</span> transaction<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"Unblinded <span class="main">∘</span> map_prod <span class="main">(</span>map_prod Unblinded Unblinded<span class="main">)</span> <span class="main">(</span>map embed_view<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-embed_transaction_simps"><span class="command">lemma</span></span> embed_transaction_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"embed_transaction <span class="main">(</span>Transaction <span class="free">cm</span> <span class="free">pm</span> <span class="free">views</span><span class="main">)</span> <span class="main">=</span>
   Transaction<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Unblinded <span class="main">(</span><span class="main">(</span>Unblinded <span class="free">cm</span><span class="main">,</span> Unblinded <span class="free">pm</span><span class="main">)</span><span class="main">,</span> map embed_view <span class="free">views</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">views</span> <span class="keyword1"><span class="command">unfolding</span></span> Transaction_Transaction' <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Inclusion proof for the mediator›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mediator_view</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view <span class="main">⇒</span> view<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mediator_view</span> <span class="main">(</span>View <span class="free"><span class="bound"><span class="entity">vm</span></span></span> <span class="free"><span class="bound"><span class="entity">vd</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span>
   View<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Unblinded <span class="main">(</span><span class="main">(</span>Unblinded <span class="free"><span class="bound"><span class="entity">vm</span></span></span><span class="main">,</span> Blinded <span class="main">(</span>Content <span class="free"><span class="bound"><span class="entity">vd</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> map <span class="free">mediator_view</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mediator_transaction_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transaction <span class="main">⇒</span> transaction<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mediator_transaction_tree</span> <span class="main">(</span>Transaction <span class="free"><span class="bound"><span class="entity">cm</span></span></span> <span class="free"><span class="bound"><span class="entity">pm</span></span></span> <span class="free"><span class="bound"><span class="entity">views</span></span></span><span class="main">)</span> <span class="main">=</span>
   Transaction<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Unblinded <span class="main">(</span><span class="main">(</span>Unblinded <span class="free"><span class="bound"><span class="entity">cm</span></span></span><span class="main">,</span> Blinded <span class="main">(</span>Content <span class="free"><span class="bound"><span class="entity">pm</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> map mediator_view <span class="free"><span class="bound"><span class="entity">views</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">views</span>

<span class="keyword1" id="Canton_Transaction_Tree-blinding_of_mediator_view"><span class="command">lemma</span></span> blinding_of_mediator_view <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"blinding_of_view <span class="main">(</span>mediator_view <span class="free">view</span><span class="main">)</span> <span class="main">(</span>embed_view <span class="free">view</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">view</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_refl_strong<span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-blinding_of_mediator_transaction_tree"><span class="command">lemma</span></span> blinding_of_mediator_transaction_tree<span class="main">:</span>
  <span class="quoted"><span class="quoted">"blinding_of_transaction <span class="main">(</span>mediator_transaction_tree <span class="free">tt</span><span class="main">)</span> <span class="main">(</span>embed_transaction <span class="free">tt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">tt</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list.rel_refl_strong<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Inclusion proofs for participants›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next, we define a function for producing all transaction views from a given view,
  and prove its properties.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> view_path_elem <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>view_metadata <span class="main">×</span> view_data<span class="main">)</span> blindable <span class="main">×</span> view list <span class="main">×</span> view list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> view_path <span class="main">=</span> <span class="quoted"><span class="quoted">"view_path_elem list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> view_zipper <span class="main">=</span> <span class="quoted"><span class="quoted">"view_path <span class="main">×</span> view"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> view_path_elem<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>view_metadata<span class="hidden">⇩</span><sub>m</sub> <span class="keyword1">×<span class="hidden">⇩</span><sub>m</sub></span> view_data<span class="hidden">⇩</span><sub>m</sub><span class="main">)</span> <span class="main">×</span> view<span class="hidden">⇩</span><sub>m</sub> list<span class="hidden">⇩</span><sub>m</sub> <span class="main">×</span> view<span class="hidden">⇩</span><sub>m</sub> list<span class="hidden">⇩</span><sub>m</sub>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> view_path<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"view_path_elem<span class="hidden">⇩</span><sub>m</sub> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> view_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"view_path<span class="hidden">⇩</span><sub>m</sub> <span class="main">×</span> view<span class="hidden">⇩</span><sub>m</sub>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> view_merkle <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> zipper_of_view <span class="main">::</span> <span class="quoted"><span class="quoted">"view <span class="main">⇒</span> view_zipper"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">zipper_of_tree</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> view_of_zipper <span class="main">::</span> <span class="quoted"><span class="quoted">"view_zipper <span class="main">⇒</span> view"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">tree_of_zipper</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> zipper_of_view<span class="hidden">⇩</span><sub>m</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"view<span class="hidden">⇩</span><sub>m</sub> <span class="main">⇒</span> view_zipper<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">zipper_of_tree<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> view_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"view_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">⇒</span> view<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">tree_of_zipper<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-view_of_zipper"><span class="command">lemma</span></span> view_of_zipper<span class="hidden">⇩</span><sub>m</sub>_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"view_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> blind_view_path_elem <span class="main">::</span> <span class="quoted"><span class="quoted">"view_path_elem <span class="main">⇒</span> view_path_elem<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"blind_path_elem embed_view_content hash_view_content"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> blind_view_path <span class="main">::</span> <span class="quoted"><span class="quoted">"view_path <span class="main">⇒</span> view_path<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"blind_path embed_view_content hash_view_content"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> embed_view_path_elem <span class="main">::</span> <span class="quoted"><span class="quoted">"view_path_elem <span class="main">⇒</span> view_path_elem<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"embed_path_elem embed_view_content"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> embed_view_path <span class="main">::</span> <span class="quoted"><span class="quoted">"view_path <span class="main">⇒</span> view_path<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"embed_path embed_view_content"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> hash_view_path_elem <span class="main">::</span> <span class="quoted"><span class="quoted">"view_path_elem<span class="hidden">⇩</span><sub>m</sub> <span class="main">⇒</span> <span class="main">(</span>view_content<span class="hidden">⇩</span><sub>h</sub> <span class="main">×</span> view<span class="hidden">⇩</span><sub>h</sub> list <span class="main">×</span> view<span class="hidden">⇩</span><sub>h</sub> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"hash_path_elem hash_view_content"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> zippers_view <span class="main">::</span> <span class="quoted"><span class="quoted">"view_zipper <span class="main">⇒</span> view_zipper<span class="hidden">⇩</span><sub>m</sub> list"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"zippers_rose_tree embed_view_content hash_view_content"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-embed_view_path_Nil"><span class="command">lemma</span></span> embed_view_path_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"embed_view_path <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> embed_path_def<span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-zippers_view_same_hash"><span class="command">lemma</span></span> zippers_view_same_hash<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> set <span class="main">(</span>zippers_view <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hash_view <span class="main">(</span>view_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> hash_view <span class="main">(</span>view_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>embed_view_path <span class="free">p</span><span class="main">,</span> embed_view <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> zippers_rose_tree_same_hash'<span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-zippers_view_blinding_of"><span class="command">lemma</span></span> zippers_view_blinding_of<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> set <span class="main">(</span>zippers_view <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_view <span class="main">(</span>view_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="free">z</span><span class="main">)</span> <span class="main">(</span>view_of_zipper<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>blind_view_path <span class="free">p</span><span class="main">,</span> embed_view <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> zippers_rose_tree_blinding_of<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">blind_view</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view <span class="main">⇒</span> view<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blind_view</span> <span class="main">(</span>View <span class="free"><span class="bound"><span class="entity">vm</span></span></span> <span class="free"><span class="bound"><span class="entity">vd</span></span></span> <span class="free"><span class="bound"><span class="entity">subviews</span></span></span><span class="main">)</span> <span class="main">=</span> 
   View<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Blinded <span class="main">(</span>Content <span class="main">(</span><span class="main">(</span>Content <span class="free"><span class="bound"><span class="entity">vm</span></span></span><span class="main">,</span> Content <span class="free"><span class="bound"><span class="entity">vd</span></span></span><span class="main">)</span><span class="main">,</span> map <span class="main">(</span>hash_view <span class="main">∘</span> embed_view<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subviews</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">subviews</span>

<span class="keyword1" id="Canton_Transaction_Tree-hash_blind_view"><span class="command">lemma</span></span> hash_blind_view<span class="main">:</span> <span class="quoted"><span class="quoted">"hash_view <span class="main">(</span>blind_view <span class="free">view</span><span class="main">)</span> <span class="main">=</span> hash_view <span class="main">(</span>embed_view <span class="free">view</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">view</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">blind_transaction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transaction <span class="main">⇒</span> transaction<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blind_transaction</span> <span class="main">(</span>Transaction <span class="free"><span class="bound"><span class="entity">cm</span></span></span> <span class="free"><span class="bound"><span class="entity">pm</span></span></span> <span class="free"><span class="bound"><span class="entity">views</span></span></span><span class="main">)</span> <span class="main">=</span> 
   Transaction<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Blinded <span class="main">(</span>Content <span class="main">(</span><span class="main">(</span>Content <span class="free"><span class="bound"><span class="entity">cm</span></span></span><span class="main">,</span> Content <span class="free"><span class="bound"><span class="entity">pm</span></span></span><span class="main">)</span><span class="main">,</span> map <span class="main">(</span>hash_view <span class="main">∘</span> blind_view<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">views</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">views</span>

<span class="keyword1" id="Canton_Transaction_Tree-hash_blind_transaction"><span class="command">lemma</span></span> hash_blind_transaction<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hash_transaction <span class="main">(</span>blind_transaction <span class="free">transaction</span><span class="main">)</span> <span class="main">=</span> hash_transaction <span class="main">(</span>embed_transaction <span class="free">transaction</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">transaction</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hash_blind_view<span class="main">)</span>


<span class="keyword1"><span class="command">typedecl</span></span> participant
<span class="keyword1"><span class="command">consts</span></span> recipients <span class="main">::</span> <span class="quoted"><span class="quoted">"view_metadata <span class="main">⇒</span> participant list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">view_recipients</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view<span class="hidden">⇩</span><sub>m</sub> <span class="main">⇒</span> participant set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">view_recipients</span> <span class="main">(</span>View<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Unblinded <span class="main">(</span><span class="main">(</span>Unblinded <span class="free"><span class="bound"><span class="entity">vm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vd</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">subviews</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>recipients <span class="free"><span class="bound"><span class="entity">vm</span></span></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">subviews</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">view_recipients</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="comment1">― ‹Sane default case›</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">participant</span> <span class="main">::</span> <span class="quoted">participant</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">view_trees_for</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"view <span class="main">⇒</span> view<span class="hidden">⇩</span><sub>m</sub> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">view_trees_for</span> <span class="free"><span class="bound"><span class="entity">view</span></span></span> <span class="main">=</span>
   map view_of_zipper<span class="hidden">⇩</span><sub>m</sub>
     <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="free">participant</span> <span class="main">∈</span> view_recipients <span class="bound">t</span><span class="main">)</span> 
       <span class="main">(</span>zippers_view <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">view</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">transaction_views_for</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transaction <span class="main">⇒</span> transaction<span class="hidden">⇩</span><sub>m</sub> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">transaction_views_for</span> <span class="main">(</span>Transaction <span class="free"><span class="bound"><span class="entity">cm</span></span></span> <span class="free"><span class="bound"><span class="entity">pm</span></span></span> <span class="free"><span class="bound"><span class="entity">views</span></span></span><span class="main">)</span> <span class="main">=</span>
   map <span class="main">(</span><span class="main">λ</span><span class="bound">view<span class="hidden">⇩</span><sub>m</sub></span><span class="main">.</span> Transaction<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>Unblinded <span class="main">(</span><span class="main">(</span>Unblinded <span class="free"><span class="bound"><span class="entity">cm</span></span></span><span class="main">,</span> Unblinded <span class="free"><span class="bound"><span class="entity">pm</span></span></span><span class="main">)</span><span class="main">,</span> <span class="bound">view<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">v<span class="hidden">⇩</span><sub>m</sub></span><span class="main">.</span> map blind_view <span class="bound">l</span> <span class="main">@</span> <span class="main">[</span><span class="bound">v<span class="hidden">⇩</span><sub>m</sub></span><span class="main">]</span> <span class="main">@</span> map blind_view <span class="bound">r</span><span class="main">)</span> <span class="main">(</span>view_trees_for <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>splits <span class="free"><span class="bound"><span class="entity">views</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">views</span>
   
<span class="keyword1" id="Canton_Transaction_Tree-view_trees_for_same_hash"><span class="command">lemma</span></span> view_trees_for_same_hash<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">vt</span> <span class="main">∈</span> set <span class="main">(</span>view_trees_for <span class="free">view</span><span class="main">)</span> <span class="main">⟹</span> hash_view <span class="free">vt</span> <span class="main">=</span> hash_view <span class="main">(</span>embed_view <span class="free">view</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> view_trees_for_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> zippers_view_same_hash<span class="main">)</span>

<span class="keyword1" id="Canton_Transaction_Tree-transaction_views_for_same_hash"><span class="command">lemma</span></span> transaction_views_for_same_hash<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">∈</span> set <span class="main">(</span>transaction_views_for <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> hash_transaction <span class="free">t<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">=</span> hash_transaction <span class="main">(</span>embed_transaction <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splits_iff hash_blind_view view_trees_for_same_hash<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">transaction_projection_for</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transaction <span class="main">⇒</span> transaction<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">transaction_projection_for</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">tvs</span> <span class="main">=</span> transaction_views_for <span class="free"><span class="bound"><span class="entity">t</span></span></span>
    <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">tvs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> blind_transaction <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> the <span class="main">(</span>transaction.Merge <span class="main">(</span>set <span class="bound">tvs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-transaction_projection_for_same_hash"><span class="command">lemma</span></span> transaction_projection_for_same_hash<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hash_transaction <span class="main">(</span>transaction_projection_for <span class="free">t</span><span class="main">)</span> <span class="main">=</span> hash_transaction <span class="main">(</span>embed_transaction <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"transaction_views_for <span class="free">t</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transaction_projection_for_def Let_def hash_blind_transaction<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transaction.Merge <span class="main">(</span>set <span class="main">(</span>transaction_views_for <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> transaction.Merge_defined<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transaction_views_for_same_hash<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transaction_projection_for_def neq_Nil_conv <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> transaction.Merge_insert<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> transaction.Merge_hash<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> transaction_views_for_same_hash<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Canton_Transaction_Tree-transaction_projection_for_upper"><span class="command">lemma</span></span> transaction_projection_for_upper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">∈</span> set <span class="main">(</span>transaction_views_for <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blinding_of_transaction <span class="free">t<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>transaction_projection_for <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transaction.Merge <span class="main">(</span>set <span class="main">(</span>transaction_views_for <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> transaction.Merge_defined<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transaction_views_for_same_hash<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transaction_projection_for_def Let_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> transaction.Merge_upper<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>