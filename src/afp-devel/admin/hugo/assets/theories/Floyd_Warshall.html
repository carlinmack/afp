<div id="Floyd_Warshall">
<div class="head">
<h1>Theory Floyd_Warshall</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Wimmer *)</span>
<span class="keyword1"><span class="command">theory</span></span> Floyd_Warshall
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Floyd-Warshall Algorithm for the All-Pairs Shortest Paths Problem›</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Introduction›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The \fw <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> floyd <span class="quasi_keyword"><span class="quasi_keyword">and</span></span> roy <span class="quasi_keyword"><span class="quasi_keyword">and</span></span> warshall<span class="antiquote"><span class="antiquote">}</span></span></span></span> is a classic dynamic programming algorithm to compute
  the length of all shortest paths between any two vertices in a graph
  (i.e. to solve the all-pairs shortest path problem, or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>APSP›</span></span></span></span> for short).
  Given a representation of the graph as a matrix of weights <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>M›</span></span></span></span>, it computes another matrix <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>M'›</span></span></span></span>
  which represents a graph with the same path lengths and contains the length of the shortest path
  between any two vertices <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span>.
  This is only possible if the graph does not contain any negative cycles (then the length
  of the shortest path is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>-∞›</span></span></span></span>). However, in this case the \fw will detect the situation by
  calculating a negative diagonal entry corresponding to the negative cycle.
  In the following, we present a formalization of the algorithm and of the aforementioned
  key properties.

  Abstractly, the algorithm corresponds to the following imperative pseudo-code:
  <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">▩</span></span><span class="raw_text"><span class="raw_text">‹
  for k = 1 .. n do
    for i = 1 .. n do
      for j = 1 .. n do
        m[i, j] := min(m[i, j], m[i, k] + m[k, j])
  ›</span></span></span></span>

  However, we will carry out the whole formalization on a recursive version of the algorithm, and
  refine it to an efficient imperative version corresponding to the above pseudo-code in the end.
  The main observation underlying the algorithm is that the shortest path from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span> which only
  uses intermediate vertices from the set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>{0…k+1}›</span></span></span></span>, is: either the shortest path from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span>
  using intermediate vertices from the set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>{0…k}›</span></span></span></span>;
  or a combination of the shortest path from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span> and the shortest path from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span>,
  each of them only using intermediate vertices from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>{0…k}›</span></span></span></span>.
  Our presentation we be slightly more general than the typical textbook version, in that we will
  factor our the inner two loops as a separate algorithm and show that it has similar properties
  as the full algorithm for a single intermediate vertex <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>.
›</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cycles in Lists›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">cnt</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remove_cycles</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_cycles</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">=</span> rev <span class="free"><span class="bound"><span class="entity">acc</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_cycles</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free">remove_cycles</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="keyword1">else</span> <span class="free">remove_cycles</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Floyd_Warshall-cnt_rev"><span class="command">lemma</span></span> cnt_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"cnt <span class="free">x</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> cnt <span class="free">x</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_rev rev_filter<span class="main">)</span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="free">cs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="free">ds</span>"</span></span>

<span class="keyword1" id="Floyd_Warshall-remove_cycles_removes"><span class="command">lemma</span></span> remove_cycles_removes<span class="main">:</span> <span class="quoted"><span class="quoted">"cnt <span class="free">x</span> <span class="main">(</span>remove_cycles <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≤</span> max <span class="main">1</span> <span class="main">(</span>cnt <span class="free">x</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cnt_rev<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span><span class="main">]</span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-remove_cycles_id"><span class="command">lemma</span></span> remove_cycles_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">⟹</span> remove_cycles <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span> <span class="main">=</span> rev <span class="free">ys</span> <span class="main">@</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Floyd_Warshall-remove_cycles_cnt_id"><span class="command">lemma</span></span> remove_cycles_cnt_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> cnt <span class="free">y</span> <span class="main">(</span>remove_cycles <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≤</span> cnt <span class="free">y</span> <span class="free">ys</span> <span class="main">+</span> cnt <span class="free">y</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cnt_rev<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">z</span><span class="main">]</span>"</span></span><span class="main">]</span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span><span class="main">]</span> Cons.prems False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-remove_cycles_ends_cycle"><span class="command">lemma</span></span> remove_cycles_ends_cycle<span class="main">:</span> <span class="quoted"><span class="quoted">"remove_cycles <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span> <span class="main">≠</span> rev <span class="free">ys</span> <span class="main">@</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> remove_cycles_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Floyd_Warshall-remove_cycles_begins_with"><span class="command">lemma</span></span> remove_cycles_begins_with<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">zs</span><span class="main">.</span> remove_cycles <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> set <span class="bound">zs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">with</span></span> remove_cycles_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-remove_cycles_self"><span class="command">lemma</span></span> remove_cycles_self<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> remove_cycles <span class="main">(</span>remove_cycles <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span><span class="main">)</span> <span class="free">x</span> <span class="free">zs</span> <span class="main">=</span> remove_cycles <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> ws<span class="main">:</span> <span class="quoted"><span class="quoted">"remove_cycles <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">ws</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="skolem">ws</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> remove_cycles_begins_with<span class="main">[</span><span class="operator">OF</span> x<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> remove_cycles_id<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"remove_cycles <span class="skolem">ws</span> <span class="free">x</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">ws</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> ws<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"remove_cycles <span class="main">(</span>remove_cycles <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span><span class="main">)</span> <span class="free">x</span> <span class="free">zs</span> <span class="main">=</span> remove_cycles <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-remove_cycles_one"><span class="command">lemma</span></span> remove_cycles_one<span class="main">:</span> <span class="quoted"><span class="quoted">"remove_cycles <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">x</span> <span class="free">ys</span> <span class="main">=</span> remove_cycles <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">x</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Floyd_Warshall-remove_cycles_cycles"><span class="command">lemma</span></span> remove_cycles_cycles<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xxs</span> <span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="bound">xxs</span><span class="main">)</span> <span class="main">@</span> remove_cycles <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> set <span class="bound">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">xxs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="skolem">y</span><span class="main">#</span><span class="bound">xs</span><span class="main">)</span> <span class="skolem">xxs</span><span class="main">)</span> <span class="main">@</span> remove_cycles <span class="skolem">xs</span> <span class="skolem">y</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="free">x</span><span class="main">#</span><span class="bound">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">as</span><span class="main">#</span><span class="skolem">xxs</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> remove_cycles <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"remove_cycles <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> remove_cycles_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="main">@</span> remove_cycles <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">xxs</span></span> <span class="keyword2"><span class="keyword">where</span></span> as<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="skolem">xxs</span><span class="main">)</span> <span class="main">@</span> remove_cycles <span class="skolem">xs</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="skolem">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span><span class="main">]</span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="skolem">xxs</span><span class="main">)</span> <span class="main">@</span> remove_cycles <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> as<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">start_remove</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">start_remove</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">=</span> rev <span class="free"><span class="bound"><span class="entity">acc</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">start_remove</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> rev <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">@</span> remove_cycles <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="keyword1">else</span> <span class="free">start_remove</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Floyd_Warshall-start_remove_decomp"><span class="command">lemma</span></span> start_remove_decomp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">as</span> <span class="bound">bs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">as</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">bs</span> <span class="main">∧</span> start_remove <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span> <span class="main">=</span> rev <span class="free">ys</span> <span class="main">@</span> <span class="bound">as</span> <span class="main">@</span> remove_cycles <span class="bound">bs</span> <span class="free">x</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"start_remove <span class="skolem">xs</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">as</span> <span class="main">@</span> remove_cycles <span class="skolem">bs</span> <span class="free">x</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span>
          <span class="quoted"><span class="quoted">"start_remove <span class="skolem">xs</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> rev <span class="skolem">ys</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">@</span> remove_cycles <span class="skolem">bs</span> <span class="free">x</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-start_remove_removes"><span class="command">lemma</span></span> start_remove_removes<span class="main">:</span> <span class="quoted"><span class="quoted">"cnt <span class="free">x</span> <span class="main">(</span>start_remove <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">(</span>cnt <span class="free">x</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> cnt_rev<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> remove_cycles_removes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span><span class="main">]</span> cnt_rev<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-start_remove_id"><span class="command">lemma</span></span> start_remove_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">⟹</span> start_remove <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span> <span class="main">=</span> rev <span class="free">ys</span> <span class="main">@</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Floyd_Warshall-start_remove_cnt_id"><span class="command">lemma</span></span> start_remove_cnt_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> cnt <span class="free">y</span> <span class="main">(</span>start_remove <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≤</span> cnt <span class="free">y</span> <span class="free">ys</span> <span class="main">+</span> cnt <span class="free">y</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cnt_rev<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> remove_cycles_cnt_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cnt_rev<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span><span class="main">]</span> this<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remove_all_cycles</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_all_cycles</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_all_cycles</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free">remove_all_cycles</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span>start_remove <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Floyd_Warshall-cnt_remove_all_mono"><span class="command">lemma</span></span> cnt_remove_all_mono<span class="main">:</span><span class="quoted"><span class="quoted">"cnt <span class="free">y</span> <span class="main">(</span>remove_all_cycles <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≤</span> max <span class="main">1</span> <span class="main">(</span>cnt <span class="free">y</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> start_remove_removes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"start_remove <span class="skolem">ys</span> <span class="free">y</span> <span class="main">[]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cnt <span class="free">y</span> <span class="main">(</span>start_remove <span class="skolem">ys</span> <span class="skolem">x</span> <span class="main">[]</span><span class="main">)</span> <span class="main">≤</span> cnt <span class="free">y</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> start_remove_cnt_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"start_remove <span class="skolem">ys</span> <span class="skolem">x</span> <span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Floyd_Warshall-cnt_remove_all_cycles"><span class="command">lemma</span></span> cnt_remove_all_cycles<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> cnt <span class="free">x</span> <span class="main">(</span>remove_all_cycles <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> start_remove_removes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> cnt_remove_all_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="quoted">"start_remove <span class="skolem">ys</span> <span class="skolem">y</span> <span class="main">[]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-cnt_mono"><span class="command">lemma</span></span> cnt_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cnt <span class="free">a</span> <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> cnt <span class="free">a</span> <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">c</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Floyd_Warshall-cnt_distinct_intro"><span class="command">lemma</span></span> cnt_distinct_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> cnt <span class="bound">x</span> <span class="free">xs</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span> distinct <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> cnt <span class="bound">x</span> <span class="skolem">xs</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filter.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> impossible_Cons linorder_class.linear list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
      preorder_class.order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xa</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> cnt <span class="bound">xa</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xa</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> cnt <span class="bound">xa</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">b</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cnt <span class="skolem">b</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> cnt_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Cons.prems One_nat_def * empty_iff filter.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> impossible_Cons
                           le_0_eq le_Suc_eq length_0_conv list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-remove_cycles_subs"><span class="command">lemma</span></span> remove_cycles_subs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>remove_cycles <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-start_remove_subs"><span class="command">lemma</span></span> start_remove_subs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>start_remove <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> remove_cycles_subs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-remove_all_cycles_subs"><span class="command">lemma</span></span> remove_all_cycles_subs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>remove_all_cycles <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> start_remove_subs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-remove_all_cycles_distinct"><span class="command">lemma</span></span> remove_all_cycles_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="main">(</span>remove_all_cycles <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> cnt <span class="bound">x</span> <span class="main">(</span>remove_all_cycles <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cnt_remove_all_cycles
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>remove_all_cycles <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> cnt <span class="bound">x</span> <span class="main">(</span>remove_all_cycles <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> remove_all_cycles_subs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>remove_all_cycles <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cnt_distinct_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-distinct_remove_cycles_inv"><span class="command">lemma</span></span> distinct_remove_cycles_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>remove_cycles <span class="free">xs</span> <span class="free">x</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_all</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span> tl <span class="main">(</span>remove_cycles <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_all_rev</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span> rev <span class="main">(</span>tl <span class="main">(</span>remove_cycles <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Floyd_Warshall-remove_all_distinct"><span class="command">lemma</span></span> remove_all_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="main">(</span><span class="free">x</span> <span class="main">#</span> remove_all <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">from</span></span> remove_cycles_begins_with<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"remove_cycles <span class="free">xs</span> <span class="free">x</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> distinct_remove_cycles_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_all_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_all_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-remove_all_removes"><span class="command">lemma</span></span> remove_all_removes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>remove_all <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> remove_all_def remove_cycles_begins_with<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-remove_all_subs"><span class="command">lemma</span></span> remove_all_subs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>remove_all <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> remove_cycles_subs remove_all_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> append_Nil2 list.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.set_sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> set_append subsetCE subsetI<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-remove_all_rev_distinct"><span class="command">lemma</span></span> remove_all_rev_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="main">(</span><span class="free">x</span> <span class="main">#</span> remove_all_rev <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> remove_cycles_begins_with<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"remove_cycles <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> distinct_remove_cycles_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_all_rev_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_all_rev_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-remove_all_rev_removes"><span class="command">lemma</span></span> remove_all_rev_removes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>remove_all_rev <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> remove_all_def remove_all_removes remove_all_rev_def set_rev<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-remove_all_rev_subs"><span class="command">lemma</span></span> remove_all_rev_subs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remove_all_rev <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> remove_all_def remove_all_subs set_rev remove_all_rev_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">rem_cycles</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> remove_all <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>remove_all_rev <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">(</span>remove_all_cycles <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Floyd_Warshall-rem_cycles_distinct'"><span class="command">lemma</span></span> rem_cycles_distinct'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">⟹</span> distinct <span class="main">(</span><span class="free">i</span> <span class="main">#</span> <span class="free">j</span> <span class="main">#</span> rem_cycles <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>remove_all_cycles <span class="free">xs</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_all_cycles_distinct<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> remove_all_rev_distinct<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>remove_all_rev <span class="free">j</span> <span class="main">(</span>remove_all_cycles <span class="free">xs</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> remove_all_distinct<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">i</span> <span class="main">#</span> rem_cycles <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∉</span> set <span class="main">(</span>rem_cycles <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> remove_all_subs remove_all_rev_removes remove_all_removes <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-rem_cycles_removes_last"><span class="command">lemma</span></span> rem_cycles_removes_last<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∉</span> set <span class="main">(</span>rem_cycles <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> remove_all_rev_removes remove_all_subs rev_subsetD<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-rem_cycles_distinct"><span class="command">lemma</span></span> rem_cycles_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>rem_cycles <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> order_refl remove_all_cycles_distinct
          remove_all_distinct remove_all_rev_distinct<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-rem_cycles_subs"><span class="command">lemma</span></span> rem_cycles_subs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>rem_cycles <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> order_trans remove_all_cycles_subs remove_all_subs remove_all_rev_subs<span class="main">)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Definition of the Algorithm›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In our formalization of the \fw, edge weights are from a linearly ordered abelian monoid.
›</span></span>

<span class="keyword1"><span class="command">class</span></span> linordered_ab_monoid_add <span class="main">=</span> linorder <span class="main">+</span> ordered_comm_monoid_add
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subclass</span></span> linordered_ab_semigroup_add <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> linordered_ab_group_add<span class="main">)</span> linordered_ab_monoid_add <span class="keyword1"><span class="command">..</span></span>


<span class="keyword1"><span class="command">context</span></span> linordered_ab_monoid_add
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'c</span> mat <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">upd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> mat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'c</span> mat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fw_upd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> mat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fw_upd</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> upd <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">(</span>min <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Recursive version of the two inner loops.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fwi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> mat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fwi</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span>       <span class="main">0</span>        <span class="main">=</span> fw_upd <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">fwi</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">0</span>        <span class="main">=</span> fw_upd <span class="main">(</span><span class="free">fwi</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">fwi</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>       <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>  <span class="main">=</span> fw_upd <span class="main">(</span><span class="free">fwi</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Recursive version of the full algorithm.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> mat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fw</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">0</span>       <span class="main">=</span> fwi <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">fw</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span> fwi <span class="main">(</span><span class="free">fw</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Elementary Properties›</span></span>

<span class="keyword1" id="Floyd_Warshall-fw_upd_mono"><span class="command">lemma</span></span> fw_upd_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fw_upd <span class="free">m</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">i'</span> <span class="free">j'</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">i'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="free">j'</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-fw_upd_out_of_bounds1"><span class="command">lemma</span></span> fw_upd_out_of_bounds1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fw_upd <span class="free">M</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="free">i'</span> <span class="free">j'</span> <span class="main">=</span> <span class="free">M</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fw_upd_def upd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_min<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-fw_upd_out_of_bounds2"><span class="command">lemma</span></span> fw_upd_out_of_bounds2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">&gt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fw_upd <span class="free">M</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="free">i'</span> <span class="free">j'</span> <span class="main">=</span> <span class="free">M</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fw_upd_def upd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_min<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-fwi_out_of_bounds1"><span class="command">lemma</span></span> fwi_out_of_bounds1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fwi <span class="free">M</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="free">i'</span> <span class="free">j'</span> <span class="main">=</span> <span class="free">M</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"less_than <span class="keyword1"><span class="keyword1">&lt;*lex*&gt;</span></span> less_than"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i j
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_out_of_bounds1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Floyd_Warshall-fw_out_of_bounds1"><span class="command">lemma</span></span> fw_out_of_bounds1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fw <span class="free">M</span> <span class="free">n</span> <span class="free">k</span><span class="main">)</span> <span class="free">i'</span> <span class="free">j'</span> <span class="main">=</span> <span class="free">M</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fwi_out_of_bounds1<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-fwi_out_of_bounds2"><span class="command">lemma</span></span> fwi_out_of_bounds2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fwi <span class="free">M</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="free">i'</span> <span class="free">j'</span> <span class="main">=</span> <span class="free">M</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"less_than <span class="keyword1"><span class="keyword1">&lt;*lex*&gt;</span></span> less_than"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i j
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_out_of_bounds2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Floyd_Warshall-fw_out_of_bounds2"><span class="command">lemma</span></span> fw_out_of_bounds2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fw <span class="free">M</span> <span class="free">n</span> <span class="free">k</span><span class="main">)</span> <span class="free">i'</span> <span class="free">j'</span> <span class="main">=</span> <span class="free">M</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fwi_out_of_bounds2<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-fwi_invariant_aux_1"><span class="command">lemma</span></span> fwi_invariant_aux_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">j''</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">i'</span> <span class="free">j'</span> <span class="main">≤</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j''</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j''</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fw_upd <span class="main">(</span>fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">k</span> <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">i'</span> <span class="free">j'</span> <span class="main">≤</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="skolem">j</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_mono<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-fwi_invariant"><span class="command">lemma</span></span> fwi_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">i''</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">j''</span> <span class="main">≤</span> <span class="free">j</span>
   <span class="main">⟹</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">i'</span> <span class="free">j'</span> <span class="main">≤</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i''</span> <span class="free">j''</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fwi_invariant_aux_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i''</span> <span class="main">=</span> Suc <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc fwi_invariant_aux_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">j</span> <span class="free">i'</span> <span class="free">j'</span> <span class="main">≤</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">0</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fwi_invariant_aux_1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="skolem">i</span> <span class="free">n</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="skolem">i</span> <span class="free">j</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fwi_invariant_aux_1 False Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i''</span> <span class="free">j''</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-single_row_inv"><span class="command">lemma</span></span> single_row_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i'</span> <span class="free">j</span> <span class="free">i'</span> <span class="free">j'</span> <span class="main">=</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i'</span> <span class="free">j'</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-single_iteration_inv'"><span class="command">lemma</span></span> single_iteration_inv'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">j'</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">i'</span> <span class="free">j'</span> <span class="main">=</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i'</span> <span class="free">j'</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">i'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> single_row_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">j'</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-single_iteration_inv"><span class="command">lemma</span></span> single_iteration_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">j'</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">i'</span> <span class="free">j'</span> <span class="main">=</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i'</span> <span class="free">j'</span> <span class="free">i'</span> <span class="free">j'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">=</span> Suc <span class="skolem">i</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">=</span> Suc <span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> single_iteration_inv'<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-fwi_innermost_id"><span class="command">lemma</span></span> fwi_innermost_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i'</span> <span class="free">j'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="free">m</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-fwi_middle_id"><span class="command">lemma</span></span> fwi_middle_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">i'</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i'</span> <span class="free">j'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="free">m</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fwi_innermost_id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-fwi_outermost_mono"><span class="command">lemma</span></span> fwi_outermost_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="skolem">i'</span> <span class="free">n</span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">m</span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fwi_innermost_id <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">=</span> <span class="main">0</span>›</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="skolem">j'</span> <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fwi_middle_id Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-fwi_mono"><span class="command">lemma</span></span> fwi_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i'</span> <span class="free">j'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i'</span> <span class="free">j'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="free">m</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fwi_innermost_id<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i'</span> <span class="free">j'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> single_iteration_inv' that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> fwi_outermost_mono<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">i'</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i'</span> <span class="free">j'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="free">m</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fwi_middle_id<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i'</span> <span class="free">j'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">=</span> <span class="free">j</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> single_row_inv<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> fwi_outermost_mono<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-Suc_innermost_mono"><span class="command">lemma</span></span> Suc_innermost_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fwi_mono<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-fw_mono"><span class="command">lemma</span></span> fw_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fwi_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc_innermost_mono<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Justifies the use of destructive updates in the case that there is no negative cycle for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>.
›</span></span>
<span class="keyword1" id="Floyd_Warshall-fwi_step"><span class="command">lemma</span></span> fwi_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">k</span> <span class="free">k</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> min <span class="main">(</span><span class="free">m</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">m</span> <span class="free">i</span> <span class="free">k</span> <span class="main">+</span> <span class="free">m</span> <span class="free">k</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"less_than <span class="keyword1"><span class="keyword1">&lt;*lex*&gt;</span></span> less_than"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i'</span> <span class="skolem">j'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> assms <span class="main">=</span> 1<span class="main">(</span>2-<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> fwi_innermost_id fwi_middle_id
  <span class="keyword1"><span class="command">note</span></span> simps <span class="main">=</span> add_increasing add_increasing2 ord.min_def fw_upd_def upd_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="main">0</span> <span class="skolem">j</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="main">0</span> <span class="skolem">j</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="main">0</span> <span class="skolem">j</span> <span class="main">0</span> <span class="free">k</span> <span class="main">=</span> <span class="free">m</span> <span class="main">0</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> single_iteration_inv<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> assms Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="skolem">i</span> <span class="free">n</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">m</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="skolem">i</span> <span class="free">n</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="free">m</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="skolem">i</span> <span class="free">n</span> <span class="free">k</span> <span class="main">0</span> <span class="main">=</span> <span class="free">m</span> <span class="free">k</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> single_iteration_inv<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> 0 <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="free">k</span> <span class="free">k</span> <span class="main">≥</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Suc_j<span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">have</span></span> diag<span class="main">:</span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">k</span> <span class="free">k</span> <span class="free">k</span> <span class="free">k</span> <span class="main">=</span> <span class="free">m</span> <span class="free">k</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> that IH assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">k</span> <span class="free">k</span> <span class="free">k</span> <span class="free">k</span> <span class="main">=</span> min <span class="main">(</span><span class="free">m</span> <span class="free">k</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">m</span> <span class="free">k</span> <span class="free">k</span> <span class="main">+</span> <span class="free">m</span> <span class="free">k</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="free">k</span> <span class="free">k</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="skolem">i</span> <span class="free">n</span> <span class="free">k</span> <span class="free">k</span> <span class="main">=</span> <span class="free">m</span> <span class="free">k</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> single_iteration_inv<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diag <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> diag2<span class="main">:</span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">k</span> <span class="skolem">j</span> <span class="free">k</span> <span class="free">k</span> <span class="main">=</span> <span class="free">m</span> <span class="free">k</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="skolem">i</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> single_iteration_inv<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diag<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">j</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">k</span> <span class="skolem">j</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> False <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="free">k</span> <span class="free">k</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> single_iteration_inv'<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simps diag2<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="free">m</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> single_iteration_inv<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="main">0</span> <span class="skolem">i</span> <span class="free">n</span> <span class="main">0</span> <span class="main">0</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> ** assms<span class="main">(</span>1<span class="main">)</span> prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="main">0</span> <span class="skolem">i</span> <span class="free">n</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">m</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simps<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> k'
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ** assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> fwi_innermost_id fwi_middle_id le_SucE lessI
                    linorder_class.not_le_imp_less prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> preorder_class.order_refl
                    single_iteration_inv single_iteration_inv'
                 <span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simps<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simps ***<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Result Under The Absence of Negative Cycles›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If the given input graph does not contain any negative cycles, the \fw computes the
  <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">❙</span></span>‹unique›</span></span> shortest paths matrix corresponding to the graph. It contains the shortest path
  between any two nodes <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i, j ≤ n›</span></span></span></span>.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Length of Paths›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">len</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">+</span> <span class="free">len</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span>"</span></span>

<span class="keyword1" id="Floyd_Warshall-len_decomp"><span class="command">lemma</span></span> len_decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span> <span class="main">⟹</span> len <span class="free">m</span> <span class="free">x</span> <span class="free">z</span> <span class="free">xs</span> <span class="main">=</span> len <span class="free">m</span> <span class="free">x</span> <span class="free">y</span> <span class="free">ys</span> <span class="main">+</span> len <span class="free">m</span> <span class="free">y</span> <span class="free">z</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Floyd_Warshall-len_comp"><span class="command">lemma</span></span> len_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">a</span> <span class="free">c</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">b</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> len <span class="free">m</span> <span class="free">a</span> <span class="free">b</span> <span class="free">xs</span> <span class="main">+</span> len <span class="free">m</span> <span class="free">b</span> <span class="free">c</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Canonicality›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The unique shortest path matrices are in a so-called <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>canonical form›</span></span></span></span>.
  We will say that a matrix <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m›</span></span></span></span> is in canonical form for a set of indices <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>I›</span></span></span></span>
  if the following holds:
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">canonical_subs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set <span class="main">⇒</span> <span class="tfree">'a</span> mat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">canonical_subs</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">i</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">j</span> <span class="bound">k</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Similarly we express that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m›</span></span></span></span> does not contain a negative cycle which only uses intermediate
  vertices from the set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>I›</span></span></span></span> as follows:
›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cyc_free_subs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set <span class="main">⇒</span> <span class="tfree">'a</span> mat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cyc_free_subs</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">i</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟶</span> len <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">i</span> <span class="bound">i</span> <span class="bound">xs</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  To prove the main result under <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>the absence of negative cycles›</span></span></span></span>, we will proceed as follows:
  <span class="antiquoted"><span class="antiquoted">▪</span></span> we show that an invocation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fwi m n k n n›</span></span></span></span> extends canonicality to index <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>,
  <span class="antiquoted"><span class="antiquoted">▪</span></span> we show that an invocation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fw m n n›</span></span></span></span> computes a matrix in canonical form,
  <span class="antiquoted"><span class="antiquoted">▪</span></span> and finally we show that canonical forms specify the lengths of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>shortest paths›</span></span></span></span>,
    provided that there are no negative cycles.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Canonical forms specify lower bounds for the length of any path.›</span></span>
<span class="keyword1" id="Floyd_Warshall-canonical_subs_len"><span class="command">lemma</span></span> canonical_subs_len<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> len <span class="free">M</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="free">I</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="skolem">x</span> <span class="free">j</span> <span class="main">≤</span> len <span class="free">M</span> <span class="skolem">x</span> <span class="free">j</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="quoted"><span class="quoted">‹canonical_subs <span class="free">n</span> <span class="free">I</span> <span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="skolem">i</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">M</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">M</span> <span class="skolem">x</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> canonical_subs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">M</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">+</span> len <span class="free">M</span> <span class="skolem">x</span> <span class="free">j</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This lemma justifies the use of destructive updates under the absence of negative cycles.
›</span></span>
<span class="keyword1" id="Floyd_Warshall-fwi_step'"><span class="command">lemma</span></span> fwi_step'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i'</span> <span class="free">j'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> min <span class="main">(</span><span class="free">m</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">m</span> <span class="free">i</span> <span class="free">k</span> <span class="main">+</span> <span class="free">m</span> <span class="free">k</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">k</span> <span class="free">k</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> single_iteration_inv<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fwi_step<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An invocation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fwi›</span></span></span></span> extends canonical forms.›</span></span>
<span class="keyword1" id="Floyd_Warshall-fwi_canonical_extend"><span class="command">lemma</span></span> fwi_canonical_extend<span class="main">:</span>
  <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="free">I</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">k</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">unfolding</span></span> canonical_subs_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i j k'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fwi_step'<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> min_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 2
    <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">i</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">m</span> <span class="skolem">j</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> add_mono <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 3
    <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">i</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">m</span> <span class="skolem">j</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> add_mono <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 4
    <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">k</span> <span class="skolem">k'</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">k</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">m</span> <span class="skolem">j</span> <span class="skolem">k'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mono add.assoc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 5
    <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">k</span> <span class="skolem">k'</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">k</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">m</span> <span class="skolem">j</span> <span class="skolem">k'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mono add.assoc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 6
    <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">k</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">m</span> <span class="skolem">j</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order.trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_increasing2 add.assoc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 7
    <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">k</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">m</span> <span class="skolem">j</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">rule</span> add_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_increasing2 add.assoc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i j k'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fwi_step'<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> min_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_increasing add_increasing2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An invocation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fwi›</span></span></span></span> will not produce a negative diagonal entry if there is no negative cycle.
›</span></span>
<span class="keyword1" id="Floyd_Warshall-fwi_cyc_free_diag"><span class="command">lemma</span></span> fwi_cyc_free_diag<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span> <span class="free">i</span> <span class="free">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"cyc_free_subs <span class="free">n</span> <span class="free">I</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">k</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fwi_step'<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> min_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[]</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[</span><span class="free">k</span><span class="main">]</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-cyc_free_subs_diag"><span class="command">lemma</span></span> cyc_free_subs_diag<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">i</span> <span class="free">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"cyc_free_subs <span class="free">n</span> <span class="free">I</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[]</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-fwi_cyc_free_subs'"><span class="command">lemma</span></span> fwi_cyc_free_subs'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cyc_free_subs <span class="free">n</span> <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"cyc_free_subs <span class="free">n</span> <span class="free">I</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="free">I</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span> <span class="bound">i</span> <span class="bound">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">k</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cyc_free_subs_diag<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">k</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> fwi_canonical_extend<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> prems that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span> <span class="skolem">i</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> * prems that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="main">≤</span> len <span class="main">(</span>fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> canonical_subs_len<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-fwi_cyc_free_subs"><span class="command">lemma</span></span> fwi_cyc_free_subs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cyc_free_subs <span class="free">n</span> <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"cyc_free_subs <span class="free">n</span> <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="free">I</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">k</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cyc_free_subs_diag<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">k</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> fwi_canonical_extend<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> prems that <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">k</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span> <span class="skolem">i</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fwi_cyc_free_diag<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> * prems that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="main">≤</span> len <span class="main">(</span>fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> canonical_subs_len<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-canonical_subs_empty"><span class="command">lemma</span></span> canonical_subs_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="main">{}</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> canonical_subs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Floyd_Warshall-fwi_neg_diag_neg_cycle"><span class="command">lemma</span></span> fwi_neg_diag_neg_cycle<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> len <span class="free">m</span> <span class="bound">i</span> <span class="bound">i</span> <span class="bound">xs</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span> <span class="free">i</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">k</span> <span class="free">k</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> fwi_step'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">,</span> <span class="operator">OF</span> True<span class="main">]</span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">m</span> <span class="free">i</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">m</span> <span class="free">i</span> <span class="free">k</span> <span class="main">+</span> <span class="free">m</span> <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> min_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">i</span> <span class="main">[]</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[]</span> <span class="main">⊆</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">i</span> <span class="main">[</span><span class="free">k</span><span class="main">]</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[</span><span class="free">k</span><span class="main">]</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">k</span> <span class="free">k</span> <span class="main">[]</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[]</span> <span class="main">⊆</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fwi›</span></span></span></span> preserves the length of paths.›</span></span>
<span class="keyword1" id="Floyd_Warshall-fwi_len"><span class="command">lemma</span></span> fwi_len<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> len <span class="main">(</span>fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span> <span class="main">=</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">k</span> <span class="free">k</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fwi_step'<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> min_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="free"><span class="free"><span class="free">k</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> set <span class="skolem">xs</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"len <span class="main">(</span>fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">x</span> <span class="free">j</span> <span class="skolem">xs</span> <span class="main">=</span> len <span class="free">m</span> <span class="skolem">x</span> <span class="free">j</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fwi_step'<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> min_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">x</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">ys</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">k</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">ys</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-fwi_neg_cycle_neg_cycle"><span class="command">lemma</span></span> fwi_neg_cycle_neg_cycle<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> len <span class="free">m</span> <span class="bound">i</span> <span class="bound">i</span> <span class="bound">ys</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"len <span class="main">(</span>fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">n</span> <span class="free">n</span><span class="main">)</span> <span class="free">i</span> <span class="free">i</span> <span class="free">xs</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">k</span> <span class="free">k</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> fwi_len<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">,</span> <span class="operator">OF</span> True that<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> that<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span> <span class="main">(</span><span class="operator">rule</span> exI conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">k</span> <span class="free">k</span> <span class="main">[]</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[]</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If the \fw produces a negative diagonal entry, then there is a negative cycle.
›</span></span>
<span class="keyword1" id="Floyd_Warshall-fw_neg_diag_neg_cycle"><span class="command">lemma</span></span> fw_neg_diag_neg_cycle<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> len <span class="free">m</span> <span class="bound">i</span> <span class="bound">i</span> <span class="bound">ys</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"len <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span><span class="main">)</span> <span class="free">i</span> <span class="free">i</span> <span class="free">xs</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">drule</span> fwi_neg_cycle_neg_cycle<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> fwi_neg_cycle_neg_cycle<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">]</span> Suc.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>  <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> set <span class="skolem">xs</span> <span class="main">∪</span> <span class="main">{</span>Suc <span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"len <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">i'</span> <span class="skolem">i'</span> <span class="skolem">ys</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Suc.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i''</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">i''</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">⊆</span> set <span class="skolem">ys</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="skolem">i''</span> <span class="skolem">i''</span> <span class="skolem">zs</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Suc.IH<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">ys</span> <span class="main">⊆</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">⊆</span> set <span class="skolem">xs</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="skolem">k</span><span class="main">}</span> <span class="main">∧</span> len <span class="free">m</span> <span class="skolem">i''</span> <span class="skolem">i''</span> <span class="skolem">zs</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i''</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Main theorem under the absence of negative cycles.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> fw_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span><span class="main">)</span> <span class="main">∧</span> cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fwi_cyc_free_subs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> fwi_canonical_extend<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cyc_free_subs_diag<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span>
    <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span> <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∧</span> cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span> <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="skolem">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>Suc <span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="skolem">k</span><span class="main">}</span> <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fwi_canonical_extend<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">..</span></span><span class="skolem"><span class="skolem">k</span></span><span class="main"><span class="main">}</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem">k</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IH Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cyc_free_subs_diag<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"len <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="main">[]</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> fw_neg_diag_neg_cycle<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span><span class="main">]</span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="skolem">k</span><span class="main">}</span> <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fwi_cyc_free_subs'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">..</span></span><span class="skolem"><span class="skolem">k</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Suc IH False <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> ** <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> fw_canonical_subs <span class="main">=</span> fw_correct<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> fw_cyc_free_subs <span class="main">=</span> fw_correct<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> cyc_free_diag <span class="main">=</span> cyc_free_subs_diag


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Definition of Shortest Paths›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define the notion of the length of the shortest <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>simple›</span></span></span></span> path between two vertices,
  using only intermediate vertices from the set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>{0…k}›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">D</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> Min <span class="main">{</span>len <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="bound">xs</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Floyd_Warshall-distinct_length_le"><span class="command">lemma</span></span> distinct_length_le<span class="main">:</span><span class="quoted"><span class="quoted">"finite <span class="free">s</span> <span class="main">⟹</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">s</span> <span class="main">⟹</span> distinct <span class="free">xs</span> <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">≤</span> card <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_mono distinct_card<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-finite_distinct"><span class="command">lemma</span></span> finite_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">s</span> <span class="main">⟹</span> finite <span class="main">{</span><span class="bound">xs</span> <span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">s</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">xs</span> <span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">s</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">s</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">≤</span> card <span class="free">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_length_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">s</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">≤</span> card <span class="free">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_lists_length_le<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">s</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-D_base_finite"><span class="command">lemma</span></span> D_base_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> finite_distinct finite_image_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Floyd_Warshall-D_base_finite'"><span class="command">lemma</span></span> D_base_finite'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> distinct <span class="main">(</span><span class="free">i</span> <span class="main">#</span> <span class="free">j</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> distinct <span class="main">(</span><span class="free">i</span> <span class="main">#</span> <span class="free">j</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span><span class="main">}</span>
        <span class="main">⊆</span> <span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> D_base_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-D_base_finite''"><span class="command">lemma</span></span> D_base_finite''<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> D_base_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cycle_free</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cycle_free</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">i</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟶</span> len <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">(</span>rem_cycles <span class="bound">i</span> <span class="bound">j</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">≤</span> len <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">∧</span> len <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">i</span> <span class="bound">i</span> <span class="bound">xs</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="Floyd_Warshall-D_eqI"><span class="command">lemma</span></span> D_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="free">n</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≡</span> <span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">A_distinct</span> <span class="main">≡</span> <span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cycle_free <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A_distinct</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"D <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> D_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Min_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> <span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D_base_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A_distinct</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rem_cycles <span class="free">i</span> <span class="free">j</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?ys</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3-6<span class="main">)</span> xs <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cycle_free_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> set <span class="var">?ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∉</span> set <span class="var">?ys</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="var">?ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rem_cycles_distinct remove_all_removes rem_cycles_removes_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> xs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> <span class="free">A_distinct</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_distinct_def <span class="keyword1"><span class="command">using</span></span> rem_cycles_subs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-6<span class="main">)</span> xs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cycle_free_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> distinct xs<span class="main">(</span>2<span class="main">)</span> rem_cycles_subs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-D_base_not_empty"><span class="command">lemma</span></span> D_base_not_empty<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="main">[]</span> <span class="main">∈</span> <span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-Min_elem_dest"><span class="command">lemma</span></span> Min_elem_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> Min <span class="free">A</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Floyd_Warshall-D_dest"><span class="command">lemma</span></span> D_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> D <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span> <span class="main">⟹</span>
  <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="free">k</span><span class="main">}</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Min_elem_dest<span class="main">[</span><span class="operator">OF</span> D_base_finite'' D_base_not_empty<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D_def<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-D_dest'"><span class="command">lemma</span></span> D_dest'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> D <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="free">k</span><span class="main">}</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Min_elem_dest<span class="main">[</span><span class="operator">OF</span> D_base_finite'' D_base_not_empty<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D_def<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-D_dest''"><span class="command">lemma</span></span> D_dest''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> D <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Min_elem_dest<span class="main">[</span><span class="operator">OF</span> D_base_finite'' D_base_not_empty<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D_def<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-cycle_free_loop_dest"><span class="command">lemma</span></span> cycle_free_loop_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> cycle_free <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">i</span> <span class="free">xs</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cycle_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Floyd_Warshall-cycle_free_dest"><span class="command">lemma</span></span> cycle_free_dest<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cycle_free <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>
    <span class="main">⟹</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>rem_cycles <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cycle_free_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cycle_free_up_to</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cycle_free_up_to</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">i</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟶</span> len <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">(</span>rem_cycles <span class="bound">i</span> <span class="bound">j</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">≤</span> len <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">∧</span> len <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">i</span> <span class="bound">i</span> <span class="bound">xs</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="Floyd_Warshall-cycle_free_up_to_loop_dest"><span class="command">lemma</span></span> cycle_free_up_to_loop_dest<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">⟹</span> cycle_free_up_to <span class="free">m</span> <span class="free">k</span> <span class="free">n</span> <span class="main">⟹</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">i</span> <span class="free">xs</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cycle_free_up_to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Floyd_Warshall-cycle_free_up_to_diag"><span class="command">lemma</span></span> cycle_free_up_to_diag<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cycle_free_up_to <span class="free">m</span> <span class="free">k</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">i</span> <span class="free">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> cycle_free_up_to_loop_dest<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Floyd_Warshall-D_eqI2"><span class="command">lemma</span></span> D_eqI2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="free">n</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≡</span> <span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">A_distinct</span> <span class="main">≡</span> <span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cycle_free_up_to <span class="free">m</span> <span class="free">k</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A_distinct</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"D <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D_def A_distinct_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Min_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A_distinct</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D_base_finite''<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> A_distinct_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A_distinct</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rem_cycles <span class="free">i</span> <span class="free">j</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?ys</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3-6<span class="main">)</span> xs <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cycle_free_up_to_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> set <span class="var">?ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∉</span> set <span class="var">?ys</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="var">?ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rem_cycles_distinct remove_all_removes rem_cycles_removes_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> xs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> <span class="free">A_distinct</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_distinct_def <span class="keyword1"><span class="command">using</span></span> rem_cycles_subs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-6<span class="main">)</span> xs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cycle_free_up_to_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A_distinct</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> distinct xs<span class="main">(</span>2<span class="main">)</span> rem_cycles_subs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_distinct_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Connecting the Algorithm to the Notion of Shortest Paths›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Under the absence of negative cycles, the \fw correctly computes the length of the shortest path
  between any pair of vertices <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i, j›</span></span></span></span>.
›</span></span>
<span class="keyword1" id="Floyd_Warshall-canonical_D"><span class="command">lemma</span></span> canonical_D<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"cycle_free_up_to <span class="free">m</span> <span class="free">k</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"D <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span> <span class="main">=</span> <span class="free">m</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> D_eqI2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">assumption</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> canonical_subs_len<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">theorem</span></span> fw_subs_len<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> fw_correct<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> canonical_subs_len<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> len <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fw_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">x</span> <span class="free">j</span> <span class="skolem">xs</span> <span class="main">≤</span> len <span class="free">m</span> <span class="skolem">x</span> <span class="free">j</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> fw_mono<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This shows that the value calculated by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fwi›</span></span></span></span> for a pair <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i, j›</span></span></span></span> always corresponds to the length
  of an actual path between <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span>.
›</span></span>
<span class="keyword1" id="Floyd_Warshall-fwi_len'"><span class="command">lemma</span></span> fwi_len'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i'</span> <span class="free">j'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">k</span> <span class="free">k</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fwi_step'<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> min_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="free"><span class="free"><span class="free">k</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The same result for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fw›</span></span></span></span>.
›</span></span>
<span class="keyword1" id="Floyd_Warshall-fw_len"><span class="command">lemma</span></span> fw_len<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">from</span></span> cyc_free_subs_diag<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">0</span> <span class="main">0</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fwi_len'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span> <span class="main">∧</span> fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="bound">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> fw_cyc_free_subs<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="skolem">k</span><span class="main">}</span> <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH Suc.prems<span class="main">(</span>1<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> Suc.prems fwi_len'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="main">{</span>Suc <span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"fwi <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">n</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">n</span> <span class="free">n</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> len <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Suc.prems<span class="main">(</span>2-<span class="main">)</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="skolem">k</span><span class="main">}</span> <span class="main">∧</span> len <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">xs</span> <span class="main">=</span> len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys<span class="main">:</span>
      <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"len <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">j</span> <span class="skolem">xs</span> <span class="main">=</span> len <span class="free">m</span> <span class="skolem">x</span> <span class="skolem">j</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> Cons.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">=</span> len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"len <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len_comp<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Intermezzo: Equivalent Characterizations of Cycle-Freeness›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Shortening Negative Cycles›</span></span>

<span class="keyword1" id="Floyd_Warshall-remove_cycles_neg_cycles_aux"><span class="command">lemma</span></span> remove_cycles_neg_cycles_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="free">xs</span> <span class="free">ys</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">≡</span> <span class="free">i</span> <span class="main">#</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">as</span> <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">(#)</span> <span class="free">i</span><span class="main">)</span> <span class="free">xss</span><span class="main">)</span> <span class="main">@</span> <span class="free">xs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">ys</span> <span class="main">&gt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">∧</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">i</span> <span class="bound">ys</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">with</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">i</span> <span class="skolem">as</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>4<span class="main">,</span>6<span class="main">)</span> len_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="skolem">xs</span> <span class="main">=</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">i</span> <span class="skolem">as</span> <span class="main">+</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> 1<span class="main">(</span>11<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">ys</span> <span class="main">≤</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> add_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Nil<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">zs</span> <span class="skolem">xss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">(#)</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">@</span> <span class="free">xs'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">i</span> <span class="skolem">as</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>5<span class="main">,</span>7<span class="main">)</span> len_decomp add_mono
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xs</span> <span class="main">≤</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xs</span> <span class="main">&lt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?xs</span> <span class="main">⊆</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> 2 _ 4<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> set <span class="var">?xs</span> <span class="main">∧</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">i</span> <span class="bound">ys</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>5<span class="main">,</span>7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-add_lt_neutral"><span class="command">lemma</span></span> add_lt_neutral<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> add_mono<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">b</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-remove_cycles_neg_cycles_aux'"><span class="command">lemma</span></span> remove_cycles_neg_cycles_aux'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">j</span> <span class="free">xs</span> <span class="free">ys</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∉</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">j</span> <span class="main">#</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span><span class="main">)</span> <span class="free">xss</span><span class="main">)</span> <span class="main">@</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">ys</span> <span class="main">&gt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">∧</span> len <span class="free">m</span> <span class="free">j</span> <span class="free">j</span> <span class="bound">ys</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">j</span> <span class="free">j</span> <span class="skolem">as</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> Nil<span class="main">(</span>3<span class="main">)</span> len_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="skolem">xs</span> <span class="main">=</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">ys</span> <span class="main">+</span> len <span class="free">m</span> <span class="free">j</span> <span class="free">j</span> <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">ys</span> <span class="main">≤</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> add_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">zs</span> <span class="skolem">xss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">@</span> <span class="free">j</span> <span class="main">#</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">as</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">as</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xs</span> <span class="main">≤</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="skolem">xs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xs</span> <span class="main">&lt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> set <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?xs</span> <span class="main">⊆</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 2 _ 4<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> set <span class="var">?xs</span> <span class="main">∧</span> len <span class="free">m</span> <span class="free">j</span> <span class="free">j</span> <span class="bound">ys</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="skolem">xs</span> <span class="main">&lt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this len_decomp Cons<span class="main">(</span>4<span class="main">)</span> add_mono
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">j</span> <span class="free">j</span> <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">&lt;</span> len <span class="free">m</span> <span class="free">j</span> <span class="free">j</span> <span class="var">?t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False local.leI <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">j</span> <span class="free">j</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="free">j</span> <span class="main">#</span> <span class="var">?t</span><span class="main">)</span> <span class="main">&lt;</span> len <span class="free">m</span> <span class="free">j</span> <span class="free">j</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> len_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">@</span> <span class="free">j</span> <span class="main">#</span> <span class="var">?t</span>"</span></span> <span class="quoted"><span class="skolem">zs</span></span> <span class="quoted"><span class="free">j</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">j</span> <span class="free">j</span> <span class="skolem">zs</span> <span class="main">+</span> len <span class="free">m</span> <span class="free">j</span> <span class="free">j</span> <span class="var">?t</span> <span class="main">&lt;</span> len <span class="free">m</span> <span class="free">j</span> <span class="free">j</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">j</span> <span class="free">j</span> <span class="skolem">zs</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> add_lt_neutral <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-add_le_impl"><span class="command">lemma</span></span> add_le_impl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">+</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">+</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≥</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> add_mono<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">+</span> <span class="free">c</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-start_remove_neg_cycles"><span class="command">lemma</span></span> start_remove_neg_cycles<span class="main">:</span>
  <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>start_remove <span class="free">xs</span> <span class="free">k</span> <span class="main">[]</span><span class="main">)</span> <span class="main">&gt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">∧</span> len <span class="free">m</span> <span class="free">k</span> <span class="free">k</span> <span class="bound">ys</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"start_remove <span class="free">xs</span> <span class="free">k</span> <span class="main">[]</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> len_lt<span class="main">:</span><span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xs</span> <span class="main">&gt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> start_remove_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> start_remove_decomp<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> as_bs<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="free">k</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xs</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> remove_cycles <span class="skolem">bs</span> <span class="free">k</span> <span class="main">[</span><span class="free">k</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"remove_cycles <span class="skolem">bs</span> <span class="free">k</span> <span class="main">[</span><span class="free">k</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> set <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> as_bs len_lt remove_cycles_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?xs</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="free">k</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xs'</span> <span class="main">=</span> <span class="free">k</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> as_bs<span class="main">(</span>2<span class="main">)</span> remove_cycles_begins_with<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">∈</span> set <span class="skolem">bs</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> len_lt'<span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">k</span> <span class="free">j</span> <span class="skolem">bs</span> <span class="main">&lt;</span> len <span class="free">m</span> <span class="free">k</span> <span class="free">j</span> <span class="skolem">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> len_decomp<span class="main">[</span><span class="operator">OF</span> as_bs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> len_decomp<span class="main">[</span><span class="operator">OF</span> ys<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> len_lt add_le_impl <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> remove_cycles_cycles<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">∈</span> set <span class="skolem">bs</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xss</span></span> <span class="skolem"><span class="skolem">as'</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as'</span> <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">(#)</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">@</span> <span class="var">?xs'</span> <span class="main">=</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as'</span> <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">(#)</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">@</span> <span class="free">k</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ys<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> remove_cycles_neg_cycles_aux<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">∉</span> set <span class="skolem">ys</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">∈</span> set <span class="skolem">bs</span>›</span></span> this<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> len_lt'<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> as_bs<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-remove_all_cycles_neg_cycles"><span class="command">lemma</span></span> remove_all_cycles_neg_cycles<span class="main">:</span>
  <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>remove_all_cycles <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span> <span class="main">&gt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>
  <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">ys</span> <span class="bound">k</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> len <span class="free">m</span> <span class="bound">k</span> <span class="bound">k</span> <span class="bound">ys</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"start_remove <span class="skolem">xs</span> <span class="skolem">y</span> <span class="main">[]</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="skolem">xs</span> <span class="main">&lt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> start_remove_id <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> start_remove_neg_cycles<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xs</span> <span class="main">&lt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>remove_all_cycles <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xs</span> <span class="main">&lt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>remove_all_cycles <span class="skolem">ys</span> <span class="var">?xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> start_remove_subs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-concat_map_cons_rev"><span class="command">lemma</span></span> concat_map_cons_rev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rev <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">(#)</span> <span class="free">j</span><span class="main">)</span> <span class="free">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">(</span>map rev <span class="free">xss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xss</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Floyd_Warshall-negative_cycle_dest"><span class="command">lemma</span></span> negative_cycle_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>rem_cycles <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="main">&gt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>
       <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">i'</span> <span class="bound">ys</span><span class="main">.</span> len <span class="free">m</span> <span class="bound">i'</span> <span class="bound">i'</span> <span class="bound">ys</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> set <span class="bound">ys</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="bound">i'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">i</span> <span class="main">#</span> <span class="free">j</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xsij</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rem_cycles <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xsj</span></span></span>  <span class="main">=</span> <span class="quoted"><span class="quoted">"remove_all_rev <span class="free">j</span> <span class="main">(</span>remove_all_cycles <span class="free">xs</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span>   <span class="main">=</span> <span class="quoted"><span class="quoted">"remove_all_cycles <span class="free">xs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> len_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xsij</span> <span class="main">&gt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xsij</span> <span class="main">≤</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xsj</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> len_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xsj</span> <span class="main">&gt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> len_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xsj</span> <span class="main">≤</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xs</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xs</span> <span class="main">&gt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> len_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> remove_all_cycles_neg_cycles<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_lt'<span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xsj</span> <span class="main">&gt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> set <span class="var">?xs</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> len_lt' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_all_rev_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">from</span></span> remove_all_rev_removes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∉</span> set <span class="var">?xsj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> set <span class="main">(</span>rev <span class="var">?xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> remove_cycles_cycles<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xss</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> as<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">(#)</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">@</span> remove_cycles <span class="main">(</span>rev <span class="var">?xs</span><span class="main">)</span> <span class="free">j</span> <span class="main">[]</span> <span class="main">=</span> rev <span class="var">?xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∉</span> set <span class="skolem">as</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xsj</span> <span class="main">=</span> rev <span class="main">(</span>tl <span class="main">(</span>remove_cycles <span class="main">(</span>rev <span class="var">?xs</span><span class="main">)</span> <span class="free">j</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_all_rev_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> remove_cycles_begins_with<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">∈</span> set <span class="main">(</span>rev <span class="var">?xs</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"remove_cycles <span class="main">(</span>rev <span class="var">?xs</span><span class="main">)</span> <span class="free">j</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">j</span> <span class="main">#</span> rev <span class="var">?xsj</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∉</span> set <span class="var">?xsj</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> as<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> xss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">(#)</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">@</span> <span class="free">j</span> <span class="main">#</span> rev <span class="var">?xsj</span> <span class="main">=</span> rev <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">(#)</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">@</span> <span class="free">j</span> <span class="main">#</span> rev <span class="var">?xsj</span><span class="main">)</span> <span class="main">=</span> <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xsj</span> <span class="main">@</span> <span class="free">j</span> <span class="main">#</span> rev <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">(#)</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> rev <span class="skolem">as</span> <span class="main">=</span> <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xsj</span> <span class="main">@</span> <span class="free">j</span> <span class="main">#</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">(</span>map rev <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> rev <span class="skolem">as</span> <span class="main">=</span> <span class="var">?xs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> concat_map_cons_rev<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> remove_cycles_neg_cycles_aux'<span class="main">[</span><span class="operator">OF</span> 1 True this<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> len_lt'<span class="main">]</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> remove_all_cycles_subs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> len_lt'<span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xsij</span> <span class="main">&gt;</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="var">?xsj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="var">?xsj</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> len_lt' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_all_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> remove_all_removes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> set <span class="var">?xsij</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_all_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> remove_cycles_cycles<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xss</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> as<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">(#)</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">@</span> remove_cycles <span class="var">?xsj</span> <span class="free">i</span> <span class="main">[]</span> <span class="main">=</span> <span class="var">?xsj</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> set <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xsij</span> <span class="main">=</span> tl <span class="main">(</span>remove_cycles <span class="var">?xsj</span> <span class="free">i</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_all_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> remove_cycles_begins_with<span class="main">[</span><span class="operator">OF</span> True<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"remove_cycles <span class="var">?xsj</span> <span class="free">i</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">i</span> <span class="main">#</span> <span class="var">?xsij</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> set <span class="var">?xsij</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> as<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> xss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">(#)</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">@</span> <span class="free">i</span> <span class="main">#</span> <span class="var">?xsij</span> <span class="main">=</span> <span class="var">?xsj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> remove_cycles_neg_cycles_aux<span class="main">[</span><span class="operator">OF</span> 1 True this<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> len_lt'<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> remove_all_rev_subs remove_all_cycles_subs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cycle-Freeness›</span></span>

<span class="keyword1" id="Floyd_Warshall-cycle_free_alt_def"><span class="command">lemma</span></span> cycle_free_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cycle_free <span class="free">M</span> <span class="free">n</span> <span class="main">⟷</span> cycle_free_up_to <span class="free">M</span> <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cycle_free_def cycle_free_up_to_def <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Floyd_Warshall-negative_cycle_dest_diag"><span class="command">lemma</span></span> negative_cycle_dest_diag<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> cycle_free_up_to <span class="free">m</span> <span class="free">k</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">i</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> len <span class="free">m</span> <span class="bound">i</span> <span class="bound">i</span> <span class="bound">xs</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cycle_free_up_to_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">xs</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">xs</span> <span class="main">&lt;</span> len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">(</span>rem_cycles <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> negative_cycle_dest<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">ys</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="skolem">i'</span> <span class="skolem">i'</span> <span class="skolem">ys</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">i</span> <span class="main">#</span> <span class="skolem">j</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> 1<span class="main">(</span>1-4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-negative_cycle_dest_diag'"><span class="command">lemma</span></span> negative_cycle_dest_diag'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> cycle_free <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">i</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> len <span class="free">m</span> <span class="bound">i</span> <span class="bound">i</span> <span class="bound">xs</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> negative_cycle_dest_diag<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cycle_free_alt_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cyc_free</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cyc_free</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">i</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span> <span class="main">⟶</span> len <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">i</span> <span class="bound">i</span> <span class="bound">xs</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="Floyd_Warshall-cycle_free_diag_intro"><span class="command">lemma</span></span> cycle_free_diag_intro<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cyc_free <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> cycle_free <span class="free">m</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> negative_cycle_dest_diag' <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Floyd_Warshall-cycle_free_diag_equiv"><span class="command">lemma</span></span> cycle_free_diag_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cyc_free <span class="free">m</span> <span class="free">n</span> <span class="main">⟷</span> cycle_free <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> negative_cycle_dest_diag'
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cycle_free_def<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-cycle_free_diag_dest"><span class="command">lemma</span></span> cycle_free_diag_dest<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cycle_free <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> cyc_free <span class="free">m</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cycle_free_diag_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Floyd_Warshall-cycle_free_upto_diag_equiv"><span class="command">lemma</span></span> cycle_free_upto_diag_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cycle_free_up_to <span class="free">m</span> <span class="free">k</span> <span class="free">n</span> <span class="main">⟷</span> cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> negative_cycle_dest_diag<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cycle_free_up_to_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> fw_shortest_path_up_to<span class="main">:</span>
  <span class="quoted"><span class="quoted">"D <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span> <span class="main">=</span> fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> cycle_free<span class="main">:</span> <span class="quoted"><span class="quoted">"cycle_free_up_to <span class="free">m</span> <span class="free">k</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cycle_free_upto_diag_equiv<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fw_correct<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> D_eqI2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> that<span class="main">(</span>1<span class="main">)</span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fw_subs_len<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 6
    <span class="keyword1"><span class="command">from</span></span> fw_len<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> that<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> that cycle_free<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We do not need to prove this because the definitions match.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"cyc_free <span class="free">m</span> <span class="free">n</span> <span class="main">⟷</span> cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Floyd_Warshall-cycle_free_cycle_free_up_to"><span class="command">lemma</span></span> cycle_free_cycle_free_up_to<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cycle_free <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> cycle_free_up_to <span class="free">m</span> <span class="free">k</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cycle_free_def cycle_free_up_to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Floyd_Warshall-cycle_free_diag"><span class="command">lemma</span></span> cycle_free_diag<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cycle_free <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">i</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> cycle_free_up_to_diag<span class="main">[</span><span class="operator">OF</span> cycle_free_cycle_free_up_to<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> fw_shortest_path<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cyc_free <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> D <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span> <span class="main">=</span> fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fw_shortest_path_up_to<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> fw_shortest<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cyc_free <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="free">n</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> fw <span class="free">m</span> <span class="free">n</span> <span class="free">n</span> <span class="free">i</span> <span class="free">k</span> <span class="main">+</span> fw <span class="free">m</span> <span class="free">n</span> <span class="free">n</span> <span class="free">k</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fw_canonical_subs<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> canonical_subs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Result Under the Presence of Negative Cycles›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Under the presence of negative cycles, the \fw will detect the situation by computing a negative
  diagonal entry.
›</span></span>

<span class="keyword1" id="Floyd_Warshall-not_cylce_free_dest"><span class="command">lemma</span></span> not_cylce_free_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> cycle_free <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> <span class="main">¬</span> cycle_free_up_to <span class="free">m</span> <span class="bound">k</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cycle_free_def cycle_free_up_to_def<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-D_not_diag_le"><span class="command">lemma</span></span> D_not_diag_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">xs</span> <span class="main">|</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>
  <span class="main">⟹</span> D <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Min_le<span class="main">[</span><span class="operator">OF</span> D_base_finite''<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D_def<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-D_not_diag_le'"><span class="command">lemma</span></span> D_not_diag_le'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="free">xs</span>
  <span class="main">⟹</span> D <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">k</span> <span class="main">≤</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Min_le<span class="main">[</span><span class="operator">OF</span> D_base_finite''<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D_def<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-nat_upto_subs_top_removal'"><span class="command">lemma</span></span> nat_upto_subs_top_removal'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> Suc <span class="free">n</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n x<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="improper">n</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Floyd_Warshall-nat_upto_subs_top_removal"><span class="command">lemma</span></span> nat_upto_subs_top_removal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">::</span>nat<span class="main">}</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> nat_upto_subs_top_removal' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Monotonicity with respect to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>.›</span></span>
<span class="keyword1" id="Floyd_Warshall-fw_invariant"><span class="command">lemma</span></span> fw_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> fw <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> fw <span class="free">m</span> <span class="free">n</span> <span class="free">k'</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fwi_invariant<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> fw <span class="free">m</span> <span class="free">n</span> <span class="free">k'</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fwi_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-negative_len_shortest"><span class="command">lemma</span></span> negative_len_shortest<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">i</span> <span class="free">xs</span> <span class="main">&lt;</span> <span class="main">0</span>
    <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">j</span> <span class="bound">ys</span><span class="main">.</span> distinct <span class="main">(</span><span class="bound">j</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∧</span> len <span class="free">m</span> <span class="bound">j</span> <span class="bound">j</span> <span class="bound">ys</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">i</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> set <span class="bound">ys</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> split_list<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="skolem">as</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">from</span></span> xs less.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> less.IH<span class="main">[</span><span class="operator">OF</span> this _ True<span class="main">]</span> xs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">from</span></span> len_decomp<span class="main">[</span><span class="operator">OF</span> xs<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">=</span> len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="skolem">as</span> <span class="main">+</span> len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> False less.prems <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="skolem">bs</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_lt_neutral local.dual_order.strict_trans local.neqE<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> xs less.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> less.IH<span class="main">[</span><span class="operator">OF</span> this _ *<span class="main">]</span> xs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> i less.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">from</span></span> not_distinct_decomp<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">cs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">a</span> <span class="skolem">bs</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">from</span></span> xs less.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> less.IH<span class="main">[</span><span class="operator">OF</span> this _ True<span class="main">]</span> xs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">from</span></span> len_decomp<span class="main">[</span><span class="operator">OF</span> xs<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">m</span></span>  <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> len_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="skolem">bs</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">cs</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">=</span> len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">a</span> <span class="skolem">as</span> <span class="main">+</span> <span class="main">(</span>len <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">a</span> <span class="skolem">bs</span> <span class="main">+</span> len <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">i</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">a</span> <span class="skolem">bs</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> add_mono <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">a</span> <span class="skolem">bs</span> <span class="main">+</span> len <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">i</span> <span class="skolem">cs</span> <span class="main">≥</span> len <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">i</span> <span class="skolem">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">≥</span> len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">a</span> <span class="skolem">as</span> <span class="main">+</span> len <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">i</span> <span class="skolem">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> less.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">a</span> <span class="skolem">as</span> <span class="main">+</span> len <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">i</span> <span class="skolem">cs</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> len_comp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> less.IH<span class="main">[</span><span class="operator">OF</span> _ _ this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span><span class="main">]</span> xs less.prems
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-fw_upd_leI"><span class="command">lemma</span></span> fw_upd_leI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fw_upd <span class="free">m'</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> fw_upd <span class="free">m</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="free">i</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">i</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="free">k</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">k</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">m</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> fw_upd_def upd_def min_def <span class="keyword1"><span class="command">using</span></span> add_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Floyd_Warshall-fwi_fw_upd_mono"><span class="command">lemma</span></span> fwi_fw_upd_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fwi <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> fw_upd <span class="free">m</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fw_upd_leI fwi_mono<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The \fw will always detect negative cycles. The argument goes as follows:
  In case there is a negative cycle, then we know that there is some smallest <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span> for which
  there is a negative cycle containing only intermediate vertices from the set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>{0…k}›</span></span></span></span>.
  We will show that then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fwi m n k›</span></span></span></span> computes a negative entry on the diagonal, and thus,
  by monotonicity, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fw m n n›</span></span></span></span> will compute a negative entry on the diagonal.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> FW_neg_cycle_detect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> cyc_free <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> fw <span class="free">m</span> <span class="free">n</span> <span class="free">n</span> <span class="bound">i</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> cyc_free <span class="free">m</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?K</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">k</span><span class="main">}</span> <span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Min <span class="var">?K</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> not_empty_K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?K</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?K</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> not_empty_K <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">k'</span></span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">.</span> cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">k'</span><span class="main">}</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k_def not_le<span class="main">)</span>
      <span class="main">(</span><span class="operator">meson</span> less_imp_le_nat local.leI order_less_irrefl preorder_class.order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> linorder_class.Min_in<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="var">?K</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?K</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xs</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> len <span class="free">m</span> <span class="bound">j</span> <span class="bound">j</span> <span class="bound">xs</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> len <span class="free">m</span> <span class="skolem">a</span> <span class="skolem">a</span> <span class="skolem">as</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> set <span class="skolem">as</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> negative_len_shortest<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span>"</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_xs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">j</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∧</span> len <span class="free">m</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="skolem">xs</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">∧</span> set <span class="skolem">xs</span> <span class="main">⊆</span> set <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> a_as <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> cyc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="skolem">xs</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">j</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span><span class="quoted"><span class="quoted">"cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span>›</span></span> nat_upto_subs_top_removal <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹cyc_free_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> len <span class="free">m</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> cyc<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> cyc<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> set <span class="skolem">xs</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">k</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> split_list<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span><span class="skolem">j</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">k</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∉</span> set <span class="skolem">zs</span>"</span></span>
             <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∉</span> set <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> xs<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span>›</span></span> nat_upto_subs_top_removal <span class="keyword1"><span class="command">have</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> xs<span class="main">(</span>1<span class="main">,</span>5<span class="main">)</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span>›</span></span> nat_upto_subs_top_removal <span class="keyword1"><span class="command">have</span></span> zs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"D <span class="free">m</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> fw_shortest_path_up_to<span class="main">[</span><span class="operator">OF</span> **<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"D <span class="free">m</span> <span class="skolem">k</span> <span class="skolem">j</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> fw_shortest_path_up_to<span class="main">[</span><span class="operator">OF</span> **<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">+</span> fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">j</span> <span class="main">≤</span> len <span class="free">m</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="skolem">ys</span> <span class="main">+</span> len <span class="free">m</span> <span class="skolem">k</span> <span class="skolem">j</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D_not_diag_le'<span class="main">[</span><span class="operator">OF</span> zs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> xs<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> D_not_diag_le'<span class="main">[</span><span class="operator">OF</span> ys<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> xs<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neg<span class="main">:</span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">+</span> fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xs<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹len <span class="free">m</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="skolem">xs</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> len_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="main">≤</span> fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">+</span> fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span> <span class="main">=</span> fwi <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span> <span class="skolem">k</span> <span class="free">n</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> fw_cyc_free_subs<span class="main">[</span><span class="operator">OF</span> **<span class="main">,</span> <span class="operator">THEN</span> cyc_free_subs_diag<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">k</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> fwi_step'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> min.cobounded2 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> neg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fw_invariant <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="free">n</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="main">≤</span> fw <span class="free">m</span> <span class="free">n</span> <span class="skolem">k</span> <span class="skolem">j</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> cyc<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> ys<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">ys</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> cyc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> fw_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="free">n</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> cyc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">j</span> <span class="main">0</span> <span class="main">+</span> <span class="free">m</span> <span class="main">0</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="main">0</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="main">≤</span> fw_upd <span class="free">m</span> <span class="main">0</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fwi_invariant fwi_fw_upd_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="main">0</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fw_upd_def upd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="main">0</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cyc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less_or_eq_imp_le single_iteration_inv<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fw <span class="free">m</span> <span class="free">n</span> <span class="free">n</span> <span class="skolem">j</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fw_invariant<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* End of local class context *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹More on Canonical Matrices›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">canonical</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">i</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">j</span> <span class="bound">k</span>"</span></span>

<span class="keyword1" id="Floyd_Warshall-canonical_alt_def"><span class="command">lemma</span></span> canonical_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"canonical <span class="free">M</span> <span class="free">n</span> <span class="main">⟷</span> canonical_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> canonical_subs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Floyd_Warshall-fw_canonical"><span class="command">lemma</span></span> fw_canonical<span class="main">:</span>
 <span class="quoted"><span class="quoted">"canonical <span class="main">(</span>fw <span class="free">m</span> <span class="free">n</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"cyc_free <span class="free">m</span> <span class="free">n</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> fw_canonical_subs<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹cyc_free <span class="free">m</span> <span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> canonical_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Floyd_Warshall-canonical_len"><span class="command">lemma</span></span> canonical_len<span class="main">:</span>
  <span class="quoted"><span class="quoted">"canonical <span class="free">M</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">M</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> len <span class="free">M</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="skolem">x</span> <span class="free">j</span> <span class="main">≤</span> len <span class="free">M</span> <span class="skolem">x</span> <span class="free">j</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="quoted"><span class="quoted">‹canonical <span class="free">M</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="skolem">i</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">M</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">M</span> <span class="skolem">x</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">M</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">+</span> len <span class="free">M</span> <span class="skolem">x</span> <span class="free">j</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Additional Theorems›</span></span>

<span class="keyword1" id="Floyd_Warshall-D_cycle_free_len_dest"><span class="command">lemma</span></span> D_cycle_free_len_dest<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cycle_free <span class="free">m</span> <span class="free">n</span>
    <span class="main">⟹</span> <span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> D <span class="free">m</span> <span class="bound">i</span> <span class="bound">j</span> <span class="free">n</span> <span class="main">=</span> <span class="free">m'</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>
    <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> len <span class="free">m'</span> <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span> <span class="main">=</span> len <span class="free">m</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">with</span></span> Nil <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="skolem">i</span> <span class="free">j</span> <span class="main">=</span> D <span class="free">m</span> <span class="skolem">i</span> <span class="free">j</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> D_dest''<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m'</span> <span class="skolem">i</span> <span class="free">j</span> <span class="main">[]</span> <span class="main">=</span> len <span class="free">m</span> <span class="skolem">i</span> <span class="free">j</span> <span class="skolem">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> _ <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> Cons.prems<span class="main">(</span>5<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> zs<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m'</span> <span class="skolem">y</span> <span class="free">j</span> <span class="skolem">ys</span> <span class="main">=</span> len <span class="free">m</span> <span class="skolem">y</span> <span class="free">j</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="skolem">i</span> <span class="skolem">y</span> <span class="main">=</span> D <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">y</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> D_dest''<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> ws<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="skolem">ws</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="skolem">i</span> <span class="skolem">y</span> <span class="main">=</span> len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">y</span> <span class="skolem">ws</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> len_comp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="skolem">ws</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">zs</span></span><span class="main">]</span> zs Cons.prems<span class="main">(</span>5<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"len <span class="free">m'</span> <span class="skolem">i</span> <span class="free">j</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> len <span class="free">m</span> <span class="skolem">i</span> <span class="free">j</span> <span class="main">(</span><span class="skolem">ws</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">ws</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-D_cyc_free_preservation"><span class="command">lemma</span></span> D_cyc_free_preservation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cyc_free <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> D <span class="free">m</span> <span class="bound">i</span> <span class="bound">j</span> <span class="free">n</span> <span class="main">=</span> <span class="free">m'</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">⟹</span> cyc_free <span class="free">m'</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> D_cycle_free_len_dest<span class="main">[</span><span class="operator">OF</span> _ 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> 1<span class="main">(</span>1<span class="main">)</span> cycle_free_diag_equiv
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> len <span class="free">m'</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">=</span> len <span class="free">m</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> 1<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">FW</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> fw <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1" id="Floyd_Warshall-FW_out_of_bounds1"><span class="command">lemma</span></span> FW_out_of_bounds1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>FW <span class="free">M</span> <span class="free">n</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="free">M</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fw_out_of_bounds1<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-FW_out_of_bounds2"><span class="command">lemma</span></span> FW_out_of_bounds2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>FW <span class="free">M</span> <span class="free">n</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="free">M</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fw_out_of_bounds2<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-FW_cyc_free_preservation"><span class="command">lemma</span></span> FW_cyc_free_preservation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cyc_free <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> cyc_free <span class="main">(</span>FW <span class="free">m</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> D_cyc_free_preservation<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fw_shortest_path<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> cycle_free_diag_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Floyd_Warshall-cyc_free_diag_dest'"><span class="command">lemma</span></span> cyc_free_diag_dest'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cyc_free <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">m</span> <span class="free">i</span> <span class="free">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cyc_free_subs_diag<span class="main">)</span>

<span class="keyword1" id="Floyd_Warshall-FW_diag_neutral_preservation"><span class="command">lemma</span></span> FW_diag_neutral_preservation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> <span class="free">M</span> <span class="bound">i</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> cyc_free <span class="free">M</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span>FW <span class="free">M</span> <span class="free">n</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>FW <span class="free">M</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="free">M</span> <span class="skolem">i</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fw_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>FW <span class="free">M</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> cyc_free_diag_dest'<span class="main">[</span><span class="operator">OF</span> FW_cyc_free_preservation<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"FW <span class="free">M</span> <span class="free">n</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-FW_fixed_preservation"><span class="command">lemma</span></span> FW_fixed_preservation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linordered_ab_monoid_add<span class="main">)</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">0</span> <span class="free">i</span> <span class="main">+</span> <span class="free">M</span> <span class="free">i</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"canonical <span class="main">(</span>FW <span class="free">M</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"cyc_free <span class="main">(</span>FW <span class="free">M</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FW <span class="free">M</span> <span class="free">n</span> <span class="main">0</span> <span class="free">i</span> <span class="main">+</span> FW <span class="free">M</span> <span class="free">n</span> <span class="free">i</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"FW <span class="free">M</span> <span class="free">n</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">0</span> <span class="free">i</span> <span class="main">+</span> <span class="free">M</span> <span class="free">i</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"canonical <span class="var">?M'</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"cyc_free <span class="var">?M'</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M'</span> <span class="main">0</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?M'</span> <span class="free">i</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">M</span> <span class="main">0</span> <span class="free">i</span> <span class="main">+</span> <span class="free">M</span> <span class="free">i</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fw_mono add_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> A<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M'</span> <span class="main">0</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?M'</span> <span class="free">i</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹canonical <span class="var">?M'</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M'</span> <span class="main">0</span> <span class="main">0</span> <span class="main">≤</span> <span class="var">?M'</span> <span class="main">0</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?M'</span> <span class="free">i</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> cyc_free_diag_dest'<span class="main">[</span><span class="operator">OF</span>  <span class="quoted"><span class="quoted">‹cyc_free <span class="var">?M'</span> <span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="var">?M'</span> <span class="main">0</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M'</span> <span class="main">0</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?M'</span> <span class="free">i</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-diag_cyc_free_neutral"><span class="command">lemma</span></span> diag_cyc_free_neutral<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cyc_free <span class="free">M</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="free">M</span> <span class="bound">k</span> <span class="bound">k</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="free">M</span> <span class="bound">i</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> this
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> set <span class="main">[]</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> A<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">M</span> <span class="skolem">i</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> A<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-fw_upd_canonical_subs_id"><span class="command">lemma</span></span> fw_upd_canonical_subs_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> fw_upd <span class="free">M</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fw_upd_def upd_def less_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> min.coboundedI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">i</span> <span class="free">k</span> <span class="main">+</span> <span class="free">M</span> <span class="free">k</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> canonical_subs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">M</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">M</span> <span class="free">i</span> <span class="free">k</span> <span class="main">+</span> <span class="free">M</span> <span class="free">k</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_min<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-fw_upd_canonical_id"><span class="command">lemma</span></span> fw_upd_canonical_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"canonical <span class="free">M</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> fw_upd <span class="free">M</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fw_upd_canonical_subs_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> canonical_subs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Floyd_Warshall-fwi_canonical_id"><span class="command">lemma</span></span> fwi_canonical_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fwi <span class="free">M</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fw_upd_canonical_subs_id<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Suc
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fw_upd_canonical_subs_id<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Floyd_Warshall-fw_canonical_id"><span class="command">lemma</span></span> fw_canonical_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fw <span class="free">M</span> <span class="free">n</span> <span class="free">k</span> <span class="main">=</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> canonical_subs_def fwi_canonical_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> FW_canonical_id <span class="main">=</span> fw_canonical_id<span class="main">[</span><span class="operator">OF</span> _ order.refl<span class="main">,</span> <span class="operator">unfolded</span> canonical_alt_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">FWI</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> fwi <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The characteristic property of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fwi›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> fwi_characteristic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">::</span>nat<span class="main">}</span><span class="main">)</span> <span class="main">(</span>FWI <span class="free">M</span> <span class="free">n</span> <span class="free">k</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> FWI <span class="free">M</span> <span class="free">n</span> <span class="free">k</span> <span class="bound">i</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"canonical_subs <span class="free">n</span> <span class="free">I</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">k</span> <span class="free">k</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> fwi_canonical_extend<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> this <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> FWI_def <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> fwi_mono<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> FWI_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* End of theory *)</span>
</pre>
</div><div id="Recursion_Combinators">
<div class="head">
<h1>Theory Recursion_Combinators</h1>
</div>
<pre class="source"><span class="comment1">(* Authors: Lammich, Wimmer *)</span>
<span class="keyword1"><span class="command">theory</span></span> Recursion_Combinators
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../refine_imperative_hol/theories/#IICF">Refine_Imperative_HOL.IICF</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">for_comb</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">for_comb</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a0</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> nfoldli <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a0</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">for_rec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> nres<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">for_rec</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">for_rec</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">for_rec</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Recursion_Combinators-for_comb_for_rec"><span class="command">lemma</span></span> for_comb_for_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"for_comb <span class="free">f</span> <span class="free">a</span> <span class="free">n</span> <span class="main">=</span> for_rec <span class="free">f</span> <span class="free">a</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> for_comb_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> for_rec.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> IH<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nfoldli_append pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">for_rec2'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">for_rec2'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> RETURN <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">else</span> for_rec <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">i</span><span class="main">.</span> for_rec <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> for_rec <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">for_rec2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> nres<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">for_rec2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">0</span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">0</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">for_rec2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">for_rec2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">for_rec2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">for_rec2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Recursion_Combinators-for_rec2_for_rec2'"><span class="command">lemma</span></span> for_rec2_for_rec2'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"for_rec2 <span class="free">f</span> <span class="free">a</span> <span class="free">n</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> for_rec2' <span class="free">f</span> <span class="free">a</span> <span class="free">n</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> for_rec2'_def
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> for_rec2.induct<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> f a n i
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">for_rec3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> nres<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> nres"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">for_rec3</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">0</span>       <span class="main">0</span>       <span class="main">0</span>        <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">0</span> <span class="main">0</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">for_rec3</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">0</span>       <span class="main">0</span>        <span class="main">=</span> <span class="free">for_rec3</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">for_rec3</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>       <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">0</span>        <span class="main">=</span> <span class="free">for_rec3</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">for_rec3</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>       <span class="free"><span class="bound"><span class="entity">i</span></span></span>       <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="free">for_rec3</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">for_rec3'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">for_rec3'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> RETURN <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">else</span> for_rec <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">k</span><span class="main">.</span> for_rec2' <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> for_rec2' <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Recursion_Combinators-for_rec3_for_rec3'"><span class="command">lemma</span></span> for_rec3_for_rec3'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"for_rec3 <span class="free">f</span> <span class="free">a</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> for_rec3' <span class="free">f</span> <span class="free">a</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> for_rec3'_def
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> for_rec3.induct<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> for_rec2_for_rec2'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> f a n k
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Recursion_Combinators-for_rec2'_for_rec"><span class="command">lemma</span></span> for_rec2'_for_rec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"for_rec2' <span class="free">f</span> <span class="free">a</span> <span class="free">n</span> <span class="free">n</span> <span class="free">n</span> <span class="main">=</span>
    for_rec <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">i</span><span class="main">.</span> for_rec <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">a</span> <span class="free">n</span><span class="main">)</span> <span class="free">a</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> for_rec2'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Recursion_Combinators-for_rec3'_for_rec"><span class="command">lemma</span></span> for_rec3'_for_rec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"for_rec3' <span class="free">f</span> <span class="free">a</span> <span class="free">n</span> <span class="free">n</span> <span class="free">n</span> <span class="free">n</span> <span class="main">=</span>
    for_rec <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">k</span><span class="main">.</span> for_rec <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">i</span><span class="main">.</span> for_rec <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">k</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">a</span> <span class="free">n</span><span class="main">)</span> <span class="bound">a</span> <span class="free">n</span><span class="main">)</span> <span class="free">a</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> for_rec3'_def for_rec2'_for_rec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> for_rec_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"for_rec <span class="free">f</span> <span class="free">a</span> <span class="free">n</span> <span class="main">=</span> nfoldli <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">k</span><span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> for_comb_for_rec<span class="main">[</span><span class="operator">unfolded</span> for_comb_def<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">theorem</span></span> for_rec2_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"for_rec2 <span class="free">f</span> <span class="free">a</span> <span class="free">n</span> <span class="free">n</span> <span class="free">n</span> <span class="main">=</span>
     nfoldli <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span>
           <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> nfoldli <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span> <span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span>
  for_rec2'_for_rec<span class="main">[</span>
    <span class="operator">unfolded</span> for_rec2_for_rec2'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> for_comb_for_rec<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> for_comb_def
  <span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">theorem</span></span> for_rec3_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"for_rec3 <span class="free">f</span> <span class="free">a</span> <span class="free">n</span> <span class="free">n</span> <span class="free">n</span> <span class="free">n</span> <span class="main">=</span>
    nfoldli <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span>
     <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> nfoldli <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span>
           <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> nfoldli <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span> <span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">k</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span>
  for_rec3'_for_rec<span class="main">[</span>
    <span class="operator">unfolded</span> for_rec3_for_rec3'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> for_comb_for_rec<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> for_comb_def
  <span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intf_of_assn</span><span class="main">]</span> <span class="main">=</span> intf_of_assnI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_mtx</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> i_mtx"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">n</span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> param_upt<span class="main">[</span><span class="operator">sepref_import_param</span><span class="main">]</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FW_Code">
<div class="head">
<h1>Theory FW_Code</h1>
</div>
<pre class="source"><span class="comment1">(* Authors: Lammich, Wimmer *)</span>
<span class="keyword1"><span class="command">theory</span></span> FW_Code
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#Recursion_Combinators">Recursion_Combinators</a>
    <a href="#Floyd_Warshall">Floyd_Warshall</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Refinement to Efficient Imperative Code›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We will now refine the recursive version of the \fw to an efficient imperative version.
  To this end, we use the Imperative Refinement Framework, yielding an implementation in Imperative HOL.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fw_upd'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linordered_ab_monoid_add<span class="main">)</span> mtx <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> mtx nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fw_upd'</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span>
  RETURN <span class="main">(</span>
    op_mtx_set <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span>min <span class="main">(</span>op_mtx_get <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>op_mtx_get <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">+</span> op_mtx_get <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fwi'</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linordered_ab_monoid_add<span class="main">)</span> mtx <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> mtx nres"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fwi'</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> RECT <span class="main">(</span><span class="main">λ</span> <span class="bound">fw</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span>
      <span class="keyword1">case</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="keyword1">of</span>
        <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⇒</span> fw_upd' <span class="bound">m</span> <span class="bound">k</span> <span class="main">0</span> <span class="main">0</span> <span class="main">|</span>
        <span class="main">(</span>Suc <span class="bound">i</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">m'</span> <span class="main">←</span> <span class="bound">fw</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">;</span> fw_upd' <span class="bound">m'</span> <span class="bound">k</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">0</span><span class="main">}</span> <span class="main">|</span>
        <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Suc <span class="bound">j</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">m'</span> <span class="main">←</span> <span class="bound">fw</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">k</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">;</span> fw_upd' <span class="bound">m'</span> <span class="bound">k</span> <span class="bound">i</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span><span class="main">}</span>
    <span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FW_Code-fwi'_simps"><span class="command">lemma</span></span> fwi'_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fwi' <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="main">0</span>       <span class="main">0</span>        <span class="main">=</span> fw_upd' <span class="free">m</span> <span class="free">k</span> <span class="main">0</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"fwi' <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">0</span>        <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">m'</span> <span class="main">←</span> fwi' <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">n</span><span class="main">;</span> fw_upd' <span class="bound">m'</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"fwi' <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span>       <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>  <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">m'</span> <span class="main">←</span> fwi' <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span><span class="main">;</span> fw_upd' <span class="bound">m'</span> <span class="free">k</span> <span class="free">i</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fwi'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">refine_mono</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"fwi' <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> uncurry <span class="main">(</span>fwi <span class="main">(</span>curry <span class="free">m</span><span class="main">)</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"curry <span class="free">m</span>"</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fwi.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fw_upd'_def fw_upd_def upd_def fwi'_simps pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="FW_Code-fw_upd'_spec"><span class="command">lemma</span></span> fw_upd'_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fw_upd' <span class="free">M</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span> <span class="bound">M'</span><span class="main">.</span> <span class="bound">M'</span> <span class="main">=</span> uncurry <span class="main">(</span>fw_upd <span class="main">(</span>curry <span class="free">M</span><span class="main">)</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fw_upd'_def fw_upd_def upd_def pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1" id="FW_Code-for_rec2_fwi"><span class="command">lemma</span></span> for_rec2_fwi<span class="main">:</span>
  <span class="quoted"><span class="quoted">"for_rec2 <span class="main">(</span><span class="main">λ</span> <span class="bound">M</span><span class="main">.</span> fw_upd' <span class="bound">M</span> <span class="free">k</span><span class="main">)</span> <span class="free">M</span> <span class="free">n</span> <span class="free">i</span> <span class="free">j</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span> <span class="bound">M'</span><span class="main">.</span> <span class="bound">M'</span> <span class="main">=</span> uncurry <span class="main">(</span>fwi <span class="main">(</span>curry <span class="free">M</span><span class="main">)</span> <span class="free">n</span> <span class="free">k</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> fw_upd'_spec
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">M</span><span class="main">.</span> fw_upd' <span class="main">(</span><span class="bound">M</span> <span class="main">::</span> <span class="main">(</span>nat <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> for_rec2.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fw'</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linordered_ab_monoid_add<span class="main">)</span> mtx <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> mtx nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fw'</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> nfoldli <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span> <span class="bound">M</span><span class="main">.</span> for_rec2 <span class="main">(</span><span class="main">λ</span> <span class="bound">M</span><span class="main">.</span> fw_upd' <span class="bound">M</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">M</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1" id="FW_Code-fw'_spec"><span class="command">lemma</span></span> fw'_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fw' <span class="free">m</span> <span class="free">n</span> <span class="free">k</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span> <span class="bound">M'</span><span class="main">.</span> <span class="bound">M'</span> <span class="main">=</span> uncurry <span class="main">(</span>fw <span class="main">(</span>curry <span class="free">m</span><span class="main">)</span> <span class="free">n</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fw'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> for_rec2_fwi <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> curry_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">dummy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>linordered_ab_monoid_add<span class="main">,</span>zero<span class="main">,</span>heap<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_import_param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(+)</span><span class="main">,</span><span class="main">(+)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id <span class="main">→</span> Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_import_param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>min<span class="main">,</span>min<span class="main">::</span><span class="tfree">'a</span><span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id <span class="main">→</span> Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">node_assn</span> <span class="main">≡</span> nat_assn"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mtx_assn</span> <span class="main">≡</span> asmtx_assn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> id_assn<span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> mtx <span class="main">⇒</span><span class="main">_</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">fw_upd_impl</span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"uncurry2 <span class="main">(</span>uncurry fw_upd'<span class="main">)</span>"</span></span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">n</span><span class="keyword1">]<span class="hidden">⇩</span><sub>a</sub></span> mtx_assn<span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span> node_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span> node_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span> node_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span>
  <span class="main">→</span> mtx_assn"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fw_upd'_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> fw_upd_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">fw_upd'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> i_mtx <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> i_mtx nres"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fwi_impl'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> mtx<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> for_rec2 <span class="main">(</span><span class="main">λ</span> <span class="bound">M</span><span class="main">.</span> fw_upd' <span class="bound">M</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free">n</span> <span class="free">n</span> <span class="free">n</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fw_impl'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> mtx<span class="main">)</span> <span class="main">=</span> fw' <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free">n</span> <span class="free">n</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">id_rules</span><span class="main">]</span> <span class="main">=</span> itypeI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TYPE</span> <span class="main">(</span>nat<span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">sepref_import_param</span><span class="main">]</span> <span class="main">=</span> IdI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">fw_impl</span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"fw_impl'"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"mtx_assn<span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> mtx_assn"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fw_impl'_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> fw'_def for_rec2_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">fwi_impl</span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"uncurry fwi_impl'"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">λ</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span><span class="keyword1">]<span class="hidden">⇩</span><sub>a</sub></span> mtx_assn<span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span> node_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="main">→</span> mtx_assn"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fwi_impl'_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> for_rec2_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* End of sepref setup *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* End of n *)</span>


<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">fw_impl</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML_imp

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A compact specification for the characteristic property of the \fw.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fw_spec</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fw_spec</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> SPEC <span class="main">(</span><span class="main">λ</span> <span class="bound">M'</span><span class="main">.</span>
    <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="bound">M'</span> <span class="bound">i</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>
    <span class="keyword1">then</span> <span class="main">¬</span> cyc_free <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>
    <span class="keyword1">else</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="bound">M'</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">=</span> D <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">i</span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> cyc_free <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FW_Code-D_diag_nonnegI"><span class="command">lemma</span></span> D_diag_nonnegI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cycle_free <span class="free">M</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"D <span class="free">M</span> <span class="free">i</span> <span class="free">i</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms D_dest''<span class="main">[</span><span class="operator">OF</span> refl<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> cycle_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FW_Code-fw_fw_spec"><span class="command">lemma</span></span> fw_fw_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span>FW <span class="free">M</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> fw_spec <span class="free">n</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fw_spec_def cycle_free_diag_equiv
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> fw_shortest_path<span class="main">[</span><span class="operator">unfolded</span> cycle_free_diag_equiv<span class="main">,</span> <span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> D_diag_nonnegI <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> FW_neg_cycle_detect<span class="main">[</span><span class="operator">unfolded</span> cycle_free_diag_equiv<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fw_shortest_path<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> cycle_free_diag_equiv<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> FW_neg_cycle_detect<span class="main">[</span><span class="operator">unfolded</span> cycle_free_diag_equiv<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mat_curry_rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">Mu</span><span class="main">,</span> <span class="bound">Mc</span><span class="main">)</span><span class="main">.</span> curry <span class="bound">Mu</span> <span class="main">=</span> <span class="bound">Mc</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mtx_curry_assn</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> hr_comp <span class="main">(</span>mtx_assn <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>br curry <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> mtx_curry_assn_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">fcomp_norm_unfold</span><span class="main">]</span>

<span class="keyword1" id="FW_Code-fw_impl'_correct"><span class="command">lemma</span></span> fw_impl'_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fw_impl'<span class="main">,</span> fw_spec<span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> br curry <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span>br curry <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span><span class="main">⟩</span> nres_rel"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fw_impl'_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> fw'_spec fw_fw_spec
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nres_relI<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Main Result›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is one way to state that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fw_impl›</span></span></span></span> fulfills the specification <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fw_spec›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> fw_impl_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fw_impl <span class="free">n</span><span class="main">,</span> fw_spec <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>mtx_curry_assn <span class="free">n</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> mtx_curry_assn <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> fw_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> fw_impl'_correct<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> fun_relD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> IdI<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An alternative version: a Hoare triple for total correctness.›</span></span>
<span class="keyword1"><span class="command">corollary</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>mtx_curry_assn <span class="free">n</span> <span class="free">M</span> <span class="free">Mi</span><span class="main">&gt;</span> fw_impl <span class="free">n</span> <span class="free">Mi</span> <span class="main">&lt;</span><span class="main">λ</span> <span class="bound">Mi'</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span> <span class="bound">M'</span><span class="main">.</span> mtx_curry_assn <span class="free">n</span> <span class="bound">M'</span> <span class="bound">Mi'</span> <span class="main">*</span> <span class="main">↑</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> <span class="bound">M'</span> <span class="bound">i</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>
    <span class="keyword1">then</span> <span class="main">¬</span> cyc_free <span class="free">M</span> <span class="free">n</span>
    <span class="keyword1">else</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> <span class="bound">M'</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">=</span> D <span class="free">M</span> <span class="bound">i</span> <span class="bound">j</span> <span class="free">n</span> <span class="main">∧</span> cyc_free <span class="free">M</span> <span class="free">n</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cycle_free_diag_equiv
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cons_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ fw_impl_correct<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">THEN</span> hfrefD<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">THEN</span> hn_refineD<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fw_spec_def<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> cycle_free_diag_equiv<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Alternative Versions for Uncurried Matrices.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">FWI'</span> <span class="main">=</span> uncurry <span class="keyword1">ooo</span> FWI <span class="keyword1">o</span> curry"</span></span>

<span class="keyword1" id="FW_Code-fwi_impl'_refine_FWI'"><span class="command">lemma</span></span> fwi_impl'_refine_FWI'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fwi_impl' <span class="free">n</span><span class="main">,</span> RETURN <span class="keyword1">oo</span> PR_CONST <span class="main">(</span><span class="main">λ</span> <span class="bound">M</span><span class="main">.</span> FWI' <span class="bound">M</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fwi_impl'_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> FWI_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> FWI'_def <span class="keyword1"><span class="command">using</span></span> for_rec2_fwi
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff pw_nres_rel_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> fwi_impl_refine_FWI' <span class="main">=</span> fwi_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> fwi_impl'_refine_FWI'<span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">FW'</span> <span class="main">=</span> uncurry <span class="keyword1">oo</span> FW <span class="keyword1">o</span> curry"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">FW''</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> FW' <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1" id="FW_Code-fw_impl'_refine_FW''"><span class="command">lemma</span></span> fw_impl'_refine_FW''<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fw_impl' <span class="free">n</span><span class="main">,</span> RETURN <span class="keyword1">o</span> PR_CONST <span class="main">(</span>FW'' <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fw_impl'_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> FW''_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> FW'_def <span class="keyword1"><span class="command">using</span></span> fw'_spec
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff pw_nres_rel_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> fw_impl_refine_FW'' <span class="main">=</span> fw_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> fw_impl'_refine_FW''<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>