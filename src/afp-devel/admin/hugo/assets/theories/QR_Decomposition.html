<div id="Miscellaneous_QR">
<div class="head">
<h1>Theory Miscellaneous_QR</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Title:      Miscellaneous_QR.thy
    Author:     Jose Divasón &lt;jose.divasonm at unirioja.es&gt;
    Author:     Jesús Aransay &lt;jesus-maria.aransay at unirioja.es&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Miscellaneous file for the QR algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Miscellaneous_QR
<span class="keyword2"><span class="keyword">imports</span></span>
 <a href="../../gauss_jordan/theories/#Examples_Gauss_Jordan_Abstract">Gauss_Jordan.Examples_Gauss_Jordan_Abstract</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹These two lemmas maybe should be in the file <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Code_Matrix.thy›</span></span></span></span> of the Gauss-Jordan
  development.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vec_nth <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="main">%</span><span class="bound">i</span><span class="main">.</span> <span class="free">a</span><span class="main">$</span><span class="bound">i</span> <span class="main">-</span> <span class="free">b</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vector_minus_component<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vec_nth <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">x</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This lemma maybe should be in the file <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Mod_Type.thy›</span></span></span></span> of the Gauss-Jordan
  development.›</span></span>

<span class="keyword1" id="Miscellaneous_QR-from_nat_le"><span class="command">lemma</span></span> from_nat_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="free">i</span><span class="main">&lt;</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> from_nat_mono from_nat_to_nat_id i k<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Some properties about orthogonal matrices.›</span></span>

<span class="keyword1" id="Miscellaneous_QR-orthogonal_mult"><span class="command">lemma</span></span> orthogonal_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="main">(</span><span class="free">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Miscellaneous_QR-orthogonal_matrix_is_orthogonal"><span class="command">lemma</span></span> orthogonal_matrix_is_orthogonal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"orthogonal_matrix <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pairwise orthogonal <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> pairwise_def columns_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> 
  <span class="keyword3"><span class="command">assume</span></span> column_i_not_j<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="free">A</span> <span class="main">≠</span> column <span class="skolem">j</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> i_not_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="main">(</span>mat <span class="main">1</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i_not_j mat_1_fun<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> o <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_matrix <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> row <span class="skolem">i</span> <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span> <span class="main">∙</span> column <span class="skolem">j</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> matrix_matrix_mult_inner_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> column <span class="skolem">i</span> <span class="free">A</span> <span class="main">∙</span> column <span class="skolem">j</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> row_transpose <span class="keyword1"><span class="command">..</span></span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="main">(</span>column <span class="skolem">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>column <span class="skolem">j</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_def <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Miscellaneous_QR-orthogonal_matrix_norm"><span class="command">lemma</span></span> orthogonal_matrix_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"orthogonal_matrix <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>column <span class="free">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> o <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_matrix <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_1_fun<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>column <span class="free">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>column <span class="free">i</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> matrix_matrix_mult_inner_mult row_transpose <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>column <span class="free">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> norm_eq_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Miscellaneous_QR-orthogonal_matrix_card"><span class="command">lemma</span></span> orthogonal_matrix_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"orthogonal_matrix <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> card_not_ncols<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">≠</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> column <span class="bound">i</span> <span class="free">A</span> <span class="main">=</span> column <span class="bound">j</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">i</span><span class="main">≠</span><span class="bound">j</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> col_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> column <span class="bound">i</span> <span class="free">A</span> <span class="main">=</span> column <span class="bound">j</span> <span class="free">A</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'n</span> set<span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_same_card<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> column <span class="bound"><span class="bound"><span class="bound">i</span></span></span> <span class="free"><span class="free"><span class="free">A</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betw_def columns_def inj_on_def col_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> card_not_ncols <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> col_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="free">A</span> <span class="main">=</span> column <span class="skolem">j</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i_not_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="main">(</span>mat <span class="main">1</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mat_1_fun i_not_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> o <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_matrix <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> column <span class="skolem">i</span> <span class="free">A</span> <span class="main">∙</span> column <span class="skolem">j</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> matrix_matrix_mult_inner_mult row_transpose <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> calculation col_eq mat_1_fun matrix_matrix_mult_inner_mult 
      o orthogonal_matrix zero_neq_one<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Miscellaneous_QR-orthogonal_matrix_intro"><span class="command">lemma</span></span> orthogonal_matrix_intro<span class="main">:</span>        
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pairwise orthogonal <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> norm <span class="main">(</span>column <span class="bound">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span> <span class="comment1">(*We need that premise to avoid the case that column i A = column j A when i ≠ j*)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orthogonal_matrix <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> orthogonal_matrix vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> mat_1_fun<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ia</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">=</span> column <span class="skolem">ia</span> <span class="free">A</span> <span class="main">∙</span> column <span class="skolem">ia</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_matrix_mult_inner_mult <span class="keyword1"><span class="command">unfolding</span></span> row_transpose <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n norm_eq_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> i_not_ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">ia</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> column_i_not_ia<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="free">A</span> <span class="main">≠</span> column <span class="skolem">ia</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> col_i_ia<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="free">A</span> <span class="main">=</span> column <span class="skolem">ia</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> column <span class="bound">i</span> <span class="free">A</span><span class="main">)</span><span class="main">`</span> <span class="main">(</span>UNIV<span class="main">-</span><span class="main">{</span><span class="skolem">ia</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≠</span><span class="skolem">ia</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≠</span><span class="skolem">ia</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_same_card<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">id</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> bij_betw_def columns_def<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> col_i_ia i_not_ia<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> column <span class="bound">i</span> <span class="free">A</span><span class="main">)</span><span class="main">`</span> <span class="main">(</span>UNIV<span class="main">-</span><span class="main">{</span><span class="skolem">ia</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rw <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="skolem">ia</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_image_le finite_code<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span> <span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> oia<span class="main">:</span> <span class="quoted"><span class="quoted">"orthogonal <span class="main">(</span>column <span class="skolem">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>column <span class="skolem">ia</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">=</span> column <span class="skolem">i</span> <span class="free">A</span> <span class="main">∙</span> column <span class="skolem">ia</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_matrix_mult_inner_mult <span class="keyword1"><span class="command">unfolding</span></span> row_transpose <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> oia <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Miscellaneous_QR-orthogonal_matrix2"><span class="command">lemma</span></span> orthogonal_matrix2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orthogonal_matrix <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>pairwise orthogonal <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> norm <span class="main">(</span>column <span class="bound">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span>card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> orthogonal_matrix_intro<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> 
    orthogonal_matrix_is_orthogonal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    orthogonal_matrix_norm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    orthogonal_matrix_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Miscellaneous_QR-orthogonal_matrix'"><span class="command">lemma</span></span> orthogonal_matrix'<span class="main">:</span> <span class="quoted"><span class="quoted">"orthogonal_matrix <span class="main">(</span><span class="free">Q</span><span class="main">::</span> real <span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">⟷</span>  <span class="free">Q</span> <span class="main">**</span> transpose <span class="free">Q</span><span class="main">=</span> mat <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> matrix_left_right_inverse orthogonal_matrix_def<span class="main">)</span>

<span class="keyword1" id="Miscellaneous_QR-orthogonal_matrix_intro2"><span class="command">lemma</span></span> orthogonal_matrix_intro2<span class="main">:</span>        
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pairwise orthogonal <span class="main">(</span>rows <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> norm <span class="main">(</span>row <span class="bound">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>rows <span class="free">A</span><span class="main">)</span> <span class="main">=</span> nrows <span class="free">A</span>"</span></span> <span class="comment1">(*We need that premise to avoid the case that row i A = row j A when i ≠ j*)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orthogonal_matrix <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> orthogonal_matrix' vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> mat_1_fun<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ia</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">**</span> transpose <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">=</span> row <span class="skolem">ia</span> <span class="free">A</span> <span class="main">∙</span> row <span class="skolem">ia</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_matrix_mult_inner_mult <span class="keyword1"><span class="command">unfolding</span></span> column_transpose <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n norm_eq_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">**</span> transpose <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> i_not_ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">ia</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> row_i_not_ia<span class="main">:</span> <span class="quoted"><span class="quoted">"row <span class="skolem">i</span> <span class="free">A</span> <span class="main">≠</span> row <span class="skolem">ia</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> row_i_ia<span class="main">:</span><span class="quoted"><span class="quoted">"row <span class="skolem">i</span> <span class="free">A</span> <span class="main">=</span> row <span class="skolem">ia</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> row <span class="bound">i</span> <span class="free">A</span><span class="main">)</span><span class="main">`</span> <span class="main">(</span>UNIV<span class="main">-</span><span class="main">{</span><span class="skolem">ia</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>row <span class="bound">i</span> <span class="free">A</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≠</span><span class="skolem">ia</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rows_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>rows <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="main">{</span>row <span class="bound">i</span> <span class="free">A</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≠</span><span class="skolem">ia</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_same_card<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">id</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> bij_betw_def rows_def<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> row_i_ia i_not_ia<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> row <span class="bound">i</span> <span class="free">A</span><span class="main">)</span><span class="main">`</span> <span class="main">(</span>UNIV<span class="main">-</span><span class="main">{</span><span class="skolem">ia</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rw <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="skolem">ia</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_image_le finite_code<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span> <span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">unfolding</span></span> nrows_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> oia<span class="main">:</span> <span class="quoted"><span class="quoted">"orthogonal <span class="main">(</span>row <span class="skolem">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>row <span class="skolem">ia</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def <span class="keyword1"><span class="command">unfolding</span></span> rows_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">**</span> transpose <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">=</span> row <span class="skolem">i</span> <span class="free">A</span> <span class="main">∙</span> row <span class="skolem">ia</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_matrix_mult_inner_mult <span class="keyword1"><span class="command">unfolding</span></span> column_transpose <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> oia <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">**</span> transpose <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Miscellaneous_QR-is_basis_imp_full_rank"><span class="command">lemma</span></span> is_basis_imp_full_rank<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>field<span class="main">}</span><span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"is_basis <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> col_rank <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rank_col_rank <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec.dim <span class="main">(</span>col_space <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> col_rank_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b col_space_def independent_is_basis vec.dim_eq_card_independent vec.dim_span<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Miscellaneous_QR-card_columns_le_ncols"><span class="command">lemma</span></span> card_columns_le_ncols<span class="main">:</span>
  <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> ncols <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> columns_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"columns <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> column <span class="bound">i</span> <span class="free">A</span><span class="main">)</span><span class="main">`</span> UNIV"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> columns_rw ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_image_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Miscellaneous_QR-full_rank_imp_is_basis"><span class="command">lemma</span></span> full_rank_imp_is_basis<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>field<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_basis <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> is_basis_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> col_rank <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rank_col_rank <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec.dim <span class="main">(</span>col_space <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> col_rank_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> antisym_conv calculation card_columns_le_ncols col_space_def
        finite_columns r vec.dim_le_card vec.dim_span vec.span_superset<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> c_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> * vec.card_eq_dim_span_indep col_rank_def 
      col_space_def finite_columns rank_col_rank<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"vec.span <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> independent_is_basis<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"columns <span class="free">A</span>"</span></span><span class="main">]</span> c_eq <span class="keyword1"><span class="command">unfolding</span></span> is_basis_def ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Miscellaneous_QR-full_rank_imp_is_basis2"><span class="command">lemma</span></span> full_rank_imp_is_basis2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>field<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> vec.span <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> col_space <span class="free">A</span> 
        <span class="main">∧</span> card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> col_rank <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rank_col_rank <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec.dim <span class="main">(</span>col_space <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> col_rank_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> antisym_conv calculation card_columns_le_ncols col_space_def
        finite_columns r vec.dim_le_card vec.dim_span vec.span_superset<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> * vec.card_eq_dim_span_indep
      col_rank_def col_space_def finite_columns rank_col_rank<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec.span <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> col_space <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> col_space_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> full_rank_eq_is_basis<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>field<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>is_basis <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> full_rank_imp_is_basis is_basis_imp_full_rank <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Miscellaneous_QR-full_col_rank_imp_independent_columns"><span class="command">lemma</span></span> full_col_rank_imp_independent_columns<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>field<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms full_rank_imp_is_basis2<span class="main">)</span>


<span class="keyword1" id="Miscellaneous_QR-matrix_vector_right_distrib_minus"><span class="command">lemma</span></span> matrix_vector_right_distrib_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>ring_1<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_minus_eq_add minus_minus<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> matrix_vector_right_distrib <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">c</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> add.commute add_minus_cancel
        matrix_vector_right_distrib uminus_add_conv_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Miscellaneous_QR-inv_matrix_vector_mul_left"><span class="command">lemma</span></span> inv_matrix_vector_mul_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">=</span><span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i invertible_def matrix_vector_mul_assoc matrix_vector_mul_lid<span class="main">)</span>

<span class="keyword1" id="Miscellaneous_QR-norm_mult_vec"><span class="command">lemma</span></span> norm_mult_vec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>real<span class="main">,</span><span class="tfree">'b</span><span class="main">::</span>finite<span class="main">)</span> vec"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">x</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> norm <span class="free">x</span> <span class="main">*</span> norm <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inner_real_def norm_cauchy_schwarz_eq norm_mult<span class="main">)</span>

<span class="keyword1" id="Miscellaneous_QR-norm_equivalence"><span class="command">lemma</span></span> norm_equivalence<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"transpose <span class="free">A</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="keyword1">v*</span> <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> transpose_transpose transpose_vector<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> eq_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">v*</span> <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> that dot_lmul_matrix inner_eq_zero_iff inner_zero_left mult_not_zero transpose_vector<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> norm <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="keyword1">v*</span> <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> norm <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> norm <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_0 that dot_lmul_matrix eq inner_zero_right norm_zero<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> norm <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm_mult_vec<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">]</span> power2_eq_square <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Miscellaneous_QR-invertible_transpose_mult"><span class="command">lemma</span></span> invertible_transpose_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invertible <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> null_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"null_space <span class="free">A</span> <span class="main">=</span> null_space <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> null_space <span class="free">A</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> null_space <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">unfolding</span></span> null_space_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> full_types<span class="main"><span class="main">)</span></span> matrix_vector_mul_assoc matrix_vector_mult_0_right mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> null_space <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> null_space <span class="free">A</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_solution_def matrix_vector_mul_assoc mem_Collect_eq 
        norm_equivalence null_space_eq_solution_set solution_set_def x<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> vec.dim <span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span>real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">)</span> set<span class="main">)</span> <span class="main">-</span> vec.dim <span class="main">(</span>null_space <span class="free">A</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> rank_nullity_theorem_matrices<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rank_eq_dim_col_space'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> add.commute diff_add_inverse2 ncols_def vec_dim_card<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec.dim <span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span>real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">)</span> set<span class="main">)</span> <span class="main">-</span> vec.dim <span class="main">(</span>null_space <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> null_eq <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> rank <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute diff_add_inverse2 ncols_def rank_eq_dim_col_space
        rank_nullity_theorem_matrices vec_dim_card<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> r_A<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> rank <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> full_rank_implies_invertible r <span class="keyword1"><span class="command">unfolding</span></span> ncols_def nrows_def r_A <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Miscellaneous_QR-matrix_inv_mult"><span class="command">lemma</span></span> matrix_inv_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_1<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_1<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invertible <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"invertible <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_inv <span class="main">(</span><span class="free">A</span> <span class="main">**</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> matrix_inv <span class="free">B</span> <span class="main">**</span> matrix_inv <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> matrix_inv_unique<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span><span class="main"><span class="main">**</span></span><span class="free"><span class="free">B</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">**</span> <span class="free">B</span> <span class="main">**</span> <span class="main">(</span>matrix_inv <span class="free">B</span> <span class="main">**</span> matrix_inv <span class="free">A</span><span class="main">)</span> <span class="main">=</span> mat <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> matrix_inv_right matrix_mul_assoc matrix_mul_lid<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" matrix_inv <span class="free">B</span> <span class="main">**</span> matrix_inv <span class="free">A</span> <span class="main">**</span> <span class="main">(</span><span class="free">A</span> <span class="main">**</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> mat <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> matrix_inv_left matrix_mul_assoc matrix_mul_lid<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Miscellaneous_QR-invertible_transpose"><span class="command">lemma</span></span> invertible_transpose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>field<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invertible <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invertible <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invertible_det_nz assms det_transpose<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following lemmas are generalizations of some parts of the library. They should be 
  in the file <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Generalizations.thy›</span></span></span></span> of the Gauss-Jordan AFP entry.›</span></span>

<span class="keyword1"><span class="command">context</span></span> vector_space
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Miscellaneous_QR-span_eq"><span class="command">lemma</span></span> span_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>span <span class="free">S</span> <span class="main">=</span> span <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="main">⊆</span> span <span class="free">T</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">⊆</span> span <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> span_superset<span class="main">[</span><span class="operator">unfolded</span> subset_eq<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> span_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="quoted">"span <span class="free">S</span>"</span></span><span class="main">]</span> span_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="quoted">"span <span class="free">T</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> span_span<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Miscellaneous_QR-basis_orthogonal"><span class="command">lemma</span></span> basis_orthogonal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>real_inner set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fB<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C</span><span class="main">.</span> finite <span class="bound">C</span> <span class="main">∧</span> card <span class="bound">C</span> <span class="main">≤</span> card <span class="free">B</span> <span class="main">∧</span> span <span class="bound">C</span>
        <span class="main">=</span> span <span class="free">B</span> <span class="main">∧</span> pairwise orthogonal <span class="bound">C</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">" <span class="main">∃</span><span class="bound">C</span><span class="main">.</span> <span class="var">?P</span> <span class="free">B</span> <span class="bound">C</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> fB
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pairwise_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">B</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> fB <span class="main">=</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> aB <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> <span class="skolem">B</span>›</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">C</span><span class="main">.</span> finite <span class="bound">C</span> <span class="main">∧</span> card <span class="bound">C</span> <span class="main">≤</span> card <span class="skolem">B</span> <span class="main">∧</span> span <span class="bound">C</span> <span class="main">=</span> span <span class="skolem">B</span> <span class="main">∧</span> pairwise orthogonal <span class="bound">C</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">C</span> <span class="main">≤</span> card <span class="skolem">B</span>"</span></span>
    <span class="quoted"><span class="quoted">"span <span class="skolem">C</span> <span class="main">=</span> span <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">-</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="skolem">a</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">C</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="var">?a</span> <span class="skolem">C</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> C<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> fC<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> fB aB C<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> cC<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?C</span> <span class="main">≤</span> card <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_insert_if<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">have</span></span> th0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">a</span> <span class="main">-</span> <span class="main">(</span><span class="bound">b</span> <span class="main">-</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="bound">c</span> <span class="main">+</span> <span class="main">(</span><span class="bound">a</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">-</span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">a</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">C</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="skolem">a</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> span <span class="skolem">C</span>
      <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">-</span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">a</span> <span class="main">∈</span> span <span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> scaleR_right_diff_distrib th0<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> span_add_eq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> span_mul<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> span_sum<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> span_mul<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> span_base<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> SC<span class="main">:</span> <span class="quoted"><span class="quoted">"span <span class="var">?C</span> <span class="main">=</span> span <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_eq_iff span_breakdown_eq C<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> yC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Cy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> insert <span class="skolem">y</span> <span class="main">(</span><span class="skolem">C</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> fth<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">C</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="var">?a</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_def
      <span class="keyword1"><span class="command">unfolding</span></span> inner_diff inner_sum_left right_minus_eq
      <span class="keyword1"><span class="command">unfolding</span></span> sum.remove <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">C</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inner_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> C<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> pairwise_def orthogonal_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹pairwise orthogonal <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> CPO<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pairwise_orthogonal_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fC cC SC CPO <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">B</span><span class="main">)</span> <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Miscellaneous_QR-op_vec_scaleR"><span class="command">lemma</span></span> op_vec_scaleR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(*s)</span> <span class="main">=</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scalar_mult_eq_scaleR<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Projections">
<div class="head">
<h1>Theory Projections</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Title:      Projections.thy
    Author:     Jose Divasón &lt;jose.divasonm at unirioja.es&gt;
    Author:     Jesús Aransay &lt;jesus-maria.aransay at unirioja.es&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Projections›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Projections
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="#Miscellaneous_QR">Miscellaneous_QR</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Definitions of vector projection and projection of a vector onto a set.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">proj</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">/</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">proj_onto</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span>sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> proj <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Properties›</span></span>

<span class="keyword1" id="Projections-proj_onto_sum_rw"><span class="command">lemma</span></span> proj_onto_sum_rw<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="free">v</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">v</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inner_commute<span class="main">)</span>

<span class="keyword1" id="Projections-vector_sub_project_orthogonal_proj"><span class="command">lemma</span></span> vector_sub_project_orthogonal_proj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inner <span class="free">b</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> proj <span class="free">x</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vector_sub_project_orthogonal
  <span class="keyword1"><span class="command">unfolding</span></span> proj_def inner_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Projections-orthogonal_proj_set"><span class="command">lemma</span></span> orthogonal_proj_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> yC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="main">(</span><span class="free">a</span> <span class="main">-</span> proj_onto <span class="free">a</span> <span class="free">C</span><span class="main">)</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> Cy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> insert <span class="free">y</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> yC
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> fth<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="main">(</span><span class="free">a</span> <span class="main">-</span> proj_onto <span class="free">a</span> <span class="free">C</span><span class="main">)</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_def <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def <span class="keyword1"><span class="command">unfolding</span></span> proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> inner_diff
    <span class="keyword1"><span class="command">unfolding</span></span> inner_sum_left 
    <span class="keyword1"><span class="command">unfolding</span></span> right_minus_eq
    <span class="keyword1"><span class="command">unfolding</span></span> sum.remove<span class="main">[</span><span class="operator">OF</span> C yC<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inner_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> p<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> pairwise_def orthogonal_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> yC <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Projections-pairwise_orthogonal_proj_set"><span class="command">lemma</span></span> pairwise_orthogonal_proj_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="main">(</span>insert <span class="main">(</span><span class="free">a</span> <span class="main">-</span> proj_onto <span class="free">a</span> <span class="free">C</span><span class="main">)</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pairwise_orthogonal_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orthogonal_proj_set C p<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Orthogonal Complement›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">orthogonal_complement</span> <span class="free"><span class="bound"><span class="entity">W</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">W</span></span></span><span class="main">.</span> orthogonal <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Projections-in_orthogonal_complement_imp_orthogonal"><span class="command">lemma</span></span> in_orthogonal_complement_imp_orthogonal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="free">x</span> <span class="free">y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms orthogonal_commute 
  <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_complement_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Projections-subspace_orthogonal_complement"><span class="command">lemma</span></span> subspace_orthogonal_complement<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="main">(</span>orthogonal_complement <span class="free">W</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subspace_def orthogonal_complement_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orthogonal_def inner_left_distrib<span class="main">)</span>

<span class="keyword1" id="Projections-orthogonal_complement_mono"><span class="command">lemma</span></span> orthogonal_complement_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_in_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orthogonal_complement <span class="free">B</span> <span class="main">⊆</span> orthogonal_complement <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> orthogonal_complement <span class="free">B</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> orthogonal_complement <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_complement_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orthogonal_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> A_in_B in_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Projections-B_in_orthogonal_complement_of_orthogonal_complement"><span class="command">lemma</span></span> B_in_orthogonal_complement_of_orthogonal_complement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> orthogonal_complement <span class="main">(</span>orthogonal_complement <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orthogonal_complement_def orthogonal_def inner_commute<span class="main">)</span>


<span class="keyword1" id="Projections-phytagorean_theorem_norm"><span class="command">lemma</span></span> phytagorean_theorem_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"orthogonal <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">=</span>norm <span class="free">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> norm <span class="free">y</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> power2_norm_eq_inner <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inner_right_distrib <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">∙</span> <span class="free">y</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">y</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">y</span> <span class="main">∙</span> <span class="free">y</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> real_inner_class.inner_add_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">y</span> <span class="main">∙</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> o <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> monoid_add_class.add.right_neutral inner_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> norm <span class="free">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> norm <span class="free">y</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> power2_norm_eq_inner <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Projections-in_orthogonal_complement_basis"><span class="command">lemma</span></span> in_orthogonal_complement_basis<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>euclidean_space<span class="main">}</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ind_B<span class="main">:</span> <span class="quoted"><span class="quoted">"independent <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> span_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> span <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> orthogonal <span class="bound">a</span> <span class="free">v</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> orthogonal_complement_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> orthogonal <span class="free">v</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>  
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="skolem">a</span> <span class="free">v</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> B orthogonal_commute rev_subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> orthogonal <span class="bound">a</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> finite_B<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> independent_bound_general<span class="main">[</span><span class="operator">OF</span> ind_B<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> span_B_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> span <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B S span_B span_subspace <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> span_finite<span class="main">[</span><span class="operator">OF</span> finite_B<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">unfolding</span></span> span_B_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">v</span> <span class="main">∙</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="free">v</span> <span class="main">∙</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inner_sum_right <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">v</span> <span class="main">∙</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inner_scaleR_right <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum.neutral o <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orthogonal_def inner_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="free">v</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹See <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">url</span></span> "https://people.math.osu.edu/husen.1/teaching/571/least_squares.pdf"<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Part 1 of the Theorem 1.7 in the previous website, but the proof has been carried out
  in other way.›</span></span>

<span class="keyword1" id="Projections-v_minus_p_orthogonal_complement"><span class="command">lemma</span></span> v_minus_p_orthogonal_complement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>euclidean_space<span class="main">}</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subspace_S<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ind_X<span class="main">:</span> <span class="quoted"><span class="quoted">"independent <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> span_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> span <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">-</span> proj_onto <span class="free">v</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> in_orthogonal_complement_basis<span class="main">[</span><span class="operator">OF</span> subspace_S ind_X X span_X<span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"proj_onto <span class="free">v</span> <span class="free">X</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="skolem">a</span> <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">-</span><span class="var">?p</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orthogonal_proj_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a _ o<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> independent_bound_general<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ind_X<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Part 2 of the Theorem 1.7 in the previous website.›</span></span>

<span class="keyword1" id="Projections-UNIV_orthogonal_complement_decomposition"><span class="command">lemma</span></span> UNIV_orthogonal_complement_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>euclidean_space<span class="main">}</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">=</span> <span class="free">S</span> <span class="main">+</span> <span class="main">(</span>orthogonal_complement <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> set_plus_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> ind_X<span class="main">:</span> <span class="quoted"><span class="quoted">"independent <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> span_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> span <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl orthonormal_basis_subspace s<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> finite_X<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> independent_bound_general ind_X<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"proj_onto <span class="skolem">v</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">=</span><span class="var">?p</span> <span class="main">+</span><span class="main">(</span><span class="skolem">v</span><span class="main">-</span><span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subspace_sum<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> X s rev_subsetD subspace_mul<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">-</span><span class="var">?p</span><span class="main">)</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> v_minus_p_orthogonal_complement<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s ind_X X span_X o<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span><span class="main">∈</span>orthogonal_complement <span class="free">S</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Normalization of vectors›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">normalize</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">normalize</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">/</span>norm <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">normalize_set_of_vec</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">normalize_set_of_vec</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>  <span class="main">=</span> normalize<span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1" id="Projections-norm_normalize"><span class="command">lemma</span></span> norm_normalize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>normalize <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_def assms<span class="main">)</span>

<span class="keyword1" id="Projections-normalize_0"><span class="command">lemma</span></span> normalize_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>normalize <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> normalize_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Projections-norm_normalize_set_of_vec"><span class="command">lemma</span></span> norm_normalize_set_of_vec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> normalize_set_of_vec <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms norm_normalize normalize_0 <span class="keyword1"><span class="command">unfolding</span></span> normalize_set_of_vec_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Gram_Schmidt">
<div class="head">
<h1>Theory Gram_Schmidt</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Title:      Gram_Schmidt.thy
    Author:     Jose Divasón &lt;jose.divasonm at unirioja.es&gt;
    Author:     Jesús Aransay &lt;jesus-maria.aransay at unirioja.es&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹The Gram-Schmidt algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Gram_Schmidt
<span class="keyword2"><span class="keyword">imports</span></span>
 <a href="#Miscellaneous_QR">Miscellaneous_QR</a>
 <a href="#Projections">Projections</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Gram-Schmidt algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The algorithm is used to orthogonalise a set of vectors. The Gram-Schmidt process takes a set of vectors <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span>
and generates another orthogonal set that spans the same subspace as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span>.

We present three ways to compute the Gram-Schmidt algorithm.

\begin{enumerate}
\item The fist one has been developed thinking about the simplicity of its formalisation.
    Given a list of vectors, the output is another list of orthogonal vectors with the same span.
    Such a list is constructed following the Gram-Schmidt process presented in any book, but in 
    the reverse order (starting the process from the last element of the input list).

\item Based on previous formalization, another function has been defined
  to compute the process of the Gram-Schmidt algorithm in the natural order 
  (starting from the first element of the input list).

\item The third way has as input and output a matrix. The algorithm is applied to the columns of a
  matrix, obtaining a matrix whose columns are orthogonal and where the column space is kept. 
  This will be a previous step to compute the QR decomposition.
\end{enumerate}

Every function can be executed with arbitrary precision (using rational numbers).
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹First way›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Gram_Schmidt_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> list <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Gram_Schmidt_step</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">-</span> proj_onto <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Gram_Schmidt</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> foldr Gram_Schmidt_step <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt-Gram_Schmidt_cons"><span class="command">lemma</span></span> Gram_Schmidt_cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Gram_Schmidt <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Gram_Schmidt_step <span class="free">a</span> <span class="main">(</span>Gram_Schmidt <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt-basis_orthogonal'"><span class="command">lemma</span></span> basis_orthogonal'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>Gram_Schmidt <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="free">xs</span><span class="main">)</span> <span class="main">∧</span>
        span <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span>
        pairwise orthogonal <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_def pairwise_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>Gram_Schmidt <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>Gram_Schmidt <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∧</span>
    span <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> pairwise orthogonal <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>Gram_Schmidt <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_cons <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_step_def <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> span <span class="main">(</span>set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> pairwise orthogonal <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">have</span></span> set_rw1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">a</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> set_rw2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>Gram_Schmidt <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">=</span> <span class="main">(</span>insert <span class="main">(</span><span class="skolem">a</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>Gram_Schmidt <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_cons Gram_Schmidt_step_def proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> set <span class="main">(</span>Gram_Schmidt <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> finite_C<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>   
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">k</span>
        <span class="keyword1"><span class="command">have</span></span> th0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="main">(</span><span class="bound">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">a</span> <span class="main">-</span> <span class="main">(</span><span class="bound">b</span> <span class="main">-</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="bound">c</span> <span class="main">+</span> <span class="main">(</span><span class="bound">a</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">-</span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">a</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">C</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span>  <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> span <span class="skolem">C</span> 
          <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">-</span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">a</span> <span class="main">∈</span> span <span class="skolem">C</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> scaleR_right_diff_distrib th0<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> span_add_eq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> span_mul<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> span_sum<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> span_mul<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> span_base<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> set_eq_iff set_rw2 set_rw1 span_breakdown_eq C_def s<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> p <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pairwise_orthogonal_proj_set<span class="main">[</span><span class="operator">OF</span> finite_C<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> set_rw2 <span class="keyword1"><span class="command">unfolding</span></span> C_def proj_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> proj_onto_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt-card_Gram_Schmidt"><span class="command">lemma</span></span> card_Gram_Schmidt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card<span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>set <span class="main">(</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">xa</span><span class="main">∈</span>set <span class="main">(</span>Gram_Schmidt <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∙</span> <span class="bound">xa</span> <span class="main">/</span> <span class="main">(</span><span class="bound">xa</span> <span class="main">∙</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">xa</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> distinct_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">-</span> <span class="skolem">b</span> <span class="main">∉</span> set <span class="main">(</span>Gram_Schmidt <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>insert <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_cons Gram_Schmidt_step_def b_def 
      <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> card_insert_disjoint<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">-</span> <span class="skolem">b</span> <span class="main">∉</span> set <span class="main">(</span>Gram_Schmidt <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> Suc <span class="main">(</span>card <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps<span class="main">[</span><span class="operator">OF</span> distinct_xs<span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="main">(</span>remdups <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> List.card_set <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span>length <span class="main">(</span>remdups <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems distinct_xs impossible_Cons not_less_eq_eq remdups_id_iff_distinct<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span>card <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.refl length_remdups_card_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> x_b_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">-</span> <span class="skolem">b</span> <span class="main">∈</span> set <span class="main">(</span>Gram_Schmidt <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>insert <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_cons Gram_Schmidt_step_def b_def
      <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>card <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False insert_absorb<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span>card <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps<span class="main">[</span><span class="operator">OF</span> distinct_xs<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span>card <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> List.card_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt-orthogonal_basis_exists"><span class="command">lemma</span></span> orthogonal_basis_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">V</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real<span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"is_basis <span class="main">(</span>set <span class="free">V</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>set <span class="free">V</span><span class="main">)</span> <span class="main">⊆</span> vec.span <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">∧</span> <span class="main">(</span>card <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> vec.dim <span class="main">(</span>set <span class="free">V</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> pairwise orthogonal <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="free">V</span><span class="main">)</span> <span class="main">⊆</span> vec.span <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> basis_orthogonal'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">V</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> vec.span_superset<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span><span class="main"><span class="main">=</span></span><span class="quoted">real</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'b</span><span class="main"><span class="main">=</span></span><span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> span_vec_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> basis_orthogonal'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">V</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> vec.dim <span class="main">(</span>set <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> card_eq_dim<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="free">V</span><span class="main">)</span> <span class="main">=</span> vec.dim <span class="main">(</span>set <span class="free">V</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> B independent_is_basis vec.dim_span vec.indep_card_eq_dim_span<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec.dim <span class="main">(</span>set <span class="free">V</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>card <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">unfolding</span></span> is_basis_def
      <span class="keyword1"><span class="command">using</span></span> vec.independent_span_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">V</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> basis_orthogonal'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">V</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> local.card_eq_dim<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> vec.dim <span class="main">(</span>set <span class="free">V</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_Gram_Schmidt<span class="main">[</span><span class="operator">OF</span> d<span class="main">]</span> card_eq_dim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> vec.card_le_dim_spanning<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"UNIV<span class="main"><span class="main">::</span></span><span class="main"><span class="main">(</span></span>real<span class="main"><span class="main">^</span></span><span class="tfree"><span class="tfree">'b</span></span><span class="main"><span class="main">)</span></span> set"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span>real<span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">⊆</span> vec.span <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> basis_orthogonal'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">V</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">unfolding</span></span> is_basis_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> span_vec_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> vec.dim <span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span>real<span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> c top_greatest vec.dim_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">corollary</span></span> orthogonal_basis_exists'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">V</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real<span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"is_basis <span class="main">(</span>set <span class="free">V</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_basis <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">∧</span> distinct <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span> <span class="main">∧</span> pairwise orthogonal <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> B orthogonal_basis_exists basis_orthogonal' card_distinct d 
    vec.dim_unique distinct_card is_basis_def subset_refl
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> span_vec_eq<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Second way›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This definition applies the Gram Schmidt process starting from the first element of the list.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Gram_Schmidt2</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> Gram_Schmidt <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt-basis_orthogonal2"><span class="command">lemma</span></span> basis_orthogonal2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>Gram_Schmidt2 <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="free">xs</span><span class="main">)</span>
  <span class="main">∧</span> span <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt2 <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>
  <span class="main">∧</span> pairwise orthogonal <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt2 <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Gram_Schmidt2_def basis_orthogonal' length_rev set_rev<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt-card_Gram_Schmidt2"><span class="command">lemma</span></span> card_Gram_Schmidt2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card<span class="main">(</span>set <span class="main">(</span>Gram_Schmidt2 <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>set <span class="main">(</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Gram_Schmidt2_def assms card_Gram_Schmidt distinct_rev set_rev<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt-orthogonal_basis_exists2"><span class="command">lemma</span></span> orthogonal_basis_exists2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">V</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real<span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"is_basis <span class="main">(</span>set <span class="free">V</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt2 <span class="free">V</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>set <span class="free">V</span><span class="main">)</span> <span class="main">⊆</span> vec.span <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt2 <span class="free">V</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">∧</span> <span class="main">(</span>card <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt2 <span class="free">V</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> vec.dim <span class="main">(</span>set <span class="free">V</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> pairwise orthogonal <span class="main">(</span>set <span class="main">(</span>Gram_Schmidt2 <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Gram_Schmidt.orthogonal_basis_exists Gram_Schmidt2_def distinct_rev set_rev
      B basis_orthogonal2 d<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Third way›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following definitions applies the Gram Schmidt process in the columns of a given matrix.
  It is previous step to the computation of the QR decomposition.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Gram_Schmidt_column_k</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span> <span class="main">⇒</span> nat 
  <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span>"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Gram_Schmidt_column_k</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> 
  <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="main">=</span> from_nat <span class="free"><span class="bound"><span class="entity">k</span></span></span> 
  <span class="keyword1">then</span> <span class="main">(</span>column <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> <span class="main">(</span>proj_onto <span class="main">(</span>column <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">{</span>column <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> 
  <span class="keyword1">else</span> <span class="main">(</span>column <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Gram_Schmidt_upt_k</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> foldl Gram_Schmidt_column_k <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Gram_Schmidt_matrix</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> Gram_Schmidt_upt_k <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>ncols <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Some definitions and lemmas in order to get execution.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Gram_Schmidt_column_k_row</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> 
  vec_lambda<span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="main">=</span> from_nat <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> 
  <span class="main">(</span>column <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">b</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>column <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> 
  <span class="keyword1">else</span> <span class="main">(</span>column <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt-Gram_Schmidt_column_k_row_code"><span class="command">lemma</span></span> Gram_Schmidt_column_k_row_code<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"vec_nth <span class="main">(</span>Gram_Schmidt_column_k_row <span class="free">A</span> <span class="free">k</span> <span class="free">a</span><span class="main">)</span> 
  <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="main">=</span> from_nat <span class="free">k</span> 
  <span class="keyword1">then</span> <span class="main">(</span>column <span class="bound">b</span> <span class="free">A</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">b</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>column <span class="bound">b</span> <span class="free">A</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> 
  <span class="keyword1">else</span> <span class="main">(</span>column <span class="bound">b</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_row_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> vec_lambda_beta<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt-Gram_Schmidt_column_k_code"><span class="command">lemma</span></span> Gram_Schmidt_column_k_code<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"vec_nth <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> Gram_Schmidt_column_k_row <span class="free">A</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_def <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_row_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Proofs›</span></span>

<span class="keyword1" id="Gram_Schmidt-Gram_Schmidt_upt_k_suc"><span class="command">lemma</span></span> Gram_Schmidt_upt_k_suc<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_def 
    <span class="keyword1"><span class="command">unfolding</span></span> rw <span class="keyword1"><span class="command">unfolding</span></span> foldl_append <span class="keyword1"><span class="command">unfolding</span></span> foldl.simps <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt-column_Gram_Schmidt_upt_k_preserves"><span class="command">lemma</span></span> column_Gram_Schmidt_upt_k_preserves<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i_less_suc<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="free">i</span><span class="main">&lt;</span><span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> suc_less_card<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">k</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span> <span class="main">(</span><span class="tfree">'cols</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_suc <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_def
    column_def <span class="keyword1"><span class="command">using</span></span> i_less_suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_nat_from_nat_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> suc_less_card<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt-column_set_Gram_Schmidt_upt_k"><span class="command">lemma</span></span> column_set_Gram_Schmidt_upt_k<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">k</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span> <span class="main">(</span><span class="tfree">'cols</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> to_nat <span class="bound">i</span><span class="main">≤</span><span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
  <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> to_nat <span class="bound">i</span><span class="main">≤</span><span class="free">k</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span>
  <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> to_nat <span class="bound">i</span><span class="main">≤</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span>column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> set_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="keyword1">χ</span> <span class="bound">ia</span><span class="main">.</span> Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span> <span class="main">$</span> <span class="bound">ia</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span>
    <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">χ</span> <span class="bound">ia</span><span class="main">.</span> Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span> <span class="main">$</span> <span class="bound">ia</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> to_nat <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">vector</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> less_Suc_eq_le to_nat_le<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'cols</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="skolem">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> i_less_suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> from_nat_le<span class="main">[</span><span class="operator">OF</span> _ k<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j'</span><span class="main">.</span> Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span> <span class="main">$</span> <span class="bound">j'</span> <span class="main">$</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∧</span>  <span class="bound">l</span> <span class="main">&lt;</span> mod_type_class.from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i_less_suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> to_nat <span class="bound">i</span><span class="main">≤</span><span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">}</span> 
    <span class="main">=</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> to_nat <span class="bound">i</span> <span class="main">≤</span> Suc <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_def 
    <span class="keyword1"><span class="command">unfolding</span></span> rw <span class="keyword1"><span class="command">unfolding</span></span> foldl_append <span class="keyword1"><span class="command">unfolding</span></span> foldl.simps <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> to_nat <span class="bound">i</span><span class="main">≤</span><span class="free">k</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span>
    <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> to_nat <span class="bound">i</span><span class="main">≤</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span>column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'cols</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="skolem">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> 
      <span class="main">=</span> column <span class="bound">ia</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> to_nat <span class="bound">ia</span> <span class="main">≤</span> Suc <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> i_less_suc<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ik <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="skolem">i</span> <span class="main">≤</span> Suc <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> column_Gram_Schmidt_upt_k_preserves<span class="main">[</span><span class="operator">OF</span> i_less_suc k<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_suc <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">-</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span>
      to_nat <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span>
      column <span class="bound">a</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      to_nat <span class="bound">a</span> <span class="main">≤</span> Suc <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"from_nat <span class="main"><span class="main">(</span></span>Suc <span class="free"><span class="free">k</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'cols</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">::</span><span class="tfree">'cols</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> to_nat_from_nat_id<span class="main">[</span><span class="operator">OF</span> k<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">-</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span>
        to_nat <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span>
        column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_def column_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">unfolding</span></span> set_rw 
        <span class="keyword1"><span class="command">unfolding</span></span> vector_scaleR_component<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> sum_component<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_sum_rw
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> col_not_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span>
      column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">-</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span>
      to_nat <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="skolem">i</span> <span class="main">≤</span> Suc <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> i_not_suc_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">-</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span>
        to_nat <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> i2  Gram_Schmidt_column_k_def column_def 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">unfolding</span></span> set_rw
        <span class="keyword1"><span class="command">unfolding</span></span> vector_scaleR_component<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> sum_component<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_sum_rw
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> col_not_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> column <span class="bound">ia</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">∧</span> to_nat <span class="bound">ia</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> Gram_Schmidt_upt_k_suc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> column_Gram_Schmidt_upt_k_preserves<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i i_not_suc_k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_imp_less_or_eq from_nat_to_nat_id<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="skolem">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less_Suc_eq_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">k</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'cols</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt-orthogonal_Gram_Schmidt_upt_k"><span class="command">lemma</span></span> orthogonal_Gram_Schmidt_upt_k<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="main">(</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> to_nat <span class="bound">i</span><span class="main">≤</span><span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> s
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> set_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">0</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> to_nat <span class="bound">i</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span>  <span class="main">{</span>column <span class="main">0</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_nat_eq_0<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_rw <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> column_set_Gram_Schmidt_upt_k<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ncols_def<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_sum_rw
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> proj_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> proj_onto_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">rule</span> pairwise_orthogonal_proj_set<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.hyps Suc.prems Suc_lessD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt-columns_Gram_Schmidt_matrix_rw"><span class="command">lemma</span></span> columns_Gram_Schmidt_matrix_rw<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> UNIV<span class="main">}</span> 
  <span class="main">=</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> to_nat <span class="bound">i</span><span class="main">≤</span> <span class="main">(</span>ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> 
    <span class="main">=</span> column <span class="bound">ia</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>ncols <span class="free">A</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> to_nat <span class="bound">ia</span> <span class="main">≤</span> ncols <span class="free">A</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_matrix_def <span class="keyword1"><span class="command">using</span></span> to_nat_less_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>ncols <span class="free">A</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> column <span class="bound">ia</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_matrix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">corollary</span></span> orthogonal_Gram_Schmidt_matrix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="main">(</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> UNIV<span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> columns_Gram_Schmidt_matrix_rw
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orthogonal_Gram_Schmidt_upt_k<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ncols_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> orthogonal_Gram_Schmidt_matrix2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">using</span></span> orthogonal_Gram_Schmidt_matrix <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Gram_Schmidt-column_Gram_Schmidt_column_k"><span class="command">lemma</span></span> column_Gram_Schmidt_column_k<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_def column_def
  <span class="keyword1"><span class="command">unfolding</span></span> from_nat_to_nat_id 
  <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_sum_rw
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>


<span class="keyword1" id="Gram_Schmidt-column_Gram_Schmidt_column_k'"><span class="command">lemma</span></span> column_Gram_Schmidt_column_k'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i_not_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≠</span><span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>column <span class="free">i</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> i_not_k
  <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_def column_def
  <span class="keyword1"><span class="command">unfolding</span></span> from_nat_to_nat_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cols_upt_k</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">{</span>column <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≤</span>from_nat <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt-cols_upt_k_insert"><span class="command">lemma</span></span> cols_upt_k_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cols_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>insert <span class="main">(</span>column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>cols_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> cols_upt_k_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="free">A</span> <span class="main">≠</span> column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> i_not_suc_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> i_le<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> from_nat <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_imp_less_or_eq i i_not_suc_k<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 from_nat_suc le_Suc not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> column <span class="skolem">i</span> <span class="free">A</span> <span class="main">=</span> column <span class="bound">ia</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">ia</span> <span class="main">≤</span> from_nat <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> from_nat <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> from_nat_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ k<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ncols_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> column <span class="skolem">i</span> <span class="free">A</span> <span class="main">=</span> column <span class="bound">ia</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">ia</span> <span class="main">≤</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt-columns_eq_cols_upt_k"><span class="command">lemma</span></span> columns_eq_cols_upt_k<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cols_upt_k <span class="free">A</span> <span class="main">(</span>ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> columns <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> cols_upt_k_def columns_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> column <span class="skolem">i</span> <span class="free">A</span> <span class="main">=</span> column <span class="bound">ia</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">ia</span> <span class="main">≤</span> from_nat <span class="main">(</span>ncols <span class="free">A</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="skolem">i</span> <span class="main">&lt;</span> ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> to_nat_less_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="skolem">i</span> <span class="main">≤</span> <span class="main">(</span>ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="skolem">i</span> <span class="main">≤</span> to_nat <span class="main">(</span>from_nat <span class="main">(</span>ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">::</span><span class="tfree">'cols</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> to_nat_from_nat_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span><span class="main"><span class="main">=</span></span><span class="tfree"><span class="quoted"><span class="tfree">'cols</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> from_nat <span class="main">(</span>ncols <span class="free">A</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def less_le_not_le linear to_nat_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt-span_cols_upt_k_Gram_Schmidt_column_k"><span class="command">lemma</span></span> span_cols_upt_k_Gram_Schmidt_column_k<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>cols_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>cols_upt_k <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> set_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="keyword1">χ</span> <span class="bound">ia</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">ia</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> least_mod_type not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> set_rw2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>column <span class="main">0</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">j</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> eq_iff least_mod_type<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> set_rw3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span><span class="main">{</span>column <span class="main">0</span> <span class="free">A</span><span class="main">}</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> eq_iff least_mod_type<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> col_0_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="main">0</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> column <span class="main">0</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_def column_def
    <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_rw<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> cols_upt_k_def from_nat_0 <span class="keyword1"><span class="command">unfolding</span></span> set_rw2 set_rw3 <span class="keyword1"><span class="command">unfolding</span></span> col_0_eq <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>cols_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>cols_upt_k <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc.prems Suc.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> set_rw1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cols_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>cols_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cols_upt_k_insert
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cols_upt_k_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> set_rw2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cols_upt_k <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    insert <span class="main">(</span>column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cols_upt_k <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cols_upt_k_insert  Suc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">=</span>Suc <span class="skolem">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> suc_not_k<span class="main">:</span> <span class="quoted"><span class="quoted">"from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span>from_nat <span class="free">j</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>from_nat <span class="free">j</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> from_nat_eq_imp_eq<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> tnfnj<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="main">(</span>from_nat <span class="free">j</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> to_nat_from_nat_id<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ncols_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a_suc_k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> col_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?a_suc_k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> column_Gram_Schmidt_column_k'<span class="main">[</span><span class="operator">OF</span> suc_not_k<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> tnfnj <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> ncols_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_rw1 set_rw2 col_eq <span class="keyword1"><span class="command">unfolding</span></span> span_insert <span class="keyword1"><span class="command">unfolding</span></span> hyp <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> cols_upt_k <span class="free">A</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> cols_upt_k <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">-</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="skolem">a</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"insert <span class="var">?a</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> col_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> from_nat <span class="skolem">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> from_nat <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> from_nat_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ncols_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> column <span class="skolem">i</span> <span class="free">A</span> <span class="main">=</span> column <span class="bound">ia</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">ia</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span>
      <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">≤</span> from_nat <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Suc_eq_plus1 <span class="keyword1"><span class="command">unfolding</span></span> from_nat_suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_Suc not_less<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">" <span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> column <span class="skolem">i</span> <span class="free">A</span> <span class="main">=</span> column <span class="bound">ia</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">ia</span> <span class="main">≤</span> from_nat <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> rw<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>cols_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="skolem">a</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_def True  <span class="keyword1"><span class="command">unfolding</span></span> cols_upt_k_def a_def C_def
      <span class="keyword1"><span class="command">unfolding</span></span>  column_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> column_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> col_rw minus_vec_def
      <span class="keyword1"><span class="command">unfolding</span></span> column_def vec_lambda_beta
      <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_sum_rw
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> finite_C<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> C_def cols_upt_k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">b</span>
      <span class="keyword1"><span class="command">have</span></span> th0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="main">(</span><span class="bound">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">)</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">a</span> <span class="main">-</span> <span class="main">(</span><span class="bound">b</span> <span class="main">-</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="bound">c</span> <span class="main">+</span> <span class="main">(</span><span class="bound">a</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">-</span> <span class="skolem">b</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span>  <span class="main">(</span><span class="skolem">a</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">C</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="skolem">a</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>  <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span>  <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> span <span class="skolem">C</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">-</span> <span class="skolem">b</span>  <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span>  <span class="skolem">a</span> <span class="main">∈</span> span <span class="skolem">C</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> scaleR_right_diff_distrib th0<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> span_add_eq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> span_mul<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> span_sum<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> span_mul<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> span_base<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_eq_iff
      <span class="keyword1"><span class="command">unfolding</span></span> C_def B_def <span class="keyword1"><span class="command">unfolding</span></span> set_rw1 <span class="keyword1"><span class="command">unfolding</span></span> set_rw2
      <span class="keyword1"><span class="command">unfolding</span></span> span_breakdown_eq <span class="keyword1"><span class="command">unfolding</span></span> hyp
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> B_def a_def rw<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">corollary</span></span> span_Gram_Schmidt_column_k<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> columns_eq_cols_upt_k<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
  <span class="keyword1"><span class="command">using</span></span> span_cols_upt_k_Gram_Schmidt_column_k<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">corollary</span></span> span_Gram_Schmidt_upt_k<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"columns <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> columns <span class="free">A</span>"</span></span>    
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> columns_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> 
    <span class="keyword1"><span class="command">have</span></span> set_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="keyword1">χ</span> <span class="bound">ia</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">ia</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> less_le_not_le least_mod_type from_nat_0<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> column <span class="bound">ia</span> <span class="free">A</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_def column_def
      <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> column <span class="skolem">i</span> <span class="free">A</span> <span class="main">=</span> column <span class="bound">ia</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_rw <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_def column_def 
      <span class="keyword1"><span class="command">unfolding</span></span> from_nat_0 
      <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc.prems Suc.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> span <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_suc <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> span <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> span_Gram_Schmidt_column_k<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> span_Gram_Schmidt_matrix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_matrix_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> span_Gram_Schmidt_upt_k ncols_def<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt-is_basis_columns_Gram_Schmidt_matrix"><span class="command">lemma</span></span> is_basis_columns_Gram_Schmidt_matrix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"is_basis <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_basis <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">∧</span> card <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> span_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"vec.span <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span>real<span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">)</span> set<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> span_Gram_Schmidt_matrix b <span class="keyword1"><span class="command">unfolding</span></span> is_basis_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> span_vec_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> c_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b is_basis_def finite_columns vec.independent_span_bound span_UNIV top_greatest<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">using</span></span> card_columns_le_ncols <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_antisym ncols_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> vec.card_le_dim_spanning<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"UNIV<span class="main"><span class="main">::</span></span><span class="main"><span class="main">(</span></span>real<span class="main"><span class="main">^</span></span><span class="tfree"><span class="tfree">'m</span></span><span class="main"><span class="main">::</span></span><span class="main"><span class="main">{</span></span>mod_type<span class="main"><span class="main">}</span></span><span class="main"><span class="main">)</span></span> set"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">⊆</span> vec.span <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> span_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_columns <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> vec.dim <span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span>real<span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b c c_eq eq_iff is_basis_def vec.dim_span_eq_card_independent<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_basis_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹From here on, we present some lemmas that will be useful for the formalisation of the QR
  decomposition.›</span></span> 

<span class="keyword1" id="Gram_Schmidt-column_gr_k_Gram_Schmidt_upt"><span class="command">lemma</span></span> column_gr_k_Gram_Schmidt_upt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&gt;</span><span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> column <span class="main">(</span>from_nat <span class="free">i</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>from_nat <span class="free">i</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> from_nat_0<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> bij_from_nat<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span><span class="main"><span class="main">=</span></span><span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> from_nat_eq_imp_eq gr_implies_not0 i ncols_def neq0_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> column <span class="main">(</span>from_nat <span class="free">i</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gram_Schmidt_column_k_def from_nat_0 column_def<span class="main">)</span>  
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> column <span class="main">(</span>from_nat <span class="free">i</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.hyps Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> to_nat_from_nat_suc_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_nat <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems dual_order.strict_trans from_nat_not_eq i ncols_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> column <span class="main">(</span>from_nat <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_suc <span class="keyword1"><span class="command">..</span></span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  column <span class="main">(</span>from_nat <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> column_Gram_Schmidt_column_k'
      <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"from_nat <span class="free"><span class="free">i</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"from_nat <span class="main"><span class="main">(</span></span>Suc <span class="skolem"><span class="skolem">k</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">" <span class="main"><span class="main">(</span></span>Gram_Schmidt_upt_k <span class="free"><span class="free">A</span></span> <span class="skolem"><span class="skolem">k</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> to_nat_from_nat_suc_k<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="free">i</span> <span class="main">≠</span> <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems not_less_iff_gr_or_eq
        from_nat_not_eq i ncols_def to_nat_from_nat_suc_k<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> hyp <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt-columns_Gram_Schmidt_upt_k_rw"><span class="command">lemma</span></span> columns_Gram_Schmidt_upt_k_rw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">k</span> <span class="main">&lt;</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">}</span> 
  <span class="main">=</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> to_nat_from_nat_k<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">k</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> to_nat_from_nat_id k <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> column <span class="bound">ia</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">ia</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> column_Gram_Schmidt_upt_k_preserves i k ncols_def to_nat_le<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> column <span class="bound">ia</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">ia</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> column_Gram_Schmidt_upt_k_preserves i k ncols_def to_nat_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt-column_Gram_Schmidt_upt_k"><span class="command">lemma</span></span> column_Gram_Schmidt_upt_k<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span>column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span>column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> from_nat_0<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> set_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">0</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> least_mod_type not_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> set_rw2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> least_mod_type not_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> col_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="main">0</span> <span class="free">A</span> <span class="main">=</span> column <span class="main">0</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_def from_nat_0
    <span class="keyword1"><span class="command">unfolding</span></span> column_def
    <span class="keyword1"><span class="command">using</span></span> set_rw2 <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="main">0</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">0</span><span class="main">)</span> 
    <span class="main">=</span> column <span class="main">0</span> <span class="free">A</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">0</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> column <span class="main">0</span> <span class="free">A</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_rw col_rw <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ak</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="skolem">k</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?uk</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a_suck</span></span></span><span class="main">=</span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u_suck</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> to_nat_from_nat_k<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> to_nat_from_nat_id Suc.prems <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> a_suc_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="var">?a_suck</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> column_gr_k_Gram_Schmidt_upt<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.prems<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> set_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">}</span> 
    <span class="main">=</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> columns_Gram_Schmidt_upt_k_rw<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u_suck</span> <span class="main">=</span> column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">-</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span>
    <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_suc
    <span class="keyword1"><span class="command">using</span></span> column_Gram_Schmidt_column_k<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> to_nat_from_nat_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?a_suck</span> <span class="main">-</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span>
    <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?a_suck</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a_suc_rw <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u_suck</span> <span class="main">=</span> <span class="var">?a_suck</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span>
    <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?a_suck</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> set_rw <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1" id="Gram_Schmidt-column_Gram_Schmidt_upt_k_preserves2"><span class="command">lemma</span></span> column_Gram_Schmidt_upt_k_preserves2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">≤</span><span class="main">(</span>from_nat <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column <span class="free">a</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> column <span class="free">a</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="free">a</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> column <span class="free">a</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> le_0_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">=</span>from_nat <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> a_not_suc_j<span class="main">=</span>False
    <span class="keyword1"><span class="command">have</span></span> rw1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_nat <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> to_nat_from_nat_id Suc.prems <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_suc <span class="keyword1"><span class="command">using</span></span> column_Gram_Schmidt_column_k'<span class="main">[</span><span class="operator">OF</span> a_not_suc_j<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> rw1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Gram_Schmidt_upt_k_suc Suc.hyps Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Suc_le_lessD assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_Suc_eq nat_less_le<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>from_nat <span class="free">i</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">≤</span> from_nat <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> from_nat_mono'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ncols_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> i_eq_suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">=</span>Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> from_nat_eq_imp_eq<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True i_eq_suc <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1" id="Gram_Schmidt-set_columns_Gram_Schmidt_matrix"><span class="command">lemma</span></span> set_columns_Gram_Schmidt_matrix<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">k</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">=</span> column <span class="bound">ia</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">ia</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">=</span> column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_matrix_def 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> column_Gram_Schmidt_upt_k_preserves2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> from_nat <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> from_nat_to_nat_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="free">k</span> <span class="main">≤</span> ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">using</span></span> to_nat_less_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> column <span class="bound">ia</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">ia</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_matrix_def 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> column_Gram_Schmidt_upt_k_preserves2<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> from_nat <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> from_nat_to_nat_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="free">k</span> <span class="main">≤</span> ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">using</span></span> to_nat_less_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1" id="Gram_Schmidt-column_Gram_Schmidt_matrix"><span class="command">lemma</span></span> column_Gram_Schmidt_matrix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> 
  <span class="main">=</span> <span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="free">k</span> <span class="main">&lt;</span> ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> to_nat_less_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">=</span> column <span class="free">k</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_matrix_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> column <span class="free">k</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> column_Gram_Schmidt_upt_k_preserves2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> from_nat <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> from_nat_to_nat_id <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="free">k</span> <span class="main">≤</span> ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">using</span></span> to_nat_less_card<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span><span class="main"><span class="main">=</span></span><span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_diff_conv2 add_leE less_diff_conv less_imp_le_nat  less_le_not_le
        nat_le_linear suc_not_zero to_nat_plus_one_less_card'<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> column <span class="free">k</span> <span class="free">A</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> column <span class="free">k</span> <span class="free">A</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> column_Gram_Schmidt_upt_k<span class="main">[</span><span class="operator">OF</span> k<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> from_nat_to_nat_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> column <span class="free">k</span> <span class="free">A</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> column <span class="free">k</span> <span class="free">A</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_columns_Gram_Schmidt_matrix<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">corollary</span></span> column_Gram_Schmidt_matrix2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> column <span class="free">k</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> 
  <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> column_Gram_Schmidt_matrix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>



<span class="keyword1" id="Gram_Schmidt-independent_columns_Gram_Schmidt_matrix"><span class="command">lemma</span></span> independent_columns_Gram_Schmidt_matrix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> card <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  b c card_columns_le_ncols vec.card_eq_dim_span_indep vec.dim_span eq_iff finite_columns 
    vec.independent_span_bound ncols_def span_Gram_Schmidt_matrix
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> vec.card_ge_dim_independent vec.dim_span_eq_card_independent span_vec_eq<span class="main">)</span>


<span class="keyword1" id="Gram_Schmidt-column_eq_Gram_Schmidt_matrix"><span class="command">lemma</span></span> column_eq_Gram_Schmidt_matrix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">=</span> column <span class="free">ia</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">ia</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> i_not_ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">ia</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> column <span class="bound">x</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">`</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> column <span class="bound">x</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">`</span> <span class="main">(</span><span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">)</span> set<span class="main">)</span><span class="main">-</span><span class="main">{</span><span class="free">ia</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>  
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="free">ia</span><span class="main">}</span><span class="main">.</span> column <span class="skolem">xa</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">=</span> column <span class="bound">x</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> <span class="free">ia</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c i_not_ia <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffI UNIV_I empty_iff insert_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> columns_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> column <span class="bound">x</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="free">ia</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ncols <span class="free">A</span> <span class="main">=</span> card <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> full_rank_imp_is_basis2 independent_columns_Gram_Schmidt_matrix r<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="free">ia</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> columns_rw <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_image_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'n</span> set<span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Diff_singleton<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nat.add_0_right le_diff_conv2 One_nat_def Suc_n_not_le_n add_Suc_right one_le_card_finite<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt-scaleR_columns_Gram_Schmidt_matrix"><span class="command">lemma</span></span> scaleR_columns_Gram_Schmidt_matrix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column <span class="free">j</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">∙</span> column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"column <span class="free">j</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">≠</span> column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> column_eq_Gram_Schmidt_matrix assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> orthogonal_Gram_Schmidt_matrix2 <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def orthogonal_def columns_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Examples of execution›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Code lemma›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> Gram_Schmidt_step_def<span class="main">[</span><span class="operator">unfolded</span> proj_onto_def proj_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">,</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> map <span class="main">(</span>list_to_vec<span class="main">::</span>real list<span class="main">=&gt;</span> real<span class="main">^</span><span class="numeral">4</span><span class="main">)</span> <span class="main">[</span><span class="main">[</span><span class="numeral">4</span><span class="main">,</span><span class="main">-</span><span class="numeral">2</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">]</span><span class="main">,</span> 
  <span class="main">[</span><span class="main">-</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="main">-</span><span class="numeral">8</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="numeral">5</span><span class="main">,</span><span class="main">-</span><span class="numeral">5</span><span class="main">,</span><span class="main">-</span><span class="numeral">3</span><span class="main">,</span><span class="main">-</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span> <span class="keyword1">in</span> 
  map vec_to_list <span class="main">(</span>Gram_Schmidt <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> map <span class="main">(</span>list_to_vec<span class="main">::</span>real list<span class="main">=&gt;</span> real<span class="main">^</span><span class="numeral">4</span><span class="main">)</span> <span class="main">[</span><span class="main">[</span><span class="numeral">4</span><span class="main">,</span><span class="main">-</span><span class="numeral">2</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">]</span><span class="main">,</span> 
  <span class="main">[</span><span class="main">-</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="main">-</span><span class="numeral">8</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="numeral">5</span><span class="main">,</span><span class="main">-</span><span class="numeral">5</span><span class="main">,</span><span class="main">-</span><span class="numeral">3</span><span class="main">,</span><span class="main">-</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span> <span class="keyword1">in</span> 
  map vec_to_list <span class="main">(</span>Gram_Schmidt2 <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="numeral">4</span><span class="main">,</span><span class="main">-</span><span class="numeral">2</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">]</span><span class="main">,</span> 
  <span class="main">[</span><span class="main">-</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="main">-</span><span class="numeral">8</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="numeral">5</span><span class="main">,</span><span class="main">-</span><span class="numeral">5</span><span class="main">,</span><span class="main">-</span><span class="numeral">3</span><span class="main">,</span><span class="main">-</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">4</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span> 
  matrix_to_list_of_list <span class="main">(</span>Gram_Schmidt_matrix <span class="bound">A</span><span class="main">)</span>"</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="QR_Decomposition">
<div class="head">
<h1>Theory QR_Decomposition</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Title:      QR_Decomposition.thy
    Author:     Jose Divasón &lt;jose.divasonm at unirioja.es&gt;
    Author:     Jesús Aransay &lt;jesus-maria.aransay at unirioja.es&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹QR Decomposition›</span></span>

<span class="keyword1"><span class="command">theory</span></span> QR_Decomposition
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Gram_Schmidt">Gram_Schmidt</a>
<span class="keyword2"><span class="keyword">begin</span></span>
 
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The QR Decomposition of a matrix›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
First of all, it's worth noting what an orthogonal matrix is. In linear algebra, 
an orthogonal matrix is a square matrix with real entries whose columns and rows are orthogonal 
unit vectors.

Although in some texts the QR decomposition is presented over square matrices, it can be applied to any matrix.
There are some variants of the algorithm, depending on the properties that the output matrices 
satisfy (see for instance, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">url</span></span> "http://inst.eecs.berkeley.edu/~ee127a/book/login/l_mats_qr.html"<span class="antiquote"><span class="antiquote">}</span></span></span></span>). 
We present two of them below.

Let A be a matrix with m rows and n columns (A is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m × n›</span></span></span></span>).

Case 1: Starting with a matrix whose column rank is maximum. We can define the QR decomposition
to obtain:

\begin{itemize}
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">Q</span></span> <span class="main"><span class="main">**</span></span> <span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  \item Q has m rows and n columns. Its columns are orthogonal unit vectors 
        and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>transpose <span class="free"><span class="free">Q</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">*</span></span> <span class="free"><span class="free">Q</span></span> <span class="main"><span class="main">=</span></span> mat <span class="main"><span class="main">1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In addition, if A is a square matrix, then Q
        will be an orthonormal matrix.
  \item R is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n × n›</span></span></span></span>, invertible and upper triangular.
\end{itemize}

Case 2: The called full QR decomposition. We can obtain:
\begin{itemize}
 \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">Q</span></span> <span class="main"><span class="main">**</span></span> <span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
 \item Q is an orthogonal matrix (Q is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m × m›</span></span></span></span>).
 \item R is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m × n›</span></span></span></span> and upper triangular, but it isn't invertible.
\end{itemize}

We have decided to formalise the first one, because it's the only useful for solving 
the linear least squares problem (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">url</span></span> "http://math.mit.edu/linearalgebra/ila0403.pdf"<span class="antiquote"><span class="antiquote">}</span></span></span></span>).

If we have an unsolvable system <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A *v x = b›</span></span></span></span>, we can try to find an approximate solution.
A plausible choice (not the only one) is to seek an <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> with the property that
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∥A ** x - y∥›</span></span></span></span> (the magnitude of the error) is as small as possible. That <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>
is the least squares approximation.

We will demostrate that the best approximation (the solution for the linear least squares problem)
is the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> that satisfies:

<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(transpose A) ** A *v x = (transpose A) *v b›</span></span></span></span>

Now we want to compute that x.

If we are working with the first case, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> can be substituted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Q**R›</span></span></span></span> and then
obtain the solution of the least squares approximation by means of the QR decomposition:

<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x = (inverse R)**(transpose Q) *v b›</span></span></span></span>

On the contrary, if we are working with the second case after 
substituting <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Q**R›</span></span></span></span> we obtain:

<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(transpose R) ** R *v x = (transpose R) ** (transpose Q) *v b›</span></span></span></span>

But the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>R›</span></span></span></span> matrix is not invertible (so neither is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>transpose R›</span></span></span></span>). The left part
of the equation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(transpose R) ** R›</span></span></span></span> is not going to be an upper triangular matrix, 
so it can't either be solved using backward-substitution.
›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Divide a vector by its norm›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹An orthogonal matrix is a matrix whose rows (and columns) are orthonormal vectors. So, in order to 
obtain the QR decomposition, we have to normalise (divide by the norm) 
the vectors obtained with the Gram-Schmidt algorithm.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">divide_by_norm</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> normalize <span class="main">(</span>column <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Properties›</span></span>

<span class="keyword1" id="QR_Decomposition-norm_column_divide_by_norm"><span class="command">lemma</span></span> norm_column_divide_by_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'cols</span><span class="main">^</span><span class="tfree">'rows</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="free">a</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>column <span class="free">a</span> <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> not_0<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a column_def norm_eq_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"column <span class="free">a</span> <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> divide_by_norm_def column_def normalize_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span>  <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>column <span class="free">a</span> <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> norm <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span>  <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">¦</span><span class="main">1</span> <span class="main">/</span> norm <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span><span class="main">¦</span> <span class="main">*</span> norm <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> norm_scaleR <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> norm <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="QR_Decomposition-span_columns_divide_by_norm"><span class="command">lemma</span></span> span_columns_divide_by_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>columns <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> real_vector.span_eq
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> columns <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_col_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span>column <span class="skolem">i</span> <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>norm <span class="main">(</span>column <span class="skolem">i</span>  <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>column <span class="skolem">i</span> <span class="free">A</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> divide_by_norm_def column_def normalize_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> x_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="main">(</span><span class="main">1</span><span class="main">/</span>norm <span class="main">(</span>column <span class="skolem">i</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>column <span class="skolem">i</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> span <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> x_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> span_mul<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> span_base<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> columns_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> columns <span class="free">A</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> span <span class="main">(</span>columns <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True span_0<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_col_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span>column <span class="skolem">i</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span>column <span class="skolem">i</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_col_i <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> norm <span class="main">(</span>column <span class="skolem">i</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> column <span class="skolem">i</span> <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">unfolding</span></span> x_col_i columns_def divide_by_norm_def column_def normalize_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> x_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> norm <span class="main">(</span>column <span class="skolem">i</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> column <span class="skolem">i</span> <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> span <span class="main">(</span>columns <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> x_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> span_mul<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> span_base<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> columns_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Code lemmas›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">divide_by_norm_row</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> vec_lambda<span class="main">(</span><span class="main">%</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="main">(</span>column <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> column <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="QR_Decomposition-divide_by_norm_row_code"><span class="command">lemma</span></span> divide_by_norm_row_code<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"vec_nth <span class="main">(</span>divide_by_norm_row <span class="free">A</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">%</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="main">(</span>column <span class="bound">b</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> column <span class="bound">b</span> <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> divide_by_norm_row_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> vec_lambda_beta<span class="main">)</span>

<span class="keyword1" id="QR_Decomposition-divide_by_norm_code"><span class="command">lemma</span></span> divide_by_norm_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"vec_nth <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span> <span class="main">=</span> divide_by_norm_row <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> divide_by_norm_def <span class="keyword1"><span class="command">unfolding</span></span> divide_by_norm_row_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> normalize_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹The QR Decomposition›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The QR decomposition. Given a real matrix <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the algorithm will return a pair <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">Q</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">R</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is an matrix whose columns are orthogonal unit vectors, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
  is upper triangular and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span><span class="main"><span class="main">=</span></span><span class="free"><span class="free">Q</span></span><span class="main"><span class="main">**</span></span><span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">QR_decomposition</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> divide_by_norm <span class="main">(</span>Gram_Schmidt_matrix <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">Q</span><span class="main">,</span> <span class="main">(</span>transpose <span class="bound">Q</span><span class="main">)</span> <span class="main">**</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="QR_Decomposition-is_basis_columns_fst_QR_decomposition"><span class="command">lemma</span></span> is_basis_columns_fst_QR_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"is_basis <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_basis <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">∧</span> card <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> is_basis_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec.span <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> vec.span <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vec.span_eq
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vec.span <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> is_basis_columns_Gram_Schmidt_matrix is_basis_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_col_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span>column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> zero_not_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_basis_columns_Gram_Schmidt_matrix<span class="main">[</span><span class="operator">OF</span> b c<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> is_basis_def
      <span class="keyword1"><span class="command">using</span></span> vec.dependent_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span>column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_col_i <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> norm <span class="main">(</span>column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> column <span class="skolem">i</span> <span class="main">(</span>divide_by_norm <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> zero_not_in <span class="keyword1"><span class="command">unfolding</span></span> x_col_i columns_def divide_by_norm_def column_def normalize_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> x_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> norm <span class="main">(</span>column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> column <span class="skolem">i</span> <span class="main">(</span>divide_by_norm <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vec.span <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> x_eq span_vec_eq
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subspace_mul<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> columns_def QR_decomposition_def Let_def subspace_span <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> span_superset<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> span_superset <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"vec.span <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span>real<span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_basis_columns_Gram_Schmidt_matrix<span class="main">[</span><span class="operator">OF</span> b c<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> is_basis_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> b c card_columns_le_ncols vec.card_le_dim_spanning 
      finite_columns vec.indep_card_eq_dim_span is_basis_def ncols_def top_greatest<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> s b c vec.card_eq_dim_span_indep finite_columns vec.indep_card_eq_dim_span is_basis_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="QR_Decomposition-orthogonal_fst_QR_decomposition"><span class="command">lemma</span></span> orthogonal_fst_QR_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def columns_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">ia</span>
  <span class="keyword3"><span class="command">assume</span></span> col_not_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> column <span class="skolem">ia</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> i_not_ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">ia</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> col_not_eq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">a</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">a</span> <span class="main">$</span> <span class="skolem">ia</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> column_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> col_not_eq2<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">(</span>column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span>column <span class="skolem">ia</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> col_not_eq <span class="keyword1"><span class="command">unfolding</span></span> QR_decomposition_def Let_def fst_conv 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> divide_by_norm_def vec_lambda_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">ia</span><span class="main">.</span> Gram_Schmidt_matrix <span class="free">A</span> <span class="main">$</span> <span class="bound">ia</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> QR_decomposition_def Let_def fst_conv
    <span class="keyword1"><span class="command">unfolding</span></span> divide_by_norm_def column_def normalize_def <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="skolem">ia</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> Gram_Schmidt_matrix <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="skolem">ia</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>column <span class="skolem">ia</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> QR_decomposition_def Let_def fst_conv
    <span class="keyword1"><span class="command">unfolding</span></span> divide_by_norm_def column_def normalize_def <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="main">(</span>column <span class="skolem">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>column <span class="skolem">ia</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> d1 d2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> orthogonal_mult<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> orthogonal_Gram_Schmidt_matrix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def <span class="keyword1"><span class="command">using</span></span> col_not_eq2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="QR_Decomposition-qk_uk_norm"><span class="command">lemma</span></span> qk_uk_norm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="main">(</span>norm <span class="main">(</span>column <span class="free">k</span> <span class="main">(</span><span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>column <span class="free">k</span> <span class="main">(</span><span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">=</span> column <span class="free">k</span> <span class="main">(</span>fst<span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> QR_decomposition_def Let_def fst_conv divide_by_norm_def
  <span class="keyword1"><span class="command">unfolding</span></span> column_def normalize_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>


<span class="keyword1" id="QR_Decomposition-norm_columns_fst_QR_decomposition"><span class="command">lemma</span></span> norm_columns_fst_QR_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>column <span class="free">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms full_rank_imp_is_basis2 independent_columns_Gram_Schmidt_matrix<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> vec.dependent_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>column <span class="free">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> QR_decomposition_def Let_def fst_conv 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> norm_column_divide_by_norm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">corollary</span></span> span_fst_QR_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec.span <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> vec.span <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> span_Gram_Schmidt_matrix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> QR_decomposition_def Let_def fst_conv
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹span <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>›</span></span> span_columns_divide_by_norm span_vec_eq<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> col_space_QR_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"col_space <span class="free">A</span> <span class="main">=</span> col_space <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> col_space_def <span class="keyword1"><span class="command">using</span></span> span_fst_QR_decomposition
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="QR_Decomposition-independent_columns_fst_QR_decomposition"><span class="command">lemma</span></span> independent_columns_fst_QR_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">∧</span> card <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">thm</span></span> is_basis_imp_full_rank
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> col_rank <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rank_col_rank <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec.dim <span class="main">(</span>col_space <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> col_rank_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> col_space_def <span class="keyword1"><span class="command">using</span></span> b
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vec.dim_span_eq_card_independent<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b c col_rank_def col_space_QR_decomposition col_space_def 
      full_rank_imp_is_basis2 vec.indep_card_eq_dim_span ncols_def rank_col_rank<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> col_space_QR_decomposition full_rank_imp_is_basis2 ncols_def r rank_eq_dim_col_space'<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="QR_Decomposition-orthogonal_matrix_fst_QR_decomposition"><span class="command">lemma</span></span> orthogonal_matrix_fst_QR_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"transpose <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">**</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mat <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> mat_1_fun<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> norm <span class="main">(</span>column <span class="bound">i</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Q_def <span class="keyword1"><span class="command">using</span></span> norm_columns_fst_QR_decomposition<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="skolem">Q</span><span class="main">)</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Q_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> full_rank_imp_is_basis2 independent_columns_fst_QR_decomposition r<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="main">(</span>columns <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Q_def orthogonal_fst_QR_decomposition<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ia</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transpose <span class="skolem">Q</span> <span class="main">**</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">=</span> column <span class="skolem">ia</span> <span class="skolem">Q</span> <span class="main">∙</span> column <span class="skolem">ia</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_matrix_mult_inner_mult <span class="keyword1"><span class="command">unfolding</span></span> row_transpose <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n norm_eq_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transpose <span class="skolem">Q</span> <span class="main">**</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> i_not_ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">ia</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> column_i_not_ia<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="skolem">Q</span> <span class="main">≠</span> column <span class="skolem">ia</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> col_i_ia<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="skolem">Q</span> <span class="main">=</span> column <span class="skolem">ia</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> column <span class="bound">i</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">`</span> <span class="main">(</span>UNIV<span class="main">-</span><span class="main">{</span><span class="skolem">ia</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>column <span class="bound">i</span> <span class="skolem">Q</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≠</span><span class="skolem">ia</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>columns <span class="skolem">Q</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="main">{</span>column <span class="bound">i</span> <span class="skolem">Q</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≠</span><span class="skolem">ia</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_same_card<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">id</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> bij_betw_def columns_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> col_i_ia i_not_ia<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> column <span class="bound">i</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">`</span> <span class="main">(</span>UNIV<span class="main">-</span><span class="main">{</span><span class="skolem">ia</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rw <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="skolem">ia</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_image_le finite_code<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span> <span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> oia<span class="main">:</span> <span class="quoted"><span class="quoted">"orthogonal <span class="main">(</span>column <span class="skolem">i</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">(</span>column <span class="skolem">ia</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transpose <span class="skolem">Q</span> <span class="main">**</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">=</span> column <span class="skolem">i</span> <span class="skolem">Q</span> <span class="main">∙</span> column <span class="skolem">ia</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_matrix_mult_inner_mult <span class="keyword1"><span class="command">unfolding</span></span> row_transpose <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> oia <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transpose <span class="skolem">Q</span> <span class="main">**</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> orthogonal_matrix_fst_QR_decomposition'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orthogonal_matrix <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms orthogonal_matrix orthogonal_matrix_fst_QR_decomposition<span class="main">)</span>


<span class="keyword1" id="QR_Decomposition-column_eq_fst_QR_decomposition"><span class="command">lemma</span></span> column_eq_fst_QR_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> column <span class="free">ia</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">ia</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> i_not_ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">ia</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"columns  <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> column <span class="bound">x</span>  <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">`</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> column <span class="bound">x</span>  <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">`</span> <span class="main">(</span><span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">)</span> set<span class="main">)</span><span class="main">-</span><span class="main">{</span><span class="free">ia</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>  
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="free">ia</span><span class="main">}</span><span class="main">.</span> column <span class="skolem">xa</span>  <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> column <span class="bound">x</span>  <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> <span class="free">ia</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c i_not_ia <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffI UNIV_I empty_iff insert_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> columns_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"columns  <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> column <span class="bound">x</span>  <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="free">ia</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ncols <span class="free">A</span> <span class="main">=</span> card <span class="main">(</span>columns  <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> full_rank_imp_is_basis2 independent_columns_fst_QR_decomposition r<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="free">ia</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> columns_rw <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_image_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'n</span> set<span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Diff_singleton<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nat.add_0_right le_diff_conv2 One_nat_def Suc_n_not_le_n add_Suc_right one_le_card_finite<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> column_QR_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span><span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">=</span> <span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?uk</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span><span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?qk</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span>fst<span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ak</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>norm <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> set_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">f</span><span class="main">`</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> 
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> col_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">1</span><span class="main">/</span>norm <span class="main">(</span>column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> QR_decomposition_def Let_def fst_conv divide_by_norm_def column_def normalize_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">f</span> <span class="main">`</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">using</span></span> i
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span>column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> column <span class="bound">ia</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">ia</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def col_rw i<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="skolem">f</span><span class="main">`</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> set_rw <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="var">?g</span>  <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> inj_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">ia</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span>column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span>column <span class="skolem">ia</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span>column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> column <span class="skolem">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f_def QR_decomposition_def Let_def fst_conv divide_by_norm_def column_def normalize_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>
    <span class="keyword1"><span class="command">have</span></span> fia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span>column <span class="skolem">ia</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> column <span class="skolem">ia</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f_def QR_decomposition_def Let_def fst_conv divide_by_norm_def column_def normalize_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">ia</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> column_eq_fst_QR_decomposition<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span> f_eq <span class="keyword1"><span class="command">unfolding</span></span> fi fia <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">=</span> column <span class="skolem">ia</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span>
    <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> o_def f_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span>
    <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span><span class="main">)</span>  <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> vec.independent_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"columns <span class="main"><span class="main">(</span></span>Gram_Schmidt_matrix <span class="free"><span class="free">A</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> full_rank_imp_is_basis2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> full_rank_imp_is_basis2 independent_columns_Gram_Schmidt_matrix r<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="main">⊆</span> columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> vec.dependent_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">" <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span><span class="main">]</span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span> <span class="main">∙</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inverse_eq_divide norm_eq_1 norm_sgn sgn_div_norm<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span> <span class="main">∙</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span> <span class="main">∙</span> column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span> <span class="main">∙</span> column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∙</span> column <span class="free">k</span> <span class="free">A</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> mult.right_neutral inner_commute inner_scaleR_right 
        norm_cauchy_schwarz_eq scaleR_one scaleR_scaleR times_divide_eq_right times_divide_times_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ak</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>
    <span class="main">=</span> <span class="var">?ak</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?uk</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> column_Gram_Schmidt_matrix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="QR_Decomposition-column_QR_decomposition'"><span class="command">lemma</span></span> column_QR_decomposition'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> column <span class="free">k</span> <span class="main">(</span><span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> column_QR_decomposition<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1" id="QR_Decomposition-norm_uk_eq"><span class="command">lemma</span></span> norm_uk_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>column <span class="free">k</span> <span class="main">(</span><span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>column <span class="free">k</span> <span class="main">(</span>fst<span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?uk</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span><span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?qk</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span>fst<span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ak</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> sum_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?uk</span> <span class="main">∙</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?uk</span> <span class="main">∙</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="var">?uk</span> <span class="main">∙</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> inner_sum_right <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?uk</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inner_scaleR_right <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?uk</span> <span class="main">∙</span> column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_irrefl r scaleR_columns_Gram_Schmidt_matrix<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span>column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">∙</span> column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
        <span class="main">(</span><span class="var">?uk</span> <span class="main">∙</span> column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?qk</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="main">(</span>norm <span class="var">?uk</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="var">?uk</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?ak</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qk_uk_norm <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="main">(</span>norm <span class="var">?uk</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?uk</span> <span class="main">∙</span> <span class="var">?ak</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inner_scaleR_left <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="main">(</span>norm <span class="var">?uk</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?uk</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?uk</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> column_Gram_Schmidt_matrix2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="main">(</span>norm <span class="var">?uk</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="var">?uk</span> <span class="main">∙</span> <span class="var">?uk</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="var">?uk</span> <span class="main">∙</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inner_add_right <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="main">(</span>norm <span class="var">?uk</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?uk</span> <span class="main">∙</span> <span class="var">?uk</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_rw <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> norm <span class="var">?uk</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abs_of_nonneg divide_eq_imp div_by_0 inner_commute inner_ge_zero inner_real_def 
      norm_mult_vec real_inner_1_right real_norm_def times_divide_eq_right<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> column_QR_decomposition2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> 
  <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?uk</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span><span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?qk</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span>fst<span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ak</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> set_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span><span class="main">}</span> 
    <span class="main">=</span> insert <span class="main">(</span>column <span class="free">k</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> less_linear not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> uk_norm_uk_qk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?uk</span> <span class="main">=</span> norm <span class="var">?uk</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="var">?qk</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> full_rank_imp_is_basis2 independent_columns_Gram_Schmidt_matrix r<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?uk</span> <span class="main">∈</span> columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?uk</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vec.dependent_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">hence</span></span> norm_not_0<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="var">?uk</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm_eq_zero <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="var">?uk</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="var">?qk</span> <span class="main">=</span> <span class="main">(</span>norm <span class="var">?uk</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="var">?uk</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="var">?uk</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> qk_uk_norm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>norm <span class="var">?uk</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="var">?uk</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="var">?uk</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> scaleR_scaleR <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?uk</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> norm_not_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> norm_qk_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?qk</span>  <span class="main">∙</span> <span class="var">?qk</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> norm_eq_1 norm_columns_fst_QR_decomposition<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ak</span> <span class="main">=</span> <span class="var">?uk</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> column_QR_decomposition'<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>norm <span class="var">?uk</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="var">?qk</span><span class="main">)</span>  <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> uk_norm_uk_qk <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="var">?qk</span> <span class="main">∙</span> <span class="var">?ak</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="var">?qk</span><span class="main">)</span>  
    <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> norm_uk_eq<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="var">?qk</span> <span class="main">∙</span> <span class="var">?ak</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="var">?qk</span> <span class="main">∙</span> <span class="var">?qk</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="var">?qk</span>
    <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> norm_qk_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>insert <span class="var">?qk</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="var">?ak</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.insert<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> column <span class="free">k</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> col_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> column <span class="skolem">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> i_less_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> column_eq_fst_QR_decomposition<span class="main">[</span><span class="operator">OF</span> r col_eq<span class="main">]</span> i_less_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_rw<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span>column <span class="skolem">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> norm_eq_1 norm_columns_fst_QR_decomposition<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∙</span> column <span class="free">k</span> <span class="free">A</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∙</span> column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="QR_Decomposition-orthogonal_columns_fst_QR_decomposition"><span class="command">lemma</span></span> orthogonal_columns_fst_QR_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i_not_ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>column <span class="free">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span>column <span class="free">ia</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>column <span class="free">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> column <span class="free">ia</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="free">ia</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> orthogonal_fst_QR_decomposition<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> i ia i_not_ia <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def orthogonal_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="QR_Decomposition-scaler_column_fst_QR_decomposition"><span class="command">lemma</span></span> scaler_column_fst_QR_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&gt;</span><span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> column <span class="free">j</span> <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>fst<span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> column <span class="free">j</span> <span class="free">A</span> 
    <span class="main">=</span> column <span class="free">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span>column <span class="free">j</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> column_QR_decomposition2<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">}</span><span class="main">.</span> 
    column <span class="free">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span>column <span class="free">j</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> real_inner_class.inner_sum_right <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">}</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span>column <span class="free">j</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span><span class="main">(</span>column <span class="free">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> real_inner_class.inner_scaleR_right <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ia</span> <span class="keyword3"><span class="command">assume</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> i_not_ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">ia</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i ia <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>column <span class="free">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> column <span class="skolem">ia</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> column_eq_fst_QR_decomposition r<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>column <span class="free">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> column <span class="skolem">ia</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orthogonal_columns_fst_QR_decomposition<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"column <span class="skolem">ia</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> column <span class="free">j</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span>column <span class="free">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> column <span class="skolem">ia</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="QR_Decomposition-R_Qi_Aj"><span class="command">lemma</span></span> R_Qi_Aj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span> <span class="main">=</span> column <span class="free">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> column <span class="free">j</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> QR_decomposition_def Let_def snd_conv matrix_matrix_mult_inner_mult 
  <span class="keyword1"><span class="command">unfolding</span></span> row_transpose <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="QR_Decomposition-sums_columns_Q_0"><span class="command">lemma</span></span> sums_columns_Q_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&gt;</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> column <span class="free">b</span> <span class="free">A</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">&lt;</span><span class="skolem">i</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> column <span class="free">b</span> <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scaler_column_fst_QR_decomposition<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="QR_Decomposition-QR_decomposition_mult"><span class="command">lemma</span></span> QR_decomposition_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">**</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> column <span class="bound">b</span> <span class="free">A</span> <span class="main">=</span> column <span class="bound">b</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">**</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">**</span> snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>  
      <span class="main">=</span>  <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">∈</span>UNIV<span class="main">.</span> fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span>column <span class="bound">k</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> column <span class="bound">j</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> matrix_matrix_mult_def R_Qi_Aj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"column <span class="skolem">b</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">**</span> snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      column <span class="skolem">b</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">∈</span>UNIV<span class="main">.</span> fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span>column <span class="bound">k</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> column <span class="bound">j</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">b</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> column <span class="skolem">b</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> column_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> 
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">=</span> column <span class="skolem">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">have</span></span> f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">`</span>UNIV <span class="main">=</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> inj_f<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inj_on_def f_def column_eq_fst_QR_decomposition r<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">b</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> column <span class="skolem">b</span> <span class="free">A</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">a</span><span class="main">)</span> 
        <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> column <span class="skolem">b</span> <span class="free">A</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span><span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span><span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≤</span><span class="skolem">b</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&gt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> set_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">=</span> <span class="var">?d</span> <span class="main">∪</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?c</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> column <span class="skolem">b</span> <span class="free">A</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">a</span><span class="main">)</span> 
          <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="var">?d</span> <span class="main">∪</span> <span class="var">?f</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> column <span class="skolem">b</span> <span class="free">A</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_rw <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?d</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> column <span class="skolem">b</span> <span class="free">A</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?f</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> column <span class="skolem">b</span> <span class="free">A</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> f_def inj_eq inj_f not_le<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?d</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> column <span class="skolem">b</span> <span class="free">A</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sums_columns_Q_0<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">f</span><span class="main">`</span>UNIV<span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> column <span class="skolem">b</span> <span class="free">A</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span>UNIV<span class="main">.</span> fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">a</span> <span class="main">$</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span>column <span class="bound">k</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> column <span class="skolem">b</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> sum.reindex<span class="main">[</span><span class="operator">OF</span> inj_f<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> f_def column_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span>UNIV<span class="main">.</span> fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">a</span> <span class="main">$</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span>column <span class="bound">k</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> column <span class="skolem">b</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">b</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> column <span class="skolem">b</span> <span class="free">A</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> column <span class="skolem">b</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> column_QR_decomposition2<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="skolem">b</span> <span class="free">A</span> <span class="main">=</span> column <span class="skolem">b</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">**</span> snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> column_def vec_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="QR_Decomposition-upper_triangular_snd_QR_decomposition"><span class="command">lemma</span></span> upper_triangular_snd_QR_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"upper_triangular <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> upper_triangular_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> j_less_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">=</span> column <span class="skolem">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> column <span class="skolem">j</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> QR_decomposition_def Let_def fst_conv snd_conv
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_matrix_mult_inner_mult row_transpose <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> scaler_column_fst_QR_decomposition<span class="main">[</span><span class="operator">OF</span> j_less_i r<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="QR_Decomposition-upper_triangular_invertible"><span class="command">lemma</span></span> upper_triangular_invertible<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span>wellorder<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span>wellorder<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"upper_triangular <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invertible <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> det_R<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>prod <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span><span class="main">$</span><span class="bound">i</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'n</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> det_upperdiagonal u <span class="keyword1"><span class="command">unfolding</span></span> upper_triangular_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invertible_det_nz<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="QR_Decomposition-invertible_snd_QR_decomposition"><span class="command">lemma</span></span> invertible_snd_QR_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invertible <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> upper_triangular_invertible<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"upper_triangular <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> upper_triangular_snd_QR_decomposition<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"vec.independent <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> full_rank_imp_is_basis2
        independent_columns_Gram_Schmidt_matrix r<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> zero_not_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="main">(</span>columns <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vec.dependent_zero<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> column <span class="skolem">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> column <span class="skolem">i</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> QR_decomposition_def Let_def snd_conv fst_conv
      <span class="keyword1"><span class="command">unfolding</span></span> matrix_matrix_mult_inner_mult
      <span class="keyword1"><span class="command">unfolding</span></span> row_transpose <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> norm <span class="main">(</span>column <span class="skolem">i</span> <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> norm_uk_eq<span class="main">[</span><span class="operator">OF</span> r<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="QR_Decomposition-QR_decomposition"><span class="command">lemma</span></span> QR_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">**</span> snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">∧</span>
  pairwise orthogonal <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> norm <span class="main">(</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span>transpose <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">**</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mat <span class="main">1</span> <span class="main">∧</span>
  vec.independent <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
  col_space <span class="free">A</span> <span class="main">=</span> col_space <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  invertible <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  upper_triangular <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> QR_decomposition_mult col_space_def full_rank_imp_is_basis2 
    independent_columns_fst_QR_decomposition invertible_snd_QR_decomposition 
    norm_columns_fst_QR_decomposition orthogonal_fst_QR_decomposition 
    orthogonal_matrix_fst_QR_decomposition r span_fst_QR_decomposition 
    upper_triangular_snd_QR_decomposition<span class="main">)</span>


<span class="keyword1" id="QR_Decomposition-QR_decomposition_square"><span class="command">lemma</span></span> QR_decomposition_square<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">**</span> snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">∧</span>
  orthogonal_matrix <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  upper_triangular <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  invertible <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>    
  pairwise orthogonal <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> norm <span class="main">(</span>column <span class="bound">i</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span>      
  vec.independent <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
  col_space <span class="free">A</span> <span class="main">=</span> col_space <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  card <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>columns <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> QR_decomposition orthogonal_matrix_fst_QR_decomposition' r<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹QR for computing determinants›</span></span>

<span class="keyword1" id="QR_Decomposition-det_QR_decomposition"><span class="command">lemma</span></span> det_QR_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>det <span class="free">A</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="main">(</span>prod <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> snd<span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">$</span><span class="bound">i</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'n</span> set<span class="main">)</span><span class="main">)</span><span class="main">¦</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"fst<span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"snd<span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> det_R<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="var">?R</span> <span class="main">=</span> <span class="main">(</span>prod <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> snd<span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">$</span><span class="bound">i</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'n</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> det_upperdiagonal<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> upper_triangular_snd_QR_decomposition<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> upper_triangular_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>det <span class="free">A</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span>det <span class="var">?Q</span> <span class="main">*</span> det <span class="var">?R</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> QR_decomposition_mult det_mul r<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">¦</span>det <span class="var">?Q</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span>det <span class="var">?R</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> abs_mult <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span> <span class="main">*</span> <span class="main">¦</span>det <span class="var">?R</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> det_orthogonal_matrix<span class="main">[</span><span class="operator">OF</span> orthogonal_matrix_fst_QR_decomposition'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> r<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">¦</span>det <span class="var">?R</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">¦</span><span class="main">(</span>prod <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> snd<span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">$</span><span class="bound">i</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'n</span> set<span class="main">)</span><span class="main">)</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> det_R <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Least_Squares_Approximation">
<div class="head">
<h1>Theory Least_Squares_Approximation</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Title:      Least_Squares_Approximation.thy
    Author:     Jose Divasón &lt;jose.divasonm at unirioja.es&gt;
    Author:     Jesús Aransay &lt;jesus-maria.aransay at unirioja.es&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Least Squares Approximation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Least_Squares_Approximation
<span class="keyword2"><span class="keyword">imports</span></span>
 <a href="#QR_Decomposition">QR_Decomposition</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Second part of the Fundamental Theorem of Linear Algebra›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹See <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">url</span></span> "http://en.wikipedia.org/wiki/Fundamental_theorem_of_linear_algebra"<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Least_Squares_Approximation-null_space_orthogonal_complement_row_space"><span class="command">lemma</span></span> null_space_orthogonal_complement_row_space<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span>wellorder<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"null_space <span class="free">A</span> <span class="main">=</span> orthogonal_complement <span class="main">(</span>row_space <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> null_space_def orthogonal_complement_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xa</span> <span class="keyword3"><span class="command">assume</span></span> Ax<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> row_space <span class="free">A</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> transpose <span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xa <span class="keyword1"><span class="command">unfolding</span></span> row_space_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">v*</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">xa</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> transpose_vector y <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="skolem">x</span> <span class="skolem">xa</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_def
    <span class="keyword1"><span class="command">using</span></span> Ax dot_lmul_matrix inner_commute inner_zero_right
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ax dot_lmul_matrix inner_commute inner_zero_right<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> xa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xa</span><span class="main">∈</span>row_space <span class="free">A</span><span class="main">.</span> orthogonal <span class="skolem">x</span> <span class="bound">xa</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xa <span class="keyword1"><span class="command">unfolding</span></span> row_space_eq orthogonal_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> transpose_transpose dot_lmul_matrix inner_eq_zero_iff transpose_vector<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Least_Squares_Approximation-left_null_space_orthogonal_complement_col_space"><span class="command">lemma</span></span> left_null_space_orthogonal_complement_col_space<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span>wellorder<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"left_null_space <span class="free">A</span> <span class="main">=</span> orthogonal_complement <span class="main">(</span>col_space <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> null_space_orthogonal_complement_row_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"transpose <span class="free">A</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> left_null_space_eq_null_space_transpose
  <span class="keyword1"><span class="command">unfolding</span></span> col_space_eq_row_space_transpose <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Least Squares Approximation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹See <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">url</span></span> "https://people.math.osu.edu/husen.1/teaching/571/least_squares.pdf"<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Part 3 of the Theorem 1.7 in the previous website.›</span></span>

<span class="keyword1" id="Least_Squares_Approximation-least_squares_approximation"><span class="command">lemma</span></span> least_squares_approximation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>euclidean_space<span class="main">}</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subspace_S<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ind_X<span class="main">:</span> <span class="quoted"><span class="quoted">"independent <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> span_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> span <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> not_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_onto <span class="free">v</span> <span class="free">X</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> proj_onto <span class="free">v</span> <span class="free">X</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> S_eq_spanX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> span <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> X span_X span_subspace subspace_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"proj_onto <span class="free">v</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> not_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>norm<span class="main">(</span><span class="var">?p</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> eq_iff_diff_eq_0 norm_eq_zero not_eq power_eq_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">v</span><span class="main">-</span><span class="free">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="var">?p</span> <span class="main">+</span> <span class="var">?p</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> norm <span class="main">(</span><span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="var">?p</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="var">?p</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> add.assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="var">?p</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span>norm<span class="main">(</span><span class="var">?p</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> phytagorean_theorem_norm<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> in_orthogonal_complement_imp_orthogonal<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">-</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subspace_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subspace_S _ y<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> subspace_sum<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subspace_S<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">v</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_eq_spanX X rev_subsetD span_mul<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">-</span> <span class="var">?p</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> v_minus_p_orthogonal_complement assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>        
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">v</span><span class="main">-</span><span class="var">?p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span><span class="main">-</span><span class="free">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> norm_gt_square power2_norm_eq_inner<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Least_Squares_Approximation-least_squares_approximation2"><span class="command">lemma</span></span> least_squares_approximation2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>euclidean_space<span class="main">}</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subspace_S<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">v</span><span class="main">-</span><span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span>  ind_X<span class="main">:</span> <span class="quoted"><span class="quoted">"independent <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> span_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> span <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl orthonormal_basis_subspace subspace_S<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"proj_onto <span class="free">v</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?p</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> proj_onto <span class="free">v</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span><span class="main">=</span><span class="free">y</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="var">?p</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="var">?p</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> least_squares_approximation<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subspace_S ind_X X span_X o False y<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="var">?p</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">unfold_abs_def</span> <span class="main"><span class="main">=</span></span> <span class="quasi_keyword">false</span><span class="main">]</span><span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> proj_onto_def proj_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subspace_sum<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subspace_S <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="skolem">X</span> <span class="main">⟹</span> proj <span class="free">v</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> proj_def X rev_subsetD subspace_S subspace_mul<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">-</span> <span class="var">?p</span><span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> v_minus_p_orthogonal_complement<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subspace_S ind_X X span_X o<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> least_squares_approximation3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>euclidean_space<span class="main">}</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subspace_S<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">v</span><span class="main">-</span><span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span>  ind_X<span class="main">:</span> <span class="quoted"><span class="quoted">"independent <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> span_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> span <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl orthonormal_basis_subspace subspace_S<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"proj_onto <span class="free">v</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?p</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span><span class="free">S</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="var">?p</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span><span class="main">=</span><span class="skolem">y</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="var">?p</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> least_squares_approximation<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subspace_S ind_X X span_X o False y<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">-</span> <span class="var">?p</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> v_minus_p_orthogonal_complement<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subspace_S ind_X X span_X o<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> proj_onto_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subspace_sum<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subspace_S <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">⟹</span> proj <span class="free">v</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Projections.proj_def X subset_iff subspace_S subspace_mul<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Least_Squares_Approximation-norm_least_squares"><span class="command">lemma</span></span> norm_least_squares<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span>wellorder<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x'</span><span class="main">.</span> norm <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">∈</span>col_space <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>col_space <span class="free">A</span><span class="main">.</span> norm <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">b</span><span class="main">-</span><span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> orthogonal_complement <span class="main">(</span>col_space <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> least_squares_approximation3<span class="main">[</span><span class="operator">OF</span> subspace_col_space<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> subspace_vec_eq<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> col_space <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>col_space <span class="free">A</span><span class="main">.</span> norm <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bp_orthogonal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> orthogonal_complement <span class="main">(</span>col_space <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">unfolding</span></span> col_space_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">x'</span> <span class="main">∈</span> col_space <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> col_space_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> least <span class="keyword1"><span class="command">unfolding</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">set_least_squares_approximation</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> norm <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">*v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">*v</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">corollary</span></span> least_squares_approximation4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>euclidean_space<span class="main">}</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subspace_S<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound"><span class="bound">p</span></span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span>  ind_X<span class="main">:</span> <span class="quoted"><span class="quoted">"independent <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> span_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> span <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl orthonormal_basis_subspace subspace_S<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"sum <span class="main">(</span>proj <span class="free">v</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?p</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span>  <span class="operator">rule</span> subspace_sum<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subspace_S <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">⟹</span> proj <span class="free">v</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Projections.proj_def X subset_iff subspace_S subspace_mul<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="var">?p</span><span class="main">}</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="var">?p</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> X ind_X least_squares_approximation  o span_X subspace_S proj_onto_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> Diff_iff singletonI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ya</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">ya</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> member_remove not_less_iff_gr_or_eq remove_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">corollary</span></span> least_squares_approximation4'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>euclidean_space<span class="main">}</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subspace_S<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound"><span class="bound">p</span></span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> ind_X<span class="main">:</span> <span class="quoted"><span class="quoted">"independent <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> span_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> span <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl orthonormal_basis_subspace subspace_S<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"sum <span class="main">(</span>proj <span class="free">v</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?p</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subspace_sum<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subspace_S <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">⟹</span> proj <span class="free">v</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Projections.proj_def X subset_iff subspace_S subspace_mul<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="var">?p</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> proj_onto_def X dual_order.refl ind_X 
         least_squares_approximation less_imp_le o span_X subspace_S<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ya</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">ya</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> a_uniq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">∈</span><span class="free">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">∈</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="bound">b</span><span class="main">}</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">b</span><span class="main">=</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> least_squares_approximation4<span class="main">[</span><span class="operator">OF</span> subspace_S<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">=</span><span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p p' a_uniq leD  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a a' member_remove remove_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span><span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y y' a_uniq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a a' leD member_remove remove_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> least_squares_approximation5<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>euclidean_space<span class="main">}</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subspace_S<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound"><span class="bound">p</span></span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="free">v</span><span class="main">-</span><span class="bound">p</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span>  ind_X<span class="main">:</span> <span class="quoted"><span class="quoted">"independent <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> span_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> span <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl orthonormal_basis_subspace subspace_S<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"sum <span class="main">(</span>proj <span class="free">v</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">-</span> <span class="bound">p</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?p</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subspace_sum<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subspace_S <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">⟹</span> proj <span class="free">v</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Projections.proj_def X rev_subsetD subspace_S subspace_mul<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="var">?p</span><span class="main">}</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="var">?p</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> least_squares_approximation<span class="main">[</span><span class="operator">OF</span> subspace_S ind_X X span_X o<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> member_remove remove_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">-</span> <span class="var">?p</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> X ind_X o span_X subspace_S v_minus_p_orthogonal_complement proj_onto_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="var">?p</span><span class="main">}</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="var">?p</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">-</span> <span class="var">?p</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">-</span> <span class="skolem">p</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ya</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">ya</span><span class="main">)</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">-</span> <span class="skolem">y</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">=</span><span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> least_squares_approximation4 p p' subspace_S y y'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> least_squares_approximation5'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>euclidean_space<span class="main">}</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subspace_S<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound"><span class="bound">p</span></span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="free">v</span><span class="main">-</span><span class="bound">p</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> least_squares_approximation3 least_squares_approximation4' subspace_S<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> least_squares_approximation6<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>euclidean_space<span class="main">}</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subspace_S<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">∈</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">-</span><span class="free">p</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="free">v</span><span class="main">-</span><span class="skolem">a</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">∈</span><span class="free">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="free">v</span><span class="main">-</span><span class="bound">b</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">b</span><span class="main">=</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> least_squares_approximation5'<span class="main">[</span><span class="operator">OF</span> subspace_S<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a a' assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> least_squares_approximation4' subspace_S<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">corollary</span></span> least_squares_approximation7<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>euclidean_space<span class="main">}</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subspace_S<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">-</span> <span class="free">p</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">∈</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> norm <span class="main">(</span><span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> add_diff_cancel_left add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add_diff_add add_diff_cancel<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> norm <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> phytagorean_theorem_norm<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> in_orthogonal_complement_imp_orthogonal<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> subspace_S subspace_diff<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">-</span> <span class="free">p</span> <span class="main">∈</span> orthogonal_complement <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span><span class="main">≤</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> norm_ge_zero power2_le_imp_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Least_Squares_Approximation-in_set_least_squares_approximation"><span class="command">lemma</span></span> in_set_least_squares_approximation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> wellorder<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">-</span> <span class="free">b</span> <span class="main">∈</span> orthogonal_complement <span class="main">(</span>col_space <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set_least_squares_approximation <span class="free">A</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> set_least_squares_approximation_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" norm <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> least_squares_approximation7<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subspace <span class="main">(</span>col_space <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subspace_col_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">,</span> <span class="operator">unfolded</span> subspace_vec_eq<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">∈</span> orthogonal_complement <span class="main">(</span>col_space <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> o subspace_orthogonal_complement<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>col_space <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> minus_diff_eq subspace_neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">∈</span> col_space <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> col_space_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">y</span> <span class="main">∈</span> col_space <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> col_space_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Least_Squares_Approximation-in_set_least_squares_approximation_eq"><span class="command">lemma</span></span> in_set_least_squares_approximation_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span>wellorder<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set_least_squares_approximation <span class="free">A</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> transpose <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set_least_squares_approximation <span class="free">A</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> norm <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_least_squares_approximation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">∈</span> orthogonal_complement <span class="main">(</span>col_space <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> least_squares_approximation6<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subspace <span class="main">(</span>col_space <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subspace_col_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">,</span> <span class="operator">unfolded</span> subspace_vec_eq<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">∈</span> col_space <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> col_space_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>col_space <span class="free">A</span><span class="main">.</span> norm <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">unfolding</span></span> col_space_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">∈</span> null_space <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> null_space_orthogonal_complement_row_space
    <span class="keyword1"><span class="command">unfolding</span></span> col_space_eq_row_space_transpose <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"transpose <span class="free">A</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> null_space_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_iff_diff_eq_0 matrix_vector_mul_assoc matrix_vector_right_distrib_minus<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> transpose <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_self matrix_vector_mul_assoc matrix_vector_right_distrib_minus<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> null_space <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> null_space_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> orthogonal_complement <span class="main">(</span>col_space <span class="free">A</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> left_null_space_eq_null_space_transpose left_null_space_orthogonal_complement_col_space<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set_least_squares_approximation <span class="free">A</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_set_least_squares_approximation<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Least_Squares_Approximation-in_set_least_squares_approximation_eq_full_rank"><span class="command">lemma</span></span> in_set_least_squares_approximation_eq_full_rank<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span>mod_type<span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span>mod_type"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set_least_squares_approximation <span class="free">A</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> matrix_inv <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span><span class="main">**</span>transpose <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> int_tA<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invertible_transpose_mult<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_least_squares_approximation <span class="free">A</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">x</span> <span class="main">=</span> transpose <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_set_least_squares_approximation_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> matrix_inv <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span> <span class="main">**</span> transpose <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> int_tA matrix_inv_left matrix_vector_mul_assoc matrix_vector_mul_lid<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> matrix_inv <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span> <span class="main">**</span> transpose <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">x</span> <span class="main">=</span> transpose <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> int_tA matrix_inv_right matrix_vector_mul_assoc matrix_vector_mul_lid<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_least_squares_approximation <span class="free">A</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> in_set_least_squares_approximation_eq <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1" id="Least_Squares_Approximation-in_set_least_squares_approximation_eq_full_rank_QR"><span class="command">lemma</span></span> in_set_least_squares_approximation_eq_full_rank_QR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set_least_squares_approximation <span class="free">A</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> transpose <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> inv_tR<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible <span class="main">(</span>transpose <span class="var">?R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invertible_snd_QR_decomposition invertible_transpose r<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inv_inv_tR<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible <span class="main">(</span>matrix_inv <span class="main">(</span>transpose <span class="var">?R</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_tR invertible_fst_Gauss_Jordan_PA matrix_inv_Gauss_Jordan_PA<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set_least_squares_approximation <span class="free">A</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> transpose <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_set_least_squares_approximation_eq <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>transpose <span class="main">(</span><span class="var">?Q</span> <span class="main">**</span> <span class="var">?R</span><span class="main">)</span> <span class="main">**</span> <span class="main">(</span><span class="var">?Q</span> <span class="main">**</span> <span class="var">?R</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> transpose <span class="main">(</span><span class="var">?Q</span> <span class="main">**</span> <span class="var">?R</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> QR_decomposition_mult<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>transpose <span class="var">?R</span> <span class="main">**</span> transpose <span class="var">?Q</span> <span class="main">**</span>  <span class="main">(</span><span class="var">?Q</span> <span class="main">**</span> <span class="var">?R</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">x</span>  <span class="main">=</span> transpose <span class="var">?R</span> <span class="main">**</span> transpose <span class="var">?Q</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> matrix_transpose_mul<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>transpose <span class="var">?R</span> <span class="keyword1">*v</span> <span class="main">(</span>transpose <span class="var">?Q</span> <span class="main">**</span> <span class="main">(</span><span class="var">?Q</span> <span class="main">**</span> <span class="var">?R</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span>  <span class="main">=</span> transpose <span class="var">?R</span> <span class="keyword1">*v</span> <span class="main">(</span>transpose <span class="var">?Q</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> matrix_vector_mul_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>matrix_inv <span class="main">(</span>transpose <span class="var">?R</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="main">(</span>transpose <span class="var">?R</span> <span class="keyword1">*v</span> <span class="main">(</span>transpose <span class="var">?Q</span> <span class="main">**</span> <span class="main">(</span><span class="var">?Q</span> <span class="main">**</span> <span class="var">?R</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>  
    <span class="main">=</span> matrix_inv <span class="main">(</span>transpose <span class="var">?R</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="main">(</span>transpose <span class="var">?R</span> <span class="keyword1">*v</span> <span class="main">(</span>transpose <span class="var">?Q</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv_matrix_vector_mul_left<span class="main">[</span><span class="operator">OF</span> inv_inv_tR<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>matrix_inv <span class="main">(</span>transpose <span class="var">?R</span><span class="main">)</span> <span class="main">**</span> transpose <span class="var">?R</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="main">(</span>transpose <span class="var">?Q</span> <span class="main">**</span> <span class="main">(</span><span class="var">?Q</span> <span class="main">**</span> <span class="var">?R</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span>  
    <span class="main">=</span> <span class="main">(</span>matrix_inv <span class="main">(</span>transpose <span class="var">?R</span><span class="main">)</span> <span class="main">**</span> transpose <span class="var">?R</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="main">(</span>transpose <span class="var">?Q</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> matrix_vector_mul_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>transpose <span class="var">?Q</span> <span class="main">**</span> <span class="main">(</span><span class="var">?Q</span> <span class="main">**</span> <span class="var">?R</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> transpose <span class="var">?Q</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_inv_left<span class="main">[</span><span class="operator">OF</span> inv_tR<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_vector_mul_lid <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>transpose <span class="var">?Q</span> <span class="main">**</span> <span class="var">?Q</span><span class="main">)</span> <span class="main">**</span> <span class="var">?R</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> transpose <span class="var">?Q</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> matrix_mul_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="var">?R</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> transpose <span class="var">?Q</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_matrix_fst_QR_decomposition<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_mul_lid <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set_least_squares_approximation <span class="free">A</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?R</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>transpose <span class="var">?Q</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*TODO: Maybe demonstrate that in this case there's only one solution.*)</span>
<span class="keyword1"><span class="command">corollary</span></span> in_set_least_squares_approximation_eq_full_rank_QR2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set_least_squares_approximation <span class="free">A</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> matrix_inv <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">**</span> transpose <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> inv_R<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invertible_snd_QR_decomposition r<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set_least_squares_approximation <span class="free">A</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?R</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> transpose <span class="var">?Q</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_set_least_squares_approximation_eq_full_rank_QR<span class="main">[</span><span class="operator">OF</span> r<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>matrix_inv <span class="var">?R</span> <span class="main">**</span> <span class="var">?R</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> matrix_inv <span class="var">?R</span> <span class="main">**</span> transpose <span class="var">?Q</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> Gauss_Jordan_PA_eq calculation fst_Gauss_Jordan_PA inv_R 
      inv_matrix_vector_mul_left invertible_fst_Gauss_Jordan_PA matrix_inv_Gauss matrix_vector_mul_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> matrix_inv <span class="var">?R</span> <span class="main">**</span> transpose <span class="var">?Q</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_R matrix_inv_left matrix_vector_mul_lid<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set_least_squares_approximation <span class="free">A</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> matrix_inv <span class="var">?R</span> <span class="main">**</span> transpose <span class="var">?Q</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Least_Squares_Approximation-set_least_squares_approximation_unique_solution"><span class="command">lemma</span></span> set_least_squares_approximation_unique_solution<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set_least_squares_approximation <span class="free">A</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>matrix_inv <span class="main">(</span>transpose <span class="free">A</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span><span class="main">**</span>transpose <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> empty_iff in_set_least_squares_approximation_eq_full_rank
    empty_iff insertI1 r subsetI subset_singletonD<span class="main">)</span>

<span class="keyword1" id="Least_Squares_Approximation-set_least_squares_approximation_unique_solution_QR"><span class="command">lemma</span></span> set_least_squares_approximation_unique_solution_QR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="free">A</span> <span class="main">=</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set_least_squares_approximation <span class="free">A</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>matrix_inv <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">**</span> transpose <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> empty_iff in_set_least_squares_approximation_eq_full_rank_QR2 insertI1 r subsetI subset_singletonD<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Examples_QR_Abstract_Float">
<div class="head">
<h1>Theory Examples_QR_Abstract_Float</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Title:      Examples_QR_Abstract_Float.thy
    Author:     Jose Divasón &lt;jose.divasonm at unirioja.es&gt;
    Author:     Jesús Aransay &lt;jesus-maria.aransay at unirioja.es&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Examples of execution using floats›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Examples_QR_Abstract_Float
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#QR_Decomposition">QR_Decomposition</a>
  <a href="../../gauss_jordan/theories/#Code_Real_Approx_By_Float_Haskell">Gauss_Jordan.Code_Real_Approx_By_Float_Haskell</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Examples›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span> 
  matrix_to_list_of_list <span class="main">(</span>divide_by_norm <span class="bound">A</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example2</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span>
  matrix_to_list_of_list <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example3</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span>
  matrix_to_list_of_list <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example4</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span>
  matrix_to_list_of_list <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span> <span class="main">**</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example5</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span>sqrt <span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span>sqrt <span class="numeral">5</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span>sqrt <span class="numeral">7</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span>
  matrix_to_list_of_list <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">example1</span></span> <span class="quoted"><span class="quoted">example2</span></span> <span class="quoted"><span class="quoted">example3</span></span> <span class="quoted"><span class="quoted">example4</span></span> <span class="quoted"><span class="quoted">example5</span></span> <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> <span class="quoted">"QR"</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Examples_QR_Abstract_Symbolic">
<div class="head">
<h1>Theory Examples_QR_Abstract_Symbolic</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Title:      Examples_QR_Abstract_Symbolic.thy
    Author:     Jose Divasón &lt;jose.divasonm at unirioja.es&gt;
    Author:     Jesús Aransay &lt;jesus-maria.aransay at unirioja.es&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Examples of execution using symbolic computation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Examples_QR_Abstract_Symbolic
<span class="keyword2"><span class="keyword">imports</span></span>
 <a href="#QR_Decomposition">QR_Decomposition</a>
 <a href="../../real_impl/theories/#Real_Unique_Impl">Real_Impl.Real_Unique_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Execution of the QR decomposition using symbolic computation›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Some previous definitions and lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The symbolic computation is based on the René Thiemann's work about implementing
field extensions of the form Q[sqrt(b)].›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">show_vec_real</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> show_real <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vec_nth <span class="main">(</span>show_vec_real <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">%</span> <span class="bound">i</span><span class="main">.</span> show_real <span class="main">(</span><span class="free">v</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> show_vec_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">show_matrix_real</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> show_vec_real <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span><span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vec_nth <span class="main">(</span>show_matrix_real <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">%</span> <span class="bound">i</span><span class="main">.</span> show_vec_real <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> show_matrix_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Examples›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span> 
  matrix_to_list_of_list <span class="main">(</span>show_matrix_real <span class="main">(</span>divide_by_norm <span class="bound">A</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span>
  matrix_to_list_of_list <span class="main">(</span>show_matrix_real <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span>
  matrix_to_list_of_list <span class="main">(</span>show_matrix_real <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span>
  matrix_to_list_of_list <span class="main">(</span>show_matrix_real <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">**</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span> <span class="keyword1">in</span>
  matrix_to_list_of_list <span class="main">(</span>show_matrix_real <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">**</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">(*Case m ≥ n and dependent columns*)</span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">9</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">2</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">2</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span> <span class="keyword1">in</span>
  matrix_to_list_of_list <span class="main">(</span>show_matrix_real <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">**</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">9</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">2</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">2</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span> <span class="keyword1">in</span>
  matrix_to_list_of_list <span class="main">(</span>show_matrix_real <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">9</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">2</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">2</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span> <span class="keyword1">in</span>
  vec_to_list <span class="main">(</span>show_vec_real <span class="main">(</span><span class="main">(</span>column <span class="main">0</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">9</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">2</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">2</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span> <span class="keyword1">in</span>
  vec_to_list <span class="main">(</span>show_vec_real <span class="main">(</span><span class="main">(</span>column <span class="main">1</span> <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">9</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">2</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">2</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span> <span class="keyword1">in</span>
  matrix_to_list_of_list <span class="main">(</span>show_matrix_real <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">(*R is not invertible*)</span>

<span class="comment1">(*Case m &lt; n and dependent columns*)</span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">9</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">in</span>
  matrix_to_list_of_list <span class="main">(</span>show_matrix_real <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">**</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">9</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">in</span>
  matrix_to_list_of_list <span class="main">(</span>show_matrix_real <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">9</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">in</span>
  matrix_to_list_of_list <span class="main">(</span>show_matrix_real <span class="main">(</span><span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(*
  Limitation: if the input matrix has irrational numbers, then probably we won't be working in the same
  field extension so the computation will fail.
*)</span>

<span class="comment1">(*
value "let A = list_of_list_to_matrix [[1,sqrt 2,4],[sqrt 5,4,5],[0,sqrt 7,4]]::real^3^3 in
  matrix_to_list_of_list (show_matrix_real ((fst (QR_decomposition A))))"
*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">9</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">in</span>
  matrix_to_list_of_list <span class="main">(</span>show_matrix_real <span class="main">(</span><span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">example1</span></span> <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> QR

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IArray_Addenda_QR">
<div class="head">
<h1>Theory IArray_Addenda_QR</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Title:      IArray_Addenda_QR.thy
    Author:     Jose Divasón &lt;jose.divasonm at unirioja.es&gt;
    Author:     Jesús Aransay &lt;jesus-maria.aransay at unirioja.es&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹IArray Addenda QR›</span></span>

<span class="keyword1"><span class="command">theory</span></span> IArray_Addenda_QR
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/IArray.html">HOL-Library.IArray</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The new file about Iarrays, with different instantiations from the presented ones in the 
Gauss-Jordan algorithm.

In order to make the formalisation of the QR algorithm easier, we have decided to present here some
alternative instantiatons for immutable arrays. 

Let see an example. The following definition is the one presented in the Gauss-Jordan AFP entry to
sum two vectors:

<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>plus_iarray A B =  IArray.of_fun (λn. A!!n + B !! n) (IArray.length A)›</span></span></span></span>

While the following is the one we will present in this development:

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> [display] <span class="raw_text"><span class="raw_text">"plus_iarray A B =
  (let length_A = (IArray.length A);
  length_B= (IArray.length B);
  n=max length_A length_B ;
  A'= IArray.of_fun (λa. if a &lt; length_A then A!!a else 0) n;
  B'=IArray.of_fun (λa. if a &lt; length_B then B!!a else 0) n
  in IArray.of_fun (λa. A' !! a + B' !! a) n)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

Now the sum is done up to the length of the shortest vector and it is completed with zeros up to
the length of the largest vector. This allows us to prove that iarray is an instance of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>comm_monoid_add›</span></span></span></span>, which is quite useful for the QR algorithm (we will be able to do
sums involving immutable arrays).

These are just alternative definitions of the main operations over immutable arrays. They have the 
advantage of being an instance of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>comm_monoid_add›</span></span></span></span>; nevertheless, the performance is slower
and proofs become more cumbersome. The user should decide what definitions to use (the presented 
here or the presented ones in the Gauss-Jordan AFP entry) depending on the algorithm to formalise.
›</span></span>

<span class="keyword1" id="IArray_Addenda_QR-iarray_exhaust2"><span class="command">lemma</span></span> iarray_exhaust2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>IArray.list_of <span class="free">xs</span> <span class="main">=</span> IArray.list_of <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iarray.exhaust list_of.simps<span class="main">)</span>

<span class="keyword1" id="IArray_Addenda_QR-of_fun_nth"><span class="command">lemma</span></span> of_fun_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>IArray.of_fun <span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> IArray.of_fun_def <span class="keyword1"><span class="command">using</span></span> map_nth i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Some previous instances›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> iarray <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">{</span>plus<span class="main">,</span>zero<span class="main">}</span>"</span></span><span class="main">)</span> <span class="quoted">plus</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">plus_iarray</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> iarray <span class="main">⇒</span> <span class="tfree">'a</span> iarray <span class="main">⇒</span> <span class="tfree">'a</span> iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">plus_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">length_A</span> <span class="main">=</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">;</span>
  <span class="bound">length_B</span><span class="main">=</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">;</span>
  <span class="bound">n</span><span class="main">=</span>max <span class="bound">length_A</span> <span class="bound">length_B</span> <span class="main">;</span> 
  <span class="bound">A'</span><span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="bound">length_A</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="bound">n</span><span class="main">;</span>
  <span class="bound">B'</span><span class="main">=</span>IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="bound">length_B</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">!!</span><span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="bound">n</span>
  <span class="keyword1">in</span>
  IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">A'</span> <span class="main">!!</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">B'</span> <span class="main">!!</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> iarray <span class="main">::</span> <span class="main">(</span><span class="quoted">zero</span><span class="main">)</span> <span class="quoted">zero</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">zero_iarray</span></span> <span class="main">=</span> <span class="main">(</span>IArray<span class="main">[]</span><span class="main">::</span><span class="tfree">'a</span> iarray<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> iarray <span class="main">::</span> <span class="main">(</span><span class="quoted">comm_monoid_add</span><span class="main">)</span> <span class="quoted">comm_monoid_add</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instance</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> iarray"</span></span>
  <span class="keyword1"><span class="command">have</span></span> max_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>max <span class="main">(</span>IArray.length <span class="main">0</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span><span class="main">(</span>IArray.length <span class="skolem">a</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span>length <span class="main">(</span>IArray.list_of <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span> iarray<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>IArray.list_of <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>IArray.list_of <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list_of.simps max_0L zero_iarray_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span>IArray.length <span class="main">0</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> IArray.length <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IArray.length_def list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list_of.simps zero_iarray_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> length0<span class="main">:</span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> zero_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> iarray_exhaust2 list_eq_iff_nth_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> IArray.length_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> IArray.sub_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> length_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> IArray.length <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> plus_iarray_def Let_def <span class="keyword1"><span class="command">using</span></span> max_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_eq i<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">aa</span><span class="main">.</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="skolem">a</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">aa</span> <span class="main">+</span>
      IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">aa</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">aa</span> <span class="main">&lt;</span> IArray.length <span class="skolem">a</span> <span class="keyword1">then</span> <span class="skolem">a</span> <span class="main">!!</span> <span class="bound">aa</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="skolem">a</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">aa</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> plus_iarray_def Let_def 
      <span class="keyword1"><span class="command">unfolding</span></span> max_eq <span class="keyword1"><span class="command">unfolding</span></span> length0 <span class="keyword1"><span class="command">unfolding</span></span> sub_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> of_fun_nth<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i2<span class="main"><span class="main">]</span></span><span class="main">)</span>   
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">aa</span><span class="main">.</span> <span class="main">0</span> <span class="main">+</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">aa</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">aa</span> <span class="main">&lt;</span> IArray.length <span class="skolem">a</span> <span class="keyword1">then</span> <span class="skolem">a</span> <span class="main">!!</span> <span class="bound">aa</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="skolem">a</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">aa</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>    
      <span class="keyword1"><span class="command">using</span></span> i2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="skolem">a</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">=</span>  <span class="skolem">a</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> iarray_exhaust2 list_eq_iff_nth_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> IArray.length_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> IArray.sub_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> max_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>max <span class="main">(</span>IArray.length <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> IArray.length <span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> plus_iarray_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> length_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> IArray.length <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> plus_iarray_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span><span class="skolem">b</span><span class="main">+</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> length_eq <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> i3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i max_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> i4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i3 max.commute<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> plus_iarray_def Let_def 
      <span class="keyword1"><span class="command">unfolding</span></span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> i3<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> i4<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> iarray_exhaust2 list_eq_iff_nth_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> IArray.length_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> IArray.sub_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> length_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> IArray.length <span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> plus_iarray_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="main">(</span>max <span class="main">(</span>IArray.length <span class="main">(</span>IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">aa</span><span class="main">.</span> IArray.of_fun 
      <span class="main">(</span><span class="main">λ</span><span class="bound">aa</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">aa</span> <span class="main">&lt;</span> IArray.length <span class="skolem">a</span> <span class="keyword1">then</span> <span class="skolem">a</span> <span class="main">!!</span> <span class="bound">aa</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">aa</span> <span class="main">+</span>
      IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">b</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">aa</span><span class="main">)</span>
      <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="skolem">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>IArray.length <span class="skolem">c</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> plus_iarray_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> i3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="main">(</span>IArray.of_fun
      <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">b</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span> <span class="main">+</span>
      IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="skolem">c</span> <span class="keyword1">then</span> <span class="skolem">c</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span><span class="main">)</span>
      <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> plus_iarray_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> plus_iarray_def <span class="keyword1"><span class="command">unfolding</span></span> Let_def
      <span class="keyword1"><span class="command">unfolding</span></span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> i2<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> i3<span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> i2 i3
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> iarray <span class="main">::</span> <span class="main">(</span><span class="quoted">uminus</span><span class="main">)</span> <span class="quoted">uminus</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">uminus_iarray</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> iarray  <span class="main">⇒</span> <span class="tfree">'a</span> iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">uminus_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>  <span class="main">=</span>  IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> iarray <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">{</span>minus<span class="main">,</span>zero<span class="main">}</span>"</span></span><span class="main">)</span> <span class="quoted">minus</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">minus_iarray</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> iarray <span class="main">⇒</span> <span class="tfree">'a</span> iarray <span class="main">⇒</span> <span class="tfree">'a</span> iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">minus_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">length_A</span><span class="main">=</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">;</span>
  <span class="bound">length_B</span><span class="main">=</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">;</span>
  <span class="bound">n</span><span class="main">=</span>max <span class="bound">length_A</span> <span class="bound">length_B</span> <span class="main">;</span> 
  <span class="bound">A'</span><span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="bound">length_A</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="bound">n</span><span class="main">;</span>
  <span class="bound">B'</span><span class="main">=</span>IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="bound">length_B</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">!!</span><span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="bound">n</span>
  <span class="keyword1">in</span>
  IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">A'</span> <span class="main">!!</span> <span class="bound">a</span> <span class="main">-</span> <span class="bound">B'</span> <span class="main">!!</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Some previous definitions and properties for IArrays›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Lemmas›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> iarray <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">all</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>IArray <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ALL</span> <span class="bound">a</span> <span class="main">:</span> set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> all

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> iarray <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">exists</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>IArray <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">EX</span> <span class="bound">a</span> <span class="main">:</span> set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> exists

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Code generation›</span></span>

<span class="keyword1"><span class="command">code_printing</span></span> 
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"IArray_Addenda_QR.exists"</span></span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"Vector.exists"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"IArray_Addenda_QR.all"</span></span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"Vector.all"</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Matrix_To_IArray_QR">
<div class="head">
<h1>Theory Matrix_To_IArray_QR</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Title:      Matrix_To_IArray_QR.thy
    Author:     Jose Divasón &lt;jose.divasonm at unirioja.es&gt;
    Author:     Jesús Aransay &lt;jesus-maria.aransay at unirioja.es&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Matrices as nested IArrays›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Matrix_To_IArray_QR
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../../rank_nullity_theorem/theories/#Mod_Type">Rank_Nullity_Theorem.Mod_Type</a>
  <a href="../../gauss_jordan/theories/#Elementary_Operations">Gauss_Jordan.Elementary_Operations</a>
  <a href="#IArray_Addenda_QR">IArray_Addenda_QR</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The file is similar to the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Matrix_To_IArray.thy›</span></span></span></span> one, presented in the Gauss-Jordan
algorithm. But now, some proofs have changed slightly because of the new instantiations presented
in the file <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>IArray_Addenda_QR.thy›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Isomorphism between matrices implemented by vecs and matrices implemented by iarrays›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Isomorphism between vec and iarray›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vec_to_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'a</span> iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">vec_to_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">$</span> <span class="main">(</span>from_nat <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iarray_to_vec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> iarray <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">iarray_to_vec</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="main">(</span>to_nat <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="comment1">(*
  definition iarray_to_vec_option :: "'a iarray ⇒ ('a^'n::{mod_type}) option"
  where "iarray_to_vec_option A = (if (IArray.length A) = CARD('n)
  then Some (χ i::'n. A!!(to_nat i)) 
  else None)"
  *)</span>

<span class="keyword1" id="Matrix_To_IArray_QR-vec_to_iarray_nth"><span class="command">lemma</span></span> vec_to_iarray_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$</span> <span class="main">(</span>from_nat <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_def <span class="keyword1"><span class="command">using</span></span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-vec_to_iarray_nth'"><span class="command">lemma</span></span> vec_to_iarray_nth'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!!</span> <span class="main">(</span>to_nat <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> to_nat_less_card<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="free">i</span><span class="main">&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_to_nat<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span><span class="main"><span class="main">=</span></span><span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_def <span class="keyword1"><span class="command">unfolding</span></span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> to_nat_less_card<span class="main">]</span> from_nat_to_nat_id <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-iarray_to_vec_nth"><span class="command">lemma</span></span> iarray_to_vec_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>iarray_to_vec <span class="free">A</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> <span class="free">A</span> <span class="main">!!</span> <span class="main">(</span>to_nat <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> iarray_to_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Matrix_To_IArray_QR-vec_to_iarray_morph"><span class="command">lemma</span></span> vec_to_iarray_morph<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">=</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>vec_to_iarray <span class="free">A</span> <span class="main">=</span> vec_to_iarray <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vec_eq_iff vec_to_iarray_nth'<span class="main">)</span>

<span class="keyword1" id="Matrix_To_IArray_QR-inj_vec_to_iarray"><span class="command">lemma</span></span> inj_vec_to_iarray<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj vec_to_iarray"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vec_to_iarray_morph <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1" id="Matrix_To_IArray_QR-iarray_to_vec_vec_to_iarray"><span class="command">lemma</span></span> iarray_to_vec_vec_to_iarray<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"iarray_to_vec <span class="main">(</span>vec_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">=</span><span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> vec_to_iarray_def iarray_to_vec_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">vector</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="skolem">i</span><span class="main">&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bij_to_nat<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span><span class="main"><span class="main">=</span></span><span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> to_nat <span class="skolem">i</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-vec_to_iarray_iarray_to_vec"><span class="command">lemma</span></span> vec_to_iarray_iarray_to_vec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> length_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"IArray.length <span class="free">A</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_to_iarray <span class="main">(</span>iarray_to_vec <span class="free">A</span><span class="main">::</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> vec_to_iarray_def iarray_to_vec_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">vector</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> IArray <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iarray.exhaust<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> IArray.list_of <span class="free">A</span> <span class="main">!</span> to_nat <span class="main">(</span>from_nat <span class="bound">i</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> xs iarray.inject list_eq_iff_nth_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length_eq <span class="keyword1"><span class="command">unfolding</span></span> xs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> to_nat <span class="main">(</span>from_nat <span class="skolem">i</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> to_nat_from_nat_id<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-length_vec_to_iarray"><span class="command">lemma</span></span> length_vec_to_iarray<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xa</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>vec_to_iarray <span class="free">xa</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Isomorphism between matrix and nested iarrays›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">matrix_to_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">matrix_to_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> IArray <span class="main">(</span>map <span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="main">(</span><span class="main">($)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span>from_nat<span class="main">::</span>nat<span class="main">=&gt;</span><span class="tfree">'m</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'m</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iarray_to_matrix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> iarray iarray <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">iarray_to_matrix</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="main">(</span>to_nat <span class="bound">i</span><span class="main">)</span> <span class="main">!!</span> <span class="main">(</span>to_nat <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-matrix_to_iarray_morph"><span class="command">lemma</span></span> matrix_to_iarray_morph<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">=</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span> <span class="main">=</span> matrix_to_iarray <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">unfolding</span></span> forall_from_nat_rw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> vec_to_iarray <span class="main">(</span><span class="free">B</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> from_nat_to_nat_id vec_eq_iff vec_to_iarray_morph<span class="main">)</span>

<span class="keyword1" id="Matrix_To_IArray_QR-matrix_to_iarray_eq_of_fun"><span class="command">lemma</span></span> matrix_to_iarray_eq_of_fun<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'columns</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vec_eq_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>to_nat <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> n_eq_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">=</span>IArray.length <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="free">A</span> <span class="main">=</span> IArray.of_fun <span class="free">f</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> IArray.of_fun_def matrix_to_iarray_def iarray.inject list_eq_iff_nth_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'rows</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n_eq_length <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'rows</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> i_less_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vec_eq_f  <span class="keyword1"><span class="command">using</span></span> i_less_n
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> to_nat_from_nat_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-map_vec_to_iarray_rw"><span class="command">lemma</span></span> map_vec_to_iarray_rw<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'columns</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'rows</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> to_nat <span class="free">i</span> <span class="main">=</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> i_less_card<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="free">i</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'rows</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_to_nat<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span><span class="main"><span class="main">=</span></span><span class="tfree"><span class="quoted"><span class="tfree">'rows</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'rows</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> to_nat <span class="free">i</span> 
    <span class="main">=</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="main">(</span>to_nat <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> from_nat_to_nat_id <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Matrix_To_IArray_QR-matrix_to_iarray_nth"><span class="command">lemma</span></span> matrix_to_iarray_nth<span class="main">:</span>
  <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="free">A</span> <span class="main">!!</span> to_nat <span class="free">i</span> <span class="main">!!</span> to_nat <span class="free">j</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def o_def <span class="keyword1"><span class="command">using</span></span> vec_to_iarray_nth' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Matrix_To_IArray_QR-vec_matrix"><span class="command">lemma</span></span> vec_matrix<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_to_iarray <span class="main">(</span><span class="free">A</span><span class="main">$</span><span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!!</span> <span class="main">(</span>to_nat <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def o_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Matrix_To_IArray_QR-iarray_to_matrix_matrix_to_iarray"><span class="command">lemma</span></span> iarray_to_matrix_matrix_to_iarray<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'columns</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"iarray_to_matrix <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def iarray_to_matrix_def o_def  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">vector</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> IArray.sub_def vec_to_iarray_nth'<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Definition of operations over matrices implemented by iarrays›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mult_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>times<span class="main">}</span> iarray <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mult_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">row_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray iarray <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">row_iarray</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">column_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray iarray  <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">column_iarray</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="bound">m</span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nrows_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> iarray iarray <span class="main">=&gt;</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">nrows_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ncols_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> iarray iarray <span class="main">=&gt;</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ncols_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> IArray.length <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rows_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span>row_iarray <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span>nrows_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">columns_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span>column_iarray <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span>ncols_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tabulate2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> <span class="main">(</span>nat <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">tabulate2</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> IArray.of_fun <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">transpose_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> iarray iarray <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">transpose_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span>  tabulate2 <span class="main">(</span>ncols_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>nrows_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="bound">b</span><span class="main">!!</span><span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">matrix_matrix_mult_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>times<span class="main">,</span> comm_monoid_add<span class="main">}</span> iarray iarray <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray iarray <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray iarray"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">**i</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1"><span class="free">**i</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> tabulate2 <span class="main">(</span>nrows_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>ncols_iarray <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="bound">i</span><span class="main">)</span><span class="main">!!</span><span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">!!</span><span class="bound">k</span><span class="main">)</span><span class="main">!!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>ncols_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">matrix_vector_mult_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_1<span class="main">}</span> iarray iarray <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">*iv</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1"><span class="free">*iv</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="bound">i</span><span class="main">)</span><span class="main">!!</span><span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">!!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>nrows_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vector_matrix_mult_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_1<span class="main">}</span> iarray <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray iarray <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">v*i</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">v*i</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="bound">i</span><span class="main">)</span><span class="main">!!</span><span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">!!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>ncols_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mat_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>zero<span class="main">}</span> <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mat_iarray</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> tabulate2 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_zero_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>zero<span class="main">}</span> iarray <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_zero_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> IArray_Addenda_QR.all <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>IArray<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Properties of previous definitions›</span></span>
<span class="keyword1" id="Matrix_To_IArray_QR-is_zero_iarray_eq_iff"><span class="command">lemma</span></span> is_zero_iarray_eq_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>zero<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>is_zero_iarray <span class="main">(</span>vec_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_zero_iarray <span class="main">(</span>vec_to_iarray <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_to_iarray_def is_zero_iarray_def Option.is_none_def find_None_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_zero_iarray <span class="main">(</span>vec_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_to_iarray_def is_zero_iarray_def Option.is_none_def find_None_iff vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> mod_type_class.from_nat <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> eq_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="skolem">i</span><span class="main">&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bij_to_nat<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span><span class="main"><span class="main">=</span></span><span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="main">(</span>from_nat <span class="main">(</span>to_nat <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> from_nat_to_nat_id <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-mult_iarray_works"><span class="command">lemma</span></span> mult_iarray_works<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">&lt;</span>IArray.length <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mult_iarray <span class="free">A</span> <span class="free">q</span> <span class="main">!!</span> <span class="free">a</span> <span class="main">=</span> <span class="free">q</span> <span class="main">*</span> <span class="free">A</span><span class="main">!!</span><span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult_iarray_def
  <span class="keyword1"><span class="command">unfolding</span></span> IArray.of_fun_def <span class="keyword1"><span class="command">unfolding</span></span> sub_def
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Matrix_To_IArray_QR-length_eq_card_rows"><span class="command">lemma</span></span> length_eq_card_rows<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'columns</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'rows</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Matrix_To_IArray_QR-nrows_eq_card_rows"><span class="command">lemma</span></span> nrows_eq_card_rows<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'columns</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nrows_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'rows</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nrows_iarray_def length_eq_card_rows <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-length_eq_card_columns"><span class="command">lemma</span></span> length_eq_card_columns<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'columns</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>matrix_to_iarray <span class="free">A</span> <span class="main">!!</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span> <span class="main">(</span><span class="tfree">'columns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def o_def vec_to_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Matrix_To_IArray_QR-ncols_eq_card_columns"><span class="command">lemma</span></span> ncols_eq_card_columns<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'columns</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ncols_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'columns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ncols_iarray_def length_eq_card_columns <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-matrix_to_iarray_nrows"><span class="command">lemma</span></span> matrix_to_iarray_nrows<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'columns</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nrows <span class="free">A</span> <span class="main">=</span> nrows_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nrows_def nrows_eq_card_rows <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-matrix_to_iarray_ncols"><span class="command">lemma</span></span> matrix_to_iarray_ncols<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'columns</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ncols <span class="free">A</span> <span class="main">=</span> ncols_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ncols_def ncols_eq_card_columns <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-vec_to_iarray_row"><span class="command">lemma</span></span> vec_to_iarray_row<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vec_to_iarray <span class="main">(</span>row <span class="free">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> row_iarray <span class="main">(</span>to_nat <span class="free">i</span><span class="main">)</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> row_def row_iarray_def vec_to_iarray_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> IArray.sub_def IArray.of_fun_def vec_matrix vec_to_iarray_def<span class="main">)</span>

<span class="keyword1" id="Matrix_To_IArray_QR-vec_to_iarray_row'"><span class="command">lemma</span></span> vec_to_iarray_row'<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_to_iarray <span class="main">(</span>row <span class="free">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!!</span> <span class="main">(</span>to_nat <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> row_def vec_to_iarray_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> IArray.sub_def IArray.of_fun_def vec_matrix vec_to_iarray_def<span class="main">)</span>

<span class="keyword1" id="Matrix_To_IArray_QR-vec_to_iarray_column"><span class="command">lemma</span></span> vec_to_iarray_column<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vec_to_iarray <span class="main">(</span>column <span class="free">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> column_iarray <span class="main">(</span>to_nat <span class="free">i</span><span class="main">)</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> column_def vec_to_iarray_def column_iarray_def length_eq_card_rows
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> IArray.sub_def from_nat_not_eq vec_matrix vec_to_iarray_nth'<span class="main">)</span>

<span class="keyword1" id="Matrix_To_IArray_QR-vec_to_iarray_column'"><span class="command">lemma</span></span> vec_to_iarray_column'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_to_iarray <span class="main">(</span>column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_column <span class="keyword1"><span class="command">unfolding</span></span> to_nat_from_nat_id<span class="main">[</span><span class="operator">OF</span> k<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ncols_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-column_iarray_nth"><span class="command">lemma</span></span> column_iarray_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>nrows_iarray <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column_iarray <span class="free">j</span> <span class="free">A</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">A</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">!!</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"column_iarray <span class="free">j</span> <span class="free">A</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">m</span> <span class="main">!!</span> <span class="free">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="free">A</span><span class="main">]</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> column_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">m</span> <span class="main">!!</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="free">A</span><span class="main">]</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i nth_map <span class="keyword1"><span class="command">unfolding</span></span> nrows_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">m</span> <span class="main">!!</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_upt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="free">A</span>"</span></span><span class="main">]</span> i <span class="keyword1"><span class="command">unfolding</span></span> nrows_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-vec_to_iarray_rows"><span class="command">lemma</span></span> vec_to_iarray_rows<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_to_iarray<span class="main">`</span> <span class="main">(</span>rows <span class="free">A</span><span class="main">)</span> <span class="main">=</span> rows_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rows_def <span class="keyword1"><span class="command">unfolding</span></span> rows_iarray_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_to_iarray_row to_nat_less_card nrows_eq_card_rows<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> from_nat_not_eq vec_to_iarray_row<span class="main">)</span>

<span class="keyword1" id="Matrix_To_IArray_QR-vec_to_iarray_columns"><span class="command">lemma</span></span> vec_to_iarray_columns<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_to_iarray<span class="main">`</span> <span class="main">(</span>columns <span class="free">A</span><span class="main">)</span> <span class="main">=</span> columns_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> columns_def <span class="keyword1"><span class="command">unfolding</span></span> columns_iarray_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ncols_eq_card_columns to_nat_less_card vec_to_iarray_column<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> from_nat_not_eq vec_to_iarray_column<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Definition of elementary operations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interchange_rows_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> iarray iarray <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">interchange_rows_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">n</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mult_row_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>times<span class="main">}</span> iarray iarray <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mult_row_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> mult_iarray <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">row_add_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>plus<span class="main">,</span> times<span class="main">,</span>zero<span class="main">}</span> iarray iarray <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">row_add_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> mult_iarray <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interchange_columns_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> iarray iarray <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">interchange_columns_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span>  tabulate2 <span class="main">(</span>nrows_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>ncols_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mult_column_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>times<span class="main">}</span> iarray iarray <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mult_column_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> tabulate2 <span class="main">(</span>nrows_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>ncols_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">!!</span> <span class="bound">j</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">column_add_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>plus<span class="main">,</span> times<span class="main">}</span> iarray iarray <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> nat <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> iarray iarray"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">column_add_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> tabulate2 <span class="main">(</span>nrows_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>ncols_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Code generator›</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-vec_to_iarray_plus"><span class="command">lemma</span></span> vec_to_iarray_plus<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vec_to_iarray <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span>vec_to_iarray <span class="free">a</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>vec_to_iarray <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_def
  <span class="keyword1"><span class="command">unfolding</span></span> plus_iarray_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Matrix_To_IArray_QR-matrix_to_iarray_plus"><span class="command">lemma</span></span> matrix_to_iarray_plus<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>matrix_to_iarray <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def o_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_iarray_def Let_def vec_to_iarray_plus<span class="main">)</span>

<span class="keyword1" id="Matrix_To_IArray_QR-matrix_to_iarray_mat"><span class="command">lemma</span></span> matrix_to_iarray_mat<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>mat <span class="free">k</span> <span class="main">::</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>zero<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">)</span> <span class="main">=</span> mat_iarray <span class="free">k</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def o_def vec_to_iarray_def mat_def mat_iarray_def tabulate2_def
  <span class="keyword1"><span class="command">using</span></span> from_nat_eq_imp_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="Matrix_To_IArray_QR-matrix_to_iarray_transpose"><span class="command">lemma</span></span> matrix_to_iarray_transpose<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span> <span class="main">=</span> transpose_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def transpose_def transpose_iarray_def 
    o_def tabulate2_def nrows_iarray_def ncols_iarray_def vec_to_iarray_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Matrix_To_IArray_QR-matrix_to_iarray_matrix_matrix_mult"><span class="command">lemma</span></span> matrix_to_iarray_matrix_matrix_mult<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_1<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">**</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">**i</span> <span class="main">(</span>matrix_to_iarray <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def matrix_matrix_mult_iarray_def matrix_matrix_mult_def 
  <span class="keyword1"><span class="command">unfolding</span></span> o_def tabulate2_def nrows_iarray_def ncols_iarray_def vec_to_iarray_def
  <span class="keyword1"><span class="command">using</span></span> sum.reindex_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"from_nat<span class="main">::</span>nat<span class="main">=&gt;</span><span class="tfree">'m</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> bij_from_nat <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>


<span class="keyword1" id="Matrix_To_IArray_QR-vec_to_iarray_matrix_matrix_mult"><span class="command">lemma</span></span> vec_to_iarray_matrix_matrix_mult<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_1<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">*iv</span> <span class="main">(</span>vec_to_iarray <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_vector_mult_iarray_def matrix_vector_mult_def 
  <span class="keyword1"><span class="command">unfolding</span></span> o_def tabulate2_def nrows_iarray_def ncols_iarray_def matrix_to_iarray_def vec_to_iarray_def
  <span class="keyword1"><span class="command">using</span></span> sum.reindex_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"from_nat<span class="main">::</span>nat<span class="main">=&gt;</span><span class="tfree">'m</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> bij_from_nat <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>


<span class="keyword1" id="Matrix_To_IArray_QR-vec_to_iarray_vector_matrix_mult"><span class="command">lemma</span></span> vec_to_iarray_vector_matrix_mult<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_1<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_to_iarray <span class="main">(</span><span class="free">x</span> <span class="keyword1">v*</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>vec_to_iarray <span class="free">x</span><span class="main">)</span> <span class="keyword1">v*i</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vector_matrix_mult_def vector_matrix_mult_iarray_def 
  <span class="keyword1"><span class="command">unfolding</span></span> o_def tabulate2_def nrows_iarray_def ncols_iarray_def matrix_to_iarray_def vec_to_iarray_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> from_nat <span class="skolem">xa</span> <span class="main">*</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">i</span> <span class="main">$</span> from_nat <span class="skolem">xa</span> <span class="main">*</span> <span class="free">x</span> <span class="main">$</span> from_nat <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"from_nat<span class="main"><span class="main">::</span></span>nat<span class="main"><span class="main">=&gt;</span></span><span class="tfree"><span class="tfree">'n</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> bij_from_nat<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span><span class="main"><span class="main">=</span></span><span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Matrix_To_IArray_QR-matrix_to_iarray_interchange_rows"><span class="command">lemma</span></span> matrix_to_iarray_interchange_rows<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_1<span class="main">}</span><span class="main">^</span><span class="tfree">'columns</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>interchange_rows <span class="free">A</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> interchange_rows_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">(</span>to_nat <span class="free">i</span><span class="main">)</span> <span class="main">(</span>to_nat <span class="free">j</span><span class="main">)</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> matrix_to_iarray_def interchange_rows_iarray_def o_def map_vec_to_iarray_rw<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x_less_card<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'rows</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x_not_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> to_nat <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x_not_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> to_nat <span class="free">i</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vec_to_iarray <span class="main">(</span>interchange_rows <span class="free">A</span> <span class="free">i</span> <span class="free">j</span> <span class="main">$</span> from_nat <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> interchange_rows_preserves to_nat_from_nat_id x_less_card x_not_i x_not_j<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Matrix_To_IArray_QR-matrix_to_iarray_mult_row"><span class="command">lemma</span></span> matrix_to_iarray_mult_row<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_1<span class="main">}</span><span class="main">^</span><span class="tfree">'columns</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>mult_row <span class="free">A</span> <span class="free">i</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> mult_row_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">(</span>to_nat <span class="free">i</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def mult_row_iarray_def o_def
  <span class="keyword1"><span class="command">unfolding</span></span> mult_iarray_def vec_to_iarray_def mult_row_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> i_contr<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> to_nat <span class="main">(</span>from_nat <span class="skolem">i</span><span class="main">::</span><span class="tfree">'rows</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'columns</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'rows</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> to_nat <span class="main">(</span>from_nat <span class="skolem">i</span><span class="main">::</span><span class="tfree">'rows</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> to_nat_from_nat_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">*</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">$</span> from_nat <span class="skolem">x</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">$</span> from_nat <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i_contr <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-matrix_to_iarray_row_add"><span class="command">lemma</span></span> matrix_to_iarray_row_add<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_1<span class="main">}</span><span class="main">^</span><span class="tfree">'columns</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>row_add <span class="free">A</span> <span class="free">i</span> <span class="free">j</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> row_add_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">(</span>to_nat <span class="free">i</span><span class="main">)</span> <span class="main">(</span>to_nat <span class="free">j</span><span class="main">)</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> matrix_to_iarray_def row_add_iarray_def o_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vec_to_iarray <span class="main">(</span>row_add <span class="free">A</span> <span class="free">i</span> <span class="free">j</span> <span class="free">q</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="main">+</span> mult_iarray <span class="main">(</span>vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mult_iarray_def vec_to_iarray_def <span class="keyword1"><span class="command">unfolding</span></span> plus_iarray_def Let_def row_add_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ia</span> <span class="keyword3"><span class="command">assume</span></span> ia_not_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">≠</span> to_nat <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ia_card<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'rows</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">have</span></span> from_nat_ia_not_i<span class="main">:</span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">ia</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> from_nat <span class="skolem">ia</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">ia</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="main">(</span>from_nat <span class="skolem">ia</span><span class="main">::</span><span class="tfree">'rows</span><span class="main">)</span> <span class="main">=</span> to_nat <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span><span class="main">=</span>to_nat <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> to_nat_from_nat_id ia_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>  <span class="keyword1"><span class="command">using</span></span> ia_not_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vec_to_iarray <span class="main">(</span>row_add <span class="free">A</span> <span class="free">i</span> <span class="free">j</span> <span class="free">q</span> <span class="main">$</span> from_nat <span class="skolem">ia</span><span class="main">)</span> <span class="main">=</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">ia</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ia_not_i
    <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_morph<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> row_add_def <span class="keyword1"><span class="command">using</span></span> from_nat_ia_not_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_To_IArray_QR-matrix_to_iarray_interchange_columns"><span class="command">lemma</span></span> matrix_to_iarray_interchange_columns<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_1<span class="main">}</span><span class="main">^</span><span class="tfree">'columns</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>interchange_columns <span class="free">A</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> interchange_columns_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">(</span>to_nat <span class="free">i</span><span class="main">)</span> <span class="main">(</span>to_nat <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> interchange_columns_def interchange_columns_iarray_def o_def tabulate2_def
  <span class="keyword1"><span class="command">unfolding</span></span> nrows_eq_card_rows ncols_eq_card_columns 
  <span class="keyword1"><span class="command">unfolding</span></span>  matrix_to_iarray_def o_def vec_to_iarray_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_nat_from_nat_id to_nat_less_card<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span> to_nat_less_card<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1" id="Matrix_To_IArray_QR-matrix_to_iarray_mult_columns"><span class="command">lemma</span></span> matrix_to_iarray_mult_columns<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_1<span class="main">}</span><span class="main">^</span><span class="tfree">'columns</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>mult_column <span class="free">A</span> <span class="free">i</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> mult_column_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">(</span>to_nat <span class="free">i</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult_column_def mult_column_iarray_def o_def tabulate2_def
  <span class="keyword1"><span class="command">unfolding</span></span> nrows_eq_card_rows ncols_eq_card_columns 
  <span class="keyword1"><span class="command">unfolding</span></span>  matrix_to_iarray_def o_def vec_to_iarray_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_nat_from_nat_id<span class="main">)</span>

<span class="keyword1" id="Matrix_To_IArray_QR-matrix_to_iarray_column_add"><span class="command">lemma</span></span> matrix_to_iarray_column_add<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_1<span class="main">}</span><span class="main">^</span><span class="tfree">'columns</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>column_add <span class="free">A</span> <span class="free">i</span> <span class="free">j</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> column_add_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">(</span>to_nat <span class="free">i</span><span class="main">)</span> <span class="main">(</span>to_nat <span class="free">j</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> column_add_def column_add_iarray_def o_def tabulate2_def
  <span class="keyword1"><span class="command">unfolding</span></span> nrows_eq_card_rows ncols_eq_card_columns 
  <span class="keyword1"><span class="command">unfolding</span></span>  matrix_to_iarray_def o_def vec_to_iarray_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_nat_from_nat_id to_nat_less_card<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span> to_nat_less_card<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Gram_Schmidt_IArrays">
<div class="head">
<h1>Theory Gram_Schmidt_IArrays</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Title:      Gram_Schmidt_IArrays.thy
    Author:     Jose Divasón &lt;jose.divasonm at unirioja.es&gt;
    Author:     Jesús Aransay &lt;jesus-maria.aransay at unirioja.es&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Gram Schmidt over IArrays›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Gram_Schmidt_IArrays
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="#QR_Decomposition">QR_Decomposition</a>   
  <a href="#Matrix_To_IArray_QR">Matrix_To_IArray_QR</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Some previous definitions, lemmas and instantiations about iarrays›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iarray_of_iarray_to_list_of_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> iarray iarray <span class="main">=&gt;</span> <span class="tfree">'a</span> list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">iarray_of_iarray_to_list_of_list</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> map IArray.list_of <span class="main">(</span>map <span class="main">(</span><span class="main">(!!)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> iarray <span class="main">::</span> <span class="main">(</span><span class="quoted">scaleR</span><span class="main">)</span> <span class="quoted">scaleR</span>
<span class="keyword2"><span class="keyword">begin</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">scaleR_iarray</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">instantiation</span></span> iarray <span class="main">::</span> <span class="main">(</span><span class="quoted">times</span><span class="main">)</span> <span class="quoted">times</span>
<span class="keyword2"><span class="keyword">begin</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">times_iarray</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!!</span><span class="bound">i</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1" id="Gram_Schmidt_IArrays-plus_iarray_component"><span class="command">lemma</span></span> plus_iarray_component<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> iA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>IArray.length <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> iB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>IArray.length <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">+</span><span class="free">B</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">A</span><span class="main">!!</span><span class="free">i</span> <span class="main">+</span> <span class="free">B</span><span class="main">!!</span><span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> plus_iarray_def Let_def <span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IArray.of_fun
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">A</span> <span class="keyword1">then</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span> <span class="main">+</span>
    IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">B</span> <span class="keyword1">then</span> <span class="free">B</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span><span class="main">)</span>
    <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span>
    <span class="free">i</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">A</span> <span class="keyword1">then</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">+</span>
    IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">B</span> <span class="keyword1">then</span> <span class="free">B</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> of_fun_nth<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> iB less_max_iff_disj<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">A</span> <span class="keyword1">then</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="free">i</span> <span class="main">+</span> 
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">B</span> <span class="keyword1">then</span> <span class="free">B</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> of_fun_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> iB <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span> <span class="free">A</span><span class="main">!!</span><span class="free">i</span> <span class="main">+</span> <span class="free">B</span> <span class="main">!!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> iA iB <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IArray.of_fun
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">A</span> <span class="keyword1">then</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span> <span class="main">+</span>
    IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">B</span> <span class="keyword1">then</span> <span class="free">B</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span><span class="main">)</span>
    <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span>
    <span class="free">i</span> <span class="main">=</span>
    <span class="free">A</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">+</span> <span class="free">B</span> <span class="main">!!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_IArrays-minus_iarray_component"><span class="command">lemma</span></span> minus_iarray_component<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> iA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>IArray.length <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> iB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>IArray.length <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">-</span><span class="free">B</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">A</span><span class="main">!!</span><span class="free">i</span> <span class="main">-</span> <span class="free">B</span><span class="main">!!</span><span class="free">i</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> minus_iarray_def Let_def <span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IArray.of_fun
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">A</span> <span class="keyword1">then</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span> <span class="main">-</span>
    IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">B</span> <span class="keyword1">then</span> <span class="free">B</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span><span class="main">)</span>
    <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span>
    <span class="free">i</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">A</span> <span class="keyword1">then</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">-</span>
    IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">B</span> <span class="keyword1">then</span> <span class="free">B</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> of_fun_nth<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> iB less_max_iff_disj<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">A</span> <span class="keyword1">then</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="free">i</span> <span class="main">-</span> 
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">B</span> <span class="keyword1">then</span> <span class="free">B</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> of_fun_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> iB <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span> <span class="free">A</span><span class="main">!!</span><span class="free">i</span> <span class="main">-</span> <span class="free">B</span> <span class="main">!!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> iA iB <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IArray.of_fun
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">A</span> <span class="keyword1">then</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span> <span class="main">-</span>
    IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">B</span> <span class="keyword1">then</span> <span class="free">B</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span><span class="main">)</span>
    <span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">A</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">-</span> <span class="free">B</span> <span class="main">!!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt_IArrays-length_plus_iarray"><span class="command">lemma</span></span> length_plus_iarray<span class="main">:</span>
  <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span><span class="free">A</span><span class="main">+</span><span class="free">B</span><span class="main">)</span><span class="main">=</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> plus_iarray_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_IArrays-length_sum_iarray"><span class="command">lemma</span></span> length_sum_iarray<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">≠</span><span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>sum <span class="free">f</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">{</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span><span class="var"><span class="quoted"><span class="var">?case</span></span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> rw<span class="main">:</span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>sum <span class="free">f</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">{</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">F</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> insert.hyps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> set_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>insert <span class="main">(</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">F</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">|</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>sum <span class="free">f</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> IArray.length <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">+</span> sum <span class="free">f</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sum_clauses<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> max <span class="main">(</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="main">(</span>sum <span class="free">f</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> length_plus_iarray <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> max <span class="main">(</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Max <span class="main">{</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">|</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">F</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rw <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  Max <span class="main">(</span>insert <span class="main">(</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">|</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">F</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> Max_insert<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">F</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">F</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> False empty_Collect_eq ex_in_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span>  Max <span class="main">{</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">|</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_rw <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt_IArrays-sum_component_iarray"><span class="command">lemma</span></span> sum_component_iarray<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">i</span><span class="main">&lt;</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">≠</span><span class="main">{}</span>"</span></span> <span class="comment1">― ‹If S is empty, then the sum will return the empty 
  iarray and it makes no sense to access the component i›</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">S</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> f a S
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> finite_F<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">!!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sum <span class="free">f</span> <span class="skolem">F</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span><span class="main">=</span><span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span>  <span class="main">(</span><span class="operator">rule</span> insert.hyps<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="free">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insertCI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">+</span> sum <span class="free">f</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sum_clauses<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">+</span> <span class="main">(</span>sum <span class="free">f</span> <span class="skolem">F</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> plus_iarray_component<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span><span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> finite_C<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">F</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_F <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> not_empty_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">F</span><span class="main">}</span> <span class="main">≠</span><span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>    
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insertI1<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span>sum <span class="free">f</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> length_sum_iarray<span class="main">[</span><span class="operator">OF</span> finite_F False<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> Max_gr_iff<span class="main">[</span><span class="operator">OF</span> finite_C not_empty_C<span class="main">]</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"IArray.length <span class="main"><span class="main">(</span></span><span class="free"><span class="free">f</span></span> <span class="skolem"><span class="skolem">a</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert.prems<span class="main">(</span>1<span class="main">)</span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>IArray.length <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">F</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hyp <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> insert.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sum_clauses<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_IArrays-length_zero_iarray"><span class="command">lemma</span></span> length_zero_iarray<span class="main">:</span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> zero_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Gram_Schmidt_IArrays-minus_zero_iarray"><span class="command">lemma</span></span> minus_zero_iarray<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>group_add<span class="main">}</span> iarray"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="main">0</span> <span class="main">=</span> <span class="free">A</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> iarray_exhaust2 list_eq_iff_nth_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> IArray.length_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> IArray.sub_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> max_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>max <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">=</span> IArray.length <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zero_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> length_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> IArray.length <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> minus_iarray_def Let_def <span class="keyword1"><span class="command">unfolding</span></span> max_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span> <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> length_eq <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="main">0</span> <span class="main">=</span> IArray.of_fun
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="free">A</span> <span class="keyword1">then</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span> <span class="main">-</span>
    IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span> iarray<span class="main">)</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span><span class="main">)</span> 
    <span class="main">(</span>IArray.length <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> minus_iarray_def Let_def <span class="keyword1"><span class="command">unfolding</span></span> max_eq <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">A</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> i2<span class="main">]</span> length_zero_iarray <span class="keyword1"><span class="command">using</span></span> i2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">0</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">A</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Inner mult over real iarrays›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inner_iarray</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real iarray <span class="main">=&gt;</span> real iarray <span class="main">=&gt;</span> real"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∙i</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">inner_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_IArrays-vec_to_iarray_inner"><span class="command">lemma</span></span> vec_to_iarray_inner<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">=</span> vec_to_iarray <span class="free">a</span> <span class="keyword1">∙i</span> vec_to_iarray <span class="free">b</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> inner_iarray_def inner_vec_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> IArray.sub_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> IArray.length_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> set_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="main">(</span>vec_to_iarray <span class="free">a</span><span class="main">)</span><span class="main">}</span>  <span class="main">=</span> <span class="main">(</span>to_nat<span class="main">)</span><span class="main">`</span><span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_def 
    <span class="keyword1"><span class="command">using</span></span> to_nat_less_card <span class="keyword1"><span class="command">using</span></span> bij_to_nat<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span><span class="main"><span class="main">=</span></span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'a</span><span class="main">=&gt;</span>nat<span class="main">)</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> strict_mono_imp_inj_on strict_mono_to_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="main">(</span>vec_to_iarray <span class="free">a</span><span class="main">)</span><span class="main">.</span> vec_to_iarray <span class="free">a</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">*</span> vec_to_iarray <span class="free">b</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>range <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'a</span><span class="main">=&gt;</span>nat<span class="main">)</span><span class="main">.</span> vec_to_iarray <span class="free">a</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">*</span> vec_to_iarray <span class="free">b</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_rw <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span><span class="main">.</span> vec_to_iarray <span class="free">a</span> <span class="main">!!</span> to_nat <span class="bound">x</span> <span class="main">*</span> vec_to_iarray <span class="free">b</span> <span class="main">!!</span> to_nat <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum.reindex<span class="main">[</span><span class="operator">OF</span> inj<span class="main">]</span> o_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">a</span> <span class="main">$</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">b</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_nth' <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">a</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="main">(</span>vec_to_iarray <span class="free">a</span><span class="main">)</span><span class="main">.</span> vec_to_iarray <span class="free">a</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">*</span> vec_to_iarray <span class="free">b</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt_IArrays-vec_to_iarray_scaleR"><span class="command">lemma</span></span> vec_to_iarray_scaleR<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"vec_to_iarray <span class="main">(</span><span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>vec_to_iarray <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> scaleR_vec_def scaleR_iarray_def vec_to_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Gram Schmidt over IArrays›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Gram_Schmidt_column_k_iarrays</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>
  <span class="main">=</span> tabulate2 <span class="main">(</span>nrows_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>ncols_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>
  <span class="keyword1">then</span> <span class="main">(</span>column_iarray <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>column_iarray <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> 
  <span class="main">(</span>set <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="main">(</span>column_iarray <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Gram_Schmidt_upt_k_iarrays</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> List.foldl Gram_Schmidt_column_k_iarrays <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Gram_Schmidt_matrix_iarrays</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> Gram_Schmidt_upt_k_iarrays <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>ncols_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_IArrays-matrix_to_iarray_Gram_Schmidt_column_k"><span class="command">lemma</span></span> matrix_to_iarray_Gram_Schmidt_column_k<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> Gram_Schmidt_column_k_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> iarray_exhaust2 list_eq_iff_nth_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> IArray.sub_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> IArray.length_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> IArray.length <span class="main">(</span>Gram_Schmidt_column_k_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def Gram_Schmidt_column_k_iarrays_def tabulate2_def <span class="keyword1"><span class="command">unfolding</span></span> nrows_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> 
    <span class="main">=</span> IArray.length <span class="main">(</span>Gram_Schmidt_column_k_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="free">k</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def Gram_Schmidt_column_k_iarrays_def tabulate2_def 
    <span class="keyword1"><span class="command">unfolding</span></span> nrows_iarray_def ncols_iarray_def o_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i length_eq_card_rows<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x<span class="hidden">⇩</span><sub>5</sub></span><span class="main">.</span> IArray.list_of <span class="main">(</span>vec_to_iarray <span class="bound">x<span class="hidden">⇩</span><sub>5</sub></span><span class="main">)</span> 
      <span class="main">=</span> List.map <span class="main">(</span><span class="main">λ</span><span class="bound">uua</span><span class="main">.</span> <span class="bound">x<span class="hidden">⇩</span><sub>5</sub></span> <span class="main">$</span> <span class="main">(</span>from_nat <span class="bound">uua</span><span class="main">::</span><span class="tfree">'cols</span><span class="main">)</span><span class="main">::</span>real<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'cols</span> set<span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_of.simps IArray.of_fun_def vec_to_iarray_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>IArray.list_of <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> vec_to_iarray <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">k</span> <span class="main">$</span> from_nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> length <span class="main">(</span>IArray.list_of <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> IArray <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> IArray.list_of <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">k</span> <span class="keyword1">then</span> column_iarray <span class="bound">b</span> <span class="main">(</span>IArray <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>IArray <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> <span class="bound">b</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="bound">b</span> <span class="main">(</span>IArray <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> column_iarray <span class="bound">b</span> <span class="main">(</span>IArray <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> length <span class="main">(</span>IArray.list_of <span class="main">(</span>vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">ia</span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> i_nrows<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>nrows <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def nrows_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ia_ncols<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ia <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def o_def vec_to_iarray_def ncols_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Ex_list_of_length i_nrows length_map list_of.simps map_nth nrows_def nth_map<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> i_nrows_iarray<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>nrows_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i_nrows <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> matrix_to_iarray_nrows<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ia_ncols_iarray<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span><span class="main">&lt;</span>ncols_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ia_ncols <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> matrix_to_iarray_ncols<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">!!</span> <span class="skolem">ia</span> <span class="main">=</span> Gram_Schmidt_column_k_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="free">k</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">!!</span> <span class="skolem">ia</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_def Gram_Schmidt_column_k_iarrays_def 
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_nth<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">i</span><span class="main">::</span><span class="tfree">'rows</span>"</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">ia</span><span class="main">::</span><span class="tfree">'cols</span>"</span></span><span class="main">,</span>
      <span class="operator">unfolded</span> to_nat_from_nat_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i_nrows<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> nrows_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
      to_nat_from_nat_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ia_ncols<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ncols_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> tabulate2_def
    <span class="keyword1"><span class="command">unfolding</span></span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> i_nrows_iarray<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> ia_ncols_iarray<span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> proj_onto_def proj_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> IArray.sub_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on vec_to_iarray <span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> vec_to_iarray_morph<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> set_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column <span class="bound">n</span> <span class="free">A</span><span class="main">)</span><span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>from_nat <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'cols</span></span></span> <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> from_nat <span class="free">k</span>"</span></span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>from_nat <span class="free">k</span><span class="main">}</span><span class="main">.</span> column <span class="skolem">a</span> <span class="free">A</span> <span class="main">=</span> column <span class="bound">x</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a least_mod_type<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> set_rw2<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_to_iarray<span class="main">`</span> <span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span><span class="main">}</span> 
      <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'cols</span></span></span> <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> from_nat <span class="free">k</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> vec_to_iarray <span class="main">(</span>column <span class="skolem">a</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> column_iarray <span class="bound">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"to_nat <span class="skolem"><span class="skolem"><span class="skolem">a</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  a to_nat_le vec_to_iarray_column<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> <span class="keyword3"><span class="command">assume</span></span> xa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> xa'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>from_nat <span class="skolem">xa</span><span class="main">::</span><span class="tfree">'cols</span><span class="main">)</span> <span class="main">&lt;</span> from_nat <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> from_nat_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> xa k<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ncols_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> column <span class="bound">i</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span><span class="main">)</span> <span class="main">∧</span> column_iarray <span class="skolem">xa</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">=</span>  vec_to_iarray <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"column <span class="main"><span class="main">(</span></span>from_nat <span class="skolem"><span class="skolem">xa</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">A</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"from_nat <span class="skolem"><span class="skolem">xa</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xa' vec_to_iarray_column<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> k order.strict_trans vec_to_iarray_column vec_to_iarray_column' xa<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">-</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span><span class="main">}</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">-</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> set_rw_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span><span class="main">}</span><span class="main">=</span><span class="main">{}</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> True from_nat_0 <span class="keyword1"><span class="command">using</span></span> least_mod_type not_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">-</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span><span class="main">}</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">∙</span> <span class="bound">x</span>
        <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">-</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_rw_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span> column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">-</span> <span class="main">0</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> minus_zero_iarray 
        <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_column'<span class="main">[</span><span class="operator">OF</span> k<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_nth<span class="main">[</span><span class="operator">OF</span> i_nrows<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> nrows_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">-</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
        <span class="main">!!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False    
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> 
        <span class="main">(</span><span class="main">(</span> column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_component_iarray<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span><span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> column_iarray_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">nat</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>IArray.list_of <span class="main">(</span>IArray <span class="main">(</span>map <span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="main">($)</span> <span class="free">A</span> <span class="main">∘</span> mod_type_class.from_nat<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i_nrows_iarray IArray.length_def matrix_to_iarray_def nrows_iarray_def<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>IArray.list_of <span class="main">(</span><span class="main">(</span>IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> IArray.list_of <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">∙i</span> IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> IArray.list_of <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> IArray.list_of <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">∙i</span> IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> IArray.list_of <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> IArray.list_of <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_to_iarray_def scaleR_iarray_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> 
        <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> column_iarray <span class="skolem">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> n_ncols<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> k n order.strict_trans<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> c_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">=</span> vec_to_iarray <span class="main">(</span>column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">::</span><span class="tfree">'cols</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> k vec_to_iarray_column'<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="skolem">x</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">∙i</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> 
          <span class="main">=</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="skolem">x</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">∙i</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> x 
          <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_column<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">n</span><span class="main">::</span><span class="tfree">'cols</span>"</span></span><span class="main">,</span> 
            <span class="operator">unfolded</span> to_nat_from_nat_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> n_ncols<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ncols_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> c_eq
          <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_inner<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
          <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_nth<span class="main">[</span><span class="operator">OF</span> i_nrows<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> nrows_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> vector_scaleR_component<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_nth'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> to_nat_from_nat_id<span class="main">[</span><span class="operator">OF</span> i_nrows<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> nrows_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_scaleR <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>vec_to_iarray <span class="main">`</span> <span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> set_rw2<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> vec_to_iarray <span class="bound">x</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> sum.reindex<span class="main">[</span><span class="operator">OF</span> inj<span class="main">]</span> o_def 
        <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_column<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"from_nat <span class="free">k</span><span class="main">::</span><span class="tfree">'cols</span>"</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">,</span><span class="operator">unfolded</span> to_nat_from_nat_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> k<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ncols_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_inner<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> 
        <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span><span class="main">}</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_nth<span class="main">[</span><span class="operator">OF</span> i_nrows<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> nrows_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> 
        <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span><span class="main">}</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>    
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">-</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">=</span>
        <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">-</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> minus_iarray_component<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False atLeastLessThan_empty_iff2 empty_is_image neq0_conv<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">{</span>IArray.length <span class="main">(</span><span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> finite_C<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> not_empty_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span>column_iarray <span class="main">0</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span><span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="var">?x</span> <span class="main">/</span> <span class="main">(</span><span class="var">?x</span> <span class="keyword1">∙i</span> <span class="var">?x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="var">?x</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> column_iarray_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> i_nrows_iarray IArray.length_def nrows_iarray_def<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> length_sum_iarray<span class="main">[</span><span class="operator">OF</span> finite not_empty<span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> Max_gr_iff<span class="main">[</span><span class="operator">OF</span> finite_C not_empty_C<span class="main">]</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?c</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?c</span>"</span></span>           
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> column_iarray_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> i_nrows nrows_def<span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>IArray.list_of <span class="main">(</span><span class="main">(</span>IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> IArray.list_of <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">∙i</span> IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> IArray.list_of <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> IArray.list_of <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">∙i</span> IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> IArray.list_of <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> IArray.list_of <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>IArray.list_of <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_to_iarray_def scaleR_iarray_def<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">∈</span> <span class="main">{</span>IArray.length <span class="main">(</span><span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> 
            <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">-</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span><span class="main">}</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>    
        <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">-</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span><span class="main">}</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_column<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"from_nat <span class="free">k</span><span class="main">::</span><span class="tfree">'cols</span>"</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">,</span><span class="operator">unfolded</span> to_nat_from_nat_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> k<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ncols_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_nth<span class="main">[</span><span class="operator">OF</span> i_nrows<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> nrows_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">-</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span><span class="main">}</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">-</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span>  <span class="bound">x</span><span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="skolem">ia</span><span class="main">)</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">=</span> column_iarray <span class="skolem">ia</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_nth<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">OF</span> i_nrows<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> nrows_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_column'<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">OF</span> ia_ncols<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">assume</span></span> ia_not_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">≠</span> <span class="free">k</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">ia</span> <span class="main">=</span> <span class="main">(</span>from_nat <span class="free">k</span><span class="main">::</span><span class="tfree">'cols</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span><span class="main">=</span><span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> from_nat_eq_imp_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq ia_ncols<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ncols_def<span class="main"><span class="main">]</span></span> k<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ncols_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span> 
      <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="free">k</span><span class="main">}</span><span class="main">.</span> 
      column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> column_iarray <span class="skolem">ia</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ia_not_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt_IArrays-matrix_to_iarray_Gram_Schmidt_upt_k"><span class="command">lemma</span></span> matrix_to_iarray_Gram_Schmidt_upt_k<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> Gram_Schmidt_upt_k_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> k
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_def Gram_Schmidt_upt_k_iarrays_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_to_iarray_Gram_Schmidt_column_k<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">&lt;</span>ncols <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> k2<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">&lt;</span> ncols <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> list_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> Gram_Schmidt_upt_k_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps Suc.prems Suc_lessD<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Gram_Schmidt_upt_k_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_def Gram_Schmidt_upt_k_iarrays_def 
    <span class="keyword1"><span class="command">unfolding</span></span> list_rw
    <span class="keyword1"><span class="command">unfolding</span></span> foldl_append
    <span class="keyword1"><span class="command">unfolding</span></span> foldl.simps
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> Gram_Schmidt_upt_k_iarrays_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> hyp<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> matrix_to_iarray_Gram_Schmidt_column_k<span class="main"><span class="main">[</span></span><span class="operator">OF</span> k2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt_IArrays-matrix_to_iarray_Gram_Schmidt_matrix"><span class="command">lemma</span></span> matrix_to_iarray_Gram_Schmidt_matrix<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Gram_Schmidt_matrix_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_matrix_def Gram_Schmidt_matrix_iarrays_def 
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_ncols<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> matrix_to_iarray_Gram_Schmidt_upt_k<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ncols_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Examples:›</span></span>

<span class="keyword1"><span class="command">value</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">8</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">2</span><span class="main">^</span><span class="numeral">3</span>
  <span class="keyword1">in</span> iarray_of_iarray_to_list_of_list <span class="main">(</span>matrix_to_iarray <span class="main">(</span>Gram_Schmidt_matrix <span class="bound">A</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> IArray<span class="main">[</span>IArray<span class="main">[</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="numeral">8</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1">in</span> iarray_of_iarray_to_list_of_list <span class="main">(</span>Gram_Schmidt_matrix_iarrays <span class="bound">A</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="QR_Decomposition_IArrays">
<div class="head">
<h1>Theory QR_Decomposition_IArrays</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Title:      QR_Decomposition_IArrays.thy
    Author:     Jose Divasón &lt;jose.divasonm at unirioja.es&gt;
    Author:     Jesús Aransay &lt;jesus-maria.aransay at unirioja.es&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹QR Decomposition over iarrays›</span></span>

<span class="keyword1"><span class="command">theory</span></span> QR_Decomposition_IArrays 
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="#Gram_Schmidt_IArrays">Gram_Schmidt_IArrays</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹QR Decomposition refinement over iarrays›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">norm_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> sqrt <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">∙i</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">divide_by_norm_iarray</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>  <span class="main">=</span> tabulate2 <span class="main">(</span>nrows_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>ncols_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">/</span>norm_iarray <span class="main">(</span>column_iarray <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>column_iarray <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">QR_decomposition_iarrays</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> divide_by_norm_iarray <span class="main">(</span>Gram_Schmidt_matrix_iarrays <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> 
  <span class="keyword1">in</span> <span class="main">(</span><span class="bound">Q</span><span class="main">,</span> transpose_iarray <span class="bound">Q</span> <span class="keyword1">**i</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="QR_Decomposition_IArrays-vec_to_iarray_norm"><span class="command">lemma</span></span> vec_to_iarray_norm<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>norm <span class="free">A</span><span class="main">)</span> <span class="main">=</span> norm_iarray <span class="main">(</span>vec_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> norm_eq_sqrt_inner norm_iarray_def
  <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_inner <span class="keyword1"><span class="command">..</span></span>


<span class="keyword1" id="QR_Decomposition_IArrays-matrix_to_iarray_divide_by_norm"><span class="command">lemma</span></span> matrix_to_iarray_divide_by_norm<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span> <span class="main">=</span> divide_by_norm_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> iarray_exhaust2 list_eq_iff_nth_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> IArray.sub_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> IArray.length_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span><span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> IArray.length <span class="main">(</span>divide_by_norm_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def divide_by_norm_iarray_def tabulate2_def <span class="keyword1"><span class="command">unfolding</span></span> nrows_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> IArray.length <span class="main">(</span>divide_by_norm_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def divide_by_norm_iarray_def tabulate2_def 
    <span class="keyword1"><span class="command">unfolding</span></span> nrows_iarray_def ncols_iarray_def o_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i length_eq_card_rows<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x<span class="hidden">⇩</span><sub>4</sub></span><span class="main">.</span> vec_to_iarray <span class="bound">x<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">=</span> IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">uua</span><span class="main">.</span> <span class="bound">x<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">$</span> <span class="main">(</span>from_nat <span class="bound">uua</span><span class="main">::</span><span class="tfree">'cols</span><span class="main">)</span><span class="main">::</span>real<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'cols</span> set<span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_to_iarray_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span> <span class="main">∧</span> length <span class="main">(</span>IArray.list_of <span class="main">(</span>IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">Ra</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm_iarray <span class="main">(</span>column_iarray <span class="bound">Ra</span> <span class="main">(</span>IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">R</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> column_iarray <span class="bound">Ra</span> <span class="main">(</span>IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">R</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">R</span><span class="main">)</span> <span class="main">(</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'cols</span> set<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>IArray.list_of <span class="main">(</span>IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> vec_to_iarray <span class="main">(</span>divide_by_norm <span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">R</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> vec_to_iarray <span class="main">(</span>divide_by_norm <span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> IArray.length <span class="main">(</span>IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm_iarray <span class="main">(</span>column_iarray <span class="bound">b</span> <span class="main">(</span>IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> column_iarray <span class="bound">b</span> <span class="main">(</span>IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="main">(</span>IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">!!</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="main">(</span>IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> vec_to_iarray <span class="main">(</span><span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'rows</span> set<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_to_iarray_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ia</span> <span class="keyword3"><span class="command">assume</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> i_nrows<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>nrows <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def nrows_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ia_ncols<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ia <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def o_def vec_to_iarray_def ncols_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Ex_list_of_length i_nrows length_map list_of.simps map_nth nrows_def nth_map<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> i_nrows_iarray<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>nrows_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i_nrows <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> matrix_to_iarray_nrows<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ia_ncols_iarray<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span><span class="main">&lt;</span>ncols_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ia_ncols <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> matrix_to_iarray_ncols<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>divide_by_norm <span class="free">A</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">!!</span> <span class="skolem">ia</span> 
    <span class="main">=</span> divide_by_norm_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">!!</span> <span class="skolem">ia</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> divide_by_norm_def divide_by_norm_iarray_def 
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_nth<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">i</span><span class="main">::</span><span class="tfree">'rows</span>"</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">ia</span><span class="main">::</span><span class="tfree">'cols</span>"</span></span><span class="main">,</span>
      <span class="operator">unfolded</span> to_nat_from_nat_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i_nrows<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> nrows_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
      to_nat_from_nat_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ia_ncols<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ncols_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> tabulate2_def
    <span class="keyword1"><span class="command">unfolding</span></span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> i_nrows_iarray<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> ia_ncols_iarray<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_column'<span class="main">[</span><span class="operator">OF</span> ia_ncols<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_norm<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> vector_scaleR_component
    <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_scaleR<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_nth<span class="main">[</span><span class="operator">OF</span> i_nrows<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> nrows_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> normalize_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="QR_Decomposition_IArrays-matrix_to_iarray_fst_QR_decomposition"><span class="command">lemma</span></span> matrix_to_iarray_fst_QR_decomposition<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>QR_decomposition_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> iarray_exhaust2 list_eq_iff_nth_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> IArray.sub_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> IArray.length_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">ia</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> IArray.length <span class="main">(</span>fst <span class="main">(</span>QR_decomposition_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> 
    <span class="main">=</span> IArray.length <span class="main">(</span>fst <span class="main">(</span>QR_decomposition_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">!!</span> <span class="skolem">ia</span> 
    <span class="main">=</span> fst <span class="main">(</span>QR_decomposition_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">!!</span> <span class="skolem">ia</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> QR_decomposition_def QR_decomposition_iarrays_def Let_def fst_conv
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_divide_by_norm
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_Gram_Schmidt_matrix <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="QR_Decomposition_IArrays-matrix_to_iarray_snd_QR_decomposition"><span class="command">lemma</span></span> matrix_to_iarray_snd_QR_decomposition<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>QR_decomposition_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> iarray_exhaust2 list_eq_iff_nth_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> IArray.sub_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> IArray.length_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">ia</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> IArray.length <span class="main">(</span>snd <span class="main">(</span>QR_decomposition_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> 
    <span class="main">=</span> IArray.length <span class="main">(</span>snd <span class="main">(</span>QR_decomposition_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">!!</span> <span class="skolem">ia</span> 
    <span class="main">=</span> snd <span class="main">(</span>QR_decomposition_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">!!</span> <span class="skolem">ia</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> QR_decomposition_iarrays_def QR_decomposition_def Let_def snd_conv
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_matrix_matrix_mult
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_transpose
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_divide_by_norm
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_Gram_Schmidt_matrix <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">matrix_to_iarray_pair</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span>matrix_to_iarray <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">,</span> matrix_to_iarray <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="QR_Decomposition_IArrays-matrix_to_iarray_QR_decomposition"><span class="command">lemma</span></span> matrix_to_iarray_QR_decomposition<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray_pair <span class="main">(</span>QR_decomposition <span class="free">A</span><span class="main">)</span> <span class="main">=</span>  QR_decomposition_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_pair_def
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_fst_QR_decomposition
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_snd_QR_decomposition <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Examples_QR_IArrays_Float">
<div class="head">
<h1>Theory Examples_QR_IArrays_Float</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Title:      Examples_QR_IArrays_Float.thy
    Author:     Jose Divasón &lt;jose.divasonm at unirioja.es&gt;
    Author:     Jesús Aransay &lt;jesus-maria.aransay at unirioja.es&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Examples of execution using floats and IArrays›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Examples_QR_IArrays_Float
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#QR_Decomposition_IArrays">QR_Decomposition_IArrays</a>
  <a href="../../gauss_jordan/theories/#Code_Real_Approx_By_Float_Haskell">Gauss_Jordan.Code_Real_Approx_By_Float_Haskell</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Examples›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span> 
  iarray_of_iarray_to_list_of_list <span class="main">(</span>matrix_to_iarray <span class="main">(</span>divide_by_norm <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example2</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span>matrix_to_iarray <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example3</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span>matrix_to_iarray <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example4</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span>matrix_to_iarray <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span> <span class="main">**</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example5</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span>sqrt <span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span>sqrt <span class="numeral">5</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span>sqrt <span class="numeral">7</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span>matrix_to_iarray <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(*Now there is no problem if there are square roots in the input matrix.*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example6</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span>sqrt <span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span>sqrt <span class="numeral">5</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span>sqrt <span class="numeral">7</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span>matrix_to_iarray <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example1b</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> IArray<span class="main">[</span>IArray<span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">::</span>real<span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">]</span> <span class="keyword1">in</span> 
   iarray_of_iarray_to_list_of_list <span class="main">(</span><span class="main">(</span>divide_by_norm_iarray <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example2b</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> IArray<span class="main">[</span>IArray<span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition_iarrays <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example3b</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> IArray<span class="main">[</span>IArray<span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span> <span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition_iarrays <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example4b</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> IArray<span class="main">[</span>IArray<span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span> <span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span> 
    <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition_iarrays <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">**i</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition_iarrays <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example5b</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> IArray<span class="main">[</span>IArray<span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span> 
    <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition_iarrays <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">**i</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition_iarrays <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example6b</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> IArray <span class="main">[</span>IArray<span class="main">[</span><span class="main">1</span><span class="main">,</span>sqrt <span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span>sqrt <span class="numeral">5</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="main">0</span><span class="main">,</span>sqrt <span class="numeral">7</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1">in</span> iarray_of_iarray_to_list_of_list <span class="main">(</span>fst <span class="main">(</span>QR_decomposition_iarrays <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following example is presented in Chapter 1 of the book
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Numerical Methods in Scientific Computing›</span></span></span></span> by Dahlquist and Bjorck›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">book_example</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix 
  <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="numeral">0.6691</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="numeral">0.3907</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="numeral">0.1219</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">0.3090</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">0.5878</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">2</span><span class="main">^</span><span class="numeral">5</span><span class="main">;</span> 
  <span class="bound">b</span> <span class="main">=</span> list_to_vec <span class="main">[</span><span class="numeral">0.3704</span><span class="main">,</span><span class="numeral">0.5</span><span class="main">,</span><span class="numeral">0.6211</span><span class="main">,</span><span class="numeral">0.8333</span><span class="main">,</span><span class="numeral">0.9804</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">5</span><span class="main">;</span>
  <span class="bound">QR</span> <span class="main">=</span> <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">Q</span> <span class="main">=</span> fst <span class="bound">QR</span><span class="main">;</span>
  <span class="bound">R</span> <span class="main">=</span> snd <span class="bound">QR</span>
  <span class="keyword1">in</span> IArray.list_of <span class="main">(</span>vec_to_iarray <span class="main">(</span>the <span class="main">(</span>inverse_matrix <span class="bound">R</span><span class="main">)</span> <span class="main">**</span> transpose <span class="bound">Q</span> <span class="keyword1">*v</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">example1</span></span> <span class="quoted"><span class="quoted">example2</span></span> <span class="quoted"><span class="quoted">example3</span></span> <span class="quoted"><span class="quoted">example4</span></span> <span class="quoted"><span class="quoted">example5</span></span> <span class="quoted"><span class="quoted">example6</span></span> 
            <span class="quoted"><span class="quoted">example1b</span></span> <span class="quoted"><span class="quoted">example2b</span></span> <span class="quoted"><span class="quoted">example3b</span></span> <span class="quoted"><span class="quoted">example4b</span></span> <span class="quoted"><span class="quoted">example5b</span></span> <span class="quoted"><span class="quoted">example6b</span></span> <span class="quoted"><span class="quoted">book_example</span></span>
            <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> <span class="quoted">"QR"</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Examples_QR_IArrays_Symbolic">
<div class="head">
<h1>Theory Examples_QR_IArrays_Symbolic</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Title:      Examples_QR_IArrays_Symbolic.thy
    Author:     Jose Divasón &lt;jose.divasonm at unirioja.es&gt;
    Author:     Jesús Aransay &lt;jesus-maria.aransay at unirioja.es&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Examples of execution using symbolic computation and iarrays›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Examples_QR_IArrays_Symbolic
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Examples_QR_Abstract_Symbolic">Examples_QR_Abstract_Symbolic</a>
  <a href="#QR_Decomposition_IArrays">QR_Decomposition_IArrays</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Execution of the QR decomposition using symbolic computation and iarrays›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">show_vec_real_iarrays</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> show_real <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Examples_QR_IArrays_Symbolic-vec_to_iarray_show_vec_real"><span class="command">lemma</span></span> vec_to_iarray_show_vec_real<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vec_to_iarray <span class="main">(</span>show_vec_real <span class="free">v</span><span class="main">)</span> 
  <span class="main">=</span> show_vec_real_iarrays <span class="main">(</span>vec_to_iarray <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> show_vec_real_def show_vec_real_iarrays_def vec_to_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following function is used to print elements of type vec as lists of characters; 
  useful for printing vectors in the output panel.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_vec</span> <span class="main">=</span> IArray.list_of <span class="main">∘</span> show_vec_real_iarrays <span class="main">∘</span> vec_to_iarray"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">show_matrix_real_iarrays</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> show_vec_real_iarrays <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Examples_QR_IArrays_Symbolic-matrix_to_iarray_show_matrix_real"><span class="command">lemma</span></span> matrix_to_iarray_show_matrix_real<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>show_matrix_real <span class="free">v</span><span class="main">)</span> 
  <span class="main">=</span> show_matrix_real_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> show_matrix_real_iarrays_def show_matrix_real_def
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_to_iarray_show_vec_real<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following functions are useful to print matrices as lists of lists of characters; 
  useful for printing in the output panel.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_vec_mat</span> <span class="main">=</span> IArray.list_of <span class="main">∘</span> show_vec_real_iarrays"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_mat_aux</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> print_vec_mat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_mat</span> <span class="main">=</span> IArray.list_of <span class="main">∘</span> print_mat_aux <span class="main">∘</span> matrix_to_iarray"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Examples›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span> 
  iarray_of_iarray_to_list_of_list <span class="main">(</span>matrix_to_iarray <span class="main">(</span>show_matrix_real <span class="main">(</span>divide_by_norm <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span>matrix_to_iarray <span class="main">(</span>show_matrix_real <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span>matrix_to_iarray <span class="main">(</span>show_matrix_real <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">3</span> <span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span>matrix_to_iarray 
    <span class="main">(</span>show_matrix_real <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">**</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span> <span class="keyword1">in</span> rank <span class="bound">A</span> <span class="main">=</span> ncols <span class="bound">A</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span><span class="main">;</span> 
  <span class="bound">b</span> <span class="main">=</span> list_to_vec <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">4</span> <span class="keyword1">in</span>
  print_result_solve <span class="main">(</span>solve <span class="bound">A</span> <span class="bound">b</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span><span class="main">;</span> 
  <span class="bound">b</span> <span class="main">=</span> list_to_vec <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">4</span>
  <span class="keyword1">in</span>
  vec_to_list <span class="main">(</span>show_vec_real <span class="main">(</span>the <span class="main">(</span>inverse_matrix <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">**</span> transpose <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span><span class="main">;</span> 
  <span class="bound">b</span> <span class="main">=</span> list_to_vec <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">4</span>
  <span class="keyword1">in</span> matrix_to_list_of_list <span class="main">(</span>show_matrix_real <span class="main">(</span><span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹least squares solution›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≡</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">3</span><span class="main">/</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≡</span> list_to_vec <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">4</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> fst <span class="main">(</span>QR_decomposition A<span class="main">)</span><span class="main">;</span> <span class="bound">R</span> <span class="main">=</span> snd <span class="main">(</span>QR_decomposition A<span class="main">)</span>
  <span class="keyword1">in</span> print_vec <span class="main">(</span><span class="main">(</span>the <span class="main">(</span>inverse_matrix <span class="bound">R</span><span class="main">)</span> <span class="main">**</span> transpose <span class="bound">Q</span> <span class="keyword1">*v</span> b<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A times least squares solution›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> fst <span class="main">(</span>QR_decomposition A<span class="main">)</span><span class="main">;</span> <span class="bound">R</span> <span class="main">=</span> snd <span class="main">(</span>QR_decomposition A<span class="main">)</span>
  <span class="keyword1">in</span> print_vec <span class="main">(</span>A <span class="keyword1">*v</span> <span class="main">(</span>the <span class="main">(</span>inverse_matrix <span class="bound">R</span><span class="main">)</span> <span class="main">**</span> transpose <span class="bound">Q</span> <span class="keyword1">*v</span> b<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The matrix Q›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"print_mat <span class="main">(</span>fst <span class="main">(</span>QR_decomposition A<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The matrix R›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"print_mat <span class="main">(</span>snd <span class="main">(</span>QR_decomposition A<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The inverse of matrix R›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">R</span> <span class="main">=</span> snd <span class="main">(</span>QR_decomposition A<span class="main">)</span> <span class="keyword1">in</span> print_mat <span class="main">(</span>the <span class="main">(</span>inverse_matrix <span class="bound">R</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The least squares solution is in the left null space of A›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> fst <span class="main">(</span>QR_decomposition A<span class="main">)</span><span class="main">;</span> <span class="bound">R</span> <span class="main">=</span> snd <span class="main">(</span>QR_decomposition A<span class="main">)</span><span class="main">;</span>
           <span class="bound">b2</span> <span class="main">=</span> <span class="main">(</span>A <span class="keyword1">*v</span> <span class="main">(</span>the <span class="main">(</span>inverse_matrix <span class="bound">R</span><span class="main">)</span> <span class="main">**</span> transpose <span class="bound">Q</span> <span class="keyword1">*v</span> b<span class="main">)</span><span class="main">)</span>
       <span class="keyword1">in</span> print_vec <span class="main">(</span><span class="main">(</span>b <span class="main">-</span> <span class="bound">b2</span><span class="main">)</span><span class="keyword1">v*</span> A<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span> <span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span>matrix_to_iarray 
    <span class="main">(</span>show_matrix_real <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">**</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> IArray<span class="main">[</span>IArray<span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">::</span>real<span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">]</span> <span class="keyword1">in</span> 
   iarray_of_iarray_to_list_of_list <span class="main">(</span>show_matrix_real_iarrays <span class="main">(</span>divide_by_norm_iarray <span class="bound">A</span><span class="main">)</span><span class="main">)</span>"</span></span>  

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> IArray<span class="main">[</span>IArray<span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span> <span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span>show_matrix_real_iarrays <span class="main">(</span>fst <span class="main">(</span>QR_decomposition_iarrays <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> IArray<span class="main">[</span>IArray<span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span> <span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span>show_matrix_real_iarrays <span class="main">(</span>snd <span class="main">(</span>QR_decomposition_iarrays <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span> <span class="keyword1">in</span> rank <span class="bound">A</span> <span class="main">=</span> ncols <span class="bound">A</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span><span class="main">;</span> 
  <span class="bound">b</span> <span class="main">=</span> list_to_vec <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">4</span> <span class="keyword1">in</span>
  print_result_solve <span class="main">(</span>solve <span class="bound">A</span> <span class="bound">b</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span><span class="main">;</span> 
  <span class="bound">b</span> <span class="main">=</span> list_to_vec <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">4</span>
  <span class="keyword1">in</span>
  vec_to_list <span class="main">(</span>show_vec_real <span class="main">(</span>the <span class="main">(</span>inverse_matrix <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">**</span> transpose <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span><span class="main">;</span> 
  <span class="bound">b</span> <span class="main">=</span> list_to_vec <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">4</span>
  <span class="keyword1">in</span> matrix_to_list_of_list <span class="main">(</span>show_matrix_real <span class="main">(</span><span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">3</span><span class="main">^</span><span class="numeral">4</span><span class="main">;</span> 
  <span class="bound">b</span> <span class="main">=</span> list_to_vec <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">4</span><span class="main">;</span>
  <span class="bound">b2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">A</span> <span class="keyword1">*v</span> <span class="main">(</span>the <span class="main">(</span>inverse_matrix <span class="main">(</span>snd <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">**</span> transpose <span class="main">(</span>fst <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">in</span>
  vec_to_list <span class="main">(</span>show_vec_real <span class="main">(</span><span class="main">(</span><span class="bound">b</span> <span class="main">-</span> <span class="bound">b2</span><span class="main">)</span><span class="keyword1">v*</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> IArray<span class="main">[</span>IArray<span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span> <span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span>show_matrix_real_iarrays 
    <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition_iarrays <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">**i</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition_iarrays <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> IArray<span class="main">[</span>IArray<span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span>show_matrix_real_iarrays 
    <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition_iarrays <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">**i</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition_iarrays <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following example is presented in Chapter 1 of the book
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Numerical Methods in Scientific Computing›</span></span></span></span> by Dahlquist and Bjorck›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> list_of_list_to_matrix 
  <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="numeral">0.6691</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="numeral">0.3907</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="numeral">0.1219</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">0.3090</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">0.5878</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">2</span><span class="main">^</span><span class="numeral">5</span><span class="main">;</span> 
  <span class="bound">b</span> <span class="main">=</span> list_to_vec <span class="main">[</span><span class="numeral">0.3704</span><span class="main">,</span><span class="numeral">0.5</span><span class="main">,</span><span class="numeral">0.6211</span><span class="main">,</span><span class="numeral">0.8333</span><span class="main">,</span><span class="numeral">0.9804</span><span class="main">]</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">5</span><span class="main">;</span>
  <span class="bound">QR</span> <span class="main">=</span> <span class="main">(</span>QR_decomposition <span class="bound">A</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">Q</span> <span class="main">=</span> fst <span class="bound">QR</span><span class="main">;</span>
  <span class="bound">R</span> <span class="main">=</span> snd <span class="bound">QR</span>
  <span class="keyword1">in</span> print_vec <span class="main">(</span>the <span class="main">(</span>inverse_matrix <span class="bound">R</span><span class="main">)</span> <span class="main">**</span> transpose <span class="bound">Q</span> <span class="keyword1">*v</span> <span class="bound">b</span><span class="main">)</span>"</span></span>


<span class="comment1">(*
  Limitation: if the input matrix has irrational numbers, then we won't be working in the same
  field extension so the computation will fail.
*)</span>

<span class="comment1">(*
value[code] "let A = list_of_list_to_matrix [[1,sqrt 2,4],[sqrt 5,4,5],[0,sqrt 7,4]]::real^3^3 in
  iarray_of_iarray_to_list_of_list (matrix_to_iarray (show_matrix_real ((fst (QR_decomposition A)))))"
*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> IArray<span class="main">[</span>IArray<span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">,</span>IArray<span class="main">[</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">]</span><span class="keyword1">in</span>
  iarray_of_iarray_to_list_of_list <span class="main">(</span>show_matrix_real_iarrays 
    <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>QR_decomposition_iarrays <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">**i</span> <span class="main">(</span>snd <span class="main">(</span>QR_decomposition_iarrays <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">example</span></span> <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> QR

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Generalizations2">
<div class="head">
<h1>Theory Generalizations2</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Title:      Generalizations2.thy
    Author:     Jose Divasón &lt;jose.divasonm at unirioja.es&gt;
    Author:     Jesús Aransay &lt;jesus-maria.aransay at unirioja.es&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Generalization of the Second Part of the Fundamental Theorem of Linear Algebra›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Generalizations2
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../../rank_nullity_theorem/theories/#Fundamental_Subspaces">Rank_Nullity_Theorem.Fundamental_Subspaces</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Conjugate class›</span></span>

<span class="keyword1"><span class="command">class</span></span> cnj <span class="main">=</span> field <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">cnj</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cnj_idem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cnj</span> <span class="main">(</span><span class="free">cnj</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> cnj_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cnj</span> <span class="main">(</span><span class="free">a</span><span class="main">+</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">cnj</span> <span class="free">a</span> <span class="main">+</span> <span class="free">cnj</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> cnj_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cnj</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">cnj</span> <span class="free">a</span> <span class="main">*</span> <span class="free">cnj</span> <span class="free">b</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Generalizations2-two_not_one"><span class="command">lemma</span></span> two_not_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≠</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> one_neq_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generalizations2-cnj_0"><span class="command">lemma</span></span> cnj_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cnj <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cnj <span class="main">0</span> <span class="main">=</span> cnj <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> cnj <span class="main">0</span> <span class="main">+</span> cnj <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cnj_add <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>cnj <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.mult_2<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cnj <span class="main">0</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> cnj <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_not_one<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generalizations2-cnj_0_eq"><span class="command">lemma</span></span> cnj_0_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cnj <span class="free">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> cnj_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> cnj <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cnj <span class="main">(</span>cnj <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cnj_idem <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cnj <span class="main">0</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cnj_rw <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> cnj <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cnj_rw <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generalizations2-a_cnj_a_0"><span class="command">lemma</span></span> a_cnj_a_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">*</span>cnj <span class="free">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Generalizations2-cnj_sum"><span class="command">lemma</span></span> cnj_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"cnj <span class="main">(</span><span class="main">∑</span><span class="bound">xa</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">xa</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">f</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> finite<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cnj_add<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> real <span class="main">::</span> <span class="quoted">cnj</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="class_parameter">cnj_real</span></span> <span class="main">::</span> real<span class="main">⇒</span>real<span class="main">)</span><span class="main">=</span> id"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cnj_real_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">instantiation</span></span> complex <span class="main">::</span> <span class="quoted">cnj</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="class_parameter">cnj_complex</span></span> <span class="main">::</span> complex<span class="main">⇒</span>complex<span class="main">)</span><span class="main">=</span> Complex.cnj"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cnj_complex_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Real\_of\_extended class›</span></span>

<span class="keyword1"><span class="command">class</span></span> real_of_extended <span class="main">=</span> real_vector <span class="main">+</span> cnj <span class="main">+</span>
 <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">real_of</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
 <span class="keyword2"><span class="keyword">assumes</span></span> real_add<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">real_of</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">real_of</span> <span class="free">a</span> <span class="main">+</span> <span class="free">real_of</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> real_uminus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">real_of</span> <span class="main">(</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="free">real_of</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> real_scalar_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">real_of</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> <span class="main">(</span><span class="free">real_of</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> real_a_cnj_ge_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">real_of</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span>cnj <span class="free">a</span><span class="main">)</span><span class="main">≥</span><span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Generalizations2-real_minus"><span class="command">lemma</span></span> real_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"real_of <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> real_of <span class="free">a</span> <span class="main">-</span> real_of <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> real_of <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> real_of <span class="free">a</span> <span class="main">+</span> real_of <span class="main">(</span><span class="main">-</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> real_add <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> real_of <span class="free">a</span> <span class="main">+</span> <span class="main">-</span> real_of <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> real_uminus <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> real_of <span class="free">a</span> <span class="main">-</span> real_of <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generalizations2-real_0"><span class="command">lemma</span></span> real_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"real_of <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of <span class="main">0</span> <span class="main">=</span> real_of <span class="main">(</span><span class="main">0</span><span class="main">+</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> real_of <span class="main">0</span> <span class="main">+</span> real_of <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> real_add <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span>real_of <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of <span class="main">0</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span> real_of <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_not_one<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Generalizations2-real_sum"><span class="command">lemma</span></span> real_sum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"real_of <span class="main">(</span>sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> real_of <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>   

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> real <span class="main">::</span> <span class="quoted">real_of_extended</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">real_of_real</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">real_of_real</span> <span class="main">=</span> id"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_of_real_def cnj_real_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> complex <span class="main">::</span> <span class="quoted">real_of_extended</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">real_of_complex</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">real_of_complex</span> <span class="main">=</span> Re"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_of_complex_def cnj_complex_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Generalizing HMA›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Inner product spaces›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We generalize the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>real_inner class›</span></span></span></span> to more general inner product spaces.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> inner_product_space <span class="main">=</span> vector_space <span class="quoted"><span class="free">scale</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">scale</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>field<span class="main">,</span> cnj<span class="main">,</span> real_of_extended<span class="main">}</span> <span class="main">=&gt;</span> <span class="tfree">'b</span><span class="main">::</span>ab_group_add <span class="main">=&gt;</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">inner</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inner_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inner_add_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">z</span> <span class="main">+</span> <span class="free">inner</span> <span class="free">y</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inner_scaleR_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="main">(</span><span class="free">scale</span> <span class="free">r</span> <span class="free">x</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inner_ge_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inner_eq_zero_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">x</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">=</span><span class="main">0</span>"</span></span>
  <span class="comment1">(*Properties related to real and inner that must be assumed.*)</span>
  <span class="keyword2"><span class="keyword">and</span></span> real_scalar_mult2<span class="main">:</span> <span class="quoted"><span class="quoted">"real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">x</span> <span class="main">*</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inner_gt_zero_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 


<span class="keyword1"><span class="command">interpretation</span></span> RV_inner<span class="main">:</span> inner_product_space <span class="quoted">scaleR</span> <span class="quoted">inner</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cnj_real_def inner_add_left real_of_real_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> inner_commute<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> RR_inner<span class="main">:</span> inner_product_space <span class="quoted">scaleR</span> <span class="quoted"><span class="quoted">"<span class="main">(*)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cnj_real_def distrib_right real_of_real_def<span class="main">)</span> 
   <span class="main">(</span><span class="operator">metis</span> not_real_square_gt_zero<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> CC_inner<span class="main">:</span> inner_product_space <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(*)</span><span class="main">::</span>complex<span class="main">⇒</span>complex<span class="main">⇒</span>complex<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">*</span>cnj <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_of_complex_def cnj_complex_def distrib_left distrib_right complex_mult_cnj complex_neq_0 cmod_power2 complex_norm_square<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Re_complex_of_real complex_neq_0 less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> of_real_add of_real_power zero_complex.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left mult.commute scaleR_conv_of_real<span class="main">)</span>
  
<span class="keyword1"><span class="command">context</span></span> inner_product_space
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Generalizations2-inner_zero_left"><span class="command">lemma</span></span> inner_zero_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="main">0</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inner_add_left <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_not_one<span class="main">)</span>

<span class="keyword1" id="Generalizations2-inner_minus_left"><span class="command">lemma</span></span> inner_minus_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="main">(</span><span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="main">-</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inner_add_left <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> add_eq_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Generalizations2-inner_diff_left"><span class="command">lemma</span></span> inner_diff_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">z</span> <span class="main">-</span> <span class="free">inner</span> <span class="free">y</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inner_add_left <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Generalizations2-inner_sum_left"><span class="command">lemma</span></span> inner_sum_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">inner</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> finite<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inner_add_left<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transfer distributivity rules to right argument.›</span></span>

<span class="keyword1" id="Generalizations2-inner_add_right"><span class="command">lemma</span></span> inner_add_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span> <span class="main">+</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inner_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> cnj <span class="main">(</span><span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span><span class="main">(</span><span class="free">inner</span> <span class="free">z</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inner_add_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="free">z</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cnj_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span> <span class="main">+</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">z</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> inner_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> inner_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Generalizations2-inner_scaleR_right"><span class="command">lemma</span></span> inner_scaleR_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">x</span> <span class="main">(</span><span class="free">scale</span> <span class="free">r</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>cnj <span class="free">r</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inner_scaleR_left <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> cnj_mult local.inner_commute<span class="main">)</span>


<span class="keyword1" id="Generalizations2-inner_zero_right"><span class="command">lemma</span></span> inner_zero_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">x</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inner_zero_left <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.inner_commute local.inner_eq_zero_iff<span class="main">)</span>


<span class="keyword1" id="Generalizations2-inner_minus_right"><span class="command">lemma</span></span> inner_minus_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">x</span> <span class="main">(</span><span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inner_minus_left <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add_eq_0_iff local.inner_add_right local.inner_zero_right<span class="main">)</span>


<span class="keyword1" id="Generalizations2-inner_diff_right"><span class="command">lemma</span></span> inner_diff_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">-</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span> <span class="main">-</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inner_diff_left <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_uminus_conv_diff local.inner_add_right local.inner_minus_right<span class="main">)</span> 


<span class="keyword1" id="Generalizations2-inner_sum_right"><span class="command">lemma</span></span> inner_sum_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">x</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">inner</span> <span class="free">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">x</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inner_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> cnj <span class="main">(</span><span class="main">∑</span><span class="bound">xa</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">inner</span> <span class="main">(</span><span class="free">f</span> <span class="bound">xa</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inner_sum_left <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">xa</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="main">(</span><span class="free">f</span> <span class="bound">xa</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cnj_sum <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">xa</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">inner</span> <span class="free">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> inner_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemmas</span></span> inner_add <span class="main">[</span><span class="operator">algebra_simps</span><span class="main">]</span> <span class="main">=</span> inner_add_left inner_add_right
<span class="keyword1"><span class="command">lemmas</span></span> inner_diff <span class="main">[</span><span class="operator">algebra_simps</span><span class="main">]</span>  <span class="main">=</span> inner_diff_left inner_diff_right
<span class="keyword1"><span class="command">lemmas</span></span> inner_scaleR <span class="main">=</span> inner_scaleR_left inner_scaleR_right

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Legacy theorem names›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> inner_left_distrib <span class="main">=</span> inner_add_left
<span class="keyword1"><span class="command">lemmas</span></span> inner_right_distrib <span class="main">=</span> inner_add_right
<span class="keyword1"><span class="command">lemmas</span></span> inner_distrib <span class="main">=</span> inner_left_distrib inner_right_distrib


<span class="keyword1" id="Generalizations2-aux_Cauchy"><span class="command">lemma</span></span> aux_Cauchy<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>cnj <span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">+</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>cnj <span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">inner</span> <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">scale</span> <span class="free">a</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">scale</span> <span class="free">a</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">inner</span> <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">scale</span> <span class="free">a</span> <span class="free">y</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">inner</span> <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">scale</span> <span class="free">a</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">scale</span> <span class="free">a</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> inner_add_right <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>cnj <span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">+</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>cnj <span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inner_add_left
    <span class="keyword1"><span class="command">unfolding</span></span> inner_scaleR_left
    <span class="keyword1"><span class="command">unfolding</span></span> inner_scaleR_right
    <span class="keyword1"><span class="command">unfolding</span></span> inner_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> distrib_left
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inner_ge_zero<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generalizations2-real_inner_inner"><span class="command">lemma</span></span> real_inner_inner<span class="main">:</span> <span class="quoted"><span class="quoted">"real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> real_scalar_mult real_scalar_mult2<span class="main">)</span> 

<span class="keyword1" id="Generalizations2-Cauchy_Schwarz_ineq"><span class="command">lemma</span></span> Cauchy_Schwarz_ineq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"real_of <span class="main">(</span>cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">≤</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cnj_a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cnj_a</span> <span class="main">=</span> <span class="main">-</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">/</span> <span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> cnj <span class="main">(</span><span class="skolem">cnj_a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> cnj_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cnj <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">cnj_a</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> a_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rw_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>cnj <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cnj_rw cnj_a_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>cnj <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>cnj <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> aux_Cauchy <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>cnj <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rw_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span> <span class="main">-</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span> <span class="main">/</span> <span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> cnj_rw cnj_a_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">0</span> <span class="main">≤</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span> <span class="main">-</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span> <span class="main">/</span> <span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span> "</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span>  <span class="main">*</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span> <span class="main">-</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span> <span class="main">/</span> <span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> real_of <span class="main">(</span>real_of <span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span><span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span><span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span> <span class="main">-</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span> <span class="main">/</span> <span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> real_scalar_mult <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> real_of <span class="main">(</span><span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span> <span class="main">-</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span> <span class="main">/</span> <span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> real_scalar_mult2 <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> real_of <span class="main">(</span><span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span> <span class="main">-</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span> <span class="main">/</span> <span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> real_of <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span> <span class="main">-</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_diff_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> real_of <span class="main">(</span><span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> real_of <span class="main">(</span>cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> real_minus <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of <span class="main">(</span>cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">≤</span> real_of <span class="main">(</span><span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> real_inner_inner <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> norm

<span class="keyword1"><span class="command">context</span></span> inner_product_space
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>sqrt <span class="main">(</span>real_of <span class="main">(</span><span class="free">inner</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> norm_eq_sqrt_inner <span class="main">=</span> norm_def

<span class="keyword1" id="Generalizations2-inner_cnj_ge_zero"><span class="command">lemma</span></span> inner_cnj_ge_zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"real_of <span class="main">(</span><span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> real_a_cnj_ge_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Generalizations2-power2_norm_eq_inner"><span class="command">lemma</span></span> power2_norm_eq_inner<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>norm <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_def<span class="main">)</span>

<span class="keyword1" id="Generalizations2-Cauchy_Schwarz_ineq2"><span class="command">lemma</span></span> Cauchy_Schwarz_ineq2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sqrt <span class="main">(</span>real_of <span class="main">(</span>cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> norm <span class="free">x</span> <span class="main">*</span> norm <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> power2_le_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> real_of <span class="main">(</span>cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of <span class="main">(</span>cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">≤</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cauchy_Schwarz_ineq <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sqrt <span class="main">(</span>real_of <span class="main">(</span>cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">(</span>norm <span class="free">x</span> <span class="main">*</span> norm <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> power_mult_distrib
  <span class="keyword1"><span class="command">unfolding</span></span> power2_norm_eq_inner <span class="keyword1"><span class="command">unfolding</span></span> real_sqrt_pow2<span class="main">[</span><span class="operator">OF</span> eq<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> norm <span class="free">x</span> <span class="main">*</span> norm <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> norm_eq_sqrt_inner
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_nonneg_nonneg real_sqrt_ge_zero inner_ge_zero<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Orthogonality›</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> orthogonal

<span class="keyword1"><span class="command">context</span></span> inner_product_space
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">orthogonal</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> <span class="free">inner</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="Generalizations2-orthogonal_clauses"><span class="command">lemma</span></span> orthogonal_clauses<span class="main">:</span>
  <span class="quoted"><span class="quoted">"orthogonal <span class="free">a</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"orthogonal <span class="free">a</span> <span class="free">x</span> <span class="main">⟹</span> orthogonal <span class="free">a</span> <span class="main">(</span><span class="free">scale</span> <span class="free">c</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"orthogonal <span class="free">a</span> <span class="free">x</span> <span class="main">⟹</span> orthogonal <span class="free">a</span> <span class="main">(</span><span class="main">-</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"orthogonal <span class="free">a</span> <span class="free">x</span> <span class="main">⟹</span> orthogonal <span class="free">a</span> <span class="free">y</span> <span class="main">⟹</span> orthogonal <span class="free">a</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"orthogonal <span class="free">a</span> <span class="free">x</span> <span class="main">⟹</span> orthogonal <span class="free">a</span> <span class="free">y</span> <span class="main">⟹</span> orthogonal <span class="free">a</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"orthogonal <span class="main">0</span> <span class="free">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"orthogonal <span class="free">x</span> <span class="free">a</span> <span class="main">⟹</span> orthogonal <span class="main">(</span><span class="free">scale</span> <span class="free">c</span> <span class="free">x</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"orthogonal <span class="free">x</span> <span class="free">a</span> <span class="main">⟹</span> orthogonal <span class="main">(</span><span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"orthogonal <span class="free">x</span> <span class="free">a</span> <span class="main">⟹</span> orthogonal <span class="free">y</span> <span class="free">a</span> <span class="main">⟹</span> orthogonal <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"orthogonal <span class="free">x</span> <span class="free">a</span> <span class="main">⟹</span> orthogonal <span class="free">y</span> <span class="free">a</span> <span class="main">⟹</span> orthogonal <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_def inner_add inner_diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Generalizations2-inner_commute_zero"><span class="command">lemma</span></span> inner_commute_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">inner</span> <span class="free">xa</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">xa</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cnj_0 local.inner_commute<span class="main">)</span>

<span class="keyword1" id="Generalizations2-vector_sub_project_orthogonal"><span class="command">lemma</span></span> vector_sub_project_orthogonal<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">b</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">scale</span> <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">b</span> <span class="main">/</span> <span class="main">(</span><span class="free">inner</span> <span class="free">b</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">a</span> <span class="bound">ba</span><span class="main">.</span> <span class="free">inner</span> <span class="bound">b</span> <span class="main">(</span><span class="free">scale</span> <span class="bound">a</span> <span class="bound">ba</span><span class="main">)</span> <span class="main">=</span> cnj <span class="main">(</span><span class="bound">a</span> <span class="main">*</span> <span class="free">inner</span> <span class="bound">ba</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.inner_commute local.inner_scaleR_left<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cnj <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">inner</span> <span class="free">b</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">inner</span> <span class="free">b</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> local.inner_commute local.inner_eq_zero_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">b</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">scale</span> <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">b</span> <span class="main">/</span> <span class="free">inner</span> <span class="free">b</span> <span class="free">b</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f1 local.inner_diff_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generalizations2-orthogonal_commute"><span class="command">lemma</span></span> orthogonal_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"orthogonal <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> orthogonal <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_def <span class="keyword1"><span class="command">using</span></span> inner_commute_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Generalizations2-pairwise_orthogonal_insert"><span class="command">lemma</span></span> pairwise_orthogonal_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> orthogonal <span class="free">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orthogonal_commute<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Generalizations2-sum_0_all"><span class="command">lemma</span></span> sum_0_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≥</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> s0<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> a f s0 sum_nonneg_eq_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Vecs as inner product spaces›</span></span>

<span class="keyword1"><span class="command">locale</span></span> vec_real_inner <span class="main">=</span> F<span class="main">?</span><span class="main">:</span> inner_product_space <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(*)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">inner_field</span></span> 
 <span class="keyword2"><span class="keyword">for</span></span> <span class="free">inner_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>field<span class="main">,</span>cnj<span class="main">,</span>real_of_extended<span class="main">}</span>"</span></span> 
 <span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">inner</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span> <span class="main">⇒</span><span class="tfree">'a</span>"</span></span> 
 <span class="keyword2"><span class="keyword">assumes</span></span> inner_vec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">inner_field</span> <span class="main">(</span><span class="free">x</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Generalizations2-inner_ge_zero"><span class="command">lemma</span></span> inner_ge_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inner_vec_def real_sum sum_nonneg<span class="main">)</span>

<span class="keyword1" id="Generalizations2-real_scalar_mult2"><span class="command">lemma</span></span> real_scalar_mult2<span class="main">:</span> <span class="quoted"><span class="quoted">"real_of <span class="main">(</span><span class="free">inner</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">x</span> <span class="main">*</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inner_vec_def<span class="main">)</span>
  <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Finite_Cartesian_Product.sum_cong_aux 
  real_scalar_mult2 real_sum scaleR_left.sum scale_sum_left<span class="main">)</span>

<span class="keyword1" id="Generalizations2-i1"><span class="command">lemma</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="free">y</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inner_vec_def cnj_sum cnj_mult mult.commute<span class="main">)</span>
   <span class="main">(</span><span class="operator">meson</span> local.inner_commute<span class="main">)</span>

<span class="keyword1" id="Generalizations2-i2"><span class="command">lemma</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">z</span> <span class="main">+</span> <span class="free">inner</span> <span class="free">y</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> local.inner_left_distrib sum.distrib inner_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Generalizations2-i3"><span class="command">lemma</span></span> i3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="main">(</span><span class="free">r</span> <span class="keyword1">*s</span> <span class="free">x</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">inner</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inner_vec_def scale_sum_right<span class="main">)</span>

<span class="keyword1" id="Generalizations2-i4"><span class="command">lemma</span></span> i4<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">x</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> real_of <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">inner_field</span> <span class="main">(</span><span class="free">x</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inner_vec_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> real_of <span class="main">(</span><span class="free">inner_field</span> <span class="main">(</span><span class="free">x</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> real_sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> real_of <span class="main">(</span><span class="free">inner_field</span> <span class="main">(</span><span class="free">x</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real_of <span class="main">(</span><span class="free">inner_field</span> <span class="main">(</span><span class="free">x</span> <span class="main">$</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">$</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_0_all F.inner_ge_zero 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> finite iso_tuple_UNIV_I<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">$</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> F.inner_eq_zero_iff F.inner_gt_zero_iff real_0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generalizations2-inner_0_0"><span class="command">lemma</span></span> inner_0_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="main">0</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inner_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">sublocale</span></span> v<span class="main">?</span><span class="main">:</span> inner_product_space <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">(*s)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">inner</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_scalar_mult2<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> cnj <span class="main">(</span><span class="free">inner</span> <span class="skolem">y</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> <span class="free">inner</span> <span class="skolem">x</span> <span class="skolem">z</span> <span class="main">+</span> <span class="free">inner</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*s</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">*</span> <span class="free">inner</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="skolem">x</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real_of <span class="main">(</span><span class="free">inner</span> <span class="skolem">x</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> inner_0_0 local.inner_ge_zero 
    local.real_scalar_mult2 mult.commute mult_1_left order.not_eq_order_implies_strict real_0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Matrices and inner product›</span></span>

<span class="keyword1"><span class="command">locale</span></span> matrix <span class="main">=</span> 
    COLS<span class="main">?</span><span class="main">:</span> vec_real_inner <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> cnj <span class="bound">y</span>"</span></span> <span class="quoted"><span class="free">inner_cols</span></span>
  <span class="main">+</span> ROWS<span class="main">?</span><span class="main">:</span> vec_real_inner <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> cnj <span class="bound">y</span>"</span></span> <span class="quoted"><span class="free">inner_rows</span></span>
 <span class="keyword2"><span class="keyword">for</span></span> <span class="free">inner_cols</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> wellorder<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> wellorder<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>field<span class="main">,</span> cnj<span class="main">,</span> real_of_extended<span class="main">}</span>"</span></span> 
 <span class="keyword2"><span class="keyword">and</span></span> <span class="free">inner_rows</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> wellorder<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> wellorder<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1" id="Generalizations2-dot_lmul_matrix"><span class="command">lemma</span></span> dot_lmul_matrix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inner_rows</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">v*</span> <span class="free">A</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="free">inner_cols</span> <span class="free">x</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> COLS.inner_vec_def ROWS.inner_vec_def matrix_vector_mult_def 
       vector_matrix_mult_def sum_distrib_right cnj_sum <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> sum_distrib_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sum.swap<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'cols</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> cnj <span class="main">(</span><span class="free">y</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">$</span> <span class="skolem">xa</span> <span class="main">*</span> <span class="free">A</span> <span class="main">$</span> <span class="skolem">xa</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">x</span> <span class="main">$</span> <span class="skolem">xa</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">y</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="skolem">xa</span> <span class="main">$</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xb</span><span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'rows</span></span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cnj_class.cnj <span class="main">(</span><span class="free">y</span> <span class="main">$</span> <span class="skolem">xb</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">$</span> <span class="skolem">xa</span> <span class="main">*</span> <span class="free">A</span> <span class="main">$</span> <span class="skolem">xa</span> <span class="main">$</span> <span class="skolem">xb</span><span class="main">)</span> 
      <span class="main">=</span> <span class="free">x</span> <span class="main">$</span> <span class="skolem">xa</span> <span class="main">*</span> cnj_class.cnj <span class="main">(</span><span class="free">y</span> <span class="main">$</span> <span class="skolem">xb</span> <span class="main">*</span> cnj_class.cnj <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="skolem">xa</span> <span class="main">$</span> <span class="skolem">xb</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cnj_mult cnj_idem <span class="keyword1"><span class="command">unfolding</span></span> mult.assoc
    <span class="keyword1"><span class="command">unfolding</span></span> mult.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="skolem">xa</span> <span class="main">$</span> <span class="skolem">xb</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Orthogonal complement generalized›</span></span>

<span class="keyword1"><span class="command">context</span></span> inner_product_space
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">orthogonal_complement</span> <span class="free"><span class="bound"><span class="entity">W</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">W</span></span></span><span class="main">.</span> orthogonal <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Generalizations2-subspace_orthogonal_complement"><span class="command">lemma</span></span> subspace_orthogonal_complement<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="main">(</span>orthogonal_complement <span class="free">W</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subspace_def orthogonal_complement_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orthogonal_def local.inner_right_distrib<span class="main">)</span>


<span class="keyword1" id="Generalizations2-orthogonal_complement_mono"><span class="command">lemma</span></span> orthogonal_complement_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_in_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orthogonal_complement <span class="free">B</span> <span class="main">⊆</span> orthogonal_complement <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> orthogonal_complement <span class="free">B</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> orthogonal_complement <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_complement_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orthogonal_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> A_in_B in_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Generalizations2-B_in_orthogonal_complement_of_orthogonal_complement"><span class="command">lemma</span></span> B_in_orthogonal_complement_of_orthogonal_complement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> orthogonal_complement <span class="main">(</span>orthogonal_complement <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orthogonal_complement_def orthogonal_def inner_commute_zero<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Generalizing projections›</span></span>

<span class="keyword1"><span class="command">context</span></span> inner_product_space
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Projection of two vectors: v onto u›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">proj</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free">scale</span> <span class="main">(</span><span class="free">inner</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">/</span> <span class="free">inner</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Projection of a onto S›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">proj_onto</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span>sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> proj <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Generalizations2-vector_sub_project_orthogonal_proj"><span class="command">lemma</span></span> vector_sub_project_orthogonal_proj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">inner</span> <span class="free">b</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> proj <span class="free">x</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> vector_sub_project_orthogonal <span class="keyword1"><span class="command">unfolding</span></span> proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Generalizations2-orthogonal_proj_set"><span class="command">lemma</span></span> orthogonal_proj_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> yC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">∈</span><span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="main">(</span><span class="free">a</span> <span class="main">-</span> proj_onto <span class="free">a</span> <span class="free">C</span><span class="main">)</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> Cy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> insert <span class="free">y</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> yC
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> fth<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="main">(</span><span class="free">a</span> <span class="main">-</span> proj_onto <span class="free">a</span> <span class="free">C</span><span class="main">)</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_def <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def <span class="keyword1"><span class="command">unfolding</span></span> proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> inner_diff
    <span class="keyword1"><span class="command">unfolding</span></span> inner_sum_left 
    <span class="keyword1"><span class="command">unfolding</span></span> right_minus_eq
    <span class="keyword1"><span class="command">unfolding</span></span> sum.remove<span class="main">[</span><span class="operator">OF</span> C yC<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inner_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> p<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> pairwise_def orthogonal_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> yC <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generalizations2-pairwise_orthogonal_proj_set"><span class="command">lemma</span></span> pairwise_orthogonal_proj_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="main">(</span>insert <span class="main">(</span><span class="free">a</span> <span class="main">-</span> proj_onto <span class="free">a</span> <span class="free">C</span><span class="main">)</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pairwise_orthogonal_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> orthogonal_proj_set C p<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Generalizations2-orthogonal_real_eq"><span class="command">lemma</span></span> orthogonal_real_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"RV_inner.orthogonal <span class="main">=</span> real_inner_class.orthogonal"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RV_inner.orthogonal_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> real_inner_class.orthogonal_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Second Part of the Fundamental Theorem of Linear Algebra generalized›</span></span>

<span class="keyword1"><span class="command">context</span></span> matrix
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Generalizations2-cnj_cnj_matrix"><span class="command">lemma</span></span> cnj_cnj_matrix<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> cnj <span class="main">(</span><span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Generalizations2-cnj_transpose"><span class="command">lemma</span></span> cnj_transpose<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> cnj <span class="main">(</span>transpose <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> transpose <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff transpose_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Generalizations2-null_space_orthogonal_complement_row_space"><span class="command">lemma</span></span> null_space_orthogonal_complement_row_space<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> wellorder<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> wellorder<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"null_space <span class="free">A</span> <span class="main">=</span> COLS.v.orthogonal_complement <span class="main">(</span>row_space <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">interpret</span></span> m<span class="main">:</span> matrix <span class="quoted"><span class="free">inner_rows</span></span> <span class="quoted"><span class="free">inner_cols</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> null_space_def COLS.v.orthogonal_complement_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xa</span> <span class="keyword3"><span class="command">assume</span></span> Ax<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> row_space <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> transpose <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xa <span class="keyword1"><span class="command">unfolding</span></span> row_space_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> y2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">v*</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xa</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> transpose_vector y <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"COLS.v.orthogonal <span class="skolem">xa</span> <span class="skolem">x</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> m.dot_lmul_matrix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> cnj_cnj_matrix Ax ROWS.v.inner_zero_right
      <span class="keyword1"><span class="command">unfolding</span></span> y2 
      <span class="keyword1"><span class="command">unfolding</span></span> COLS.v.orthogonal_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> xa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xa</span><span class="main">∈</span>row_space <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> COLS.v.orthogonal <span class="bound">xa</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xa <span class="keyword1"><span class="command">unfolding</span></span> row_space_eq COLS.v.orthogonal_def <span class="keyword1"><span class="command">using</span></span> COLS.v.inner_eq_zero_iff
    <span class="keyword1"><span class="command">using</span></span> m.dot_lmul_matrix<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> transpose_vector
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
       <span class="main">(</span><span class="operator">metis</span> ROWS.i4 m.cnj_cnj_matrix m.dot_lmul_matrix transpose_vector<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1" id="Generalizations2-left_null_space_orthogonal_complement_col_space"><span class="command">lemma</span></span> left_null_space_orthogonal_complement_col_space<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> wellorder<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> wellorder<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"left_null_space <span class="free">A</span> <span class="main">=</span> ROWS.v.orthogonal_complement <span class="main">(</span>col_space <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> m<span class="main">:</span> matrix <span class="quoted"><span class="free">inner_rows</span></span> <span class="quoted"><span class="free">inner_cols</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> m.null_space_orthogonal_complement_row_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"transpose <span class="free">A</span>"</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> left_null_space_eq_null_space_transpose
  <span class="keyword1"><span class="command">unfolding</span></span> col_space_eq_row_space_transpose <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We can get the explicit results for complex and real matrices›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> real_matrix<span class="main">:</span> matrix <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">::</span>real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span>wellorder<span class="main">}</span><span class="main">.</span> 
  sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="bound">y</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="bound">y</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cnj_real_def real_of_real_def distrib_right<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> not_real_square_gt_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">interpretation</span></span> complex_matrix<span class="main">:</span> matrix <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">::</span>complex<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span>wellorder<span class="main">}</span><span class="main">.</span> 
  sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span> <span class="main">*</span> cnj <span class="main">(</span><span class="bound">y</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span> <span class="main">*</span> cnj <span class="main">(</span><span class="bound">y</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_right<span class="main">)</span>

<span class="keyword1" id="Generalizations2-null_space_orthogonal_complement_row_space_complex"><span class="command">lemma</span></span> null_space_orthogonal_complement_row_space_complex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span>wellorder<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span>wellorder<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"null_space <span class="free">A</span> <span class="main">=</span> complex_matrix.orthogonal_complement <span class="main">(</span>row_space <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> complex_matrix.null_space_orthogonal_complement_row_space <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Generalizations2-left_null_space_orthogonal_complement_col_space_complex"><span class="command">lemma</span></span> left_null_space_orthogonal_complement_col_space_complex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> wellorder<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> wellorder<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"left_null_space <span class="free">A</span> <span class="main">=</span> complex_matrix.orthogonal_complement <span class="main">(</span>col_space <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> complex_matrix.left_null_space_orthogonal_complement_col_space <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Generalizations2-null_space_orthogonal_complement_row_space_reals"><span class="command">lemma</span></span> null_space_orthogonal_complement_row_space_reals<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span>wellorder<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span>wellorder<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"null_space <span class="free">A</span> <span class="main">=</span> real_matrix.orthogonal_complement <span class="main">(</span>row_space <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> real_matrix.null_space_orthogonal_complement_row_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> cnj_real_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_lambda_eta<span class="main">)</span>

<span class="keyword1" id="Generalizations2-left_null_space_orthogonal_complement_col_space_real"><span class="command">lemma</span></span> left_null_space_orthogonal_complement_col_space_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'cols</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> wellorder<span class="main">}</span><span class="main">^</span><span class="tfree">'rows</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> wellorder<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"left_null_space <span class="free">A</span> <span class="main">=</span> real_matrix.orthogonal_complement <span class="main">(</span>col_space <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> real_matrix.left_null_space_orthogonal_complement_col_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cnj_real_def vec_lambda_eta<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="QR_Efficient">
<div class="head">
<h1>Theory QR_Efficient</h1>
</div>
<pre class="source"><span class="comment1">(*  
  Title:      QR_Efficient.thy
  Author:     Jose Divasón &lt;jose.divasonm at unirioja.es&gt;
  Author:     Jesús Aransay &lt;jesus-maria.aransay at unirioja.es&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Improvements to get better performance of the algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> QR_Efficient
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#QR_Decomposition_IArrays">QR_Decomposition_IArrays</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Improvements for computing the Gram Schmidt algorithm and QR decomposition using vecs›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Essentialy, we try to avoid removing duplicates in each iteration. 
  They will not affect the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> sum_list<span class="antiquote"><span class="antiquote">}</span></span></span></span> since the duplicates will be the vector zero.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹New definitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Gram_Schmidt_column_k_efficient</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> 
  <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="main">=</span> from_nat <span class="free"><span class="bound"><span class="entity">k</span></span></span> 
  <span class="keyword1">then</span> column <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>column <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> 
  <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="bound">n</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>to_nat <span class="bound">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> column <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹General properties about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> sum_list<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="QR_Efficient-sum_list_remdups"><span class="command">lemma</span></span> sum_list_remdups<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">xs</span> <span class="main">∧</span> <span class="bound">j</span><span class="main">&lt;</span>length <span class="free">xs</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> 
  <span class="main">∧</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>remdups <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>remdups <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="main">(</span>remdups <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">+</span> sum_list <span class="main">(</span>remdups <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">+</span> sum_list <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps Cons.prems False
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>      
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps Cons.prems True
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_less_eq add.right_neutral add_Suc_right add_gr_0 
        in_set_conv_nth lessI list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_Cons_0 nth_Cons_Suc<span class="main">)</span>       
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>remdups <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>remdups <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_list <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps Cons.prems True
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">+</span> sum_list <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="QR_Efficient-sum_list_remdups_2"><span class="command">lemma</span></span> sum_list_remdups_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>zero<span class="main">,</span> monoid_add<span class="main">}</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">xs</span> <span class="main">∧</span> <span class="bound">j</span><span class="main">&lt;</span>length <span class="free">xs</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">∧</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> 
    <span class="main">⟶</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>remdups <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>remdups <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>  sum_list <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="main">(</span>remdups <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span> <span class="main">#</span> <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>remdups <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>remdups <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems Cons.hyps
      <span class="keyword1"><span class="command">using</span></span> id_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  sum_list <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> fa_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps Cons.prems True
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_less_eq add.right_neutral add_Suc_right add_gr_0 
        in_set_conv_nth lessI list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> nth_Cons_0 nth_Cons_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>remdups <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>  sum_list <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>remdups <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems Cons.hyps
      <span class="keyword1"><span class="command">using</span></span> id_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fa_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Proving a code equation to improve the performance›</span></span>

<span class="keyword1" id="QR_Efficient-set_map_column"><span class="command">lemma</span></span> set_map_column<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="bound">n</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>to_nat <span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>  <span class="main">{</span>column <span class="bound">i</span> <span class="free">G</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> to_nat <span class="free">b</span>"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> from_nat_mono to_nat_less_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="skolem">n</span><span class="main">)</span> <span class="free">G</span> <span class="main">=</span> column <span class="bound">i</span> <span class="free">G</span><span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> ib<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="skolem">i</span> <span class="main">&lt;</span> to_nat <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_nat_le<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="skolem">i</span> <span class="free">G</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="bound">n</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>to_nat <span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> image_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"to_nat <span class="skolem"><span class="skolem"><span class="skolem">i</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ib<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="QR_Efficient-column_Gram_Schmidt_column_k_repeated_0"><span class="command">lemma</span></span> column_Gram_Schmidt_column_k_repeated_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>real_inner<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i_not_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≠</span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">=</span> column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> column <span class="free">k</span> <span class="free">A</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> column <span class="free">k</span> <span class="free">A</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> column_Gram_Schmidt_column_k<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> column <span class="free">k</span> <span class="free">A</span> <span class="main">-</span> proj_onto <span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> inner_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> col_k_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> column <span class="free">k</span> <span class="free">A</span> <span class="main">-</span> proj_onto <span class="main">(</span>column <span class="free">k</span> <span class="free">A</span><span class="main">)</span> <span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="main">(</span>column <span class="free">k</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span>column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> col_k_rw
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> orthogonal_proj_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ o<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> column <span class="free">i</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> column_Gram_Schmidt_column_k'<span class="main">[</span><span class="operator">OF</span> i_not_k<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>  <span class="main">∈</span> <span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"column <span class="free">k</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_def c_eq inner_eq_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1" id="QR_Efficient-column_Gram_Schmidt_upt_k_repeated_0'"><span class="command">lemma</span></span> column_Gram_Schmidt_upt_k_repeated_0'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i_not_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≠</span><span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">≤</span>from_nat <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="free">j</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> 
  <span class="main">=</span> column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column <span class="free">j</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> j c_eq k
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> ij least_mod_type 
    <span class="keyword1"><span class="command">unfolding</span></span> from_nat_0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> dual_order.strict_trans1 ij least_mod_type not_less<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> i_not_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≠</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> col_i_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i_not_k Gram_Schmidt_column_k_def Gram_Schmidt_upt_k_suc column_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tn_fn_suc<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> to_nat_from_nat_id Suc.prems
    <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">=</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False    
    <span class="keyword1"><span class="command">have</span></span> jk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> from_nat <span class="skolem">k</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False One_nat_def Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add.right_neutral add_Suc_right
        from_nat_suc le_Suc less_le linorder_not_le<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> col_j_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="free">j</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> column <span class="free">j</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False Gram_Schmidt_column_k_def Gram_Schmidt_upt_k_suc column_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> col_j_eq_col_i_k<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="free">j</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">unfolding</span></span> col_j_rw col_i_rw <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc.hyps col_j_eq_col_i_k k jk <span class="keyword1"><span class="command">unfolding</span></span> col_j_rw <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_suc 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> column_Gram_Schmidt_column_k_repeated_0<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
        <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"from_nat <span class="main"><span class="main">(</span></span>Suc <span class="skolem"><span class="skolem">k</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Gram_Schmidt_upt_k <span class="free"><span class="free">A</span></span> <span class="skolem"><span class="skolem">k</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> tn_fn_suc<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> set_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">}</span> 
        <span class="main">=</span> <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> to_nat <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> less_Suc_eq_le less_le not_less tn_fn_suc to_nat_mono<span class="main">)</span>      
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i_not_k <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc.prems True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gram_Schmidt_upt_k_suc<span class="main">)</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pairwise orthogonal <span class="main">{</span>column <span class="bound">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> from_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> set_rw <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orthogonal_Gram_Schmidt_upt_k<span class="main"><span class="main">[</span></span><span class="operator">OF</span> k<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>




<span class="keyword1" id="QR_Efficient-column_Gram_Schmidt_upt_k_repeated_0"><span class="command">lemma</span></span> column_Gram_Schmidt_upt_k_repeated_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i_not_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≠</span><span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">≤</span><span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="free">j</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">=</span> column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column <span class="free">j</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms column_Gram_Schmidt_upt_k_repeated_0' to_nat_less_card ncols_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> c_eq column_Gram_Schmidt_upt_k_repeated_0' 
     from_nat_to_nat_id i_not_k ij j ncols_def to_nat_less_card<span class="main">)</span>


<span class="keyword1"><span class="command">corollary</span></span> column_Gram_Schmidt_upt_k_repeated<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i_not_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≠</span><span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≤</span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">≤</span><span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="free">j</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column <span class="free">j</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="free">j</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms column_Gram_Schmidt_upt_k_repeated_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i_not_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms column_Gram_Schmidt_upt_k_repeated_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="free">i</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>to_nat <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms column_Gram_Schmidt_upt_k_repeated_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i_not_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms column_Gram_Schmidt_upt_k_repeated_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="QR_Efficient-column_Gram_Schmidt_column_k_eq_efficient"><span class="command">lemma</span></span> column_Gram_Schmidt_column_k_eq_efficient<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span> <span class="main">=</span> foldl Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">k</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> suc_k<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">k</span> <span class="main">&lt;</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"column <span class="free">b</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>
  <span class="main">=</span> column <span class="free">b</span> <span class="main">(</span>Gram_Schmidt_column_k_efficient <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_efficient_def Gram_Schmidt_column_k_def column_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> tn_fn_suc<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">k</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> suc_k to_nat_from_nat_id <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span><span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>column <span class="free">b</span> <span class="skolem">G</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="bound">n</span><span class="main">)</span> <span class="skolem">G</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">have</span></span> proj_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_onto <span class="main">(</span>column <span class="free">b</span> <span class="skolem">G</span><span class="main">)</span> <span class="main">{</span>column <span class="bound">i</span> <span class="skolem">G</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">}</span> 
    <span class="main">=</span> sum_list <span class="main">(</span>map <span class="var">?f</span> <span class="main">(</span>map <span class="var">?g</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>to_nat <span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proj_onto <span class="main">(</span>column <span class="free">b</span> <span class="skolem">G</span><span class="main">)</span> <span class="main">{</span>column <span class="bound">i</span> <span class="skolem">G</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">{</span>column <span class="bound">i</span> <span class="skolem">G</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> proj_onto_def proj_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">(</span>set <span class="main">(</span>map <span class="var">?g</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>to_nat <span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_map_column<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>    
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="var">?f</span> <span class="main">(</span>remdups <span class="main">(</span>map <span class="var">?g</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>to_nat <span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_code <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="main">(</span>map <span class="var">?f</span> <span class="main">(</span><span class="main">(</span>map <span class="var">?g</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>to_nat <span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_remdups_2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> to_nat <span class="free">b</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> to_nat <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> col_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="skolem">i</span><span class="main">)</span> <span class="skolem">G</span> <span class="main">=</span> column <span class="main">(</span>from_nat <span class="skolem">j</span><span class="main">)</span> <span class="skolem">G</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> col_0<span class="main">:</span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="skolem">j</span><span class="main">)</span> <span class="skolem">G</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="main">(</span>from_nat <span class="free">k</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessD ncols_def suc_k to_nat_from_nat_id<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="skolem">j</span><span class="main">)</span> <span class="skolem">G</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> G_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> column_Gram_Schmidt_upt_k_repeated<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
          <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>from_nat <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'n</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"from_nat <span class="skolem"><span class="skolem">j</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"from_nat <span class="free"><span class="free">k</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> k<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> from_nat_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">k</span>"</span></span><span class="main">]</span> suc_k i 
          <span class="keyword1"><span class="command">unfolding</span></span> True tn_fn_suc ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">i</span> <span class="main">≤</span> <span class="main">(</span>from_nat <span class="free">k</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessD True from_nat_mono' i less_Suc_eq_le ncols_def suc_k tn_fn_suc<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span>from_nat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> from_nat_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">k</span>"</span></span><span class="main">]</span> suc_k j
          <span class="keyword1"><span class="command">unfolding</span></span> True tn_fn_suc ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">j</span> <span class="main">≤</span> <span class="main">(</span>from_nat <span class="free">k</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessD True from_nat_mono' j less_Suc_eq_le ncols_def suc_k tn_fn_suc<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">i</span> <span class="main">≠</span> <span class="main">(</span>from_nat <span class="skolem">j</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij i j True suc_k 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> dual_order.strict_trans from_nat_eq_imp_eq ncols_def tn_fn_suc<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"column <span class="main">(</span>from_nat <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> 
          <span class="main">=</span> column <span class="main">(</span>from_nat <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> G_def col_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"column <span class="free">b</span> <span class="skolem">G</span> <span class="main">∙</span> column <span class="main">(</span>from_nat <span class="skolem">j</span><span class="main">)</span> <span class="skolem">G</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> col_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"column <span class="free">b</span> <span class="main">(</span>Gram_Schmidt_column_k <span class="skolem">G</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> column <span class="free">b</span> <span class="skolem">G</span> <span class="main">-</span> proj_onto <span class="main">(</span>column <span class="free">b</span> <span class="skolem">G</span><span class="main">)</span> <span class="main">{</span>column <span class="bound">i</span> <span class="skolem">G</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> True
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_def G_def column_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> column <span class="free">b</span> <span class="skolem">G</span> 
    <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="bound">n</span><span class="main">)</span> <span class="skolem">G</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>to_nat <span class="free">b</span><span class="main">]</span><span class="main">.</span> <span class="main">(</span>column <span class="free">b</span> <span class="skolem">G</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> proj_eq <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> column <span class="free">b</span> <span class="main">(</span>Gram_Schmidt_column_k_efficient <span class="skolem">G</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> True Gram_Schmidt_column_k_efficient_def G_def column_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> G_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="QR_Efficient-Gram_Schmidt_upt_k_efficient_induction"><span class="command">lemma</span></span> Gram_Schmidt_upt_k_efficient_induction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span> <span class="main">=</span> foldl Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">k</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> suc_k<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">k</span> <span class="main">&lt;</span> ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> 
  <span class="main">=</span> Gram_Schmidt_column_k_efficient <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> column_Gram_Schmidt_column_k_eq_efficient<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> column_def vec_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>


<span class="keyword1" id="QR_Efficient-Gram_Schmidt_upt_k_efficient"><span class="command">lemma</span></span> Gram_Schmidt_upt_k_efficient<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span> <span class="main">=</span> foldl Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">k</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> k
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">{</span>column <span class="bound">i</span> <span class="free">A</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> least_mod_type <span class="keyword1"><span class="command">using</span></span> leD <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gram_Schmidt_column_k_efficient_def 
      Gram_Schmidt_upt_k_def Gram_Schmidt_column_k_def 
      proj_onto_def proj_def vec_eq_iff from_nat_0 to_nat_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> Gram_Schmidt_column_k <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Gram_Schmidt_upt_k_suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Gram_Schmidt_column_k_efficient <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Gram_Schmidt_upt_k_efficient_induction<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span> <span class="main">=</span> foldl Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.hyps Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">&lt;</span> ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Gram_Schmidt_column_k_efficient
    <span class="main">(</span>foldl Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.hyps Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>foldl Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This equation is now more efficient than the original definition of the algoritm, since it is not
  removing duplicates in each iteration, which is more expensive in time than adding zeros (if there appear 
  duplicates while applying the algorithm, they are zeros and then the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> sum_list<span class="antiquote"><span class="antiquote">}</span></span></span></span> is the same in each step).›</span></span>

<span class="keyword1" id="QR_Efficient-Gram_Schmidt_matrix_efficient"><span class="command">lemma</span></span> Gram_Schmidt_matrix_efficient<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Gram_Schmidt_matrix <span class="free">A</span> <span class="main">=</span> foldl Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>ncols <span class="free">A</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Gram_Schmidt_matrix <span class="free">A</span> <span class="main">=</span> Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_matrix_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> foldl Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>ncols <span class="free">A</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Gram_Schmidt_upt_k_efficient<span class="main">[</span><span class="operator">OF</span> n<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Improvements for computing the Gram Schmidt algorithm and QR decomposition 
  using immutable arrays›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹New definitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Gram_Schmidt_column_k_iarrays_efficient</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> 
  tabulate2 <span class="main">(</span>nrows_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>ncols_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">column_b_A</span> <span class="main">=</span> column_iarray <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">in</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">column_b_A</span> <span class="main">-</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">column_b_A</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> 
  <span class="main">(</span><span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="bound">column_b_A</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Gram_Schmidt_matrix_iarrays_efficient</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> 
  <span class="main">=</span> foldl Gram_Schmidt_column_k_iarrays_efficient <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>ncols_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">QR_decomposition_iarrays_efficient</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> divide_by_norm_iarray <span class="main">(</span>Gram_Schmidt_matrix_iarrays_efficient <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> 
  <span class="keyword1">in</span> <span class="main">(</span><span class="bound">Q</span><span class="main">,</span> transpose_iarray <span class="bound">Q</span> <span class="keyword1">**i</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹General properties›</span></span>

<span class="keyword1" id="QR_Efficient-tabulate2_nth"><span class="command">lemma</span></span> tabulate2_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">nr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tabulate2 <span class="free">nr</span> <span class="free">nc</span> <span class="free">f</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">!!</span> <span class="free">j</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tabulate2_def <span class="keyword1"><span class="command">using</span></span> i j nth_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="QR_Efficient-vec_to_iarray_minus"><span class="command">lemma</span></span> vec_to_iarray_minus<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"vec_to_iarray <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span>vec_to_iarray <span class="free">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>vec_to_iarray <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_def
  <span class="keyword1"><span class="command">unfolding</span></span> minus_iarray_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="QR_Efficient-vec_to_iarray_minus_nth"><span class="command">lemma</span></span> vec_to_iarray_minus_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>IArray.length <span class="main">(</span>vec_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>IArray.length <span class="main">(</span>vec_to_iarray <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_to_iarray <span class="free">A</span> <span class="main">-</span> vec_to_iarray <span class="free">B</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> 
  <span class="main">=</span> vec_to_iarray <span class="free">A</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">-</span> vec_to_iarray <span class="free">B</span> <span class="main">!!</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> i_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>max <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'c</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i i2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> i_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>max <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'c</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="keyword1">then</span> IArray 
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>max <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'c</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span>
    <span class="bound">a</span> <span class="main">-</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'c</span><span class="main">)</span> <span class="keyword1">then</span> 
    IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">B</span> <span class="main">$</span> from_nat <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>max <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'c</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_to_iarray <span class="free">A</span> <span class="main">-</span> vec_to_iarray <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> 
    <span class="main">-</span> IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">B</span> <span class="main">$</span> from_nat <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> IArray <span class="main">(</span>map <span class="var">?f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>max <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> minus_iarray_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span>  <span class="free">A</span> <span class="main">$</span> from_nat <span class="free">i</span> <span class="main">-</span> <span class="free">B</span> <span class="main">$</span> from_nat <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i_length <span class="keyword1"><span class="command">using</span></span> nth_map i i2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec_to_iarray <span class="free">A</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">-</span> vec_to_iarray <span class="free">B</span> <span class="main">!!</span> <span class="free">i</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i i2 vec_to_iarray_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="QR_Efficient-sum_list_map_vec_to_iarray"><span class="command">lemma</span></span> sum_list_map_vec_to_iarray<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="comment1">(*If I remove this assumption, I have to prove 
  vec_to_iarray 0 = IArray [] which is false.*)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> vec_to_iarray <span class="main">(</span>sum_list <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> o_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span><span class="main">=</span><span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> l_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> IArray<span class="main">[]</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_iarray_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> sum_list <span class="main">(</span><span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">#</span> map <span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec_to_iarray <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">+</span> IArray<span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> l_rw <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec_to_iarray <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">+</span> vec_to_iarray <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="main">(</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> vec<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> plus_iarray_def Let_def vec_to_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec_to_iarray <span class="main">(</span>sum_list <span class="main">(</span>map <span class="main">(</span><span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">unfolding</span></span> plus_iarray_def Let_def vec_to_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> sum_list <span class="main">(</span><span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">#</span> map <span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">+</span> vec_to_iarray <span class="main">(</span>sum_list <span class="main">(</span>map <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems Cons.hyps False <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec_to_iarray <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">+</span> vec_to_iarray <span class="main">(</span>sum_list <span class="main">(</span>map <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec_to_iarray <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span>sum_list <span class="main">(</span>map <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_to_iarray_plus<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec_to_iarray <span class="main">(</span>sum_list <span class="main">(</span>map <span class="main">(</span><span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Proving the equivalence›</span></span>

<span class="keyword1" id="QR_Efficient-matrix_to_iarray_Gram_Schmidt_column_k_efficient"><span class="command">lemma</span></span> matrix_to_iarray_Gram_Schmidt_column_k_efficient<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="free">k</span><span class="main">)</span> 
  <span class="main">=</span> Gram_Schmidt_column_k_iarrays_efficient <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> iarray_exhaust2 list_eq_iff_nth_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> 
    <span class="operator">unfold</span> IArray.sub_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> IArray.length_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> IArray.length <span class="main">(</span>Gram_Schmidt_column_k_iarrays_efficient <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_def Gram_Schmidt_column_k_iarrays_efficient_def tabulate2_def 
    <span class="keyword1"><span class="command">unfolding</span></span> nrows_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span>
    IArray.length <span class="main">(</span>Gram_Schmidt_column_k_iarrays_efficient <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="free">k</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_to_iarray_def Gram_Schmidt_column_k_iarrays_efficient_def 
      Gram_Schmidt_column_k_efficient_def tabulate2_def ncols_iarray_def 
      nrows_iarray_def vec_to_iarray_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">ia</span> 
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span>matrix_to_iarray <span class="main">(</span>Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">!!</span> <span class="skolem">ia</span> 
    <span class="main">=</span> Gram_Schmidt_column_k_iarrays_efficient <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="free">k</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">!!</span> <span class="skolem">ia</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">column_b_A</span> <span class="main">=</span> column_iarray <span class="bound">b</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>
      <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">k</span> <span class="keyword1">then</span> <span class="bound">column_b_A</span> 
      <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">b</span><span class="main">]</span><span class="main">.</span> 
      <span class="main">(</span><span class="bound">column_b_A</span> <span class="keyword1">∙i</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">column_b_A</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>nrows <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> nrows_def matrix_to_iarray_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> ia2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ia <span class="keyword1"><span class="command">unfolding</span></span> ncols_def matrix_to_iarray_def o_def vec_to_iarray_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i2 ia length_vec_to_iarray nrows_def to_nat_from_nat_id vec_matrix<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Gram_Schmidt_column_k_iarrays_efficient <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="free">k</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">!!</span> <span class="skolem">ia</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">i</span> <span class="skolem">ia</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_iarrays_efficient_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tabulate2_nth<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> nrows_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> i2 <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_nrows <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">&lt;</span> ncols_iarray <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ia2 <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_ncols <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span>from_nat <span class="skolem">i</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span>from_nat <span class="skolem">ia</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_efficient_def Let_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> ia_neq_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">≠</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>from_nat <span class="skolem">ia</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> from_nat <span class="free">k</span> "</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms from_nat_eq_imp_eq ia2 ncols_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"IArray.list_of <span class="main">(</span>column_iarray <span class="skolem">ia</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span>
        column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">-</span>
        sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> 
        <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="bound">n</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>to_nat <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> from_nat <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ia_neq_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">≠</span> <span class="free">k</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"IArray.list_of <span class="main">(</span>column_iarray <span class="skolem">ia</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> 
        <span class="main">=</span> column <span class="main">(</span>from_nat <span class="skolem">ia</span><span class="main">)</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IArray.sub_def i ia2 length_eq_card_rows to_nat_from_nat_id 
          vec_to_iarray_column' vec_to_iarray_nth'<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>column <span class="main">(</span>from_nat <span class="bound">x</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="main">/</span>
        <span class="main">(</span><span class="main">(</span>column <span class="main">(</span>from_nat <span class="bound">x</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>column <span class="main">(</span>from_nat <span class="bound">x</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>column <span class="main">(</span>from_nat <span class="bound">x</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="var">?f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IArray.list_of
        <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">-</span>
        sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> 
        <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span>
        column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">-</span> 
        sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> 
        <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="bound">n</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>to_nat <span class="main">(</span>from_nat <span class="free">k</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> from_nat <span class="skolem">i</span>"</span></span>    
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_column'<span class="main">[</span><span class="operator">OF</span> k<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> True from_nat_0 to_nat_0 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> IArray.sub_def i2 minus_zero_iarray nrows_def vec_to_iarray_nth<span class="main">)</span>    
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False        
        <span class="keyword1"><span class="command">have</span></span> tn_fn_k<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="main">(</span>from_nat <span class="free">k</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms from_nat_to_nat ncols_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> column_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> 
          <span class="main">=</span> vec_to_iarray <span class="main">(</span>column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vec_to_iarray_column'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> k<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> sum_list_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> 
        <span class="keyword1">∙i</span> column_iarray <span class="bound">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>column_iarray <span class="bound">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> 
        <span class="keyword1">∙i</span> column_iarray <span class="bound">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> column_iarray <span class="bound">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">=</span> vec_to_iarray <span class="var">?l</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> 
          <span class="keyword1">∙i</span> column_iarray <span class="bound">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>column_iarray <span class="bound">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> 
          <span class="keyword1">∙i</span> column_iarray <span class="bound">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> column_iarray <span class="bound">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span> 
          <span class="main">=</span> sum_list <span class="main">(</span>map <span class="main">(</span>vec_to_iarray <span class="main">∘</span> <span class="var">?f</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">)</span>"</span></span>            
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> interv_sum_list_conv_sum_set_nat<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">&lt;</span><span class="free">k</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> column_iarray <span class="skolem">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">/</span>
              <span class="main">(</span>column_iarray <span class="skolem">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> column_iarray <span class="skolem">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span>
              column_iarray <span class="skolem">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">=</span>
              vec_to_iarray <span class="main">(</span><span class="main">(</span>column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">∙</span> column <span class="main">(</span>from_nat <span class="skolem">x</span><span class="main">)</span> <span class="free">A</span> <span class="main">/</span>
              <span class="main">(</span>column <span class="main">(</span>from_nat <span class="skolem">x</span><span class="main">)</span> <span class="free">A</span> <span class="main">∙</span> column <span class="main">(</span>from_nat <span class="skolem">x</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> column <span class="main">(</span>from_nat <span class="skolem">x</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_scaleR vec_to_iarray_inner
              <span class="keyword1"><span class="command">unfolding</span></span> column_rw <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_column'<span class="main">[</span><span class="operator">OF</span> x<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec_to_iarray <span class="main">(</span>sum_list <span class="main">(</span>map <span class="var">?f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_map_vec_to_iarray<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>   
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IArray.list_of
          <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">-</span>
          sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> 
          <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> 
          <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">-</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> column_iarray <span class="bound">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">/</span>
          <span class="main">(</span>column_iarray <span class="bound">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> column_iarray <span class="bound">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span>
          column_iarray <span class="bound">x</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> vec_to_iarray_inner tn_fn_k o_def
          <span class="keyword1"><span class="command">unfolding</span></span> IArray.sub_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>vec_to_iarray <span class="main">(</span>column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="main">-</span> vec_to_iarray <span class="var">?l</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> sum_list_rw <span class="keyword1"><span class="command">unfolding</span></span> column_rw  <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>vec_to_iarray <span class="main">(</span>column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>vec_to_iarray <span class="var">?l</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> vec_to_iarray_minus_nth<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span>vec_to_iarray <span class="main">(</span>column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i2 length_vec_to_iarray nrows_def<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span>vec_to_iarray <span class="var">?l</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> i2 length_vec_to_iarray nrows_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">-</span> <span class="var">?l</span> <span class="main">$</span> from_nat <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> column_rw
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> i2 nrows_def vec_to_iarray_nth<span class="main">)</span> 
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">-</span>
          sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> 
          <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="bound">n</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>to_nat <span class="main">(</span>from_nat <span class="free">k</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> from_nat <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> o_def tn_fn_k <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IArray.list_of
          <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">-</span>
          sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>column_iarray <span class="free">k</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="keyword1">∙i</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> 
          <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span>
          column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">$</span> from_nat <span class="skolem">i</span> <span class="main">-</span>
          sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>column <span class="main">(</span>from_nat <span class="free">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> 
          <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column <span class="main">(</span>from_nat <span class="bound">n</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>to_nat <span class="main">(</span>from_nat <span class="free">k</span><span class="main">::</span><span class="tfree">'n</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> from_nat <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> matrix_to_iarray <span class="main">(</span>Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">!!</span> <span class="skolem">ia</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> matrix_to_iarray_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Gram_Schmidt_column_k_efficient <span class="free">A</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">ia</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">using</span></span> ia2 i2
      <span class="keyword1"><span class="command">unfolding</span></span> to_nat_from_nat_id<span class="main">[</span><span class="operator">OF</span> i2<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> nrows_def<span class="main"><span class="main">]</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> to_nat_from_nat_id<span class="main">[</span><span class="operator">OF</span> ia2<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ncols_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1" id="QR_Efficient-matrix_to_iarray_Gram_Schmidt_upt_k_efficient"><span class="command">lemma</span></span> matrix_to_iarray_Gram_Schmidt_upt_k_efficient<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="free">k</span><span class="main">)</span> 
  <span class="main">=</span> foldl Gram_Schmidt_column_k_iarrays_efficient <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">k</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> zero_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span>ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_efficient<span class="main">[</span><span class="operator">OF</span> zero_le<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_efficient
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_to_iarray_Gram_Schmidt_column_k_efficient<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"foldl Gram_Schmidt_column_k_iarrays_efficient <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">&lt;</span>ncols <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> k2<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">&lt;</span> ncols <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> list_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="var">?G</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps Suc.prems Suc_lessD<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>Gram_Schmidt_upt_k <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?G</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_def 
    <span class="keyword1"><span class="command">unfolding</span></span> list_rw
    <span class="keyword1"><span class="command">unfolding</span></span> foldl_append
    <span class="keyword1"><span class="command">unfolding</span></span> foldl.simps
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_upt_k_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> hyp<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> matrix_to_iarray_Gram_Schmidt_column_k_efficient
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Gram_Schmidt_upt_k_efficient Gram_Schmidt_upt_k_efficient_induction 
      Suc.prems k matrix_to_iarray_Gram_Schmidt_column_k_efficient ncols_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="QR_Efficient-matrix_to_iarray_Gram_Schmidt_matrix_efficient"><span class="command">lemma</span></span> matrix_to_iarray_Gram_Schmidt_matrix_efficient<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span><span class="main">^</span><span class="tfree">'m</span><span class="main">::</span><span class="main">{</span>mod_type<span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_to_iarray <span class="main">(</span>Gram_Schmidt_matrix <span class="free">A</span><span class="main">)</span> 
  <span class="main">=</span> Gram_Schmidt_matrix_iarrays_efficient <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"ncols <span class="free">A</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> ncols <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ncols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_matrix_iarrays_efficient_def Gram_Schmidt_matrix_def 
    <span class="keyword1"><span class="command">using</span></span> matrix_to_iarray_Gram_Schmidt_upt_k_efficient<span class="main">[</span><span class="operator">OF</span> n<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_ncols <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="QR_Efficient-QR_decomposition_iarrays_efficient"><span class="command">lemma</span></span> QR_decomposition_iarrays_efficient<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"QR_decomposition_iarrays <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span> 
  <span class="main">=</span> QR_decomposition_iarrays_efficient <span class="main">(</span>matrix_to_iarray <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> QR_decomposition_iarrays_def QR_decomposition_iarrays_efficient_def Let_def
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_Gram_Schmidt_matrix_efficient<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_to_iarray_Gram_Schmidt_matrix <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Other code equations that improve the performance›</span></span>

<span class="keyword1" id="QR_Efficient-inner_iarray_code"><span class="command">lemma</span></span> inner_iarray_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inner_iarray <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">*</span> <span class="free">B</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="free">A</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> set_Eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="free">A</span><span class="main">}</span> <span class="main">=</span> set <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="free">A</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> atLeastLessThan_upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inner_iarray <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">*</span> <span class="free">B</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="free">A</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> inner_iarray_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">*</span> <span class="free">B</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="free">A</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_Eq <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">A</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">*</span> <span class="free">B</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>IArray.length <span class="free">A</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum_set_upt_conv_sum_list_nat <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Gram_Schmidt_column_k_iarrays_efficient2</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> 
  tabulate2 <span class="main">(</span>nrows_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>ncols_iarray <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> 
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">col_k</span> <span class="main">=</span> column_iarray <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
       <span class="bound">col</span> <span class="main">=</span> <span class="main">(</span><span class="bound">col_k</span> <span class="main">-</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">col_k</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">∙i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> 
              <span class="main">(</span><span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> column_iarray <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">in</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="bound">col</span> <span class="keyword1">else</span> column_iarray <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">!!</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="QR_Efficient-Gram_Schmidt_column_k_iarrays_efficient_eq"><span class="command">lemma</span></span> Gram_Schmidt_column_k_iarrays_efficient_eq<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Gram_Schmidt_column_k_iarrays_efficient <span class="free">A</span> <span class="free">k</span> 
  <span class="main">=</span> Gram_Schmidt_column_k_iarrays_efficient2 <span class="free">A</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_iarrays_efficient_def
  <span class="keyword1"><span class="command">unfolding</span></span> Gram_Schmidt_column_k_iarrays_efficient2_def
  <span class="keyword1"><span class="command">unfolding</span></span> Let_def tabulate2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>